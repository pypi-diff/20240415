# Comparing `tmp/BioTEMPy-2.2.0a0.tar.gz` & `tmp/BioTEMPy-2.2.0a1.tar.gz`

## filetype from file(1)

```diff
@@ -1 +1 @@
-gzip compressed data, was "dist/BioTEMPy-2.2.0a0.tar", last modified: Tue Mar 26 15:16:26 2024, max compression
+gzip compressed data, was "dist/BioTEMPy-2.2.0a1.tar", last modified: Mon Apr 15 13:10:10 2024, max compression
```

## Comparing `BioTEMPy-2.2.0a0.tar` & `BioTEMPy-2.2.0a1.tar`

### file list

```diff
@@ -1,82 +1,83 @@
-drwxr-xr-x   0 root         (0) root         (0)        0 2024-03-26 15:16:26.000000 BioTEMPy-2.2.0a0/
-drwxr-xr-x   0 root         (0) root         (0)        0 2024-03-26 15:16:26.000000 BioTEMPy-2.2.0a0/BioTEMPy.egg-info/
--rw-r--r--   0 root         (0) root         (0)      499 2024-03-26 15:16:26.000000 BioTEMPy-2.2.0a0/BioTEMPy.egg-info/PKG-INFO
--rw-r--r--   0 root         (0) root         (0)     1700 2024-03-26 15:16:26.000000 BioTEMPy-2.2.0a0/BioTEMPy.egg-info/SOURCES.txt
--rw-r--r--   0 root         (0) root         (0)        1 2024-03-26 15:16:26.000000 BioTEMPy-2.2.0a0/BioTEMPy.egg-info/dependency_links.txt
--rw-r--r--   0 root         (0) root         (0)      169 2024-03-26 15:16:26.000000 BioTEMPy-2.2.0a0/BioTEMPy.egg-info/entry_points.txt
--rw-r--r--   0 root         (0) root         (0)       80 2024-03-26 15:16:26.000000 BioTEMPy-2.2.0a0/BioTEMPy.egg-info/requires.txt
--rw-r--r--   0 root         (0) root         (0)        6 2024-03-26 15:16:26.000000 BioTEMPy-2.2.0a0/BioTEMPy.egg-info/top_level.txt
--rw-r--r--   0 root         (0) root         (0)      499 2024-03-26 15:16:26.000000 BioTEMPy-2.2.0a0/PKG-INFO
--rw-rw-rw-   0 root         (0) root         (0)     3329 2024-03-26 15:06:45.000000 BioTEMPy-2.2.0a0/README.md
-drwxr-xr-x   0 root         (0) root         (0)        0 2024-03-26 15:16:26.000000 BioTEMPy-2.2.0a0/TEMPy/
--rw-rw-rw-   0 root         (0) root         (0)       52 2024-03-26 15:06:45.000000 BioTEMPy-2.2.0a0/TEMPy/__init__.py
--rw-rw-rw-   0 root         (0) root         (0)       26 2024-03-26 15:06:45.000000 BioTEMPy-2.2.0a0/TEMPy/_version.py
-drwxr-xr-x   0 root         (0) root         (0)        0 2024-03-26 15:16:26.000000 BioTEMPy-2.2.0a0/TEMPy/assembly/
--rw-rw-rw-   0 root         (0) root         (0)        0 2024-03-26 15:16:13.000000 BioTEMPy-2.2.0a0/TEMPy/assembly/__init__.py
--rwxrwxrwx   0 root         (0) root         (0)    13073 2024-03-26 15:06:45.000000 BioTEMPy-2.2.0a0/TEMPy/assembly/assembly.py
--rw-rw-rw-   0 root         (0) root         (0)    46773 2024-03-26 15:06:45.000000 BioTEMPy-2.2.0a0/TEMPy/assembly/gamma.py
-drwxr-xr-x   0 root         (0) root         (0)        0 2024-03-26 15:16:26.000000 BioTEMPy-2.2.0a0/TEMPy/cli/
--rw-rw-rw-   0 root         (0) root         (0)        0 2024-03-26 15:16:13.000000 BioTEMPy-2.2.0a0/TEMPy/cli/__init__.py
--rw-rw-rw-   0 root         (0) root         (0)    14120 2024-03-26 15:06:45.000000 BioTEMPy-2.2.0a0/TEMPy/cli/arg_parser.py
--rw-rw-rw-   0 root         (0) root         (0)    11044 2024-03-26 15:06:45.000000 BioTEMPy-2.2.0a0/TEMPy/cli/class_arg.py
-drwxr-xr-x   0 root         (0) root         (0)        0 2024-03-26 15:16:26.000000 BioTEMPy-2.2.0a0/TEMPy/core/
--rw-rw-rw-   0 root         (0) root         (0)        0 2024-03-26 15:16:13.000000 BioTEMPy-2.2.0a0/TEMPy/core/__init__.py
-drwxr-xr-x   0 root         (0) root         (0)        0 2024-03-26 15:16:26.000000 BioTEMPy-2.2.0a0/TEMPy/core/data/
--rw-rw-rw-   0 root         (0) root         (0)       82 2024-03-26 15:06:45.000000 BioTEMPy-2.2.0a0/TEMPy/core/data/__init__.py
--rw-rw-rw-   0 root         (0) root         (0)     1778 2024-03-26 15:06:45.000000 BioTEMPy-2.2.0a0/TEMPy/core/data/download.py
-drwxr-xr-x   0 root         (0) root         (0)        0 2024-03-26 15:16:26.000000 BioTEMPy-2.2.0a0/TEMPy/core/errors/
--rw-rw-rw-   0 root         (0) root         (0)       86 2024-03-26 15:06:45.000000 BioTEMPy-2.2.0a0/TEMPy/core/errors/__init__.py
--rw-rw-rw-   0 root         (0) root         (0)      149 2024-03-26 15:06:45.000000 BioTEMPy-2.2.0a0/TEMPy/core/errors/instance.py
--rw-rw-rw-   0 root         (0) root         (0)     1381 2024-03-26 15:06:45.000000 BioTEMPy-2.2.0a0/TEMPy/core/warn.py
-drwxr-xr-x   0 root         (0) root         (0)        0 2024-03-26 15:16:26.000000 BioTEMPy-2.2.0a0/TEMPy/graphics/
--rw-rw-rw-   0 root         (0) root         (0)        0 2024-03-26 15:16:13.000000 BioTEMPy-2.2.0a0/TEMPy/graphics/__init__.py
--rw-rw-rw-   0 root         (0) root         (0)    20832 2024-03-26 15:06:45.000000 BioTEMPy-2.2.0a0/TEMPy/graphics/show_plot.py
-drwxr-xr-x   0 root         (0) root         (0)        0 2024-03-26 15:16:26.000000 BioTEMPy-2.2.0a0/TEMPy/map_process/
--rw-rw-rw-   0 root         (0) root         (0)        0 2024-03-26 15:16:13.000000 BioTEMPy-2.2.0a0/TEMPy/map_process/__init__.py
--rw-rw-rw-   0 root         (0) root         (0)    21815 2024-03-26 15:06:45.000000 BioTEMPy-2.2.0a0/TEMPy/map_process/map_filters.py
--rw-rw-rw-   0 root         (0) root         (0)    31367 2024-03-26 15:06:45.000000 BioTEMPy-2.2.0a0/TEMPy/map_process/process.py
-drwxr-xr-x   0 root         (0) root         (0)        0 2024-03-26 15:16:26.000000 BioTEMPy-2.2.0a0/TEMPy/maps/
--rw-rw-rw-   0 root         (0) root         (0)        0 2024-03-26 15:16:13.000000 BioTEMPy-2.2.0a0/TEMPy/maps/__init__.py
--rwxrwxrwx   0 root         (0) root         (0)    95871 2024-03-26 15:06:45.000000 BioTEMPy-2.2.0a0/TEMPy/maps/em_map.py
--rwxrwxrwx   0 root         (0) root         (0)    17392 2024-03-26 15:06:45.000000 BioTEMPy-2.2.0a0/TEMPy/maps/map_parser.py
--rw-rw-rw-   0 root         (0) root         (0)     4070 2024-03-26 15:06:45.000000 BioTEMPy-2.2.0a0/TEMPy/maps/map_transform_score.py
-drwxr-xr-x   0 root         (0) root         (0)        0 2024-03-26 15:16:26.000000 BioTEMPy-2.2.0a0/TEMPy/math/
--rw-rw-rw-   0 root         (0) root         (0)        0 2024-03-26 15:16:13.000000 BioTEMPy-2.2.0a0/TEMPy/math/__init__.py
--rw-rw-rw-   0 root         (0) root         (0)    29185 2024-03-26 15:06:45.000000 BioTEMPy-2.2.0a0/TEMPy/math/cluster.py
--rw-rw-rw-   0 root         (0) root         (0)    25634 2024-03-26 15:06:45.000000 BioTEMPy-2.2.0a0/TEMPy/math/consensus.py
--rw-rw-rw-   0 root         (0) root         (0)    11869 2024-03-26 15:06:45.000000 BioTEMPy-2.2.0a0/TEMPy/math/fourier.py
--rw-rw-rw-   0 root         (0) root         (0)     5064 2024-03-26 15:06:45.000000 BioTEMPy-2.2.0a0/TEMPy/math/quaternion.py
--rw-rw-rw-   0 root         (0) root         (0)     3201 2024-03-26 15:06:45.000000 BioTEMPy-2.2.0a0/TEMPy/math/transform_parser.py
--rwxrwxrwx   0 root         (0) root         (0)    16705 2024-03-26 15:06:45.000000 BioTEMPy-2.2.0a0/TEMPy/math/vector.py
--rwxrwxrwx   0 root         (0) root         (0)     4746 2024-03-26 15:06:45.000000 BioTEMPy-2.2.0a0/TEMPy/math/vq.py
-drwxr-xr-x   0 root         (0) root         (0)        0 2024-03-26 15:16:26.000000 BioTEMPy-2.2.0a0/TEMPy/optimisation/
--rw-rw-rw-   0 root         (0) root         (0)        0 2024-03-26 15:16:13.000000 BioTEMPy-2.2.0a0/TEMPy/optimisation/__init__.py
--rw-rw-rw-   0 root         (0) root         (0)    10371 2024-03-26 15:06:45.000000 BioTEMPy-2.2.0a0/TEMPy/optimisation/ensemble_generation.py
-drwxr-xr-x   0 root         (0) root         (0)        0 2024-03-26 15:16:26.000000 BioTEMPy-2.2.0a0/TEMPy/protein/
--rw-rw-rw-   0 root         (0) root         (0)        0 2024-03-26 15:16:13.000000 BioTEMPy-2.2.0a0/TEMPy/protein/__init__.py
--rw-rw-rw-   0 root         (0) root         (0)     1719 2024-03-26 15:06:45.000000 BioTEMPy-2.2.0a0/TEMPy/protein/blur.py
--rw-rw-rw-   0 root         (0) root         (0)    12573 2024-03-26 15:06:45.000000 BioTEMPy-2.2.0a0/TEMPy/protein/density_calculator.py
--rw-rw-rw-   0 root         (0) root         (0)    14647 2024-03-26 15:06:45.000000 BioTEMPy-2.2.0a0/TEMPy/protein/mmcif.py
--rw-rw-rw-   0 root         (0) root         (0)    68320 2024-03-26 15:06:45.000000 BioTEMPy-2.2.0a0/TEMPy/protein/prot_rep_biopy.py
--rw-rw-rw-   0 root         (0) root         (0)    11687 2024-03-26 15:06:45.000000 BioTEMPy-2.2.0a0/TEMPy/protein/rigid_body_parser.py
-drwxr-xr-x   0 root         (0) root         (0)        0 2024-03-26 15:16:26.000000 BioTEMPy-2.2.0a0/TEMPy/protein/scores/
--rw-rw-rw-   0 root         (0) root         (0)     1000 2024-03-26 15:06:45.000000 BioTEMPy-2.2.0a0/TEMPy/protein/scores/__init__.py
--rw-rw-rw-   0 root         (0) root         (0)     6888 2024-03-26 15:06:45.000000 BioTEMPy-2.2.0a0/TEMPy/protein/scores/base_classes.py
--rw-rw-rw-   0 root         (0) root         (0)    31507 2024-03-26 15:06:45.000000 BioTEMPy-2.2.0a0/TEMPy/protein/scores/glob.py
--rw-rw-rw-   0 root         (0) root         (0)    17213 2024-03-26 15:06:45.000000 BioTEMPy-2.2.0a0/TEMPy/protein/scores/local.py
--rw-rw-rw-   0 root         (0) root         (0)     2964 2024-03-26 15:06:45.000000 BioTEMPy-2.2.0a0/TEMPy/protein/scores/segmented.py
--rw-rw-rw-   0 root         (0) root         (0)   144961 2024-03-26 15:06:45.000000 BioTEMPy-2.2.0a0/TEMPy/protein/scoring_functions.py
--rwxrwxrwx   0 root         (0) root         (0)    54468 2024-03-26 15:06:45.000000 BioTEMPy-2.2.0a0/TEMPy/protein/structure_blurrer.py
--rw-rw-rw-   0 root         (0) root         (0)    19018 2024-03-26 15:06:45.000000 BioTEMPy-2.2.0a0/TEMPy/protein/structure_parser.py
-drwxr-xr-x   0 root         (0) root         (0)        0 2024-03-26 15:16:26.000000 BioTEMPy-2.2.0a0/TEMPy/script/
--rw-rw-rw-   0 root         (0) root         (0)        0 2024-03-26 15:16:13.000000 BioTEMPy-2.2.0a0/TEMPy/script/__init__.py
--rw-rw-rw-   0 root         (0) root         (0)    10663 2024-03-26 15:06:45.000000 BioTEMPy-2.2.0a0/TEMPy/script/gamma.py
--rw-rw-rw-   0 root         (0) root         (0)     5045 2024-03-26 15:06:45.000000 BioTEMPy-2.2.0a0/TEMPy/script/loqfit.py
--rw-rw-rw-   0 root         (0) root         (0)     2538 2024-03-26 15:06:45.000000 BioTEMPy-2.2.0a0/TEMPy/script/mi.py
--rw-rw-rw-   0 root         (0) root         (0)    11963 2024-03-26 15:06:45.000000 BioTEMPy-2.2.0a0/TEMPy/script/output.py
--rw-rw-rw-   0 root         (0) root         (0)     2710 2024-03-26 15:06:45.000000 BioTEMPy-2.2.0a0/TEMPy/script/sccc.py
--rw-rw-rw-   0 root         (0) root         (0)     4028 2024-03-26 15:06:45.000000 BioTEMPy-2.2.0a0/TEMPy/script/smoc.py
-drwxr-xr-x   0 root         (0) root         (0)        0 2024-03-26 15:16:26.000000 BioTEMPy-2.2.0a0/TEMPy/tempy_data/
--rw-rw-rw-   0 root         (0) root         (0)   523370 2024-03-26 15:06:45.000000 BioTEMPy-2.2.0a0/TEMPy/tempy_data/quaternion_vectors_5000.pk
--rw-r--r--   0 root         (0) root         (0)       38 2024-03-26 15:16:26.000000 BioTEMPy-2.2.0a0/setup.cfg
--rw-rw-rw-   0 root         (0) root         (0)     1290 2024-03-26 15:06:45.000000 BioTEMPy-2.2.0a0/setup.py
+drwxr-xr-x   0 root         (0) root         (0)        0 2024-04-15 13:10:10.000000 BioTEMPy-2.2.0a1/
+drwxr-xr-x   0 root         (0) root         (0)        0 2024-04-15 13:10:10.000000 BioTEMPy-2.2.0a1/BioTEMPy.egg-info/
+-rw-r--r--   0 root         (0) root         (0)      499 2024-04-15 13:10:10.000000 BioTEMPy-2.2.0a1/BioTEMPy.egg-info/PKG-INFO
+-rw-r--r--   0 root         (0) root         (0)     1723 2024-04-15 13:10:10.000000 BioTEMPy-2.2.0a1/BioTEMPy.egg-info/SOURCES.txt
+-rw-r--r--   0 root         (0) root         (0)        1 2024-04-15 13:10:10.000000 BioTEMPy-2.2.0a1/BioTEMPy.egg-info/dependency_links.txt
+-rw-r--r--   0 root         (0) root         (0)      209 2024-04-15 13:10:10.000000 BioTEMPy-2.2.0a1/BioTEMPy.egg-info/entry_points.txt
+-rw-r--r--   0 root         (0) root         (0)       80 2024-04-15 13:10:10.000000 BioTEMPy-2.2.0a1/BioTEMPy.egg-info/requires.txt
+-rw-r--r--   0 root         (0) root         (0)        6 2024-04-15 13:10:10.000000 BioTEMPy-2.2.0a1/BioTEMPy.egg-info/top_level.txt
+-rw-r--r--   0 root         (0) root         (0)      499 2024-04-15 13:10:10.000000 BioTEMPy-2.2.0a1/PKG-INFO
+-rw-rw-rw-   0 root         (0) root         (0)     3329 2024-03-25 16:02:14.000000 BioTEMPy-2.2.0a1/README.md
+drwxr-xr-x   0 root         (0) root         (0)        0 2024-04-15 13:10:10.000000 BioTEMPy-2.2.0a1/TEMPy/
+-rw-rw-rw-   0 root         (0) root         (0)       52 2022-07-12 12:03:45.000000 BioTEMPy-2.2.0a1/TEMPy/__init__.py
+-rw-rw-rw-   0 root         (0) root         (0)       26 2022-07-12 12:03:45.000000 BioTEMPy-2.2.0a1/TEMPy/_version.py
+drwxr-xr-x   0 root         (0) root         (0)        0 2024-04-15 13:10:10.000000 BioTEMPy-2.2.0a1/TEMPy/assembly/
+-rw-rw-rw-   0 root         (0) root         (0)        0 2022-07-12 12:03:45.000000 BioTEMPy-2.2.0a1/TEMPy/assembly/__init__.py
+-rwxrwxrwx   0 root         (0) root         (0)    13073 2022-07-12 12:03:45.000000 BioTEMPy-2.2.0a1/TEMPy/assembly/assembly.py
+-rw-rw-rw-   0 root         (0) root         (0)    46773 2024-03-25 16:02:14.000000 BioTEMPy-2.2.0a1/TEMPy/assembly/gamma.py
+drwxr-xr-x   0 root         (0) root         (0)        0 2024-04-15 13:10:10.000000 BioTEMPy-2.2.0a1/TEMPy/cli/
+-rw-rw-rw-   0 root         (0) root         (0)        0 2022-07-12 12:03:45.000000 BioTEMPy-2.2.0a1/TEMPy/cli/__init__.py
+-rw-rw-rw-   0 root         (0) root         (0)    14142 2024-04-15 12:35:53.000000 BioTEMPy-2.2.0a1/TEMPy/cli/arg_parser.py
+-rw-rw-rw-   0 root         (0) root         (0)    11044 2022-07-12 12:03:45.000000 BioTEMPy-2.2.0a1/TEMPy/cli/class_arg.py
+drwxr-xr-x   0 root         (0) root         (0)        0 2024-04-15 13:10:10.000000 BioTEMPy-2.2.0a1/TEMPy/core/
+-rw-rw-rw-   0 root         (0) root         (0)        0 2022-07-12 12:03:45.000000 BioTEMPy-2.2.0a1/TEMPy/core/__init__.py
+drwxr-xr-x   0 root         (0) root         (0)        0 2024-04-15 13:10:10.000000 BioTEMPy-2.2.0a1/TEMPy/core/data/
+-rw-rw-rw-   0 root         (0) root         (0)       82 2022-07-12 12:03:45.000000 BioTEMPy-2.2.0a1/TEMPy/core/data/__init__.py
+-rw-rw-rw-   0 root         (0) root         (0)     1778 2022-07-12 12:03:45.000000 BioTEMPy-2.2.0a1/TEMPy/core/data/download.py
+drwxr-xr-x   0 root         (0) root         (0)        0 2024-04-15 13:10:10.000000 BioTEMPy-2.2.0a1/TEMPy/core/errors/
+-rw-rw-rw-   0 root         (0) root         (0)       86 2022-07-12 12:03:45.000000 BioTEMPy-2.2.0a1/TEMPy/core/errors/__init__.py
+-rw-rw-rw-   0 root         (0) root         (0)      149 2022-07-12 12:03:45.000000 BioTEMPy-2.2.0a1/TEMPy/core/errors/instance.py
+-rw-rw-rw-   0 root         (0) root         (0)     1381 2024-03-25 16:02:14.000000 BioTEMPy-2.2.0a1/TEMPy/core/warn.py
+drwxr-xr-x   0 root         (0) root         (0)        0 2024-04-15 13:10:10.000000 BioTEMPy-2.2.0a1/TEMPy/graphics/
+-rw-rw-rw-   0 root         (0) root         (0)        0 2022-07-12 12:03:45.000000 BioTEMPy-2.2.0a1/TEMPy/graphics/__init__.py
+-rw-rw-rw-   0 root         (0) root         (0)    20832 2022-07-12 12:03:45.000000 BioTEMPy-2.2.0a1/TEMPy/graphics/show_plot.py
+drwxr-xr-x   0 root         (0) root         (0)        0 2024-04-15 13:10:10.000000 BioTEMPy-2.2.0a1/TEMPy/map_process/
+-rw-rw-rw-   0 root         (0) root         (0)        0 2022-07-12 12:03:45.000000 BioTEMPy-2.2.0a1/TEMPy/map_process/__init__.py
+-rw-rw-rw-   0 root         (0) root         (0)    21815 2024-03-25 16:02:14.000000 BioTEMPy-2.2.0a1/TEMPy/map_process/map_filters.py
+-rw-rw-rw-   0 root         (0) root         (0)    31367 2023-04-26 10:48:58.000000 BioTEMPy-2.2.0a1/TEMPy/map_process/process.py
+drwxr-xr-x   0 root         (0) root         (0)        0 2024-04-15 13:10:10.000000 BioTEMPy-2.2.0a1/TEMPy/maps/
+-rw-rw-rw-   0 root         (0) root         (0)        0 2022-07-12 12:03:45.000000 BioTEMPy-2.2.0a1/TEMPy/maps/__init__.py
+-rwxrwxrwx   0 root         (0) root         (0)    95871 2024-03-25 16:02:14.000000 BioTEMPy-2.2.0a1/TEMPy/maps/em_map.py
+-rwxrwxrwx   0 root         (0) root         (0)    17392 2022-07-12 12:03:45.000000 BioTEMPy-2.2.0a1/TEMPy/maps/map_parser.py
+-rw-rw-rw-   0 root         (0) root         (0)     4070 2022-11-18 16:17:02.000000 BioTEMPy-2.2.0a1/TEMPy/maps/map_transform_score.py
+drwxr-xr-x   0 root         (0) root         (0)        0 2024-04-15 13:10:10.000000 BioTEMPy-2.2.0a1/TEMPy/math/
+-rw-rw-rw-   0 root         (0) root         (0)        0 2022-07-12 12:03:45.000000 BioTEMPy-2.2.0a1/TEMPy/math/__init__.py
+-rw-rw-rw-   0 root         (0) root         (0)    29185 2022-07-12 12:03:45.000000 BioTEMPy-2.2.0a1/TEMPy/math/cluster.py
+-rw-rw-rw-   0 root         (0) root         (0)    25634 2022-07-12 12:03:45.000000 BioTEMPy-2.2.0a1/TEMPy/math/consensus.py
+-rw-rw-rw-   0 root         (0) root         (0)    11869 2022-07-12 12:03:45.000000 BioTEMPy-2.2.0a1/TEMPy/math/fourier.py
+-rw-rw-rw-   0 root         (0) root         (0)     5064 2022-07-12 12:03:45.000000 BioTEMPy-2.2.0a1/TEMPy/math/quaternion.py
+-rw-rw-rw-   0 root         (0) root         (0)     3201 2022-07-12 12:03:45.000000 BioTEMPy-2.2.0a1/TEMPy/math/transform_parser.py
+-rwxrwxrwx   0 root         (0) root         (0)    16705 2024-03-25 16:02:14.000000 BioTEMPy-2.2.0a1/TEMPy/math/vector.py
+-rwxrwxrwx   0 root         (0) root         (0)     4746 2022-07-12 12:03:45.000000 BioTEMPy-2.2.0a1/TEMPy/math/vq.py
+drwxr-xr-x   0 root         (0) root         (0)        0 2024-04-15 13:10:10.000000 BioTEMPy-2.2.0a1/TEMPy/optimisation/
+-rw-rw-rw-   0 root         (0) root         (0)        0 2022-07-12 12:03:45.000000 BioTEMPy-2.2.0a1/TEMPy/optimisation/__init__.py
+-rw-rw-rw-   0 root         (0) root         (0)    10371 2022-07-12 12:03:45.000000 BioTEMPy-2.2.0a1/TEMPy/optimisation/ensemble_generation.py
+drwxr-xr-x   0 root         (0) root         (0)        0 2024-04-15 13:10:10.000000 BioTEMPy-2.2.0a1/TEMPy/protein/
+-rw-rw-rw-   0 root         (0) root         (0)        0 2022-07-12 12:03:45.000000 BioTEMPy-2.2.0a1/TEMPy/protein/__init__.py
+-rw-rw-rw-   0 root         (0) root         (0)     1719 2024-03-25 16:02:14.000000 BioTEMPy-2.2.0a1/TEMPy/protein/blur.py
+-rw-rw-rw-   0 root         (0) root         (0)    12573 2024-03-25 16:02:14.000000 BioTEMPy-2.2.0a1/TEMPy/protein/density_calculator.py
+-rw-rw-rw-   0 root         (0) root         (0)    14647 2023-04-26 14:26:52.000000 BioTEMPy-2.2.0a1/TEMPy/protein/mmcif.py
+-rw-rw-rw-   0 root         (0) root         (0)    68320 2024-03-25 16:02:14.000000 BioTEMPy-2.2.0a1/TEMPy/protein/prot_rep_biopy.py
+-rw-rw-rw-   0 root         (0) root         (0)    11687 2022-07-12 12:03:45.000000 BioTEMPy-2.2.0a1/TEMPy/protein/rigid_body_parser.py
+drwxr-xr-x   0 root         (0) root         (0)        0 2024-04-15 13:10:10.000000 BioTEMPy-2.2.0a1/TEMPy/protein/scores/
+-rw-rw-rw-   0 root         (0) root         (0)     1000 2024-03-25 16:02:14.000000 BioTEMPy-2.2.0a1/TEMPy/protein/scores/__init__.py
+-rw-rw-rw-   0 root         (0) root         (0)     6888 2024-03-25 16:02:14.000000 BioTEMPy-2.2.0a1/TEMPy/protein/scores/base_classes.py
+-rw-rw-rw-   0 root         (0) root         (0)    31507 2024-03-25 16:02:14.000000 BioTEMPy-2.2.0a1/TEMPy/protein/scores/glob.py
+-rw-rw-rw-   0 root         (0) root         (0)    17213 2024-03-25 16:02:14.000000 BioTEMPy-2.2.0a1/TEMPy/protein/scores/local.py
+-rw-rw-rw-   0 root         (0) root         (0)     2964 2024-03-25 16:02:14.000000 BioTEMPy-2.2.0a1/TEMPy/protein/scores/segmented.py
+-rw-rw-rw-   0 root         (0) root         (0)   145324 2024-04-15 12:35:53.000000 BioTEMPy-2.2.0a1/TEMPy/protein/scoring_functions.py
+-rwxrwxrwx   0 root         (0) root         (0)    54468 2024-03-25 16:02:14.000000 BioTEMPy-2.2.0a1/TEMPy/protein/structure_blurrer.py
+-rw-rw-rw-   0 root         (0) root         (0)    19018 2024-03-26 11:36:45.000000 BioTEMPy-2.2.0a1/TEMPy/protein/structure_parser.py
+drwxr-xr-x   0 root         (0) root         (0)        0 2024-04-15 13:10:10.000000 BioTEMPy-2.2.0a1/TEMPy/script/
+-rw-rw-rw-   0 root         (0) root         (0)        0 2022-07-12 13:26:42.000000 BioTEMPy-2.2.0a1/TEMPy/script/__init__.py
+-rw-rw-rw-   0 root         (0) root         (0)    10663 2023-04-26 14:26:52.000000 BioTEMPy-2.2.0a1/TEMPy/script/gamma.py
+-rw-rw-rw-   0 root         (0) root         (0)     5045 2023-04-26 14:26:52.000000 BioTEMPy-2.2.0a1/TEMPy/script/loqfit.py
+-rw-rw-rw-   0 root         (0) root         (0)     2538 2023-04-26 14:26:52.000000 BioTEMPy-2.2.0a1/TEMPy/script/mi.py
+-rw-rw-rw-   0 root         (0) root         (0)    11963 2023-04-26 14:26:52.000000 BioTEMPy-2.2.0a1/TEMPy/script/output.py
+-rw-rw-rw-   0 root         (0) root         (0)     2710 2023-04-26 14:26:52.000000 BioTEMPy-2.2.0a1/TEMPy/script/sccc.py
+-rw-rw-rw-   0 root         (0) root         (0)     5843 2024-04-15 12:35:53.000000 BioTEMPy-2.2.0a1/TEMPy/script/scores.py
+-rw-rw-rw-   0 root         (0) root         (0)     4028 2023-04-26 14:26:52.000000 BioTEMPy-2.2.0a1/TEMPy/script/smoc.py
+drwxr-xr-x   0 root         (0) root         (0)        0 2024-04-15 13:10:10.000000 BioTEMPy-2.2.0a1/TEMPy/tempy_data/
+-rw-rw-rw-   0 root         (0) root         (0)   523370 2022-07-12 12:03:45.000000 BioTEMPy-2.2.0a1/TEMPy/tempy_data/quaternion_vectors_5000.pk
+-rw-r--r--   0 root         (0) root         (0)       38 2024-04-15 13:10:10.000000 BioTEMPy-2.2.0a1/setup.cfg
+-rw-rw-rw-   0 root         (0) root         (0)     1359 2024-04-15 12:46:52.000000 BioTEMPy-2.2.0a1/setup.py
```

### Comparing `BioTEMPy-2.2.0a0/BioTEMPy.egg-info/SOURCES.txt` & `BioTEMPy-2.2.0a1/BioTEMPy.egg-info/SOURCES.txt`

 * *Files 1% similar despite different names*

```diff
@@ -55,9 +55,10 @@
 TEMPy/protein/scores/segmented.py
 TEMPy/script/__init__.py
 TEMPy/script/gamma.py
 TEMPy/script/loqfit.py
 TEMPy/script/mi.py
 TEMPy/script/output.py
 TEMPy/script/sccc.py
+TEMPy/script/scores.py
 TEMPy/script/smoc.py
 TEMPy/tempy_data/quaternion_vectors_5000.pk
```

### Comparing `BioTEMPy-2.2.0a0/README.md` & `BioTEMPy-2.2.0a1/README.md`

 * *Files identical despite different names*

### Comparing `BioTEMPy-2.2.0a0/TEMPy/assembly/assembly.py` & `BioTEMPy-2.2.0a1/TEMPy/assembly/assembly.py`

 * *Files identical despite different names*

### Comparing `BioTEMPy-2.2.0a0/TEMPy/assembly/gamma.py` & `BioTEMPy-2.2.0a1/TEMPy/assembly/gamma.py`

 * *Files identical despite different names*

### Comparing `BioTEMPy-2.2.0a0/TEMPy/cli/arg_parser.py` & `BioTEMPy-2.2.0a1/TEMPy/cli/arg_parser.py`

 * *Files 0% similar despite different names*

```diff
@@ -1,10 +1,11 @@
 import argparse
 import os
 import urllib
+import urllib.request
 import tempfile
 from TEMPy.protein.structure_parser import PDBParser, mmCIFParser
 from TEMPy.maps.map_parser import MapParser
 
 
 class Model:
     NUM_MODELS = 0
```

### Comparing `BioTEMPy-2.2.0a0/TEMPy/cli/class_arg.py` & `BioTEMPy-2.2.0a1/TEMPy/cli/class_arg.py`

 * *Files identical despite different names*

### Comparing `BioTEMPy-2.2.0a0/TEMPy/core/data/download.py` & `BioTEMPy-2.2.0a1/TEMPy/core/data/download.py`

 * *Files identical despite different names*

### Comparing `BioTEMPy-2.2.0a0/TEMPy/core/warn.py` & `BioTEMPy-2.2.0a1/TEMPy/core/warn.py`

 * *Files identical despite different names*

### Comparing `BioTEMPy-2.2.0a0/TEMPy/graphics/show_plot.py` & `BioTEMPy-2.2.0a1/TEMPy/graphics/show_plot.py`

 * *Files identical despite different names*

### Comparing `BioTEMPy-2.2.0a0/TEMPy/map_process/map_filters.py` & `BioTEMPy-2.2.0a1/TEMPy/map_process/map_filters.py`

 * *Files identical despite different names*

### Comparing `BioTEMPy-2.2.0a0/TEMPy/map_process/process.py` & `BioTEMPy-2.2.0a1/TEMPy/map_process/process.py`

 * *Files identical despite different names*

### Comparing `BioTEMPy-2.2.0a0/TEMPy/maps/em_map.py` & `BioTEMPy-2.2.0a1/TEMPy/maps/em_map.py`

 * *Files identical despite different names*

### Comparing `BioTEMPy-2.2.0a0/TEMPy/maps/map_parser.py` & `BioTEMPy-2.2.0a1/TEMPy/maps/map_parser.py`

 * *Files identical despite different names*

### Comparing `BioTEMPy-2.2.0a0/TEMPy/maps/map_transform_score.py` & `BioTEMPy-2.2.0a1/TEMPy/maps/map_transform_score.py`

 * *Files identical despite different names*

### Comparing `BioTEMPy-2.2.0a0/TEMPy/math/cluster.py` & `BioTEMPy-2.2.0a1/TEMPy/math/cluster.py`

 * *Files identical despite different names*

### Comparing `BioTEMPy-2.2.0a0/TEMPy/math/consensus.py` & `BioTEMPy-2.2.0a1/TEMPy/math/consensus.py`

 * *Files identical despite different names*

### Comparing `BioTEMPy-2.2.0a0/TEMPy/math/fourier.py` & `BioTEMPy-2.2.0a1/TEMPy/math/fourier.py`

 * *Files identical despite different names*

### Comparing `BioTEMPy-2.2.0a0/TEMPy/math/quaternion.py` & `BioTEMPy-2.2.0a1/TEMPy/math/quaternion.py`

 * *Files identical despite different names*

### Comparing `BioTEMPy-2.2.0a0/TEMPy/math/transform_parser.py` & `BioTEMPy-2.2.0a1/TEMPy/math/transform_parser.py`

 * *Files identical despite different names*

### Comparing `BioTEMPy-2.2.0a0/TEMPy/math/vector.py` & `BioTEMPy-2.2.0a1/TEMPy/math/vector.py`

 * *Files identical despite different names*

### Comparing `BioTEMPy-2.2.0a0/TEMPy/math/vq.py` & `BioTEMPy-2.2.0a1/TEMPy/math/vq.py`

 * *Files identical despite different names*

### Comparing `BioTEMPy-2.2.0a0/TEMPy/optimisation/ensemble_generation.py` & `BioTEMPy-2.2.0a1/TEMPy/optimisation/ensemble_generation.py`

 * *Files identical despite different names*

### Comparing `BioTEMPy-2.2.0a0/TEMPy/protein/blur.py` & `BioTEMPy-2.2.0a1/TEMPy/protein/blur.py`

 * *Files identical despite different names*

### Comparing `BioTEMPy-2.2.0a0/TEMPy/protein/density_calculator.py` & `BioTEMPy-2.2.0a1/TEMPy/protein/density_calculator.py`

 * *Files identical despite different names*

### Comparing `BioTEMPy-2.2.0a0/TEMPy/protein/mmcif.py` & `BioTEMPy-2.2.0a1/TEMPy/protein/mmcif.py`

 * *Files identical despite different names*

### Comparing `BioTEMPy-2.2.0a0/TEMPy/protein/prot_rep_biopy.py` & `BioTEMPy-2.2.0a1/TEMPy/protein/prot_rep_biopy.py`

 * *Files identical despite different names*

### Comparing `BioTEMPy-2.2.0a0/TEMPy/protein/rigid_body_parser.py` & `BioTEMPy-2.2.0a1/TEMPy/protein/rigid_body_parser.py`

 * *Files identical despite different names*

### Comparing `BioTEMPy-2.2.0a0/TEMPy/protein/scores/__init__.py` & `BioTEMPy-2.2.0a1/TEMPy/protein/scores/__init__.py`

 * *Files identical despite different names*

### Comparing `BioTEMPy-2.2.0a0/TEMPy/protein/scores/base_classes.py` & `BioTEMPy-2.2.0a1/TEMPy/protein/scores/base_classes.py`

 * *Files identical despite different names*

### Comparing `BioTEMPy-2.2.0a0/TEMPy/protein/scores/glob.py` & `BioTEMPy-2.2.0a1/TEMPy/protein/scores/glob.py`

 * *Files identical despite different names*

### Comparing `BioTEMPy-2.2.0a0/TEMPy/protein/scores/local.py` & `BioTEMPy-2.2.0a1/TEMPy/protein/scores/local.py`

 * *Files identical despite different names*

### Comparing `BioTEMPy-2.2.0a0/TEMPy/protein/scores/segmented.py` & `BioTEMPy-2.2.0a1/TEMPy/protein/scores/segmented.py`

 * *Files identical despite different names*

### Comparing `BioTEMPy-2.2.0a0/TEMPy/protein/scoring_functions.py` & `BioTEMPy-2.2.0a1/TEMPy/protein/scoring_functions.py`

 * *Files 1% similar despite different names*

```diff
@@ -398,8664 +398,8686 @@
 000018d0: 206d 6170 5f74 6172 6765 745f 7468 7265   map_target_thre
 000018e0: 7368 6f6c 642c 0a20 2020 2020 2020 2020  shold,.         
 000018f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00001900: 2020 2020 2020 206d 6170 5f70 726f 6265         map_probe
 00001910: 5f74 6872 6573 686f 6c64 0a20 2020 2020  _threshold.     
 00001920: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00001930: 2020 2020 2020 2020 2020 2029 3a0a 2020             ):.  
-00001940: 2020 2020 2020 2222 2243 7572 7265 6e74        """Current
-00001950: 6c79 2062 726f 6b65 6e3a 206e 702e 6e75  ly broken: np.nu
-00001960: 6d73 756d 2064 6f65 736e 2774 2065 7869  msum doesn't exi
-00001970: 7374 2069 6e20 6375 7272 656e 7420 6e75  st in current nu
-00001980: 6d70 7920 7665 7273 696f 6e0a 0a0a 2020  mpy version...  
-00001990: 2020 2020 2020 2020 2020 6d61 736b 206d            mask m
-000019a0: 6170 7320 7769 7468 2032 2063 7574 2d6f  aps with 2 cut-o
-000019b0: 6666 206d 6170 5f74 6172 6765 745f 7468  ff map_target_th
-000019c0: 7265 7368 6f6c 6420 616e 640a 2020 2020  reshold and.    
-000019d0: 2020 2020 2020 2020 6d61 705f 7072 6f62          map_prob
-000019e0: 655f 7468 7265 7368 6f6c 6420 2876 6f6c  e_threshold (vol
-000019f0: 2074 6872 2e29 0a0a 2020 2020 2020 2020   thr.)..        
-00001a00: 2020 2020 7265 7475 726e 3a0a 2020 2020      return:.    
-00001a10: 2020 2020 2020 2020 6672 6163 7469 6f6e          fraction
-00001a20: 206f 6620 6f76 6572 6c61 7020 7769 7468   of overlap with
-00001a30: 2072 6573 7065 6374 2074 6f20 7461 7267   respect to targ
-00001a40: 6574 2c20 616e 6420 7769 7468 2072 6573  et, and with res
-00001a50: 7065 6374 2074 6f0a 2020 2020 2020 2020  pect to.        
-00001a60: 2020 2020 7072 6f62 650a 2020 2020 2020      probe.      
-00001a70: 2020 2222 220a 0a20 2020 2020 2020 2062    """..        b
-00001a80: 696e 6d61 7031 203d 206d 6170 5f74 6172  inmap1 = map_tar
-00001a90: 6765 742e 6675 6c6c 4d61 7020 3e20 666c  get.fullMap > fl
-00001aa0: 6f61 7428 6d61 705f 7461 7267 6574 5f74  oat(map_target_t
-00001ab0: 6872 6573 686f 6c64 290a 2020 2020 2020  hreshold).      
-00001ac0: 2020 6269 6e6d 6170 3220 3d20 6d61 705f    binmap2 = map_
-00001ad0: 7072 6f62 652e 6675 6c6c 4d61 7020 3e20  probe.fullMap > 
-00001ae0: 666c 6f61 7428 6d61 705f 7072 6f62 655f  float(map_probe_
-00001af0: 7468 7265 7368 6f6c 6429 0a20 2020 2020  threshold).     
-00001b00: 2020 206d 6173 6b5f 6172 7261 7920 3d20     mask_array = 
-00001b10: 2862 696e 6d61 7031 202a 2062 696e 6d61  (binmap1 * binma
-00001b20: 7032 2920 3e20 300a 0a20 2020 2020 2020  p2) > 0..       
-00001b30: 2073 697a 6531 203d 206e 702e 6e75 6d73   size1 = np.nums
-00001b40: 756d 2862 696e 6d61 7031 2920 2023 2063  um(binmap1)  # c
-00001b50: 616e 2774 2066 696e 6420 6e75 6d73 756d  an't find numsum
-00001b60: 2069 6e20 6e75 6d70 7920 646f 6373 0a20   in numpy docs. 
-00001b70: 2020 2020 2020 2073 697a 6532 203d 206e         size2 = n
-00001b80: 702e 6e75 6d73 756d 2862 696e 6d61 7032  p.numsum(binmap2
-00001b90: 290a 2020 2020 2020 2020 7265 7475 726e  ).        return
-00001ba0: 2066 6c6f 6174 286e 702e 6e75 6d73 756d   float(np.numsum
-00001bb0: 286d 6173 6b5f 6172 7261 7929 2920 2f20  (mask_array)) / 
-00001bc0: 7369 7a65 312c 205c 0a20 2020 2020 2020  size1, \.       
-00001bd0: 2020 2020 2066 6c6f 6174 286e 702e 6e75       float(np.nu
-00001be0: 6d73 756d 286d 6173 6b5f 6172 7261 7929  msum(mask_array)
-00001bf0: 2920 2f20 7369 7a65 320a 0a20 2020 2064  ) / size2..    d
-00001c00: 6566 205f 6f76 6572 6c61 705f 6d61 705f  ef _overlap_map_
-00001c10: 6172 7261 7928 0a20 2020 2020 2020 2020  array(.         
-00001c20: 2020 2073 656c 662c 0a20 2020 2020 2020     self,.       
-00001c30: 2020 2020 206d 6170 5f74 6172 6765 742c       map_target,
-00001c40: 0a20 2020 2020 2020 2020 2020 206d 6170  .            map
-00001c50: 5f74 6172 6765 745f 7468 7265 7368 6f6c  _target_threshol
-00001c60: 642c 0a20 2020 2020 2020 2020 2020 206d  d,.            m
-00001c70: 6170 5f70 726f 6265 2c0a 2020 2020 2020  ap_probe,.      
-00001c80: 2020 2020 2020 6d61 705f 7072 6f62 655f        map_probe_
-00001c90: 7468 7265 7368 6f6c 642c 0a20 2020 2029  threshold,.    )
-00001ca0: 3a0a 2020 2020 2020 2020 2222 2248 656c  :.        """Hel
-00001cb0: 7065 7220 6675 6e63 7469 6f6e 2066 6f72  per function for
-00001cc0: 206d 7574 7561 6c20 696e 666f 726d 6174   mutual informat
-00001cd0: 696f 6e20 6361 6c63 756c 6174 696f 6e2e  ion calculation.
-00001ce0: 0a0a 2020 2020 2020 2020 4d61 736b 7320  ..        Masks 
-00001cf0: 6d61 7073 2075 7369 6e67 2075 6e69 7175  maps using uniqu
-00001d00: 6520 6375 746f 6666 2066 6f72 2065 6163  e cutoff for eac
-00001d10: 6820 286d 6170 5f74 6172 6765 745f 7468  h (map_target_th
-00001d20: 7265 7368 6f6c 6420 616e 640a 2020 2020  reshold and.    
-00001d30: 2020 2020 6d61 705f 7072 6f62 655f 7468      map_probe_th
-00001d40: 7265 7368 6f6c 6429 2061 6e64 2072 6574  reshold) and ret
-00001d50: 7572 6e73 2061 2066 696e 616c 206d 6173  urns a final mas
-00001d60: 6b20 7768 6963 6820 6973 2054 7275 6520  k which is True 
-00001d70: 7768 6572 650a 2020 2020 2020 2020 626f  where.        bo
-00001d80: 7468 206d 6170 7320 6172 6520 6162 6f76  th maps are abov
-00001d90: 6520 7468 6569 7220 7265 7370 6563 7469  e their respecti
-00001da0: 7665 2074 6872 6573 686f 6c64 732e 0a0a  ve thresholds...
-00001db0: 2020 2020 2020 2020 4172 6773 3a0a 2020          Args:.  
-00001dc0: 2020 2020 2020 2020 2020 6d61 705f 7461            map_ta
-00001dd0: 7267 6574 2c20 6d61 705f 7072 6f62 653a  rget, map_probe:
-00001de0: 2049 6e70 7574 204d 6170 2069 6e73 7461   Input Map insta
-00001df0: 6e63 650a 2020 2020 2020 2020 2020 2020  nce.            
-00001e00: 6d61 705f 7461 7267 6574 5f74 6872 6573  map_target_thres
-00001e10: 686f 6c64 2c20 6d61 705f 7072 6f62 655f  hold, map_probe_
-00001e20: 7468 7265 7368 6f6c 643a 2054 6872 6573  threshold: Thres
-00001e30: 686f 6c64 2075 7365 6420 746f 206d 6173  hold used to mas
-00001e40: 6b0a 2020 2020 2020 2020 2020 2020 7265  k.            re
-00001e50: 7370 6563 7469 7665 206d 6170 2069 6e73  spective map ins
-00001e60: 7461 6e63 650a 0a20 2020 2020 2020 2052  tance..        R
-00001e70: 6574 7572 6e73 3a0a 2020 2020 2020 2020  eturns:.        
-00001e80: 2020 2020 6d61 736b 5f61 7272 6179 3a20      mask_array: 
-00001e90: 4d61 736b 2077 6869 6368 2069 7320 7472  Mask which is tr
-00001ea0: 7565 2077 6865 7265 2062 6f74 6820 6d61  ue where both ma
-00001eb0: 7073 2061 7265 2061 626f 7665 2074 6865  ps are above the
-00001ec0: 6972 0a20 2020 2020 2020 2020 2020 2072  ir.            r
-00001ed0: 6573 7065 6374 6976 6520 7468 7265 7368  espective thresh
-00001ee0: 6f6c 6473 2e0a 2020 2020 2020 2020 2222  olds..        ""
-00001ef0: 220a 2020 2020 2020 2020 6269 6e6d 6170  ".        binmap
-00001f00: 3120 3d20 6d61 705f 7461 7267 6574 2e66  1 = map_target.f
-00001f10: 756c 6c4d 6170 203e 2066 6c6f 6174 286d  ullMap > float(m
-00001f20: 6170 5f74 6172 6765 745f 7468 7265 7368  ap_target_thresh
-00001f30: 6f6c 6429 0a20 2020 2020 2020 2062 696e  old).        bin
-00001f40: 6d61 7032 203d 206d 6170 5f70 726f 6265  map2 = map_probe
-00001f50: 2e66 756c 6c4d 6170 203e 2066 6c6f 6174  .fullMap > float
-00001f60: 286d 6170 5f70 726f 6265 5f74 6872 6573  (map_probe_thres
-00001f70: 686f 6c64 290a 2020 2020 2020 2020 6d61  hold).        ma
-00001f80: 736b 5f61 7272 6179 203d 2028 6269 6e6d  sk_array = (binm
-00001f90: 6170 3120 2a20 6269 6e6d 6170 3229 203e  ap1 * binmap2) >
-00001fa0: 2030 0a20 2020 2020 2020 2072 6574 7572   0.        retur
-00001fb0: 6e20 6d61 736b 5f61 7272 6179 0a0a 2020  n mask_array..  
-00001fc0: 2020 6465 6620 6361 6c63 756c 6174 655f    def calculate_
-00001fd0: 6d61 705f 7468 7265 7368 6f6c 6428 7365  map_threshold(se
-00001fe0: 6c66 2c20 6d61 705f 7461 7267 6574 293a  lf, map_target):
-00001ff0: 0a20 2020 2020 2020 2022 2222 4361 6c63  .        """Calc
-00002000: 756c 6174 6573 206d 6170 2074 6872 6573  ulates map thres
-00002010: 686f 6c64 2061 7320 6d65 616e 2076 616c  hold as mean val
-00002020: 7565 202b 2028 3220 2a20 6d61 7020 7374  ue + (2 * map st
-00002030: 616e 6461 7264 2064 6576 6961 7469 6f6e  andard deviation
-00002040: 290a 0a20 2020 2020 2020 2041 7267 733a  )..        Args:
-00002050: 0a20 2020 2020 2020 2020 2020 206d 6170  .            map
-00002060: 5f74 6172 6765 743a 204d 6170 2069 6e73  _target: Map ins
-00002070: 7461 6e63 650a 0a20 2020 2020 2020 2052  tance..        R
-00002080: 6574 7572 6e73 3a0a 2020 2020 2020 2020  eturns:.        
-00002090: 2020 2020 666c 6f61 743a 2054 6872 6573      float: Thres
-000020a0: 686f 6c64 2076 616c 7565 0a20 2020 2020  hold value.     
-000020b0: 2020 2022 2222 0a20 2020 2020 2020 2023     """.        #
-000020c0: 204e 4f54 453a 204d 4f56 4520 544f 2054   NOTE: MOVE TO T
-000020d0: 454d 5079 2e6d 6170 732e 656d 5f6d 6170  EMPy.maps.em_map
-000020e0: 2e4d 6170 3f3f 0a20 2020 2020 2020 2074  .Map??.        t
-000020f0: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
-00002100: 7065 616b 2c20 6176 652c 2073 6967 6d61  peak, ave, sigma
-00002110: 203d 206d 6170 5f74 6172 6765 742e 5f70   = map_target._p
-00002120: 6561 6b5f 6465 6e73 6974 7928 290a 2020  eak_density().  
-00002130: 2020 2020 2020 2020 2020 766f 6c5f 7468            vol_th
-00002140: 7265 7368 6f6c 6420 3d20 666c 6f61 7428  reshold = float(
-00002150: 6176 6529 202b 2028 322e 3020 2a20 666c  ave) + (2.0 * fl
-00002160: 6f61 7428 7369 676d 6129 290a 2020 2020  oat(sigma)).    
-00002170: 2020 2020 6578 6365 7074 2045 7863 6570      except Excep
-00002180: 7469 6f6e 3a0a 2020 2020 2020 2020 2020  tion:.          
-00002190: 2020 6966 206c 656e 286d 6170 5f74 6172    if len(map_tar
-000021a0: 6765 742e 6865 6164 6572 2920 3d3d 2030  get.header) == 0
-000021b0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-000021c0: 2020 616d 6561 6e20 3d20 6d61 705f 7461    amean = map_ta
-000021d0: 7267 6574 2e6d 6561 6e28 290a 2020 2020  rget.mean().    
-000021e0: 2020 2020 2020 2020 2020 2020 726d 7320              rms 
-000021f0: 3d20 6d61 705f 7461 7267 6574 2e73 7464  = map_target.std
-00002200: 2829 0a20 2020 2020 2020 2020 2020 2020  ().             
-00002210: 2020 2076 6f6c 5f74 6872 6573 686f 6c64     vol_threshold
-00002220: 203d 2066 6c6f 6174 2861 6d65 616e 2920   = float(amean) 
-00002230: 2b20 2831 2e35 202a 2066 6c6f 6174 2872  + (1.5 * float(r
-00002240: 6d73 2929 0a20 2020 2020 2020 2020 2020  ms)).           
-00002250: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-00002260: 2020 2020 2020 2061 6d65 616e 203d 206d         amean = m
-00002270: 6170 5f74 6172 6765 742e 6d65 616e 2829  ap_target.mean()
-00002280: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00002290: 2072 6d73 203d 206d 6170 5f74 6172 6765   rms = map_targe
-000022a0: 742e 7374 6428 290a 2020 2020 2020 2020  t.std().        
-000022b0: 2020 2020 2020 2020 766f 6c5f 7468 7265          vol_thre
-000022c0: 7368 6f6c 6420 3d20 666c 6f61 7428 616d  shold = float(am
-000022d0: 6561 6e29 202b 2028 312e 3520 2a20 666c  ean) + (1.5 * fl
-000022e0: 6f61 7428 726d 7329 290a 2020 2020 2020  oat(rms)).      
-000022f0: 2020 7265 7475 726e 2076 6f6c 5f74 6872    return vol_thr
-00002300: 6573 686f 6c64 0a0a 2020 2020 6465 6620  eshold..    def 
-00002310: 6d61 7043 6f6d 7061 7269 736f 6e28 7365  mapComparison(se
-00002320: 6c66 2c20 6d61 705f 7461 7267 6574 2c20  lf, map_target, 
-00002330: 6d61 705f 7072 6f62 6529 3a0a 2020 2020  map_probe):.    
-00002340: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
-00002350: 4368 6563 6b73 2069 6620 7072 6f70 6572  Checks if proper
-00002360: 7469 6573 2028 7361 6d70 6c69 6e67 2072  ties (sampling r
-00002370: 6174 652c 2062 6f78 2073 697a 6520 616e  ate, box size an
-00002380: 6420 6f72 6967 696e 2920 6f66 2074 776f  d origin) of two
-00002390: 206d 6170 730a 2020 2020 2020 2020 6172   maps.        ar
-000023a0: 6520 6571 7561 6c2e 0a0a 2020 2020 2020  e equal...      
-000023b0: 2020 4172 6773 3a0a 2020 2020 2020 2020    Args:.        
-000023c0: 2020 2020 6d61 705f 7461 7267 6574 2c20      map_target, 
-000023d0: 6d61 705f 7072 6f62 650a 2020 2020 2020  map_probe.      
-000023e0: 2020 2020 2020 2020 2020 4d61 7020 696e            Map in
-000023f0: 7374 616e 6365 2074 6f20 636f 6d70 6172  stance to compar
-00002400: 652e 0a0a 2020 2020 2020 2020 5265 7475  e...        Retu
-00002410: 726e 733a 0a20 2020 2020 2020 2020 2020  rns:.           
-00002420: 2054 7275 6520 6966 2074 6865 206d 6170   True if the map
-00002430: 2070 726f 7065 7274 6965 7320 6172 6520   properties are 
-00002440: 7468 6520 7361 6d65 2062 6574 7765 656e  the same between
-00002450: 2074 776f 206d 6170 732c 2046 616c 7365   two maps, False
-00002460: 0a20 2020 2020 2020 2020 2020 206f 7468  .            oth
-00002470: 6572 7769 7365 2e0a 2020 2020 2020 2020  erwise..        
-00002480: 2222 220a 2020 2020 2020 2020 6966 2028  """.        if (
-00002490: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000024a0: 206e 702e 6973 636c 6f73 6528 6d61 705f   np.isclose(map_
-000024b0: 7461 7267 6574 2e61 7069 782c 0a20 2020  target.apix,.   
-000024c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000024d0: 2020 2020 2020 2020 6d61 705f 7072 6f62          map_prob
-000024e0: 652e 6170 6978 2c0a 2020 2020 2020 2020  e.apix,.        
-000024f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002500: 2020 2061 746f 6c3d 3145 2d36 292e 616c     atol=1E-6).al
-00002510: 6c28 2920 616e 640a 2020 2020 2020 2020  l() and.        
-00002520: 2020 2020 2020 2020 6d61 705f 7461 7267          map_targ
-00002530: 6574 2e62 6f78 5f73 697a 6528 2920 3d3d  et.box_size() ==
-00002540: 206d 6170 5f70 726f 6265 2e62 6f78 5f73   map_probe.box_s
-00002550: 697a 6528 290a 2020 2020 2020 2020 293a  ize().        ):
-00002560: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-00002570: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-00002580: 2020 2020 2020 726f 756e 6428 6d61 705f        round(map_
-00002590: 7461 7267 6574 2e6f 7269 6769 6e5b 305d  target.origin[0]
-000025a0: 2c20 3229 203d 3d20 726f 756e 6428 6d61  , 2) == round(ma
-000025b0: 705f 7072 6f62 652e 6f72 6967 696e 5b30  p_probe.origin[0
-000025c0: 5d2c 2032 2920 616e 6420 2023 206e 6f71  ], 2) and  # noq
-000025d0: 613a 4535 3031 0a20 2020 2020 2020 2020  a:E501.         
-000025e0: 2020 2020 2020 2020 2020 2072 6f75 6e64             round
-000025f0: 286d 6170 5f74 6172 6765 742e 6f72 6967  (map_target.orig
-00002600: 696e 5b31 5d2c 2032 2920 3d3d 2072 6f75  in[1], 2) == rou
-00002610: 6e64 286d 6170 5f70 726f 6265 2e6f 7269  nd(map_probe.ori
-00002620: 6769 6e5b 315d 2c20 3229 2061 6e64 2020  gin[1], 2) and  
-00002630: 2320 6e6f 7161 3a45 3530 310a 2020 2020  # noqa:E501.    
-00002640: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002650: 726f 756e 6428 6d61 705f 7461 7267 6574  round(map_target
-00002660: 2e6f 7269 6769 6e5b 325d 2c20 3229 203d  .origin[2], 2) =
-00002670: 3d20 726f 756e 6428 6d61 705f 7072 6f62  = round(map_prob
-00002680: 652e 6f72 6967 696e 5b32 5d2c 2032 2920  e.origin[2], 2) 
-00002690: 2023 206e 6f71 613a 4535 3031 0a20 2020   # noqa:E501.   
-000026a0: 2020 2020 2020 2020 2029 3a0a 2020 2020           ):.    
-000026b0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-000026c0: 726e 2054 7275 650a 2020 2020 2020 2020  rn True.        
-000026d0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-000026e0: 2020 2020 2020 2020 2020 7265 7475 726e            return
-000026f0: 2046 616c 7365 0a20 2020 2020 2020 2065   False.        e
-00002700: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-00002710: 2072 6574 7572 6e20 4661 6c73 650a 0a20   return False.. 
-00002720: 2020 2064 6566 205f 6661 696c 6564 5f6d     def _failed_m
-00002730: 6174 6368 2873 656c 6629 3a0a 2020 2020  atch(self):.    
-00002740: 2020 2020 2320 7368 6f75 6c64 2069 6d70      # should imp
-00002750: 6c65 6d65 6e74 2054 454d 5079 2065 7272  lement TEMPy err
-00002760: 6f72 7320 666f 7220 6d6f 7265 2065 6c65  ors for more ele
-00002770: 6761 6e74 2065 7272 6f72 2068 616e 646c  gant error handl
-00002780: 696e 670a 2020 2020 2020 2020 7072 696e  ing.        prin
-00002790: 7428 0a20 2020 2020 2020 2020 2020 2027  t(.            '
-000027a0: 5761 726e 696e 673a 2063 616e 5c27 7420  Warning: can\'t 
-000027b0: 6d61 7463 6820 7468 6520 6d61 7020 6174  match the map at
-000027c0: 2074 6865 206d 6f6d 656e 742c 270a 2020   the moment,'.  
-000027d0: 2020 2020 2020 2020 2020 2775 7365 206d            'use m
-000027e0: 6170 2077 6974 6820 7361 6d65 2062 6f78  ap with same box
-000027f0: 2073 697a 652e 270a 2020 2020 2020 2020   size.'.        
-00002800: 290a 2020 2020 2020 2020 7379 732e 6578  ).        sys.ex
-00002810: 6974 2829 0a0a 2020 2020 6465 6620 7363  it()..    def sc
-00002820: 616c 655f 6d65 6469 616e 2873 656c 662c  ale_median(self,
-00002830: 2061 7272 312c 2061 7272 3229 3a0a 2020   arr1, arr2):.  
-00002840: 2020 2020 2020 2222 2253 6361 6c65 206f        """Scale o
-00002850: 6e65 206c 6973 742f 6172 7261 7920 6f66  ne list/array of
-00002860: 2073 636f 7265 7320 7769 7468 2072 6573   scores with res
-00002870: 7065 6374 2074 6f20 616e 6f74 6865 7220  pect to another 
-00002880: 6261 7365 6420 6f6e 0a20 2020 2020 2020  based on.       
-00002890: 2064 6973 7472 6962 7574 696f 6e20 6172   distribution ar
-000028a0: 6f75 6e64 206d 6564 6961 6e2e 0a0a 2020  ound median...  
-000028b0: 2020 2020 2020 4172 6775 6d65 6e74 733a        Arguments:
-000028c0: 0a20 2020 2020 2020 2020 2020 2061 7272  .            arr
-000028d0: 312c 2061 7272 323a 2041 7272 6179 2f6c  1, arr2: Array/l
-000028e0: 6973 7420 6f66 2073 636f 7265 730a 0a20  ist of scores.. 
-000028f0: 2020 2020 2020 2052 6574 7572 6e73 3a0a         Returns:.
-00002900: 2020 2020 2020 2020 2020 2020 5363 616c              Scal
-00002910: 6564 2061 7272 312c 2062 6173 6564 206f  ed arr1, based o
-00002920: 6e20 7468 6520 7661 6c75 6573 2069 6e20  n the values in 
-00002930: 6172 7232 0a20 2020 2020 2020 2022 2222  arr2.        """
-00002940: 0a20 2020 2020 2020 206e 7061 7272 3120  .        nparr1 
-00002950: 3d20 6e70 2e61 7272 6179 2861 7272 3129  = np.array(arr1)
-00002960: 0a20 2020 2020 2020 206e 7061 7272 3220  .        nparr2 
-00002970: 3d20 6e70 2e61 7272 6179 2861 7272 3229  = np.array(arr2)
-00002980: 0a20 2020 2020 2020 206d 6564 5f64 6576  .        med_dev
-00002990: 5f31 203d 206e 702e 6d65 6469 616e 286e  _1 = np.median(n
-000029a0: 702e 6162 736f 6c75 7465 286e 7061 7272  p.absolute(nparr
-000029b0: 3120 2d20 6e70 2e6d 6564 6961 6e28 6e70  1 - np.median(np
-000029c0: 6172 7231 2929 290a 2020 2020 2020 2020  arr1))).        
-000029d0: 6d65 645f 6465 765f 3220 3d20 6e70 2e6d  med_dev_2 = np.m
-000029e0: 6564 6961 6e28 6e70 2e61 6273 6f6c 7574  edian(np.absolut
-000029f0: 6528 6e70 6172 7232 202d 206e 702e 6d65  e(nparr2 - np.me
-00002a00: 6469 616e 286e 7061 7272 3229 2929 0a20  dian(nparr2))). 
-00002a10: 2020 2020 2020 2069 6620 6d65 645f 6465         if med_de
-00002a20: 765f 3120 3d3d 2030 2e30 3a0a 2020 2020  v_1 == 0.0:.    
-00002a30: 2020 2020 2020 2020 7363 616c 655f 6661          scale_fa
-00002a40: 6374 6f72 203d 2030 2e30 0a20 2020 2020  ctor = 0.0.     
-00002a50: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-00002a60: 2020 2020 2073 6361 6c65 5f66 6163 746f       scale_facto
-00002a70: 7220 3d20 6d65 645f 6465 765f 3220 2f20  r = med_dev_2 / 
-00002a80: 6d65 645f 6465 765f 310a 2020 2020 2020  med_dev_1.      
-00002a90: 2020 7368 6966 745f 6661 6374 6f72 203d    shift_factor =
-00002aa0: 206e 702e 6d65 6469 616e 286e 7061 7272   np.median(nparr
-00002ab0: 3229 202d 2028 7363 616c 655f 6661 6374  2) - (scale_fact
-00002ac0: 6f72 202a 206e 702e 6d65 6469 616e 286e  or * np.median(n
-00002ad0: 7061 7272 3129 290a 0a20 2020 2020 2020  parr1))..       
-00002ae0: 2023 2054 4f44 4f3a 2066 696e 6420 6120   # TODO: find a 
-00002af0: 6265 7474 6572 2077 6179 2074 6f20 6176  better way to av
-00002b00: 6f69 6420 6f75 746c 6965 7273 2069 6e20  oid outliers in 
-00002b10: 6765 6e65 7261 6c0a 2020 2020 2020 2020  general.        
-00002b20: 6966 2028 6d61 7828 6e70 6172 7231 2920  if (max(nparr1) 
-00002b30: 2d20 6d69 6e28 6e70 6172 7231 2929 203e  - min(nparr1)) >
-00002b40: 2030 2e31 3a0a 2020 2020 2020 2020 2020   0.1:.          
-00002b50: 2020 7363 616c 6564 5f61 7272 203d 2028    scaled_arr = (
-00002b60: 2873 6361 6c65 5f66 6163 746f 7220 2a20  (scale_factor * 
-00002b70: 6e70 6172 7231 202b 2073 6869 6674 5f66  nparr1 + shift_f
-00002b80: 6163 746f 7229 202b 206e 7061 7272 3229  actor) + nparr2)
-00002b90: 202f 2032 2e0a 2020 2020 2020 2020 656c   / 2..        el
-00002ba0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-00002bb0: 7363 616c 6564 5f61 7272 203d 206e 7061  scaled_arr = npa
-00002bc0: 7272 320a 2020 2020 2020 2020 7265 7475  rr2.        retu
-00002bd0: 726e 2073 6361 6c65 645f 6172 720a 0a20  rn scaled_arr.. 
-00002be0: 2020 2064 6566 205f 4343 435f 6361 6c63     def _CCC_calc
-00002bf0: 2873 656c 662c 206d 312c 206d 3229 3a0a  (self, m1, m2):.
-00002c00: 2020 2020 2020 2020 6172 7231 203d 206d          arr1 = m
-00002c10: 312e 7669 6577 2866 6c6f 6174 290a 2020  1.view(float).  
-00002c20: 2020 2020 2020 6172 7232 203d 206d 322e        arr2 = m2.
-00002c30: 7669 6577 2866 6c6f 6174 2920 2023 206e  view(float)  # n
-00002c40: 6f71 613a 4638 3431 0a20 2020 2020 2020  oqa:F841.       
-00002c50: 206e 6420 3d20 6c65 6e28 6172 7231 2e73   nd = len(arr1.s
-00002c60: 6861 7065 290a 2020 2020 2020 2020 6966  hape).        if
-00002c70: 206e 6420 3d3d 2032 2061 6e64 206c 656e   nd == 2 and len
-00002c80: 2861 7272 312e 7368 6170 6529 5b31 5d20  (arr1.shape)[1] 
-00002c90: 3d3d 2030 3a0a 2020 2020 2020 2020 2020  == 0:.          
-00002ca0: 2020 6e64 203d 2031 0a20 2020 2020 2020    nd = 1.       
-00002cb0: 206c 203d 2031 2020 2320 6e6f 7161 3a45   l = 1  # noqa:E
-00002cc0: 3734 310a 2020 2020 2020 2020 6469 6d20  741.        dim 
-00002cd0: 3d20 6e70 2e7a 6572 6f73 2833 2c20 6474  = np.zeros(3, dt
-00002ce0: 7970 653d 696e 7429 0a20 2020 2020 2020  ype=int).       
-00002cf0: 2066 6f72 2069 2069 6e20 7261 6e67 6528   for i in range(
-00002d00: 6e64 293a 0a20 2020 2020 2020 2020 2020  nd):.           
-00002d10: 206c 202a 3d20 6172 7231 2e73 6861 7065   l *= arr1.shape
-00002d20: 5b69 5d20 2023 206e 6f71 613a 4537 3431  [i]  # noqa:E741
-00002d30: 0a20 2020 2020 2020 2020 2020 2064 696d  .            dim
-00002d40: 5b69 5d20 3d20 6172 7231 2e73 6861 7065  [i] = arr1.shape
-00002d50: 5b69 5d0a 2020 2020 2020 2020 636f 7272  [i].        corr
-00002d60: 203d 2030 2e30 0a20 2020 2020 2020 206e   = 0.0.        n
-00002d70: 756d 6572 203d 2030 2e30 0a20 2020 2020  umer = 0.0.     
-00002d80: 2020 2076 6172 3120 3d20 302e 300a 2020     var1 = 0.0.  
-00002d90: 2020 2020 2020 7661 7232 203d 2030 2e30        var2 = 0.0
-00002da0: 0a20 2020 2020 2020 2069 6620 6e64 203d  .        if nd =
-00002db0: 3d20 313a 0a20 2020 2020 2020 2020 2020  = 1:.           
-00002dc0: 2066 6f72 207a 2069 6e20 7261 6e67 6528   for z in range(
-00002dd0: 6469 6d5b 305d 293a 0a20 2020 2020 2020  dim[0]):.       
-00002de0: 2020 2020 2020 2020 206e 756d 6572 202b           numer +
-00002df0: 3d20 6172 7231 5b7a 5d2a 6172 7232 5b7a  = arr1[z]*arr2[z
-00002e00: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
-00002e10: 2020 7661 7231 202b 3d20 6172 7231 5b7a    var1 += arr1[z
-00002e20: 5d2a 2a32 0a20 2020 2020 2020 2020 2020  ]**2.           
-00002e30: 2020 2020 2076 6172 3220 2b3d 2061 7272       var2 += arr
-00002e40: 325b 7a5d 2a2a 320a 2020 2020 2020 2020  2[z]**2.        
-00002e50: 656c 6966 206e 6420 3d3d 2033 3a0a 2020  elif nd == 3:.  
-00002e60: 2020 2020 2020 2020 2020 666f 7220 7a20            for z 
-00002e70: 696e 2072 616e 6765 2864 696d 5b30 5d29  in range(dim[0])
-00002e80: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00002e90: 2020 666f 7220 7920 696e 2072 616e 6765    for y in range
-00002ea0: 2864 696d 5b31 5d29 3a0a 2020 2020 2020  (dim[1]):.      
-00002eb0: 2020 2020 2020 2020 2020 2020 2020 666f                fo
-00002ec0: 7220 7820 696e 2072 616e 6765 2864 696d  r x in range(dim
-00002ed0: 5b32 5d29 3a0a 2020 2020 2020 2020 2020  [2]):.          
-00002ee0: 2020 2020 2020 2020 2020 2020 2020 6e75                nu
-00002ef0: 6d65 7220 2b3d 2061 7272 315b 7a2c 2079  mer += arr1[z, y
-00002f00: 2c20 785d 2a61 7272 325b 7a2c 2079 2c20  , x]*arr2[z, y, 
-00002f10: 785d 0a20 2020 2020 2020 2020 2020 2020  x].             
-00002f20: 2020 2020 2020 2020 2020 2076 6172 3120             var1 
-00002f30: 2b3d 2061 7272 315b 7a2c 2079 2c20 785d  += arr1[z, y, x]
-00002f40: 2a2a 320a 2020 2020 2020 2020 2020 2020  **2.            
-00002f50: 2020 2020 2020 2020 2020 2020 7661 7232              var2
-00002f60: 202b 3d20 6172 7232 5b7a 2c20 792c 2078   += arr2[z, y, x
-00002f70: 5d2a 2a32 0a20 2020 2020 2020 2063 6f72  ]**2.        cor
-00002f80: 7220 3d20 6e75 6d65 722f 6d61 7468 2e73  r = numer/math.s
-00002f90: 7172 7428 7661 7231 2a76 6172 3229 0a20  qrt(var1*var2). 
-00002fa0: 2020 2020 2020 2063 6f72 7220 3d20 6d69         corr = mi
-00002fb0: 6e28 312e 302c 2063 6f72 7229 0a20 2020  n(1.0, corr).   
-00002fc0: 2020 2020 2063 6f72 7220 3d20 6d61 7828       corr = max(
-00002fd0: 2d31 2e30 2c20 636f 7272 290a 2020 2020  -1.0, corr).    
-00002fe0: 2020 2020 7265 7475 726e 2063 6f72 720a      return corr.
-00002ff0: 0a20 2020 2064 6566 2043 4343 5f6d 6170  .    def CCC_map
-00003000: 280a 2020 2020 2020 2020 2020 2020 7365  (.            se
-00003010: 6c66 2c0a 2020 2020 2020 2020 2020 2020  lf,.            
-00003020: 6d61 705f 7461 7267 6574 2c0a 2020 2020  map_target,.    
-00003030: 2020 2020 2020 2020 6d61 705f 7072 6f62          map_prob
-00003040: 652c 0a20 2020 2020 2020 2020 2020 206d  e,.            m
-00003050: 6170 5f74 6172 6765 745f 7468 7265 7368  ap_target_thresh
-00003060: 6f6c 643d 302e 302c 0a20 2020 2020 2020  old=0.0,.       
-00003070: 2020 2020 206d 6170 5f70 726f 6265 5f74       map_probe_t
-00003080: 6872 6573 686f 6c64 3d30 2e30 2c0a 2020  hreshold=0.0,.  
-00003090: 2020 2020 2020 2020 2020 6d6f 6465 3d31            mode=1
-000030a0: 2c0a 2020 2020 2020 2020 2020 2020 6d65  ,.            me
-000030b0: 616e 4469 7374 3d46 616c 7365 2c0a 2020  anDist=False,.  
-000030c0: 2020 2020 2020 2020 2020 636d 6f64 653d            cmode=
-000030d0: 5472 7565 2c0a 2020 2020 293a 0a20 2020  True,.    ):.   
-000030e0: 2020 2020 2022 2222 4361 6c63 756c 6174       """Calculat
-000030f0: 6520 6372 6f73 732d 636f 7272 656c 6174  e cross-correlat
-00003100: 696f 6e20 6265 7477 6565 6e20 7477 6f20  ion between two 
-00003110: 4d61 7020 696e 7374 616e 6365 7320 7573  Map instances us
-00003120: 696e 6720 6f6e 6520 6f66 0a20 2020 2020  ing one of.     
-00003130: 2020 2033 206d 6574 686f 6473 2e0a 0a20     3 methods... 
-00003140: 2020 2020 2020 2041 7267 733a 0a20 2020         Args:.   
-00003150: 2020 2020 2020 2020 206d 6170 5f74 6172           map_tar
-00003160: 6765 742c 206d 6170 5f70 726f 6265 3a20  get, map_probe: 
-00003170: 454d 4d61 7020 696e 7374 616e 6365 2074  EMMap instance t
-00003180: 6f20 636f 6d70 6172 652e 0a0a 2020 2020  o compare...    
-00003190: 2020 2020 2020 2020 6d61 705f 7461 7267          map_targ
-000031a0: 6574 5f74 6872 6573 686f 6c64 2c20 6d61  et_threshold, ma
-000031b0: 705f 7072 6f62 655f 7468 7265 7368 6f6c  p_probe_threshol
-000031c0: 643a 0a20 2020 2020 2020 2020 2020 2020  d:.             
-000031d0: 2020 204d 6170 2074 6872 6573 686f 6c64     Map threshold
-000031e0: 2c20 7573 6564 2074 6f20 7365 6c65 6374  , used to select
-000031f0: 2070 6978 656c 7320 7768 656e 2063 616c   pixels when cal
-00003200: 6375 6c61 7469 6e67 2043 4343 2077 6974  culating CCC wit
-00003210: 680a 2020 2020 2020 2020 2020 2020 2020  h.              
-00003220: 2020 6d65 7468 6f64 2032 2e20 4966 206e    method 2. If n
-00003230: 6f74 2073 7065 6369 6669 6564 2c20 7769  ot specified, wi
-00003240: 6c6c 2062 6520 6361 6c63 756c 6174 6564  ll be calculated
-00003250: 2075 7369 6e67 0a20 2020 2020 2020 2020   using.         
-00003260: 2020 2020 2020 203a 6d65 7468 3a60 6361         :meth:`ca
-00003270: 6c63 756c 6174 655f 6d61 705f 7468 7265  lculate_map_thre
-00003280: 7368 6f6c 6420 3c54 454d 5079 2e70 726f  shold <TEMPy.pro
-00003290: 7465 696e 2e73 636f 7269 6e67 5f66 756e  tein.scoring_fun
-000032a0: 6374 696f 6e73 2e53 636f 7269 6e67 4675  ctions.ScoringFu
-000032b0: 6e63 7469 6f6e 732e 6361 6c63 756c 6174  nctions.calculat
-000032c0: 655f 6d61 705f 7468 7265 7368 6f6c 643e  e_map_threshold>
-000032d0: 6020 2023 206e 6f71 613a 4535 3031 0a0a  `  # noqa:E501..
-000032e0: 2020 2020 2020 2020 2020 2020 6d6f 6465              mode
-000032f0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00003300: 2020 312e 2043 4343 2063 616c 6375 6c61    1. CCC calcula
-00003310: 7469 6f6e 206f 6e20 616c 6c20 7069 7865  tion on all pixe
-00003320: 6c73 2069 6e20 6d61 700a 2020 2020 2020  ls in map.      
-00003330: 2020 2020 2020 2020 2020 322e 2043 4343            2. CCC
-00003340: 206f 6e6c 7920 6f6e 2070 6978 656c 7320   only on pixels 
-00003350: 7769 7468 2064 656e 7369 7479 2076 616c  with density val
-00003360: 7565 2061 626f 7665 2072 6573 7065 6374  ue above respect
-00003370: 6976 6520 7468 7265 7368 6f6c 6473 0a20  ive thresholds. 
-00003380: 2020 2020 2020 2020 2020 2020 2020 2033                 3
-00003390: 2e20 4343 4320 6f6e 6c79 206f 6e20 7069  . CCC only on pi
-000033a0: 7865 6c73 2077 6974 6869 6e20 7468 6520  xels within the 
-000033b0: 6d61 736b 0a0a 2020 2020 2020 2020 2020  mask..          
-000033c0: 2020 6d65 616e 4469 7374 3a20 5472 7565    meanDist: True
-000033d0: 2069 6620 7468 6520 6465 7669 6174 696f   if the deviatio
-000033e0: 6e20 6672 6f6d 206d 6561 6e20 6e65 6564  n from mean need
-000033f0: 7320 746f 2062 6520 6361 6c63 756c 6174  s to be calculat
-00003400: 6564 0a0a 2020 2020 2020 2020 2020 2020  ed..            
-00003410: 636d 6f64 653a 2049 6620 5472 7565 2c20  cmode: If True, 
-00003420: 7573 6520 7075 7265 2070 7974 686f 6e20  use pure python 
-00003430: 696d 706c 656d 656e 7461 7469 6f6e 2074  implementation t
-00003440: 6f20 6361 6c63 756c 6174 6520 4343 432e  o calculate CCC.
-00003450: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00003460: 2049 6620 4661 6c73 652c 2075 7365 206e   If False, use n
-00003470: 756d 7079 2069 6d70 6c65 6d65 6e74 6174  umpy implementat
-00003480: 696f 6e2e 0a0a 2020 2020 2020 2020 5265  ion...        Re
-00003490: 7475 726e 733a 0a0a 2020 2020 2020 2020  turns:..        
-000034a0: 2020 2020 4343 432c 2070 6572 6365 6e74      CCC, percent
-000034b0: 6167 655f 6f76 6572 6c61 703a 2054 6865  age_overlap: The
-000034c0: 2063 726f 7373 2063 6f72 7265 6c61 7469   cross correlati
-000034d0: 6f6e 2073 636f 7265 2061 6e64 2074 6865  on score and the
-000034e0: 0a20 2020 2020 2020 2020 2020 2070 6572  .            per
-000034f0: 6365 6e74 6167 6520 6f76 6572 6c61 7020  centage overlap 
-00003500: 6265 7477 6565 6e20 7468 6520 7477 6f20  between the two 
-00003510: 696e 7075 7420 6d61 7073 0a0a 2020 2020  input maps..    
-00003520: 2020 2020 5261 6973 6573 3a0a 0a20 2020      Raises:..   
-00003530: 2020 2020 2020 2020 2057 6172 6e69 6e67           Warning
-00003540: 3a20 5769 6c6c 2072 6574 7572 6e20 2d31  : Will return -1
-00003550: 2c20 3020 6966 2074 6865 2074 776f 2069  , 0 if the two i
-00003560: 6e70 7574 206d 6170 7320 646f 206e 6f74  nput maps do not
-00003570: 206d 6174 6368 0a20 2020 2020 2020 2020   match.         
-00003580: 2020 2020 2020 2073 6861 7065 2c20 7069         shape, pi
-00003590: 7865 6c20 7369 7a65 2061 6e64 206f 7269  xel size and ori
-000035a0: 6769 6e2e 0a20 2020 2020 2020 2022 2222  gin..        """
-000035b0: 0a20 2020 2020 2020 2069 6620 7365 6c66  .        if self
-000035c0: 2e6d 6170 436f 6d70 6172 6973 6f6e 286d  .mapComparison(m
-000035d0: 6170 5f74 6172 6765 742c 206d 6170 5f70  ap_target, map_p
-000035e0: 726f 6265 293a 0a20 2020 2020 2020 2020  robe):.         
-000035f0: 2020 2069 6620 6e6f 7420 6d6f 6465 203d     if not mode =
-00003600: 3d20 313a 0a20 2020 2020 2020 2020 2020  = 1:.           
-00003610: 2020 2020 2069 6620 6d61 705f 7461 7267       if map_targ
-00003620: 6574 5f74 6872 6573 686f 6c64 203d 3d20  et_threshold == 
-00003630: 3020 616e 6420 6d61 705f 7072 6f62 655f  0 and map_probe_
-00003640: 7468 7265 7368 6f6c 6420 3d3d 2030 3a0a  threshold == 0:.
-00003650: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003660: 2020 2020 6d61 705f 7461 7267 6574 5f74      map_target_t
-00003670: 6872 6573 686f 6c64 203d 2073 656c 662e  hreshold = self.
-00003680: 6361 6c63 756c 6174 655f 6d61 705f 7468  calculate_map_th
-00003690: 7265 7368 6f6c 6428 0a20 2020 2020 2020  reshold(.       
-000036a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000036b0: 206d 6170 5f74 6172 6765 740a 2020 2020   map_target.    
-000036c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000036d0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-000036e0: 2020 2020 2020 6d61 705f 7072 6f62 655f        map_probe_
-000036f0: 7468 7265 7368 6f6c 6420 3d20 7365 6c66  threshold = self
-00003700: 2e63 616c 6375 6c61 7465 5f6d 6170 5f74  .calculate_map_t
-00003710: 6872 6573 686f 6c64 280a 2020 2020 2020  hreshold(.      
-00003720: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003730: 2020 6d61 705f 7072 6f62 650a 2020 2020    map_probe.    
-00003740: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003750: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00003760: 2020 6269 6e5f 6d61 7031 203d 206d 6170    bin_map1 = map
-00003770: 5f74 6172 6765 742e 6675 6c6c 4d61 7020  _target.fullMap 
-00003780: 3e20 666c 6f61 7428 6d61 705f 7461 7267  > float(map_targ
-00003790: 6574 5f74 6872 6573 686f 6c64 290a 2020  et_threshold).  
-000037a0: 2020 2020 2020 2020 2020 2020 2020 6269                bi
-000037b0: 6e5f 6d61 7032 203d 206d 6170 5f70 726f  n_map2 = map_pro
-000037c0: 6265 2e66 756c 6c4d 6170 203e 2066 6c6f  be.fullMap > flo
-000037d0: 6174 286d 6170 5f70 726f 6265 5f74 6872  at(map_probe_thr
-000037e0: 6573 686f 6c64 290a 2020 2020 2020 2020  eshold).        
-000037f0: 2020 2020 2020 2020 6d69 6e69 6d20 3d20          minim = 
-00003800: 6e70 2e73 756d 2862 696e 5f6d 6170 3129  np.sum(bin_map1)
-00003810: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00003820: 206d 696e 696d 3220 3d20 6e70 2e73 756d   minim2 = np.sum
-00003830: 2862 696e 5f6d 6170 3229 0a20 2020 2020  (bin_map2).     
-00003840: 2020 2020 2020 2020 2020 2069 6620 6d69             if mi
-00003850: 6e69 6d32 203c 206d 696e 696d 3a0a 2020  nim2 < minim:.  
-00003860: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003870: 2020 6d69 6e69 6d20 3d20 6d69 6e69 6d32    minim = minim2
-00003880: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00003890: 206d 6173 6b5f 6172 7261 7920 3d20 2862   mask_array = (b
-000038a0: 696e 5f6d 6170 3120 2a20 6269 6e5f 6d61  in_map1 * bin_ma
-000038b0: 7032 2920 3e20 300a 2020 2020 2020 2020  p2) > 0.        
-000038c0: 2020 2020 2020 2020 6966 206e 6f74 206d          if not m
-000038d0: 696e 696d 203d 3d20 302e 303a 0a20 2020  inim == 0.0:.   
-000038e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000038f0: 2070 6572 635f 6f76 7220 3d20 666c 6f61   perc_ovr = floa
-00003900: 7428 6e70 2e73 756d 286d 6173 6b5f 6172  t(np.sum(mask_ar
-00003910: 7261 7929 2920 2f20 6d69 6e69 6d0a 2020  ray)) / minim.  
-00003920: 2020 2020 2020 2020 2020 2020 2020 656c                el
-00003930: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-00003940: 2020 2020 2020 2020 7072 696e 7428 0a20          print(. 
-00003950: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003960: 2020 2020 2020 2027 4e6f 206d 6170 206f         'No map o
-00003970: 7665 726c 6170 2028 4372 6f73 7320 636f  verlap (Cross co
-00003980: 7272 656c 6174 696f 6e20 7363 6f72 6529  rrelation score)
-00003990: 2c20 6578 6974 696e 6720 270a 2020 2020  , exiting '.    
-000039a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000039b0: 2020 2020 2773 636f 7265 2063 616c 6375      'score calcu
-000039c0: 6c61 7469 6f6e 2e2e 270a 2020 2020 2020  lation..'.      
-000039d0: 2020 2020 2020 2020 2020 2020 2020 290a                ).
-000039e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000039f0: 2020 2020 7265 7475 726e 202d 312e 302c      return -1.0,
-00003a00: 2030 2e30 0a20 2020 2020 2020 2020 2020   0.0.           
-00003a10: 2020 2020 2069 6620 7065 7263 5f6f 7672       if perc_ovr
-00003a20: 203c 2030 2e30 323a 0a20 2020 2020 2020   < 0.02:.       
-00003a30: 2020 2020 2020 2020 2020 2020 2072 6574               ret
-00003a40: 7572 6e20 2d31 2e30 2c20 302e 300a 2020  urn -1.0, 0.0.  
-00003a50: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
-00003a60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003a70: 7065 7263 5f6f 7672 203d 2031 2e30 0a0a  perc_ovr = 1.0..
-00003a80: 2020 2020 2020 2020 2020 2020 2320 6361              # ca
-00003a90: 6c63 756c 6174 6520 4343 4320 7769 7468  lculate CCC with
-00003aa0: 696e 2076 6f6c 756d 6520 6f66 206f 7665  in volume of ove
-00003ab0: 726c 6170 0a20 2020 2020 2020 2020 2020  rlap.           
-00003ac0: 2069 6620 6d6f 6465 203d 3d20 333a 0a20   if mode == 3:. 
-00003ad0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00003ae0: 6620 6e70 2e73 756d 286d 6173 6b5f 6172  f np.sum(mask_ar
-00003af0: 7261 7929 203d 3d20 303a 0a20 2020 2020  ray) == 0:.     
-00003b00: 2020 2020 2020 2020 2020 2020 2020 2070                 p
-00003b10: 7269 6e74 280a 2020 2020 2020 2020 2020  rint(.          
-00003b20: 2020 2020 2020 2020 2020 2020 2020 274e                'N
-00003b30: 6f20 6d61 7020 6f76 6572 6c61 7020 2843  o map overlap (C
-00003b40: 726f 7373 2063 6f72 7265 6c61 7469 6f6e  ross correlation
-00003b50: 2073 636f 7265 292c 2027 0a20 2020 2020   score), '.     
-00003b60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003b70: 2020 2027 6578 6974 696e 6720 7363 6f72     'exiting scor
-00003b80: 6520 6361 6c63 756c 6174 696f 6e2e 2e27  e calculation..'
-00003b90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00003ba0: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
-00003bb0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-00003bc0: 6e20 2d31 2e30 2c20 302e 300a 2020 2020  n -1.0, 0.0.    
-00003bd0: 2020 2020 2020 2020 2020 2020 6d61 7031              map1
-00003be0: 5f6d 6173 6b20 3d20 6d61 705f 7461 7267  _mask = map_targ
-00003bf0: 6574 2e66 756c 6c4d 6170 5b6d 6173 6b5f  et.fullMap[mask_
-00003c00: 6172 7261 795d 0a20 2020 2020 2020 2020  array].         
-00003c10: 2020 2020 2020 206d 6170 325f 6d61 736b         map2_mask
-00003c20: 203d 206d 6170 5f70 726f 6265 2e66 756c   = map_probe.ful
-00003c30: 6c4d 6170 5b6d 6173 6b5f 6172 7261 795d  lMap[mask_array]
-00003c40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00003c50: 2069 6620 6d65 616e 4469 7374 3a0a 2020   if meanDist:.  
-00003c60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003c70: 2020 6d61 7031 5f6d 6173 6b20 3d20 6d61    map1_mask = ma
-00003c80: 7031 5f6d 6173 6b20 2d20 6e70 2e6d 6561  p1_mask - np.mea
-00003c90: 6e28 6d61 7031 5f6d 6173 6b29 0a20 2020  n(map1_mask).   
-00003ca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003cb0: 206d 6170 325f 6d61 736b 203d 206d 6170   map2_mask = map
-00003cc0: 325f 6d61 736b 202d 206e 702e 6d65 616e  2_mask - np.mean
-00003cd0: 286d 6170 325f 6d61 736b 290a 2020 2020  (map2_mask).    
-00003ce0: 2020 2020 2020 2020 2020 2020 6966 2063              if c
-00003cf0: 6d6f 6465 3a0a 2020 2020 2020 2020 2020  mode:.          
-00003d00: 2020 2020 2020 2020 2020 636f 7272 203d            corr =
-00003d10: 2073 656c 662e 5f43 4343 5f63 616c 6328   self._CCC_calc(
-00003d20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00003d30: 2020 2020 2020 2020 206d 6170 315f 6d61           map1_ma
-00003d40: 736b 2e66 6c61 7474 656e 2829 2c0a 2020  sk.flatten(),.  
-00003d50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003d60: 2020 2020 2020 6d61 7032 5f6d 6173 6b2e        map2_mask.
-00003d70: 666c 6174 7465 6e28 292c 0a20 2020 2020  flatten(),.     
-00003d80: 2020 2020 2020 2020 2020 2020 2020 2029                 )
-00003d90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00003da0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-00003db0: 2020 2020 2020 2020 2020 2063 6f72 7220             corr 
-00003dc0: 3d20 4e6f 6e65 0a20 2020 2020 2020 2020  = None.         
-00003dd0: 2020 2020 2020 2069 6620 636f 7272 2069         if corr i
-00003de0: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
-00003df0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-00003e00: 726e 2028 0a20 2020 2020 2020 2020 2020  rn (.           
-00003e10: 2020 2020 2020 2020 2020 2020 2028 0a20               (. 
-00003e20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003e30: 2020 2020 2020 2020 2020 206e 702e 7375             np.su
-00003e40: 6d28 6d61 7031 5f6d 6173 6b20 2a20 6d61  m(map1_mask * ma
-00003e50: 7032 5f6d 6173 6b29 202f 0a20 2020 2020  p2_mask) /.     
-00003e60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003e70: 2020 2020 2020 206e 702e 7371 7274 280a         np.sqrt(.
-00003e80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00001940: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
+00001950: 2020 2020 2020 6d61 736b 206d 6170 7320        mask maps 
+00001960: 7769 7468 2032 2063 7574 2d6f 6666 206d  with 2 cut-off m
+00001970: 6170 5f74 6172 6765 745f 7468 7265 7368  ap_target_thresh
+00001980: 6f6c 6420 616e 640a 2020 2020 2020 2020  old and.        
+00001990: 2020 2020 6d61 705f 7072 6f62 655f 7468      map_probe_th
+000019a0: 7265 7368 6f6c 6420 2876 6f6c 2074 6872  reshold (vol thr
+000019b0: 2e29 0a0a 2020 2020 2020 2020 2020 2020  .)..            
+000019c0: 7265 7475 726e 3a0a 2020 2020 2020 2020  return:.        
+000019d0: 2020 2020 6672 6163 7469 6f6e 206f 6620      fraction of 
+000019e0: 6f76 6572 6c61 7020 7769 7468 2072 6573  overlap with res
+000019f0: 7065 6374 2074 6f20 7461 7267 6574 2c20  pect to target, 
+00001a00: 7769 7468 2072 6573 7065 6374 2074 6f0a  with respect to.
+00001a10: 2020 2020 2020 2020 2020 2020 7072 6f62              prob
+00001a20: 6520 616e 6420 7769 7468 2072 6573 7065  e and with respe
+00001a30: 6374 2074 6f20 7468 6520 746f 7461 6c20  ct to the total 
+00001a40: 2875 6e69 6f6e 290a 2020 2020 2020 2020  (union).        
+00001a50: 2222 220a 2020 2020 2020 2020 6966 206e  """.        if n
+00001a60: 6f74 2073 656c 662e 6d61 7043 6f6d 7061  ot self.mapCompa
+00001a70: 7269 736f 6e28 6d61 705f 7461 7267 6574  rison(map_target
+00001a80: 2c20 6d61 705f 7072 6f62 6529 3a0a 2020  , map_probe):.  
+00001a90: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
+00001aa0: 5661 6c75 6545 7272 6f72 280a 2020 2020  ValueError(.    
+00001ab0: 2020 2020 2020 2020 2020 2020 6622 436f              f"Co
+00001ac0: 756c 6420 6e6f 7420 6361 6c63 756c 6174  uld not calculat
+00001ad0: 6520 7363 6f72 6573 2066 6f72 2069 6e70  e scores for inp
+00001ae0: 7574 206d 6170 7320 7769 7468 2070 6978  ut maps with pix
+00001af0: 656c 2073 697a 6573 207b 6d61 705f 7461  el sizes {map_ta
+00001b00: 7267 6574 2e61 7069 787d 2c20 7b6d 6170  rget.apix}, {map
+00001b10: 5f70 726f 6265 2e61 7069 787d 2c22 0a20  _probe.apix},". 
+00001b20: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00001b30: 2220 7368 6170 6573 207b 6d61 705f 7461  " shapes {map_ta
+00001b40: 7267 6574 2e62 6f78 5f73 697a 6528 297d  rget.box_size()}
+00001b50: 2c20 7b6d 6170 5f70 726f 6265 2e62 6f78  , {map_probe.box
+00001b60: 5f73 697a 6528 297d 2061 6e64 2022 0a20  _size()} and ". 
+00001b70: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00001b80: 226f 7269 6769 6e73 207b 6d61 705f 7461  "origins {map_ta
+00001b90: 7267 6574 2e6f 7269 6769 6e7d 2c20 7b6d  rget.origin}, {m
+00001ba0: 6170 5f70 726f 6265 2e6f 7269 6769 6e7d  ap_probe.origin}
+00001bb0: 2e22 0a20 2020 2020 2020 2020 2020 2029  .".            )
+00001bc0: 0a20 2020 2020 2020 2062 696e 6d61 7031  .        binmap1
+00001bd0: 203d 206d 6170 5f74 6172 6765 742e 6675   = map_target.fu
+00001be0: 6c6c 4d61 7020 3e20 666c 6f61 7428 6d61  llMap > float(ma
+00001bf0: 705f 7461 7267 6574 5f74 6872 6573 686f  p_target_thresho
+00001c00: 6c64 290a 2020 2020 2020 2020 6269 6e6d  ld).        binm
+00001c10: 6170 3220 3d20 6d61 705f 7072 6f62 652e  ap2 = map_probe.
+00001c20: 6675 6c6c 4d61 7020 3e20 666c 6f61 7428  fullMap > float(
+00001c30: 6d61 705f 7072 6f62 655f 7468 7265 7368  map_probe_thresh
+00001c40: 6f6c 6429 0a20 2020 2020 2020 206d 6173  old).        mas
+00001c50: 6b5f 6172 7261 7920 3d20 2862 696e 6d61  k_array = (binma
+00001c60: 7031 202a 2062 696e 6d61 7032 2920 3e20  p1 * binmap2) > 
+00001c70: 300a 0a20 2020 2020 2020 2073 697a 6531  0..        size1
+00001c80: 203d 206e 702e 7375 6d28 6269 6e6d 6170   = np.sum(binmap
+00001c90: 3129 0a20 2020 2020 2020 2073 697a 6532  1).        size2
+00001ca0: 203d 206e 702e 7375 6d28 6269 6e6d 6170   = np.sum(binmap
+00001cb0: 3229 0a20 2020 2020 2020 2072 6574 7572  2).        retur
+00001cc0: 6e20 280a 2020 2020 2020 2020 2020 2020  n (.            
+00001cd0: 666c 6f61 7428 6e70 2e73 756d 286d 6173  float(np.sum(mas
+00001ce0: 6b5f 6172 7261 7929 2920 2f20 7369 7a65  k_array)) / size
+00001cf0: 312c 0a20 2020 2020 2020 2020 2020 2066  1,.            f
+00001d00: 6c6f 6174 286e 702e 7375 6d28 6d61 736b  loat(np.sum(mask
+00001d10: 5f61 7272 6179 2929 202f 2073 697a 6532  _array)) / size2
+00001d20: 2c0a 2020 2020 2020 2020 2020 2020 666c  ,.            fl
+00001d30: 6f61 7428 6e70 2e73 756d 286d 6173 6b5f  oat(np.sum(mask_
+00001d40: 6172 7261 7929 2920 2f20 2873 697a 6531  array)) / (size1
+00001d50: 202b 2073 697a 6532 292c 0a20 2020 2020   + size2),.     
+00001d60: 2020 2029 0a0a 2020 2020 6465 6620 5f6f     )..    def _o
+00001d70: 7665 726c 6170 5f6d 6170 5f61 7272 6179  verlap_map_array
+00001d80: 280a 2020 2020 2020 2020 2020 2020 7365  (.            se
+00001d90: 6c66 2c0a 2020 2020 2020 2020 2020 2020  lf,.            
+00001da0: 6d61 705f 7461 7267 6574 2c0a 2020 2020  map_target,.    
+00001db0: 2020 2020 2020 2020 6d61 705f 7461 7267          map_targ
+00001dc0: 6574 5f74 6872 6573 686f 6c64 2c0a 2020  et_threshold,.  
+00001dd0: 2020 2020 2020 2020 2020 6d61 705f 7072            map_pr
+00001de0: 6f62 652c 0a20 2020 2020 2020 2020 2020  obe,.           
+00001df0: 206d 6170 5f70 726f 6265 5f74 6872 6573   map_probe_thres
+00001e00: 686f 6c64 2c0a 2020 2020 293a 0a20 2020  hold,.    ):.   
+00001e10: 2020 2020 2022 2222 4865 6c70 6572 2066       """Helper f
+00001e20: 756e 6374 696f 6e20 666f 7220 6d75 7475  unction for mutu
+00001e30: 616c 2069 6e66 6f72 6d61 7469 6f6e 2063  al information c
+00001e40: 616c 6375 6c61 7469 6f6e 2e0a 0a20 2020  alculation...   
+00001e50: 2020 2020 204d 6173 6b73 206d 6170 7320       Masks maps 
+00001e60: 7573 696e 6720 756e 6971 7565 2063 7574  using unique cut
+00001e70: 6f66 6620 666f 7220 6561 6368 2028 6d61  off for each (ma
+00001e80: 705f 7461 7267 6574 5f74 6872 6573 686f  p_target_thresho
+00001e90: 6c64 2061 6e64 0a20 2020 2020 2020 206d  ld and.        m
+00001ea0: 6170 5f70 726f 6265 5f74 6872 6573 686f  ap_probe_thresho
+00001eb0: 6c64 2920 616e 6420 7265 7475 726e 7320  ld) and returns 
+00001ec0: 6120 6669 6e61 6c20 6d61 736b 2077 6869  a final mask whi
+00001ed0: 6368 2069 7320 5472 7565 2077 6865 7265  ch is True where
+00001ee0: 0a20 2020 2020 2020 2062 6f74 6820 6d61  .        both ma
+00001ef0: 7073 2061 7265 2061 626f 7665 2074 6865  ps are above the
+00001f00: 6972 2072 6573 7065 6374 6976 6520 7468  ir respective th
+00001f10: 7265 7368 6f6c 6473 2e0a 0a20 2020 2020  resholds...     
+00001f20: 2020 2041 7267 733a 0a20 2020 2020 2020     Args:.       
+00001f30: 2020 2020 206d 6170 5f74 6172 6765 742c       map_target,
+00001f40: 206d 6170 5f70 726f 6265 3a20 496e 7075   map_probe: Inpu
+00001f50: 7420 4d61 7020 696e 7374 616e 6365 0a20  t Map instance. 
+00001f60: 2020 2020 2020 2020 2020 206d 6170 5f74             map_t
+00001f70: 6172 6765 745f 7468 7265 7368 6f6c 642c  arget_threshold,
+00001f80: 206d 6170 5f70 726f 6265 5f74 6872 6573   map_probe_thres
+00001f90: 686f 6c64 3a20 5468 7265 7368 6f6c 6420  hold: Threshold 
+00001fa0: 7573 6564 2074 6f20 6d61 736b 0a20 2020  used to mask.   
+00001fb0: 2020 2020 2020 2020 2072 6573 7065 6374           respect
+00001fc0: 6976 6520 6d61 7020 696e 7374 616e 6365  ive map instance
+00001fd0: 0a0a 2020 2020 2020 2020 5265 7475 726e  ..        Return
+00001fe0: 733a 0a20 2020 2020 2020 2020 2020 206d  s:.            m
+00001ff0: 6173 6b5f 6172 7261 793a 204d 6173 6b20  ask_array: Mask 
+00002000: 7768 6963 6820 6973 2074 7275 6520 7768  which is true wh
+00002010: 6572 6520 626f 7468 206d 6170 7320 6172  ere both maps ar
+00002020: 6520 6162 6f76 6520 7468 6569 720a 2020  e above their.  
+00002030: 2020 2020 2020 2020 2020 7265 7370 6563            respec
+00002040: 7469 7665 2074 6872 6573 686f 6c64 732e  tive thresholds.
+00002050: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
+00002060: 2020 2020 2062 696e 6d61 7031 203d 206d       binmap1 = m
+00002070: 6170 5f74 6172 6765 742e 6675 6c6c 4d61  ap_target.fullMa
+00002080: 7020 3e20 666c 6f61 7428 6d61 705f 7461  p > float(map_ta
+00002090: 7267 6574 5f74 6872 6573 686f 6c64 290a  rget_threshold).
+000020a0: 2020 2020 2020 2020 6269 6e6d 6170 3220          binmap2 
+000020b0: 3d20 6d61 705f 7072 6f62 652e 6675 6c6c  = map_probe.full
+000020c0: 4d61 7020 3e20 666c 6f61 7428 6d61 705f  Map > float(map_
+000020d0: 7072 6f62 655f 7468 7265 7368 6f6c 6429  probe_threshold)
+000020e0: 0a20 2020 2020 2020 206d 6173 6b5f 6172  .        mask_ar
+000020f0: 7261 7920 3d20 2862 696e 6d61 7031 202a  ray = (binmap1 *
+00002100: 2062 696e 6d61 7032 2920 3e20 300a 2020   binmap2) > 0.  
+00002110: 2020 2020 2020 7265 7475 726e 206d 6173        return mas
+00002120: 6b5f 6172 7261 790a 0a20 2020 2064 6566  k_array..    def
+00002130: 2063 616c 6375 6c61 7465 5f6d 6170 5f74   calculate_map_t
+00002140: 6872 6573 686f 6c64 2873 656c 662c 206d  hreshold(self, m
+00002150: 6170 5f74 6172 6765 7429 3a0a 2020 2020  ap_target):.    
+00002160: 2020 2020 2222 2243 616c 6375 6c61 7465      """Calculate
+00002170: 7320 6d61 7020 7468 7265 7368 6f6c 6420  s map threshold 
+00002180: 6173 206d 6561 6e20 7661 6c75 6520 2b20  as mean value + 
+00002190: 2832 202a 206d 6170 2073 7461 6e64 6172  (2 * map standar
+000021a0: 6420 6465 7669 6174 696f 6e29 0a0a 2020  d deviation)..  
+000021b0: 2020 2020 2020 4172 6773 3a0a 2020 2020        Args:.    
+000021c0: 2020 2020 2020 2020 6d61 705f 7461 7267          map_targ
+000021d0: 6574 3a20 4d61 7020 696e 7374 616e 6365  et: Map instance
+000021e0: 0a0a 2020 2020 2020 2020 5265 7475 726e  ..        Return
+000021f0: 733a 0a20 2020 2020 2020 2020 2020 2066  s:.            f
+00002200: 6c6f 6174 3a20 5468 7265 7368 6f6c 6420  loat: Threshold 
+00002210: 7661 6c75 650a 2020 2020 2020 2020 2222  value.        ""
+00002220: 220a 2020 2020 2020 2020 2320 4e4f 5445  ".        # NOTE
+00002230: 3a20 4d4f 5645 2054 4f20 5445 4d50 792e  : MOVE TO TEMPy.
+00002240: 6d61 7073 2e65 6d5f 6d61 702e 4d61 703f  maps.em_map.Map?
+00002250: 3f0a 2020 2020 2020 2020 7472 793a 0a20  ?.        try:. 
+00002260: 2020 2020 2020 2020 2020 2070 6561 6b2c             peak,
+00002270: 2061 7665 2c20 7369 676d 6120 3d20 6d61   ave, sigma = ma
+00002280: 705f 7461 7267 6574 2e5f 7065 616b 5f64  p_target._peak_d
+00002290: 656e 7369 7479 2829 0a20 2020 2020 2020  ensity().       
+000022a0: 2020 2020 2076 6f6c 5f74 6872 6573 686f       vol_thresho
+000022b0: 6c64 203d 2066 6c6f 6174 2861 7665 2920  ld = float(ave) 
+000022c0: 2b20 2832 2e30 202a 2066 6c6f 6174 2873  + (2.0 * float(s
+000022d0: 6967 6d61 2929 0a20 2020 2020 2020 2065  igma)).        e
+000022e0: 7863 6570 7420 4578 6365 7074 696f 6e3a  xcept Exception:
+000022f0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+00002300: 6c65 6e28 6d61 705f 7461 7267 6574 2e68  len(map_target.h
+00002310: 6561 6465 7229 203d 3d20 303a 0a20 2020  eader) == 0:.   
+00002320: 2020 2020 2020 2020 2020 2020 2061 6d65               ame
+00002330: 616e 203d 206d 6170 5f74 6172 6765 742e  an = map_target.
+00002340: 6d65 616e 2829 0a20 2020 2020 2020 2020  mean().         
+00002350: 2020 2020 2020 2072 6d73 203d 206d 6170         rms = map
+00002360: 5f74 6172 6765 742e 7374 6428 290a 2020  _target.std().  
+00002370: 2020 2020 2020 2020 2020 2020 2020 766f                vo
+00002380: 6c5f 7468 7265 7368 6f6c 6420 3d20 666c  l_threshold = fl
+00002390: 6f61 7428 616d 6561 6e29 202b 2028 312e  oat(amean) + (1.
+000023a0: 3520 2a20 666c 6f61 7428 726d 7329 290a  5 * float(rms)).
+000023b0: 2020 2020 2020 2020 2020 2020 656c 7365              else
+000023c0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+000023d0: 2020 616d 6561 6e20 3d20 6d61 705f 7461    amean = map_ta
+000023e0: 7267 6574 2e6d 6561 6e28 290a 2020 2020  rget.mean().    
+000023f0: 2020 2020 2020 2020 2020 2020 726d 7320              rms 
+00002400: 3d20 6d61 705f 7461 7267 6574 2e73 7464  = map_target.std
+00002410: 2829 0a20 2020 2020 2020 2020 2020 2020  ().             
+00002420: 2020 2076 6f6c 5f74 6872 6573 686f 6c64     vol_threshold
+00002430: 203d 2066 6c6f 6174 2861 6d65 616e 2920   = float(amean) 
+00002440: 2b20 2831 2e35 202a 2066 6c6f 6174 2872  + (1.5 * float(r
+00002450: 6d73 2929 0a20 2020 2020 2020 2072 6574  ms)).        ret
+00002460: 7572 6e20 766f 6c5f 7468 7265 7368 6f6c  urn vol_threshol
+00002470: 640a 0a20 2020 2064 6566 206d 6170 436f  d..    def mapCo
+00002480: 6d70 6172 6973 6f6e 2873 656c 662c 206d  mparison(self, m
+00002490: 6170 5f74 6172 6765 742c 206d 6170 5f70  ap_target, map_p
+000024a0: 726f 6265 293a 0a20 2020 2020 2020 2022  robe):.        "
+000024b0: 2222 0a20 2020 2020 2020 2043 6865 636b  "".        Check
+000024c0: 7320 6966 2070 726f 7065 7274 6965 7320  s if properties 
+000024d0: 2873 616d 706c 696e 6720 7261 7465 2c20  (sampling rate, 
+000024e0: 626f 7820 7369 7a65 2061 6e64 206f 7269  box size and ori
+000024f0: 6769 6e29 206f 6620 7477 6f20 6d61 7073  gin) of two maps
+00002500: 0a20 2020 2020 2020 2061 7265 2065 7175  .        are equ
+00002510: 616c 2e0a 0a20 2020 2020 2020 2041 7267  al...        Arg
+00002520: 733a 0a20 2020 2020 2020 2020 2020 206d  s:.            m
+00002530: 6170 5f74 6172 6765 742c 206d 6170 5f70  ap_target, map_p
+00002540: 726f 6265 0a20 2020 2020 2020 2020 2020  robe.           
+00002550: 2020 2020 204d 6170 2069 6e73 7461 6e63       Map instanc
+00002560: 6520 746f 2063 6f6d 7061 7265 2e0a 0a20  e to compare... 
+00002570: 2020 2020 2020 2052 6574 7572 6e73 3a0a         Returns:.
+00002580: 2020 2020 2020 2020 2020 2020 5472 7565              True
+00002590: 2069 6620 7468 6520 6d61 7020 7072 6f70   if the map prop
+000025a0: 6572 7469 6573 2061 7265 2074 6865 2073  erties are the s
+000025b0: 616d 6520 6265 7477 6565 6e20 7477 6f20  ame between two 
+000025c0: 6d61 7073 2c20 4661 6c73 650a 2020 2020  maps, False.    
+000025d0: 2020 2020 2020 2020 6f74 6865 7277 6973          otherwis
+000025e0: 652e 0a20 2020 2020 2020 2022 2222 0a20  e..        """. 
+000025f0: 2020 2020 2020 2069 6620 280a 2020 2020         if (.    
+00002600: 2020 2020 2020 2020 2020 2020 6e70 2e69              np.i
+00002610: 7363 6c6f 7365 286d 6170 5f74 6172 6765  sclose(map_targe
+00002620: 742e 6170 6978 2c0a 2020 2020 2020 2020  t.apix,.        
+00002630: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002640: 2020 206d 6170 5f70 726f 6265 2e61 7069     map_probe.api
+00002650: 782c 0a20 2020 2020 2020 2020 2020 2020  x,.             
+00002660: 2020 2020 2020 2020 2020 2020 2020 6174                at
+00002670: 6f6c 3d31 452d 3629 2e61 6c6c 2829 2061  ol=1E-6).all() a
+00002680: 6e64 0a20 2020 2020 2020 2020 2020 2020  nd.             
+00002690: 2020 206d 6170 5f74 6172 6765 742e 626f     map_target.bo
+000026a0: 785f 7369 7a65 2829 203d 3d20 6d61 705f  x_size() == map_
+000026b0: 7072 6f62 652e 626f 785f 7369 7a65 2829  probe.box_size()
+000026c0: 0a20 2020 2020 2020 2029 3a0a 2020 2020  .        ):.    
+000026d0: 2020 2020 2020 2020 6966 2028 0a20 2020          if (.   
+000026e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000026f0: 2072 6f75 6e64 286d 6170 5f74 6172 6765   round(map_targe
+00002700: 742e 6f72 6967 696e 5b30 5d2c 2032 2920  t.origin[0], 2) 
+00002710: 3d3d 2072 6f75 6e64 286d 6170 5f70 726f  == round(map_pro
+00002720: 6265 2e6f 7269 6769 6e5b 305d 2c20 3229  be.origin[0], 2)
+00002730: 2061 6e64 2020 2320 6e6f 7161 3a45 3530   and  # noqa:E50
+00002740: 310a 2020 2020 2020 2020 2020 2020 2020  1.              
+00002750: 2020 2020 2020 726f 756e 6428 6d61 705f        round(map_
+00002760: 7461 7267 6574 2e6f 7269 6769 6e5b 315d  target.origin[1]
+00002770: 2c20 3229 203d 3d20 726f 756e 6428 6d61  , 2) == round(ma
+00002780: 705f 7072 6f62 652e 6f72 6967 696e 5b31  p_probe.origin[1
+00002790: 5d2c 2032 2920 616e 6420 2023 206e 6f71  ], 2) and  # noq
+000027a0: 613a 4535 3031 0a20 2020 2020 2020 2020  a:E501.         
+000027b0: 2020 2020 2020 2020 2020 2072 6f75 6e64             round
+000027c0: 286d 6170 5f74 6172 6765 742e 6f72 6967  (map_target.orig
+000027d0: 696e 5b32 5d2c 2032 2920 3d3d 2072 6f75  in[2], 2) == rou
+000027e0: 6e64 286d 6170 5f70 726f 6265 2e6f 7269  nd(map_probe.ori
+000027f0: 6769 6e5b 325d 2c20 3229 2020 2320 6e6f  gin[2], 2)  # no
+00002800: 7161 3a45 3530 310a 2020 2020 2020 2020  qa:E501.        
+00002810: 2020 2020 293a 0a20 2020 2020 2020 2020      ):.         
+00002820: 2020 2020 2020 2072 6574 7572 6e20 5472         return Tr
+00002830: 7565 0a20 2020 2020 2020 2020 2020 2065  ue.            e
+00002840: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+00002850: 2020 2020 2072 6574 7572 6e20 4661 6c73       return Fals
+00002860: 650a 2020 2020 2020 2020 656c 7365 3a0a  e.        else:.
+00002870: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+00002880: 726e 2046 616c 7365 0a0a 2020 2020 6465  rn False..    de
+00002890: 6620 5f66 6169 6c65 645f 6d61 7463 6828  f _failed_match(
+000028a0: 7365 6c66 293a 0a20 2020 2020 2020 2023  self):.        #
+000028b0: 2073 686f 756c 6420 696d 706c 656d 656e   should implemen
+000028c0: 7420 5445 4d50 7920 6572 726f 7273 2066  t TEMPy errors f
+000028d0: 6f72 206d 6f72 6520 656c 6567 616e 7420  or more elegant 
+000028e0: 6572 726f 7220 6861 6e64 6c69 6e67 0a20  error handling. 
+000028f0: 2020 2020 2020 2070 7269 6e74 280a 2020         print(.  
+00002900: 2020 2020 2020 2020 2020 2757 6172 6e69            'Warni
+00002910: 6e67 3a20 6361 6e5c 2774 206d 6174 6368  ng: can\'t match
+00002920: 2074 6865 206d 6170 2061 7420 7468 6520   the map at the 
+00002930: 6d6f 6d65 6e74 2c27 0a20 2020 2020 2020  moment,'.       
+00002940: 2020 2020 2027 7573 6520 6d61 7020 7769       'use map wi
+00002950: 7468 2073 616d 6520 626f 7820 7369 7a65  th same box size
+00002960: 2e27 0a20 2020 2020 2020 2029 0a20 2020  .'.        ).   
+00002970: 2020 2020 2073 7973 2e65 7869 7428 290a       sys.exit().
+00002980: 0a20 2020 2064 6566 2073 6361 6c65 5f6d  .    def scale_m
+00002990: 6564 6961 6e28 7365 6c66 2c20 6172 7231  edian(self, arr1
+000029a0: 2c20 6172 7232 293a 0a20 2020 2020 2020  , arr2):.       
+000029b0: 2022 2222 5363 616c 6520 6f6e 6520 6c69   """Scale one li
+000029c0: 7374 2f61 7272 6179 206f 6620 7363 6f72  st/array of scor
+000029d0: 6573 2077 6974 6820 7265 7370 6563 7420  es with respect 
+000029e0: 746f 2061 6e6f 7468 6572 2062 6173 6564  to another based
+000029f0: 206f 6e0a 2020 2020 2020 2020 6469 7374   on.        dist
+00002a00: 7269 6275 7469 6f6e 2061 726f 756e 6420  ribution around 
+00002a10: 6d65 6469 616e 2e0a 0a20 2020 2020 2020  median...       
+00002a20: 2041 7267 756d 656e 7473 3a0a 2020 2020   Arguments:.    
+00002a30: 2020 2020 2020 2020 6172 7231 2c20 6172          arr1, ar
+00002a40: 7232 3a20 4172 7261 792f 6c69 7374 206f  r2: Array/list o
+00002a50: 6620 7363 6f72 6573 0a0a 2020 2020 2020  f scores..      
+00002a60: 2020 5265 7475 726e 733a 0a20 2020 2020    Returns:.     
+00002a70: 2020 2020 2020 2053 6361 6c65 6420 6172         Scaled ar
+00002a80: 7231 2c20 6261 7365 6420 6f6e 2074 6865  r1, based on the
+00002a90: 2076 616c 7565 7320 696e 2061 7272 320a   values in arr2.
+00002aa0: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
+00002ab0: 2020 2020 6e70 6172 7231 203d 206e 702e      nparr1 = np.
+00002ac0: 6172 7261 7928 6172 7231 290a 2020 2020  array(arr1).    
+00002ad0: 2020 2020 6e70 6172 7232 203d 206e 702e      nparr2 = np.
+00002ae0: 6172 7261 7928 6172 7232 290a 2020 2020  array(arr2).    
+00002af0: 2020 2020 6d65 645f 6465 765f 3120 3d20      med_dev_1 = 
+00002b00: 6e70 2e6d 6564 6961 6e28 6e70 2e61 6273  np.median(np.abs
+00002b10: 6f6c 7574 6528 6e70 6172 7231 202d 206e  olute(nparr1 - n
+00002b20: 702e 6d65 6469 616e 286e 7061 7272 3129  p.median(nparr1)
+00002b30: 2929 0a20 2020 2020 2020 206d 6564 5f64  )).        med_d
+00002b40: 6576 5f32 203d 206e 702e 6d65 6469 616e  ev_2 = np.median
+00002b50: 286e 702e 6162 736f 6c75 7465 286e 7061  (np.absolute(npa
+00002b60: 7272 3220 2d20 6e70 2e6d 6564 6961 6e28  rr2 - np.median(
+00002b70: 6e70 6172 7232 2929 290a 2020 2020 2020  nparr2))).      
+00002b80: 2020 6966 206d 6564 5f64 6576 5f31 203d    if med_dev_1 =
+00002b90: 3d20 302e 303a 0a20 2020 2020 2020 2020  = 0.0:.         
+00002ba0: 2020 2073 6361 6c65 5f66 6163 746f 7220     scale_factor 
+00002bb0: 3d20 302e 300a 2020 2020 2020 2020 656c  = 0.0.        el
+00002bc0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+00002bd0: 7363 616c 655f 6661 6374 6f72 203d 206d  scale_factor = m
+00002be0: 6564 5f64 6576 5f32 202f 206d 6564 5f64  ed_dev_2 / med_d
+00002bf0: 6576 5f31 0a20 2020 2020 2020 2073 6869  ev_1.        shi
+00002c00: 6674 5f66 6163 746f 7220 3d20 6e70 2e6d  ft_factor = np.m
+00002c10: 6564 6961 6e28 6e70 6172 7232 2920 2d20  edian(nparr2) - 
+00002c20: 2873 6361 6c65 5f66 6163 746f 7220 2a20  (scale_factor * 
+00002c30: 6e70 2e6d 6564 6961 6e28 6e70 6172 7231  np.median(nparr1
+00002c40: 2929 0a0a 2020 2020 2020 2020 2320 544f  ))..        # TO
+00002c50: 444f 3a20 6669 6e64 2061 2062 6574 7465  DO: find a bette
+00002c60: 7220 7761 7920 746f 2061 766f 6964 206f  r way to avoid o
+00002c70: 7574 6c69 6572 7320 696e 2067 656e 6572  utliers in gener
+00002c80: 616c 0a20 2020 2020 2020 2069 6620 286d  al.        if (m
+00002c90: 6178 286e 7061 7272 3129 202d 206d 696e  ax(nparr1) - min
+00002ca0: 286e 7061 7272 3129 2920 3e20 302e 313a  (nparr1)) > 0.1:
+00002cb0: 0a20 2020 2020 2020 2020 2020 2073 6361  .            sca
+00002cc0: 6c65 645f 6172 7220 3d20 2828 7363 616c  led_arr = ((scal
+00002cd0: 655f 6661 6374 6f72 202a 206e 7061 7272  e_factor * nparr
+00002ce0: 3120 2b20 7368 6966 745f 6661 6374 6f72  1 + shift_factor
+00002cf0: 2920 2b20 6e70 6172 7232 2920 2f20 322e  ) + nparr2) / 2.
+00002d00: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
+00002d10: 2020 2020 2020 2020 2020 2073 6361 6c65             scale
+00002d20: 645f 6172 7220 3d20 6e70 6172 7232 0a20  d_arr = nparr2. 
+00002d30: 2020 2020 2020 2072 6574 7572 6e20 7363         return sc
+00002d40: 616c 6564 5f61 7272 0a0a 2020 2020 6465  aled_arr..    de
+00002d50: 6620 5f43 4343 5f63 616c 6328 7365 6c66  f _CCC_calc(self
+00002d60: 2c20 6d31 2c20 6d32 293a 0a20 2020 2020  , m1, m2):.     
+00002d70: 2020 2061 7272 3120 3d20 6d31 2e76 6965     arr1 = m1.vie
+00002d80: 7728 666c 6f61 7429 0a20 2020 2020 2020  w(float).       
+00002d90: 2061 7272 3220 3d20 6d32 2e76 6965 7728   arr2 = m2.view(
+00002da0: 666c 6f61 7429 2020 2320 6e6f 7161 3a46  float)  # noqa:F
+00002db0: 3834 310a 2020 2020 2020 2020 6e64 203d  841.        nd =
+00002dc0: 206c 656e 2861 7272 312e 7368 6170 6529   len(arr1.shape)
+00002dd0: 0a20 2020 2020 2020 2069 6620 6e64 203d  .        if nd =
+00002de0: 3d20 3220 616e 6420 6c65 6e28 6172 7231  = 2 and len(arr1
+00002df0: 2e73 6861 7065 295b 315d 203d 3d20 303a  .shape)[1] == 0:
+00002e00: 0a20 2020 2020 2020 2020 2020 206e 6420  .            nd 
+00002e10: 3d20 310a 2020 2020 2020 2020 6c20 3d20  = 1.        l = 
+00002e20: 3120 2023 206e 6f71 613a 4537 3431 0a20  1  # noqa:E741. 
+00002e30: 2020 2020 2020 2064 696d 203d 206e 702e         dim = np.
+00002e40: 7a65 726f 7328 332c 2064 7479 7065 3d69  zeros(3, dtype=i
+00002e50: 6e74 290a 2020 2020 2020 2020 666f 7220  nt).        for 
+00002e60: 6920 696e 2072 616e 6765 286e 6429 3a0a  i in range(nd):.
+00002e70: 2020 2020 2020 2020 2020 2020 6c20 2a3d              l *=
+00002e80: 2061 7272 312e 7368 6170 655b 695d 2020   arr1.shape[i]  
+00002e90: 2320 6e6f 7161 3a45 3734 310a 2020 2020  # noqa:E741.    
+00002ea0: 2020 2020 2020 2020 6469 6d5b 695d 203d          dim[i] =
+00002eb0: 2061 7272 312e 7368 6170 655b 695d 0a20   arr1.shape[i]. 
+00002ec0: 2020 2020 2020 2063 6f72 7220 3d20 302e         corr = 0.
+00002ed0: 300a 2020 2020 2020 2020 6e75 6d65 7220  0.        numer 
+00002ee0: 3d20 302e 300a 2020 2020 2020 2020 7661  = 0.0.        va
+00002ef0: 7231 203d 2030 2e30 0a20 2020 2020 2020  r1 = 0.0.       
+00002f00: 2076 6172 3220 3d20 302e 300a 2020 2020   var2 = 0.0.    
+00002f10: 2020 2020 6966 206e 6420 3d3d 2031 3a0a      if nd == 1:.
+00002f20: 2020 2020 2020 2020 2020 2020 666f 7220              for 
+00002f30: 7a20 696e 2072 616e 6765 2864 696d 5b30  z in range(dim[0
+00002f40: 5d29 3a0a 2020 2020 2020 2020 2020 2020  ]):.            
+00002f50: 2020 2020 6e75 6d65 7220 2b3d 2061 7272      numer += arr
+00002f60: 315b 7a5d 2a61 7272 325b 7a5d 0a20 2020  1[z]*arr2[z].   
+00002f70: 2020 2020 2020 2020 2020 2020 2076 6172               var
+00002f80: 3120 2b3d 2061 7272 315b 7a5d 2a2a 320a  1 += arr1[z]**2.
+00002f90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002fa0: 7661 7232 202b 3d20 6172 7232 5b7a 5d2a  var2 += arr2[z]*
+00002fb0: 2a32 0a20 2020 2020 2020 2065 6c69 6620  *2.        elif 
+00002fc0: 6e64 203d 3d20 333a 0a20 2020 2020 2020  nd == 3:.       
+00002fd0: 2020 2020 2066 6f72 207a 2069 6e20 7261       for z in ra
+00002fe0: 6e67 6528 6469 6d5b 305d 293a 0a20 2020  nge(dim[0]):.   
+00002ff0: 2020 2020 2020 2020 2020 2020 2066 6f72               for
+00003000: 2079 2069 6e20 7261 6e67 6528 6469 6d5b   y in range(dim[
+00003010: 315d 293a 0a20 2020 2020 2020 2020 2020  1]):.           
+00003020: 2020 2020 2020 2020 2066 6f72 2078 2069           for x i
+00003030: 6e20 7261 6e67 6528 6469 6d5b 325d 293a  n range(dim[2]):
+00003040: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00003050: 2020 2020 2020 2020 206e 756d 6572 202b           numer +
+00003060: 3d20 6172 7231 5b7a 2c20 792c 2078 5d2a  = arr1[z, y, x]*
+00003070: 6172 7232 5b7a 2c20 792c 2078 5d0a 2020  arr2[z, y, x].  
+00003080: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003090: 2020 2020 2020 7661 7231 202b 3d20 6172        var1 += ar
+000030a0: 7231 5b7a 2c20 792c 2078 5d2a 2a32 0a20  r1[z, y, x]**2. 
+000030b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000030c0: 2020 2020 2020 2076 6172 3220 2b3d 2061         var2 += a
+000030d0: 7272 325b 7a2c 2079 2c20 785d 2a2a 320a  rr2[z, y, x]**2.
+000030e0: 2020 2020 2020 2020 636f 7272 203d 206e          corr = n
+000030f0: 756d 6572 2f6d 6174 682e 7371 7274 2876  umer/math.sqrt(v
+00003100: 6172 312a 7661 7232 290a 2020 2020 2020  ar1*var2).      
+00003110: 2020 636f 7272 203d 206d 696e 2831 2e30    corr = min(1.0
+00003120: 2c20 636f 7272 290a 2020 2020 2020 2020  , corr).        
+00003130: 636f 7272 203d 206d 6178 282d 312e 302c  corr = max(-1.0,
+00003140: 2063 6f72 7229 0a20 2020 2020 2020 2072   corr).        r
+00003150: 6574 7572 6e20 636f 7272 0a0a 2020 2020  eturn corr..    
+00003160: 6465 6620 4343 435f 6d61 7028 0a20 2020  def CCC_map(.   
+00003170: 2020 2020 2020 2020 2073 656c 662c 0a20           self,. 
+00003180: 2020 2020 2020 2020 2020 206d 6170 5f74             map_t
+00003190: 6172 6765 742c 0a20 2020 2020 2020 2020  arget,.         
+000031a0: 2020 206d 6170 5f70 726f 6265 2c0a 2020     map_probe,.  
+000031b0: 2020 2020 2020 2020 2020 6d61 705f 7461            map_ta
+000031c0: 7267 6574 5f74 6872 6573 686f 6c64 3d30  rget_threshold=0
+000031d0: 2e30 2c0a 2020 2020 2020 2020 2020 2020  .0,.            
+000031e0: 6d61 705f 7072 6f62 655f 7468 7265 7368  map_probe_thresh
+000031f0: 6f6c 643d 302e 302c 0a20 2020 2020 2020  old=0.0,.       
+00003200: 2020 2020 206d 6f64 653d 312c 0a20 2020       mode=1,.   
+00003210: 2020 2020 2020 2020 206d 6561 6e44 6973           meanDis
+00003220: 743d 4661 6c73 652c 0a20 2020 2020 2020  t=False,.       
+00003230: 2020 2020 2063 6d6f 6465 3d54 7275 652c       cmode=True,
+00003240: 0a20 2020 2029 3a0a 2020 2020 2020 2020  .    ):.        
+00003250: 2222 2243 616c 6375 6c61 7465 2063 726f  """Calculate cro
+00003260: 7373 2d63 6f72 7265 6c61 7469 6f6e 2062  ss-correlation b
+00003270: 6574 7765 656e 2074 776f 204d 6170 2069  etween two Map i
+00003280: 6e73 7461 6e63 6573 2075 7369 6e67 206f  nstances using o
+00003290: 6e65 206f 660a 2020 2020 2020 2020 3320  ne of.        3 
+000032a0: 6d65 7468 6f64 732e 0a0a 2020 2020 2020  methods...      
+000032b0: 2020 4172 6773 3a0a 2020 2020 2020 2020    Args:.        
+000032c0: 2020 2020 6d61 705f 7461 7267 6574 2c20      map_target, 
+000032d0: 6d61 705f 7072 6f62 653a 2045 4d4d 6170  map_probe: EMMap
+000032e0: 2069 6e73 7461 6e63 6520 746f 2063 6f6d   instance to com
+000032f0: 7061 7265 2e0a 0a20 2020 2020 2020 2020  pare...         
+00003300: 2020 206d 6170 5f74 6172 6765 745f 7468     map_target_th
+00003310: 7265 7368 6f6c 642c 206d 6170 5f70 726f  reshold, map_pro
+00003320: 6265 5f74 6872 6573 686f 6c64 3a0a 2020  be_threshold:.  
+00003330: 2020 2020 2020 2020 2020 2020 2020 4d61                Ma
+00003340: 7020 7468 7265 7368 6f6c 642c 2075 7365  p threshold, use
+00003350: 6420 746f 2073 656c 6563 7420 7069 7865  d to select pixe
+00003360: 6c73 2077 6865 6e20 6361 6c63 756c 6174  ls when calculat
+00003370: 696e 6720 4343 4320 7769 7468 0a20 2020  ing CCC with.   
+00003380: 2020 2020 2020 2020 2020 2020 206d 6574               met
+00003390: 686f 6420 322e 2049 6620 6e6f 7420 7370  hod 2. If not sp
+000033a0: 6563 6966 6965 642c 2077 696c 6c20 6265  ecified, will be
+000033b0: 2063 616c 6375 6c61 7465 6420 7573 696e   calculated usin
+000033c0: 670a 2020 2020 2020 2020 2020 2020 2020  g.              
+000033d0: 2020 3a6d 6574 683a 6063 616c 6375 6c61    :meth:`calcula
+000033e0: 7465 5f6d 6170 5f74 6872 6573 686f 6c64  te_map_threshold
+000033f0: 203c 5445 4d50 792e 7072 6f74 6569 6e2e   <TEMPy.protein.
+00003400: 7363 6f72 696e 675f 6675 6e63 7469 6f6e  scoring_function
+00003410: 732e 5363 6f72 696e 6746 756e 6374 696f  s.ScoringFunctio
+00003420: 6e73 2e63 616c 6375 6c61 7465 5f6d 6170  ns.calculate_map
+00003430: 5f74 6872 6573 686f 6c64 3e60 2020 2320  _threshold>`  # 
+00003440: 6e6f 7161 3a45 3530 310a 0a20 2020 2020  noqa:E501..     
+00003450: 2020 2020 2020 206d 6f64 653a 0a20 2020         mode:.   
+00003460: 2020 2020 2020 2020 2020 2020 2031 2e20               1. 
+00003470: 4343 4320 6361 6c63 756c 6174 696f 6e20  CCC calculation 
+00003480: 6f6e 2061 6c6c 2070 6978 656c 7320 696e  on all pixels in
+00003490: 206d 6170 0a20 2020 2020 2020 2020 2020   map.           
+000034a0: 2020 2020 2032 2e20 4343 4320 6f6e 6c79       2. CCC only
+000034b0: 206f 6e20 7069 7865 6c73 2077 6974 6820   on pixels with 
+000034c0: 6465 6e73 6974 7920 7661 6c75 6520 6162  density value ab
+000034d0: 6f76 6520 7265 7370 6563 7469 7665 2074  ove respective t
+000034e0: 6872 6573 686f 6c64 730a 2020 2020 2020  hresholds.      
+000034f0: 2020 2020 2020 2020 2020 332e 2043 4343            3. CCC
+00003500: 206f 6e6c 7920 6f6e 2070 6978 656c 7320   only on pixels 
+00003510: 7769 7468 696e 2074 6865 206d 6173 6b0a  within the mask.
+00003520: 0a20 2020 2020 2020 2020 2020 206d 6561  .            mea
+00003530: 6e44 6973 743a 2054 7275 6520 6966 2074  nDist: True if t
+00003540: 6865 2064 6576 6961 7469 6f6e 2066 726f  he deviation fro
+00003550: 6d20 6d65 616e 206e 6565 6473 2074 6f20  m mean needs to 
+00003560: 6265 2063 616c 6375 6c61 7465 640a 0a20  be calculated.. 
+00003570: 2020 2020 2020 2020 2020 2063 6d6f 6465             cmode
+00003580: 3a20 4966 2054 7275 652c 2075 7365 2070  : If True, use p
+00003590: 7572 6520 7079 7468 6f6e 2069 6d70 6c65  ure python imple
+000035a0: 6d65 6e74 6174 696f 6e20 746f 2063 616c  mentation to cal
+000035b0: 6375 6c61 7465 2043 4343 2e0a 2020 2020  culate CCC..    
+000035c0: 2020 2020 2020 2020 2020 2020 4966 2046              If F
+000035d0: 616c 7365 2c20 7573 6520 6e75 6d70 7920  alse, use numpy 
+000035e0: 696d 706c 656d 656e 7461 7469 6f6e 2e0a  implementation..
+000035f0: 0a20 2020 2020 2020 2052 6574 7572 6e73  .        Returns
+00003600: 3a0a 0a20 2020 2020 2020 2020 2020 2043  :..            C
+00003610: 4343 2c20 7065 7263 656e 7461 6765 5f6f  CC, percentage_o
+00003620: 7665 726c 6170 3a20 5468 6520 6372 6f73  verlap: The cros
+00003630: 7320 636f 7272 656c 6174 696f 6e20 7363  s correlation sc
+00003640: 6f72 6520 616e 6420 7468 650a 2020 2020  ore and the.    
+00003650: 2020 2020 2020 2020 7065 7263 656e 7461          percenta
+00003660: 6765 206f 7665 726c 6170 2062 6574 7765  ge overlap betwe
+00003670: 656e 2074 6865 2074 776f 2069 6e70 7574  en the two input
+00003680: 206d 6170 730a 0a20 2020 2020 2020 2052   maps..        R
+00003690: 6169 7365 733a 0a0a 2020 2020 2020 2020  aises:..        
+000036a0: 2020 2020 5761 726e 696e 673a 2057 696c      Warning: Wil
+000036b0: 6c20 7265 7475 726e 202d 312c 2030 2069  l return -1, 0 i
+000036c0: 6620 7468 6520 7477 6f20 696e 7075 7420  f the two input 
+000036d0: 6d61 7073 2064 6f20 6e6f 7420 6d61 7463  maps do not matc
+000036e0: 680a 2020 2020 2020 2020 2020 2020 2020  h.              
+000036f0: 2020 7368 6170 652c 2070 6978 656c 2073    shape, pixel s
+00003700: 697a 6520 616e 6420 6f72 6967 696e 2e0a  ize and origin..
+00003710: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
+00003720: 2020 2020 6966 2073 656c 662e 6d61 7043      if self.mapC
+00003730: 6f6d 7061 7269 736f 6e28 6d61 705f 7461  omparison(map_ta
+00003740: 7267 6574 2c20 6d61 705f 7072 6f62 6529  rget, map_probe)
+00003750: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
+00003760: 206e 6f74 206d 6f64 6520 3d3d 2031 3a0a   not mode == 1:.
+00003770: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003780: 6966 206d 6170 5f74 6172 6765 745f 7468  if map_target_th
+00003790: 7265 7368 6f6c 6420 3d3d 2030 2061 6e64  reshold == 0 and
+000037a0: 206d 6170 5f70 726f 6265 5f74 6872 6573   map_probe_thres
+000037b0: 686f 6c64 203d 3d20 303a 0a20 2020 2020  hold == 0:.     
+000037c0: 2020 2020 2020 2020 2020 2020 2020 206d                 m
+000037d0: 6170 5f74 6172 6765 745f 7468 7265 7368  ap_target_thresh
+000037e0: 6f6c 6420 3d20 7365 6c66 2e63 616c 6375  old = self.calcu
+000037f0: 6c61 7465 5f6d 6170 5f74 6872 6573 686f  late_map_thresho
+00003800: 6c64 280a 2020 2020 2020 2020 2020 2020  ld(.            
+00003810: 2020 2020 2020 2020 2020 2020 6d61 705f              map_
+00003820: 7461 7267 6574 0a20 2020 2020 2020 2020  target.         
+00003830: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
+00003840: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003850: 206d 6170 5f70 726f 6265 5f74 6872 6573   map_probe_thres
+00003860: 686f 6c64 203d 2073 656c 662e 6361 6c63  hold = self.calc
+00003870: 756c 6174 655f 6d61 705f 7468 7265 7368  ulate_map_thresh
+00003880: 6f6c 6428 0a20 2020 2020 2020 2020 2020  old(.           
+00003890: 2020 2020 2020 2020 2020 2020 206d 6170               map
+000038a0: 5f70 726f 6265 0a20 2020 2020 2020 2020  _probe.         
+000038b0: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
+000038c0: 2020 2020 2020 2020 2020 2020 2062 696e               bin
+000038d0: 5f6d 6170 3120 3d20 6d61 705f 7461 7267  _map1 = map_targ
+000038e0: 6574 2e66 756c 6c4d 6170 203e 2066 6c6f  et.fullMap > flo
+000038f0: 6174 286d 6170 5f74 6172 6765 745f 7468  at(map_target_th
+00003900: 7265 7368 6f6c 6429 0a20 2020 2020 2020  reshold).       
+00003910: 2020 2020 2020 2020 2062 696e 5f6d 6170           bin_map
+00003920: 3220 3d20 6d61 705f 7072 6f62 652e 6675  2 = map_probe.fu
+00003930: 6c6c 4d61 7020 3e20 666c 6f61 7428 6d61  llMap > float(ma
+00003940: 705f 7072 6f62 655f 7468 7265 7368 6f6c  p_probe_threshol
+00003950: 6429 0a20 2020 2020 2020 2020 2020 2020  d).             
+00003960: 2020 206d 696e 696d 203d 206e 702e 7375     minim = np.su
+00003970: 6d28 6269 6e5f 6d61 7031 290a 2020 2020  m(bin_map1).    
+00003980: 2020 2020 2020 2020 2020 2020 6d69 6e69              mini
+00003990: 6d32 203d 206e 702e 7375 6d28 6269 6e5f  m2 = np.sum(bin_
+000039a0: 6d61 7032 290a 2020 2020 2020 2020 2020  map2).          
+000039b0: 2020 2020 2020 6966 206d 696e 696d 3220        if minim2 
+000039c0: 3c20 6d69 6e69 6d3a 0a20 2020 2020 2020  < minim:.       
+000039d0: 2020 2020 2020 2020 2020 2020 206d 696e               min
+000039e0: 696d 203d 206d 696e 696d 320a 2020 2020  im = minim2.    
+000039f0: 2020 2020 2020 2020 2020 2020 6d61 736b              mask
+00003a00: 5f61 7272 6179 203d 2028 6269 6e5f 6d61  _array = (bin_ma
+00003a10: 7031 202a 2062 696e 5f6d 6170 3229 203e  p1 * bin_map2) >
+00003a20: 2030 0a20 2020 2020 2020 2020 2020 2020   0.             
+00003a30: 2020 2069 6620 6e6f 7420 6d69 6e69 6d20     if not minim 
+00003a40: 3d3d 2030 2e30 3a0a 2020 2020 2020 2020  == 0.0:.        
+00003a50: 2020 2020 2020 2020 2020 2020 7065 7263              perc
+00003a60: 5f6f 7672 203d 2066 6c6f 6174 286e 702e  _ovr = float(np.
+00003a70: 7375 6d28 6d61 736b 5f61 7272 6179 2929  sum(mask_array))
+00003a80: 202f 206d 696e 696d 0a20 2020 2020 2020   / minim.       
+00003a90: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
+00003aa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003ab0: 2020 2070 7269 6e74 280a 2020 2020 2020     print(.      
+00003ac0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003ad0: 2020 274e 6f20 6d61 7020 6f76 6572 6c61    'No map overla
+00003ae0: 7020 2843 726f 7373 2063 6f72 7265 6c61  p (Cross correla
+00003af0: 7469 6f6e 2073 636f 7265 292c 2065 7869  tion score), exi
+00003b00: 7469 6e67 2027 0a20 2020 2020 2020 2020  ting '.         
+00003b10: 2020 2020 2020 2020 2020 2020 2020 2027                 '
+00003b20: 7363 6f72 6520 6361 6c63 756c 6174 696f  score calculatio
+00003b30: 6e2e 2e27 0a20 2020 2020 2020 2020 2020  n..'.           
+00003b40: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
+00003b50: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+00003b60: 6574 7572 6e20 2d31 2e30 2c20 302e 300a  eturn -1.0, 0.0.
+00003b70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003b80: 6966 2070 6572 635f 6f76 7220 3c20 302e  if perc_ovr < 0.
+00003b90: 3032 3a0a 2020 2020 2020 2020 2020 2020  02:.            
+00003ba0: 2020 2020 2020 2020 7265 7475 726e 202d          return -
+00003bb0: 312e 302c 2030 2e30 0a20 2020 2020 2020  1.0, 0.0.       
+00003bc0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+00003bd0: 2020 2020 2020 2020 2020 2070 6572 635f             perc_
+00003be0: 6f76 7220 3d20 312e 300a 0a20 2020 2020  ovr = 1.0..     
+00003bf0: 2020 2020 2020 2023 2063 616c 6375 6c61         # calcula
+00003c00: 7465 2043 4343 2077 6974 6869 6e20 766f  te CCC within vo
+00003c10: 6c75 6d65 206f 6620 6f76 6572 6c61 700a  lume of overlap.
+00003c20: 2020 2020 2020 2020 2020 2020 6966 206d              if m
+00003c30: 6f64 6520 3d3d 2033 3a0a 2020 2020 2020  ode == 3:.      
+00003c40: 2020 2020 2020 2020 2020 6966 206e 702e            if np.
+00003c50: 7375 6d28 6d61 736b 5f61 7272 6179 2920  sum(mask_array) 
+00003c60: 3d3d 2030 3a0a 2020 2020 2020 2020 2020  == 0:.          
+00003c70: 2020 2020 2020 2020 2020 7072 696e 7428            print(
+00003c80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00003c90: 2020 2020 2020 2020 2027 4e6f 206d 6170           'No map
+00003ca0: 206f 7665 726c 6170 2028 4372 6f73 7320   overlap (Cross 
+00003cb0: 636f 7272 656c 6174 696f 6e20 7363 6f72  correlation scor
+00003cc0: 6529 2c20 270a 2020 2020 2020 2020 2020  e), '.          
+00003cd0: 2020 2020 2020 2020 2020 2020 2020 2765                'e
+00003ce0: 7869 7469 6e67 2073 636f 7265 2063 616c  xiting score cal
+00003cf0: 6375 6c61 7469 6f6e 2e2e 270a 2020 2020  culation..'.    
+00003d00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003d10: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00003d20: 2020 2020 2020 7265 7475 726e 202d 312e        return -1.
+00003d30: 302c 2030 2e30 0a20 2020 2020 2020 2020  0, 0.0.         
+00003d40: 2020 2020 2020 206d 6170 315f 6d61 736b         map1_mask
+00003d50: 203d 206d 6170 5f74 6172 6765 742e 6675   = map_target.fu
+00003d60: 6c6c 4d61 705b 6d61 736b 5f61 7272 6179  llMap[mask_array
+00003d70: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
+00003d80: 2020 6d61 7032 5f6d 6173 6b20 3d20 6d61    map2_mask = ma
+00003d90: 705f 7072 6f62 652e 6675 6c6c 4d61 705b  p_probe.fullMap[
+00003da0: 6d61 736b 5f61 7272 6179 5d0a 2020 2020  mask_array].    
+00003db0: 2020 2020 2020 2020 2020 2020 6966 206d              if m
+00003dc0: 6561 6e44 6973 743a 0a20 2020 2020 2020  eanDist:.       
+00003dd0: 2020 2020 2020 2020 2020 2020 206d 6170               map
+00003de0: 315f 6d61 736b 203d 206d 6170 315f 6d61  1_mask = map1_ma
+00003df0: 736b 202d 206e 702e 6d65 616e 286d 6170  sk - np.mean(map
+00003e00: 315f 6d61 736b 290a 2020 2020 2020 2020  1_mask).        
+00003e10: 2020 2020 2020 2020 2020 2020 6d61 7032              map2
+00003e20: 5f6d 6173 6b20 3d20 6d61 7032 5f6d 6173  _mask = map2_mas
+00003e30: 6b20 2d20 6e70 2e6d 6561 6e28 6d61 7032  k - np.mean(map2
+00003e40: 5f6d 6173 6b29 0a20 2020 2020 2020 2020  _mask).         
+00003e50: 2020 2020 2020 2069 6620 636d 6f64 653a         if cmode:
+00003e60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00003e70: 2020 2020 2063 6f72 7220 3d20 7365 6c66       corr = self
+00003e80: 2e5f 4343 435f 6361 6c63 280a 2020 2020  ._CCC_calc(.    
 00003e90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003ea0: 6e70 2e73 756d 286e 702e 7371 7561 7265  np.sum(np.square
-00003eb0: 286d 6170 315f 6d61 736b 2929 202a 0a20  (map1_mask)) *. 
+00003ea0: 2020 2020 6d61 7031 5f6d 6173 6b2e 666c      map1_mask.fl
+00003eb0: 6174 7465 6e28 292c 0a20 2020 2020 2020  atten(),.       
 00003ec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003ed0: 2020 2020 2020 2020 2020 2020 2020 206e                 n
-00003ee0: 702e 7375 6d28 6e70 2e73 7175 6172 6528  p.sum(np.square(
-00003ef0: 6d61 7032 5f6d 6173 6b29 290a 2020 2020  map2_mask)).    
-00003f00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003f10: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-00003f20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003f30: 2020 292c 0a20 2020 2020 2020 2020 2020    ),.           
-00003f40: 2020 2020 2020 2020 2020 2020 2070 6572               per
-00003f50: 635f 6f76 720a 2020 2020 2020 2020 2020  c_ovr.          
-00003f60: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
-00003f70: 2020 2020 2020 2020 2020 2020 656c 7365              else
-00003f80: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00003f90: 2020 2020 2020 7265 7475 726e 2063 6f72        return cor
-00003fa0: 722c 2070 6572 635f 6f76 720a 0a20 2020  r, perc_ovr..   
-00003fb0: 2020 2020 2020 2020 2023 2063 616c 6375           # calcu
-00003fc0: 6c61 7465 2043 4343 2066 6f72 2063 6f6e  late CCC for con
-00003fd0: 746f 7572 6564 206d 6170 7320 6261 7365  toured maps base
-00003fe0: 6420 6f6e 2074 6872 6573 686f 6c64 0a20  d on threshold. 
-00003ff0: 2020 2020 2020 2020 2020 2065 6c69 6620             elif 
-00004000: 6d6f 6465 203d 3d20 323a 0a20 2020 2020  mode == 2:.     
-00004010: 2020 2020 2020 2020 2020 206d 6170 315f             map1_
-00004020: 6d61 736b 203d 206d 6170 5f74 6172 6765  mask = map_targe
-00004030: 742e 6675 6c6c 4d61 7020 2a20 6269 6e5f  t.fullMap * bin_
-00004040: 6d61 7031 0a20 2020 2020 2020 2020 2020  map1.           
-00004050: 2020 2020 206d 6170 325f 6d61 736b 203d       map2_mask =
-00004060: 206d 6170 5f70 726f 6265 2e66 756c 6c4d   map_probe.fullM
-00004070: 6170 202a 2062 696e 5f6d 6170 320a 2020  ap * bin_map2.  
-00004080: 2020 2020 2020 2020 2020 2020 2020 6966                if
-00004090: 206d 6561 6e44 6973 743a 0a20 2020 2020   meanDist:.     
-000040a0: 2020 2020 2020 2020 2020 2020 2020 206d                 m
-000040b0: 6170 315f 6d61 736b 203d 2028 0a20 2020  ap1_mask = (.   
-000040c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000040d0: 2020 2020 2020 2020 206d 6170 315f 6d61           map1_ma
-000040e0: 736b 202d 0a20 2020 2020 2020 2020 2020  sk -.           
+00003ed0: 206d 6170 325f 6d61 736b 2e66 6c61 7474   map2_mask.flatt
+00003ee0: 656e 2829 2c0a 2020 2020 2020 2020 2020  en(),.          
+00003ef0: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+00003f00: 2020 2020 2020 2020 2020 2020 656c 7365              else
+00003f10: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00003f20: 2020 2020 2020 636f 7272 203d 204e 6f6e        corr = Non
+00003f30: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
+00003f40: 2020 6966 2063 6f72 7220 6973 204e 6f6e    if corr is Non
+00003f50: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+00003f60: 2020 2020 2020 2072 6574 7572 6e20 280a         return (.
+00003f70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003f80: 2020 2020 2020 2020 280a 2020 2020 2020          (.      
+00003f90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003fa0: 2020 2020 2020 6e70 2e73 756d 286d 6170        np.sum(map
+00003fb0: 315f 6d61 736b 202a 206d 6170 325f 6d61  1_mask * map2_ma
+00003fc0: 736b 2920 2f0a 2020 2020 2020 2020 2020  sk) /.          
+00003fd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003fe0: 2020 6e70 2e73 7172 7428 0a20 2020 2020    np.sqrt(.     
+00003ff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004000: 2020 2020 2020 2020 2020 206e 702e 7375             np.su
+00004010: 6d28 6e70 2e73 7175 6172 6528 6d61 7031  m(np.square(map1
+00004020: 5f6d 6173 6b29 2920 2a0a 2020 2020 2020  _mask)) *.      
+00004030: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004040: 2020 2020 2020 2020 2020 6e70 2e73 756d            np.sum
+00004050: 286e 702e 7371 7561 7265 286d 6170 325f  (np.square(map2_
+00004060: 6d61 736b 2929 0a20 2020 2020 2020 2020  mask)).         
+00004070: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004080: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
+00004090: 2020 2020 2020 2020 2020 2020 2029 2c0a               ),.
+000040a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000040b0: 2020 2020 2020 2020 7065 7263 5f6f 7672          perc_ovr
+000040c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000040d0: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
+000040e0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
 000040f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004100: 206e 702e 6d65 616e 286d 6170 5f74 6172   np.mean(map_tar
-00004110: 6765 742e 6675 6c6c 4d61 705b 6269 6e5f  get.fullMap[bin_
-00004120: 6d61 7031 5d29 0a20 2020 2020 2020 2020  map1]).         
-00004130: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
-00004140: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004150: 206d 6170 325f 6d61 736b 203d 2028 0a20   map2_mask = (. 
-00004160: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004170: 2020 2020 2020 2020 2020 206d 6170 325f             map2_
-00004180: 6d61 736b 202d 0a20 2020 2020 2020 2020  mask -.         
-00004190: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000041a0: 2020 206e 702e 6d65 616e 286d 6170 5f70     np.mean(map_p
-000041b0: 726f 6265 2e66 756c 6c4d 6170 5b62 696e  robe.fullMap[bin
-000041c0: 5f6d 6170 325d 290a 2020 2020 2020 2020  _map2]).        
-000041d0: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
-000041e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000041f0: 2020 6d61 7031 5f6d 6173 6b20 3d20 6d61    map1_mask = ma
-00004200: 7031 5f6d 6173 6b20 2a20 6269 6e5f 6d61  p1_mask * bin_ma
-00004210: 7031 0a20 2020 2020 2020 2020 2020 2020  p1.             
-00004220: 2020 2020 2020 206d 6170 325f 6d61 736b         map2_mask
-00004230: 203d 206d 6170 325f 6d61 736b 202a 2062   = map2_mask * b
-00004240: 696e 5f6d 6170 320a 2020 2020 2020 2020  in_map2.        
-00004250: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-00004260: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004270: 2020 6d61 7031 5f6d 6173 6b20 3d20 6d61    map1_mask = ma
-00004280: 705f 7461 7267 6574 2e66 756c 6c4d 6170  p_target.fullMap
-00004290: 202a 2062 696e 5f6d 6170 310a 2020 2020   * bin_map1.    
-000042a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000042b0: 6d61 7032 5f6d 6173 6b20 3d20 6d61 705f  map2_mask = map_
-000042c0: 7072 6f62 652e 6675 6c6c 4d61 7020 2a20  probe.fullMap * 
-000042d0: 6269 6e5f 6d61 7032 0a20 2020 2020 2020  bin_map2.       
-000042e0: 2020 2020 2020 2020 2069 6620 636d 6f64           if cmod
-000042f0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-00004300: 2020 2020 2020 2063 6f72 7220 3d20 7365         corr = se
-00004310: 6c66 2e5f 4343 435f 6361 6c63 286d 6170  lf._CCC_calc(map
-00004320: 315f 6d61 736b 2c20 6d61 7032 5f6d 6173  1_mask, map2_mas
-00004330: 6b29 0a20 2020 2020 2020 2020 2020 2020  k).             
-00004340: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-00004350: 2020 2020 2020 2020 2020 2020 2063 6f72               cor
-00004360: 7220 3d20 4e6f 6e65 0a20 2020 2020 2020  r = None.       
-00004370: 2020 2020 2020 2020 2069 6620 636f 7272           if corr
-00004380: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
-00004390: 2020 2020 2020 2020 2020 2020 2020 7265                re
-000043a0: 7475 726e 2028 0a20 2020 2020 2020 2020  turn (.         
-000043b0: 2020 2020 2020 2020 2020 2020 2020 2028                 (
-000043c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000043d0: 2020 2020 2020 2020 2020 2020 206e 702e               np.
-000043e0: 7375 6d28 6d61 7031 5f6d 6173 6b20 2a20  sum(map1_mask * 
-000043f0: 6d61 7032 5f6d 6173 6b29 202f 0a20 2020  map2_mask) /.   
-00004400: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004410: 2020 2020 2020 2020 206e 702e 7371 7274           np.sqrt
-00004420: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-00004430: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004440: 2020 6e70 2e73 756d 286e 702e 7371 7561    np.sum(np.squa
-00004450: 7265 286d 6170 315f 6d61 736b 2929 202a  re(map1_mask)) *
-00004460: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00004470: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004480: 206e 702e 7375 6d28 6e70 2e73 7175 6172   np.sum(np.squar
-00004490: 6528 6d61 7032 5f6d 6173 6b29 290a 2020  e(map2_mask)).  
-000044a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000044b0: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
-000044c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000044d0: 2020 2020 292c 0a20 2020 2020 2020 2020      ),.         
-000044e0: 2020 2020 2020 2020 2020 2020 2020 2070                 p
-000044f0: 6572 635f 6f76 720a 2020 2020 2020 2020  erc_ovr.        
-00004500: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
-00004510: 2020 2020 2020 2020 2020 2020 2020 656c                el
-00004520: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-00004530: 2020 2020 2020 2020 7265 7475 726e 2063          return c
-00004540: 6f72 722c 2070 6572 635f 6f76 720a 2020  orr, perc_ovr.  
-00004550: 2020 2020 2020 2020 2020 2320 6361 6c63            # calc
-00004560: 756c 6174 6520 6f6e 2074 6865 2063 6f6d  ulate on the com
-00004570: 706c 6574 6520 6d61 700a 2020 2020 2020  plete map.      
-00004580: 2020 2020 2020 6966 206d 6561 6e44 6973        if meanDis
-00004590: 743a 0a20 2020 2020 2020 2020 2020 2020  t:.             
-000045a0: 2020 2069 6620 636d 6f64 653a 0a20 2020     if cmode:.   
-000045b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000045c0: 2063 6f72 7220 3d20 7365 6c66 2e5f 4343   corr = self._CC
-000045d0: 435f 6361 6c63 280a 2020 2020 2020 2020  C_calc(.        
-000045e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000045f0: 6d61 705f 7461 7267 6574 2e66 756c 6c4d  map_target.fullM
-00004600: 6170 202d 206e 702e 6d65 616e 286d 6170  ap - np.mean(map
-00004610: 5f74 6172 6765 742e 6675 6c6c 4d61 7029  _target.fullMap)
-00004620: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00004630: 2020 2020 2020 2020 2020 6d61 705f 7072            map_pr
-00004640: 6f62 652e 6675 6c6c 4d61 7020 2d20 6e70  obe.fullMap - np
-00004650: 2e6d 6561 6e28 6d61 705f 7072 6f62 652e  .mean(map_probe.
-00004660: 6675 6c6c 4d61 7029 0a20 2020 2020 2020  fullMap).       
-00004670: 2020 2020 2020 2020 2020 2020 2029 0a20               ). 
-00004680: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-00004690: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-000046a0: 2020 2020 2020 2020 2063 6f72 7220 3d20           corr = 
-000046b0: 4e6f 6e65 0a20 2020 2020 2020 2020 2020  None.           
-000046c0: 2020 2020 2069 6620 636f 7272 2069 7320       if corr is 
-000046d0: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
-000046e0: 2020 2020 2020 2020 2020 7265 7475 726e            return
-000046f0: 2028 0a20 2020 2020 2020 2020 2020 2020   (.             
-00004700: 2020 2020 2020 2020 2020 2028 0a20 2020             (.   
-00004710: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004720: 2020 2020 2020 2020 206e 702e 7375 6d28           np.sum(
-00004730: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00004740: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004750: 2028 0a20 2020 2020 2020 2020 2020 2020   (.             
-00004760: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004770: 2020 2020 2020 206d 6170 5f74 6172 6765         map_targe
-00004780: 742e 6675 6c6c 4d61 7020 2d0a 2020 2020  t.fullMap -.    
+00004100: 2072 6574 7572 6e20 636f 7272 2c20 7065   return corr, pe
+00004110: 7263 5f6f 7672 0a0a 2020 2020 2020 2020  rc_ovr..        
+00004120: 2020 2020 2320 6361 6c63 756c 6174 6520      # calculate 
+00004130: 4343 4320 666f 7220 636f 6e74 6f75 7265  CCC for contoure
+00004140: 6420 6d61 7073 2062 6173 6564 206f 6e20  d maps based on 
+00004150: 7468 7265 7368 6f6c 640a 2020 2020 2020  threshold.      
+00004160: 2020 2020 2020 656c 6966 206d 6f64 6520        elif mode 
+00004170: 3d3d 2032 3a0a 2020 2020 2020 2020 2020  == 2:.          
+00004180: 2020 2020 2020 6d61 7031 5f6d 6173 6b20        map1_mask 
+00004190: 3d20 6d61 705f 7461 7267 6574 2e66 756c  = map_target.ful
+000041a0: 6c4d 6170 202a 2062 696e 5f6d 6170 310a  lMap * bin_map1.
+000041b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000041c0: 6d61 7032 5f6d 6173 6b20 3d20 6d61 705f  map2_mask = map_
+000041d0: 7072 6f62 652e 6675 6c6c 4d61 7020 2a20  probe.fullMap * 
+000041e0: 6269 6e5f 6d61 7032 0a20 2020 2020 2020  bin_map2.       
+000041f0: 2020 2020 2020 2020 2069 6620 6d65 616e           if mean
+00004200: 4469 7374 3a0a 2020 2020 2020 2020 2020  Dist:.          
+00004210: 2020 2020 2020 2020 2020 6d61 7031 5f6d            map1_m
+00004220: 6173 6b20 3d20 280a 2020 2020 2020 2020  ask = (.        
+00004230: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004240: 2020 2020 6d61 7031 5f6d 6173 6b20 2d0a      map1_mask -.
+00004250: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004260: 2020 2020 2020 2020 2020 2020 6e70 2e6d              np.m
+00004270: 6561 6e28 6d61 705f 7461 7267 6574 2e66  ean(map_target.f
+00004280: 756c 6c4d 6170 5b62 696e 5f6d 6170 315d  ullMap[bin_map1]
+00004290: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+000042a0: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+000042b0: 2020 2020 2020 2020 2020 2020 6d61 7032              map2
+000042c0: 5f6d 6173 6b20 3d20 280a 2020 2020 2020  _mask = (.      
+000042d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000042e0: 2020 2020 2020 6d61 7032 5f6d 6173 6b20        map2_mask 
+000042f0: 2d0a 2020 2020 2020 2020 2020 2020 2020  -.              
+00004300: 2020 2020 2020 2020 2020 2020 2020 6e70                np
+00004310: 2e6d 6561 6e28 6d61 705f 7072 6f62 652e  .mean(map_probe.
+00004320: 6675 6c6c 4d61 705b 6269 6e5f 6d61 7032  fullMap[bin_map2
+00004330: 5d29 0a20 2020 2020 2020 2020 2020 2020  ]).             
+00004340: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+00004350: 2020 2020 2020 2020 2020 2020 206d 6170               map
+00004360: 315f 6d61 736b 203d 206d 6170 315f 6d61  1_mask = map1_ma
+00004370: 736b 202a 2062 696e 5f6d 6170 310a 2020  sk * bin_map1.  
+00004380: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004390: 2020 6d61 7032 5f6d 6173 6b20 3d20 6d61    map2_mask = ma
+000043a0: 7032 5f6d 6173 6b20 2a20 6269 6e5f 6d61  p2_mask * bin_ma
+000043b0: 7032 0a20 2020 2020 2020 2020 2020 2020  p2.             
+000043c0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+000043d0: 2020 2020 2020 2020 2020 2020 206d 6170               map
+000043e0: 315f 6d61 736b 203d 206d 6170 5f74 6172  1_mask = map_tar
+000043f0: 6765 742e 6675 6c6c 4d61 7020 2a20 6269  get.fullMap * bi
+00004400: 6e5f 6d61 7031 0a20 2020 2020 2020 2020  n_map1.         
+00004410: 2020 2020 2020 2020 2020 206d 6170 325f             map2_
+00004420: 6d61 736b 203d 206d 6170 5f70 726f 6265  mask = map_probe
+00004430: 2e66 756c 6c4d 6170 202a 2062 696e 5f6d  .fullMap * bin_m
+00004440: 6170 320a 2020 2020 2020 2020 2020 2020  ap2.            
+00004450: 2020 2020 6966 2063 6d6f 6465 3a0a 2020      if cmode:.  
+00004460: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004470: 2020 636f 7272 203d 2073 656c 662e 5f43    corr = self._C
+00004480: 4343 5f63 616c 6328 6d61 7031 5f6d 6173  CC_calc(map1_mas
+00004490: 6b2c 206d 6170 325f 6d61 736b 290a 2020  k, map2_mask).  
+000044a0: 2020 2020 2020 2020 2020 2020 2020 656c                el
+000044b0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+000044c0: 2020 2020 2020 2020 636f 7272 203d 204e          corr = N
+000044d0: 6f6e 650a 2020 2020 2020 2020 2020 2020  one.            
+000044e0: 2020 2020 6966 2063 6f72 7220 6973 204e      if corr is N
+000044f0: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
+00004500: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+00004510: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00004520: 2020 2020 2020 2020 2020 280a 2020 2020            (.    
+00004530: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004540: 2020 2020 2020 2020 6e70 2e73 756d 286d          np.sum(m
+00004550: 6170 315f 6d61 736b 202a 206d 6170 325f  ap1_mask * map2_
+00004560: 6d61 736b 2920 2f0a 2020 2020 2020 2020  mask) /.        
+00004570: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004580: 2020 2020 6e70 2e73 7172 7428 0a20 2020      np.sqrt(.   
+00004590: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000045a0: 2020 2020 2020 2020 2020 2020 206e 702e               np.
+000045b0: 7375 6d28 6e70 2e73 7175 6172 6528 6d61  sum(np.square(ma
+000045c0: 7031 5f6d 6173 6b29 2920 2a0a 2020 2020  p1_mask)) *.    
+000045d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000045e0: 2020 2020 2020 2020 2020 2020 6e70 2e73              np.s
+000045f0: 756d 286e 702e 7371 7561 7265 286d 6170  um(np.square(map
+00004600: 325f 6d61 736b 2929 0a20 2020 2020 2020  2_mask)).       
+00004610: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004620: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
+00004630: 2020 2020 2020 2020 2020 2020 2020 2029                 )
+00004640: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00004650: 2020 2020 2020 2020 2020 7065 7263 5f6f            perc_o
+00004660: 7672 0a20 2020 2020 2020 2020 2020 2020  vr.             
+00004670: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+00004680: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
+00004690: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000046a0: 2020 2072 6574 7572 6e20 636f 7272 2c20     return corr, 
+000046b0: 7065 7263 5f6f 7672 0a20 2020 2020 2020  perc_ovr.       
+000046c0: 2020 2020 2023 2063 616c 6375 6c61 7465       # calculate
+000046d0: 206f 6e20 7468 6520 636f 6d70 6c65 7465   on the complete
+000046e0: 206d 6170 0a20 2020 2020 2020 2020 2020   map.           
+000046f0: 2069 6620 6d65 616e 4469 7374 3a0a 2020   if meanDist:.  
+00004700: 2020 2020 2020 2020 2020 2020 2020 6966                if
+00004710: 2063 6d6f 6465 3a0a 2020 2020 2020 2020   cmode:.        
+00004720: 2020 2020 2020 2020 2020 2020 636f 7272              corr
+00004730: 203d 2073 656c 662e 5f43 4343 5f63 616c   = self._CCC_cal
+00004740: 6328 0a20 2020 2020 2020 2020 2020 2020  c(.             
+00004750: 2020 2020 2020 2020 2020 206d 6170 5f74             map_t
+00004760: 6172 6765 742e 6675 6c6c 4d61 7020 2d20  arget.fullMap - 
+00004770: 6e70 2e6d 6561 6e28 6d61 705f 7461 7267  np.mean(map_targ
+00004780: 6574 2e66 756c 6c4d 6170 292c 0a20 2020  et.fullMap),.   
 00004790: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000047a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000047b0: 6e70 2e6d 6561 6e28 6d61 705f 7461 7267  np.mean(map_targ
-000047c0: 6574 2e66 756c 6c4d 6170 290a 2020 2020  et.fullMap).    
-000047d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000047e0: 2020 2020 2020 2020 2020 2020 2920 2a0a              ) *.
-000047f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000047a0: 2020 2020 206d 6170 5f70 726f 6265 2e66       map_probe.f
+000047b0: 756c 6c4d 6170 202d 206e 702e 6d65 616e  ullMap - np.mean
+000047c0: 286d 6170 5f70 726f 6265 2e66 756c 6c4d  (map_probe.fullM
+000047d0: 6170 290a 2020 2020 2020 2020 2020 2020  ap).            
+000047e0: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+000047f0: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
 00004800: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004810: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00004810: 2020 2020 636f 7272 203d 204e 6f6e 650a      corr = None.
 00004820: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004830: 2020 2020 2020 6d61 705f 7072 6f62 652e        map_probe.
-00004840: 6675 6c6c 4d61 7020 2d0a 2020 2020 2020  fullMap -.      
-00004850: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004860: 2020 2020 2020 2020 2020 2020 2020 6e70                np
-00004870: 2e6d 6561 6e28 6d61 705f 7072 6f62 652e  .mean(map_probe.
-00004880: 6675 6c6c 4d61 7029 0a20 2020 2020 2020  fullMap).       
-00004890: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000048a0: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
-000048b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000048c0: 2020 2020 2020 2029 202f 0a20 2020 2020         ) /.     
+00004830: 6966 2063 6f72 7220 6973 204e 6f6e 653a  if corr is None:
+00004840: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00004850: 2020 2020 2072 6574 7572 6e20 280a 2020       return (.  
+00004860: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004870: 2020 2020 2020 280a 2020 2020 2020 2020        (.        
+00004880: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004890: 2020 2020 6e70 2e73 756d 280a 2020 2020      np.sum(.    
+000048a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000048b0: 2020 2020 2020 2020 2020 2020 280a 2020              (.  
+000048c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 000048d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000048e0: 2020 2020 2020 2028 0a20 2020 2020 2020         (.       
-000048f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004900: 2020 2020 2020 2020 206e 702e 7371 7274           np.sqrt
-00004910: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-00004920: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004930: 2020 2020 2020 6e70 2e73 756d 280a 2020        np.sum(.  
+000048e0: 2020 6d61 705f 7461 7267 6574 2e66 756c    map_target.ful
+000048f0: 6c4d 6170 202d 0a20 2020 2020 2020 2020  lMap -.         
+00004900: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004910: 2020 2020 2020 2020 2020 206e 702e 6d65             np.me
+00004920: 616e 286d 6170 5f74 6172 6765 742e 6675  an(map_target.fu
+00004930: 6c6c 4d61 7029 0a20 2020 2020 2020 2020  llMap).         
 00004940: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004950: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004960: 2020 2020 2020 6e70 2e73 7175 6172 6528        np.square(
-00004970: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00004950: 2020 2020 2020 2029 202a 0a20 2020 2020         ) *.     
+00004960: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004970: 2020 2020 2020 2020 2020 2028 0a20 2020             (.   
 00004980: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004990: 2020 2020 2020 2020 2020 2020 206d 6170               map
-000049a0: 5f74 6172 6765 742e 6675 6c6c 4d61 7020  _target.fullMap 
-000049b0: 2d0a 2020 2020 2020 2020 2020 2020 2020  -.              
+00004990: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000049a0: 206d 6170 5f70 726f 6265 2e66 756c 6c4d   map_probe.fullM
+000049b0: 6170 202d 0a20 2020 2020 2020 2020 2020  ap -.           
 000049c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000049d0: 2020 2020 2020 2020 2020 2020 2020 6e70                np
-000049e0: 2e6d 6561 6e28 6d61 705f 7461 7267 6574  .mean(map_target
-000049f0: 2e66 756c 6c4d 6170 290a 2020 2020 2020  .fullMap).      
+000049d0: 2020 2020 2020 2020 206e 702e 6d65 616e           np.mean
+000049e0: 286d 6170 5f70 726f 6265 2e66 756c 6c4d  (map_probe.fullM
+000049f0: 6170 290a 2020 2020 2020 2020 2020 2020  ap).            
 00004a00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004a10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004a20: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
-00004a30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004a40: 2020 2020 2020 2020 2920 2a0a 2020 2020          ) *.    
-00004a50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004a10: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
+00004a20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004a30: 2020 2920 2f0a 2020 2020 2020 2020 2020    ) /.          
+00004a40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004a50: 2020 280a 2020 2020 2020 2020 2020 2020    (.            
 00004a60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004a70: 6e70 2e73 756d 280a 2020 2020 2020 2020  np.sum(.        
+00004a70: 2020 2020 6e70 2e73 7172 7428 0a20 2020      np.sqrt(.   
 00004a80: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00004a90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004aa0: 6e70 2e73 7175 6172 6528 0a20 2020 2020  np.square(.     
+00004aa0: 206e 702e 7375 6d28 0a20 2020 2020 2020   np.sum(.       
 00004ab0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00004ac0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004ad0: 2020 2020 2020 206d 6170 5f70 726f 6265         map_probe
-00004ae0: 2e66 756c 6c4d 6170 202d 0a20 2020 2020  .fullMap -.     
+00004ad0: 206e 702e 7371 7561 7265 280a 2020 2020   np.square(.    
+00004ae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00004af0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004b00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004b10: 2020 2020 2020 206e 702e 6d65 616e 286d         np.mean(m
-00004b20: 6170 5f70 726f 6265 2e66 756c 6c4d 6170  ap_probe.fullMap
-00004b30: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00004b40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004b50: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
-00004b60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004b00: 2020 2020 2020 2020 6d61 705f 7461 7267          map_targ
+00004b10: 6574 2e66 756c 6c4d 6170 202d 0a20 2020  et.fullMap -.   
+00004b20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004b30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004b40: 2020 2020 2020 2020 206e 702e 6d65 616e           np.mean
+00004b50: 286d 6170 5f74 6172 6765 742e 6675 6c6c  (map_target.full
+00004b60: 4d61 7029 0a20 2020 2020 2020 2020 2020  Map).           
 00004b70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004b80: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00004b80: 2020 2020 2020 2020 2020 2020 2029 0a20               ). 
 00004b90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004ba0: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
-00004bb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004bc0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00004bd0: 2020 2020 2020 2020 2020 292c 0a20 2020            ),.   
-00004be0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004bf0: 2020 2020 2070 6572 635f 6f76 720a 2020       perc_ovr.  
-00004c00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004c10: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
-00004c20: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-00004c30: 2020 2020 2020 2020 2020 2020 2020 7265                re
-00004c40: 7475 726e 2063 6f72 722c 2070 6572 635f  turn corr, perc_
-00004c50: 6f76 720a 2020 2020 2020 2020 2020 2020  ovr.            
-00004c60: 6966 2063 6d6f 6465 3a0a 2020 2020 2020  if cmode:.      
-00004c70: 2020 2020 2020 2020 2020 636f 7272 203d            corr =
-00004c80: 2073 656c 662e 5f43 4343 5f63 616c 6328   self._CCC_calc(
-00004c90: 6d61 705f 7461 7267 6574 2e66 756c 6c4d  map_target.fullM
-00004ca0: 6170 2c20 6d61 705f 7072 6f62 652e 6675  ap, map_probe.fu
-00004cb0: 6c6c 4d61 7029 0a20 2020 2020 2020 2020  llMap).         
-00004cc0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-00004cd0: 2020 2020 2020 2020 2063 6f72 7220 3d20           corr = 
-00004ce0: 4e6f 6e65 0a20 2020 2020 2020 2020 2020  None.           
-00004cf0: 2069 6620 636f 7272 2069 7320 4e6f 6e65   if corr is None
-00004d00: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00004d10: 2020 7265 7475 726e 2028 0a20 2020 2020    return (.     
-00004d20: 2020 2020 2020 2020 2020 2020 2020 206e                 n
-00004d30: 702e 7375 6d28 6d61 705f 7461 7267 6574  p.sum(map_target
-00004d40: 2e66 756c 6c4d 6170 202a 206d 6170 5f70  .fullMap * map_p
-00004d50: 726f 6265 2e66 756c 6c4d 6170 2920 2f0a  robe.fullMap) /.
-00004d60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004d70: 2020 2020 6e70 2e73 7172 7428 0a20 2020      np.sqrt(.   
-00004d80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004d90: 2020 2020 206e 702e 7375 6d28 6e70 2e73       np.sum(np.s
-00004da0: 7175 6172 6528 6d61 705f 7461 7267 6574  quare(map_target
-00004db0: 2e66 756c 6c4d 6170 2929 202a 0a20 2020  .fullMap)) *.   
-00004dc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004dd0: 2020 2020 206e 702e 7375 6d28 6e70 2e73       np.sum(np.s
-00004de0: 7175 6172 6528 6d61 705f 7072 6f62 652e  quare(map_probe.
-00004df0: 6675 6c6c 4d61 7029 290a 2020 2020 2020  fullMap)).      
-00004e00: 2020 2020 2020 2020 2020 2020 2020 292c                ),
-00004e10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00004e20: 2020 2020 2070 6572 635f 6f76 720a 2020       perc_ovr.  
-00004e30: 2020 2020 2020 2020 2020 2020 2020 290a                ).
-00004e40: 2020 2020 2020 2020 2020 2020 656c 7365              else
-00004e50: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00004e60: 2020 7265 7475 726e 2063 6f72 722c 2070    return corr, p
-00004e70: 6572 635f 6f76 720a 2020 2020 2020 2020  erc_ovr.        
-00004e80: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-00004e90: 2020 7072 696e 7428 2740 4040 204d 6170    print('@@@ Map
-00004ea0: 7320 636f 756c 6420 6e6f 7420 6265 206d  s could not be m
-00004eb0: 6174 6368 6564 2729 0a20 2020 2020 2020  atched').       
-00004ec0: 2020 2020 2072 6574 7572 6e20 2d31 2e2c       return -1.,
-00004ed0: 2030 2e0a 0a20 2020 2064 6566 2043 4343   0...    def CCC
-00004ee0: 2873 656c 662c 206d 6170 5f74 6172 6765  (self, map_targe
-00004ef0: 742c 206d 6170 5f70 726f 6265 293a 0a20  t, map_probe):. 
-00004f00: 2020 2020 2020 2022 2222 4361 6c63 756c         """Calcul
-00004f10: 6174 6520 6372 6f73 732d 636f 7272 656c  ate cross-correl
-00004f20: 6174 696f 6e20 6265 7477 6565 6e20 7477  ation between tw
-00004f30: 6f20 4d61 7020 696e 7374 616e 6365 732e  o Map instances.
-00004f40: 0a0a 2020 2020 2020 2020 4172 6773 3a0a  ..        Args:.
-00004f50: 2020 2020 2020 2020 2020 2020 6d61 705f              map_
-00004f60: 7461 7267 6574 2c20 6d61 705f 7072 6f62  target, map_prob
-00004f70: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
-00004f80: 2020 4d61 7020 696e 7374 616e 6365 2074    Map instance t
-00004f90: 6f20 636f 6d70 6172 652e 0a20 2020 2020  o compare..     
-00004fa0: 2020 2052 6574 7572 6e73 3a0a 2020 2020     Returns:.    
-00004fb0: 2020 2020 2020 2020 4343 4320 7363 6f72          CCC scor
-00004fc0: 650a 2020 2020 2020 2020 5261 6973 6573  e.        Raises
-00004fd0: 3a0a 2020 2020 2020 2020 2020 2020 7379  :.            sy
-00004fe0: 732e 6578 6974 3a20 496e 7075 7420 6d61  s.exit: Input ma
-00004ff0: 7073 2064 6f20 6e6f 7420 6d61 7463 6820  ps do not match 
-00005000: 696e 2073 6861 7065 2c20 7069 7865 6c20  in shape, pixel 
-00005010: 7369 7a65 206f 7220 6f72 6967 696e 0a20  size or origin. 
-00005020: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
-00005030: 2020 2069 6620 7365 6c66 2e6d 6170 436f     if self.mapCo
-00005040: 6d70 6172 6973 6f6e 286d 6170 5f74 6172  mparison(map_tar
-00005050: 6765 742c 206d 6170 5f70 726f 6265 293a  get, map_probe):
-00005060: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-00005070: 7572 6e20 280a 2020 2020 2020 2020 2020  urn (.          
-00005080: 2020 2020 2020 6d61 705f 7461 7267 6574        map_target
-00005090: 2e6e 6f72 6d61 6c69 7365 2829 2e67 6574  .normalise().get
-000050a0: 4d61 7028 292a 6d61 705f 7072 6f62 652e  Map()*map_probe.
-000050b0: 6e6f 726d 616c 6973 6528 292e 6765 744d  normalise().getM
-000050c0: 6170 2829 0a20 2020 2020 2020 2020 2020  ap().           
-000050d0: 2029 2e6d 6561 6e28 290a 2020 2020 2020   ).mean().      
-000050e0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-000050f0: 2020 2020 7365 6c66 2e5f 6661 696c 6564      self._failed
-00005100: 5f6d 6174 6368 2829 0a0a 2020 2020 6465  _match()..    de
-00005110: 6620 4c53 4628 7365 6c66 2c20 6d61 705f  f LSF(self, map_
-00005120: 7461 7267 6574 2c20 6d61 705f 7072 6f62  target, map_prob
-00005130: 6529 3a0a 2020 2020 2020 2020 2222 2243  e):.        """C
-00005140: 616c 6375 6c61 7465 206c 6561 7374 2d73  alculate least-s
-00005150: 7175 6172 6573 2062 6574 7765 656e 2074  quares between t
-00005160: 776f 204d 6170 2069 6e73 7461 6e63 6573  wo Map instances
-00005170: 2e0a 0a20 2020 2020 2020 2041 7267 756d  ...        Argum
-00005180: 656e 7473 3a0a 2020 2020 2020 2020 2020  ents:.          
-00005190: 2020 6d61 705f 7461 7267 6574 2c20 6d61    map_target, ma
-000051a0: 705f 7072 6f62 653a 204d 6170 2069 6e73  p_probe: Map ins
-000051b0: 7461 6e63 6520 746f 2063 6f6d 7061 7265  tance to compare
-000051c0: 2e0a 2020 2020 2020 2020 5265 7475 726e  ..        Return
-000051d0: 3a0a 2020 2020 2020 2020 2020 2020 4c65  :.            Le
-000051e0: 6173 742d 7371 7561 7265 7320 7661 6c75  ast-squares valu
-000051f0: 650a 2020 2020 2020 2020 5261 6973 6573  e.        Raises
-00005200: 3a0a 2020 2020 2020 2020 2020 2020 7379  :.            sy
-00005210: 732e 6578 6974 3a20 496e 7075 7420 6d61  s.exit: Input ma
-00005220: 7073 2064 6f20 6e6f 7420 6d61 7463 6820  ps do not match 
-00005230: 696e 2073 6861 7065 2c20 7069 7865 6c20  in shape, pixel 
-00005240: 7369 7a65 206f 7220 6f72 6967 696e 0a20  size or origin. 
-00005250: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
-00005260: 2020 2069 6620 7365 6c66 2e6d 6170 436f     if self.mapCo
-00005270: 6d70 6172 6973 6f6e 286d 6170 5f74 6172  mparison(map_tar
-00005280: 6765 742c 206d 6170 5f70 726f 6265 293a  get, map_probe):
-00005290: 0a20 2020 2020 2020 2020 2020 206d 6170  .            map
-000052a0: 5f74 6172 6765 742c 206d 6170 5f70 726f  _target, map_pro
-000052b0: 6265 203d 206d 6170 5f74 6172 6765 742c  be = map_target,
-000052c0: 206d 6170 5f70 726f 6265 0a20 2020 2020   map_probe.     
-000052d0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-000052e0: 2020 2020 2073 656c 662e 5f66 6169 6c65       self._faile
-000052f0: 645f 6d61 7463 6828 290a 2020 2020 2020  d_match().      
-00005300: 2020 7265 7475 726e 2028 286d 6170 5f74    return ((map_t
-00005310: 6172 6765 742e 6765 744d 6170 2829 202d  arget.getMap() -
-00005320: 206d 6170 5f70 726f 6265 2e67 6574 4d61   map_probe.getMa
-00005330: 7028 2929 2a2a 3229 2e6d 6561 6e28 290a  p())**2).mean().
-00005340: 0a20 2020 2064 6566 206c 6170 6c61 6365  .    def laplace
-00005350: 5f43 4343 280a 2020 2020 2020 2020 2020  _CCC(.          
-00005360: 2020 7365 6c66 2c0a 2020 2020 2020 2020    self,.        
-00005370: 2020 2020 6d61 705f 7461 7267 6574 2c0a      map_target,.
-00005380: 2020 2020 2020 2020 2020 2020 6d61 705f              map_
-00005390: 7072 6f62 652c 0a20 2020 2020 2020 2020  probe,.         
-000053a0: 2020 2070 7265 6669 6c3d 2846 616c 7365     prefil=(False
-000053b0: 2c20 4661 6c73 6529 0a20 2020 2029 3a0a  , False).    ):.
-000053c0: 2020 2020 2020 2020 2222 2243 616c 6375          """Calcu
-000053d0: 6c61 7465 2043 4343 2062 6574 7765 656e  late CCC between
-000053e0: 2074 776f 206c 6170 6c61 6369 616e 2066   two laplacian f
-000053f0: 696c 7465 7265 6420 4d61 7020 696e 7374  iltered Map inst
-00005400: 616e 6365 732e 0a0a 2020 2020 2020 2020  ances...        
-00005410: 5468 6520 6c61 706c 6163 6961 6e20 6669  The laplacian fi
-00005420: 6c74 6572 2069 7320 616e 2065 6467 6520  lter is an edge 
-00005430: 6465 7465 6374 696f 6e20 6669 6c74 6572  detection filter
-00005440: 2c20 7768 6963 6820 636f 6d70 7574 6573  , which computes
-00005450: 2074 6865 0a20 2020 2020 2020 2073 6563   the.        sec
-00005460: 6f6e 6420 6465 7276 6961 7469 7665 7320  ond derviatives 
-00005470: 6f66 2061 6e20 696d 6167 652f 766f 6c75  of an image/volu
-00005480: 6d65 2e20 5573 696e 6720 4c61 706c 6163  me. Using Laplac
-00005490: 6961 6e20 6669 6c74 6572 7320 696e 0a20  ian filters in. 
-000054a0: 2020 2020 2020 2063 6f6d 6269 6e61 7469         combinati
-000054b0: 6f6e 2077 6974 6820 4343 4320 7363 6f72  on with CCC scor
-000054c0: 696e 6720 6f66 2063 7279 6f20 454d 206d  ing of cryo EM m
-000054d0: 6f64 656c 7320 2077 6173 2073 686f 776e  odels  was shown
-000054e0: 2074 6f20 6265 206d 6f72 650a 2020 2020   to be more.    
-000054f0: 2020 2020 6163 6375 7261 7465 2074 6861      accurate tha
-00005500: 6e20 4343 4320 7363 6f72 696e 6720 616c  n CCC scoring al
-00005510: 6f6e 6520 666f 7220 6c6f 7720 7265 736f  one for low reso
-00005520: 6c75 7469 6f6e 206d 6170 732c 2069 6e0a  lution maps, in.
-00005530: 2020 2020 2020 2020 6028 4368 6163 6f6e          `(Chacon
-00005540: 2061 6e64 2057 7269 6767 6572 732c 2032   and Wriggers, 2
-00005550: 3030 3229 203c 6874 7470 733a 2f2f 7075  002) <https://pu
-00005560: 626d 6564 2e6e 6362 692e 6e6c 6d2e 6e69  bmed.ncbi.nlm.ni
-00005570: 682e 676f 762f 3131 3932 3236 3731 2f3e  h.gov/11922671/>
-00005580: 605f 0a0a 2020 2020 2020 2020 4172 6775  `_..        Argu
-00005590: 6d65 6e74 733a 0a20 2020 2020 2020 2020  ments:.         
-000055a0: 2020 206d 6170 5f74 6172 6765 742c 206d     map_target, m
-000055b0: 6170 5f70 726f 6265 3a20 4d61 7020 696e  ap_probe: Map in
-000055c0: 7374 616e 6365 7320 746f 2063 6f6d 7061  stances to compa
-000055d0: 7265 2e0a 0a20 2020 2020 2020 2020 2020  re...           
-000055e0: 2070 7265 6669 6c3a 2032 2d74 7570 6c65   prefil: 2-tuple
-000055f0: 206f 6620 626f 6f6c 6561 6e20 7661 6c75   of boolean valu
-00005600: 6573 2c20 6f6e 6520 666f 7220 6561 6368  es, one for each
-00005610: 206d 6170 2072 6573 7065 6374 6976 656c   map respectivel
-00005620: 792e 0a20 2020 2020 2020 2020 2020 2020  y..             
-00005630: 2020 2054 7275 6520 6966 204d 6170 2069     True if Map i
-00005640: 6e73 7461 6e63 6520 6973 2061 6c72 6561  nstance is alrea
-00005650: 6479 204c 6170 6c61 6369 616e 2d66 696c  dy Laplacian-fil
-00005660: 7465 7265 642e 2046 616c 7365 0a20 2020  tered. False.   
-00005670: 2020 2020 2020 2020 2020 2020 206f 7468               oth
-00005680: 6572 7769 7365 2e0a 2020 2020 2020 2020  erwise..        
-00005690: 5265 7475 726e 3a0a 2020 2020 2020 2020  Return:.        
-000056a0: 2020 2020 4c61 706c 6163 6961 6e20 6372      Laplacian cr
-000056b0: 6f73 732d 636f 7272 656c 6174 696f 6e20  oss-correlation 
-000056c0: 7363 6f72 650a 2020 2020 2020 2020 5261  score.        Ra
-000056d0: 6973 6573 3a0a 2020 2020 2020 2020 2020  ises:.          
-000056e0: 2020 7379 732e 6578 6974 3a20 496e 7075    sys.exit: Inpu
-000056f0: 7420 6d61 7073 2064 6f20 6e6f 7420 6d61  t maps do not ma
-00005700: 7463 6820 696e 2073 6861 7065 2c20 7069  tch in shape, pi
-00005710: 7865 6c20 7369 7a65 206f 7220 6f72 6967  xel size or orig
-00005720: 696e 0a20 2020 2020 2020 2022 2222 0a0a  in.        """..
-00005730: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
-00005740: 6d61 7043 6f6d 7061 7269 736f 6e28 6d61  mapComparison(ma
-00005750: 705f 7461 7267 6574 2c20 6d61 705f 7072  p_target, map_pr
-00005760: 6f62 6529 3a0a 2020 2020 2020 2020 2020  obe):.          
-00005770: 2020 2320 4920 646f 6e27 7420 756e 6465    # I don't unde
-00005780: 7273 7461 6e64 2074 6869 7320 2d20 6361  rstand this - ca
-00005790: 6e20 7765 2072 6570 6c61 6365 2069 7420  n we replace it 
-000057a0: 7769 7468 2070 6173 733f 0a20 2020 2020  with pass?.     
-000057b0: 2020 2020 2020 205f 2c20 5f20 3d20 6d61         _, _ = ma
-000057c0: 705f 7461 7267 6574 2c20 6d61 705f 7072  p_target, map_pr
-000057d0: 6f62 6520 2023 206e 6f71 613a 4638 3431  obe  # noqa:F841
-000057e0: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
-000057f0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-00005800: 5f66 6169 6c65 645f 6d61 7463 6828 290a  _failed_match().
-00005810: 0a20 2020 2020 2020 2069 6620 6e6f 7420  .        if not 
-00005820: 7072 6566 696c 5b30 5d3a 0a20 2020 2020  prefil[0]:.     
-00005830: 2020 2020 2020 206d 6170 5f74 6172 6765         map_targe
-00005840: 7420 3d20 6d61 705f 7461 7267 6574 2e6c  t = map_target.l
-00005850: 6170 6c61 6365 5f66 696c 7465 7265 6428  aplace_filtered(
-00005860: 290a 2020 2020 2020 2020 6966 206e 6f74  ).        if not
-00005870: 2070 7265 6669 6c5b 315d 3a0a 2020 2020   prefil[1]:.    
-00005880: 2020 2020 2020 2020 6d61 705f 7072 6f62          map_prob
-00005890: 6520 3d20 6d61 705f 7072 6f62 652e 6c61  e = map_probe.la
-000058a0: 706c 6163 655f 6669 6c74 6572 6564 2829  place_filtered()
-000058b0: 0a20 2020 2020 2020 206d 6170 5f74 6172  .        map_tar
-000058c0: 6765 7420 3d20 6d61 705f 7461 7267 6574  get = map_target
-000058d0: 2e6e 6f72 6d61 6c69 7365 2829 0a20 2020  .normalise().   
-000058e0: 2020 2020 206d 6170 5f70 726f 6265 203d       map_probe =
-000058f0: 206d 6170 5f70 726f 6265 2e6e 6f72 6d61   map_probe.norma
-00005900: 6c69 7365 2829 0a20 2020 2020 2020 2072  lise().        r
-00005910: 6574 7572 6e20 7365 6c66 2e43 4343 286d  eturn self.CCC(m
-00005920: 6170 5f74 6172 6765 742c 206d 6170 5f70  ap_target, map_p
-00005930: 726f 6265 290a 0a20 2020 2064 6566 206e  robe)..    def n
-00005940: 6f72 6d61 6c5f 7665 6374 6f72 5f73 636f  ormal_vector_sco
-00005950: 7265 280a 2020 2020 2020 2020 2020 2020  re(.            
-00005960: 7365 6c66 2c0a 2020 2020 2020 2020 2020  self,.          
-00005970: 2020 6d61 705f 7461 7267 6574 2c0a 2020    map_target,.  
-00005980: 2020 2020 2020 2020 2020 6d61 705f 7072            map_pr
-00005990: 6f62 652c 0a20 2020 2020 2020 2020 2020  obe,.           
-000059a0: 2070 7269 6d61 7279 5f62 6f75 6e64 6172   primary_boundar
-000059b0: 792c 0a20 2020 2020 2020 2020 2020 2073  y,.            s
-000059c0: 6563 6f6e 6461 7279 5f62 6f75 6e64 6172  econdary_boundar
-000059d0: 793d 302e 302c 0a20 2020 2020 2020 2020  y=0.0,.         
-000059e0: 2020 2046 696c 7465 723d 4e6f 6e65 2c0a     Filter=None,.
-000059f0: 2020 2020 293a 0a20 2020 2020 2020 2022      ):.        "
-00005a00: 2222 4361 6c63 756c 6174 6520 7468 6520  ""Calculate the 
-00005a10: 4e6f 726d 616c 2056 6563 746f 7220 5363  Normal Vector Sc
-00005a20: 6f72 6520 6265 7477 6565 6e20 7477 6f20  ore between two 
-00005a30: 4d61 7020 7375 7266 6163 6573 2e0a 0a20  Map surfaces... 
-00005a40: 2020 2020 2020 2042 6173 6564 206f 6e20         Based on 
-00005a50: 3353 4f4d 2061 6c67 6f72 6974 686d 2028  3SOM algorithm (
-00005a60: 4365 756c 656d 616e 7320 616e 6420 5275  Ceulemans and Ru
-00005a70: 7373 656c 6c2c 2032 3030 3429 2e0a 0a20  ssell, 2004)... 
-00005a80: 2020 2020 2020 2041 7267 756d 656e 7473         Arguments
-00005a90: 3a0a 2020 2020 2020 2020 2020 2020 6d61  :.            ma
-00005aa0: 705f 7461 7267 6574 2c20 6d61 705f 7072  p_target, map_pr
-00005ab0: 6f62 653a 0a20 2020 2020 2020 2020 2020  obe:.           
-00005ac0: 2020 2020 204d 6170 2069 6e73 7461 6e63       Map instanc
-00005ad0: 6573 2074 6f20 636f 6d70 6172 652e 0a20  es to compare.. 
-00005ae0: 2020 2020 2020 2020 2020 2070 7269 6d61             prima
-00005af0: 7279 5f62 6f75 6e64 6172 792c 2073 6563  ry_boundary, sec
-00005b00: 6f6e 6461 7279 5f62 6f75 6e64 6172 793a  ondary_boundary:
-00005b10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00005b20: 2049 6620 6120 6669 6c74 6572 2069 7320   If a filter is 
-00005b30: 7365 6c65 6374 6564 2c20 6a75 7374 2069  selected, just i
-00005b40: 6e70 7574 2061 2063 6f6e 746f 7572 206c  nput a contour l
-00005b50: 6576 656c 2061 7320 7072 696d 6172 790a  evel as primary.
-00005b60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005b70: 7468 7265 7368 6f6c 642e 204f 7468 6572  threshold. Other
-00005b80: 7769 7365 2c20 6e65 6564 2074 6f20 7275  wise, need to ru
-00005b90: 6e20 6765 745f 7072 696d 6172 795f 626f  n get_primary_bo
-00005ba0: 756e 6461 7279 2061 6e64 0a20 2020 2020  undary and.     
-00005bb0: 2020 2020 2020 2020 2020 2067 6574 5f73             get_s
-00005bc0: 6563 6f6e 645f 626f 756e 6461 7279 2062  econd_boundary b
-00005bd0: 6173 6564 206f 6e20 6d61 7020 7461 7267  ased on map targ
-00005be0: 6574 2e0a 2020 2020 2020 2020 2020 2020  et..            
-00005bf0: 4669 6c74 6572 3a0a 2020 2020 2020 2020  Filter:.        
-00005c00: 2020 2020 2020 2020 4669 6c74 6572 2074          Filter t
-00005c10: 6f20 6265 2061 7070 6c69 6564 2074 6f20  o be applied to 
-00005c20: 696e 7075 7473 206d 6170 7320 6265 666f  inputs maps befo
-00005c30: 7265 2063 616c 6375 6c61 7469 6e67 2073  re calculating s
-00005c40: 636f 7265 2e0a 2020 2020 2020 2020 2020  core..          
-00005c50: 2020 2020 2020 2020 2020 312e 2053 6f62            1. Sob
-00005c60: 656c 2046 696c 7465 7220 2846 696c 7465  el Filter (Filte
-00005c70: 723d 3d27 536f 6265 6c27 290a 2020 2020  r=='Sobel').    
-00005c80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005c90: 322e 204c 6170 6c61 6365 2046 696c 7465  2. Laplace Filte
-00005ca0: 7220 2846 696c 7465 723d 3d27 4c61 706c  r (Filter=='Lapl
-00005cb0: 6163 6527 290a 2020 2020 2020 2020 2020  ace').          
-00005cc0: 2020 2020 2020 2020 2020 332e 204d 696e            3. Min
-00005cd0: 696d 756d 2046 696c 7465 7220 2846 696c  imum Filter (Fil
-00005ce0: 7465 723d 3d27 4d69 6e69 6d75 6d27 290a  ter=='Minimum').
-00005cf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005d00: 2020 2020 342e 204d 6561 6e20 4669 6c74      4. Mean Filt
-00005d10: 6572 2028 4669 6c74 6572 3d3d 274d 6561  er (Filter=='Mea
-00005d20: 6e27 290a 2020 2020 2020 2020 2020 2020  n').            
-00005d30: 2020 2020 2020 2020 352e 204e 6f20 6669          5. No fi
-00005d40: 6c74 6572 696e 6720 2846 696c 7465 723d  ltering (Filter=
-00005d50: 3d4e 6f6e 6529 0a20 2020 2020 2020 2052  =None).        R
-00005d60: 6574 7572 6e3a 0a20 2020 2020 2020 2020  eturn:.         
-00005d70: 2020 204e 6f72 6d61 6c20 7665 6374 6f72     Normal vector
-00005d80: 2073 636f 7265 2e0a 2020 2020 2020 2020   score..        
-00005d90: 5261 6973 6573 3a0a 2020 2020 2020 2020  Raises:.        
-00005da0: 2020 2020 7379 732e 6578 6974 3a20 496e      sys.exit: In
-00005db0: 7075 7420 6d61 7073 2064 6f20 6e6f 7420  put maps do not 
-00005dc0: 6d61 7463 6820 696e 2073 6861 7065 2c20  match in shape, 
-00005dd0: 7069 7865 6c20 7369 7a65 206f 7220 6f72  pixel size or or
-00005de0: 6967 696e 0a20 2020 2020 2020 2022 2222  igin.        """
-00005df0: 0a20 2020 2020 2020 2069 6620 4669 6c74  .        if Filt
-00005e00: 6572 206e 6f74 2069 6e20 5b27 536f 6265  er not in ['Sobe
-00005e10: 6c27 2c20 274c 6170 6c61 6365 272c 2027  l', 'Laplace', '
-00005e20: 4d65 616e 272c 2027 4d69 6e69 6d75 6d27  Mean', 'Minimum'
-00005e30: 2c20 4e6f 6e65 5d3a 0a20 2020 2020 2020  , None]:.       
-00005e40: 2020 2020 2070 7269 6e74 2827 496e 636f       print('Inco
-00005e50: 7272 6563 7420 6e61 6d65 206f 6620 6669  rrect name of fi
-00005e60: 6c74 6572 3a20 2573 2220 2520 4669 6c74  lter: %s" % Filt
-00005e70: 6572 2729 0a20 2020 2020 2020 2020 2020  er').           
-00005e80: 2070 7269 6e74 280a 2020 2020 2020 2020   print(.        
-00005e90: 2020 2020 2020 2020 2753 656c 6563 7420          'Select 
-00005ea0: 6f6e 6520 6f66 2074 6865 2066 6f6c 6c6f  one of the follo
-00005eb0: 7769 6e67 2046 696c 7465 7273 2069 6620  wing Filters if 
-00005ec0: 6170 706c 6963 6162 6c65 3a20 2573 5c6e  applicable: %s\n
-00005ed0: 2720 250a 2020 2020 2020 2020 2020 2020  ' %.            
-00005ee0: 2020 2020 272c 2027 2e6a 6f69 6e28 5b27      ', '.join(['
-00005ef0: 536f 6265 6c27 2c20 274c 6170 6c61 6365  Sobel', 'Laplace
-00005f00: 275d 290a 2020 2020 2020 2020 2020 2020  ']).            
-00005f10: 290a 2020 2020 2020 2020 2020 2020 7379  ).            sy
-00005f20: 732e 6578 6974 2829 0a0a 2020 2020 2020  s.exit()..      
-00005f30: 2020 7363 6f72 6573 203d 205b 5d0a 2020    scores = [].  
-00005f40: 2020 2020 2020 6966 206e 6f74 2073 656c        if not sel
-00005f50: 662e 6d61 7043 6f6d 7061 7269 736f 6e28  f.mapComparison(
-00005f60: 6d61 705f 7461 7267 6574 2c20 6d61 705f  map_target, map_
-00005f70: 7072 6f62 6529 3a0a 2020 2020 2020 2020  probe):.        
-00005f80: 2020 2020 7365 6c66 2e5f 6661 696c 6564      self._failed
-00005f90: 5f6d 6174 6368 2829 0a20 2020 2020 2020  _match().       
-00005fa0: 2061 7373 6572 7420 6973 696e 7374 616e   assert isinstan
-00005fb0: 6365 2870 7269 6d61 7279 5f62 6f75 6e64  ce(primary_bound
-00005fc0: 6172 792c 2066 6c6f 6174 290a 2020 2020  ary, float).    
-00005fd0: 2020 2020 6173 7365 7274 2069 7369 6e73      assert isins
-00005fe0: 7461 6e63 6528 7365 636f 6e64 6172 795f  tance(secondary_
-00005ff0: 626f 756e 6461 7279 2c20 666c 6f61 7429  boundary, float)
-00006000: 0a20 2020 2020 2020 2069 6620 7072 696d  .        if prim
-00006010: 6172 795f 626f 756e 6461 7279 203e 2073  ary_boundary > s
-00006020: 6563 6f6e 6461 7279 5f62 6f75 6e64 6172  econdary_boundar
-00006030: 793a 0a20 2020 2020 2020 2020 2020 2074  y:.            t
-00006040: 656d 705f 7468 7220 3d20 7365 636f 6e64  emp_thr = second
-00006050: 6172 795f 626f 756e 6461 7279 0a20 2020  ary_boundary.   
-00006060: 2020 2020 2020 2020 2073 6563 6f6e 6461           seconda
-00006070: 7279 5f62 6f75 6e64 6172 7920 3d20 7072  ry_boundary = pr
-00006080: 696d 6172 795f 626f 756e 6461 7279 0a20  imary_boundary. 
-00006090: 2020 2020 2020 2020 2020 2070 7269 6d61             prima
-000060a0: 7279 5f62 6f75 6e64 6172 7920 3d20 7465  ry_boundary = te
-000060b0: 6d70 5f74 6872 0a0a 2020 2020 2020 2020  mp_thr..        
-000060c0: 706f 696e 7473 203d 206e 702e 6172 6777  points = np.argw
-000060d0: 6865 7265 280a 2020 2020 2020 2020 2020  here(.          
-000060e0: 2020 286d 6170 5f74 6172 6765 742e 6675    (map_target.fu
-000060f0: 6c6c 4d61 7020 3e20 7072 696d 6172 795f  llMap > primary_
-00006100: 626f 756e 6461 7279 2920 260a 2020 2020  boundary) &.    
-00006110: 2020 2020 2020 2020 286d 6170 5f74 6172          (map_tar
-00006120: 6765 742e 6675 6c6c 4d61 7020 3c20 7365  get.fullMap < se
-00006130: 636f 6e64 6172 795f 626f 756e 6461 7279  condary_boundary
-00006140: 290a 2020 2020 2020 2020 290a 0a20 2020  ).        )..   
-00006150: 2020 2020 2069 6620 4669 6c74 6572 203d       if Filter =
-00006160: 3d20 2753 6f62 656c 273a 0a20 2020 2020  = 'Sobel':.     
-00006170: 2020 2020 2020 206d 6170 315f 7375 7266         map1_surf
-00006180: 6163 6520 3d20 6d61 705f 7461 7267 6574  ace = map_target
-00006190: 2e5f 736f 6265 6c5f 6669 6c74 6572 5f63  ._sobel_filter_c
-000061a0: 6f6e 746f 7572 2870 7269 6d61 7279 5f62  ontour(primary_b
-000061b0: 6f75 6e64 6172 7929 0a20 2020 2020 2020  oundary).       
-000061c0: 2020 2020 2070 6f69 6e74 7320 3d20 6e70       points = np
-000061d0: 2e61 7267 7768 6572 6528 0a20 2020 2020  .argwhere(.     
-000061e0: 2020 2020 2020 2020 2020 206d 6170 315f             map1_
-000061f0: 7375 7266 6163 652e 6675 6c6c 4d61 7020  surface.fullMap 
-00006200: 3e20 286d 6170 315f 7375 7266 6163 652e  > (map1_surface.
-00006210: 6d61 7828 2920 2f20 322e 3029 0a20 2020  max() / 2.0).   
-00006220: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
-00006230: 2020 2065 6c69 6620 4669 6c74 6572 203d     elif Filter =
-00006240: 3d20 274c 6170 6c61 6365 273a 0a20 2020  = 'Laplace':.   
-00006250: 2020 2020 2020 2020 206d 6170 315f 7375           map1_su
-00006260: 7266 6163 6520 3d20 6d61 705f 7461 7267  rface = map_targ
-00006270: 6574 2e5f 6c61 706c 6163 655f 6669 6c74  et._laplace_filt
-00006280: 6572 6564 5f63 6f6e 746f 7572 280a 2020  ered_contour(.  
-00006290: 2020 2020 2020 2020 2020 2020 2020 7072                pr
-000062a0: 696d 6172 795f 626f 756e 6461 7279 0a20  imary_boundary. 
-000062b0: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
-000062c0: 2020 2020 2020 2020 2070 6f69 6e74 7320           points 
-000062d0: 3d20 6e70 2e61 7267 7768 6572 6528 0a20  = np.argwhere(. 
-000062e0: 2020 2020 2020 2020 2020 2020 2020 206d                 m
-000062f0: 6170 315f 7375 7266 6163 652e 6675 6c6c  ap1_surface.full
-00006300: 4d61 7020 3e20 286d 6170 315f 7375 7266  Map > (map1_surf
-00006310: 6163 652e 6d61 7828 2920 2f20 322e 3029  ace.max() / 2.0)
-00006320: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
-00006330: 2020 2020 2020 2065 6c69 6620 4669 6c74         elif Filt
-00006340: 6572 203d 3d20 274d 696e 696d 756d 273a  er == 'Minimum':
-00006350: 0a20 2020 2020 2020 2020 2020 206d 6170  .            map
-00006360: 315f 7375 7266 6163 6520 3d20 6d61 705f  1_surface = map_
-00006370: 7461 7267 6574 2e5f 7375 7266 6163 655f  target._surface_
-00006380: 6d69 6e69 6d75 6d5f 6669 6c74 6572 280a  minimum_filter(.
-00006390: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000063a0: 666c 6f61 7428 7072 696d 6172 795f 626f  float(primary_bo
-000063b0: 756e 6461 7279 290a 2020 2020 2020 2020  undary).        
-000063c0: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
-000063d0: 2020 706f 696e 7473 203d 206e 702e 6172    points = np.ar
-000063e0: 6777 6865 7265 286d 6170 315f 7375 7266  gwhere(map1_surf
-000063f0: 6163 6520 3d3d 2031 290a 2020 2020 2020  ace == 1).      
-00006400: 2020 656c 6966 2046 696c 7465 7220 3d3d    elif Filter ==
-00006410: 2027 4d65 616e 273a 0a20 2020 2020 2020   'Mean':.       
-00006420: 2020 2020 206d 6170 315f 6669 6c74 6572       map1_filter
-00006430: 203d 206d 6170 5f74 6172 6765 742e 5f73   = map_target._s
-00006440: 7572 6661 6365 5f66 6561 7475 7265 7328  urface_features(
-00006450: 666c 6f61 7428 7072 696d 6172 795f 626f  float(primary_bo
-00006460: 756e 6461 7279 2929 0a20 2020 2020 2020  undary)).       
-00006470: 2020 2020 2062 696e 5f74 6573 7420 3d20       bin_test = 
-00006480: 5b30 2e30 3030 315d 0a20 2020 2020 2020  [0.0001].       
-00006490: 2020 2020 2066 6f72 2069 6920 696e 2072       for ii in r
-000064a0: 616e 6765 2831 2c20 3431 293a 0a20 2020  ange(1, 41):.   
-000064b0: 2020 2020 2020 2020 2020 2020 2062 696e               bin
-000064c0: 5f74 6573 742e 6170 7065 6e64 2830 2e30  _test.append(0.0
-000064d0: 3235 202a 2069 6929 0a20 2020 2020 2020  25 * ii).       
-000064e0: 2020 2020 2066 7265 715f 7465 7374 203d       freq_test =
-000064f0: 206e 702e 6869 7374 6f67 7261 6d28 6d61   np.histogram(ma
-00006500: 7031 5f66 696c 7465 722e 6675 6c6c 4d61  p1_filter.fullMa
-00006510: 702c 2062 696e 5f74 6573 7429 5b30 5d0a  p, bin_test)[0].
-00006520: 2020 2020 2020 2020 2020 2020 7375 6d5f              sum_
-00006530: 6672 6571 203d 2030 2e30 0a20 2020 2020  freq = 0.0.     
-00006540: 2020 2020 2020 2066 6f72 2066 7220 696e         for fr in
-00006550: 2072 616e 6765 286c 656e 2866 7265 715f   range(len(freq_
-00006560: 7465 7374 2929 3a0a 2020 2020 2020 2020  test)):.        
-00006570: 2020 2020 2020 2020 7375 6d5f 6672 6571          sum_freq
-00006580: 202b 3d20 666c 6f61 7428 6672 6571 5f74   += float(freq_t
-00006590: 6573 745b 6672 5d29 0a20 2020 2020 2020  est[fr]).       
-000065a0: 2020 2020 2020 2020 2069 6620 280a 2020           if (.  
-000065b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000065c0: 2020 2020 2020 7375 6d5f 6672 6571 202f        sum_freq /
-000065d0: 206e 702e 7375 6d28 6672 6571 5f74 6573   np.sum(freq_tes
-000065e0: 7429 203e 2030 2e30 3520 616e 640a 2020  t) > 0.05 and.  
-000065f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006600: 2020 2020 2020 6269 6e5f 7465 7374 5b66        bin_test[f
-00006610: 722b 315d 203e 3d20 302e 330a 2020 2020  r+1] >= 0.3.    
-00006620: 2020 2020 2020 2020 2020 2020 293a 0a20              ):. 
-00006630: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006640: 2020 2074 3120 3d20 6269 6e5f 7465 7374     t1 = bin_test
-00006650: 5b66 722b 315d 0a20 2020 2020 2020 2020  [fr+1].         
-00006660: 2020 2020 2020 2020 2020 2062 7265 616b             break
-00006670: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00006680: 2069 6620 280a 2020 2020 2020 2020 2020   if (.          
-00006690: 2020 2020 2020 2020 2020 2020 2020 7375                su
-000066a0: 6d5f 6672 6571 202f 206e 702e 6e75 6d73  m_freq / np.nums
-000066b0: 756d 2866 7265 715f 7465 7374 2920 3e20  um(freq_test) > 
-000066c0: 302e 3130 206f 720a 2020 2020 2020 2020  0.10 or.        
-000066d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000066e0: 7375 6d5f 6672 6571 203e 2031 3030 3030  sum_freq > 10000
-000066f0: 300a 2020 2020 2020 2020 2020 2020 2020  0.              
-00006700: 2020 293a 0a20 2020 2020 2020 2020 2020    ):.           
-00006710: 2020 2020 2020 2020 2074 3120 3d20 6269           t1 = bi
-00006720: 6e5f 7465 7374 5b66 722b 315d 0a20 2020  n_test[fr+1].   
-00006730: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006740: 2062 7265 616b 0a20 2020 2020 2020 2020   break.         
-00006750: 2020 2070 6f69 6e74 7320 3d20 6e70 2e61     points = np.a
-00006760: 7267 7768 6572 6528 0a20 2020 2020 2020  rgwhere(.       
-00006770: 2020 2020 2020 2020 2028 6d61 7031 5f66           (map1_f
-00006780: 696c 7465 722e 6675 6c6c 4d61 7020 3e20  ilter.fullMap > 
-00006790: 302e 3029 2026 2028 6d61 7031 5f66 696c  0.0) & (map1_fil
-000067a0: 7465 722e 6675 6c6c 4d61 7020 3c20 7431  ter.fullMap < t1
-000067b0: 290a 2020 2020 2020 2020 2020 2020 290a  ).            ).
-000067c0: 2020 2020 2020 2020 2320 432b 2b20 6361          # C++ ca
-000067d0: 6c63 756c 6174 696f 6e0a 2020 2020 2020  lculation.      
-000067e0: 2020 666c 6167 6320 3d20 310a 2020 2020    flagc = 1.    
-000067f0: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
-00006800: 2020 2020 2076 6563 6e6f 726d 5f74 6172       vecnorm_tar
-00006810: 6765 7420 3d20 6d61 705f 7461 7267 6574  get = map_target
-00006820: 2e5f 6765 745f 6e6f 726d 616c 5f76 6563  ._get_normal_vec
-00006830: 746f 7228 706f 696e 7473 290a 2020 2020  tor(points).    
-00006840: 2020 2020 2020 2020 7665 636e 6f72 6d5f          vecnorm_
-00006850: 7072 6f62 6520 3d20 6d61 705f 7072 6f62  probe = map_prob
-00006860: 652e 5f67 6574 5f6e 6f72 6d61 6c5f 7665  e._get_normal_ve
-00006870: 6374 6f72 2870 6f69 6e74 7329 0a20 2020  ctor(points).   
-00006880: 2020 2020 2065 7863 6570 7420 4578 6365       except Exce
-00006890: 7074 696f 6e3a 0a20 2020 2020 2020 2020  ption:.         
-000068a0: 2020 2066 6c61 6763 203d 2030 0a20 2020     flagc = 0.   
-000068b0: 2020 2020 2069 6620 7665 636e 6f72 6d5f       if vecnorm_
-000068c0: 7461 7267 6574 2069 7320 4e6f 6e65 206f  target is None o
-000068d0: 7220 7665 636e 6f72 6d5f 7072 6f62 6520  r vecnorm_probe 
-000068e0: 6973 204e 6f6e 653a 0a20 2020 2020 2020  is None:.       
-000068f0: 2020 2020 2066 6c61 6763 203d 2030 0a20       flagc = 0. 
-00006900: 2020 2020 2020 2063 7420 3d20 300a 0a20         ct = 0.. 
-00006910: 2020 2020 2020 2069 6620 666c 6167 6320         if flagc 
-00006920: 3d3d 2031 3a0a 2020 2020 2020 2020 2020  == 1:.          
-00006930: 2020 666f 7220 6920 696e 2072 616e 6765    for i in range
-00006940: 286c 656e 2876 6563 6e6f 726d 5f74 6172  (len(vecnorm_tar
-00006950: 6765 7429 293a 0a20 2020 2020 2020 2020  get)):.         
-00006960: 2020 2020 2020 2063 7420 2b3d 2031 0a20         ct += 1. 
-00006970: 2020 2020 2020 2020 2020 2020 2020 206e                 n
-00006980: 7665 6320 3d20 7665 636e 6f72 6d5f 7461  vec = vecnorm_ta
-00006990: 7267 6574 5b69 5d0a 2020 2020 2020 2020  rget[i].        
-000069a0: 2020 2020 2020 2020 6f76 6563 203d 2076          ovec = v
-000069b0: 6563 6e6f 726d 5f70 726f 6265 5b69 5d0a  ecnorm_probe[i].
-000069c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000069d0: 2320 6164 6420 6d61 7820 7661 6c75 6520  # add max value 
-000069e0: 666f 7220 7265 6769 6f6e 7320 6f66 206e  for regions of n
-000069f0: 756c 6c20 7661 7269 6174 696f 6e0a 2020  ull variation.  
-00006a00: 2020 2020 2020 2020 2020 2020 2020 6966                if
-00006a10: 2028 0a20 2020 2020 2020 2020 2020 2020   (.             
-00006a20: 2020 2020 2020 2020 2020 206e 7665 635b             nvec[
-00006a30: 305d 203d 3d20 302e 2061 6e64 0a20 2020  0] == 0. and.   
-00006a40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006a50: 2020 2020 206e 7665 635b 315d 203d 3d20       nvec[1] == 
-00006a60: 302e 2061 6e64 0a20 2020 2020 2020 2020  0. and.         
-00006a70: 2020 2020 2020 2020 2020 2020 2020 206e                 n
-00006a80: 7665 635b 325d 203d 3d20 302e 0a20 2020  vec[2] == 0..   
-00006a90: 2020 2020 2020 2020 2020 2020 2029 3a0a               ):.
-00006aa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006ab0: 2020 2020 6966 2028 0a20 2020 2020 2020      if (.       
-00006ac0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006ad0: 2020 2020 206f 7665 635b 305d 203d 3d20       ovec[0] == 
-00006ae0: 302e 2061 6e64 0a20 2020 2020 2020 2020  0. and.         
-00006af0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006b00: 2020 206f 7665 635b 315d 203d 3d20 302e     ovec[1] == 0.
-00006b10: 2061 6e64 0a20 2020 2020 2020 2020 2020   and.           
-00006b20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006b30: 206f 7665 635b 325d 203d 3d20 302e 300a   ovec[2] == 0.0.
-00006b40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006b50: 2020 2020 293a 0a20 2020 2020 2020 2020      ):.         
-00006b60: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-00006b70: 6f6e 7469 6e75 650a 2020 2020 2020 2020  ontinue.        
-00006b80: 2020 2020 2020 2020 2020 2020 656c 7365              else
-00006b90: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00006ba0: 2020 2020 2020 2020 2020 7363 6f72 6573            scores
-00006bb0: 2e61 7070 656e 6428 332e 3134 290a 2020  .append(3.14).  
-00006bc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006bd0: 2020 2020 2020 636f 6e74 696e 7565 0a20        continue. 
-00006be0: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-00006bf0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-00006c00: 2020 2020 2020 2020 2069 6620 280a 2020           if (.  
-00006c10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006c20: 2020 2020 2020 2020 2020 6f76 6563 5b30            ovec[0
-00006c30: 5d20 3d3d 2030 2e20 616e 640a 2020 2020  ] == 0. and.    
-00006c40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006c50: 2020 2020 2020 2020 6f76 6563 5b31 5d20          ovec[1] 
-00006c60: 3d3d 2030 2e20 616e 640a 2020 2020 2020  == 0. and.      
-00006c70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006c80: 2020 2020 2020 6f76 6563 5b32 5d20 3d3d        ovec[2] ==
-00006c90: 2030 2e0a 2020 2020 2020 2020 2020 2020   0..            
-00006ca0: 2020 2020 2020 2020 293a 0a20 2020 2020          ):.     
-00006cb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006cc0: 2020 2073 636f 7265 732e 6170 7065 6e64     scores.append
-00006cd0: 2833 2e31 3429 0a20 2020 2020 2020 2020  (3.14).         
-00006ce0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-00006cf0: 6f6e 7469 6e75 650a 2020 2020 2020 2020  ontinue.        
-00006d00: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
-00006d10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006d20: 2064 6f74 7072 6f64 203d 2028 0a20 2020   dotprod = (.   
+00004ba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004bb0: 2020 2029 202a 0a20 2020 2020 2020 2020     ) *.         
+00004bc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004bd0: 2020 2020 2020 2020 2020 206e 702e 7375             np.su
+00004be0: 6d28 0a20 2020 2020 2020 2020 2020 2020  m(.             
+00004bf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004c00: 2020 2020 2020 2020 2020 206e 702e 7371             np.sq
+00004c10: 7561 7265 280a 2020 2020 2020 2020 2020  uare(.          
+00004c20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004c30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004c40: 2020 6d61 705f 7072 6f62 652e 6675 6c6c    map_probe.full
+00004c50: 4d61 7020 2d0a 2020 2020 2020 2020 2020  Map -.          
+00004c60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004c70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004c80: 2020 6e70 2e6d 6561 6e28 6d61 705f 7072    np.mean(map_pr
+00004c90: 6f62 652e 6675 6c6c 4d61 7029 0a20 2020  obe.fullMap).   
+00004ca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004cb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004cc0: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
+00004cd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004ce0: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
+00004cf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004d00: 2020 2020 2020 2020 2020 2020 2029 0a20               ). 
+00004d10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004d20: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
+00004d30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004d40: 2020 2020 2029 2c0a 2020 2020 2020 2020       ),.        
+00004d50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004d60: 7065 7263 5f6f 7672 0a20 2020 2020 2020  perc_ovr.       
+00004d70: 2020 2020 2020 2020 2020 2020 2029 0a20               ). 
+00004d80: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+00004d90: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+00004da0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+00004db0: 636f 7272 2c20 7065 7263 5f6f 7672 0a20  corr, perc_ovr. 
+00004dc0: 2020 2020 2020 2020 2020 2069 6620 636d             if cm
+00004dd0: 6f64 653a 0a20 2020 2020 2020 2020 2020  ode:.           
+00004de0: 2020 2020 2063 6f72 7220 3d20 7365 6c66       corr = self
+00004df0: 2e5f 4343 435f 6361 6c63 286d 6170 5f74  ._CCC_calc(map_t
+00004e00: 6172 6765 742e 6675 6c6c 4d61 702c 206d  arget.fullMap, m
+00004e10: 6170 5f70 726f 6265 2e66 756c 6c4d 6170  ap_probe.fullMap
+00004e20: 290a 2020 2020 2020 2020 2020 2020 656c  ).            el
+00004e30: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+00004e40: 2020 2020 636f 7272 203d 204e 6f6e 650a      corr = None.
+00004e50: 2020 2020 2020 2020 2020 2020 6966 2063              if c
+00004e60: 6f72 7220 6973 204e 6f6e 653a 0a20 2020  orr is None:.   
+00004e70: 2020 2020 2020 2020 2020 2020 2072 6574               ret
+00004e80: 7572 6e20 280a 2020 2020 2020 2020 2020  urn (.          
+00004e90: 2020 2020 2020 2020 2020 6e70 2e73 756d            np.sum
+00004ea0: 286d 6170 5f74 6172 6765 742e 6675 6c6c  (map_target.full
+00004eb0: 4d61 7020 2a20 6d61 705f 7072 6f62 652e  Map * map_probe.
+00004ec0: 6675 6c6c 4d61 7029 202f 0a20 2020 2020  fullMap) /.     
+00004ed0: 2020 2020 2020 2020 2020 2020 2020 206e                 n
+00004ee0: 702e 7371 7274 280a 2020 2020 2020 2020  p.sqrt(.        
+00004ef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004f00: 6e70 2e73 756d 286e 702e 7371 7561 7265  np.sum(np.square
+00004f10: 286d 6170 5f74 6172 6765 742e 6675 6c6c  (map_target.full
+00004f20: 4d61 7029 2920 2a0a 2020 2020 2020 2020  Map)) *.        
+00004f30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004f40: 6e70 2e73 756d 286e 702e 7371 7561 7265  np.sum(np.square
+00004f50: 286d 6170 5f70 726f 6265 2e66 756c 6c4d  (map_probe.fullM
+00004f60: 6170 2929 0a20 2020 2020 2020 2020 2020  ap)).           
+00004f70: 2020 2020 2020 2020 2029 2c0a 2020 2020           ),.    
+00004f80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004f90: 7065 7263 5f6f 7672 0a20 2020 2020 2020  perc_ovr.       
+00004fa0: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
+00004fb0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+00004fc0: 2020 2020 2020 2020 2020 2020 2072 6574               ret
+00004fd0: 7572 6e20 636f 7272 2c20 7065 7263 5f6f  urn corr, perc_o
+00004fe0: 7672 0a20 2020 2020 2020 2065 6c73 653a  vr.        else:
+00004ff0: 0a20 2020 2020 2020 2020 2020 2070 7269  .            pri
+00005000: 6e74 2827 4040 4020 4d61 7073 2063 6f75  nt('@@@ Maps cou
+00005010: 6c64 206e 6f74 2062 6520 6d61 7463 6865  ld not be matche
+00005020: 6427 290a 2020 2020 2020 2020 2020 2020  d').            
+00005030: 7265 7475 726e 202d 312e 2c20 302e 0a0a  return -1., 0...
+00005040: 2020 2020 6465 6620 4343 4328 7365 6c66      def CCC(self
+00005050: 2c20 6d61 705f 7461 7267 6574 2c20 6d61  , map_target, ma
+00005060: 705f 7072 6f62 6529 3a0a 2020 2020 2020  p_probe):.      
+00005070: 2020 2222 2243 616c 6375 6c61 7465 2063    """Calculate c
+00005080: 726f 7373 2d63 6f72 7265 6c61 7469 6f6e  ross-correlation
+00005090: 2062 6574 7765 656e 2074 776f 204d 6170   between two Map
+000050a0: 2069 6e73 7461 6e63 6573 2e0a 0a20 2020   instances...   
+000050b0: 2020 2020 2041 7267 733a 0a20 2020 2020       Args:.     
+000050c0: 2020 2020 2020 206d 6170 5f74 6172 6765         map_targe
+000050d0: 742c 206d 6170 5f70 726f 6265 0a20 2020  t, map_probe.   
+000050e0: 2020 2020 2020 2020 2020 2020 204d 6170               Map
+000050f0: 2069 6e73 7461 6e63 6520 746f 2063 6f6d   instance to com
+00005100: 7061 7265 2e0a 2020 2020 2020 2020 5265  pare..        Re
+00005110: 7475 726e 733a 0a20 2020 2020 2020 2020  turns:.         
+00005120: 2020 2043 4343 2073 636f 7265 0a20 2020     CCC score.   
+00005130: 2020 2020 2052 6169 7365 733a 0a20 2020       Raises:.   
+00005140: 2020 2020 2020 2020 2073 7973 2e65 7869           sys.exi
+00005150: 743a 2049 6e70 7574 206d 6170 7320 646f  t: Input maps do
+00005160: 206e 6f74 206d 6174 6368 2069 6e20 7368   not match in sh
+00005170: 6170 652c 2070 6978 656c 2073 697a 6520  ape, pixel size 
+00005180: 6f72 206f 7269 6769 6e0a 2020 2020 2020  or origin.      
+00005190: 2020 2222 220a 2020 2020 2020 2020 6966    """.        if
+000051a0: 2073 656c 662e 6d61 7043 6f6d 7061 7269   self.mapCompari
+000051b0: 736f 6e28 6d61 705f 7461 7267 6574 2c20  son(map_target, 
+000051c0: 6d61 705f 7072 6f62 6529 3a0a 2020 2020  map_probe):.    
+000051d0: 2020 2020 2020 2020 7265 7475 726e 2028          return (
+000051e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000051f0: 206d 6170 5f74 6172 6765 742e 6e6f 726d   map_target.norm
+00005200: 616c 6973 6528 292e 6765 744d 6170 2829  alise().getMap()
+00005210: 2a6d 6170 5f70 726f 6265 2e6e 6f72 6d61  *map_probe.norma
+00005220: 6c69 7365 2829 2e67 6574 4d61 7028 290a  lise().getMap().
+00005230: 2020 2020 2020 2020 2020 2020 292e 6d65              ).me
+00005240: 616e 2829 0a20 2020 2020 2020 2065 6c73  an().        els
+00005250: 653a 0a20 2020 2020 2020 2020 2020 2073  e:.            s
+00005260: 656c 662e 5f66 6169 6c65 645f 6d61 7463  elf._failed_matc
+00005270: 6828 290a 0a20 2020 2064 6566 204c 5346  h()..    def LSF
+00005280: 2873 656c 662c 206d 6170 5f74 6172 6765  (self, map_targe
+00005290: 742c 206d 6170 5f70 726f 6265 293a 0a20  t, map_probe):. 
+000052a0: 2020 2020 2020 2022 2222 4361 6c63 756c         """Calcul
+000052b0: 6174 6520 6c65 6173 742d 7371 7561 7265  ate least-square
+000052c0: 7320 6265 7477 6565 6e20 7477 6f20 4d61  s between two Ma
+000052d0: 7020 696e 7374 616e 6365 732e 0a0a 2020  p instances...  
+000052e0: 2020 2020 2020 4172 6775 6d65 6e74 733a        Arguments:
+000052f0: 0a20 2020 2020 2020 2020 2020 206d 6170  .            map
+00005300: 5f74 6172 6765 742c 206d 6170 5f70 726f  _target, map_pro
+00005310: 6265 3a20 4d61 7020 696e 7374 616e 6365  be: Map instance
+00005320: 2074 6f20 636f 6d70 6172 652e 0a20 2020   to compare..   
+00005330: 2020 2020 2052 6574 7572 6e3a 0a20 2020       Return:.   
+00005340: 2020 2020 2020 2020 204c 6561 7374 2d73           Least-s
+00005350: 7175 6172 6573 2076 616c 7565 0a20 2020  quares value.   
+00005360: 2020 2020 2052 6169 7365 733a 0a20 2020       Raises:.   
+00005370: 2020 2020 2020 2020 2073 7973 2e65 7869           sys.exi
+00005380: 743a 2049 6e70 7574 206d 6170 7320 646f  t: Input maps do
+00005390: 206e 6f74 206d 6174 6368 2069 6e20 7368   not match in sh
+000053a0: 6170 652c 2070 6978 656c 2073 697a 6520  ape, pixel size 
+000053b0: 6f72 206f 7269 6769 6e0a 2020 2020 2020  or origin.      
+000053c0: 2020 2222 220a 2020 2020 2020 2020 6966    """.        if
+000053d0: 2073 656c 662e 6d61 7043 6f6d 7061 7269   self.mapCompari
+000053e0: 736f 6e28 6d61 705f 7461 7267 6574 2c20  son(map_target, 
+000053f0: 6d61 705f 7072 6f62 6529 3a0a 2020 2020  map_probe):.    
+00005400: 2020 2020 2020 2020 6d61 705f 7461 7267          map_targ
+00005410: 6574 2c20 6d61 705f 7072 6f62 6520 3d20  et, map_probe = 
+00005420: 6d61 705f 7461 7267 6574 2c20 6d61 705f  map_target, map_
+00005430: 7072 6f62 650a 2020 2020 2020 2020 656c  probe.        el
+00005440: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+00005450: 7365 6c66 2e5f 6661 696c 6564 5f6d 6174  self._failed_mat
+00005460: 6368 2829 0a20 2020 2020 2020 2072 6574  ch().        ret
+00005470: 7572 6e20 2828 6d61 705f 7461 7267 6574  urn ((map_target
+00005480: 2e67 6574 4d61 7028 2920 2d20 6d61 705f  .getMap() - map_
+00005490: 7072 6f62 652e 6765 744d 6170 2829 292a  probe.getMap())*
+000054a0: 2a32 292e 6d65 616e 2829 0a0a 2020 2020  *2).mean()..    
+000054b0: 6465 6620 6c61 706c 6163 655f 4343 4328  def laplace_CCC(
+000054c0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+000054d0: 662c 0a20 2020 2020 2020 2020 2020 206d  f,.            m
+000054e0: 6170 5f74 6172 6765 742c 0a20 2020 2020  ap_target,.     
+000054f0: 2020 2020 2020 206d 6170 5f70 726f 6265         map_probe
+00005500: 2c0a 2020 2020 2020 2020 2020 2020 7072  ,.            pr
+00005510: 6566 696c 3d28 4661 6c73 652c 2046 616c  efil=(False, Fal
+00005520: 7365 290a 2020 2020 293a 0a20 2020 2020  se).    ):.     
+00005530: 2020 2022 2222 4361 6c63 756c 6174 6520     """Calculate 
+00005540: 4343 4320 6265 7477 6565 6e20 7477 6f20  CCC between two 
+00005550: 6c61 706c 6163 6961 6e20 6669 6c74 6572  laplacian filter
+00005560: 6564 204d 6170 2069 6e73 7461 6e63 6573  ed Map instances
+00005570: 2e0a 0a20 2020 2020 2020 2054 6865 206c  ...        The l
+00005580: 6170 6c61 6369 616e 2066 696c 7465 7220  aplacian filter 
+00005590: 6973 2061 6e20 6564 6765 2064 6574 6563  is an edge detec
+000055a0: 7469 6f6e 2066 696c 7465 722c 2077 6869  tion filter, whi
+000055b0: 6368 2063 6f6d 7075 7465 7320 7468 650a  ch computes the.
+000055c0: 2020 2020 2020 2020 7365 636f 6e64 2064          second d
+000055d0: 6572 7669 6174 6976 6573 206f 6620 616e  erviatives of an
+000055e0: 2069 6d61 6765 2f76 6f6c 756d 652e 2055   image/volume. U
+000055f0: 7369 6e67 204c 6170 6c61 6369 616e 2066  sing Laplacian f
+00005600: 696c 7465 7273 2069 6e0a 2020 2020 2020  ilters in.      
+00005610: 2020 636f 6d62 696e 6174 696f 6e20 7769    combination wi
+00005620: 7468 2043 4343 2073 636f 7269 6e67 206f  th CCC scoring o
+00005630: 6620 6372 796f 2045 4d20 6d6f 6465 6c73  f cryo EM models
+00005640: 2020 7761 7320 7368 6f77 6e20 746f 2062    was shown to b
+00005650: 6520 6d6f 7265 0a20 2020 2020 2020 2061  e more.        a
+00005660: 6363 7572 6174 6520 7468 616e 2043 4343  ccurate than CCC
+00005670: 2073 636f 7269 6e67 2061 6c6f 6e65 2066   scoring alone f
+00005680: 6f72 206c 6f77 2072 6573 6f6c 7574 696f  or low resolutio
+00005690: 6e20 6d61 7073 2c20 696e 0a20 2020 2020  n maps, in.     
+000056a0: 2020 2060 2843 6861 636f 6e20 616e 6420     `(Chacon and 
+000056b0: 5772 6967 6765 7273 2c20 3230 3032 2920  Wriggers, 2002) 
+000056c0: 3c68 7474 7073 3a2f 2f70 7562 6d65 642e  <https://pubmed.
+000056d0: 6e63 6269 2e6e 6c6d 2e6e 6968 2e67 6f76  ncbi.nlm.nih.gov
+000056e0: 2f31 3139 3232 3637 312f 3e60 5f0a 0a20  /11922671/>`_.. 
+000056f0: 2020 2020 2020 2041 7267 756d 656e 7473         Arguments
+00005700: 3a0a 2020 2020 2020 2020 2020 2020 6d61  :.            ma
+00005710: 705f 7461 7267 6574 2c20 6d61 705f 7072  p_target, map_pr
+00005720: 6f62 653a 204d 6170 2069 6e73 7461 6e63  obe: Map instanc
+00005730: 6573 2074 6f20 636f 6d70 6172 652e 0a0a  es to compare...
+00005740: 2020 2020 2020 2020 2020 2020 7072 6566              pref
+00005750: 696c 3a20 322d 7475 706c 6520 6f66 2062  il: 2-tuple of b
+00005760: 6f6f 6c65 616e 2076 616c 7565 732c 206f  oolean values, o
+00005770: 6e65 2066 6f72 2065 6163 6820 6d61 7020  ne for each map 
+00005780: 7265 7370 6563 7469 7665 6c79 2e0a 2020  respectively..  
+00005790: 2020 2020 2020 2020 2020 2020 2020 5472                Tr
+000057a0: 7565 2069 6620 4d61 7020 696e 7374 616e  ue if Map instan
+000057b0: 6365 2069 7320 616c 7265 6164 7920 4c61  ce is already La
+000057c0: 706c 6163 6961 6e2d 6669 6c74 6572 6564  placian-filtered
+000057d0: 2e20 4661 6c73 650a 2020 2020 2020 2020  . False.        
+000057e0: 2020 2020 2020 2020 6f74 6865 7277 6973          otherwis
+000057f0: 652e 0a20 2020 2020 2020 2052 6574 7572  e..        Retur
+00005800: 6e3a 0a20 2020 2020 2020 2020 2020 204c  n:.            L
+00005810: 6170 6c61 6369 616e 2063 726f 7373 2d63  aplacian cross-c
+00005820: 6f72 7265 6c61 7469 6f6e 2073 636f 7265  orrelation score
+00005830: 0a20 2020 2020 2020 2052 6169 7365 733a  .        Raises:
+00005840: 0a20 2020 2020 2020 2020 2020 2073 7973  .            sys
+00005850: 2e65 7869 743a 2049 6e70 7574 206d 6170  .exit: Input map
+00005860: 7320 646f 206e 6f74 206d 6174 6368 2069  s do not match i
+00005870: 6e20 7368 6170 652c 2070 6978 656c 2073  n shape, pixel s
+00005880: 697a 6520 6f72 206f 7269 6769 6e0a 2020  ize or origin.  
+00005890: 2020 2020 2020 2222 220a 0a20 2020 2020        """..     
+000058a0: 2020 2069 6620 7365 6c66 2e6d 6170 436f     if self.mapCo
+000058b0: 6d70 6172 6973 6f6e 286d 6170 5f74 6172  mparison(map_tar
+000058c0: 6765 742c 206d 6170 5f70 726f 6265 293a  get, map_probe):
+000058d0: 0a20 2020 2020 2020 2020 2020 2023 2049  .            # I
+000058e0: 2064 6f6e 2774 2075 6e64 6572 7374 616e   don't understan
+000058f0: 6420 7468 6973 202d 2063 616e 2077 6520  d this - can we 
+00005900: 7265 706c 6163 6520 6974 2077 6974 6820  replace it with 
+00005910: 7061 7373 3f0a 2020 2020 2020 2020 2020  pass?.          
+00005920: 2020 5f2c 205f 203d 206d 6170 5f74 6172    _, _ = map_tar
+00005930: 6765 742c 206d 6170 5f70 726f 6265 2020  get, map_probe  
+00005940: 2320 6e6f 7161 3a46 3834 310a 2020 2020  # noqa:F841.    
+00005950: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00005960: 2020 2020 2020 7365 6c66 2e5f 6661 696c        self._fail
+00005970: 6564 5f6d 6174 6368 2829 0a0a 2020 2020  ed_match()..    
+00005980: 2020 2020 6966 206e 6f74 2070 7265 6669      if not prefi
+00005990: 6c5b 305d 3a0a 2020 2020 2020 2020 2020  l[0]:.          
+000059a0: 2020 6d61 705f 7461 7267 6574 203d 206d    map_target = m
+000059b0: 6170 5f74 6172 6765 742e 6c61 706c 6163  ap_target.laplac
+000059c0: 655f 6669 6c74 6572 6564 2829 0a20 2020  e_filtered().   
+000059d0: 2020 2020 2069 6620 6e6f 7420 7072 6566       if not pref
+000059e0: 696c 5b31 5d3a 0a20 2020 2020 2020 2020  il[1]:.         
+000059f0: 2020 206d 6170 5f70 726f 6265 203d 206d     map_probe = m
+00005a00: 6170 5f70 726f 6265 2e6c 6170 6c61 6365  ap_probe.laplace
+00005a10: 5f66 696c 7465 7265 6428 290a 2020 2020  _filtered().    
+00005a20: 2020 2020 6d61 705f 7461 7267 6574 203d      map_target =
+00005a30: 206d 6170 5f74 6172 6765 742e 6e6f 726d   map_target.norm
+00005a40: 616c 6973 6528 290a 2020 2020 2020 2020  alise().        
+00005a50: 6d61 705f 7072 6f62 6520 3d20 6d61 705f  map_probe = map_
+00005a60: 7072 6f62 652e 6e6f 726d 616c 6973 6528  probe.normalise(
+00005a70: 290a 2020 2020 2020 2020 7265 7475 726e  ).        return
+00005a80: 2073 656c 662e 4343 4328 6d61 705f 7461   self.CCC(map_ta
+00005a90: 7267 6574 2c20 6d61 705f 7072 6f62 6529  rget, map_probe)
+00005aa0: 0a0a 2020 2020 6465 6620 6e6f 726d 616c  ..    def normal
+00005ab0: 5f76 6563 746f 725f 7363 6f72 6528 0a20  _vector_score(. 
+00005ac0: 2020 2020 2020 2020 2020 2073 656c 662c             self,
+00005ad0: 0a20 2020 2020 2020 2020 2020 206d 6170  .            map
+00005ae0: 5f74 6172 6765 742c 0a20 2020 2020 2020  _target,.       
+00005af0: 2020 2020 206d 6170 5f70 726f 6265 2c0a       map_probe,.
+00005b00: 2020 2020 2020 2020 2020 2020 7072 696d              prim
+00005b10: 6172 795f 626f 756e 6461 7279 2c0a 2020  ary_boundary,.  
+00005b20: 2020 2020 2020 2020 2020 7365 636f 6e64            second
+00005b30: 6172 795f 626f 756e 6461 7279 3d30 2e30  ary_boundary=0.0
+00005b40: 2c0a 2020 2020 2020 2020 2020 2020 4669  ,.            Fi
+00005b50: 6c74 6572 3d4e 6f6e 652c 0a20 2020 2029  lter=None,.    )
+00005b60: 3a0a 2020 2020 2020 2020 2222 2243 616c  :.        """Cal
+00005b70: 6375 6c61 7465 2074 6865 204e 6f72 6d61  culate the Norma
+00005b80: 6c20 5665 6374 6f72 2053 636f 7265 2062  l Vector Score b
+00005b90: 6574 7765 656e 2074 776f 204d 6170 2073  etween two Map s
+00005ba0: 7572 6661 6365 732e 0a0a 2020 2020 2020  urfaces...      
+00005bb0: 2020 4261 7365 6420 6f6e 2033 534f 4d20    Based on 3SOM 
+00005bc0: 616c 676f 7269 7468 6d20 2843 6575 6c65  algorithm (Ceule
+00005bd0: 6d61 6e73 2061 6e64 2052 7573 7365 6c6c  mans and Russell
+00005be0: 2c20 3230 3034 292e 0a0a 2020 2020 2020  , 2004)...      
+00005bf0: 2020 4172 6775 6d65 6e74 733a 0a20 2020    Arguments:.   
+00005c00: 2020 2020 2020 2020 206d 6170 5f74 6172           map_tar
+00005c10: 6765 742c 206d 6170 5f70 726f 6265 3a0a  get, map_probe:.
+00005c20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005c30: 4d61 7020 696e 7374 616e 6365 7320 746f  Map instances to
+00005c40: 2063 6f6d 7061 7265 2e0a 2020 2020 2020   compare..      
+00005c50: 2020 2020 2020 7072 696d 6172 795f 626f        primary_bo
+00005c60: 756e 6461 7279 2c20 7365 636f 6e64 6172  undary, secondar
+00005c70: 795f 626f 756e 6461 7279 3a0a 2020 2020  y_boundary:.    
+00005c80: 2020 2020 2020 2020 2020 2020 4966 2061              If a
+00005c90: 2066 696c 7465 7220 6973 2073 656c 6563   filter is selec
+00005ca0: 7465 642c 206a 7573 7420 696e 7075 7420  ted, just input 
+00005cb0: 6120 636f 6e74 6f75 7220 6c65 7665 6c20  a contour level 
+00005cc0: 6173 2070 7269 6d61 7279 0a20 2020 2020  as primary.     
+00005cd0: 2020 2020 2020 2020 2020 2074 6872 6573             thres
+00005ce0: 686f 6c64 2e20 4f74 6865 7277 6973 652c  hold. Otherwise,
+00005cf0: 206e 6565 6420 746f 2072 756e 2067 6574   need to run get
+00005d00: 5f70 7269 6d61 7279 5f62 6f75 6e64 6172  _primary_boundar
+00005d10: 7920 616e 640a 2020 2020 2020 2020 2020  y and.          
+00005d20: 2020 2020 2020 6765 745f 7365 636f 6e64        get_second
+00005d30: 5f62 6f75 6e64 6172 7920 6261 7365 6420  _boundary based 
+00005d40: 6f6e 206d 6170 2074 6172 6765 742e 0a20  on map target.. 
+00005d50: 2020 2020 2020 2020 2020 2046 696c 7465             Filte
+00005d60: 723a 0a20 2020 2020 2020 2020 2020 2020  r:.             
+00005d70: 2020 2046 696c 7465 7220 746f 2062 6520     Filter to be 
+00005d80: 6170 706c 6965 6420 746f 2069 6e70 7574  applied to input
+00005d90: 7320 6d61 7073 2062 6566 6f72 6520 6361  s maps before ca
+00005da0: 6c63 756c 6174 696e 6720 7363 6f72 652e  lculating score.
+00005db0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00005dc0: 2020 2020 2031 2e20 536f 6265 6c20 4669       1. Sobel Fi
+00005dd0: 6c74 6572 2028 4669 6c74 6572 3d3d 2753  lter (Filter=='S
+00005de0: 6f62 656c 2729 0a20 2020 2020 2020 2020  obel').         
+00005df0: 2020 2020 2020 2020 2020 2032 2e20 4c61             2. La
+00005e00: 706c 6163 6520 4669 6c74 6572 2028 4669  place Filter (Fi
+00005e10: 6c74 6572 3d3d 274c 6170 6c61 6365 2729  lter=='Laplace')
+00005e20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00005e30: 2020 2020 2033 2e20 4d69 6e69 6d75 6d20       3. Minimum 
+00005e40: 4669 6c74 6572 2028 4669 6c74 6572 3d3d  Filter (Filter==
+00005e50: 274d 696e 696d 756d 2729 0a20 2020 2020  'Minimum').     
+00005e60: 2020 2020 2020 2020 2020 2020 2020 2034                 4
+00005e70: 2e20 4d65 616e 2046 696c 7465 7220 2846  . Mean Filter (F
+00005e80: 696c 7465 723d 3d27 4d65 616e 2729 0a20  ilter=='Mean'). 
+00005e90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005ea0: 2020 2035 2e20 4e6f 2066 696c 7465 7269     5. No filteri
+00005eb0: 6e67 2028 4669 6c74 6572 3d3d 4e6f 6e65  ng (Filter==None
+00005ec0: 290a 2020 2020 2020 2020 5265 7475 726e  ).        Return
+00005ed0: 3a0a 2020 2020 2020 2020 2020 2020 4e6f  :.            No
+00005ee0: 726d 616c 2076 6563 746f 7220 7363 6f72  rmal vector scor
+00005ef0: 652e 0a20 2020 2020 2020 2052 6169 7365  e..        Raise
+00005f00: 733a 0a20 2020 2020 2020 2020 2020 2073  s:.            s
+00005f10: 7973 2e65 7869 743a 2049 6e70 7574 206d  ys.exit: Input m
+00005f20: 6170 7320 646f 206e 6f74 206d 6174 6368  aps do not match
+00005f30: 2069 6e20 7368 6170 652c 2070 6978 656c   in shape, pixel
+00005f40: 2073 697a 6520 6f72 206f 7269 6769 6e0a   size or origin.
+00005f50: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
+00005f60: 2020 2020 6966 2046 696c 7465 7220 6e6f      if Filter no
+00005f70: 7420 696e 205b 2753 6f62 656c 272c 2027  t in ['Sobel', '
+00005f80: 4c61 706c 6163 6527 2c20 274d 6561 6e27  Laplace', 'Mean'
+00005f90: 2c20 274d 696e 696d 756d 272c 204e 6f6e  , 'Minimum', Non
+00005fa0: 655d 3a0a 2020 2020 2020 2020 2020 2020  e]:.            
+00005fb0: 7072 696e 7428 2749 6e63 6f72 7265 6374  print('Incorrect
+00005fc0: 206e 616d 6520 6f66 2066 696c 7465 723a   name of filter:
+00005fd0: 2025 7322 2025 2046 696c 7465 7227 290a   %s" % Filter').
+00005fe0: 2020 2020 2020 2020 2020 2020 7072 696e              prin
+00005ff0: 7428 0a20 2020 2020 2020 2020 2020 2020  t(.             
+00006000: 2020 2027 5365 6c65 6374 206f 6e65 206f     'Select one o
+00006010: 6620 7468 6520 666f 6c6c 6f77 696e 6720  f the following 
+00006020: 4669 6c74 6572 7320 6966 2061 7070 6c69  Filters if appli
+00006030: 6361 626c 653a 2025 735c 6e27 2025 0a20  cable: %s\n' %. 
+00006040: 2020 2020 2020 2020 2020 2020 2020 2027                 '
+00006050: 2c20 272e 6a6f 696e 285b 2753 6f62 656c  , '.join(['Sobel
+00006060: 272c 2027 4c61 706c 6163 6527 5d29 0a20  ', 'Laplace']). 
+00006070: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
+00006080: 2020 2020 2020 2020 2073 7973 2e65 7869           sys.exi
+00006090: 7428 290a 0a20 2020 2020 2020 2073 636f  t()..        sco
+000060a0: 7265 7320 3d20 5b5d 0a20 2020 2020 2020  res = [].       
+000060b0: 2069 6620 6e6f 7420 7365 6c66 2e6d 6170   if not self.map
+000060c0: 436f 6d70 6172 6973 6f6e 286d 6170 5f74  Comparison(map_t
+000060d0: 6172 6765 742c 206d 6170 5f70 726f 6265  arget, map_probe
+000060e0: 293a 0a20 2020 2020 2020 2020 2020 2073  ):.            s
+000060f0: 656c 662e 5f66 6169 6c65 645f 6d61 7463  elf._failed_matc
+00006100: 6828 290a 2020 2020 2020 2020 6173 7365  h().        asse
+00006110: 7274 2069 7369 6e73 7461 6e63 6528 7072  rt isinstance(pr
+00006120: 696d 6172 795f 626f 756e 6461 7279 2c20  imary_boundary, 
+00006130: 666c 6f61 7429 0a20 2020 2020 2020 2061  float).        a
+00006140: 7373 6572 7420 6973 696e 7374 616e 6365  ssert isinstance
+00006150: 2873 6563 6f6e 6461 7279 5f62 6f75 6e64  (secondary_bound
+00006160: 6172 792c 2066 6c6f 6174 290a 2020 2020  ary, float).    
+00006170: 2020 2020 6966 2070 7269 6d61 7279 5f62      if primary_b
+00006180: 6f75 6e64 6172 7920 3e20 7365 636f 6e64  oundary > second
+00006190: 6172 795f 626f 756e 6461 7279 3a0a 2020  ary_boundary:.  
+000061a0: 2020 2020 2020 2020 2020 7465 6d70 5f74            temp_t
+000061b0: 6872 203d 2073 6563 6f6e 6461 7279 5f62  hr = secondary_b
+000061c0: 6f75 6e64 6172 790a 2020 2020 2020 2020  oundary.        
+000061d0: 2020 2020 7365 636f 6e64 6172 795f 626f      secondary_bo
+000061e0: 756e 6461 7279 203d 2070 7269 6d61 7279  undary = primary
+000061f0: 5f62 6f75 6e64 6172 790a 2020 2020 2020  _boundary.      
+00006200: 2020 2020 2020 7072 696d 6172 795f 626f        primary_bo
+00006210: 756e 6461 7279 203d 2074 656d 705f 7468  undary = temp_th
+00006220: 720a 0a20 2020 2020 2020 2070 6f69 6e74  r..        point
+00006230: 7320 3d20 6e70 2e61 7267 7768 6572 6528  s = np.argwhere(
+00006240: 0a20 2020 2020 2020 2020 2020 2028 6d61  .            (ma
+00006250: 705f 7461 7267 6574 2e66 756c 6c4d 6170  p_target.fullMap
+00006260: 203e 2070 7269 6d61 7279 5f62 6f75 6e64   > primary_bound
+00006270: 6172 7929 2026 0a20 2020 2020 2020 2020  ary) &.         
+00006280: 2020 2028 6d61 705f 7461 7267 6574 2e66     (map_target.f
+00006290: 756c 6c4d 6170 203c 2073 6563 6f6e 6461  ullMap < seconda
+000062a0: 7279 5f62 6f75 6e64 6172 7929 0a20 2020  ry_boundary).   
+000062b0: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
+000062c0: 6966 2046 696c 7465 7220 3d3d 2027 536f  if Filter == 'So
+000062d0: 6265 6c27 3a0a 2020 2020 2020 2020 2020  bel':.          
+000062e0: 2020 6d61 7031 5f73 7572 6661 6365 203d    map1_surface =
+000062f0: 206d 6170 5f74 6172 6765 742e 5f73 6f62   map_target._sob
+00006300: 656c 5f66 696c 7465 725f 636f 6e74 6f75  el_filter_contou
+00006310: 7228 7072 696d 6172 795f 626f 756e 6461  r(primary_bounda
+00006320: 7279 290a 2020 2020 2020 2020 2020 2020  ry).            
+00006330: 706f 696e 7473 203d 206e 702e 6172 6777  points = np.argw
+00006340: 6865 7265 280a 2020 2020 2020 2020 2020  here(.          
+00006350: 2020 2020 2020 6d61 7031 5f73 7572 6661        map1_surfa
+00006360: 6365 2e66 756c 6c4d 6170 203e 2028 6d61  ce.fullMap > (ma
+00006370: 7031 5f73 7572 6661 6365 2e6d 6178 2829  p1_surface.max()
+00006380: 202f 2032 2e30 290a 2020 2020 2020 2020   / 2.0).        
+00006390: 2020 2020 290a 2020 2020 2020 2020 656c      ).        el
+000063a0: 6966 2046 696c 7465 7220 3d3d 2027 4c61  if Filter == 'La
+000063b0: 706c 6163 6527 3a0a 2020 2020 2020 2020  place':.        
+000063c0: 2020 2020 6d61 7031 5f73 7572 6661 6365      map1_surface
+000063d0: 203d 206d 6170 5f74 6172 6765 742e 5f6c   = map_target._l
+000063e0: 6170 6c61 6365 5f66 696c 7465 7265 645f  aplace_filtered_
+000063f0: 636f 6e74 6f75 7228 0a20 2020 2020 2020  contour(.       
+00006400: 2020 2020 2020 2020 2070 7269 6d61 7279           primary
+00006410: 5f62 6f75 6e64 6172 790a 2020 2020 2020  _boundary.      
+00006420: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+00006430: 2020 2020 706f 696e 7473 203d 206e 702e      points = np.
+00006440: 6172 6777 6865 7265 280a 2020 2020 2020  argwhere(.      
+00006450: 2020 2020 2020 2020 2020 6d61 7031 5f73            map1_s
+00006460: 7572 6661 6365 2e66 756c 6c4d 6170 203e  urface.fullMap >
+00006470: 2028 6d61 7031 5f73 7572 6661 6365 2e6d   (map1_surface.m
+00006480: 6178 2829 202f 2032 2e30 290a 2020 2020  ax() / 2.0).    
+00006490: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+000064a0: 2020 656c 6966 2046 696c 7465 7220 3d3d    elif Filter ==
+000064b0: 2027 4d69 6e69 6d75 6d27 3a0a 2020 2020   'Minimum':.    
+000064c0: 2020 2020 2020 2020 6d61 7031 5f73 7572          map1_sur
+000064d0: 6661 6365 203d 206d 6170 5f74 6172 6765  face = map_targe
+000064e0: 742e 5f73 7572 6661 6365 5f6d 696e 696d  t._surface_minim
+000064f0: 756d 5f66 696c 7465 7228 0a20 2020 2020  um_filter(.     
+00006500: 2020 2020 2020 2020 2020 2066 6c6f 6174             float
+00006510: 2870 7269 6d61 7279 5f62 6f75 6e64 6172  (primary_boundar
+00006520: 7929 0a20 2020 2020 2020 2020 2020 2029  y).            )
+00006530: 0a20 2020 2020 2020 2020 2020 2070 6f69  .            poi
+00006540: 6e74 7320 3d20 6e70 2e61 7267 7768 6572  nts = np.argwher
+00006550: 6528 6d61 7031 5f73 7572 6661 6365 203d  e(map1_surface =
+00006560: 3d20 3129 0a20 2020 2020 2020 2065 6c69  = 1).        eli
+00006570: 6620 4669 6c74 6572 203d 3d20 274d 6561  f Filter == 'Mea
+00006580: 6e27 3a0a 2020 2020 2020 2020 2020 2020  n':.            
+00006590: 6d61 7031 5f66 696c 7465 7220 3d20 6d61  map1_filter = ma
+000065a0: 705f 7461 7267 6574 2e5f 7375 7266 6163  p_target._surfac
+000065b0: 655f 6665 6174 7572 6573 2866 6c6f 6174  e_features(float
+000065c0: 2870 7269 6d61 7279 5f62 6f75 6e64 6172  (primary_boundar
+000065d0: 7929 290a 2020 2020 2020 2020 2020 2020  y)).            
+000065e0: 6269 6e5f 7465 7374 203d 205b 302e 3030  bin_test = [0.00
+000065f0: 3031 5d0a 2020 2020 2020 2020 2020 2020  01].            
+00006600: 666f 7220 6969 2069 6e20 7261 6e67 6528  for ii in range(
+00006610: 312c 2034 3129 3a0a 2020 2020 2020 2020  1, 41):.        
+00006620: 2020 2020 2020 2020 6269 6e5f 7465 7374          bin_test
+00006630: 2e61 7070 656e 6428 302e 3032 3520 2a20  .append(0.025 * 
+00006640: 6969 290a 2020 2020 2020 2020 2020 2020  ii).            
+00006650: 6672 6571 5f74 6573 7420 3d20 6e70 2e68  freq_test = np.h
+00006660: 6973 746f 6772 616d 286d 6170 315f 6669  istogram(map1_fi
+00006670: 6c74 6572 2e66 756c 6c4d 6170 2c20 6269  lter.fullMap, bi
+00006680: 6e5f 7465 7374 295b 305d 0a20 2020 2020  n_test)[0].     
+00006690: 2020 2020 2020 2073 756d 5f66 7265 7120         sum_freq 
+000066a0: 3d20 302e 300a 2020 2020 2020 2020 2020  = 0.0.          
+000066b0: 2020 666f 7220 6672 2069 6e20 7261 6e67    for fr in rang
+000066c0: 6528 6c65 6e28 6672 6571 5f74 6573 7429  e(len(freq_test)
+000066d0: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+000066e0: 2020 2073 756d 5f66 7265 7120 2b3d 2066     sum_freq += f
+000066f0: 6c6f 6174 2866 7265 715f 7465 7374 5b66  loat(freq_test[f
+00006700: 725d 290a 2020 2020 2020 2020 2020 2020  r]).            
+00006710: 2020 2020 6966 2028 0a20 2020 2020 2020      if (.       
+00006720: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006730: 2073 756d 5f66 7265 7120 2f20 6e70 2e73   sum_freq / np.s
+00006740: 756d 2866 7265 715f 7465 7374 2920 3e20  um(freq_test) > 
+00006750: 302e 3035 2061 6e64 0a20 2020 2020 2020  0.05 and.       
+00006760: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006770: 2062 696e 5f74 6573 745b 6672 2b31 5d20   bin_test[fr+1] 
+00006780: 3e3d 2030 2e33 0a20 2020 2020 2020 2020  >= 0.3.         
+00006790: 2020 2020 2020 2029 3a0a 2020 2020 2020         ):.      
+000067a0: 2020 2020 2020 2020 2020 2020 2020 7431                t1
+000067b0: 203d 2062 696e 5f74 6573 745b 6672 2b31   = bin_test[fr+1
+000067c0: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
+000067d0: 2020 2020 2020 6272 6561 6b0a 2020 2020        break.    
+000067e0: 2020 2020 2020 2020 2020 2020 6966 2028              if (
+000067f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00006800: 2020 2020 2020 2020 2073 756d 5f66 7265           sum_fre
+00006810: 7120 2f20 6e70 2e6e 756d 7375 6d28 6672  q / np.numsum(fr
+00006820: 6571 5f74 6573 7429 203e 2030 2e31 3020  eq_test) > 0.10 
+00006830: 6f72 0a20 2020 2020 2020 2020 2020 2020  or.             
+00006840: 2020 2020 2020 2020 2020 2073 756d 5f66             sum_f
+00006850: 7265 7120 3e20 3130 3030 3030 0a20 2020  req > 100000.   
+00006860: 2020 2020 2020 2020 2020 2020 2029 3a0a               ):.
+00006870: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006880: 2020 2020 7431 203d 2062 696e 5f74 6573      t1 = bin_tes
+00006890: 745b 6672 2b31 5d0a 2020 2020 2020 2020  t[fr+1].        
+000068a0: 2020 2020 2020 2020 2020 2020 6272 6561              brea
+000068b0: 6b0a 2020 2020 2020 2020 2020 2020 706f  k.            po
+000068c0: 696e 7473 203d 206e 702e 6172 6777 6865  ints = np.argwhe
+000068d0: 7265 280a 2020 2020 2020 2020 2020 2020  re(.            
+000068e0: 2020 2020 286d 6170 315f 6669 6c74 6572      (map1_filter
+000068f0: 2e66 756c 6c4d 6170 203e 2030 2e30 2920  .fullMap > 0.0) 
+00006900: 2620 286d 6170 315f 6669 6c74 6572 2e66  & (map1_filter.f
+00006910: 756c 6c4d 6170 203c 2074 3129 0a20 2020  ullMap < t1).   
+00006920: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
+00006930: 2020 2023 2043 2b2b 2063 616c 6375 6c61     # C++ calcula
+00006940: 7469 6f6e 0a20 2020 2020 2020 2066 6c61  tion.        fla
+00006950: 6763 203d 2031 0a20 2020 2020 2020 2074  gc = 1.        t
+00006960: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
+00006970: 7665 636e 6f72 6d5f 7461 7267 6574 203d  vecnorm_target =
+00006980: 206d 6170 5f74 6172 6765 742e 5f67 6574   map_target._get
+00006990: 5f6e 6f72 6d61 6c5f 7665 6374 6f72 2870  _normal_vector(p
+000069a0: 6f69 6e74 7329 0a20 2020 2020 2020 2020  oints).         
+000069b0: 2020 2076 6563 6e6f 726d 5f70 726f 6265     vecnorm_probe
+000069c0: 203d 206d 6170 5f70 726f 6265 2e5f 6765   = map_probe._ge
+000069d0: 745f 6e6f 726d 616c 5f76 6563 746f 7228  t_normal_vector(
+000069e0: 706f 696e 7473 290a 2020 2020 2020 2020  points).        
+000069f0: 6578 6365 7074 2045 7863 6570 7469 6f6e  except Exception
+00006a00: 3a0a 2020 2020 2020 2020 2020 2020 666c  :.            fl
+00006a10: 6167 6320 3d20 300a 2020 2020 2020 2020  agc = 0.        
+00006a20: 6966 2076 6563 6e6f 726d 5f74 6172 6765  if vecnorm_targe
+00006a30: 7420 6973 204e 6f6e 6520 6f72 2076 6563  t is None or vec
+00006a40: 6e6f 726d 5f70 726f 6265 2069 7320 4e6f  norm_probe is No
+00006a50: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
+00006a60: 666c 6167 6320 3d20 300a 2020 2020 2020  flagc = 0.      
+00006a70: 2020 6374 203d 2030 0a0a 2020 2020 2020    ct = 0..      
+00006a80: 2020 6966 2066 6c61 6763 203d 3d20 313a    if flagc == 1:
+00006a90: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
+00006aa0: 2069 2069 6e20 7261 6e67 6528 6c65 6e28   i in range(len(
+00006ab0: 7665 636e 6f72 6d5f 7461 7267 6574 2929  vecnorm_target))
+00006ac0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00006ad0: 2020 6374 202b 3d20 310a 2020 2020 2020    ct += 1.      
+00006ae0: 2020 2020 2020 2020 2020 6e76 6563 203d            nvec =
+00006af0: 2076 6563 6e6f 726d 5f74 6172 6765 745b   vecnorm_target[
+00006b00: 695d 0a20 2020 2020 2020 2020 2020 2020  i].             
+00006b10: 2020 206f 7665 6320 3d20 7665 636e 6f72     ovec = vecnor
+00006b20: 6d5f 7072 6f62 655b 695d 0a20 2020 2020  m_probe[i].     
+00006b30: 2020 2020 2020 2020 2020 2023 2061 6464             # add
+00006b40: 206d 6178 2076 616c 7565 2066 6f72 2072   max value for r
+00006b50: 6567 696f 6e73 206f 6620 6e75 6c6c 2076  egions of null v
+00006b60: 6172 6961 7469 6f6e 0a20 2020 2020 2020  ariation.       
+00006b70: 2020 2020 2020 2020 2069 6620 280a 2020           if (.  
+00006b80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006b90: 2020 2020 2020 6e76 6563 5b30 5d20 3d3d        nvec[0] ==
+00006ba0: 2030 2e20 616e 640a 2020 2020 2020 2020   0. and.        
+00006bb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006bc0: 6e76 6563 5b31 5d20 3d3d 2030 2e20 616e  nvec[1] == 0. an
+00006bd0: 640a 2020 2020 2020 2020 2020 2020 2020  d.              
+00006be0: 2020 2020 2020 2020 2020 6e76 6563 5b32            nvec[2
+00006bf0: 5d20 3d3d 2030 2e0a 2020 2020 2020 2020  ] == 0..        
+00006c00: 2020 2020 2020 2020 293a 0a20 2020 2020          ):.     
+00006c10: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00006c20: 6620 280a 2020 2020 2020 2020 2020 2020  f (.            
+00006c30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006c40: 6f76 6563 5b30 5d20 3d3d 2030 2e20 616e  ovec[0] == 0. an
+00006c50: 640a 2020 2020 2020 2020 2020 2020 2020  d.              
+00006c60: 2020 2020 2020 2020 2020 2020 2020 6f76                ov
+00006c70: 6563 5b31 5d20 3d3d 2030 2e20 616e 640a  ec[1] == 0. and.
+00006c80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006c90: 2020 2020 2020 2020 2020 2020 6f76 6563              ovec
+00006ca0: 5b32 5d20 3d3d 2030 2e30 0a20 2020 2020  [2] == 0.0.     
+00006cb0: 2020 2020 2020 2020 2020 2020 2020 2029                 )
+00006cc0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00006cd0: 2020 2020 2020 2020 2020 636f 6e74 696e            contin
+00006ce0: 7565 0a20 2020 2020 2020 2020 2020 2020  ue.             
+00006cf0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+00006d00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006d10: 2020 2020 2073 636f 7265 732e 6170 7065       scores.appe
+00006d20: 6e64 2833 2e31 3429 0a20 2020 2020 2020  nd(3.14).       
 00006d30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006d40: 2020 2020 2020 2020 206f 7665 635b 305d           ovec[0]
-00006d50: 202a 0a20 2020 2020 2020 2020 2020 2020   *.             
-00006d60: 2020 2020 2020 2020 2020 2020 2020 206e                 n
-00006d70: 7665 635b 305d 202b 0a20 2020 2020 2020  vec[0] +.       
+00006d40: 2063 6f6e 7469 6e75 650a 2020 2020 2020   continue.      
+00006d50: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
+00006d60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006d70: 2020 2020 6966 2028 0a20 2020 2020 2020      if (.       
 00006d80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006d90: 2020 2020 206f 7665 635b 315d 202a 0a20       ovec[1] *. 
-00006da0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006db0: 2020 2020 2020 2020 2020 206e 7665 635b             nvec[
-00006dc0: 315d 202b 0a20 2020 2020 2020 2020 2020  1] +.           
-00006dd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006de0: 206f 7665 635b 325d 202a 0a20 2020 2020   ovec[2] *.     
-00006df0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006e00: 2020 2020 2020 206e 7665 635b 325d 0a20         nvec[2]. 
-00006e10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006e20: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
-00006e30: 2020 2020 2020 2020 2064 656e 203d 2028           den = (
-00006e40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00006e50: 2020 2020 2020 2020 2020 2020 206e 702e               np.
-00006e60: 7371 7274 286e 7665 635b 305d 2a2a 3220  sqrt(nvec[0]**2 
-00006e70: 2b20 6e76 6563 5b31 5d2a 2a32 202b 206e  + nvec[1]**2 + n
-00006e80: 7665 635b 325d 2a2a 3229 202a 0a20 2020  vec[2]**2) *.   
-00006e90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006ea0: 2020 2020 2020 2020 206e 702e 7371 7274           np.sqrt
-00006eb0: 286f 7665 635b 305d 2a2a 3220 2b20 6f76  (ovec[0]**2 + ov
-00006ec0: 6563 5b31 5d2a 2a32 202b 206f 7665 635b  ec[1]**2 + ovec[
-00006ed0: 325d 2a2a 3229 0a20 2020 2020 2020 2020  2]**2).         
-00006ee0: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
+00006d90: 2020 2020 206f 7665 635b 305d 203d 3d20       ovec[0] == 
+00006da0: 302e 2061 6e64 0a20 2020 2020 2020 2020  0. and.         
+00006db0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006dc0: 2020 206f 7665 635b 315d 203d 3d20 302e     ovec[1] == 0.
+00006dd0: 2061 6e64 0a20 2020 2020 2020 2020 2020   and.           
+00006de0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006df0: 206f 7665 635b 325d 203d 3d20 302e 0a20   ovec[2] == 0.. 
+00006e00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006e10: 2020 2029 3a0a 2020 2020 2020 2020 2020     ):.          
+00006e20: 2020 2020 2020 2020 2020 2020 2020 7363                sc
+00006e30: 6f72 6573 2e61 7070 656e 6428 332e 3134  ores.append(3.14
+00006e40: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00006e50: 2020 2020 2020 2020 2020 636f 6e74 696e            contin
+00006e60: 7565 0a20 2020 2020 2020 2020 2020 2020  ue.             
+00006e70: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
+00006e80: 2020 2020 2020 2020 2020 2020 646f 7470              dotp
+00006e90: 726f 6420 3d20 280a 2020 2020 2020 2020  rod = (.        
+00006ea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006eb0: 2020 2020 6f76 6563 5b30 5d20 2a0a 2020      ovec[0] *.  
+00006ec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006ed0: 2020 2020 2020 2020 2020 6e76 6563 5b30            nvec[0
+00006ee0: 5d20 2b0a 2020 2020 2020 2020 2020 2020  ] +.            
 00006ef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006f00: 2069 6620 6162 7328 646f 7470 726f 6420   if abs(dotprod 
-00006f10: 2d20 6465 6e29 203c 2030 2e30 3030 3031  - den) < 0.00001
-00006f20: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00006f30: 2020 2020 2020 2020 2020 616e 6720 3d20            ang = 
-00006f40: 302e 300a 2020 2020 2020 2020 2020 2020  0.0.            
-00006f50: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+00006f00: 6f76 6563 5b31 5d20 2a0a 2020 2020 2020  ovec[1] *.      
+00006f10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006f20: 2020 2020 2020 6e76 6563 5b31 5d20 2b0a        nvec[1] +.
+00006f30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006f40: 2020 2020 2020 2020 2020 2020 6f76 6563              ovec
+00006f50: 5b32 5d20 2a0a 2020 2020 2020 2020 2020  [2] *.          
 00006f60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006f70: 2020 2020 2020 616e 6720 3d20 6d61 7468        ang = math
-00006f80: 2e61 636f 7328 6d69 6e28 6d61 7828 646f  .acos(min(max(do
-00006f90: 7470 726f 6420 2f20 6465 6e2c 202d 312e  tprod / den, -1.
-00006fa0: 3029 2c20 312e 3029 290a 2020 2020 2020  0), 1.0)).      
-00006fb0: 2020 2020 2020 2020 2020 2020 2020 6966                if
-00006fc0: 2064 656e 203d 3d20 302e 303a 0a20 2020   den == 0.0:.   
-00006fd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006fe0: 2020 2020 2070 7269 6e74 2864 6f74 7072       print(dotpr
-00006ff0: 6f64 2c20 6465 6e2c 206e 7665 632c 206f  od, den, nvec, o
-00007000: 7665 6329 0a20 2020 2020 2020 2020 2020  vec).           
-00007010: 2020 2020 2020 2020 2073 636f 7265 732e           scores.
-00007020: 6170 7065 6e64 2861 6273 2861 6e67 2929  append(abs(ang))
-00007030: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00007040: 2065 7863 6570 7420 5661 6c75 6545 7272   except ValueErr
-00007050: 6f72 3a0a 2020 2020 2020 2020 2020 2020  or:.            
-00007060: 2020 2020 2020 2020 7072 696e 7428 0a20          print(. 
-00007070: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007080: 2020 2020 2020 2027 4572 726f 723a 2041         'Error: A
-00007090: 6e67 6c65 2063 6f75 6c64 206e 6f74 2062  ngle could not b
-000070a0: 6520 6361 6c63 756c 6174 6564 3a20 272c  e calculated: ',
-000070b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000070c0: 2020 2020 2020 2020 206e 7665 632c 0a20           nvec,. 
+00006f70: 2020 6e76 6563 5b32 5d0a 2020 2020 2020    nvec[2].      
+00006f80: 2020 2020 2020 2020 2020 2020 2020 290a                ).
+00006f90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006fa0: 2020 2020 6465 6e20 3d20 280a 2020 2020      den = (.    
+00006fb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006fc0: 2020 2020 2020 2020 6e70 2e73 7172 7428          np.sqrt(
+00006fd0: 6e76 6563 5b30 5d2a 2a32 202b 206e 7665  nvec[0]**2 + nve
+00006fe0: 635b 315d 2a2a 3220 2b20 6e76 6563 5b32  c[1]**2 + nvec[2
+00006ff0: 5d2a 2a32 2920 2a0a 2020 2020 2020 2020  ]**2) *.        
+00007000: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007010: 2020 2020 6e70 2e73 7172 7428 6f76 6563      np.sqrt(ovec
+00007020: 5b30 5d2a 2a32 202b 206f 7665 635b 315d  [0]**2 + ovec[1]
+00007030: 2a2a 3220 2b20 6f76 6563 5b32 5d2a 2a32  **2 + ovec[2]**2
+00007040: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00007050: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+00007060: 2020 2020 2020 2020 2020 2020 6966 2061              if a
+00007070: 6273 2864 6f74 7072 6f64 202d 2064 656e  bs(dotprod - den
+00007080: 2920 3c20 302e 3030 3030 313a 0a20 2020  ) < 0.00001:.   
+00007090: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000070a0: 2020 2020 2061 6e67 203d 2030 2e30 0a20       ang = 0.0. 
+000070b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000070c0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
 000070d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000070e0: 2020 2020 2020 2027 2027 2c0a 2020 2020         ' ',.    
-000070f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007100: 2020 2020 6f76 6563 0a20 2020 2020 2020      ovec.       
-00007110: 2020 2020 2020 2020 2020 2020 2029 0a20               ). 
-00007120: 2020 2020 2020 2020 2020 2069 6620 6c65             if le
-00007130: 6e28 7363 6f72 6573 2920 3d3d 2030 3a0a  n(scores) == 0:.
+000070e0: 2061 6e67 203d 206d 6174 682e 6163 6f73   ang = math.acos
+000070f0: 286d 696e 286d 6178 2864 6f74 7072 6f64  (min(max(dotprod
+00007100: 202f 2064 656e 2c20 2d31 2e30 292c 2031   / den, -1.0), 1
+00007110: 2e30 2929 0a20 2020 2020 2020 2020 2020  .0)).           
+00007120: 2020 2020 2020 2020 2069 6620 6465 6e20           if den 
+00007130: 3d3d 2030 2e30 3a0a 2020 2020 2020 2020  == 0.0:.        
 00007140: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007150: 7072 696e 7428 0a20 2020 2020 2020 2020  print(.         
-00007160: 2020 2020 2020 2020 2020 2027 5468 6572             'Ther
-00007170: 6520 6172 6520 6e6f 2070 6f69 6e74 7320  e are no points 
-00007180: 746f 2062 6520 7363 6f72 6564 2120 5468  to be scored! Th
-00007190: 6520 7468 7265 7368 6f6c 6420 7661 6c75  e threshold valu
-000071a0: 6573 206f 7227 0a20 2020 2020 2020 2020  es or'.         
-000071b0: 2020 2020 2020 2020 2020 2027 2074 6865             ' the
-000071c0: 206e 756d 6265 7220 6f66 2070 6f69 6e74   number of point
-000071d0: 7320 746f 2062 6520 636f 6e73 6964 6572  s to be consider
-000071e0: 6564 206e 6565 6473 2074 6f20 6265 270a  ed needs to be'.
-000071f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007200: 2020 2020 2720 6368 616e 6765 642e 270a      ' changed.'.
-00007210: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007220: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00007230: 2020 7265 7475 726e 204e 6f6e 650a 2020    return None.  
-00007240: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
-00007250: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007260: 6966 2073 756d 2873 636f 7265 7329 203d  if sum(scores) =
-00007270: 3d20 303a 0a20 2020 2020 2020 2020 2020  = 0:.           
-00007280: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-00007290: 302e 300a 2020 2020 2020 2020 2020 2020  0.0.            
-000072a0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-000072b0: 2020 2020 2020 2020 2020 2020 2020 7265                re
-000072c0: 7475 726e 2031 202d 2028 7375 6d28 7363  turn 1 - (sum(sc
-000072d0: 6f72 6573 2920 2f20 286c 656e 2870 6f69  ores) / (len(poi
-000072e0: 6e74 7329 202a 2033 2e31 3429 290a 2020  nts) * 3.14)).  
-000072f0: 2020 2020 2020 7363 6f72 6573 203d 205b        scores = [
-00007300: 5d0a 2020 2020 2020 2020 6374 3120 3d20  ].        ct1 = 
-00007310: 300a 2020 2020 2020 2020 6966 2066 6c61  0.        if fla
-00007320: 6763 203d 3d20 303a 0a20 2020 2020 2020  gc == 0:.       
-00007330: 2020 2020 2066 6f72 2076 2069 6e20 706f       for v in po
-00007340: 696e 7473 3a0a 2020 2020 2020 2020 2020  ints:.          
-00007350: 2020 2020 2020 6e5f 7665 6320 3d20 6d61        n_vec = ma
-00007360: 705f 7461 7267 6574 2e67 6574 5f6e 6f72  p_target.get_nor
-00007370: 6d61 6c5f 7665 6374 6f72 2876 5b32 5d2c  mal_vector(v[2],
-00007380: 2076 5b31 5d2c 2076 5b30 5d29 0a20 2020   v[1], v[0]).   
-00007390: 2020 2020 2020 2020 2020 2020 206f 5f76               o_v
-000073a0: 6563 203d 206d 6170 5f70 726f 6265 2e67  ec = map_probe.g
-000073b0: 6574 5f6e 6f72 6d61 6c5f 7665 6374 6f72  et_normal_vector
-000073c0: 2876 5b32 5d2c 2076 5b31 5d2c 2076 5b30  (v[2], v[1], v[0
-000073d0: 5d29 0a20 2020 2020 2020 2020 2020 2020  ]).             
-000073e0: 2020 2063 7431 202b 3d20 310a 2020 2020     ct1 += 1.    
-000073f0: 2020 2020 2020 2020 2020 2020 6966 2028              if (
-00007400: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00007410: 2020 2020 206e 5f76 6563 2e78 203d 3d20       n_vec.x == 
-00007420: 2d39 2061 6e64 0a20 2020 2020 2020 2020  -9 and.         
-00007430: 2020 2020 2020 2020 2020 206e 5f76 6563             n_vec
-00007440: 2e79 203d 3d20 2d39 2061 6e64 0a20 2020  .y == -9 and.   
-00007450: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007460: 206e 5f76 6563 2e7a 203d 3d20 2d39 0a20   n_vec.z == -9. 
-00007470: 2020 2020 2020 2020 2020 2020 2020 2029                 )
-00007480: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00007490: 2020 2020 2020 6966 2028 0a20 2020 2020        if (.     
-000074a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000074b0: 2020 206f 5f76 6563 2e78 203d 3d20 2d39     o_vec.x == -9
-000074c0: 2061 6e64 0a20 2020 2020 2020 2020 2020   and.           
-000074d0: 2020 2020 2020 2020 2020 2020 206f 5f76               o_v
-000074e0: 6563 2e79 203d 3d20 2d39 2061 6e64 0a20  ec.y == -9 and. 
-000074f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007500: 2020 2020 2020 206f 5f76 6563 2e7a 203d         o_vec.z =
-00007510: 3d20 2d39 0a20 2020 2020 2020 2020 2020  = -9.           
-00007520: 2020 2020 2020 2020 2029 3a0a 2020 2020           ):.    
-00007530: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007540: 2020 2020 636f 6e74 696e 7565 0a20 2020      continue.   
-00007550: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007560: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-00007570: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-00007580: 636f 7265 732e 6170 7065 6e64 2833 2e31  cores.append(3.1
-00007590: 3429 0a20 2020 2020 2020 2020 2020 2020  4).             
-000075a0: 2020 2020 2020 2020 2020 2063 6f6e 7469             conti
-000075b0: 6e75 650a 2020 2020 2020 2020 2020 2020  nue.            
-000075c0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-000075d0: 2020 2020 2020 2020 2020 2020 2020 6966                if
-000075e0: 2028 0a20 2020 2020 2020 2020 2020 2020   (.             
-000075f0: 2020 2020 2020 2020 2020 206f 5f76 6563             o_vec
-00007600: 2e78 203d 3d20 2d39 2061 6e64 0a20 2020  .x == -9 and.   
-00007610: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007620: 2020 2020 206f 5f76 6563 2e79 203d 3d20       o_vec.y == 
-00007630: 2d39 2061 6e64 0a20 2020 2020 2020 2020  -9 and.         
-00007640: 2020 2020 2020 2020 2020 2020 2020 206f                 o
-00007650: 5f76 6563 2e7a 203d 3d20 2d39 0a20 2020  _vec.z == -9.   
+00007150: 7072 696e 7428 646f 7470 726f 642c 2064  print(dotprod, d
+00007160: 656e 2c20 6e76 6563 2c20 6f76 6563 290a  en, nvec, ovec).
+00007170: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007180: 2020 2020 7363 6f72 6573 2e61 7070 656e      scores.appen
+00007190: 6428 6162 7328 616e 6729 290a 2020 2020  d(abs(ang)).    
+000071a0: 2020 2020 2020 2020 2020 2020 6578 6365              exce
+000071b0: 7074 2056 616c 7565 4572 726f 723a 0a20  pt ValueError:. 
+000071c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000071d0: 2020 2070 7269 6e74 280a 2020 2020 2020     print(.      
+000071e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000071f0: 2020 2745 7272 6f72 3a20 416e 676c 6520    'Error: Angle 
+00007200: 636f 756c 6420 6e6f 7420 6265 2063 616c  could not be cal
+00007210: 6375 6c61 7465 643a 2027 2c0a 2020 2020  culated: ',.    
+00007220: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007230: 2020 2020 6e76 6563 2c0a 2020 2020 2020      nvec,.      
+00007240: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007250: 2020 2720 272c 0a20 2020 2020 2020 2020    ' ',.         
+00007260: 2020 2020 2020 2020 2020 2020 2020 206f                 o
+00007270: 7665 630a 2020 2020 2020 2020 2020 2020  vec.            
+00007280: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+00007290: 2020 2020 2020 6966 206c 656e 2873 636f        if len(sco
+000072a0: 7265 7329 203d 3d20 303a 0a20 2020 2020  res) == 0:.     
+000072b0: 2020 2020 2020 2020 2020 2070 7269 6e74             print
+000072c0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+000072d0: 2020 2020 2020 2754 6865 7265 2061 7265        'There are
+000072e0: 206e 6f20 706f 696e 7473 2074 6f20 6265   no points to be
+000072f0: 2073 636f 7265 6421 2054 6865 2074 6872   scored! The thr
+00007300: 6573 686f 6c64 2076 616c 7565 7320 6f72  eshold values or
+00007310: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
+00007320: 2020 2020 2020 2720 7468 6520 6e75 6d62        ' the numb
+00007330: 6572 206f 6620 706f 696e 7473 2074 6f20  er of points to 
+00007340: 6265 2063 6f6e 7369 6465 7265 6420 6e65  be considered ne
+00007350: 6564 7320 746f 2062 6527 0a20 2020 2020  eds to be'.     
+00007360: 2020 2020 2020 2020 2020 2020 2020 2027                 '
+00007370: 2063 6861 6e67 6564 2e27 0a20 2020 2020   changed.'.     
+00007380: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
+00007390: 2020 2020 2020 2020 2020 2020 2072 6574               ret
+000073a0: 7572 6e20 4e6f 6e65 0a20 2020 2020 2020  urn None.       
+000073b0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+000073c0: 2020 2020 2020 2020 2020 2069 6620 7375             if su
+000073d0: 6d28 7363 6f72 6573 2920 3d3d 2030 3a0a  m(scores) == 0:.
+000073e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000073f0: 2020 2020 7265 7475 726e 2030 2e30 0a20      return 0.0. 
+00007400: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+00007410: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+00007420: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+00007430: 3120 2d20 2873 756d 2873 636f 7265 7329  1 - (sum(scores)
+00007440: 202f 2028 6c65 6e28 706f 696e 7473 2920   / (len(points) 
+00007450: 2a20 332e 3134 2929 0a20 2020 2020 2020  * 3.14)).       
+00007460: 2073 636f 7265 7320 3d20 5b5d 0a20 2020   scores = [].   
+00007470: 2020 2020 2063 7431 203d 2030 0a20 2020       ct1 = 0.   
+00007480: 2020 2020 2069 6620 666c 6167 6320 3d3d       if flagc ==
+00007490: 2030 3a0a 2020 2020 2020 2020 2020 2020   0:.            
+000074a0: 666f 7220 7620 696e 2070 6f69 6e74 733a  for v in points:
+000074b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000074c0: 206e 5f76 6563 203d 206d 6170 5f74 6172   n_vec = map_tar
+000074d0: 6765 742e 6765 745f 6e6f 726d 616c 5f76  get.get_normal_v
+000074e0: 6563 746f 7228 765b 325d 2c20 765b 315d  ector(v[2], v[1]
+000074f0: 2c20 765b 305d 290a 2020 2020 2020 2020  , v[0]).        
+00007500: 2020 2020 2020 2020 6f5f 7665 6320 3d20          o_vec = 
+00007510: 6d61 705f 7072 6f62 652e 6765 745f 6e6f  map_probe.get_no
+00007520: 726d 616c 5f76 6563 746f 7228 765b 325d  rmal_vector(v[2]
+00007530: 2c20 765b 315d 2c20 765b 305d 290a 2020  , v[1], v[0]).  
+00007540: 2020 2020 2020 2020 2020 2020 2020 6374                ct
+00007550: 3120 2b3d 2031 0a20 2020 2020 2020 2020  1 += 1.         
+00007560: 2020 2020 2020 2069 6620 280a 2020 2020         if (.    
+00007570: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007580: 6e5f 7665 632e 7820 3d3d 202d 3920 616e  n_vec.x == -9 an
+00007590: 640a 2020 2020 2020 2020 2020 2020 2020  d.              
+000075a0: 2020 2020 2020 6e5f 7665 632e 7920 3d3d        n_vec.y ==
+000075b0: 202d 3920 616e 640a 2020 2020 2020 2020   -9 and.        
+000075c0: 2020 2020 2020 2020 2020 2020 6e5f 7665              n_ve
+000075d0: 632e 7a20 3d3d 202d 390a 2020 2020 2020  c.z == -9.      
+000075e0: 2020 2020 2020 2020 2020 293a 0a20 2020            ):.   
+000075f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007600: 2069 6620 280a 2020 2020 2020 2020 2020   if (.          
+00007610: 2020 2020 2020 2020 2020 2020 2020 6f5f                o_
+00007620: 7665 632e 7820 3d3d 202d 3920 616e 640a  vec.x == -9 and.
+00007630: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007640: 2020 2020 2020 2020 6f5f 7665 632e 7920          o_vec.y 
+00007650: 3d3d 202d 3920 616e 640a 2020 2020 2020  == -9 and.      
 00007660: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007670: 2029 3a0a 2020 2020 2020 2020 2020 2020   ):.            
-00007680: 2020 2020 2020 2020 2020 2020 7363 6f72              scor
-00007690: 6573 2e61 7070 656e 6428 332e 3134 290a  es.append(3.14).
-000076a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000076b0: 2020 2020 2020 2020 636f 6e74 696e 7565          continue
-000076c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000076d0: 2074 7279 3a0a 2020 2020 2020 2020 2020   try:.          
+00007670: 2020 6f5f 7665 632e 7a20 3d3d 202d 390a    o_vec.z == -9.
+00007680: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007690: 2020 2020 293a 0a20 2020 2020 2020 2020      ):.         
+000076a0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+000076b0: 6f6e 7469 6e75 650a 2020 2020 2020 2020  ontinue.        
+000076c0: 2020 2020 2020 2020 2020 2020 656c 7365              else
+000076d0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
 000076e0: 2020 2020 2020 2020 2020 7363 6f72 6573            scores
-000076f0: 2e61 7070 656e 6428 6162 7328 6e5f 7665  .append(abs(n_ve
-00007700: 632e 6172 6728 6f5f 7665 6329 2929 0a20  c.arg(o_vec))). 
-00007710: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-00007720: 7863 6570 7420 5661 6c75 6545 7272 6f72  xcept ValueError
-00007730: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00007740: 2020 2020 2020 7072 696e 7428 0a20 2020        print(.   
+000076f0: 2e61 7070 656e 6428 332e 3134 290a 2020  .append(3.14).  
+00007700: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007710: 2020 2020 2020 636f 6e74 696e 7565 0a20        continue. 
+00007720: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+00007730: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+00007740: 2020 2020 2020 2020 2069 6620 280a 2020           if (.  
 00007750: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007760: 2020 2020 2027 4572 726f 723a 2041 6e67       'Error: Ang
-00007770: 6c65 2062 6574 7765 656e 2027 202b 0a20  le between ' +. 
+00007760: 2020 2020 2020 6f5f 7665 632e 7820 3d3d        o_vec.x ==
+00007770: 202d 3920 616e 640a 2020 2020 2020 2020   -9 and.        
 00007780: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007790: 2020 2020 2020 2073 7472 286e 5f76 6563         str(n_vec
-000077a0: 2920 2b0a 2020 2020 2020 2020 2020 2020  ) +.            
-000077b0: 2020 2020 2020 2020 2020 2020 272c 2027              ', '
-000077c0: 202b 0a20 2020 2020 2020 2020 2020 2020   +.             
-000077d0: 2020 2020 2020 2020 2020 2073 7472 286f             str(o
-000077e0: 5f76 6563 2920 2b0a 2020 2020 2020 2020  _vec) +.        
-000077f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007800: 2720 666f 7220 706f 696e 7420 2564 2c20  ' for point %d, 
-00007810: 2564 2c20 2564 2063 616e 6e6f 7420 6265  %d, %d cannot be
-00007820: 2063 616c 6375 6c61 7465 642e 2720 250a   calculated.' %.
-00007830: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007840: 2020 2020 2020 2020 2876 2e78 2c20 762e          (v.x, v.
-00007850: 792c 2076 2e7a 290a 2020 2020 2020 2020  y, v.z).        
-00007860: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
-00007870: 2020 2020 2020 6966 206c 656e 2873 636f        if len(sco
-00007880: 7265 7329 203d 3d20 303a 0a20 2020 2020  res) == 0:.     
-00007890: 2020 2020 2020 2070 7269 6e74 280a 2020         print(.  
-000078a0: 2020 2020 2020 2020 2020 2020 2020 2754                'T
-000078b0: 6865 7265 2061 7265 206e 6f20 706f 696e  here are no poin
-000078c0: 7473 2074 6f20 6265 2073 636f 7265 6421  ts to be scored!
-000078d0: 2054 6865 2074 6872 6573 686f 6c64 2076   The threshold v
-000078e0: 616c 7565 7320 6f72 2027 0a20 2020 2020  alues or '.     
-000078f0: 2020 2020 2020 2020 2020 2027 7468 6520             'the 
-00007900: 6e75 6d62 6572 206f 6620 706f 696e 7473  number of points
-00007910: 2074 6f20 6265 2063 6f6e 7369 6465 7265   to be considere
-00007920: 6420 6e65 6564 7320 746f 2062 6520 6368  d needs to be ch
-00007930: 616e 6765 642e 270a 2020 2020 2020 2020  anged.'.        
-00007940: 2020 2020 290a 2020 2020 2020 2020 656c      ).        el
-00007950: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-00007960: 6966 2073 756d 2873 636f 7265 7329 203d  if sum(scores) =
-00007970: 3d20 303a 0a20 2020 2020 2020 2020 2020  = 0:.           
-00007980: 2020 2020 2072 6574 7572 6e20 300a 2020       return 0.  
-00007990: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
+00007790: 6f5f 7665 632e 7920 3d3d 202d 3920 616e  o_vec.y == -9 an
+000077a0: 640a 2020 2020 2020 2020 2020 2020 2020  d.              
+000077b0: 2020 2020 2020 2020 2020 6f5f 7665 632e            o_vec.
+000077c0: 7a20 3d3d 202d 390a 2020 2020 2020 2020  z == -9.        
+000077d0: 2020 2020 2020 2020 2020 2020 293a 0a20              ):. 
+000077e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000077f0: 2020 2020 2020 2073 636f 7265 732e 6170         scores.ap
+00007800: 7065 6e64 2833 2e31 3429 0a20 2020 2020  pend(3.14).     
+00007810: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007820: 2020 2063 6f6e 7469 6e75 650a 2020 2020     continue.    
+00007830: 2020 2020 2020 2020 2020 2020 7472 793a              try:
+00007840: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00007850: 2020 2020 2073 636f 7265 732e 6170 7065       scores.appe
+00007860: 6e64 2861 6273 286e 5f76 6563 2e61 7267  nd(abs(n_vec.arg
+00007870: 286f 5f76 6563 2929 290a 2020 2020 2020  (o_vec))).      
+00007880: 2020 2020 2020 2020 2020 6578 6365 7074            except
+00007890: 2056 616c 7565 4572 726f 723a 0a20 2020   ValueError:.   
+000078a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000078b0: 2070 7269 6e74 280a 2020 2020 2020 2020   print(.        
+000078c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000078d0: 2745 7272 6f72 3a20 416e 676c 6520 6265  'Error: Angle be
+000078e0: 7477 6565 6e20 2720 2b0a 2020 2020 2020  tween ' +.      
+000078f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007900: 2020 7374 7228 6e5f 7665 6329 202b 0a20    str(n_vec) +. 
+00007910: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007920: 2020 2020 2020 2027 2c20 2720 2b0a 2020         ', ' +.  
+00007930: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007940: 2020 2020 2020 7374 7228 6f5f 7665 6329        str(o_vec)
+00007950: 202b 0a20 2020 2020 2020 2020 2020 2020   +.             
+00007960: 2020 2020 2020 2020 2020 2027 2066 6f72             ' for
+00007970: 2070 6f69 6e74 2025 642c 2025 642c 2025   point %d, %d, %
+00007980: 6420 6361 6e6e 6f74 2062 6520 6361 6c63  d cannot be calc
+00007990: 756c 6174 6564 2e27 2025 0a20 2020 2020  ulated.' %.     
 000079a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000079b0: 7265 7475 726e 2031 202d 2028 7375 6d28  return 1 - (sum(
-000079c0: 7363 6f72 6573 2920 2f20 286c 656e 2870  scores) / (len(p
-000079d0: 6f69 6e74 7329 202a 2033 2e31 3429 290a  oints) * 3.14)).
-000079e0: 0a20 2020 2064 6566 2067 6574 5f70 6172  .    def get_par
-000079f0: 7469 616c 5f44 4c53 4628 0a20 2020 2020  tial_DLSF(.     
-00007a00: 2020 2020 2020 2073 656c 662c 0a20 2020         self,.   
-00007a10: 2020 2020 2020 2020 206e 756d 5f6f 665f           num_of_
-00007a20: 706f 696e 7473 2c0a 2020 2020 2020 2020  points,.        
-00007a30: 2020 2020 6d61 705f 7461 7267 6574 2c0a      map_target,.
-00007a40: 2020 2020 2020 2020 2020 2020 6d61 705f              map_
-00007a50: 7072 6f62 650a 2020 2020 293a 0a20 2020  probe.    ):.   
-00007a60: 2020 2020 2022 2222 4361 6c63 756c 6174       """Calculat
-00007a70: 6520 7468 6520 444c 5346 2073 636f 7265  e the DLSF score
-00007a80: 2062 6574 7765 656e 2074 776f 204d 6170   between two Map
-00007a90: 2069 6e73 7461 6e63 6573 2e0a 0a20 2020   instances...   
-00007aa0: 2020 2020 2054 6865 2044 4c53 4620 6973       The DLSF is
-00007ab0: 2073 696d 696c 6172 2074 6f20 7468 6520   similar to the 
-00007ac0: 4c53 463b 0a20 2020 2020 2020 2077 6865  LSF;.        whe
-00007ad0: 7265 6173 2074 6865 204c 5346 2063 6f6d  reas the LSF com
-00007ae0: 7061 7265 7320 6162 736f 6c75 7465 2064  pares absolute d
-00007af0: 656e 7369 7479 2076 616c 7565 732c 0a20  ensity values,. 
-00007b00: 2020 2020 2020 2074 6865 2044 4c53 4620         the DLSF 
-00007b10: 636f 6d70 6172 6573 2074 6865 2064 6966  compares the dif
-00007b20: 6665 7265 6e63 6520 6265 7477 6565 6e20  ference between 
-00007b30: 7061 6972 7320 6f66 2076 616c 7565 732e  pairs of values.
-00007b40: 0a0a 2020 2020 2020 2020 4172 6775 6d65  ..        Argume
-00007b50: 6e74 733a 0a20 2020 2020 2020 2020 2020  nts:.           
-00007b60: 206d 6170 5f74 6172 6765 742c 206d 6170   map_target, map
-00007b70: 5f70 726f 6265 3a20 4d61 7020 696e 7374  _probe: Map inst
-00007b80: 616e 6365 7320 746f 2063 6f6d 7061 7265  ances to compare
-00007b90: 2e0a 2020 2020 2020 2020 2020 2020 6e75  ..            nu
-00007ba0: 6d5f 6f66 5f70 6f69 6e74 733a 204e 756d  m_of_points: Num
-00007bb0: 6265 7220 6f66 2073 6967 6e69 6669 6361  ber of significa
-00007bc0: 6e74 2070 6f69 6e74 732e 0a20 2020 2020  nt points..     
-00007bd0: 2020 2052 6574 7572 6e3a 0a20 2020 2020     Return:.     
-00007be0: 2020 2020 2020 2044 4c53 4620 7363 6f72         DLSF scor
-00007bf0: 652c 206f 7220 7374 7269 6e67 2022 6361  e, or string "ca
-00007c00: 6e27 7420 6d61 7463 6820 7468 6520 6d61  n't match the ma
-00007c10: 7022 2069 6620 496e 7075 7420 6d61 7073  p" if Input maps
-00007c20: 2064 6f20 6e6f 740a 2020 2020 2020 2020   do not.        
-00007c30: 2020 2020 6d61 7463 6820 696e 2073 6861      match in sha
-00007c40: 7065 2c20 7069 7865 6c20 7369 7a65 206f  pe, pixel size o
-00007c50: 7220 6f72 6967 696e 0a20 2020 2020 2020  r origin.       
-00007c60: 2022 2222 0a0a 2020 2020 2020 2020 6966   """..        if
-00007c70: 206e 6f74 2073 656c 662e 6d61 7043 6f6d   not self.mapCom
-00007c80: 7061 7269 736f 6e28 6d61 705f 7461 7267  parison(map_targ
-00007c90: 6574 2c20 6d61 705f 7072 6f62 6529 3a0a  et, map_probe):.
-00007ca0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-00007cb0: 726e 2022 6361 6e27 7420 4d61 7463 6820  rn "can't Match 
-00007cc0: 7468 6520 6d61 7022 0a0a 2020 2020 2020  the map"..      
-00007cd0: 2020 6d61 705f 7461 7267 6574 5f73 6967    map_target_sig
-00007ce0: 5f70 6169 7273 203d 206d 6170 5f74 6172  _pairs = map_tar
-00007cf0: 6765 742e 5f67 6574 5f72 616e 646f 6d5f  get._get_random_
-00007d00: 7369 676e 6966 6963 616e 745f 7061 6972  significant_pair
-00007d10: 7328 0a20 2020 2020 2020 2020 2020 2069  s(.            i
-00007d20: 6e74 286e 756d 5f6f 665f 706f 696e 7473  nt(num_of_points
-00007d30: 290a 2020 2020 2020 2020 290a 2020 2020  ).        ).    
-00007d40: 2020 2020 6f74 6865 724d 6170 203d 206d      otherMap = m
-00007d50: 6170 5f70 726f 6265 0a20 2020 2020 2020  ap_probe.       
-00007d60: 2073 636f 7265 203d 2030 2e30 0a20 2020   score = 0.0.   
-00007d70: 2020 2020 2066 6f72 2070 2069 6e20 6d61       for p in ma
-00007d80: 705f 7461 7267 6574 5f73 6967 5f70 6169  p_target_sig_pai
-00007d90: 7273 3a0a 2020 2020 2020 2020 2020 2020  rs:.            
-00007da0: 7a31 203d 2070 5b30 5d0a 2020 2020 2020  z1 = p[0].      
-00007db0: 2020 2020 2020 7931 203d 2070 5b31 5d0a        y1 = p[1].
-00007dc0: 2020 2020 2020 2020 2020 2020 7831 203d              x1 =
-00007dd0: 2070 5b32 5d0a 2020 2020 2020 2020 2020   p[2].          
-00007de0: 2020 7a32 203d 2070 5b33 5d0a 2020 2020    z2 = p[3].    
-00007df0: 2020 2020 2020 2020 7932 203d 2070 5b34          y2 = p[4
-00007e00: 5d0a 2020 2020 2020 2020 2020 2020 7832  ].            x2
-00007e10: 203d 2070 5b35 5d0a 2020 2020 2020 2020   = p[5].        
-00007e20: 2020 2020 6465 6e73 203d 2070 5b36 5d0a      dens = p[6].
-00007e30: 2020 2020 2020 2020 2020 2020 7072 6f74              prot
-00007e40: 5f64 656e 7320 3d20 280a 2020 2020 2020  _dens = (.      
-00007e50: 2020 2020 2020 2020 2020 6f74 6865 724d            otherM
-00007e60: 6170 2e66 756c 6c4d 6170 5b7a 315d 5b79  ap.fullMap[z1][y
-00007e70: 315d 5b78 315d 202d 206f 7468 6572 4d61  1][x1] - otherMa
-00007e80: 702e 6675 6c6c 4d61 705b 7a32 5d5b 7932  p.fullMap[z2][y2
-00007e90: 5d5b 7832 5d0a 2020 2020 2020 2020 2020  ][x2].          
-00007ea0: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
-00007eb0: 7363 6f72 6520 2b3d 2028 6465 6e73 202d  score += (dens -
-00007ec0: 2070 726f 745f 6465 6e73 292a 2a32 0a20   prot_dens)**2. 
-00007ed0: 2020 2020 2020 2072 6574 7572 6e20 7363         return sc
-00007ee0: 6f72 6520 2f20 6d61 705f 7461 7267 6574  ore / map_target
-00007ef0: 2e66 756c 6c4d 6170 2e73 697a 650a 0a20  .fullMap.size.. 
-00007f00: 2020 2064 6566 205f 4d49 2873 656c 662c     def _MI(self,
-00007f10: 206d 6170 5f74 6172 6765 742c 206d 6170   map_target, map
-00007f20: 5f70 726f 6265 2c20 6c61 7965 7273 3d32  _probe, layers=2
-00007f30: 3029 3a0a 2020 2020 2020 2020 2222 2243  0):.        """C
-00007f40: 616c 6375 6c61 7465 2074 6865 206d 7574  alculate the mut
-00007f50: 7561 6c20 696e 666f 726d 6174 696f 6e20  ual information 
-00007f60: 7363 6f72 6520 6265 7477 6565 6e20 7477  score between tw
-00007f70: 6f20 4d61 7073 2e0a 0a20 2020 2020 2020  o Maps...       
-00007f80: 204f 6c64 2076 6572 7369 6f6e 206f 6620   Old version of 
-00007f90: 7468 6520 7363 6f72 653f 0a0a 2020 2020  the score?..    
-00007fa0: 2020 2020 4172 6775 6d65 6e74 733a 0a20      Arguments:. 
-00007fb0: 2020 2020 2020 2020 2020 206d 6170 5f74             map_t
-00007fc0: 6172 6765 742c 206d 6170 5f70 726f 6265  arget, map_probe
-00007fd0: 3a20 4d61 7020 696e 7374 616e 6365 7320  : Map instances 
-00007fe0: 746f 2063 6f6d 7061 7265 2e0a 0a20 2020  to compare...   
-00007ff0: 2020 2020 2020 2020 206c 6179 6572 733a           layers:
-00008000: 204e 756d 6265 7220 6f66 206c 6179 6572   Number of layer
-00008010: 7320 7573 6564 2074 6f20 6269 6e20 7468  s used to bin th
-00008020: 6520 6d61 702e 2044 6566 6175 6c74 2069  e map. Default i
-00008030: 7320 3230 2061 7320 696e 0a20 2020 2020  s 20 as in.     
-00008040: 2020 2020 2020 2020 2020 2053 6861 7473             Shats
-00008050: 6b79 2065 7420 616c 2e2c 2032 3030 382e  ky et al., 2008.
-00008060: 0a20 2020 2020 2020 2052 6574 7572 6e3a  .        Return:
-00008070: 204d 4920 7363 6f72 650a 2020 2020 2020   MI score.      
-00008080: 2020 5261 6973 6573 3a0a 2020 2020 2020    Raises:.      
-00008090: 2020 2020 2020 7379 732e 6578 6974 3a20        sys.exit: 
-000080a0: 496e 7075 7420 6d61 7073 2064 6f20 6e6f  Input maps do no
-000080b0: 7420 6d61 7463 6820 696e 2073 6861 7065  t match in shape
-000080c0: 2c20 7069 7865 6c20 7369 7a65 206f 7220  , pixel size or 
-000080d0: 6f72 6967 696e 0a20 2020 2020 2020 2022  origin.        "
-000080e0: 2222 0a0a 2020 2020 2020 2020 6966 2073  ""..        if s
-000080f0: 656c 662e 6d61 7043 6f6d 7061 7269 736f  elf.mapCompariso
-00008100: 6e28 6d61 705f 7461 7267 6574 2c20 6d61  n(map_target, ma
-00008110: 705f 7072 6f62 6529 3a0a 2020 2020 2020  p_probe):.      
-00008120: 2020 2020 2020 6d31 2c20 6d32 203d 206d        m1, m2 = m
-00008130: 6170 5f74 6172 6765 742c 206d 6170 5f70  ap_target, map_p
-00008140: 726f 6265 0a20 2020 2020 2020 2065 6c73  robe.        els
-00008150: 653a 0a20 2020 2020 2020 2020 2020 2073  e:.            s
-00008160: 656c 662e 5f66 6169 6c65 645f 6d61 7463  elf._failed_matc
-00008170: 6828 290a 2020 2020 2020 2020 7363 6f72  h().        scor
-00008180: 6520 3d20 300a 2020 2020 2020 2020 6d31  e = 0.        m1
-00008190: 5f6c 6576 656c 7320 3d20 286d 312e 6d61  _levels = (m1.ma
-000081a0: 7828 2920 2d20 6d31 2e6d 696e 2829 2920  x() - m1.min()) 
-000081b0: 2f20 6c61 7965 7273 0a20 2020 2020 2020  / layers.       
-000081c0: 206d 325f 6c65 7665 6c73 203d 2028 6d32   m2_levels = (m2
-000081d0: 2e6d 6178 2829 202d 206d 322e 6d69 6e28  .max() - m2.min(
-000081e0: 2929 202f 206c 6179 6572 730a 2020 2020  )) / layers.    
-000081f0: 2020 2020 666f 7220 7820 696e 2072 616e      for x in ran
-00008200: 6765 286c 6179 6572 7329 3a0a 2020 2020  ge(layers):.    
-00008210: 2020 2020 2020 2020 666f 7220 7920 696e          for y in
-00008220: 2072 616e 6765 286c 6179 6572 7329 3a0a   range(layers):.
-00008230: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008240: 6d31 5f6c 6576 656c 5f6d 6170 203d 2028  m1_level_map = (
-00008250: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00008260: 2020 2020 2020 2020 2028 6d31 2e67 6574           (m1.get
-00008270: 4d61 7028 2920 3e3d 206d 312e 6d69 6e28  Map() >= m1.min(
-00008280: 2920 2b20 2878 202a 206d 315f 6c65 7665  ) + (x * m1_leve
-00008290: 6c73 2929 202a 0a20 2020 2020 2020 2020  ls)) *.         
-000082a0: 2020 2020 2020 2020 2020 2020 2020 2028                 (
-000082b0: 6d31 2e67 6574 4d61 7028 2920 3c3d 206d  m1.getMap() <= m
-000082c0: 312e 6d69 6e28 2920 2b20 2828 7820 2b20  1.min() + ((x + 
-000082d0: 3129 202a 206d 315f 6c65 7665 6c73 2929  1) * m1_levels))
-000082e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000082f0: 2029 0a20 2020 2020 2020 2020 2020 2020   ).             
-00008300: 2020 206d 325f 6c65 7665 6c5f 6d61 7020     m2_level_map 
-00008310: 3d20 280a 2020 2020 2020 2020 2020 2020  = (.            
-00008320: 2020 2020 2020 2020 2020 2020 286d 322e              (m2.
-00008330: 6765 744d 6170 2829 203e 3d20 6d32 2e6d  getMap() >= m2.m
-00008340: 696e 2829 202b 2028 7920 2a20 6d32 5f6c  in() + (y * m2_l
-00008350: 6576 656c 7329 2920 2a0a 2020 2020 2020  evels)) *.      
-00008360: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008370: 2020 286d 322e 6765 744d 6170 2829 203c    (m2.getMap() <
-00008380: 3d20 6d32 2e6d 696e 2829 202b 2028 2879  = m2.min() + ((y
-00008390: 202b 2031 2920 2a20 6d32 5f6c 6576 656c   + 1) * m2_level
-000083a0: 7329 290a 2020 2020 2020 2020 2020 2020  s)).            
-000083b0: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
-000083c0: 2020 2020 2020 636f 6d62 5f6c 6576 656c        comb_level
-000083d0: 5f6d 6170 203d 206d 315f 6c65 7665 6c5f  _map = m1_level_
-000083e0: 6d61 702a 6d32 5f6c 6576 656c 5f6d 6170  map*m2_level_map
-000083f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00008400: 2070 5f6d 3120 3d20 666c 6f61 7428 6d31   p_m1 = float(m1
-00008410: 5f6c 6576 656c 5f6d 6170 2e73 756d 2829  _level_map.sum()
-00008420: 292f 6d31 5f6c 6576 656c 5f6d 6170 2e73  )/m1_level_map.s
-00008430: 697a 650a 2020 2020 2020 2020 2020 2020  ize.            
-00008440: 2020 2020 705f 6d32 203d 2066 6c6f 6174      p_m2 = float
-00008450: 286d 325f 6c65 7665 6c5f 6d61 702e 7375  (m2_level_map.su
-00008460: 6d28 2929 2f6d 325f 6c65 7665 6c5f 6d61  m())/m2_level_ma
-00008470: 702e 7369 7a65 0a20 2020 2020 2020 2020  p.size.         
-00008480: 2020 2020 2020 2070 5f63 6f6d 6220 3d20         p_comb = 
-00008490: 666c 6f61 7428 636f 6d62 5f6c 6576 656c  float(comb_level
-000084a0: 5f6d 6170 2e73 756d 2829 292f 636f 6d62  _map.sum())/comb
-000084b0: 5f6c 6576 656c 5f6d 6170 2e73 697a 650a  _level_map.size.
-000084c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000084d0: 6966 2070 5f63 6f6d 6220 3d3d 2030 3a0a  if p_comb == 0:.
-000084e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000084f0: 2020 2020 6d69 5f73 636f 7265 203d 2030      mi_score = 0
-00008500: 2e30 0a20 2020 2020 2020 2020 2020 2020  .0.             
-00008510: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-00008520: 2020 2020 2020 2020 2020 2020 206d 695f               mi_
-00008530: 7363 6f72 6520 3d20 705f 636f 6d62 202a  score = p_comb *
-00008540: 206d 6174 682e 6c6f 6728 705f 636f 6d62   math.log(p_comb
-00008550: 202f 2028 705f 6d31 202a 2070 5f6d 3229   / (p_m1 * p_m2)
-00008560: 2c20 3229 0a20 2020 2020 2020 2020 2020  , 2).           
-00008570: 2020 2020 2073 636f 7265 202b 3d20 6d69       score += mi
-00008580: 5f73 636f 7265 0a20 2020 2020 2020 2072  _score.        r
-00008590: 6574 7572 6e20 7363 6f72 650a 0a20 2020  eturn score..   
-000085a0: 2064 6566 205f 4d49 5f43 280a 2020 2020   def _MI_C(.    
-000085b0: 2020 2020 2020 2020 7365 6c66 2c0a 2020          self,.  
-000085c0: 2020 2020 2020 2020 2020 6d31 2c0a 2020            m1,.  
-000085d0: 2020 2020 2020 2020 2020 6d32 2c0a 2020            m2,.  
-000085e0: 2020 2020 2020 2020 2020 6c61 7965 7273            layers
-000085f0: 313d 3230 2c0a 2020 2020 2020 2020 2020  1=20,.          
-00008600: 2020 6c61 7965 7273 323d 3230 2c0a 2020    layers2=20,.  
-00008610: 2020 2020 2020 2020 2020 4e3d 302c 0a20            N=0,. 
-00008620: 2020 2020 2020 2020 2020 206c 6331 3d30             lc1=0
-00008630: 2e30 2c0a 2020 2020 2020 2020 2020 2020  .0,.            
-00008640: 6c63 323d 302e 302c 0a20 2020 2029 3a0a  lc2=0.0,.    ):.
-00008650: 2020 2020 2020 2020 6172 7231 203d 2028          arr1 = (
-00008660: 6d31 292e 7669 6577 2866 6c6f 6174 290a  m1).view(float).
-00008670: 2020 2020 2020 2020 6172 7232 203d 2028          arr2 = (
-00008680: 6d32 292e 7669 6577 2866 6c6f 6174 290a  m2).view(float).
-00008690: 2020 2020 2020 2020 7265 7475 726e 205f          return _
-000086a0: 4d49 5f43 5f68 656c 7065 725f 6e65 7728  MI_C_helper_new(
-000086b0: 6172 7231 2c20 6172 7232 2c20 6c61 7965  arr1, arr2, laye
-000086c0: 7273 312c 206c 6179 6572 7332 2c20 4e2c  rs1, layers2, N,
-000086d0: 206c 6331 2c20 6c63 3229 0a0a 2020 2020   lc1, lc2)..    
-000086e0: 6465 6620 4d49 280a 2020 2020 2020 2020  def MI(.        
-000086f0: 2020 2020 7365 6c66 2c0a 2020 2020 2020      self,.      
-00008700: 2020 2020 2020 6d61 705f 7461 7267 6574        map_target
-00008710: 2c0a 2020 2020 2020 2020 2020 2020 6d61  ,.            ma
-00008720: 705f 7072 6f62 652c 0a20 2020 2020 2020  p_probe,.       
-00008730: 2020 2020 206d 6170 5f74 6172 6765 745f       map_target_
-00008740: 7468 7265 7368 6f6c 643d 302e 302c 0a20  threshold=0.0,. 
-00008750: 2020 2020 2020 2020 2020 206d 6170 5f70             map_p
-00008760: 726f 6265 5f74 6872 6573 686f 6c64 3d30  robe_threshold=0
-00008770: 2e30 2c0a 2020 2020 2020 2020 2020 2020  .0,.            
-00008780: 6d6f 6465 3d31 2c0a 2020 2020 2020 2020  mode=1,.        
-00008790: 2020 2020 6c61 7965 7273 313d 4e6f 6e65      layers1=None
-000087a0: 2c0a 2020 2020 2020 2020 2020 2020 6c61  ,.            la
-000087b0: 7965 7273 323d 4e6f 6e65 2c0a 2020 2020  yers2=None,.    
-000087c0: 2020 2020 2020 2020 7765 6967 6874 3d46          weight=F
-000087d0: 616c 7365 2c0a 2020 2020 2020 2020 2020  alse,.          
-000087e0: 2020 636d 6f64 653d 5472 7565 2c0a 2020    cmode=True,.  
-000087f0: 2020 293a 0a20 2020 2020 2020 2022 2222    ):.        """
-00008800: 4361 6c63 756c 6174 6520 7468 6520 6d75  Calculate the mu
-00008810: 7475 616c 2069 6e66 6f72 6d61 7469 6f6e  tual information
-00008820: 2073 636f 7265 2062 6574 7765 656e 2074   score between t
-00008830: 776f 204d 6170 2069 6e73 7461 6e63 6573  wo Map instances
-00008840: 2e0a 0a20 2020 2020 2020 2041 7267 756d  ...        Argum
-00008850: 656e 7473 3a0a 2020 2020 2020 2020 2020  ents:.          
-00008860: 2020 6d61 705f 7461 7267 6574 2c20 6d61    map_target, ma
-00008870: 705f 7072 6f62 653a 204d 6170 2069 6e73  p_probe: Map ins
-00008880: 7461 6e63 6520 746f 2063 6f6d 7061 7265  tance to compare
-00008890: 2e0a 2020 2020 2020 2020 2020 2020 6d61  ..            ma
-000088a0: 705f 7461 7267 6574 5f74 6872 6573 686f  p_target_thresho
-000088b0: 6c64 2c20 6d61 705f 7072 6f62 655f 7468  ld, map_probe_th
-000088c0: 7265 7368 6f6c 643a 2054 6872 6573 686f  reshold: Thresho
-000088d0: 6c64 2075 7365 6420 666f 720a 2020 2020  ld used for.    
-000088e0: 2020 2020 2020 2020 2020 2020 636f 6e74              cont
-000088f0: 6f75 7269 6e67 0a20 2020 2020 2020 2020  ouring.         
-00008900: 2020 206d 6f64 653a 0a20 2020 2020 2020     mode:.       
-00008910: 2020 2020 2020 2020 2031 2e20 7573 6520           1. use 
-00008920: 636f 6d70 6c65 7465 206d 6170 2066 6f72  complete map for
-00008930: 2063 616c 6375 6c61 7469 6f6e 0a20 2020   calculation.   
-00008940: 2020 2020 2020 2020 2020 2020 2033 2e20               3. 
-00008950: 7573 6520 6f76 6572 6c61 7020 7265 6769  use overlap regi
-00008960: 6f6e 2066 6f72 2063 616c 6375 6c61 7469  on for calculati
-00008970: 6f6e 0a20 2020 2020 2020 2020 2020 206c  on.            l
-00008980: 6179 6572 7331 3a20 4e75 6d62 6572 206f  ayers1: Number o
-00008990: 6620 6c61 7965 7273 2075 7365 6420 746f  f layers used to
-000089a0: 2062 696e 206d 6170 5f74 6172 6765 742e   bin map_target.
-000089b0: 2049 6620 4e6f 6e65 2c20 7661 6c75 650a   If None, value.
-000089c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000089d0: 6973 2063 616c 6375 6c61 7465 6420 6261  is calculated ba
-000089e0: 7365 6420 6f6e 2053 7475 7267 6573 2c20  sed on Sturges, 
-000089f0: 3139 3236 206d 6574 686f 642e 0a20 2020  1926 method..   
-00008a00: 2020 2020 2020 2020 206c 6179 6572 7332           layers2
-00008a10: 3a20 4e75 6d62 6572 206f 6620 6c61 7965  : Number of laye
-00008a20: 7273 2075 7365 6420 746f 2062 696e 206d  rs used to bin m
-00008a30: 6170 5f70 726f 6265 2e20 4966 204e 6f6e  ap_probe. If Non
-00008a40: 652c 2076 616c 7565 0a20 2020 2020 2020  e, value.       
-00008a50: 2020 2020 2020 2020 2069 7320 6361 6c63           is calc
-00008a60: 756c 6174 6564 2062 6173 6564 206f 6e20  ulated based on 
-00008a70: 5374 7572 6765 732c 2031 3932 3620 6d65  Sturges, 1926 me
-00008a80: 7468 6f64 2e0a 2020 2020 2020 2020 2020  thod..          
-00008a90: 2020 7765 6967 6874 3a20 4966 2054 7275    weight: If Tru
-00008aa0: 653a 206e 6f72 6d61 6c69 7365 6420 4d49  e: normalised MI
-00008ab0: 2028 5374 7564 686f 6c6d 6520 6574 2061   (Studholme et a
-00008ac0: 6c2e 2920 6973 2075 7365 6420 746f 0a20  l.) is used to. 
-00008ad0: 2020 2020 2020 2020 2020 2020 2020 2061                 a
-00008ae0: 6363 6f75 6e74 2066 6f72 206f 7665 726c  ccount for overl
-00008af0: 6170 206f 6620 2763 6f6e 746f 7572 7327  ap of 'contours'
-00008b00: 0a20 2020 2020 2020 2020 2020 2063 6d6f  .            cmo
-00008b10: 6465 3a0a 2020 2020 2020 2020 5265 7475  de:.        Retu
-00008b20: 726e 733a 0a20 2020 2020 2020 2020 2020  rns:.           
-00008b30: 204d 4920 7363 6f72 650a 2020 2020 2020   MI score.      
-00008b40: 2020 5261 6973 6573 3a0a 2020 2020 2020    Raises:.      
-00008b50: 2020 2020 2020 7379 732e 6578 6974 3a20        sys.exit: 
-00008b60: 496e 7075 7420 6d61 7073 2064 6f20 6e6f  Input maps do no
-00008b70: 7420 6d61 7463 6820 696e 2073 6861 7065  t match in shape
-00008b80: 2c20 7069 7865 6c20 7369 7a65 206f 7220  , pixel size or 
-00008b90: 6f72 6967 696e 0a20 2020 2020 2020 2022  origin.        "
-00008ba0: 2222 0a20 2020 2020 2020 2069 6620 6e6f  "".        if no
-00008bb0: 7420 7365 6c66 2e6d 6170 436f 6d70 6172  t self.mapCompar
-00008bc0: 6973 6f6e 286d 6170 5f74 6172 6765 742c  ison(map_target,
-00008bd0: 206d 6170 5f70 726f 6265 293a 0a20 2020   map_probe):.   
-00008be0: 2020 2020 2020 2020 2073 656c 662e 5f66           self._f
-00008bf0: 6169 6c65 645f 6d61 7463 6828 290a 2020  ailed_match().  
-00008c00: 2020 2020 2020 6966 206d 6170 5f74 6172        if map_tar
-00008c10: 6765 745f 7468 7265 7368 6f6c 6420 3d3d  get_threshold ==
-00008c20: 2030 2e30 3a0a 2020 2020 2020 2020 2020   0.0:.          
-00008c30: 2020 6d61 705f 7461 7267 6574 5f74 6872    map_target_thr
-00008c40: 6573 686f 6c64 203d 2073 656c 662e 6361  eshold = self.ca
-00008c50: 6c63 756c 6174 655f 6d61 705f 7468 7265  lculate_map_thre
-00008c60: 7368 6f6c 6428 6d61 705f 7461 7267 6574  shold(map_target
-00008c70: 290a 2020 2020 2020 2020 6966 206d 6170  ).        if map
-00008c80: 5f70 726f 6265 5f74 6872 6573 686f 6c64  _probe_threshold
-00008c90: 203d 3d20 302e 303a 0a20 2020 2020 2020   == 0.0:.       
-00008ca0: 2020 2020 206d 6170 5f70 726f 6265 5f74       map_probe_t
-00008cb0: 6872 6573 686f 6c64 203d 2073 656c 662e  hreshold = self.
-00008cc0: 6361 6c63 756c 6174 655f 6d61 705f 7468  calculate_map_th
-00008cd0: 7265 7368 6f6c 6428 6d61 705f 7072 6f62  reshold(map_prob
-00008ce0: 6529 0a20 2020 2020 2020 2023 2063 616c  e).        # cal
-00008cf0: 6375 6c61 7469 6f6e 206f 6e20 7468 6520  culation on the 
-00008d00: 636f 6d70 6c65 7465 206d 6170 0a20 2020  complete map.   
-00008d10: 2020 2020 2069 6620 6d6f 6465 203d 3d20       if mode == 
-00008d20: 313a 0a20 2020 2020 2020 2020 2020 2069  1:.            i
-00008d30: 6620 7765 6967 6874 3a0a 2020 2020 2020  f weight:.      
-00008d40: 2020 2020 2020 2020 2020 7774 203d 2031            wt = 1
-00008d50: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
-00008d60: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-00008d70: 2020 2077 7420 3d20 300a 2020 2020 2020     wt = 0.      
-00008d80: 2020 2020 2020 6966 206c 6179 6572 7331        if layers1
-00008d90: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
-00008da0: 2020 2020 2020 2020 2020 6c61 7965 7273            layers
-00008db0: 3120 3d20 3230 0a20 2020 2020 2020 2020  1 = 20.         
-00008dc0: 2020 2069 6620 6c61 7965 7273 3220 6973     if layers2 is
-00008dd0: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
-00008de0: 2020 2020 2020 206c 6179 6572 7332 203d         layers2 =
-00008df0: 2032 300a 2020 2020 2020 2020 2020 2020   20.            
-00008e00: 6d69 6e31 203d 2028 0a20 2020 2020 2020  min1 = (.       
-00008e10: 2020 2020 2020 2020 2020 2020 206e 702e               np.
-00008e20: 616d 696e 286d 6170 5f74 6172 6765 742e  amin(map_target.
-00008e30: 6675 6c6c 4d61 7029 202d 0a20 2020 2020  fullMap) -.     
-00008e40: 2020 2020 2020 2020 2020 2020 2020 2030                 0
-00008e50: 2e30 3030 3031 202a 0a20 2020 2020 2020  .00001 *.       
-00008e60: 2020 2020 2020 2020 2020 2020 2028 6e70               (np
-00008e70: 2e61 6d61 7828 6d61 705f 7461 7267 6574  .amax(map_target
-00008e80: 2e66 756c 6c4d 6170 2920 2d20 6e70 2e61  .fullMap) - np.a
-00008e90: 6d69 6e28 6d61 705f 7461 7267 6574 2e66  min(map_target.f
-00008ea0: 756c 6c4d 6170 2929 0a20 2020 2020 2020  ullMap)).       
-00008eb0: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
-00008ec0: 2020 206d 696e 3220 3d20 280a 2020 2020     min2 = (.    
-00008ed0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008ee0: 6e70 2e61 6d69 6e28 6d61 705f 7072 6f62  np.amin(map_prob
-00008ef0: 652e 6675 6c6c 4d61 7029 202d 0a20 2020  e.fullMap) -.   
-00008f00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008f10: 2030 2e30 3030 3031 202a 0a20 2020 2020   0.00001 *.     
-00008f20: 2020 2020 2020 2020 2020 2020 2020 2028                 (
-00008f30: 6e70 2e61 6d61 7828 6d61 705f 7072 6f62  np.amax(map_prob
-00008f40: 652e 6675 6c6c 4d61 7029 202d 206e 702e  e.fullMap) - np.
-00008f50: 616d 696e 286d 6170 5f70 726f 6265 2e66  amin(map_probe.f
-00008f60: 756c 6c4d 6170 2929 0a20 2020 2020 2020  ullMap)).       
-00008f70: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
-00008f80: 2020 2069 6620 636d 6f64 653a 0a20 2020     if cmode:.   
-00008f90: 2020 2020 2020 2020 2020 2020 206d 6963               mic
-00008fa0: 203d 2073 656c 662e 5f4d 495f 4328 0a20   = self._MI_C(. 
-00008fb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008fc0: 2020 206d 6170 5f74 6172 6765 742e 6675     map_target.fu
-00008fd0: 6c6c 4d61 702c 0a20 2020 2020 2020 2020  llMap,.         
-00008fe0: 2020 2020 2020 2020 2020 206d 6170 5f70             map_p
-00008ff0: 726f 6265 2e66 756c 6c4d 6170 2c0a 2020  robe.fullMap,.  
-00009000: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009010: 2020 6c61 7965 7273 312c 0a20 2020 2020    layers1,.     
-00009020: 2020 2020 2020 2020 2020 2020 2020 206c                 l
-00009030: 6179 6572 7332 2c0a 2020 2020 2020 2020  ayers2,.        
-00009040: 2020 2020 2020 2020 2020 2020 7774 2c0a              wt,.
-00009050: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009060: 2020 2020 6d69 6e31 2c0a 2020 2020 2020      min1,.      
-00009070: 2020 2020 2020 2020 2020 2020 2020 6d69                mi
-00009080: 6e32 0a20 2020 2020 2020 2020 2020 2020  n2.             
-00009090: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
-000090a0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-000090b0: 2020 2020 2020 206d 6963 203d 204e 6f6e         mic = Non
-000090c0: 650a 2020 2020 2020 2020 2020 2020 6966  e.            if
-000090d0: 206d 6963 2069 7320 6e6f 7420 4e6f 6e65   mic is not None
-000090e0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-000090f0: 2020 7265 7475 726e 206d 6963 0a20 2020    return mic.   
-00009100: 2020 2020 2020 2020 2023 2064 6967 6974           # digit
-00009110: 697a 6520 7768 6f6c 6520 6d61 7020 6261  ize whole map ba
-00009120: 7365 6420 6f6e 206c 6179 6572 730a 2020  sed on layers.  
-00009130: 2020 2020 2020 2020 2020 6d61 7031 5f62            map1_b
-00009140: 696e 203d 206d 6170 5f74 6172 6765 742e  in = map_target.
-00009150: 5f6d 6170 5f64 6967 6974 697a 6528 0a20  _map_digitize(. 
-00009160: 2020 2020 2020 2020 2020 2020 2020 206d                 m
-00009170: 6170 5f74 6172 6765 742e 6d69 6e28 292c  ap_target.min(),
-00009180: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00009190: 206c 6179 6572 7331 2c0a 2020 2020 2020   layers1,.      
-000091a0: 2020 2020 2020 2020 2020 5472 7565 2c0a            True,.
-000091b0: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
-000091c0: 2020 2020 2020 2020 2020 6d61 7032 5f62            map2_b
-000091d0: 696e 203d 206d 6170 5f70 726f 6265 2e5f  in = map_probe._
-000091e0: 6d61 705f 6469 6769 7469 7a65 286d 6170  map_digitize(map
-000091f0: 5f70 726f 6265 2e6d 696e 2829 2c20 6c61  _probe.min(), la
-00009200: 7965 7273 322c 2054 7275 6529 0a20 2020  yers2, True).   
-00009210: 2020 2020 2020 2020 2062 696e 7331 203d           bins1 =
-00009220: 205b 5d0a 2020 2020 2020 2020 2020 2020   [].            
-00009230: 666f 7220 6920 696e 2072 616e 6765 286c  for i in range(l
-00009240: 6179 6572 7331 2b32 293a 0a20 2020 2020  ayers1+2):.     
-00009250: 2020 2020 2020 2020 2020 2062 696e 7331             bins1
-00009260: 2e61 7070 656e 6428 6929 0a20 2020 2020  .append(i).     
-00009270: 2020 2020 2020 2062 696e 7332 203d 205b         bins2 = [
-00009280: 5d0a 2020 2020 2020 2020 2020 2020 666f  ].            fo
-00009290: 7220 6920 696e 2072 616e 6765 286c 6179  r i in range(lay
-000092a0: 6572 7332 2b32 293a 0a20 2020 2020 2020  ers2+2):.       
-000092b0: 2020 2020 2020 2020 2062 696e 7332 2e61           bins2.a
-000092c0: 7070 656e 6428 6929 0a20 2020 2020 2020  ppend(i).       
-000092d0: 2020 2020 2023 2063 616c 6375 6c61 7465       # calculate
-000092e0: 2066 7265 7175 656e 6379 206f 6620 6269   frequency of bi
-000092f0: 6e73 0a20 2020 2020 2020 2020 2020 206d  ns.            m
-00009300: 6170 315f 6672 6571 203d 206e 702e 6869  ap1_freq = np.hi
-00009310: 7374 6f67 7261 6d28 6d61 7031 5f62 696e  stogram(map1_bin
-00009320: 2e66 756c 6c4d 6170 2c20 6269 6e73 3129  .fullMap, bins1)
-00009330: 5b30 5d5b 313a 5d0a 2020 2020 2020 2020  [0][1:].        
-00009340: 2020 2020 6d61 7032 5f66 7265 7120 3d20      map2_freq = 
-00009350: 6e70 2e68 6973 746f 6772 616d 286d 6170  np.histogram(map
-00009360: 325f 6269 6e2e 6675 6c6c 4d61 702c 2062  2_bin.fullMap, b
-00009370: 696e 7332 295b 305d 5b31 3a5d 0a20 2020  ins2)[0][1:].   
-00009380: 2020 2020 2065 6c69 6620 6d6f 6465 203d       elif mode =
-00009390: 3d20 333a 0a20 2020 2020 2020 2020 2020  = 3:.           
-000093a0: 206d 6173 6b5f 6172 7261 7920 3d20 7365   mask_array = se
-000093b0: 6c66 2e5f 6f76 6572 6c61 705f 6d61 705f  lf._overlap_map_
-000093c0: 6172 7261 7928 0a20 2020 2020 2020 2020  array(.         
-000093d0: 2020 2020 2020 206d 6170 5f74 6172 6765         map_targe
-000093e0: 742c 0a20 2020 2020 2020 2020 2020 2020  t,.             
-000093f0: 2020 206d 6170 5f74 6172 6765 745f 7468     map_target_th
-00009400: 7265 7368 6f6c 642c 0a20 2020 2020 2020  reshold,.       
-00009410: 2020 2020 2020 2020 206d 6170 5f70 726f           map_pro
-00009420: 6265 2c0a 2020 2020 2020 2020 2020 2020  be,.            
-00009430: 2020 2020 6d61 705f 7072 6f62 655f 7468      map_probe_th
-00009440: 7265 7368 6f6c 640a 2020 2020 2020 2020  reshold.        
-00009450: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
-00009460: 2020 6966 206e 702e 7375 6d28 6d61 736b    if np.sum(mask
-00009470: 5f61 7272 6179 2920 3d3d 2030 3a0a 2020  _array) == 0:.  
-00009480: 2020 2020 2020 2020 2020 2020 2020 7072                pr
-00009490: 696e 7428 0a20 2020 2020 2020 2020 2020  int(.           
-000094a0: 2020 2020 2020 2020 2027 4e6f 206d 6170           'No map
-000094b0: 206f 7665 726c 6170 2028 4d75 7475 616c   overlap (Mutual
-000094c0: 2069 6e66 6f72 6d61 7469 6f6e 2073 636f   information sco
-000094d0: 7265 292c 2065 7869 7469 6e67 2073 636f  re), exiting sco
-000094e0: 7265 2027 0a20 2020 2020 2020 2020 2020  re '.           
-000094f0: 2020 2020 2020 2020 2027 6361 6c63 756c           'calcul
-00009500: 6174 696f 6e2e 2e27 0a20 2020 2020 2020  ation..'.       
-00009510: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
-00009520: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-00009530: 6e20 302e 300a 2020 2020 2020 2020 2020  n 0.0.          
-00009540: 2020 2320 7374 7572 6765 7320 7275 6c65    # sturges rule
-00009550: 2070 726f 7669 6465 7320 6120 7761 7920   provides a way 
-00009560: 6f66 2063 616c 6375 6c61 7469 6e67 206e  of calculating n
-00009570: 756d 6265 7220 6f66 2062 696e 7320 3a0a  umber of bins :.
-00009580: 2020 2020 2020 2020 2020 2020 2320 3120              # 1 
-00009590: 2b20 6d61 7468 2e6c 6f67 286e 756d 6265  + math.log(numbe
-000095a0: 7220 6f66 2070 6f69 6e74 7329 0a20 2020  r of points).   
-000095b0: 2020 2020 2020 2020 2069 6620 6c61 7965           if laye
-000095c0: 7273 3120 6973 204e 6f6e 653a 0a20 2020  rs1 is None:.   
-000095d0: 2020 2020 2020 2020 2020 2020 2074 7279               try
-000095e0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-000095f0: 2020 2020 2020 6c61 7965 7273 3120 3d20        layers1 = 
-00009600: 696e 7428 3120 2b20 6d61 7468 2e6c 6f67  int(1 + math.log
-00009610: 286e 702e 7375 6d28 6d61 736b 5f61 7272  (np.sum(mask_arr
-00009620: 6179 292c 2032 2929 0a20 2020 2020 2020  ay), 2)).       
-00009630: 2020 2020 2020 2020 2065 7863 6570 7420           except 
-00009640: 5661 6c75 6545 7272 6f72 3a0a 2020 2020  ValueError:.    
+000079b0: 2020 2028 762e 782c 2076 2e79 2c20 762e     (v.x, v.y, v.
+000079c0: 7a29 0a20 2020 2020 2020 2020 2020 2020  z).             
+000079d0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+000079e0: 2069 6620 6c65 6e28 7363 6f72 6573 2920   if len(scores) 
+000079f0: 3d3d 2030 3a0a 2020 2020 2020 2020 2020  == 0:.          
+00007a00: 2020 7072 696e 7428 0a20 2020 2020 2020    print(.       
+00007a10: 2020 2020 2020 2020 2027 5468 6572 6520           'There 
+00007a20: 6172 6520 6e6f 2070 6f69 6e74 7320 746f  are no points to
+00007a30: 2062 6520 7363 6f72 6564 2120 5468 6520   be scored! The 
+00007a40: 7468 7265 7368 6f6c 6420 7661 6c75 6573  threshold values
+00007a50: 206f 7220 270a 2020 2020 2020 2020 2020   or '.          
+00007a60: 2020 2020 2020 2774 6865 206e 756d 6265        'the numbe
+00007a70: 7220 6f66 2070 6f69 6e74 7320 746f 2062  r of points to b
+00007a80: 6520 636f 6e73 6964 6572 6564 206e 6565  e considered nee
+00007a90: 6473 2074 6f20 6265 2063 6861 6e67 6564  ds to be changed
+00007aa0: 2e27 0a20 2020 2020 2020 2020 2020 2029  .'.            )
+00007ab0: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
+00007ac0: 2020 2020 2020 2020 2020 2069 6620 7375             if su
+00007ad0: 6d28 7363 6f72 6573 2920 3d3d 2030 3a0a  m(scores) == 0:.
+00007ae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007af0: 7265 7475 726e 2030 0a20 2020 2020 2020  return 0.       
+00007b00: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+00007b10: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+00007b20: 6e20 3120 2d20 2873 756d 2873 636f 7265  n 1 - (sum(score
+00007b30: 7329 202f 2028 6c65 6e28 706f 696e 7473  s) / (len(points
+00007b40: 2920 2a20 332e 3134 2929 0a0a 2020 2020  ) * 3.14))..    
+00007b50: 6465 6620 6765 745f 7061 7274 6961 6c5f  def get_partial_
+00007b60: 444c 5346 280a 2020 2020 2020 2020 2020  DLSF(.          
+00007b70: 2020 7365 6c66 2c0a 2020 2020 2020 2020    self,.        
+00007b80: 2020 2020 6e75 6d5f 6f66 5f70 6f69 6e74      num_of_point
+00007b90: 732c 0a20 2020 2020 2020 2020 2020 206d  s,.            m
+00007ba0: 6170 5f74 6172 6765 742c 0a20 2020 2020  ap_target,.     
+00007bb0: 2020 2020 2020 206d 6170 5f70 726f 6265         map_probe
+00007bc0: 0a20 2020 2029 3a0a 2020 2020 2020 2020  .    ):.        
+00007bd0: 2222 2243 616c 6375 6c61 7465 2074 6865  """Calculate the
+00007be0: 2044 4c53 4620 7363 6f72 6520 6265 7477   DLSF score betw
+00007bf0: 6565 6e20 7477 6f20 4d61 7020 696e 7374  een two Map inst
+00007c00: 616e 6365 732e 0a0a 2020 2020 2020 2020  ances...        
+00007c10: 5468 6520 444c 5346 2069 7320 7369 6d69  The DLSF is simi
+00007c20: 6c61 7220 746f 2074 6865 204c 5346 3b0a  lar to the LSF;.
+00007c30: 2020 2020 2020 2020 7768 6572 6561 7320          whereas 
+00007c40: 7468 6520 4c53 4620 636f 6d70 6172 6573  the LSF compares
+00007c50: 2061 6273 6f6c 7574 6520 6465 6e73 6974   absolute densit
+00007c60: 7920 7661 6c75 6573 2c0a 2020 2020 2020  y values,.      
+00007c70: 2020 7468 6520 444c 5346 2063 6f6d 7061    the DLSF compa
+00007c80: 7265 7320 7468 6520 6469 6666 6572 656e  res the differen
+00007c90: 6365 2062 6574 7765 656e 2070 6169 7273  ce between pairs
+00007ca0: 206f 6620 7661 6c75 6573 2e0a 0a20 2020   of values...   
+00007cb0: 2020 2020 2041 7267 756d 656e 7473 3a0a       Arguments:.
+00007cc0: 2020 2020 2020 2020 2020 2020 6d61 705f              map_
+00007cd0: 7461 7267 6574 2c20 6d61 705f 7072 6f62  target, map_prob
+00007ce0: 653a 204d 6170 2069 6e73 7461 6e63 6573  e: Map instances
+00007cf0: 2074 6f20 636f 6d70 6172 652e 0a20 2020   to compare..   
+00007d00: 2020 2020 2020 2020 206e 756d 5f6f 665f           num_of_
+00007d10: 706f 696e 7473 3a20 4e75 6d62 6572 206f  points: Number o
+00007d20: 6620 7369 676e 6966 6963 616e 7420 706f  f significant po
+00007d30: 696e 7473 2e0a 2020 2020 2020 2020 5265  ints..        Re
+00007d40: 7475 726e 3a0a 2020 2020 2020 2020 2020  turn:.          
+00007d50: 2020 444c 5346 2073 636f 7265 2c20 6f72    DLSF score, or
+00007d60: 2073 7472 696e 6720 2263 616e 2774 206d   string "can't m
+00007d70: 6174 6368 2074 6865 206d 6170 2220 6966  atch the map" if
+00007d80: 2049 6e70 7574 206d 6170 7320 646f 206e   Input maps do n
+00007d90: 6f74 0a20 2020 2020 2020 2020 2020 206d  ot.            m
+00007da0: 6174 6368 2069 6e20 7368 6170 652c 2070  atch in shape, p
+00007db0: 6978 656c 2073 697a 6520 6f72 206f 7269  ixel size or ori
+00007dc0: 6769 6e0a 2020 2020 2020 2020 2222 220a  gin.        """.
+00007dd0: 0a20 2020 2020 2020 2069 6620 6e6f 7420  .        if not 
+00007de0: 7365 6c66 2e6d 6170 436f 6d70 6172 6973  self.mapComparis
+00007df0: 6f6e 286d 6170 5f74 6172 6765 742c 206d  on(map_target, m
+00007e00: 6170 5f70 726f 6265 293a 0a20 2020 2020  ap_probe):.     
+00007e10: 2020 2020 2020 2072 6574 7572 6e20 2263         return "c
+00007e20: 616e 2774 204d 6174 6368 2074 6865 206d  an't Match the m
+00007e30: 6170 220a 0a20 2020 2020 2020 206d 6170  ap"..        map
+00007e40: 5f74 6172 6765 745f 7369 675f 7061 6972  _target_sig_pair
+00007e50: 7320 3d20 6d61 705f 7461 7267 6574 2e5f  s = map_target._
+00007e60: 6765 745f 7261 6e64 6f6d 5f73 6967 6e69  get_random_signi
+00007e70: 6669 6361 6e74 5f70 6169 7273 280a 2020  ficant_pairs(.  
+00007e80: 2020 2020 2020 2020 2020 696e 7428 6e75            int(nu
+00007e90: 6d5f 6f66 5f70 6f69 6e74 7329 0a20 2020  m_of_points).   
+00007ea0: 2020 2020 2029 0a20 2020 2020 2020 206f       ).        o
+00007eb0: 7468 6572 4d61 7020 3d20 6d61 705f 7072  therMap = map_pr
+00007ec0: 6f62 650a 2020 2020 2020 2020 7363 6f72  obe.        scor
+00007ed0: 6520 3d20 302e 300a 2020 2020 2020 2020  e = 0.0.        
+00007ee0: 666f 7220 7020 696e 206d 6170 5f74 6172  for p in map_tar
+00007ef0: 6765 745f 7369 675f 7061 6972 733a 0a20  get_sig_pairs:. 
+00007f00: 2020 2020 2020 2020 2020 207a 3120 3d20             z1 = 
+00007f10: 705b 305d 0a20 2020 2020 2020 2020 2020  p[0].           
+00007f20: 2079 3120 3d20 705b 315d 0a20 2020 2020   y1 = p[1].     
+00007f30: 2020 2020 2020 2078 3120 3d20 705b 325d         x1 = p[2]
+00007f40: 0a20 2020 2020 2020 2020 2020 207a 3220  .            z2 
+00007f50: 3d20 705b 335d 0a20 2020 2020 2020 2020  = p[3].         
+00007f60: 2020 2079 3220 3d20 705b 345d 0a20 2020     y2 = p[4].   
+00007f70: 2020 2020 2020 2020 2078 3220 3d20 705b           x2 = p[
+00007f80: 355d 0a20 2020 2020 2020 2020 2020 2064  5].            d
+00007f90: 656e 7320 3d20 705b 365d 0a20 2020 2020  ens = p[6].     
+00007fa0: 2020 2020 2020 2070 726f 745f 6465 6e73         prot_dens
+00007fb0: 203d 2028 0a20 2020 2020 2020 2020 2020   = (.           
+00007fc0: 2020 2020 206f 7468 6572 4d61 702e 6675       otherMap.fu
+00007fd0: 6c6c 4d61 705b 7a31 5d5b 7931 5d5b 7831  llMap[z1][y1][x1
+00007fe0: 5d20 2d20 6f74 6865 724d 6170 2e66 756c  ] - otherMap.ful
+00007ff0: 6c4d 6170 5b7a 325d 5b79 325d 5b78 325d  lMap[z2][y2][x2]
+00008000: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
+00008010: 2020 2020 2020 2020 2020 2073 636f 7265             score
+00008020: 202b 3d20 2864 656e 7320 2d20 7072 6f74   += (dens - prot
+00008030: 5f64 656e 7329 2a2a 320a 2020 2020 2020  _dens)**2.      
+00008040: 2020 7265 7475 726e 2073 636f 7265 202f    return score /
+00008050: 206d 6170 5f74 6172 6765 742e 6675 6c6c   map_target.full
+00008060: 4d61 702e 7369 7a65 0a0a 2020 2020 6465  Map.size..    de
+00008070: 6620 5f4d 4928 7365 6c66 2c20 6d61 705f  f _MI(self, map_
+00008080: 7461 7267 6574 2c20 6d61 705f 7072 6f62  target, map_prob
+00008090: 652c 206c 6179 6572 733d 3230 293a 0a20  e, layers=20):. 
+000080a0: 2020 2020 2020 2022 2222 4361 6c63 756c         """Calcul
+000080b0: 6174 6520 7468 6520 6d75 7475 616c 2069  ate the mutual i
+000080c0: 6e66 6f72 6d61 7469 6f6e 2073 636f 7265  nformation score
+000080d0: 2062 6574 7765 656e 2074 776f 204d 6170   between two Map
+000080e0: 732e 0a0a 2020 2020 2020 2020 4f6c 6420  s...        Old 
+000080f0: 7665 7273 696f 6e20 6f66 2074 6865 2073  version of the s
+00008100: 636f 7265 3f0a 0a20 2020 2020 2020 2041  core?..        A
+00008110: 7267 756d 656e 7473 3a0a 2020 2020 2020  rguments:.      
+00008120: 2020 2020 2020 6d61 705f 7461 7267 6574        map_target
+00008130: 2c20 6d61 705f 7072 6f62 653a 204d 6170  , map_probe: Map
+00008140: 2069 6e73 7461 6e63 6573 2074 6f20 636f   instances to co
+00008150: 6d70 6172 652e 0a0a 2020 2020 2020 2020  mpare...        
+00008160: 2020 2020 6c61 7965 7273 3a20 4e75 6d62      layers: Numb
+00008170: 6572 206f 6620 6c61 7965 7273 2075 7365  er of layers use
+00008180: 6420 746f 2062 696e 2074 6865 206d 6170  d to bin the map
+00008190: 2e20 4465 6661 756c 7420 6973 2032 3020  . Default is 20 
+000081a0: 6173 2069 6e0a 2020 2020 2020 2020 2020  as in.          
+000081b0: 2020 2020 2020 5368 6174 736b 7920 6574        Shatsky et
+000081c0: 2061 6c2e 2c20 3230 3038 2e0a 2020 2020   al., 2008..    
+000081d0: 2020 2020 5265 7475 726e 3a20 4d49 2073      Return: MI s
+000081e0: 636f 7265 0a20 2020 2020 2020 2052 6169  core.        Rai
+000081f0: 7365 733a 0a20 2020 2020 2020 2020 2020  ses:.           
+00008200: 2073 7973 2e65 7869 743a 2049 6e70 7574   sys.exit: Input
+00008210: 206d 6170 7320 646f 206e 6f74 206d 6174   maps do not mat
+00008220: 6368 2069 6e20 7368 6170 652c 2070 6978  ch in shape, pix
+00008230: 656c 2073 697a 6520 6f72 206f 7269 6769  el size or origi
+00008240: 6e0a 2020 2020 2020 2020 2222 220a 0a20  n.        """.. 
+00008250: 2020 2020 2020 2069 6620 7365 6c66 2e6d         if self.m
+00008260: 6170 436f 6d70 6172 6973 6f6e 286d 6170  apComparison(map
+00008270: 5f74 6172 6765 742c 206d 6170 5f70 726f  _target, map_pro
+00008280: 6265 293a 0a20 2020 2020 2020 2020 2020  be):.           
+00008290: 206d 312c 206d 3220 3d20 6d61 705f 7461   m1, m2 = map_ta
+000082a0: 7267 6574 2c20 6d61 705f 7072 6f62 650a  rget, map_probe.
+000082b0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+000082c0: 2020 2020 2020 2020 2020 7365 6c66 2e5f            self._
+000082d0: 6661 696c 6564 5f6d 6174 6368 2829 0a20  failed_match(). 
+000082e0: 2020 2020 2020 2073 636f 7265 203d 2030         score = 0
+000082f0: 0a20 2020 2020 2020 206d 315f 6c65 7665  .        m1_leve
+00008300: 6c73 203d 2028 6d31 2e6d 6178 2829 202d  ls = (m1.max() -
+00008310: 206d 312e 6d69 6e28 2929 202f 206c 6179   m1.min()) / lay
+00008320: 6572 730a 2020 2020 2020 2020 6d32 5f6c  ers.        m2_l
+00008330: 6576 656c 7320 3d20 286d 322e 6d61 7828  evels = (m2.max(
+00008340: 2920 2d20 6d32 2e6d 696e 2829 2920 2f20  ) - m2.min()) / 
+00008350: 6c61 7965 7273 0a20 2020 2020 2020 2066  layers.        f
+00008360: 6f72 2078 2069 6e20 7261 6e67 6528 6c61  or x in range(la
+00008370: 7965 7273 293a 0a20 2020 2020 2020 2020  yers):.         
+00008380: 2020 2066 6f72 2079 2069 6e20 7261 6e67     for y in rang
+00008390: 6528 6c61 7965 7273 293a 0a20 2020 2020  e(layers):.     
+000083a0: 2020 2020 2020 2020 2020 206d 315f 6c65             m1_le
+000083b0: 7665 6c5f 6d61 7020 3d20 280a 2020 2020  vel_map = (.    
+000083c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000083d0: 2020 2020 286d 312e 6765 744d 6170 2829      (m1.getMap()
+000083e0: 203e 3d20 6d31 2e6d 696e 2829 202b 2028   >= m1.min() + (
+000083f0: 7820 2a20 6d31 5f6c 6576 656c 7329 2920  x * m1_levels)) 
+00008400: 2a0a 2020 2020 2020 2020 2020 2020 2020  *.              
+00008410: 2020 2020 2020 2020 2020 286d 312e 6765            (m1.ge
+00008420: 744d 6170 2829 203c 3d20 6d31 2e6d 696e  tMap() <= m1.min
+00008430: 2829 202b 2028 2878 202b 2031 2920 2a20  () + ((x + 1) * 
+00008440: 6d31 5f6c 6576 656c 7329 290a 2020 2020  m1_levels)).    
+00008450: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+00008460: 2020 2020 2020 2020 2020 2020 2020 6d32                m2
+00008470: 5f6c 6576 656c 5f6d 6170 203d 2028 0a20  _level_map = (. 
+00008480: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008490: 2020 2020 2020 2028 6d32 2e67 6574 4d61         (m2.getMa
+000084a0: 7028 2920 3e3d 206d 322e 6d69 6e28 2920  p() >= m2.min() 
+000084b0: 2b20 2879 202a 206d 325f 6c65 7665 6c73  + (y * m2_levels
+000084c0: 2929 202a 0a20 2020 2020 2020 2020 2020  )) *.           
+000084d0: 2020 2020 2020 2020 2020 2020 2028 6d32               (m2
+000084e0: 2e67 6574 4d61 7028 2920 3c3d 206d 322e  .getMap() <= m2.
+000084f0: 6d69 6e28 2920 2b20 2828 7920 2b20 3129  min() + ((y + 1)
+00008500: 202a 206d 325f 6c65 7665 6c73 2929 0a20   * m2_levels)). 
+00008510: 2020 2020 2020 2020 2020 2020 2020 2029                 )
+00008520: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00008530: 2063 6f6d 625f 6c65 7665 6c5f 6d61 7020   comb_level_map 
+00008540: 3d20 6d31 5f6c 6576 656c 5f6d 6170 2a6d  = m1_level_map*m
+00008550: 325f 6c65 7665 6c5f 6d61 700a 2020 2020  2_level_map.    
+00008560: 2020 2020 2020 2020 2020 2020 705f 6d31              p_m1
+00008570: 203d 2066 6c6f 6174 286d 315f 6c65 7665   = float(m1_leve
+00008580: 6c5f 6d61 702e 7375 6d28 2929 2f6d 315f  l_map.sum())/m1_
+00008590: 6c65 7665 6c5f 6d61 702e 7369 7a65 0a20  level_map.size. 
+000085a0: 2020 2020 2020 2020 2020 2020 2020 2070                 p
+000085b0: 5f6d 3220 3d20 666c 6f61 7428 6d32 5f6c  _m2 = float(m2_l
+000085c0: 6576 656c 5f6d 6170 2e73 756d 2829 292f  evel_map.sum())/
+000085d0: 6d32 5f6c 6576 656c 5f6d 6170 2e73 697a  m2_level_map.siz
+000085e0: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
+000085f0: 2020 705f 636f 6d62 203d 2066 6c6f 6174    p_comb = float
+00008600: 2863 6f6d 625f 6c65 7665 6c5f 6d61 702e  (comb_level_map.
+00008610: 7375 6d28 2929 2f63 6f6d 625f 6c65 7665  sum())/comb_leve
+00008620: 6c5f 6d61 702e 7369 7a65 0a20 2020 2020  l_map.size.     
+00008630: 2020 2020 2020 2020 2020 2069 6620 705f             if p_
+00008640: 636f 6d62 203d 3d20 303a 0a20 2020 2020  comb == 0:.     
+00008650: 2020 2020 2020 2020 2020 2020 2020 206d                 m
+00008660: 695f 7363 6f72 6520 3d20 302e 300a 2020  i_score = 0.0.  
+00008670: 2020 2020 2020 2020 2020 2020 2020 656c                el
+00008680: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+00008690: 2020 2020 2020 2020 6d69 5f73 636f 7265          mi_score
+000086a0: 203d 2070 5f63 6f6d 6220 2a20 6d61 7468   = p_comb * math
+000086b0: 2e6c 6f67 2870 5f63 6f6d 6220 2f20 2870  .log(p_comb / (p
+000086c0: 5f6d 3120 2a20 705f 6d32 292c 2032 290a  _m1 * p_m2), 2).
+000086d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000086e0: 7363 6f72 6520 2b3d 206d 695f 7363 6f72  score += mi_scor
+000086f0: 650a 2020 2020 2020 2020 7265 7475 726e  e.        return
+00008700: 2073 636f 7265 0a0a 2020 2020 6465 6620   score..    def 
+00008710: 5f4d 495f 4328 0a20 2020 2020 2020 2020  _MI_C(.         
+00008720: 2020 2073 656c 662c 0a20 2020 2020 2020     self,.       
+00008730: 2020 2020 206d 312c 0a20 2020 2020 2020       m1,.       
+00008740: 2020 2020 206d 322c 0a20 2020 2020 2020       m2,.       
+00008750: 2020 2020 206c 6179 6572 7331 3d32 302c       layers1=20,
+00008760: 0a20 2020 2020 2020 2020 2020 206c 6179  .            lay
+00008770: 6572 7332 3d32 302c 0a20 2020 2020 2020  ers2=20,.       
+00008780: 2020 2020 204e 3d30 2c0a 2020 2020 2020       N=0,.      
+00008790: 2020 2020 2020 6c63 313d 302e 302c 0a20        lc1=0.0,. 
+000087a0: 2020 2020 2020 2020 2020 206c 6332 3d30             lc2=0
+000087b0: 2e30 2c0a 2020 2020 293a 0a20 2020 2020  .0,.    ):.     
+000087c0: 2020 2061 7272 3120 3d20 286d 3129 2e76     arr1 = (m1).v
+000087d0: 6965 7728 666c 6f61 7429 0a20 2020 2020  iew(float).     
+000087e0: 2020 2061 7272 3220 3d20 286d 3229 2e76     arr2 = (m2).v
+000087f0: 6965 7728 666c 6f61 7429 0a20 2020 2020  iew(float).     
+00008800: 2020 2072 6574 7572 6e20 5f4d 495f 435f     return _MI_C_
+00008810: 6865 6c70 6572 5f6e 6577 2861 7272 312c  helper_new(arr1,
+00008820: 2061 7272 322c 206c 6179 6572 7331 2c20   arr2, layers1, 
+00008830: 6c61 7965 7273 322c 204e 2c20 6c63 312c  layers2, N, lc1,
+00008840: 206c 6332 290a 0a20 2020 2064 6566 204d   lc2)..    def M
+00008850: 4928 0a20 2020 2020 2020 2020 2020 2073  I(.            s
+00008860: 656c 662c 0a20 2020 2020 2020 2020 2020  elf,.           
+00008870: 206d 6170 5f74 6172 6765 742c 0a20 2020   map_target,.   
+00008880: 2020 2020 2020 2020 206d 6170 5f70 726f           map_pro
+00008890: 6265 2c0a 2020 2020 2020 2020 2020 2020  be,.            
+000088a0: 6d61 705f 7461 7267 6574 5f74 6872 6573  map_target_thres
+000088b0: 686f 6c64 3d30 2e30 2c0a 2020 2020 2020  hold=0.0,.      
+000088c0: 2020 2020 2020 6d61 705f 7072 6f62 655f        map_probe_
+000088d0: 7468 7265 7368 6f6c 643d 302e 302c 0a20  threshold=0.0,. 
+000088e0: 2020 2020 2020 2020 2020 206d 6f64 653d             mode=
+000088f0: 312c 0a20 2020 2020 2020 2020 2020 206c  1,.            l
+00008900: 6179 6572 7331 3d4e 6f6e 652c 0a20 2020  ayers1=None,.   
+00008910: 2020 2020 2020 2020 206c 6179 6572 7332           layers2
+00008920: 3d4e 6f6e 652c 0a20 2020 2020 2020 2020  =None,.         
+00008930: 2020 2077 6569 6768 743d 4661 6c73 652c     weight=False,
+00008940: 0a20 2020 2020 2020 2020 2020 2063 6d6f  .            cmo
+00008950: 6465 3d54 7275 652c 0a20 2020 2029 3a0a  de=True,.    ):.
+00008960: 2020 2020 2020 2020 2222 2243 616c 6375          """Calcu
+00008970: 6c61 7465 2074 6865 206d 7574 7561 6c20  late the mutual 
+00008980: 696e 666f 726d 6174 696f 6e20 7363 6f72  information scor
+00008990: 6520 6265 7477 6565 6e20 7477 6f20 4d61  e between two Ma
+000089a0: 7020 696e 7374 616e 6365 732e 0a0a 2020  p instances...  
+000089b0: 2020 2020 2020 4172 6775 6d65 6e74 733a        Arguments:
+000089c0: 0a20 2020 2020 2020 2020 2020 206d 6170  .            map
+000089d0: 5f74 6172 6765 742c 206d 6170 5f70 726f  _target, map_pro
+000089e0: 6265 3a20 4d61 7020 696e 7374 616e 6365  be: Map instance
+000089f0: 2074 6f20 636f 6d70 6172 652e 0a20 2020   to compare..   
+00008a00: 2020 2020 2020 2020 206d 6170 5f74 6172           map_tar
+00008a10: 6765 745f 7468 7265 7368 6f6c 642c 206d  get_threshold, m
+00008a20: 6170 5f70 726f 6265 5f74 6872 6573 686f  ap_probe_thresho
+00008a30: 6c64 3a20 5468 7265 7368 6f6c 6420 7573  ld: Threshold us
+00008a40: 6564 2066 6f72 0a20 2020 2020 2020 2020  ed for.         
+00008a50: 2020 2020 2020 2063 6f6e 746f 7572 696e         contourin
+00008a60: 670a 2020 2020 2020 2020 2020 2020 6d6f  g.            mo
+00008a70: 6465 3a0a 2020 2020 2020 2020 2020 2020  de:.            
+00008a80: 2020 2020 312e 2075 7365 2063 6f6d 706c      1. use compl
+00008a90: 6574 6520 6d61 7020 666f 7220 6361 6c63  ete map for calc
+00008aa0: 756c 6174 696f 6e0a 2020 2020 2020 2020  ulation.        
+00008ab0: 2020 2020 2020 2020 332e 2075 7365 206f          3. use o
+00008ac0: 7665 726c 6170 2072 6567 696f 6e20 666f  verlap region fo
+00008ad0: 7220 6361 6c63 756c 6174 696f 6e0a 2020  r calculation.  
+00008ae0: 2020 2020 2020 2020 2020 6c61 7965 7273            layers
+00008af0: 313a 204e 756d 6265 7220 6f66 206c 6179  1: Number of lay
+00008b00: 6572 7320 7573 6564 2074 6f20 6269 6e20  ers used to bin 
+00008b10: 6d61 705f 7461 7267 6574 2e20 4966 204e  map_target. If N
+00008b20: 6f6e 652c 2076 616c 7565 0a20 2020 2020  one, value.     
+00008b30: 2020 2020 2020 2020 2020 2069 7320 6361             is ca
+00008b40: 6c63 756c 6174 6564 2062 6173 6564 206f  lculated based o
+00008b50: 6e20 5374 7572 6765 732c 2031 3932 3620  n Sturges, 1926 
+00008b60: 6d65 7468 6f64 2e0a 2020 2020 2020 2020  method..        
+00008b70: 2020 2020 6c61 7965 7273 323a 204e 756d      layers2: Num
+00008b80: 6265 7220 6f66 206c 6179 6572 7320 7573  ber of layers us
+00008b90: 6564 2074 6f20 6269 6e20 6d61 705f 7072  ed to bin map_pr
+00008ba0: 6f62 652e 2049 6620 4e6f 6e65 2c20 7661  obe. If None, va
+00008bb0: 6c75 650a 2020 2020 2020 2020 2020 2020  lue.            
+00008bc0: 2020 2020 6973 2063 616c 6375 6c61 7465      is calculate
+00008bd0: 6420 6261 7365 6420 6f6e 2053 7475 7267  d based on Sturg
+00008be0: 6573 2c20 3139 3236 206d 6574 686f 642e  es, 1926 method.
+00008bf0: 0a20 2020 2020 2020 2020 2020 2077 6569  .            wei
+00008c00: 6768 743a 2049 6620 5472 7565 3a20 6e6f  ght: If True: no
+00008c10: 726d 616c 6973 6564 204d 4920 2853 7475  rmalised MI (Stu
+00008c20: 6468 6f6c 6d65 2065 7420 616c 2e29 2069  dholme et al.) i
+00008c30: 7320 7573 6564 2074 6f0a 2020 2020 2020  s used to.      
+00008c40: 2020 2020 2020 2020 2020 6163 636f 756e            accoun
+00008c50: 7420 666f 7220 6f76 6572 6c61 7020 6f66  t for overlap of
+00008c60: 2027 636f 6e74 6f75 7273 270a 2020 2020   'contours'.    
+00008c70: 2020 2020 2020 2020 636d 6f64 653a 0a20          cmode:. 
+00008c80: 2020 2020 2020 2052 6574 7572 6e73 3a0a         Returns:.
+00008c90: 2020 2020 2020 2020 2020 2020 4d49 2073              MI s
+00008ca0: 636f 7265 0a20 2020 2020 2020 2052 6169  core.        Rai
+00008cb0: 7365 733a 0a20 2020 2020 2020 2020 2020  ses:.           
+00008cc0: 2073 7973 2e65 7869 743a 2049 6e70 7574   sys.exit: Input
+00008cd0: 206d 6170 7320 646f 206e 6f74 206d 6174   maps do not mat
+00008ce0: 6368 2069 6e20 7368 6170 652c 2070 6978  ch in shape, pix
+00008cf0: 656c 2073 697a 6520 6f72 206f 7269 6769  el size or origi
+00008d00: 6e0a 2020 2020 2020 2020 2222 220a 2020  n.        """.  
+00008d10: 2020 2020 2020 6966 206e 6f74 2073 656c        if not sel
+00008d20: 662e 6d61 7043 6f6d 7061 7269 736f 6e28  f.mapComparison(
+00008d30: 6d61 705f 7461 7267 6574 2c20 6d61 705f  map_target, map_
+00008d40: 7072 6f62 6529 3a0a 2020 2020 2020 2020  probe):.        
+00008d50: 2020 2020 7365 6c66 2e5f 6661 696c 6564      self._failed
+00008d60: 5f6d 6174 6368 2829 0a20 2020 2020 2020  _match().       
+00008d70: 2069 6620 6d61 705f 7461 7267 6574 5f74   if map_target_t
+00008d80: 6872 6573 686f 6c64 203d 3d20 302e 303a  hreshold == 0.0:
+00008d90: 0a20 2020 2020 2020 2020 2020 206d 6170  .            map
+00008da0: 5f74 6172 6765 745f 7468 7265 7368 6f6c  _target_threshol
+00008db0: 6420 3d20 7365 6c66 2e63 616c 6375 6c61  d = self.calcula
+00008dc0: 7465 5f6d 6170 5f74 6872 6573 686f 6c64  te_map_threshold
+00008dd0: 286d 6170 5f74 6172 6765 7429 0a20 2020  (map_target).   
+00008de0: 2020 2020 2069 6620 6d61 705f 7072 6f62       if map_prob
+00008df0: 655f 7468 7265 7368 6f6c 6420 3d3d 2030  e_threshold == 0
+00008e00: 2e30 3a0a 2020 2020 2020 2020 2020 2020  .0:.            
+00008e10: 6d61 705f 7072 6f62 655f 7468 7265 7368  map_probe_thresh
+00008e20: 6f6c 6420 3d20 7365 6c66 2e63 616c 6375  old = self.calcu
+00008e30: 6c61 7465 5f6d 6170 5f74 6872 6573 686f  late_map_thresho
+00008e40: 6c64 286d 6170 5f70 726f 6265 290a 2020  ld(map_probe).  
+00008e50: 2020 2020 2020 2320 6361 6c63 756c 6174        # calculat
+00008e60: 696f 6e20 6f6e 2074 6865 2063 6f6d 706c  ion on the compl
+00008e70: 6574 6520 6d61 700a 2020 2020 2020 2020  ete map.        
+00008e80: 6966 206d 6f64 6520 3d3d 2031 3a0a 2020  if mode == 1:.  
+00008e90: 2020 2020 2020 2020 2020 6966 2077 6569            if wei
+00008ea0: 6768 743a 0a20 2020 2020 2020 2020 2020  ght:.           
+00008eb0: 2020 2020 2077 7420 3d20 310a 2020 2020       wt = 1.    
+00008ec0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+00008ed0: 2020 2020 2020 2020 2020 2020 2020 7774                wt
+00008ee0: 203d 2030 0a20 2020 2020 2020 2020 2020   = 0.           
+00008ef0: 2069 6620 6c61 7965 7273 3120 6973 204e   if layers1 is N
+00008f00: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
+00008f10: 2020 2020 206c 6179 6572 7331 203d 2032       layers1 = 2
+00008f20: 300a 2020 2020 2020 2020 2020 2020 6966  0.            if
+00008f30: 206c 6179 6572 7332 2069 7320 4e6f 6e65   layers2 is None
+00008f40: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00008f50: 2020 6c61 7965 7273 3220 3d20 3230 0a20    layers2 = 20. 
+00008f60: 2020 2020 2020 2020 2020 206d 696e 3120             min1 
+00008f70: 3d20 280a 2020 2020 2020 2020 2020 2020  = (.            
+00008f80: 2020 2020 2020 2020 6e70 2e61 6d69 6e28          np.amin(
+00008f90: 6d61 705f 7461 7267 6574 2e66 756c 6c4d  map_target.fullM
+00008fa0: 6170 2920 2d0a 2020 2020 2020 2020 2020  ap) -.          
+00008fb0: 2020 2020 2020 2020 2020 302e 3030 3030            0.0000
+00008fc0: 3120 2a0a 2020 2020 2020 2020 2020 2020  1 *.            
+00008fd0: 2020 2020 2020 2020 286e 702e 616d 6178          (np.amax
+00008fe0: 286d 6170 5f74 6172 6765 742e 6675 6c6c  (map_target.full
+00008ff0: 4d61 7029 202d 206e 702e 616d 696e 286d  Map) - np.amin(m
+00009000: 6170 5f74 6172 6765 742e 6675 6c6c 4d61  ap_target.fullMa
+00009010: 7029 290a 2020 2020 2020 2020 2020 2020  p)).            
+00009020: 290a 2020 2020 2020 2020 2020 2020 6d69  ).            mi
+00009030: 6e32 203d 2028 0a20 2020 2020 2020 2020  n2 = (.         
+00009040: 2020 2020 2020 2020 2020 206e 702e 616d             np.am
+00009050: 696e 286d 6170 5f70 726f 6265 2e66 756c  in(map_probe.ful
+00009060: 6c4d 6170 2920 2d0a 2020 2020 2020 2020  lMap) -.        
+00009070: 2020 2020 2020 2020 2020 2020 302e 3030              0.00
+00009080: 3030 3120 2a0a 2020 2020 2020 2020 2020  001 *.          
+00009090: 2020 2020 2020 2020 2020 286e 702e 616d            (np.am
+000090a0: 6178 286d 6170 5f70 726f 6265 2e66 756c  ax(map_probe.ful
+000090b0: 6c4d 6170 2920 2d20 6e70 2e61 6d69 6e28  lMap) - np.amin(
+000090c0: 6d61 705f 7072 6f62 652e 6675 6c6c 4d61  map_probe.fullMa
+000090d0: 7029 290a 2020 2020 2020 2020 2020 2020  p)).            
+000090e0: 290a 2020 2020 2020 2020 2020 2020 6966  ).            if
+000090f0: 2063 6d6f 6465 3a0a 2020 2020 2020 2020   cmode:.        
+00009100: 2020 2020 2020 2020 6d69 6320 3d20 7365          mic = se
+00009110: 6c66 2e5f 4d49 5f43 280a 2020 2020 2020  lf._MI_C(.      
+00009120: 2020 2020 2020 2020 2020 2020 2020 6d61                ma
+00009130: 705f 7461 7267 6574 2e66 756c 6c4d 6170  p_target.fullMap
+00009140: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00009150: 2020 2020 2020 6d61 705f 7072 6f62 652e        map_probe.
+00009160: 6675 6c6c 4d61 702c 0a20 2020 2020 2020  fullMap,.       
+00009170: 2020 2020 2020 2020 2020 2020 206c 6179               lay
+00009180: 6572 7331 2c0a 2020 2020 2020 2020 2020  ers1,.          
+00009190: 2020 2020 2020 2020 2020 6c61 7965 7273            layers
+000091a0: 322c 0a20 2020 2020 2020 2020 2020 2020  2,.             
+000091b0: 2020 2020 2020 2077 742c 0a20 2020 2020         wt,.     
+000091c0: 2020 2020 2020 2020 2020 2020 2020 206d                 m
+000091d0: 696e 312c 0a20 2020 2020 2020 2020 2020  in1,.           
+000091e0: 2020 2020 2020 2020 206d 696e 320a 2020           min2.  
+000091f0: 2020 2020 2020 2020 2020 2020 2020 290a                ).
+00009200: 2020 2020 2020 2020 2020 2020 656c 7365              else
+00009210: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00009220: 2020 6d69 6320 3d20 4e6f 6e65 0a20 2020    mic = None.   
+00009230: 2020 2020 2020 2020 2069 6620 6d69 6320           if mic 
+00009240: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
+00009250: 2020 2020 2020 2020 2020 2020 2072 6574               ret
+00009260: 7572 6e20 6d69 630a 2020 2020 2020 2020  urn mic.        
+00009270: 2020 2020 2320 6469 6769 7469 7a65 2077      # digitize w
+00009280: 686f 6c65 206d 6170 2062 6173 6564 206f  hole map based o
+00009290: 6e20 6c61 7965 7273 0a20 2020 2020 2020  n layers.       
+000092a0: 2020 2020 206d 6170 315f 6269 6e20 3d20       map1_bin = 
+000092b0: 6d61 705f 7461 7267 6574 2e5f 6d61 705f  map_target._map_
+000092c0: 6469 6769 7469 7a65 280a 2020 2020 2020  digitize(.      
+000092d0: 2020 2020 2020 2020 2020 6d61 705f 7461            map_ta
+000092e0: 7267 6574 2e6d 696e 2829 2c0a 2020 2020  rget.min(),.    
+000092f0: 2020 2020 2020 2020 2020 2020 6c61 7965              laye
+00009300: 7273 312c 0a20 2020 2020 2020 2020 2020  rs1,.           
+00009310: 2020 2020 2054 7275 652c 0a20 2020 2020       True,.     
+00009320: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+00009330: 2020 2020 206d 6170 325f 6269 6e20 3d20       map2_bin = 
+00009340: 6d61 705f 7072 6f62 652e 5f6d 6170 5f64  map_probe._map_d
+00009350: 6967 6974 697a 6528 6d61 705f 7072 6f62  igitize(map_prob
+00009360: 652e 6d69 6e28 292c 206c 6179 6572 7332  e.min(), layers2
+00009370: 2c20 5472 7565 290a 2020 2020 2020 2020  , True).        
+00009380: 2020 2020 6269 6e73 3120 3d20 5b5d 0a20      bins1 = []. 
+00009390: 2020 2020 2020 2020 2020 2066 6f72 2069             for i
+000093a0: 2069 6e20 7261 6e67 6528 6c61 7965 7273   in range(layers
+000093b0: 312b 3229 3a0a 2020 2020 2020 2020 2020  1+2):.          
+000093c0: 2020 2020 2020 6269 6e73 312e 6170 7065        bins1.appe
+000093d0: 6e64 2869 290a 2020 2020 2020 2020 2020  nd(i).          
+000093e0: 2020 6269 6e73 3220 3d20 5b5d 0a20 2020    bins2 = [].   
+000093f0: 2020 2020 2020 2020 2066 6f72 2069 2069           for i i
+00009400: 6e20 7261 6e67 6528 6c61 7965 7273 322b  n range(layers2+
+00009410: 3229 3a0a 2020 2020 2020 2020 2020 2020  2):.            
+00009420: 2020 2020 6269 6e73 322e 6170 7065 6e64      bins2.append
+00009430: 2869 290a 2020 2020 2020 2020 2020 2020  (i).            
+00009440: 2320 6361 6c63 756c 6174 6520 6672 6571  # calculate freq
+00009450: 7565 6e63 7920 6f66 2062 696e 730a 2020  uency of bins.  
+00009460: 2020 2020 2020 2020 2020 6d61 7031 5f66            map1_f
+00009470: 7265 7120 3d20 6e70 2e68 6973 746f 6772  req = np.histogr
+00009480: 616d 286d 6170 315f 6269 6e2e 6675 6c6c  am(map1_bin.full
+00009490: 4d61 702c 2062 696e 7331 295b 305d 5b31  Map, bins1)[0][1
+000094a0: 3a5d 0a20 2020 2020 2020 2020 2020 206d  :].            m
+000094b0: 6170 325f 6672 6571 203d 206e 702e 6869  ap2_freq = np.hi
+000094c0: 7374 6f67 7261 6d28 6d61 7032 5f62 696e  stogram(map2_bin
+000094d0: 2e66 756c 6c4d 6170 2c20 6269 6e73 3229  .fullMap, bins2)
+000094e0: 5b30 5d5b 313a 5d0a 2020 2020 2020 2020  [0][1:].        
+000094f0: 656c 6966 206d 6f64 6520 3d3d 2033 3a0a  elif mode == 3:.
+00009500: 2020 2020 2020 2020 2020 2020 6d61 736b              mask
+00009510: 5f61 7272 6179 203d 2073 656c 662e 5f6f  _array = self._o
+00009520: 7665 726c 6170 5f6d 6170 5f61 7272 6179  verlap_map_array
+00009530: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00009540: 2020 6d61 705f 7461 7267 6574 2c0a 2020    map_target,.  
+00009550: 2020 2020 2020 2020 2020 2020 2020 6d61                ma
+00009560: 705f 7461 7267 6574 5f74 6872 6573 686f  p_target_thresho
+00009570: 6c64 2c0a 2020 2020 2020 2020 2020 2020  ld,.            
+00009580: 2020 2020 6d61 705f 7072 6f62 652c 0a20      map_probe,. 
+00009590: 2020 2020 2020 2020 2020 2020 2020 206d                 m
+000095a0: 6170 5f70 726f 6265 5f74 6872 6573 686f  ap_probe_thresho
+000095b0: 6c64 0a20 2020 2020 2020 2020 2020 2029  ld.            )
+000095c0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+000095d0: 6e70 2e73 756d 286d 6173 6b5f 6172 7261  np.sum(mask_arra
+000095e0: 7929 203d 3d20 303a 0a20 2020 2020 2020  y) == 0:.       
+000095f0: 2020 2020 2020 2020 2070 7269 6e74 280a           print(.
+00009600: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009610: 2020 2020 274e 6f20 6d61 7020 6f76 6572      'No map over
+00009620: 6c61 7020 284d 7574 7561 6c20 696e 666f  lap (Mutual info
+00009630: 726d 6174 696f 6e20 7363 6f72 6529 2c20  rmation score), 
+00009640: 6578 6974 696e 6720 7363 6f72 6520 270a  exiting score '.
 00009650: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009660: 7072 696e 7428 0a20 2020 2020 2020 2020  print(.         
-00009670: 2020 2020 2020 2020 2020 2020 2020 2027                 '
-00009680: 4e6f 206d 6170 206f 7665 726c 6170 2028  No map overlap (
-00009690: 4d75 7475 616c 2069 6e66 6f72 6d61 7469  Mutual informati
-000096a0: 6f6e 2073 636f 7265 292c 2027 0a20 2020  on score), '.   
-000096b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000096c0: 2020 2020 2027 6578 6974 696e 6720 7363       'exiting sc
-000096d0: 6f72 6520 6361 6c63 756c 6174 696f 6e2e  ore calculation.
-000096e0: 2e27 0a20 2020 2020 2020 2020 2020 2020  .'.             
-000096f0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-00009700: 2020 2020 2020 2020 2020 2020 2072 6574               ret
-00009710: 7572 6e20 302e 300a 2020 2020 2020 2020  urn 0.0.        
-00009720: 2020 2020 6966 206c 6179 6572 7332 2069      if layers2 i
+00009660: 2020 2020 2763 616c 6375 6c61 7469 6f6e      'calculation
+00009670: 2e2e 270a 2020 2020 2020 2020 2020 2020  ..'.            
+00009680: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
+00009690: 2020 2020 2020 7265 7475 726e 2030 2e30        return 0.0
+000096a0: 0a20 2020 2020 2020 2020 2020 2023 2073  .            # s
+000096b0: 7475 7267 6573 2072 756c 6520 7072 6f76  turges rule prov
+000096c0: 6964 6573 2061 2077 6179 206f 6620 6361  ides a way of ca
+000096d0: 6c63 756c 6174 696e 6720 6e75 6d62 6572  lculating number
+000096e0: 206f 6620 6269 6e73 203a 0a20 2020 2020   of bins :.     
+000096f0: 2020 2020 2020 2023 2031 202b 206d 6174         # 1 + mat
+00009700: 682e 6c6f 6728 6e75 6d62 6572 206f 6620  h.log(number of 
+00009710: 706f 696e 7473 290a 2020 2020 2020 2020  points).        
+00009720: 2020 2020 6966 206c 6179 6572 7331 2069      if layers1 i
 00009730: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
 00009740: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
 00009750: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009760: 206c 6179 6572 7332 203d 2069 6e74 2831   layers2 = int(1
+00009760: 206c 6179 6572 7331 203d 2069 6e74 2831   layers1 = int(1
 00009770: 202b 206d 6174 682e 6c6f 6728 6e70 2e73   + math.log(np.s
 00009780: 756d 286d 6173 6b5f 6172 7261 7929 2c20  um(mask_array), 
 00009790: 3229 290a 2020 2020 2020 2020 2020 2020  2)).            
 000097a0: 2020 2020 6578 6365 7074 2056 616c 7565      except Value
 000097b0: 4572 726f 723a 0a20 2020 2020 2020 2020  Error:.         
 000097c0: 2020 2020 2020 2020 2020 2070 7269 6e74             print
 000097d0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
 000097e0: 2020 2020 2020 2020 2020 274e 6f20 6d61            'No ma
 000097f0: 7020 6f76 6572 6c61 7020 284d 7574 7561  p overlap (Mutua
 00009800: 6c20 696e 666f 726d 6174 696f 6e20 7363  l information sc
-00009810: 6f72 6529 2c20 6578 6974 696e 6720 270a  ore), exiting '.
+00009810: 6f72 6529 2c20 270a 2020 2020 2020 2020  ore), '.        
 00009820: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009830: 2020 2020 2020 2020 2773 636f 7265 2063          'score c
+00009830: 2765 7869 7469 6e67 2073 636f 7265 2063  'exiting score c
 00009840: 616c 6375 6c61 7469 6f6e 2e2e 270a 2020  alculation..'.  
 00009850: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00009860: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
 00009870: 2020 2020 2020 2020 7265 7475 726e 2030          return 0
-00009880: 2e30 0a20 2020 2020 2020 2020 2020 206c  .0.            l
-00009890: 6179 6572 7331 203d 206d 6178 286c 6179  ayers1 = max(lay
-000098a0: 6572 7331 2c20 3135 290a 2020 2020 2020  ers1, 15).      
-000098b0: 2020 2020 2020 6c61 7965 7273 3220 3d20        layers2 = 
-000098c0: 6d61 7828 6c61 7965 7273 322c 2031 3529  max(layers2, 15)
-000098d0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-000098e0: 7765 6967 6874 3a0a 2020 2020 2020 2020  weight:.        
-000098f0: 2020 2020 2020 2020 7774 203d 2031 0a20          wt = 1. 
-00009900: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
-00009910: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00009920: 2077 7420 3d20 300a 2020 2020 2020 2020   wt = 0.        
-00009930: 2020 2020 6966 2063 6d6f 6465 3a0a 2020      if cmode:.  
-00009940: 2020 2020 2020 2020 2020 2020 2020 6d69                mi
-00009950: 6320 3d20 7365 6c66 2e5f 4d49 5f43 280a  c = self._MI_C(.
-00009960: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009970: 2020 2020 6e70 2e61 7272 6179 286d 6170      np.array(map
-00009980: 5f74 6172 6765 742e 6675 6c6c 4d61 7020  _target.fullMap 
-00009990: 2a20 6d61 736b 5f61 7272 6179 292c 0a20  * mask_array),. 
-000099a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000099b0: 2020 206e 702e 6172 7261 7928 6d61 705f     np.array(map_
-000099c0: 7072 6f62 652e 6675 6c6c 4d61 7020 2a20  probe.fullMap * 
-000099d0: 6d61 736b 5f61 7272 6179 292c 0a20 2020  mask_array),.   
-000099e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000099f0: 206c 6179 6572 7331 2c0a 2020 2020 2020   layers1,.      
-00009a00: 2020 2020 2020 2020 2020 2020 2020 6c61                la
-00009a10: 7965 7273 322c 0a20 2020 2020 2020 2020  yers2,.         
-00009a20: 2020 2020 2020 2020 2020 2077 742c 0a20             wt,. 
-00009a30: 2020 2020 2020 2020 2020 2020 2020 2029                 )
-00009a40: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
-00009a50: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-00009a60: 2020 206d 6963 203d 204e 6f6e 650a 2020     mic = None.  
-00009a70: 2020 2020 2020 2020 2020 6966 206d 6963            if mic
-00009a80: 2069 7320 6e6f 7420 4e6f 6e65 3a0a 2020   is not None:.  
-00009a90: 2020 2020 2020 2020 2020 2020 2020 7265                re
-00009aa0: 7475 726e 206d 6963 0a20 2020 2020 2020  turn mic.       
-00009ab0: 2020 2020 2023 2064 6967 6974 697a 6520       # digitize 
-00009ac0: 6d61 736b 6564 206d 6170 2062 6173 6564  masked map based
-00009ad0: 206f 6e20 6c61 7965 7273 0a20 2020 2020   on layers.     
-00009ae0: 2020 2020 2020 206d 6170 315f 6269 6e20         map1_bin 
-00009af0: 3d20 6d61 705f 7461 7267 6574 2e63 6f70  = map_target.cop
-00009b00: 7928 290a 2020 2020 2020 2020 2020 2020  y().            
-00009b10: 6d61 7032 5f62 696e 203d 206d 6170 5f70  map2_bin = map_p
-00009b20: 726f 6265 2e63 6f70 7928 290a 2020 2020  robe.copy().    
-00009b30: 2020 2020 2020 2020 6d61 7031 5f62 696e          map1_bin
-00009b40: 2e66 756c 6c4d 6170 203d 206d 6170 315f  .fullMap = map1_
-00009b50: 6269 6e2e 6675 6c6c 4d61 7020 2a20 6d61  bin.fullMap * ma
-00009b60: 736b 5f61 7272 6179 0a20 2020 2020 2020  sk_array.       
-00009b70: 2020 2020 206d 6170 325f 6269 6e2e 6675       map2_bin.fu
-00009b80: 6c6c 4d61 7020 3d20 6d61 7032 5f62 696e  llMap = map2_bin
-00009b90: 2e66 756c 6c4d 6170 202a 206d 6173 6b5f  .fullMap * mask_
-00009ba0: 6172 7261 790a 2020 2020 2020 2020 2020  array.          
-00009bb0: 2020 6d61 7031 5f62 696e 203d 206d 6170    map1_bin = map
-00009bc0: 315f 6269 6e2e 5f6d 6170 5f64 6967 6974  1_bin._map_digit
-00009bd0: 697a 6528 0a20 2020 2020 2020 2020 2020  ize(.           
-00009be0: 2020 2020 206d 6170 5f74 6172 6765 742e       map_target.
-00009bf0: 6675 6c6c 4d61 705b 6d61 736b 5f61 7272  fullMap[mask_arr
-00009c00: 6179 5d2e 6d69 6e28 292c 0a20 2020 2020  ay].min(),.     
-00009c10: 2020 2020 2020 2020 2020 206c 6179 6572             layer
-00009c20: 7331 2c0a 2020 2020 2020 2020 2020 2020  s1,.            
-00009c30: 2020 2020 5472 7565 0a20 2020 2020 2020      True.       
-00009c40: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
-00009c50: 2020 206d 6170 325f 6269 6e20 3d20 6d61     map2_bin = ma
-00009c60: 7032 5f62 696e 2e5f 6d61 705f 6469 6769  p2_bin._map_digi
-00009c70: 7469 7a65 280a 2020 2020 2020 2020 2020  tize(.          
-00009c80: 2020 2020 2020 6d61 705f 7072 6f62 652e        map_probe.
-00009c90: 6675 6c6c 4d61 705b 6d61 736b 5f61 7272  fullMap[mask_arr
-00009ca0: 6179 5d2e 6d69 6e28 292c 0a20 2020 2020  ay].min(),.     
-00009cb0: 2020 2020 2020 2020 2020 206c 6179 6572             layer
-00009cc0: 7332 2c0a 2020 2020 2020 2020 2020 2020  s2,.            
-00009cd0: 2020 2020 5472 7565 0a20 2020 2020 2020      True.       
-00009ce0: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
-00009cf0: 2020 2023 206d 616b 6520 7375 7265 2074     # make sure t
-00009d00: 6865 206f 7574 7369 6465 2072 6567 696f  he outside regio
-00009d10: 6e20 6973 2066 696c 6c65 6420 7769 7468  n is filled with
-00009d20: 207a 6572 6f73 0a20 2020 2020 2020 2020   zeros.         
-00009d30: 2020 206d 6170 315f 6269 6e2e 6675 6c6c     map1_bin.full
-00009d40: 4d61 7020 3d20 6d61 7031 5f62 696e 2e66  Map = map1_bin.f
-00009d50: 756c 6c4d 6170 202a 206d 6173 6b5f 6172  ullMap * mask_ar
-00009d60: 7261 790a 2020 2020 2020 2020 2020 2020  ray.            
-00009d70: 6d61 7032 5f62 696e 2e66 756c 6c4d 6170  map2_bin.fullMap
-00009d80: 203d 206d 6170 325f 6269 6e2e 6675 6c6c   = map2_bin.full
-00009d90: 4d61 7020 2a20 6d61 736b 5f61 7272 6179  Map * mask_array
-00009da0: 0a20 2020 2020 2020 2020 2020 2023 2062  .            # b
-00009db0: 6163 6b67 726f 756e 6420 6672 6571 7565  ackground freque
-00009dc0: 6e63 6965 7320 6672 6f6d 2074 6865 2077  ncies from the w
-00009dd0: 686f 6c65 206d 6170 0a20 2020 2020 2020  hole map.       
-00009de0: 2020 2020 2062 696e 7331 203d 205b 5d0a       bins1 = [].
-00009df0: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-00009e00: 6920 696e 2072 616e 6765 286c 6179 6572  i in range(layer
-00009e10: 7331 202b 2032 293a 0a20 2020 2020 2020  s1 + 2):.       
-00009e20: 2020 2020 2020 2020 2062 696e 7331 2e61           bins1.a
-00009e30: 7070 656e 6428 6929 0a20 2020 2020 2020  ppend(i).       
-00009e40: 2020 2020 2062 696e 7332 203d 205b 5d0a       bins2 = [].
-00009e50: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-00009e60: 6920 696e 2072 616e 6765 286c 6179 6572  i in range(layer
-00009e70: 7332 202b 2032 293a 0a20 2020 2020 2020  s2 + 2):.       
-00009e80: 2020 2020 2020 2020 2062 696e 7332 2e61           bins2.a
-00009e90: 7070 656e 6428 6929 0a20 2020 2020 2020  ppend(i).       
-00009ea0: 2020 2020 2023 2063 616c 6375 6c61 7465       # calculate
-00009eb0: 2066 7265 7175 656e 6379 206f 6620 6269   frequency of bi
-00009ec0: 6e73 0a20 2020 2020 2020 2020 2020 206d  ns.            m
-00009ed0: 6170 315f 6672 6571 203d 206e 702e 6869  ap1_freq = np.hi
-00009ee0: 7374 6f67 7261 6d28 6d61 7031 5f62 696e  stogram(map1_bin
-00009ef0: 2e66 756c 6c4d 6170 2c20 6269 6e73 3129  .fullMap, bins1)
-00009f00: 5b30 5d5b 313a 5d0a 2020 2020 2020 2020  [0][1:].        
-00009f10: 2020 2020 6d61 7032 5f66 7265 7120 3d20      map2_freq = 
-00009f20: 6e70 2e68 6973 746f 6772 616d 286d 6170  np.histogram(map
-00009f30: 325f 6269 6e2e 6675 6c6c 4d61 702c 2062  2_bin.fullMap, b
-00009f40: 696e 7332 295b 305d 5b31 3a5d 0a0a 2020  ins2)[0][1:]..  
-00009f50: 2020 2020 2020 7363 6f72 6520 3d20 302e        score = 0.
-00009f60: 300a 2020 2020 2020 2020 746f 7461 6c20  0.        total 
-00009f70: 3d20 300a 0a20 2020 2020 2020 2069 6620  = 0..        if 
-00009f80: 6e70 2e73 756d 286d 6170 315f 6672 6571  np.sum(map1_freq
-00009f90: 2920 3d3d 2030 3a0a 2020 2020 2020 2020  ) == 0:.        
-00009fa0: 2020 2020 7072 696e 7428 0a20 2020 2020      print(.     
-00009fb0: 2020 2020 2020 2020 2020 2027 4e6f 206d             'No m
-00009fc0: 6170 206f 7665 726c 6170 2028 4d75 7475  ap overlap (Mutu
-00009fd0: 616c 2069 6e66 6f72 6d61 7469 6f6e 2073  al information s
-00009fe0: 636f 7265 292c 2065 7869 7469 6e67 2073  core), exiting s
-00009ff0: 636f 7265 2027 0a20 2020 2020 2020 2020  core '.         
-0000a000: 2020 2020 2020 2027 6361 6c63 756c 6174         'calculat
-0000a010: 696f 6e2e 2e27 0a20 2020 2020 2020 2020  ion..'.         
-0000a020: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
-0000a030: 2072 6574 7572 6e20 302e 300a 2020 2020   return 0.0.    
-0000a040: 2020 2020 6966 206e 702e 7375 6d28 6d61      if np.sum(ma
-0000a050: 7032 5f66 7265 7129 203d 3d20 303a 0a20  p2_freq) == 0:. 
-0000a060: 2020 2020 2020 2020 2020 2070 7269 6e74             print
-0000a070: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-0000a080: 2020 274e 6f20 6d61 7020 6f76 6572 6c61    'No map overla
-0000a090: 7020 284d 7574 7561 6c20 696e 666f 726d  p (Mutual inform
-0000a0a0: 6174 696f 6e20 7363 6f72 6529 2c20 6578  ation score), ex
-0000a0b0: 6974 696e 6720 7363 6f72 6520 270a 2020  iting score '.  
-0000a0c0: 2020 2020 2020 2020 2020 2020 2020 2763                'c
-0000a0d0: 616c 6375 6c61 7469 6f6e 2e2e 270a 2020  alculation..'.  
-0000a0e0: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
-0000a0f0: 2020 2020 2020 2020 7265 7475 726e 2030          return 0
-0000a100: 2e30 0a20 2020 2020 2020 206c 6973 745f  .0.        list_
-0000a110: 6f76 6572 6c61 7073 203d 205b 5d0a 2020  overlaps = [].  
-0000a120: 2020 2020 2020 666f 7220 7820 696e 2072        for x in r
-0000a130: 616e 6765 286c 6179 6572 7331 293a 0a20  ange(layers1):. 
-0000a140: 2020 2020 2020 2020 2020 206d 6173 6b5f             mask_
-0000a150: 6172 7261 7920 3d20 6d61 7031 5f62 696e  array = map1_bin
-0000a160: 2e66 756c 6c4d 6170 203d 3d20 666c 6f61  .fullMap == floa
-0000a170: 7428 782b 3129 0a20 2020 2020 2020 2020  t(x+1).         
-0000a180: 2020 206f 7665 726c 6170 5f66 7265 7120     overlap_freq 
-0000a190: 3d20 6e70 2e68 6973 746f 6772 616d 280a  = np.histogram(.
-0000a1a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a1b0: 6d61 7032 5f62 696e 2e66 756c 6c4d 6170  map2_bin.fullMap
-0000a1c0: 5b6d 6173 6b5f 6172 7261 795d 2c20 6269  [mask_array], bi
-0000a1d0: 6e73 320a 2020 2020 2020 2020 2020 2020  ns2.            
-0000a1e0: 295b 305d 5b31 3a5d 0a20 2020 2020 2020  )[0][1:].       
-0000a1f0: 2020 2020 2074 6f74 616c 202b 3d20 666c       total += fl
-0000a200: 6f61 7428 6e70 2e73 756d 286f 7665 726c  oat(np.sum(overl
-0000a210: 6170 5f66 7265 7129 290a 2020 2020 2020  ap_freq)).      
-0000a220: 2020 2020 2020 6c69 7374 5f6f 7665 726c        list_overl
-0000a230: 6170 732e 6170 7065 6e64 286f 7665 726c  aps.append(overl
-0000a240: 6170 5f66 7265 7129 0a0a 2020 2020 2020  ap_freq)..      
-0000a250: 2020 6966 2074 6f74 616c 203d 3d20 303a    if total == 0:
-0000a260: 0a20 2020 2020 2020 2020 2020 2070 7269  .            pri
-0000a270: 6e74 280a 2020 2020 2020 2020 2020 2020  nt(.            
-0000a280: 2020 2020 274e 6f20 6d61 7020 6f76 6572      'No map over
-0000a290: 6c61 7020 284d 7574 7561 6c20 696e 666f  lap (Mutual info
-0000a2a0: 726d 6174 696f 6e20 7363 6f72 6529 2c20  rmation score), 
-0000a2b0: 6578 6974 696e 6720 7363 6f72 6520 270a  exiting score '.
-0000a2c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a2d0: 2763 616c 6375 6c61 7469 6f6e 2e2e 270a  'calculation..'.
-0000a2e0: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
-0000a2f0: 2020 2020 2020 2020 2020 7265 7475 726e            return
-0000a300: 2030 2e30 0a20 2020 2020 2020 2065 6e74   0.0.        ent
-0000a310: 6572 203d 2030 0a20 2020 2020 2020 2048  er = 0.        H
-0000a320: 7879 203d 2030 2e30 0a20 2020 2020 2020  xy = 0.0.       
-0000a330: 2048 7820 3d20 302e 300a 2020 2020 2020   Hx = 0.0.      
-0000a340: 2020 4879 203d 2030 2e30 0a20 2020 2020    Hy = 0.0.     
-0000a350: 2020 206d 695f 7363 6f72 6520 3d20 302e     mi_score = 0.
-0000a360: 300a 2020 2020 2020 2020 705f 636f 6d62  0.        p_comb
-0000a370: 203d 2030 2e30 0a20 2020 2020 2020 2066   = 0.0.        f
-0000a380: 6f72 2078 2069 6e20 7261 6e67 6528 6c61  or x in range(la
-0000a390: 7965 7273 3129 3a0a 2020 2020 2020 2020  yers1):.        
-0000a3a0: 2020 2020 705f 6d31 203d 206d 6170 315f      p_m1 = map1_
-0000a3b0: 6672 6571 5b78 5d2f 666c 6f61 7428 6e70  freq[x]/float(np
-0000a3c0: 2e73 756d 286d 6170 315f 6672 6571 2929  .sum(map1_freq))
-0000a3d0: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
-0000a3e0: 2079 2069 6e20 7261 6e67 6528 6c61 7965   y in range(laye
-0000a3f0: 7273 3229 3a0a 2020 2020 2020 2020 2020  rs2):.          
-0000a400: 2020 2020 2020 656e 7465 7220 3d20 310a        enter = 1.
-0000a410: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a420: 705f 636f 6d62 203d 206c 6973 745f 6f76  p_comb = list_ov
-0000a430: 6572 6c61 7073 5b78 5d5b 795d 2f74 6f74  erlaps[x][y]/tot
-0000a440: 616c 0a20 2020 2020 2020 2020 2020 2020  al.             
-0000a450: 2020 2070 5f6d 3220 3d20 6d61 7032 5f66     p_m2 = map2_f
-0000a460: 7265 715b 795d 202f 2066 6c6f 6174 286e  req[y] / float(n
-0000a470: 702e 7375 6d28 6d61 7032 5f66 7265 7129  p.sum(map2_freq)
-0000a480: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0000a490: 2020 6966 2070 5f63 6f6d 6220 3d3d 2030    if p_comb == 0
-0000a4a0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0000a4b0: 2020 2020 2020 6d69 5f73 636f 7265 203d        mi_score =
-0000a4c0: 2030 2e30 0a0a 2020 2020 2020 2020 2020   0.0..          
-0000a4d0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-0000a4e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a4f0: 4878 7920 2b3d 202d 705f 636f 6d62 202a  Hxy += -p_comb *
-0000a500: 206d 6174 682e 6c6f 6728 705f 636f 6d62   math.log(p_comb
-0000a510: 2c20 3229 0a20 2020 2020 2020 2020 2020  , 2).           
-0000a520: 2020 2020 2073 636f 7265 202b 3d20 6d69       score += mi
-0000a530: 5f73 636f 7265 0a20 2020 2020 2020 2020  _score.         
-0000a540: 2020 2020 2020 2069 6620 7820 3d3d 2030         if x == 0
-0000a550: 2061 6e64 206e 6f74 2070 5f6d 3220 3d3d   and not p_m2 ==
-0000a560: 2030 2e30 3a0a 2020 2020 2020 2020 2020   0.0:.          
-0000a570: 2020 2020 2020 2020 2020 4879 202b 3d20            Hy += 
-0000a580: 282d 705f 6d32 202a 206d 6174 682e 6c6f  (-p_m2 * math.lo
-0000a590: 6728 705f 6d32 2c20 3229 290a 2020 2020  g(p_m2, 2)).    
-0000a5a0: 2020 2020 2020 2020 6966 206e 6f74 2070          if not p
-0000a5b0: 5f6d 3120 3d3d 2030 2e30 3a0a 2020 2020  _m1 == 0.0:.    
-0000a5c0: 2020 2020 2020 2020 2020 2020 4878 202b              Hx +
-0000a5d0: 3d20 282d 705f 6d31 202a 206d 6174 682e  = (-p_m1 * math.
-0000a5e0: 6c6f 6728 705f 6d31 2c20 3229 290a 2020  log(p_m1, 2)).  
-0000a5f0: 2020 2020 2020 6966 2065 6e74 6572 203d        if enter =
-0000a600: 3d20 313a 0a20 2020 2020 2020 2020 2020  = 1:.           
-0000a610: 2069 6620 7765 6967 6874 3a0a 2020 2020   if weight:.    
-0000a620: 2020 2020 2020 2020 2020 2020 6966 2048              if H
-0000a630: 7879 203d 3d20 302e 303a 0a20 2020 2020  xy == 0.0:.     
-0000a640: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-0000a650: 6574 7572 6e20 302e 300a 2020 2020 2020  eturn 0.0.      
-0000a660: 2020 2020 2020 2020 2020 7265 7475 726e            return
-0000a670: 2028 4878 202b 2048 7929 202f 2048 7879   (Hx + Hy) / Hxy
-0000a680: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-0000a690: 7572 6e20 4878 202b 2048 7920 2d20 4878  urn Hx + Hy - Hx
-0000a6a0: 790a 2020 2020 2020 2020 656c 7365 3a0a  y.        else:.
-0000a6b0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-0000a6c0: 726e 204e 6f6e 650a 0a20 2020 2064 6566  rn None..    def
-0000a6d0: 204d 495f 6e65 7728 7365 6c66 2c20 6578   MI_new(self, ex
-0000a6e0: 705f 6d61 702c 2073 696d 5f6d 6170 2c20  p_map, sim_map, 
-0000a6f0: 6269 6e73 313d 3230 2c20 6269 6e73 323d  bins1=20, bins2=
-0000a700: 3230 2c20 6e6f 726d 616c 6973 653d 4661  20, normalise=Fa
-0000a710: 6c73 6529 3a0a 2020 2020 2020 2020 2222  lse):.        ""
-0000a720: 220a 2020 2020 2020 2020 5461 6b65 6e20  ".        Taken 
-0000a730: 6672 6f6d 2068 7474 7073 3a2f 2f73 7461  from https://sta
-0000a740: 636b 6f76 6572 666c 6f77 2e63 6f6d 2f71  ckoverflow.com/q
-0000a750: 7565 7374 696f 6e73 2f32 3034 3931 3032  uestions/2049102
-0000a760: 382f 6f70 7469 6d61 6c2d 7761 792d 746f  8/optimal-way-to
-0000a770: 2d63 6f6d 7075 7465 2d70 6169 7277 6973  -compute-pairwis
-0000a780: 652d 6d75 7475 616c 2d69 6e66 6f72 6d61  e-mutual-informa
-0000a790: 7469 6f6e 2d75 7369 6e67 2d6e 756d 7079  tion-using-numpy
-0000a7a0: 0a20 2020 2020 2020 2022 2222 0a0a 2020  .        """..  
-0000a7b0: 2020 2020 2020 635f 7879 2c20 782c 2079        c_xy, x, y
-0000a7c0: 203d 206e 702e 6869 7374 6f67 7261 6d32   = np.histogram2
-0000a7d0: 6428 6578 705f 6d61 702e 6675 6c6c 4d61  d(exp_map.fullMa
-0000a7e0: 702e 7261 7665 6c28 292c 0a20 2020 2020  p.ravel(),.     
-0000a7f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a800: 2020 2020 2020 2073 696d 5f6d 6170 2e66         sim_map.f
-0000a810: 756c 6c4d 6170 2e72 6176 656c 2829 2c0a  ullMap.ravel(),.
-0000a820: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a830: 2020 2020 2020 2020 2020 2020 6269 6e73              bins
-0000a840: 3d5b 6269 6e73 312c 2062 696e 7332 5d29  =[bins1, bins2])
-0000a850: 0a0a 2020 2020 2020 2020 672c 205f 2c20  ..        g, _, 
-0000a860: 5f2c 205f 203d 2073 7461 7473 2e63 6869  _, _ = stats.chi
-0000a870: 325f 636f 6e74 696e 6765 6e63 7928 635f  2_contingency(c_
-0000a880: 7879 2c20 6c61 6d62 6461 5f3d 276c 6f67  xy, lambda_='log
-0000a890: 2d6c 696b 656c 6968 6f6f 6427 290a 0a20  -likelihood').. 
-0000a8a0: 2020 2020 2020 206d 695f 6e6c 203d 2030         mi_nl = 0
-0000a8b0: 2e35 202a 2067 202f 2063 5f78 792e 7375  .5 * g / c_xy.su
-0000a8c0: 6d28 290a 0a20 2020 2020 2020 2072 6574  m()..        ret
-0000a8d0: 7572 6e20 6e70 2e6c 6f67 3228 6e70 2e65  urn np.log2(np.e
-0000a8e0: 7870 286d 695f 6e6c 2929 0a0a 2020 2020  xp(mi_nl))..    
-0000a8f0: 6465 6620 5f68 6175 7364 6f72 6666 5f6c  def _hausdorff_l
-0000a900: 6973 7428 0a20 2020 2020 2020 2020 2020  ist(.           
-0000a910: 2073 656c 662c 0a20 2020 2020 2020 2020   self,.         
-0000a920: 2020 2070 7269 6d61 7279 5f62 6f75 6e64     primary_bound
-0000a930: 6172 792c 0a20 2020 2020 2020 2020 2020  ary,.           
-0000a940: 2073 6563 6f6e 6461 7279 5f62 6f75 6e64   secondary_bound
-0000a950: 6172 792c 0a20 2020 2020 2020 2020 2020  ary,.           
-0000a960: 206b 6474 7265 652c 0a20 2020 2020 2020   kdtree,.       
-0000a970: 2020 2020 206d 6170 5f70 726f 6265 2c0a       map_probe,.
-0000a980: 2020 2020 293a 0a20 2020 2020 2020 2022      ):.        "
-0000a990: 2222 0a20 2020 2020 2020 2054 6869 7320  "".        This 
-0000a9a0: 6973 2066 6f72 2074 6865 2063 6861 6d64  is for the chamd
-0000a9b0: 6566 2064 6973 7461 6e63 6520 6465 6620  ef distance def 
-0000a9c0: 6368 616d 6665 725f 6469 7374 616e 6365  chamfer_distance
-0000a9d0: 2c20 6d69 6e20 6d61 7820 6465 6e73 6974  , min max densit
-0000a9e0: 790a 2020 2020 2020 2020 7661 6c75 6520  y.        value 
-0000a9f0: 7468 6174 2064 6566 696e 6520 7468 6520  that define the 
-0000aa00: 7375 7266 6163 6520 6f66 2074 6865 2070  surface of the p
-0000aa10: 726f 7465 696e 0a0a 2020 2020 2020 2020  rotein..        
-0000aa20: 4172 6775 6d65 6e74 733a 0a20 2020 2020  Arguments:.     
-0000aa30: 2020 2020 2020 202a 6b64 7472 6565 2a0a         *kdtree*.
-0000aa40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000aa50: 2874 6865 7265 2061 7265 2032 206f 6620  (there are 2 of 
-0000aa60: 7468 656d 2069 6e20 6e75 6d70 7920 6f6e  them in numpy on
-0000aa70: 6520 4362 6173 6564 206f 6e20 7079 2d62  e Cbased on py-b
-0000aa80: 6173 6564 2c20 7468 650a 2020 2020 2020  ased, the.      
-0000aa90: 2020 2020 2020 2020 2020 6c61 7474 6572            latter
-0000aaa0: 2069 7320 6265 7474 6572 2c20 6374 726c   is better, ctrl
-0000aab0: 2920 7468 6973 2068 6176 6520 746f 2062  ) this have to b
-0000aac0: 6520 6f6e 6520 6f66 2074 6865 2069 6e70  e one of the inp
-0000aad0: 7574 2e0a 2020 2020 2020 2020 2020 2020  ut..            
-0000aae0: 2020 2020 6b64 7472 6565 2066 726f 6d20      kdtree from 
-0000aaf0: 6d61 705f 7461 7267 6574 0a20 2020 2020  map_target.     
-0000ab00: 2020 2020 2020 202a 7072 696d 6172 795f         *primary_
-0000ab10: 626f 756e 6461 7279 2c20 7365 636f 6e64  boundary, second
-0000ab20: 6172 795f 626f 756e 6461 7279 2a0a 2020  ary_boundary*.  
-0000ab30: 2020 2020 2020 2020 2020 2020 2020 6e65                ne
-0000ab40: 6564 2074 6f20 7275 6e20 6765 745f 7072  ed to run get_pr
-0000ab50: 696d 6172 795f 626f 756e 6461 7279 2061  imary_boundary a
-0000ab60: 6e64 2067 6574 5f73 6563 6f6e 645f 626f  nd get_second_bo
-0000ab70: 756e 6461 7279 2066 6f72 0a20 2020 2020  undary for.     
-0000ab80: 2020 2020 2020 2020 2020 206d 6170 5f70             map_p
-0000ab90: 726f 6265 0a0a 2020 2020 2020 2020 2020  robe..          
-0000aba0: 2020 4e4f 5445 3a20 6966 2079 6f75 206b    NOTE: if you k
-0000abb0: 6565 7020 7468 6520 6b64 7472 6565 2061  eep the kdtree a
-0000abc0: 7320 7061 7261 6d65 7472 6520 6f75 7420  s parametre out 
-0000abd0: 6f73 206c 6573 7320 7469 6d65 0a20 2020  os less time.   
-0000abe0: 2020 2020 2020 2020 2063 6f6e 7375 6d69           consumi
-0000abf0: 6e67 2061 7320 6275 696c 6469 6e67 2069  ng as building i
-0000ac00: 7420 7461 6b65 7320 7469 6d65 2e0a 2020  t takes time..  
-0000ac10: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
-0000ac20: 2020 706f 696e 7473 203d 206d 6170 5f70    points = map_p
-0000ac30: 726f 6265 2e67 6574 5f70 6f73 2870 7269  robe.get_pos(pri
-0000ac40: 6d61 7279 5f62 6f75 6e64 6172 792c 2073  mary_boundary, s
-0000ac50: 6563 6f6e 6461 7279 5f62 6f75 6e64 6172  econdary_boundar
-0000ac60: 7929 0a20 2020 2020 2020 2072 6574 7572  y).        retur
-0000ac70: 6e20 6b64 7472 6565 2e71 7565 7279 2870  n kdtree.query(p
-0000ac80: 6f69 6e74 7329 5b30 5d0a 0a20 2020 2064  oints)[0]..    d
-0000ac90: 6566 2063 6861 6d66 6572 5f64 6973 7461  ef chamfer_dista
-0000aca0: 6e63 6528 0a20 2020 2020 2020 2020 2020  nce(.           
-0000acb0: 2073 656c 662c 0a20 2020 2020 2020 2020   self,.         
-0000acc0: 2020 206d 6170 5f74 6172 6765 742c 0a20     map_target,. 
-0000acd0: 2020 2020 2020 2020 2020 206d 6170 5f70             map_p
-0000ace0: 726f 6265 2c0a 2020 2020 2020 2020 2020  robe,.          
-0000acf0: 2020 7072 696d 6172 795f 626f 756e 6461    primary_bounda
-0000ad00: 7279 2c0a 2020 2020 2020 2020 2020 2020  ry,.            
-0000ad10: 7365 636f 6e64 6172 795f 626f 756e 6461  secondary_bounda
-0000ad20: 7279 2c0a 2020 2020 2020 2020 2020 2020  ry,.            
-0000ad30: 6b64 7472 6565 3d4e 6f6e 652c 0a20 2020  kdtree=None,.   
-0000ad40: 2029 3a0a 2020 2020 2020 2020 2222 2243   ):.        """C
-0000ad50: 616c 6375 6c61 7465 2074 6865 2063 6861  alculate the cha
-0000ad60: 6d66 6572 2064 6973 7461 6e63 6520 5363  mfer distance Sc
-0000ad70: 6f72 6520 6265 7477 6565 6e20 7477 6f20  ore between two 
-0000ad80: 4d61 7020 696e 7374 616e 6365 732e 0a0a  Map instances...
-0000ad90: 2020 2020 2020 2020 4375 7272 656e 746c          Currentl
-0000ada0: 7920 756e 7374 6162 6c65 2061 6e64 206e  y unstable and n
-0000adb0: 6f74 2072 6563 6f6d 6d65 6e64 6564 2066  ot recommended f
-0000adc0: 6f72 2075 7365 2e0a 0a20 2020 2020 2020  or use...       
-0000add0: 2041 7267 756d 656e 7473 3a0a 2020 2020   Arguments:.    
-0000ade0: 2020 2020 2020 2020 6d61 705f 7461 7267          map_targ
-0000adf0: 6574 2c20 6d61 705f 7072 6f62 653a 204d  et, map_probe: M
-0000ae00: 6170 2069 6e73 7461 6e63 6573 2074 6f20  ap instances to 
-0000ae10: 636f 6d70 6172 652e 0a20 2020 2020 2020  compare..       
-0000ae20: 2020 2020 2070 7269 6d61 7279 5f62 6f75       primary_bou
-0000ae30: 6e64 6172 793a 2054 6872 6573 686f 6c64  ndary: Threshold
-0000ae40: 2074 6861 7420 6465 6669 6e65 6420 7468   that defined th
-0000ae50: 6520 454d 206d 6170 2073 7572 6661 6365  e EM map surface
-0000ae60: 2c20 6261 7365 640a 2020 2020 2020 2020  , based.        
-0000ae70: 2020 2020 2020 2020 6f6e 2074 6865 2076          on the v
-0000ae80: 6f6c 756d 6520 6f66 2074 6865 2070 726f  olume of the pro
-0000ae90: 7465 696e 206d 6f64 656c 2e20 4361 6e20  tein model. Can 
-0000aea0: 6265 2063 616c 6375 6c61 7465 6420 7573  be calculated us
-0000aeb0: 696e 670a 2020 2020 2020 2020 2020 2020  ing.            
-0000aec0: 2020 2020 3a6d 6574 683a 604d 6170 2e6d      :meth:`Map.m
-0000aed0: 616b 654b 4454 7265 6520 3c54 454d 5079  akeKDTree <TEMPy
-0000aee0: 2e6d 6170 732e 656d 5f6d 6170 2e4d 6170  .maps.em_map.Map
-0000aef0: 2e67 6574 5f70 7269 6d61 7279 5f62 6f75  .get_primary_bou
-0000af00: 6e64 6172 793e 600a 2020 2020 2020 2020  ndary>`.        
-0000af10: 2020 2020 7365 636f 6e64 6172 795f 626f      secondary_bo
-0000af20: 756e 6461 7279 3a20 5468 6520 7365 636f  undary: The seco
-0000af30: 6e64 2062 6f75 6e64 2064 656e 7369 7479  nd bound density
-0000af40: 2070 6f69 6e74 2e0a 2020 2020 2020 2020   point..        
-0000af50: 2020 2020 2020 2020 4361 6e20 6265 2063          Can be c
-0000af60: 616c 6375 6c61 7465 6420 7573 696e 670a  alculated using.
-0000af70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000af80: 3a6d 6574 683a 604d 6170 2e6d 616b 654b  :meth:`Map.makeK
-0000af90: 4454 7265 6520 3c54 454d 5079 2e6d 6170  DTree <TEMPy.map
-0000afa0: 732e 656d 5f6d 6170 2e4d 6170 2e67 6574  s.em_map.Map.get
-0000afb0: 5f73 6563 6f6e 645f 626f 756e 6461 7279  _second_boundary
-0000afc0: 3e60 0a20 2020 2020 2020 2020 2020 206b  >`.            k
-0000afd0: 6474 7265 653a 2050 7265 6361 6c63 756c  dtree: Precalcul
-0000afe0: 6174 6564 206b 6474 7265 652e 2049 6620  ated kdtree. If 
-0000aff0: 4e6f 6e65 2c20 4b44 5472 6565 2069 7320  None, KDTree is 
-0000b000: 636f 6e73 7472 7563 7465 6420 7573 696e  constructed usin
-0000b010: 670a 2020 2020 2020 2020 2020 2020 2020  g.              
-0000b020: 2020 3a6d 6574 683a 604d 6170 2e6d 616b    :meth:`Map.mak
-0000b030: 654b 4454 7265 6520 3c54 454d 5079 2e6d  eKDTree <TEMPy.m
-0000b040: 6170 732e 656d 5f6d 6170 2e4d 6170 2e6d  aps.em_map.Map.m
-0000b050: 616b 654b 4454 7265 653e 600a 2020 2020  akeKDTree>`.    
-0000b060: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
-0000b070: 6966 2073 656c 662e 6d61 7043 6f6d 7061  if self.mapCompa
-0000b080: 7269 736f 6e28 6d61 705f 7461 7267 6574  rison(map_target
-0000b090: 2c20 6d61 705f 7072 6f62 6529 3a0a 2020  , map_probe):.  
-0000b0a0: 2020 2020 2020 2020 2020 6d31 2c20 6d32            m1, m2
-0000b0b0: 203d 206d 6170 5f74 6172 6765 742c 206d   = map_target, m
-0000b0c0: 6170 5f70 726f 6265 0a20 2020 2020 2020  ap_probe.       
-0000b0d0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-0000b0e0: 2020 2073 656c 662e 5f66 6169 6c65 645f     self._failed_
-0000b0f0: 6d61 7463 6828 290a 2020 2020 2020 2020  match().        
-0000b100: 6966 206b 6474 7265 653a 0a20 2020 2020  if kdtree:.     
-0000b110: 2020 2020 2020 2072 6574 7572 6e20 7365         return se
-0000b120: 6c66 2e5f 6861 7573 646f 7266 665f 6c69  lf._hausdorff_li
-0000b130: 7374 280a 2020 2020 2020 2020 2020 2020  st(.            
-0000b140: 2020 2020 7072 696d 6172 795f 626f 756e      primary_boun
-0000b150: 6461 7279 2c20 7365 636f 6e64 6172 795f  dary, secondary_
-0000b160: 626f 756e 6461 7279 2c20 6b64 7472 6565  boundary, kdtree
-0000b170: 2c20 6d32 0a20 2020 2020 2020 2020 2020  , m2.           
-0000b180: 2029 2e6d 6561 6e28 290a 2020 2020 2020   ).mean().      
-0000b190: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-0000b1a0: 2020 2020 7072 696e 7428 6d31 2c20 7072      print(m1, pr
-0000b1b0: 696d 6172 795f 626f 756e 6461 7279 2c20  imary_boundary, 
-0000b1c0: 7365 636f 6e64 6172 795f 626f 756e 6461  secondary_bounda
-0000b1d0: 7279 290a 2020 2020 2020 2020 2020 2020  ry).            
-0000b1e0: 6b64 7472 6565 203d 206d 312e 6d61 6b65  kdtree = m1.make
-0000b1f0: 4b44 5472 6565 2870 7269 6d61 7279 5f62  KDTree(primary_b
-0000b200: 6f75 6e64 6172 792c 2073 6563 6f6e 6461  oundary, seconda
-0000b210: 7279 5f62 6f75 6e64 6172 7929 0a20 2020  ry_boundary).   
-0000b220: 2020 2020 2020 2020 2069 6620 6b64 7472           if kdtr
-0000b230: 6565 2069 7320 4e6f 6e65 3a0a 2020 2020  ee is None:.    
-0000b240: 2020 2020 2020 2020 2020 2020 7072 696e              prin
-0000b250: 7428 2745 7272 6f72 2e20 4e6f 2070 6f69  t('Error. No poi
-0000b260: 6e74 7320 7365 6c65 6374 6564 2c20 6368  nts selected, ch
-0000b270: 616e 6765 2062 6f75 6e64 6172 7920 7061  ange boundary pa
-0000b280: 7261 6d65 7465 7273 2e27 290a 2020 2020  rameters.').    
-0000b290: 2020 2020 2020 2020 2020 2020 7379 732e              sys.
-0000b2a0: 6578 6974 2829 0a20 2020 2020 2020 2020  exit().         
-0000b2b0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-0000b2c0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-0000b2d0: 7365 6c66 2e5f 6861 7573 646f 7266 665f  self._hausdorff_
-0000b2e0: 6c69 7374 280a 2020 2020 2020 2020 2020  list(.          
-0000b2f0: 2020 2020 2020 2020 2020 7072 696d 6172            primar
-0000b300: 795f 626f 756e 6461 7279 2c0a 2020 2020  y_boundary,.    
-0000b310: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b320: 7365 636f 6e64 6172 795f 626f 756e 6461  secondary_bounda
-0000b330: 7279 2c0a 2020 2020 2020 2020 2020 2020  ry,.            
-0000b340: 2020 2020 2020 2020 6b64 7472 6565 2c0a          kdtree,.
-0000b350: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b360: 2020 2020 6d32 0a20 2020 2020 2020 2020      m2.         
-0000b370: 2020 2020 2020 2029 2e6d 6561 6e28 290a         ).mean().
-0000b380: 0a20 2020 2064 6566 205f 7375 7266 6163  .    def _surfac
-0000b390: 655f 6469 7374 616e 6365 5f73 636f 7265  e_distance_score
-0000b3a0: 280a 2020 2020 2020 2020 2020 2020 7365  (.            se
-0000b3b0: 6c66 2c0a 2020 2020 2020 2020 2020 2020  lf,.            
-0000b3c0: 6d61 705f 7461 7267 6574 2c0a 2020 2020  map_target,.    
-0000b3d0: 2020 2020 2020 2020 6d61 705f 7072 6f62          map_prob
-0000b3e0: 652c 0a20 2020 2020 2020 2020 2020 206d  e,.            m
-0000b3f0: 6170 5f74 6172 6765 745f 7468 7265 7368  ap_target_thresh
-0000b400: 6f6c 6431 3d30 2e30 2c0a 2020 2020 2020  old1=0.0,.      
-0000b410: 2020 2020 2020 6d61 705f 7072 6f62 655f        map_probe_
-0000b420: 7468 7265 7368 6f6c 643d 302e 302c 0a20  threshold=0.0,. 
-0000b430: 2020 2020 2020 2020 2020 2046 696c 7465             Filte
-0000b440: 723d 4e6f 6e65 2c0a 2020 2020 2020 2020  r=None,.        
-0000b450: 2020 2020 6d61 705f 7461 7267 6574 5f74      map_target_t
-0000b460: 6872 6573 686f 6c64 323d 302e 302c 0a20  hreshold2=0.0,. 
-0000b470: 2020 2020 2020 2020 2020 2077 6569 6768             weigh
-0000b480: 743d 4661 6c73 650a 2020 2020 293a 0a20  t=False.    ):. 
-0000b490: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
-0000b4a0: 2020 2043 616c 6375 6c61 7465 2074 6865     Calculate the
-0000b4b0: 2063 6861 6d66 6572 2064 6973 7461 6e63   chamfer distanc
-0000b4c0: 6520 5363 6f72 6520 6265 7477 6565 6e20  e Score between 
-0000b4d0: 7477 6f20 4d61 7020 696e 7374 616e 6365  two Map instance
-0000b4e0: 732e 0a0a 2020 2020 2020 2020 4172 6775  s...        Argu
-0000b4f0: 6d65 6e74 733a 0a20 2020 2020 2020 2020  ments:.         
-0000b500: 2020 202a 6d61 705f 7461 7267 6574 2c20     *map_target, 
-0000b510: 6d61 705f 7072 6f62 652a 0a20 2020 2020  map_probe*.     
-0000b520: 2020 2020 2020 2020 2020 2045 4d4d 6170             EMMap
-0000b530: 2069 6e73 7461 6e63 6573 2074 6f20 636f   instances to co
-0000b540: 6d70 6172 652e 0a20 2020 2020 2020 2020  mpare..         
-0000b550: 2020 202a 6d61 705f 7461 7267 6574 5f74     *map_target_t
-0000b560: 6872 6573 686f 6c64 312a 0a20 2020 2020  hreshold1*.     
-0000b570: 2020 2020 2020 2020 2020 2063 6f6e 746f             conto
-0000b580: 7572 2074 6872 6573 686f 6c64 206f 6620  ur threshold of 
-0000b590: 7468 6520 7461 7267 6574 206d 6170 2e0a  the target map..
-0000b5a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b5b0: 5468 6973 2076 616c 7565 2069 7320 7573  This value is us
-0000b5c0: 6564 2074 6865 2070 7269 6d61 7279 2062  ed the primary b
-0000b5d0: 6f75 6e64 6172 7920 6966 0a20 2020 2020  oundary if.     
-0000b5e0: 2020 2020 2020 2020 2020 206d 6170 5f74             map_t
-0000b5f0: 6172 6765 745f 7468 7265 7368 6f6c 6432  arget_threshold2
-0000b600: 2069 7320 6769 7665 6e2e 0a20 2020 2020   is given..     
-0000b610: 2020 2020 2020 202a 6d61 705f 7072 6f62         *map_prob
-0000b620: 655f 7468 7265 7368 6f6c 642a 0a20 2020  e_threshold*.   
-0000b630: 2020 2020 2020 2020 2020 2020 2063 6f6e               con
-0000b640: 746f 7572 2074 6872 6573 686f 6c64 2066  tour threshold f
-0000b650: 6f72 2074 6865 2070 726f 6265 206d 6170  or the probe map
-0000b660: 2e0a 2020 2020 2020 2020 2020 2020 2a46  ..            *F
-0000b670: 696c 7465 722a 0a20 2020 2020 2020 2020  ilter*.         
-0000b680: 2020 2020 2020 2064 6566 696e 6974 696f         definitio
-0000b690: 6e20 6f66 2074 6865 2073 7572 6661 6365  n of the surface
-0000b6a0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0000b6b0: 2020 2020 2020 3129 204e 6f6e 6520 3a20        1) None : 
-0000b6c0: 7375 7266 6163 6520 6465 6669 6e65 6420  surface defined 
-0000b6d0: 6279 206b 6e6f 776e 2062 6f75 6e64 6172  by known boundar
-0000b6e0: 6965 7320 2d0a 2020 2020 2020 2020 2020  ies -.          
-0000b6f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b700: 2020 2020 6d61 705f 7461 7267 6574 5f74      map_target_t
-0000b710: 6872 6573 686f 6c64 3120 2620 6d61 705f  hreshold1 & map_
-0000b720: 7461 7267 6574 5f74 6872 6573 686f 6c64  target_threshold
-0000b730: 320a 2020 2020 2020 2020 2020 2020 2020  2.              
-0000b740: 2020 2020 2020 4966 2074 6865 2062 6f75        If the bou
-0000b750: 6e64 6172 6965 7320 6172 6520 6e6f 7420  ndaries are not 
-0000b760: 6b6e 6f77 6e20 616e 6420 7461 7267 6574  known and target
-0000b770: 2670 726f 6265 206d 6170 0a20 2020 2020  &probe map.     
-0000b780: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-0000b790: 6f6e 746f 7572 206c 6576 656c 7320 6172  ontour levels ar
-0000b7a0: 6520 6b6e 6f77 6e3a 0a20 2020 2020 2020  e known:.       
-0000b7b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b7c0: 2032 2920 5374 6420 3a20 746f 2064 6566   2) Std : to def
-0000b7d0: 696e 6520 7468 6520 626f 756e 6461 7269  ine the boundari
-0000b7e0: 6573 2c20 636f 6e74 6f75 7220 6c65 7665  es, contour leve
-0000b7f0: 6c20 2b2d 2035 250a 2020 2020 2020 2020  l +- 5%.        
-0000b800: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b810: 2020 2020 2020 2020 2073 6967 6d61 2069           sigma i
-0000b820: 7320 6361 6c63 756c 6174 6564 2e20 3525  s calculated. 5%
-0000b830: 7369 676d 6120 6973 2075 7365 6420 746f  sigma is used to
-0000b840: 206c 696d 6974 0a20 2020 2020 2020 2020   limit.         
-0000b850: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b860: 2020 2020 2020 2020 7468 6520 6e75 6d62          the numb
-0000b870: 6572 206f 6620 706f 696e 7473 2070 6963  er of points pic
-0000b880: 6b65 6420 6173 2073 7572 6661 6365 2e20  ked as surface. 
-0000b890: 466f 720a 2020 2020 2020 2020 2020 2020  For.            
+00009880: 2e30 0a20 2020 2020 2020 2020 2020 2069  .0.            i
+00009890: 6620 6c61 7965 7273 3220 6973 204e 6f6e  f layers2 is Non
+000098a0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+000098b0: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
+000098c0: 2020 2020 2020 2020 2020 2020 6c61 7965              laye
+000098d0: 7273 3220 3d20 696e 7428 3120 2b20 6d61  rs2 = int(1 + ma
+000098e0: 7468 2e6c 6f67 286e 702e 7375 6d28 6d61  th.log(np.sum(ma
+000098f0: 736b 5f61 7272 6179 292c 2032 2929 0a20  sk_array), 2)). 
+00009900: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+00009910: 7863 6570 7420 5661 6c75 6545 7272 6f72  xcept ValueError
+00009920: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00009930: 2020 2020 2020 7072 696e 7428 0a20 2020        print(.   
+00009940: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009950: 2020 2020 2027 4e6f 206d 6170 206f 7665       'No map ove
+00009960: 726c 6170 2028 4d75 7475 616c 2069 6e66  rlap (Mutual inf
+00009970: 6f72 6d61 7469 6f6e 2073 636f 7265 292c  ormation score),
+00009980: 2065 7869 7469 6e67 2027 0a20 2020 2020   exiting '.     
+00009990: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000099a0: 2020 2027 7363 6f72 6520 6361 6c63 756c     'score calcul
+000099b0: 6174 696f 6e2e 2e27 0a20 2020 2020 2020  ation..'.       
+000099c0: 2020 2020 2020 2020 2020 2020 2029 0a20               ). 
+000099d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000099e0: 2020 2072 6574 7572 6e20 302e 300a 2020     return 0.0.  
+000099f0: 2020 2020 2020 2020 2020 6c61 7965 7273            layers
+00009a00: 3120 3d20 6d61 7828 6c61 7965 7273 312c  1 = max(layers1,
+00009a10: 2031 3529 0a20 2020 2020 2020 2020 2020   15).           
+00009a20: 206c 6179 6572 7332 203d 206d 6178 286c   layers2 = max(l
+00009a30: 6179 6572 7332 2c20 3135 290a 2020 2020  ayers2, 15).    
+00009a40: 2020 2020 2020 2020 6966 2077 6569 6768          if weigh
+00009a50: 743a 0a20 2020 2020 2020 2020 2020 2020  t:.             
+00009a60: 2020 2077 7420 3d20 310a 2020 2020 2020     wt = 1.      
+00009a70: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+00009a80: 2020 2020 2020 2020 2020 2020 7774 203d              wt =
+00009a90: 2030 0a20 2020 2020 2020 2020 2020 2069   0.            i
+00009aa0: 6620 636d 6f64 653a 0a20 2020 2020 2020  f cmode:.       
+00009ab0: 2020 2020 2020 2020 206d 6963 203d 2073           mic = s
+00009ac0: 656c 662e 5f4d 495f 4328 0a20 2020 2020  elf._MI_C(.     
+00009ad0: 2020 2020 2020 2020 2020 2020 2020 206e                 n
+00009ae0: 702e 6172 7261 7928 6d61 705f 7461 7267  p.array(map_targ
+00009af0: 6574 2e66 756c 6c4d 6170 202a 206d 6173  et.fullMap * mas
+00009b00: 6b5f 6172 7261 7929 2c0a 2020 2020 2020  k_array),.      
+00009b10: 2020 2020 2020 2020 2020 2020 2020 6e70                np
+00009b20: 2e61 7272 6179 286d 6170 5f70 726f 6265  .array(map_probe
+00009b30: 2e66 756c 6c4d 6170 202a 206d 6173 6b5f  .fullMap * mask_
+00009b40: 6172 7261 7929 2c0a 2020 2020 2020 2020  array),.        
+00009b50: 2020 2020 2020 2020 2020 2020 6c61 7965              laye
+00009b60: 7273 312c 0a20 2020 2020 2020 2020 2020  rs1,.           
+00009b70: 2020 2020 2020 2020 206c 6179 6572 7332           layers2
+00009b80: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00009b90: 2020 2020 2020 7774 2c0a 2020 2020 2020        wt,.      
+00009ba0: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+00009bb0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+00009bc0: 2020 2020 2020 2020 2020 2020 2020 6d69                mi
+00009bd0: 6320 3d20 4e6f 6e65 0a20 2020 2020 2020  c = None.       
+00009be0: 2020 2020 2069 6620 6d69 6320 6973 206e       if mic is n
+00009bf0: 6f74 204e 6f6e 653a 0a20 2020 2020 2020  ot None:.       
+00009c00: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+00009c10: 6d69 630a 2020 2020 2020 2020 2020 2020  mic.            
+00009c20: 2320 6469 6769 7469 7a65 206d 6173 6b65  # digitize maske
+00009c30: 6420 6d61 7020 6261 7365 6420 6f6e 206c  d map based on l
+00009c40: 6179 6572 730a 2020 2020 2020 2020 2020  ayers.          
+00009c50: 2020 6d61 7031 5f62 696e 203d 206d 6170    map1_bin = map
+00009c60: 5f74 6172 6765 742e 636f 7079 2829 0a20  _target.copy(). 
+00009c70: 2020 2020 2020 2020 2020 206d 6170 325f             map2_
+00009c80: 6269 6e20 3d20 6d61 705f 7072 6f62 652e  bin = map_probe.
+00009c90: 636f 7079 2829 0a20 2020 2020 2020 2020  copy().         
+00009ca0: 2020 206d 6170 315f 6269 6e2e 6675 6c6c     map1_bin.full
+00009cb0: 4d61 7020 3d20 6d61 7031 5f62 696e 2e66  Map = map1_bin.f
+00009cc0: 756c 6c4d 6170 202a 206d 6173 6b5f 6172  ullMap * mask_ar
+00009cd0: 7261 790a 2020 2020 2020 2020 2020 2020  ray.            
+00009ce0: 6d61 7032 5f62 696e 2e66 756c 6c4d 6170  map2_bin.fullMap
+00009cf0: 203d 206d 6170 325f 6269 6e2e 6675 6c6c   = map2_bin.full
+00009d00: 4d61 7020 2a20 6d61 736b 5f61 7272 6179  Map * mask_array
+00009d10: 0a20 2020 2020 2020 2020 2020 206d 6170  .            map
+00009d20: 315f 6269 6e20 3d20 6d61 7031 5f62 696e  1_bin = map1_bin
+00009d30: 2e5f 6d61 705f 6469 6769 7469 7a65 280a  ._map_digitize(.
+00009d40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009d50: 6d61 705f 7461 7267 6574 2e66 756c 6c4d  map_target.fullM
+00009d60: 6170 5b6d 6173 6b5f 6172 7261 795d 2e6d  ap[mask_array].m
+00009d70: 696e 2829 2c0a 2020 2020 2020 2020 2020  in(),.          
+00009d80: 2020 2020 2020 6c61 7965 7273 312c 0a20        layers1,. 
+00009d90: 2020 2020 2020 2020 2020 2020 2020 2054                 T
+00009da0: 7275 650a 2020 2020 2020 2020 2020 2020  rue.            
+00009db0: 290a 2020 2020 2020 2020 2020 2020 6d61  ).            ma
+00009dc0: 7032 5f62 696e 203d 206d 6170 325f 6269  p2_bin = map2_bi
+00009dd0: 6e2e 5f6d 6170 5f64 6967 6974 697a 6528  n._map_digitize(
+00009de0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00009df0: 206d 6170 5f70 726f 6265 2e66 756c 6c4d   map_probe.fullM
+00009e00: 6170 5b6d 6173 6b5f 6172 7261 795d 2e6d  ap[mask_array].m
+00009e10: 696e 2829 2c0a 2020 2020 2020 2020 2020  in(),.          
+00009e20: 2020 2020 2020 6c61 7965 7273 322c 0a20        layers2,. 
+00009e30: 2020 2020 2020 2020 2020 2020 2020 2054                 T
+00009e40: 7275 650a 2020 2020 2020 2020 2020 2020  rue.            
+00009e50: 290a 2020 2020 2020 2020 2020 2020 2320  ).            # 
+00009e60: 6d61 6b65 2073 7572 6520 7468 6520 6f75  make sure the ou
+00009e70: 7473 6964 6520 7265 6769 6f6e 2069 7320  tside region is 
+00009e80: 6669 6c6c 6564 2077 6974 6820 7a65 726f  filled with zero
+00009e90: 730a 2020 2020 2020 2020 2020 2020 6d61  s.            ma
+00009ea0: 7031 5f62 696e 2e66 756c 6c4d 6170 203d  p1_bin.fullMap =
+00009eb0: 206d 6170 315f 6269 6e2e 6675 6c6c 4d61   map1_bin.fullMa
+00009ec0: 7020 2a20 6d61 736b 5f61 7272 6179 0a20  p * mask_array. 
+00009ed0: 2020 2020 2020 2020 2020 206d 6170 325f             map2_
+00009ee0: 6269 6e2e 6675 6c6c 4d61 7020 3d20 6d61  bin.fullMap = ma
+00009ef0: 7032 5f62 696e 2e66 756c 6c4d 6170 202a  p2_bin.fullMap *
+00009f00: 206d 6173 6b5f 6172 7261 790a 2020 2020   mask_array.    
+00009f10: 2020 2020 2020 2020 2320 6261 636b 6772          # backgr
+00009f20: 6f75 6e64 2066 7265 7175 656e 6369 6573  ound frequencies
+00009f30: 2066 726f 6d20 7468 6520 7768 6f6c 6520   from the whole 
+00009f40: 6d61 700a 2020 2020 2020 2020 2020 2020  map.            
+00009f50: 6269 6e73 3120 3d20 5b5d 0a20 2020 2020  bins1 = [].     
+00009f60: 2020 2020 2020 2066 6f72 2069 2069 6e20         for i in 
+00009f70: 7261 6e67 6528 6c61 7965 7273 3120 2b20  range(layers1 + 
+00009f80: 3229 3a0a 2020 2020 2020 2020 2020 2020  2):.            
+00009f90: 2020 2020 6269 6e73 312e 6170 7065 6e64      bins1.append
+00009fa0: 2869 290a 2020 2020 2020 2020 2020 2020  (i).            
+00009fb0: 6269 6e73 3220 3d20 5b5d 0a20 2020 2020  bins2 = [].     
+00009fc0: 2020 2020 2020 2066 6f72 2069 2069 6e20         for i in 
+00009fd0: 7261 6e67 6528 6c61 7965 7273 3220 2b20  range(layers2 + 
+00009fe0: 3229 3a0a 2020 2020 2020 2020 2020 2020  2):.            
+00009ff0: 2020 2020 6269 6e73 322e 6170 7065 6e64      bins2.append
+0000a000: 2869 290a 2020 2020 2020 2020 2020 2020  (i).            
+0000a010: 2320 6361 6c63 756c 6174 6520 6672 6571  # calculate freq
+0000a020: 7565 6e63 7920 6f66 2062 696e 730a 2020  uency of bins.  
+0000a030: 2020 2020 2020 2020 2020 6d61 7031 5f66            map1_f
+0000a040: 7265 7120 3d20 6e70 2e68 6973 746f 6772  req = np.histogr
+0000a050: 616d 286d 6170 315f 6269 6e2e 6675 6c6c  am(map1_bin.full
+0000a060: 4d61 702c 2062 696e 7331 295b 305d 5b31  Map, bins1)[0][1
+0000a070: 3a5d 0a20 2020 2020 2020 2020 2020 206d  :].            m
+0000a080: 6170 325f 6672 6571 203d 206e 702e 6869  ap2_freq = np.hi
+0000a090: 7374 6f67 7261 6d28 6d61 7032 5f62 696e  stogram(map2_bin
+0000a0a0: 2e66 756c 6c4d 6170 2c20 6269 6e73 3229  .fullMap, bins2)
+0000a0b0: 5b30 5d5b 313a 5d0a 0a20 2020 2020 2020  [0][1:]..       
+0000a0c0: 2073 636f 7265 203d 2030 2e30 0a20 2020   score = 0.0.   
+0000a0d0: 2020 2020 2074 6f74 616c 203d 2030 0a0a       total = 0..
+0000a0e0: 2020 2020 2020 2020 6966 206e 702e 7375          if np.su
+0000a0f0: 6d28 6d61 7031 5f66 7265 7129 203d 3d20  m(map1_freq) == 
+0000a100: 303a 0a20 2020 2020 2020 2020 2020 2070  0:.            p
+0000a110: 7269 6e74 280a 2020 2020 2020 2020 2020  rint(.          
+0000a120: 2020 2020 2020 274e 6f20 6d61 7020 6f76        'No map ov
+0000a130: 6572 6c61 7020 284d 7574 7561 6c20 696e  erlap (Mutual in
+0000a140: 666f 726d 6174 696f 6e20 7363 6f72 6529  formation score)
+0000a150: 2c20 6578 6974 696e 6720 7363 6f72 6520  , exiting score 
+0000a160: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
+0000a170: 2020 2763 616c 6375 6c61 7469 6f6e 2e2e    'calculation..
+0000a180: 270a 2020 2020 2020 2020 2020 2020 290a  '.            ).
+0000a190: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+0000a1a0: 726e 2030 2e30 0a20 2020 2020 2020 2069  rn 0.0.        i
+0000a1b0: 6620 6e70 2e73 756d 286d 6170 325f 6672  f np.sum(map2_fr
+0000a1c0: 6571 2920 3d3d 2030 3a0a 2020 2020 2020  eq) == 0:.      
+0000a1d0: 2020 2020 2020 7072 696e 7428 0a20 2020        print(.   
+0000a1e0: 2020 2020 2020 2020 2020 2020 2027 4e6f               'No
+0000a1f0: 206d 6170 206f 7665 726c 6170 2028 4d75   map overlap (Mu
+0000a200: 7475 616c 2069 6e66 6f72 6d61 7469 6f6e  tual information
+0000a210: 2073 636f 7265 292c 2065 7869 7469 6e67   score), exiting
+0000a220: 2073 636f 7265 2027 0a20 2020 2020 2020   score '.       
+0000a230: 2020 2020 2020 2020 2027 6361 6c63 756c           'calcul
+0000a240: 6174 696f 6e2e 2e27 0a20 2020 2020 2020  ation..'.       
+0000a250: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
+0000a260: 2020 2072 6574 7572 6e20 302e 300a 2020     return 0.0.  
+0000a270: 2020 2020 2020 6c69 7374 5f6f 7665 726c        list_overl
+0000a280: 6170 7320 3d20 5b5d 0a20 2020 2020 2020  aps = [].       
+0000a290: 2066 6f72 2078 2069 6e20 7261 6e67 6528   for x in range(
+0000a2a0: 6c61 7965 7273 3129 3a0a 2020 2020 2020  layers1):.      
+0000a2b0: 2020 2020 2020 6d61 736b 5f61 7272 6179        mask_array
+0000a2c0: 203d 206d 6170 315f 6269 6e2e 6675 6c6c   = map1_bin.full
+0000a2d0: 4d61 7020 3d3d 2066 6c6f 6174 2878 2b31  Map == float(x+1
+0000a2e0: 290a 2020 2020 2020 2020 2020 2020 6f76  ).            ov
+0000a2f0: 6572 6c61 705f 6672 6571 203d 206e 702e  erlap_freq = np.
+0000a300: 6869 7374 6f67 7261 6d28 0a20 2020 2020  histogram(.     
+0000a310: 2020 2020 2020 2020 2020 206d 6170 325f             map2_
+0000a320: 6269 6e2e 6675 6c6c 4d61 705b 6d61 736b  bin.fullMap[mask
+0000a330: 5f61 7272 6179 5d2c 2062 696e 7332 0a20  _array], bins2. 
+0000a340: 2020 2020 2020 2020 2020 2029 5b30 5d5b             )[0][
+0000a350: 313a 5d0a 2020 2020 2020 2020 2020 2020  1:].            
+0000a360: 746f 7461 6c20 2b3d 2066 6c6f 6174 286e  total += float(n
+0000a370: 702e 7375 6d28 6f76 6572 6c61 705f 6672  p.sum(overlap_fr
+0000a380: 6571 2929 0a20 2020 2020 2020 2020 2020  eq)).           
+0000a390: 206c 6973 745f 6f76 6572 6c61 7073 2e61   list_overlaps.a
+0000a3a0: 7070 656e 6428 6f76 6572 6c61 705f 6672  ppend(overlap_fr
+0000a3b0: 6571 290a 0a20 2020 2020 2020 2069 6620  eq)..        if 
+0000a3c0: 746f 7461 6c20 3d3d 2030 3a0a 2020 2020  total == 0:.    
+0000a3d0: 2020 2020 2020 2020 7072 696e 7428 0a20          print(. 
+0000a3e0: 2020 2020 2020 2020 2020 2020 2020 2027                 '
+0000a3f0: 4e6f 206d 6170 206f 7665 726c 6170 2028  No map overlap (
+0000a400: 4d75 7475 616c 2069 6e66 6f72 6d61 7469  Mutual informati
+0000a410: 6f6e 2073 636f 7265 292c 2065 7869 7469  on score), exiti
+0000a420: 6e67 2073 636f 7265 2027 0a20 2020 2020  ng score '.     
+0000a430: 2020 2020 2020 2020 2020 2027 6361 6c63             'calc
+0000a440: 756c 6174 696f 6e2e 2e27 0a20 2020 2020  ulation..'.     
+0000a450: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+0000a460: 2020 2020 2072 6574 7572 6e20 302e 300a       return 0.0.
+0000a470: 2020 2020 2020 2020 656e 7465 7220 3d20          enter = 
+0000a480: 300a 2020 2020 2020 2020 4878 7920 3d20  0.        Hxy = 
+0000a490: 302e 300a 2020 2020 2020 2020 4878 203d  0.0.        Hx =
+0000a4a0: 2030 2e30 0a20 2020 2020 2020 2048 7920   0.0.        Hy 
+0000a4b0: 3d20 302e 300a 2020 2020 2020 2020 6d69  = 0.0.        mi
+0000a4c0: 5f73 636f 7265 203d 2030 2e30 0a20 2020  _score = 0.0.   
+0000a4d0: 2020 2020 2070 5f63 6f6d 6220 3d20 302e       p_comb = 0.
+0000a4e0: 300a 2020 2020 2020 2020 666f 7220 7820  0.        for x 
+0000a4f0: 696e 2072 616e 6765 286c 6179 6572 7331  in range(layers1
+0000a500: 293a 0a20 2020 2020 2020 2020 2020 2070  ):.            p
+0000a510: 5f6d 3120 3d20 6d61 7031 5f66 7265 715b  _m1 = map1_freq[
+0000a520: 785d 2f66 6c6f 6174 286e 702e 7375 6d28  x]/float(np.sum(
+0000a530: 6d61 7031 5f66 7265 7129 290a 2020 2020  map1_freq)).    
+0000a540: 2020 2020 2020 2020 666f 7220 7920 696e          for y in
+0000a550: 2072 616e 6765 286c 6179 6572 7332 293a   range(layers2):
+0000a560: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000a570: 2065 6e74 6572 203d 2031 0a20 2020 2020   enter = 1.     
+0000a580: 2020 2020 2020 2020 2020 2070 5f63 6f6d             p_com
+0000a590: 6220 3d20 6c69 7374 5f6f 7665 726c 6170  b = list_overlap
+0000a5a0: 735b 785d 5b79 5d2f 746f 7461 6c0a 2020  s[x][y]/total.  
+0000a5b0: 2020 2020 2020 2020 2020 2020 2020 705f                p_
+0000a5c0: 6d32 203d 206d 6170 325f 6672 6571 5b79  m2 = map2_freq[y
+0000a5d0: 5d20 2f20 666c 6f61 7428 6e70 2e73 756d  ] / float(np.sum
+0000a5e0: 286d 6170 325f 6672 6571 2929 0a20 2020  (map2_freq)).   
+0000a5f0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+0000a600: 705f 636f 6d62 203d 3d20 303a 0a20 2020  p_comb == 0:.   
+0000a610: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a620: 206d 695f 7363 6f72 6520 3d20 302e 300a   mi_score = 0.0.
+0000a630: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000a640: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+0000a650: 2020 2020 2020 2020 2020 2048 7879 202b             Hxy +
+0000a660: 3d20 2d70 5f63 6f6d 6220 2a20 6d61 7468  = -p_comb * math
+0000a670: 2e6c 6f67 2870 5f63 6f6d 622c 2032 290a  .log(p_comb, 2).
+0000a680: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a690: 7363 6f72 6520 2b3d 206d 695f 7363 6f72  score += mi_scor
+0000a6a0: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
+0000a6b0: 2020 6966 2078 203d 3d20 3020 616e 6420    if x == 0 and 
+0000a6c0: 6e6f 7420 705f 6d32 203d 3d20 302e 303a  not p_m2 == 0.0:
+0000a6d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000a6e0: 2020 2020 2048 7920 2b3d 2028 2d70 5f6d       Hy += (-p_m
+0000a6f0: 3220 2a20 6d61 7468 2e6c 6f67 2870 5f6d  2 * math.log(p_m
+0000a700: 322c 2032 2929 0a20 2020 2020 2020 2020  2, 2)).         
+0000a710: 2020 2069 6620 6e6f 7420 705f 6d31 203d     if not p_m1 =
+0000a720: 3d20 302e 303a 0a20 2020 2020 2020 2020  = 0.0:.         
+0000a730: 2020 2020 2020 2048 7820 2b3d 2028 2d70         Hx += (-p
+0000a740: 5f6d 3120 2a20 6d61 7468 2e6c 6f67 2870  _m1 * math.log(p
+0000a750: 5f6d 312c 2032 2929 0a20 2020 2020 2020  _m1, 2)).       
+0000a760: 2069 6620 656e 7465 7220 3d3d 2031 3a0a   if enter == 1:.
+0000a770: 2020 2020 2020 2020 2020 2020 6966 2077              if w
+0000a780: 6569 6768 743a 0a20 2020 2020 2020 2020  eight:.         
+0000a790: 2020 2020 2020 2069 6620 4878 7920 3d3d         if Hxy ==
+0000a7a0: 2030 2e30 3a0a 2020 2020 2020 2020 2020   0.0:.          
+0000a7b0: 2020 2020 2020 2020 2020 7265 7475 726e            return
+0000a7c0: 2030 2e30 0a20 2020 2020 2020 2020 2020   0.0.           
+0000a7d0: 2020 2020 2072 6574 7572 6e20 2848 7820       return (Hx 
+0000a7e0: 2b20 4879 2920 2f20 4878 790a 2020 2020  + Hy) / Hxy.    
+0000a7f0: 2020 2020 2020 2020 7265 7475 726e 2048          return H
+0000a800: 7820 2b20 4879 202d 2048 7879 0a20 2020  x + Hy - Hxy.   
+0000a810: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+0000a820: 2020 2020 2020 2072 6574 7572 6e20 4e6f         return No
+0000a830: 6e65 0a0a 2020 2020 6465 6620 4d49 5f6e  ne..    def MI_n
+0000a840: 6577 2873 656c 662c 2065 7870 5f6d 6170  ew(self, exp_map
+0000a850: 2c20 7369 6d5f 6d61 702c 2062 696e 7331  , sim_map, bins1
+0000a860: 3d32 302c 2062 696e 7332 3d32 302c 206e  =20, bins2=20, n
+0000a870: 6f72 6d61 6c69 7365 3d46 616c 7365 293a  ormalise=False):
+0000a880: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
+0000a890: 2020 2020 2054 616b 656e 2066 726f 6d20       Taken from 
+0000a8a0: 6874 7470 733a 2f2f 7374 6163 6b6f 7665  https://stackove
+0000a8b0: 7266 6c6f 772e 636f 6d2f 7175 6573 7469  rflow.com/questi
+0000a8c0: 6f6e 732f 3230 3439 3130 3238 2f6f 7074  ons/20491028/opt
+0000a8d0: 696d 616c 2d77 6179 2d74 6f2d 636f 6d70  imal-way-to-comp
+0000a8e0: 7574 652d 7061 6972 7769 7365 2d6d 7574  ute-pairwise-mut
+0000a8f0: 7561 6c2d 696e 666f 726d 6174 696f 6e2d  ual-information-
+0000a900: 7573 696e 672d 6e75 6d70 790a 2020 2020  using-numpy.    
+0000a910: 2020 2020 2222 220a 0a20 2020 2020 2020      """..       
+0000a920: 2063 5f78 792c 2078 2c20 7920 3d20 6e70   c_xy, x, y = np
+0000a930: 2e68 6973 746f 6772 616d 3264 2865 7870  .histogram2d(exp
+0000a940: 5f6d 6170 2e66 756c 6c4d 6170 2e72 6176  _map.fullMap.rav
+0000a950: 656c 2829 2c0a 2020 2020 2020 2020 2020  el(),.          
+0000a960: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a970: 2020 7369 6d5f 6d61 702e 6675 6c6c 4d61    sim_map.fullMa
+0000a980: 702e 7261 7665 6c28 292c 0a20 2020 2020  p.ravel(),.     
+0000a990: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a9a0: 2020 2020 2020 2062 696e 733d 5b62 696e         bins=[bin
+0000a9b0: 7331 2c20 6269 6e73 325d 290a 0a20 2020  s1, bins2])..   
+0000a9c0: 2020 2020 2067 2c20 5f2c 205f 2c20 5f20       g, _, _, _ 
+0000a9d0: 3d20 7374 6174 732e 6368 6932 5f63 6f6e  = stats.chi2_con
+0000a9e0: 7469 6e67 656e 6379 2863 5f78 792c 206c  tingency(c_xy, l
+0000a9f0: 616d 6264 615f 3d27 6c6f 672d 6c69 6b65  ambda_='log-like
+0000aa00: 6c69 686f 6f64 2729 0a0a 2020 2020 2020  lihood')..      
+0000aa10: 2020 6d69 5f6e 6c20 3d20 302e 3520 2a20    mi_nl = 0.5 * 
+0000aa20: 6720 2f20 635f 7879 2e73 756d 2829 0a0a  g / c_xy.sum()..
+0000aa30: 2020 2020 2020 2020 7265 7475 726e 206e          return n
+0000aa40: 702e 6c6f 6732 286e 702e 6578 7028 6d69  p.log2(np.exp(mi
+0000aa50: 5f6e 6c29 290a 0a20 2020 2064 6566 205f  _nl))..    def _
+0000aa60: 6861 7573 646f 7266 665f 6c69 7374 280a  hausdorff_list(.
+0000aa70: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+0000aa80: 2c0a 2020 2020 2020 2020 2020 2020 7072  ,.            pr
+0000aa90: 696d 6172 795f 626f 756e 6461 7279 2c0a  imary_boundary,.
+0000aaa0: 2020 2020 2020 2020 2020 2020 7365 636f              seco
+0000aab0: 6e64 6172 795f 626f 756e 6461 7279 2c0a  ndary_boundary,.
+0000aac0: 2020 2020 2020 2020 2020 2020 6b64 7472              kdtr
+0000aad0: 6565 2c0a 2020 2020 2020 2020 2020 2020  ee,.            
+0000aae0: 6d61 705f 7072 6f62 652c 0a20 2020 2029  map_probe,.    )
+0000aaf0: 3a0a 2020 2020 2020 2020 2222 220a 2020  :.        """.  
+0000ab00: 2020 2020 2020 5468 6973 2069 7320 666f        This is fo
+0000ab10: 7220 7468 6520 6368 616d 6465 6620 6469  r the chamdef di
+0000ab20: 7374 616e 6365 2064 6566 2063 6861 6d66  stance def chamf
+0000ab30: 6572 5f64 6973 7461 6e63 652c 206d 696e  er_distance, min
+0000ab40: 206d 6178 2064 656e 7369 7479 0a20 2020   max density.   
+0000ab50: 2020 2020 2076 616c 7565 2074 6861 7420       value that 
+0000ab60: 6465 6669 6e65 2074 6865 2073 7572 6661  define the surfa
+0000ab70: 6365 206f 6620 7468 6520 7072 6f74 6569  ce of the protei
+0000ab80: 6e0a 0a20 2020 2020 2020 2041 7267 756d  n..        Argum
+0000ab90: 656e 7473 3a0a 2020 2020 2020 2020 2020  ents:.          
+0000aba0: 2020 2a6b 6474 7265 652a 0a20 2020 2020    *kdtree*.     
+0000abb0: 2020 2020 2020 2020 2020 2028 7468 6572             (ther
+0000abc0: 6520 6172 6520 3220 6f66 2074 6865 6d20  e are 2 of them 
+0000abd0: 696e 206e 756d 7079 206f 6e65 2043 6261  in numpy one Cba
+0000abe0: 7365 6420 6f6e 2070 792d 6261 7365 642c  sed on py-based,
+0000abf0: 2074 6865 0a20 2020 2020 2020 2020 2020   the.           
+0000ac00: 2020 2020 206c 6174 7465 7220 6973 2062       latter is b
+0000ac10: 6574 7465 722c 2063 7472 6c29 2074 6869  etter, ctrl) thi
+0000ac20: 7320 6861 7665 2074 6f20 6265 206f 6e65  s have to be one
+0000ac30: 206f 6620 7468 6520 696e 7075 742e 0a20   of the input.. 
+0000ac40: 2020 2020 2020 2020 2020 2020 2020 206b                 k
+0000ac50: 6474 7265 6520 6672 6f6d 206d 6170 5f74  dtree from map_t
+0000ac60: 6172 6765 740a 2020 2020 2020 2020 2020  arget.          
+0000ac70: 2020 2a70 7269 6d61 7279 5f62 6f75 6e64    *primary_bound
+0000ac80: 6172 792c 2073 6563 6f6e 6461 7279 5f62  ary, secondary_b
+0000ac90: 6f75 6e64 6172 792a 0a20 2020 2020 2020  oundary*.       
+0000aca0: 2020 2020 2020 2020 206e 6565 6420 746f           need to
+0000acb0: 2072 756e 2067 6574 5f70 7269 6d61 7279   run get_primary
+0000acc0: 5f62 6f75 6e64 6172 7920 616e 6420 6765  _boundary and ge
+0000acd0: 745f 7365 636f 6e64 5f62 6f75 6e64 6172  t_second_boundar
+0000ace0: 7920 666f 720a 2020 2020 2020 2020 2020  y for.          
+0000acf0: 2020 2020 2020 6d61 705f 7072 6f62 650a        map_probe.
+0000ad00: 0a20 2020 2020 2020 2020 2020 204e 4f54  .            NOT
+0000ad10: 453a 2069 6620 796f 7520 6b65 6570 2074  E: if you keep t
+0000ad20: 6865 206b 6474 7265 6520 6173 2070 6172  he kdtree as par
+0000ad30: 616d 6574 7265 206f 7574 206f 7320 6c65  ametre out os le
+0000ad40: 7373 2074 696d 650a 2020 2020 2020 2020  ss time.        
+0000ad50: 2020 2020 636f 6e73 756d 696e 6720 6173      consuming as
+0000ad60: 2062 7569 6c64 696e 6720 6974 2074 616b   building it tak
+0000ad70: 6573 2074 696d 652e 0a20 2020 2020 2020  es time..       
+0000ad80: 2022 2222 0a20 2020 2020 2020 2070 6f69   """.        poi
+0000ad90: 6e74 7320 3d20 6d61 705f 7072 6f62 652e  nts = map_probe.
+0000ada0: 6765 745f 706f 7328 7072 696d 6172 795f  get_pos(primary_
+0000adb0: 626f 756e 6461 7279 2c20 7365 636f 6e64  boundary, second
+0000adc0: 6172 795f 626f 756e 6461 7279 290a 2020  ary_boundary).  
+0000add0: 2020 2020 2020 7265 7475 726e 206b 6474        return kdt
+0000ade0: 7265 652e 7175 6572 7928 706f 696e 7473  ree.query(points
+0000adf0: 295b 305d 0a0a 2020 2020 6465 6620 6368  )[0]..    def ch
+0000ae00: 616d 6665 725f 6469 7374 616e 6365 280a  amfer_distance(.
+0000ae10: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+0000ae20: 2c0a 2020 2020 2020 2020 2020 2020 6d61  ,.            ma
+0000ae30: 705f 7461 7267 6574 2c0a 2020 2020 2020  p_target,.      
+0000ae40: 2020 2020 2020 6d61 705f 7072 6f62 652c        map_probe,
+0000ae50: 0a20 2020 2020 2020 2020 2020 2070 7269  .            pri
+0000ae60: 6d61 7279 5f62 6f75 6e64 6172 792c 0a20  mary_boundary,. 
+0000ae70: 2020 2020 2020 2020 2020 2073 6563 6f6e             secon
+0000ae80: 6461 7279 5f62 6f75 6e64 6172 792c 0a20  dary_boundary,. 
+0000ae90: 2020 2020 2020 2020 2020 206b 6474 7265             kdtre
+0000aea0: 653d 4e6f 6e65 2c0a 2020 2020 293a 0a20  e=None,.    ):. 
+0000aeb0: 2020 2020 2020 2022 2222 4361 6c63 756c         """Calcul
+0000aec0: 6174 6520 7468 6520 6368 616d 6665 7220  ate the chamfer 
+0000aed0: 6469 7374 616e 6365 2053 636f 7265 2062  distance Score b
+0000aee0: 6574 7765 656e 2074 776f 204d 6170 2069  etween two Map i
+0000aef0: 6e73 7461 6e63 6573 2e0a 0a20 2020 2020  nstances...     
+0000af00: 2020 2043 7572 7265 6e74 6c79 2075 6e73     Currently uns
+0000af10: 7461 626c 6520 616e 6420 6e6f 7420 7265  table and not re
+0000af20: 636f 6d6d 656e 6465 6420 666f 7220 7573  commended for us
+0000af30: 652e 0a0a 2020 2020 2020 2020 4172 6775  e...        Argu
+0000af40: 6d65 6e74 733a 0a20 2020 2020 2020 2020  ments:.         
+0000af50: 2020 206d 6170 5f74 6172 6765 742c 206d     map_target, m
+0000af60: 6170 5f70 726f 6265 3a20 4d61 7020 696e  ap_probe: Map in
+0000af70: 7374 616e 6365 7320 746f 2063 6f6d 7061  stances to compa
+0000af80: 7265 2e0a 2020 2020 2020 2020 2020 2020  re..            
+0000af90: 7072 696d 6172 795f 626f 756e 6461 7279  primary_boundary
+0000afa0: 3a20 5468 7265 7368 6f6c 6420 7468 6174  : Threshold that
+0000afb0: 2064 6566 696e 6564 2074 6865 2045 4d20   defined the EM 
+0000afc0: 6d61 7020 7375 7266 6163 652c 2062 6173  map surface, bas
+0000afd0: 6564 0a20 2020 2020 2020 2020 2020 2020  ed.             
+0000afe0: 2020 206f 6e20 7468 6520 766f 6c75 6d65     on the volume
+0000aff0: 206f 6620 7468 6520 7072 6f74 6569 6e20   of the protein 
+0000b000: 6d6f 6465 6c2e 2043 616e 2062 6520 6361  model. Can be ca
+0000b010: 6c63 756c 6174 6564 2075 7369 6e67 0a20  lculated using. 
+0000b020: 2020 2020 2020 2020 2020 2020 2020 203a                 :
+0000b030: 6d65 7468 3a60 4d61 702e 6d61 6b65 4b44  meth:`Map.makeKD
+0000b040: 5472 6565 203c 5445 4d50 792e 6d61 7073  Tree <TEMPy.maps
+0000b050: 2e65 6d5f 6d61 702e 4d61 702e 6765 745f  .em_map.Map.get_
+0000b060: 7072 696d 6172 795f 626f 756e 6461 7279  primary_boundary
+0000b070: 3e60 0a20 2020 2020 2020 2020 2020 2073  >`.            s
+0000b080: 6563 6f6e 6461 7279 5f62 6f75 6e64 6172  econdary_boundar
+0000b090: 793a 2054 6865 2073 6563 6f6e 6420 626f  y: The second bo
+0000b0a0: 756e 6420 6465 6e73 6974 7920 706f 696e  und density poin
+0000b0b0: 742e 0a20 2020 2020 2020 2020 2020 2020  t..             
+0000b0c0: 2020 2043 616e 2062 6520 6361 6c63 756c     Can be calcul
+0000b0d0: 6174 6564 2075 7369 6e67 0a20 2020 2020  ated using.     
+0000b0e0: 2020 2020 2020 2020 2020 203a 6d65 7468             :meth
+0000b0f0: 3a60 4d61 702e 6d61 6b65 4b44 5472 6565  :`Map.makeKDTree
+0000b100: 203c 5445 4d50 792e 6d61 7073 2e65 6d5f   <TEMPy.maps.em_
+0000b110: 6d61 702e 4d61 702e 6765 745f 7365 636f  map.Map.get_seco
+0000b120: 6e64 5f62 6f75 6e64 6172 793e 600a 2020  nd_boundary>`.  
+0000b130: 2020 2020 2020 2020 2020 6b64 7472 6565            kdtree
+0000b140: 3a20 5072 6563 616c 6375 6c61 7465 6420  : Precalculated 
+0000b150: 6b64 7472 6565 2e20 4966 204e 6f6e 652c  kdtree. If None,
+0000b160: 204b 4454 7265 6520 6973 2063 6f6e 7374   KDTree is const
+0000b170: 7275 6374 6564 2075 7369 6e67 0a20 2020  ructed using.   
+0000b180: 2020 2020 2020 2020 2020 2020 203a 6d65               :me
+0000b190: 7468 3a60 4d61 702e 6d61 6b65 4b44 5472  th:`Map.makeKDTr
+0000b1a0: 6565 203c 5445 4d50 792e 6d61 7073 2e65  ee <TEMPy.maps.e
+0000b1b0: 6d5f 6d61 702e 4d61 702e 6d61 6b65 4b44  m_map.Map.makeKD
+0000b1c0: 5472 6565 3e60 0a20 2020 2020 2020 2022  Tree>`.        "
+0000b1d0: 2222 0a20 2020 2020 2020 2069 6620 7365  "".        if se
+0000b1e0: 6c66 2e6d 6170 436f 6d70 6172 6973 6f6e  lf.mapComparison
+0000b1f0: 286d 6170 5f74 6172 6765 742c 206d 6170  (map_target, map
+0000b200: 5f70 726f 6265 293a 0a20 2020 2020 2020  _probe):.       
+0000b210: 2020 2020 206d 312c 206d 3220 3d20 6d61       m1, m2 = ma
+0000b220: 705f 7461 7267 6574 2c20 6d61 705f 7072  p_target, map_pr
+0000b230: 6f62 650a 2020 2020 2020 2020 656c 7365  obe.        else
+0000b240: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
+0000b250: 6c66 2e5f 6661 696c 6564 5f6d 6174 6368  lf._failed_match
+0000b260: 2829 0a20 2020 2020 2020 2069 6620 6b64  ().        if kd
+0000b270: 7472 6565 3a0a 2020 2020 2020 2020 2020  tree:.          
+0000b280: 2020 7265 7475 726e 2073 656c 662e 5f68    return self._h
+0000b290: 6175 7364 6f72 6666 5f6c 6973 7428 0a20  ausdorff_list(. 
+0000b2a0: 2020 2020 2020 2020 2020 2020 2020 2070                 p
+0000b2b0: 7269 6d61 7279 5f62 6f75 6e64 6172 792c  rimary_boundary,
+0000b2c0: 2073 6563 6f6e 6461 7279 5f62 6f75 6e64   secondary_bound
+0000b2d0: 6172 792c 206b 6474 7265 652c 206d 320a  ary, kdtree, m2.
+0000b2e0: 2020 2020 2020 2020 2020 2020 292e 6d65              ).me
+0000b2f0: 616e 2829 0a20 2020 2020 2020 2065 6c73  an().        els
+0000b300: 653a 0a20 2020 2020 2020 2020 2020 2070  e:.            p
+0000b310: 7269 6e74 286d 312c 2070 7269 6d61 7279  rint(m1, primary
+0000b320: 5f62 6f75 6e64 6172 792c 2073 6563 6f6e  _boundary, secon
+0000b330: 6461 7279 5f62 6f75 6e64 6172 7929 0a20  dary_boundary). 
+0000b340: 2020 2020 2020 2020 2020 206b 6474 7265             kdtre
+0000b350: 6520 3d20 6d31 2e6d 616b 654b 4454 7265  e = m1.makeKDTre
+0000b360: 6528 7072 696d 6172 795f 626f 756e 6461  e(primary_bounda
+0000b370: 7279 2c20 7365 636f 6e64 6172 795f 626f  ry, secondary_bo
+0000b380: 756e 6461 7279 290a 2020 2020 2020 2020  undary).        
+0000b390: 2020 2020 6966 206b 6474 7265 6520 6973      if kdtree is
+0000b3a0: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
+0000b3b0: 2020 2020 2020 2070 7269 6e74 2827 4572         print('Er
+0000b3c0: 726f 722e 204e 6f20 706f 696e 7473 2073  ror. No points s
+0000b3d0: 656c 6563 7465 642c 2063 6861 6e67 6520  elected, change 
+0000b3e0: 626f 756e 6461 7279 2070 6172 616d 6574  boundary paramet
+0000b3f0: 6572 732e 2729 0a20 2020 2020 2020 2020  ers.').         
+0000b400: 2020 2020 2020 2073 7973 2e65 7869 7428         sys.exit(
+0000b410: 290a 2020 2020 2020 2020 2020 2020 656c  ).            el
+0000b420: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+0000b430: 2020 2020 7265 7475 726e 2073 656c 662e      return self.
+0000b440: 5f68 6175 7364 6f72 6666 5f6c 6973 7428  _hausdorff_list(
+0000b450: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000b460: 2020 2020 2070 7269 6d61 7279 5f62 6f75       primary_bou
+0000b470: 6e64 6172 792c 0a20 2020 2020 2020 2020  ndary,.         
+0000b480: 2020 2020 2020 2020 2020 2073 6563 6f6e             secon
+0000b490: 6461 7279 5f62 6f75 6e64 6172 792c 0a20  dary_boundary,. 
+0000b4a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b4b0: 2020 206b 6474 7265 652c 0a20 2020 2020     kdtree,.     
+0000b4c0: 2020 2020 2020 2020 2020 2020 2020 206d                 m
+0000b4d0: 320a 2020 2020 2020 2020 2020 2020 2020  2.              
+0000b4e0: 2020 292e 6d65 616e 2829 0a0a 2020 2020    ).mean()..    
+0000b4f0: 6465 6620 5f73 7572 6661 6365 5f64 6973  def _surface_dis
+0000b500: 7461 6e63 655f 7363 6f72 6528 0a20 2020  tance_score(.   
+0000b510: 2020 2020 2020 2020 2073 656c 662c 0a20           self,. 
+0000b520: 2020 2020 2020 2020 2020 206d 6170 5f74             map_t
+0000b530: 6172 6765 742c 0a20 2020 2020 2020 2020  arget,.         
+0000b540: 2020 206d 6170 5f70 726f 6265 2c0a 2020     map_probe,.  
+0000b550: 2020 2020 2020 2020 2020 6d61 705f 7461            map_ta
+0000b560: 7267 6574 5f74 6872 6573 686f 6c64 313d  rget_threshold1=
+0000b570: 302e 302c 0a20 2020 2020 2020 2020 2020  0.0,.           
+0000b580: 206d 6170 5f70 726f 6265 5f74 6872 6573   map_probe_thres
+0000b590: 686f 6c64 3d30 2e30 2c0a 2020 2020 2020  hold=0.0,.      
+0000b5a0: 2020 2020 2020 4669 6c74 6572 3d4e 6f6e        Filter=Non
+0000b5b0: 652c 0a20 2020 2020 2020 2020 2020 206d  e,.            m
+0000b5c0: 6170 5f74 6172 6765 745f 7468 7265 7368  ap_target_thresh
+0000b5d0: 6f6c 6432 3d30 2e30 2c0a 2020 2020 2020  old2=0.0,.      
+0000b5e0: 2020 2020 2020 7765 6967 6874 3d46 616c        weight=Fal
+0000b5f0: 7365 0a20 2020 2029 3a0a 2020 2020 2020  se.    ):.      
+0000b600: 2020 2222 220a 2020 2020 2020 2020 4361    """.        Ca
+0000b610: 6c63 756c 6174 6520 7468 6520 6368 616d  lculate the cham
+0000b620: 6665 7220 6469 7374 616e 6365 2053 636f  fer distance Sco
+0000b630: 7265 2062 6574 7765 656e 2074 776f 204d  re between two M
+0000b640: 6170 2069 6e73 7461 6e63 6573 2e0a 0a20  ap instances... 
+0000b650: 2020 2020 2020 2041 7267 756d 656e 7473         Arguments
+0000b660: 3a0a 2020 2020 2020 2020 2020 2020 2a6d  :.            *m
+0000b670: 6170 5f74 6172 6765 742c 206d 6170 5f70  ap_target, map_p
+0000b680: 726f 6265 2a0a 2020 2020 2020 2020 2020  robe*.          
+0000b690: 2020 2020 2020 454d 4d61 7020 696e 7374        EMMap inst
+0000b6a0: 616e 6365 7320 746f 2063 6f6d 7061 7265  ances to compare
+0000b6b0: 2e0a 2020 2020 2020 2020 2020 2020 2a6d  ..            *m
+0000b6c0: 6170 5f74 6172 6765 745f 7468 7265 7368  ap_target_thresh
+0000b6d0: 6f6c 6431 2a0a 2020 2020 2020 2020 2020  old1*.          
+0000b6e0: 2020 2020 2020 636f 6e74 6f75 7220 7468        contour th
+0000b6f0: 7265 7368 6f6c 6420 6f66 2074 6865 2074  reshold of the t
+0000b700: 6172 6765 7420 6d61 702e 0a20 2020 2020  arget map..     
+0000b710: 2020 2020 2020 2020 2020 2054 6869 7320             This 
+0000b720: 7661 6c75 6520 6973 2075 7365 6420 7468  value is used th
+0000b730: 6520 7072 696d 6172 7920 626f 756e 6461  e primary bounda
+0000b740: 7279 2069 660a 2020 2020 2020 2020 2020  ry if.          
+0000b750: 2020 2020 2020 6d61 705f 7461 7267 6574        map_target
+0000b760: 5f74 6872 6573 686f 6c64 3220 6973 2067  _threshold2 is g
+0000b770: 6976 656e 2e0a 2020 2020 2020 2020 2020  iven..          
+0000b780: 2020 2a6d 6170 5f70 726f 6265 5f74 6872    *map_probe_thr
+0000b790: 6573 686f 6c64 2a0a 2020 2020 2020 2020  eshold*.        
+0000b7a0: 2020 2020 2020 2020 636f 6e74 6f75 7220          contour 
+0000b7b0: 7468 7265 7368 6f6c 6420 666f 7220 7468  threshold for th
+0000b7c0: 6520 7072 6f62 6520 6d61 702e 0a20 2020  e probe map..   
+0000b7d0: 2020 2020 2020 2020 202a 4669 6c74 6572           *Filter
+0000b7e0: 2a0a 2020 2020 2020 2020 2020 2020 2020  *.              
+0000b7f0: 2020 6465 6669 6e69 7469 6f6e 206f 6620    definition of 
+0000b800: 7468 6520 7375 7266 6163 653a 0a20 2020  the surface:.   
+0000b810: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b820: 2031 2920 4e6f 6e65 203a 2073 7572 6661   1) None : surfa
+0000b830: 6365 2064 6566 696e 6564 2062 7920 6b6e  ce defined by kn
+0000b840: 6f77 6e20 626f 756e 6461 7269 6573 202d  own boundaries -
+0000b850: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000b860: 2020 2020 2020 2020 2020 2020 2020 206d                 m
+0000b870: 6170 5f74 6172 6765 745f 7468 7265 7368  ap_target_thresh
+0000b880: 6f6c 6431 2026 206d 6170 5f74 6172 6765  old1 & map_targe
+0000b890: 745f 7468 7265 7368 6f6c 6432 0a20 2020  t_threshold2.   
 0000b8a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b8b0: 2020 2020 2073 6d61 6c6c 206d 6170 732c       small maps,
-0000b8c0: 2068 6967 6865 7220 7661 6c75 6573 2028   higher values (
-0000b8d0: 6567 3a20 3130 2573 6967 6d61 290a 2020  eg: 10%sigma).  
-0000b8e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b8f0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-0000b900: 616e 2062 6520 7573 6564 2e0a 2020 2020  an be used..    
-0000b910: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b920: 2020 2020 3329 204d 6561 6e3a 2061 206d      3) Mean: a m
-0000b930: 6561 6e20 6669 6c74 6572 2069 7320 6170  ean filter is ap
-0000b940: 706c 6965 6420 6f6e 2074 6865 2062 696e  plied on the bin
-0000b950: 6172 7920 636f 6e74 6f75 720a 2020 2020  ary contour.    
-0000b960: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b970: 2020 2020 2020 2020 2020 2020 206d 6173               mas
-0000b980: 6b20 6f76 6572 2061 206c 6f6e 6720 7769  k over a long wi
-0000b990: 6e64 6f77 2e20 5468 6520 7265 7375 6c74  ndow. The result
-0000b9a0: 696e 6720 6d61 736b 0a20 2020 2020 2020  ing mask.       
-0000b9b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b9c0: 2020 2020 2020 2020 2020 6861 7320 7661            has va
-0000b9d0: 6c75 6573 2062 6574 7765 656e 2030 2061  lues between 0 a
-0000b9e0: 6e64 2031 2e20 506f 696e 7473 2077 6974  nd 1. Points wit
-0000b9f0: 6820 7661 6c75 6573 0a20 2020 2020 2020  h values.       
+0000b8b0: 2049 6620 7468 6520 626f 756e 6461 7269   If the boundari
+0000b8c0: 6573 2061 7265 206e 6f74 206b 6e6f 776e  es are not known
+0000b8d0: 2061 6e64 2074 6172 6765 7426 7072 6f62   and target&prob
+0000b8e0: 6520 6d61 700a 2020 2020 2020 2020 2020  e map.          
+0000b8f0: 2020 2020 2020 2020 2020 636f 6e74 6f75            contou
+0000b900: 7220 6c65 7665 6c73 2061 7265 206b 6e6f  r levels are kno
+0000b910: 776e 3a0a 2020 2020 2020 2020 2020 2020  wn:.            
+0000b920: 2020 2020 2020 2020 2020 2020 3229 2053              2) S
+0000b930: 7464 203a 2074 6f20 6465 6669 6e65 2074  td : to define t
+0000b940: 6865 2062 6f75 6e64 6172 6965 732c 2063  he boundaries, c
+0000b950: 6f6e 746f 7572 206c 6576 656c 202b 2d20  ontour level +- 
+0000b960: 3525 0a20 2020 2020 2020 2020 2020 2020  5%.             
+0000b970: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b980: 2020 2020 7369 676d 6120 6973 2063 616c      sigma is cal
+0000b990: 6375 6c61 7465 642e 2035 2573 6967 6d61  culated. 5%sigma
+0000b9a0: 2069 7320 7573 6564 2074 6f20 6c69 6d69   is used to limi
+0000b9b0: 740a 2020 2020 2020 2020 2020 2020 2020  t.              
+0000b9c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b9d0: 2020 2074 6865 206e 756d 6265 7220 6f66     the number of
+0000b9e0: 2070 6f69 6e74 7320 7069 636b 6564 2061   points picked a
+0000b9f0: 7320 7375 7266 6163 652e 2046 6f72 0a20  s surface. For. 
 0000ba00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ba10: 2020 2020 2020 2020 2020 6c65 7373 2074            less t
-0000ba20: 6861 6e20 302e 3320 6973 2075 7365 6420  han 0.3 is used 
-0000ba30: 746f 2072 6570 7265 7365 6e74 2073 7572  to represent sur
-0000ba40: 6661 6365 2e0a 2020 2020 2020 2020 2020  face..          
+0000ba10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ba20: 736d 616c 6c20 6d61 7073 2c20 6869 6768  small maps, high
+0000ba30: 6572 2076 616c 7565 7320 2865 673a 2031  er values (eg: 1
+0000ba40: 3025 7369 676d 6129 0a20 2020 2020 2020  0%sigma).       
 0000ba50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ba60: 2020 2020 2020 2041 7320 7468 6520 6176         As the av
-0000ba70: 6572 6167 6520 6973 2063 616c 6375 6c61  erage is calcula
-0000ba80: 7465 6420 6f6e 2061 206c 6f6e 6720 7769  ted on a long wi
-0000ba90: 6e64 6f77 2c0a 2020 2020 2020 2020 2020  ndow,.          
-0000baa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000bab0: 2020 2020 2020 2068 6967 686c 7920 6578         highly ex
-0000bac0: 706f 7365 6420 7375 7266 6163 6520 706f  posed surface po
-0000bad0: 696e 7473 2068 6176 6520 7665 7279 206c  ints have very l
-0000bae0: 6f77 0a20 2020 2020 2020 2020 2020 2020  ow.             
-0000baf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000bb00: 2020 2020 7661 6c75 6573 2061 6e64 2070      values and p
-0000bb10: 6172 7469 616c 6c79 2065 7870 6f73 6564  artially exposed
-0000bb20: 2073 7572 6661 6365 732f 6772 6f6f 7665   surfaces/groove
-0000bb30: 730a 2020 2020 2020 2020 2020 2020 2020  s.              
-0000bb40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000bb50: 2020 2068 6176 6520 7265 6c61 7469 7665     have relative
-0000bb60: 6c79 2068 6967 6865 7220 7661 6c75 6573  ly higher values
-0000bb70: 2e0a 2020 2020 2020 2020 2020 2020 2020  ..              
-0000bb80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000bb90: 2020 2054 6869 7320 6465 6669 6e69 7469     This definiti
-0000bba0: 6f6e 2069 7320 7573 6566 756c 2065 7370  on is useful esp
-0000bbb0: 6563 6961 6c6c 7920 7768 656e 2074 6865  ecially when the
-0000bbc0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000bbd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000bbe0: 2020 6d61 7020 7375 7266 6163 6520 6861    map surface ha
-0000bbf0: 7320 6d61 6e79 2066 6561 7475 7265 732f  s many features/
-0000bc00: 7072 6f6a 6563 7469 6f6e 732e 0a20 2020  projections..   
+0000ba60: 2020 2020 2020 2020 2020 6361 6e20 6265            can be
+0000ba70: 2075 7365 642e 0a20 2020 2020 2020 2020   used..         
+0000ba80: 2020 2020 2020 2020 2020 2020 2020 2033                 3
+0000ba90: 2920 4d65 616e 3a20 6120 6d65 616e 2066  ) Mean: a mean f
+0000baa0: 696c 7465 7220 6973 2061 7070 6c69 6564  ilter is applied
+0000bab0: 206f 6e20 7468 6520 6269 6e61 7279 2063   on the binary c
+0000bac0: 6f6e 746f 7572 0a20 2020 2020 2020 2020  ontour.         
+0000bad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000bae0: 2020 2020 2020 2020 6d61 736b 206f 7665          mask ove
+0000baf0: 7220 6120 6c6f 6e67 2077 696e 646f 772e  r a long window.
+0000bb00: 2054 6865 2072 6573 756c 7469 6e67 206d   The resulting m
+0000bb10: 6173 6b0a 2020 2020 2020 2020 2020 2020  ask.            
+0000bb20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000bb30: 2020 2020 2068 6173 2076 616c 7565 7320       has values 
+0000bb40: 6265 7477 6565 6e20 3020 616e 6420 312e  between 0 and 1.
+0000bb50: 2050 6f69 6e74 7320 7769 7468 2076 616c   Points with val
+0000bb60: 7565 730a 2020 2020 2020 2020 2020 2020  ues.            
+0000bb70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000bb80: 2020 2020 206c 6573 7320 7468 616e 2030       less than 0
+0000bb90: 2e33 2069 7320 7573 6564 2074 6f20 7265  .3 is used to re
+0000bba0: 7072 6573 656e 7420 7375 7266 6163 652e  present surface.
+0000bbb0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000bbc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000bbd0: 2020 4173 2074 6865 2061 7665 7261 6765    As the average
+0000bbe0: 2069 7320 6361 6c63 756c 6174 6564 206f   is calculated o
+0000bbf0: 6e20 6120 6c6f 6e67 2077 696e 646f 772c  n a long window,
+0000bc00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
 0000bc10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000bc20: 2020 2020 2034 2920 4d69 6e69 6d75 6d3a       4) Minimum:
-0000bc30: 2061 206d 696e 696d 756d 2066 696c 7465   a minimum filte
-0000bc40: 7220 6973 2061 7070 6c69 6564 206f 6e20  r is applied on 
-0000bc50: 6120 6269 6e61 7279 0a20 2020 2020 2020  a binary.       
-0000bc60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000bc70: 2020 2020 2020 2020 2020 2020 2063 6f6e               con
-0000bc80: 746f 7572 206d 6173 6b20 746f 206c 6f63  tour mask to loc
-0000bc90: 6174 6520 7375 7266 6163 6520 706f 696e  ate surface poin
-0000bca0: 7473 2e0a 2020 2020 2020 2020 2020 2020  ts..            
-0000bcb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000bcc0: 2020 2020 2020 2020 566f 7865 6c73 2073          Voxels s
-0000bcd0: 7572 726f 756e 6465 6420 6279 2070 6f69  urrounded by poi
-0000bce0: 6e74 7320 6f75 7473 6964 6520 7468 650a  nts outside the.
-0000bcf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000bd00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000bd10: 2020 2020 636f 6e74 6f75 7220 287a 6572      contour (zer
-0000bd20: 6f65 7329 2061 7265 2064 6574 6563 7465  oes) are detecte
-0000bd30: 6420 6173 2073 7572 6661 6365 2e0a 2020  d as surface..  
-0000bd40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000bd50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000bd60: 2020 566f 7865 6c73 2073 7572 726f 756e    Voxels surroun
-0000bd70: 6465 6420 6279 2070 6f69 6e74 7320 6f75  ded by points ou
-0000bd80: 7473 6964 6520 7468 650a 2020 2020 2020  tside the.      
-0000bd90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000bda0: 2020 2020 2020 2020 2020 2020 2020 636f                co
-0000bdb0: 6e74 6f75 7220 287a 6572 6f65 7329 2061  ntour (zeroes) a
-0000bdc0: 7265 2064 6574 6563 7465 6420 6173 2073  re detected as s
-0000bdd0: 7572 6661 6365 2e0a 2020 2020 2020 2020  urface..        
-0000bde0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000bdf0: 3529 2053 6f62 656c 3a20 736f 6265 6c20  5) Sobel: sobel 
-0000be00: 6669 6c74 6572 2069 7320 6170 706c 6965  filter is applie
-0000be10: 6420 6f6e 2074 6865 206d 6170 2074 6f20  d on the map to 
-0000be20: 6465 7465 6374 0a20 2020 2020 2020 2020  detect.         
-0000be30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000be40: 2020 2020 2020 2020 2068 6967 6820 6465           high de
-0000be50: 6e73 6974 7920 6772 6164 6965 6e74 732e  nsity gradients.
-0000be60: 2042 6566 6f72 6520 6170 706c 7969 6e67   Before applying
-0000be70: 2074 6865 0a20 2020 2020 2020 2020 2020   the.           
-0000be80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000be90: 2020 2020 2020 2073 6f62 656c 2066 696c         sobel fil
-0000bea0: 7465 722c 2069 7420 6973 2069 6d70 6f72  ter, it is impor
-0000beb0: 7461 6e74 2074 6f20 7265 6475 6365 2074  tant to reduce t
-0000bec0: 6865 0a20 2020 2020 2020 2020 2020 2020  he.             
-0000bed0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000bee0: 2020 2020 206e 6f69 7365 2064 656e 7369       noise densi
-0000bef0: 7479 2061 6e64 206c 6172 6765 2076 6172  ty and large var
-0000bf00: 6961 7469 6f6e 730a 2020 2020 2020 2020  iations.        
-0000bf10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000bf20: 2020 2020 2020 2020 2020 2867 7261 6469            (gradi
-0000bf30: 656e 7473 2920 696e 2074 6865 206e 6f69  ents) in the noi
-0000bf40: 7365 2072 6567 696f 6e2e 0a20 2020 2020  se region..     
-0000bf50: 2020 2020 2020 202a 7765 6967 6874 2a0a         *weight*.
-0000bf60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000bf70: 4966 2073 6574 2074 7275 652c 2074 6865  If set true, the
-0000bf80: 2064 6973 7461 6e63 6573 2062 6574 7765   distances betwe
-0000bf90: 656e 2074 6865 2073 7572 6661 6365 2070  en the surface p
-0000bfa0: 6f69 6e74 7320 6973 0a20 2020 2020 2020  oints is.       
-0000bfb0: 2020 2020 2020 2020 206e 6f72 6d61 6c69           normali
-0000bfc0: 7a65 6420 696e 2061 2077 6179 2073 696d  zed in a way sim
-0000bfd0: 696c 6172 2074 6f20 4744 5420 285a 656d  ilar to GDT (Zem
-0000bfe0: 6c61 2032 3030 3729 0a20 2020 2020 2020  la 2007).       
-0000bff0: 2020 2020 2020 2020 2063 616c 6375 6c61           calcula
-0000c000: 7469 6f6e 2066 6f72 2061 746f 6d69 6320  tion for atomic 
-0000c010: 636f 2d6f 7264 696e 6174 6520 616c 6967  co-ordinate alig
-0000c020: 6e6d 656e 7473 2e0a 2020 2020 2020 2020  nments..        
-0000c030: 2222 220a 2020 2020 2020 2020 2320 6368  """.        # ch
-0000c040: 6563 6b20 6966 2062 6f74 6820 6d61 7073  eck if both maps
-0000c050: 2061 7265 206f 6e20 7468 6520 7361 6d65   are on the same
-0000c060: 2067 7269 640a 2020 2020 2020 2020 6966   grid.        if
-0000c070: 206e 6f74 2073 656c 662e 6d61 7043 6f6d   not self.mapCom
-0000c080: 7061 7269 736f 6e28 6d61 705f 7461 7267  parison(map_targ
-0000c090: 6574 2c20 6d61 705f 7072 6f62 6529 3a0a  et, map_probe):.
-0000c0a0: 2020 2020 2020 2020 2020 2020 7072 696e              prin
-0000c0b0: 7428 2740 4040 204d 6170 7320 636f 756c  t('@@@ Maps coul
-0000c0c0: 6420 6e6f 7420 6265 206d 6174 6368 6564  d not be matched
-0000c0d0: 2729 0a20 2020 2020 2020 2020 2020 2072  ').            r
-0000c0e0: 6574 7572 6e20 2d39 3939 2e0a 2020 2020  eturn -999..    
-0000c0f0: 2020 2020 2320 6966 2074 6865 2062 6f75      # if the bou
-0000c100: 6e64 6172 6965 7320 6172 6520 6b6e 6f77  ndaries are know
-0000c110: 6e2c 2063 616c 6375 6c61 7465 2074 6865  n, calculate the
-0000c120: 206b 6474 7265 650a 2020 2020 2020 2020   kdtree.        
-0000c130: 6966 2046 696c 7465 7220 6973 204e 6f6e  if Filter is Non
-0000c140: 653a 0a20 2020 2020 2020 2020 2020 206b  e:.            k
-0000c150: 6474 7265 6520 3d20 6d61 705f 7461 7267  dtree = map_targ
-0000c160: 6574 2e6d 616b 654b 4454 7265 6528 0a20  et.makeKDTree(. 
-0000c170: 2020 2020 2020 2020 2020 2020 2020 206d                 m
-0000c180: 6170 5f74 6172 6765 745f 7468 7265 7368  ap_target_thresh
-0000c190: 6f6c 6431 2c0a 2020 2020 2020 2020 2020  old1,.          
-0000c1a0: 2020 2020 2020 6d61 705f 7461 7267 6574        map_target
-0000c1b0: 5f74 6872 6573 686f 6c64 320a 2020 2020  _threshold2.    
-0000c1c0: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-0000c1d0: 2020 2020 2020 7072 6f62 655f 706f 696e        probe_poin
-0000c1e0: 7473 203d 206d 6170 5f70 726f 6265 2e67  ts = map_probe.g
-0000c1f0: 6574 5f70 6f73 280a 2020 2020 2020 2020  et_pos(.        
-0000c200: 2020 2020 2020 2020 6d61 705f 7461 7267          map_targ
-0000c210: 6574 5f74 6872 6573 686f 6c64 312c 0a20  et_threshold1,. 
-0000c220: 2020 2020 2020 2020 2020 2020 2020 206d                 m
-0000c230: 6170 5f74 6172 6765 745f 7468 7265 7368  ap_target_thresh
-0000c240: 6f6c 6432 0a20 2020 2020 2020 2020 2020  old2.           
-0000c250: 2029 0a20 2020 2020 2020 2065 6c69 6620   ).        elif 
-0000c260: 4669 6c74 6572 203d 3d20 2753 7464 273a  Filter == 'Std':
-0000c270: 0a20 2020 2020 2020 2020 2020 2074 6172  .            tar
-0000c280: 6765 745f 706f 696e 7473 203d 206e 702e  get_points = np.
-0000c290: 6172 6777 6865 7265 280a 2020 2020 2020  argwhere(.      
-0000c2a0: 2020 2020 2020 2020 2020 286d 6170 5f74            (map_t
-0000c2b0: 6172 6765 742e 6675 6c6c 4d61 7020 3e20  arget.fullMap > 
-0000c2c0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-0000c2d0: 2020 2020 2020 2020 2020 666c 6f61 7428            float(
-0000c2e0: 6d61 705f 7461 7267 6574 5f74 6872 6573  map_target_thres
-0000c2f0: 686f 6c64 3129 2d28 6d61 705f 7461 7267  hold1)-(map_targ
-0000c300: 6574 2e73 7464 2829 2a30 2e31 3029 290a  et.std()*0.10)).
-0000c310: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c320: 2029 2026 0a20 2020 2020 2020 2020 2020   ) &.           
-0000c330: 2020 2020 2028 6d61 705f 7461 7267 6574       (map_target
-0000c340: 2e66 756c 6c4d 6170 203c 2028 0a20 2020  .fullMap < (.   
-0000c350: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c360: 2020 2020 2066 6c6f 6174 286d 6170 5f74       float(map_t
-0000c370: 6172 6765 745f 7468 7265 7368 6f6c 6431  arget_threshold1
-0000c380: 292b 286d 6170 5f74 6172 6765 742e 7374  )+(map_target.st
-0000c390: 6428 292a 302e 3130 2929 0a20 2020 2020  d()*0.10)).     
-0000c3a0: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
-0000c3b0: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
-0000c3c0: 2020 2020 2020 2020 7072 6f62 655f 706f          probe_po
-0000c3d0: 696e 7473 203d 206e 702e 6172 6777 6865  ints = np.argwhe
-0000c3e0: 7265 280a 2020 2020 2020 2020 2020 2020  re(.            
-0000c3f0: 2020 2020 286d 6170 5f70 726f 6265 2e66      (map_probe.f
-0000c400: 756c 6c4d 6170 203e 2028 0a20 2020 2020  ullMap > (.     
-0000c410: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c420: 2020 2066 6c6f 6174 286d 6170 5f70 726f     float(map_pro
-0000c430: 6265 5f74 6872 6573 686f 6c64 292d 286d  be_threshold)-(m
-0000c440: 6170 5f70 726f 6265 2e73 7464 2829 2a30  ap_probe.std()*0
-0000c450: 2e31 3029 290a 2020 2020 2020 2020 2020  .10)).          
-0000c460: 2020 2020 2020 2029 2026 0a20 2020 2020         ) &.     
-0000c470: 2020 2020 2020 2020 2020 2028 6d61 705f             (map_
-0000c480: 7072 6f62 652e 6675 6c6c 4d61 7020 3c20  probe.fullMap < 
-0000c490: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-0000c4a0: 2020 2020 2020 2020 2020 666c 6f61 7428            float(
-0000c4b0: 6d61 705f 7072 6f62 655f 7468 7265 7368  map_probe_thresh
-0000c4c0: 6f6c 6429 2b28 6d61 705f 7072 6f62 652e  old)+(map_probe.
-0000c4d0: 7374 6428 292a 302e 3130 2929 0a20 2020  std()*0.10)).   
-0000c4e0: 2020 2020 2020 2020 2020 2020 2020 290a                ).
-0000c4f0: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
-0000c500: 2020 2020 2020 2020 2020 6966 206c 656e            if len
-0000c510: 2874 6172 6765 745f 706f 696e 7473 2920  (target_points) 
-0000c520: 3c20 6c65 6e28 7072 6f62 655f 706f 696e  < len(probe_poin
-0000c530: 7473 293a 0a20 2020 2020 2020 2020 2020  ts):.           
-0000c540: 2020 2020 2070 726f 6265 5f70 6f69 6e74       probe_point
-0000c550: 7331 203d 206e 702e 636f 7079 2874 6172  s1 = np.copy(tar
-0000c560: 6765 745f 706f 696e 7473 290a 2020 2020  get_points).    
-0000c570: 2020 2020 2020 2020 2020 2020 7461 7267              targ
-0000c580: 6574 5f70 6f69 6e74 7320 3d20 6e70 2e63  et_points = np.c
-0000c590: 6f70 7928 7072 6f62 655f 706f 696e 7473  opy(probe_points
-0000c5a0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0000c5b0: 2020 7072 6f62 655f 706f 696e 7473 203d    probe_points =
-0000c5c0: 206e 702e 636f 7079 2870 726f 6265 5f70   np.copy(probe_p
-0000c5d0: 6f69 6e74 7331 290a 2020 2020 2020 2020  oints1).        
-0000c5e0: 2020 2020 6966 206c 656e 2874 6172 6765      if len(targe
-0000c5f0: 745f 706f 696e 7473 2920 3d3d 2030 206f  t_points) == 0 o
-0000c600: 7220 6c65 6e28 7072 6f62 655f 706f 696e  r len(probe_poin
-0000c610: 7473 2920 3d3d 2030 3a0a 2020 2020 2020  ts) == 0:.      
-0000c620: 2020 2020 2020 2020 2020 7072 696e 7428            print(
-0000c630: 2753 7572 6661 6365 2064 6574 6563 7469  'Surface detecti
-0000c640: 6f6e 2066 6169 6c65 6420 2853 7464 2066  on failed (Std f
-0000c650: 696c 7465 7229 2c20 6578 6974 696e 672e  ilter), exiting.
-0000c660: 2e27 290a 2020 2020 2020 2020 2020 2020  .').            
-0000c670: 2020 2020 7265 7475 726e 204e 6f6e 650a      return None.
-0000c680: 2020 2020 2020 2020 2020 2020 7472 793a              try:
-0000c690: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000c6a0: 2066 726f 6d20 7363 6970 792e 7370 6174   from scipy.spat
-0000c6b0: 6961 6c20 696d 706f 7274 2063 4b44 5472  ial import cKDTr
-0000c6c0: 6565 0a20 2020 2020 2020 2020 2020 2020  ee.             
-0000c6d0: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
-0000c6e0: 2020 2020 2020 2020 2020 2020 6b64 7472              kdtr
-0000c6f0: 6565 203d 2063 4b44 5472 6565 2874 6172  ee = cKDTree(tar
-0000c700: 6765 745f 706f 696e 7473 290a 2020 2020  get_points).    
-0000c710: 2020 2020 2020 2020 2020 2020 6578 6365              exce
-0000c720: 7074 2052 756e 7469 6d65 4572 726f 723a  pt RuntimeError:
-0000c730: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000c740: 2020 2020 2072 6574 7572 6e20 4e6f 6e65       return None
-0000c750: 0a20 2020 2020 2020 2020 2020 2065 7863  .            exc
-0000c760: 6570 7420 496d 706f 7274 4572 726f 723a  ept ImportError:
-0000c770: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000c780: 2074 7279 3a0a 2020 2020 2020 2020 2020   try:.          
-0000c790: 2020 2020 2020 2020 2020 6b64 7472 6565            kdtree
-0000c7a0: 203d 204b 4454 7265 6528 7461 7267 6574   = KDTree(target
-0000c7b0: 5f70 6f69 6e74 7329 0a20 2020 2020 2020  _points).       
-0000c7c0: 2020 2020 2020 2020 2065 7863 6570 7420           except 
-0000c7d0: 5275 6e74 696d 6545 7272 6f72 3a0a 2020  RuntimeError:.  
-0000c7e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c7f0: 2020 7265 7475 726e 204e 6f6e 650a 2020    return None.  
-0000c800: 2020 2020 2020 656c 6966 2046 696c 7465        elif Filte
-0000c810: 7220 3d3d 2027 4d65 616e 273a 0a20 2020  r == 'Mean':.   
-0000c820: 2020 2020 2020 2020 206d 6170 315f 6669           map1_fi
-0000c830: 6c74 6572 203d 206d 6170 5f74 6172 6765  lter = map_targe
-0000c840: 742e 5f73 7572 6661 6365 5f66 6561 7475  t._surface_featu
-0000c850: 7265 7328 0a20 2020 2020 2020 2020 2020  res(.           
-0000c860: 2020 2020 2066 6c6f 6174 286d 6170 5f74       float(map_t
-0000c870: 6172 6765 745f 7468 7265 7368 6f6c 6431  arget_threshold1
-0000c880: 290a 2020 2020 2020 2020 2020 2020 290a  ).            ).
-0000c890: 2020 2020 2020 2020 2020 2020 6d61 7032              map2
-0000c8a0: 5f66 696c 7465 7220 3d20 6d61 705f 7072  _filter = map_pr
-0000c8b0: 6f62 652e 5f73 7572 6661 6365 5f66 6561  obe._surface_fea
-0000c8c0: 7475 7265 7328 0a20 2020 2020 2020 2020  tures(.         
-0000c8d0: 2020 2020 2020 2066 6c6f 6174 286d 6170         float(map
-0000c8e0: 5f70 726f 6265 5f74 6872 6573 686f 6c64  _probe_threshold
-0000c8f0: 290a 2020 2020 2020 2020 2020 2020 290a  ).            ).
-0000c900: 2020 2020 2020 2020 2020 2020 2222 220a              """.
-0000c910: 2020 2020 2020 2020 2020 2020 6465 6669              defi
-0000c920: 6e65 2073 7572 6661 6365 2062 6173 6564  ne surface based
-0000c930: 206f 6e20 7468 6520 6669 6c74 6572 6564   on the filtered
-0000c940: 206d 6173 6b20 7661 6c75 6573 2e0a 2020   mask values..  
-0000c950: 2020 2020 2020 2020 2020 706f 696e 7473            points
-0000c960: 2077 6974 6820 7661 6c75 6573 206c 6573   with values les
-0000c970: 7320 7468 616e 2030 2e33 2061 7265 2075  s than 0.3 are u
-0000c980: 7375 616c 6c79 2070 7265 6665 7272 6564  sually preferred
-0000c990: 2e20 4275 7420 696e 0a20 2020 2020 2020  . But in.       
-0000c9a0: 2020 2020 2073 6f6d 6520 6361 7365 7320       some cases 
-0000c9b0: 6c69 6b65 2076 6972 7573 6573 2c20 6d6f  like viruses, mo
-0000c9c0: 7374 2073 7572 6661 6365 2070 6f69 6e74  st surface point
-0000c9d0: 7320 6172 6520 6869 6768 6c79 2065 7870  s are highly exp
-0000c9e0: 6f73 6564 0a20 2020 2020 2020 2020 2020  osed.           
-0000c9f0: 2061 6e64 2061 206c 6172 6765 206e 756d   and a large num
-0000ca00: 6265 7220 6f66 2070 6f69 6e74 7320 6172  ber of points ar
-0000ca10: 6520 7265 7475 726e 6564 2061 6e64 2074  e returned and t
-0000ca20: 6865 2063 616c 6375 6c61 7469 6f6e 0a20  he calculation. 
-0000ca30: 2020 2020 2020 2020 2020 2062 6563 6f6d             becom
-0000ca40: 6573 2073 6c6f 772e 0a20 2020 2020 2020  es slow..       
-0000ca50: 2020 2020 2048 656e 6365 2061 6e20 6164       Hence an ad
-0000ca60: 6469 7469 6f6e 616c 2066 696c 7465 7220  ditional filter 
-0000ca70: 6973 2061 6464 6564 3a20 7468 6520 6d61  is added: the ma
-0000ca80: 7869 6d75 6d20 616c 6c6f 7765 6420 706f  ximum allowed po
-0000ca90: 696e 7473 0a20 2020 2020 2020 2020 2020  ints.           
-0000caa0: 2069 7320 3130 2520 6f66 2062 6f78 2073   is 10% of box s
-0000cab0: 697a 652e 0a20 2020 2020 2020 2020 2020  ize..           
-0000cac0: 2054 6865 206d 696e 696d 756d 206e 756d   The minimum num
-0000cad0: 6265 7220 6f66 2070 6f69 6e74 7320 6973  ber of points is
-0000cae0: 206b 6570 7420 6173 2037 252e 2054 6869   kept as 7%. Thi
-0000caf0: 7320 6d6f 6465 2069 7320 6c65 7373 0a20  s mode is less. 
-0000cb00: 2020 2020 2020 2020 2020 2073 656e 7369             sensi
-0000cb10: 7469 7665 2074 6f20 7468 6520 6e75 6d62  tive to the numb
-0000cb20: 6572 206f 6620 7375 7266 6163 6520 706f  er of surface po
-0000cb30: 696e 7473 2063 686f 7365 6e0a 2020 2020  ints chosen.    
-0000cb40: 2020 2020 2020 2020 6173 2074 6865 2065          as the e
-0000cb50: 7874 656e 7420 6f66 2065 7870 6f73 7572  xtent of exposur
-0000cb60: 6520 6973 2075 7365 6420 666f 7220 6465  e is used for de
-0000cb70: 6669 6e69 6e67 2073 7572 6661 6365 2e20  fining surface. 
-0000cb80: 4865 6e63 650a 2020 2020 2020 2020 2020  Hence.          
-0000cb90: 2020 7468 6963 6b20 7375 7266 6163 6520    thick surface 
-0000cba0: 6973 206e 6f74 2075 7375 616c 6c79 2072  is not usually r
-0000cbb0: 6571 7569 7265 642e 0a20 2020 2020 2020  equired..       
-0000cbc0: 2020 2020 2063 616c 6375 6c61 7465 2066       calculate f
-0000cbd0: 7265 7175 656e 6369 6573 2069 6e20 6269  requencies in bi
-0000cbe0: 6e73 2066 6f72 2066 696c 7465 7265 6420  ns for filtered 
-0000cbf0: 6d61 736b 2e0a 2020 2020 2020 2020 2020  mask..          
-0000cc00: 2020 5468 6520 736d 616c 6c65 7220 7468    The smaller th
-0000cc10: 6520 6269 6e73 2c20 6d6f 7265 2070 7265  e bins, more pre
-0000cc20: 6369 7365 2077 696c 6c20 6265 2074 6865  cise will be the
-0000cc30: 2063 616c 6375 6c61 7469 6f6e 206f 660a   calculation of.
-0000cc40: 2020 2020 2020 2020 2020 2020 706f 696e              poin
-0000cc50: 7473 2061 6c6c 6f77 6564 2062 6173 6564  ts allowed based
-0000cc60: 206f 6e20 7065 7263 656e 7420 6f66 2070   on percent of p
-0000cc70: 6f69 6e74 7320 6368 6f73 656e 2e0a 2020  oints chosen..  
-0000cc80: 2020 2020 2020 2020 2020 4173 2074 6869            As thi
-0000cc90: 7320 6973 206a 7573 7420 616e 2061 6464  s is just an add
-0000cca0: 6974 696f 6e61 6c20 6669 6c74 6572 2061  itional filter a
-0000ccb0: 6e64 2064 6f65 736e 2774 2061 6666 6563  nd doesn't affec
-0000ccc0: 7420 7468 650a 2020 2020 2020 2020 2020  t the.          
-0000ccd0: 2020 6361 6c63 756c 6174 696f 6e73 2064    calculations d
-0000cce0: 7261 7374 6963 616c 6c79 2c20 3430 2062  rastically, 40 b
-0000ccf0: 696e 7320 6172 6520 7573 6564 2074 6f20  ins are used to 
-0000cd00: 6361 6c63 756c 6174 650a 2020 2020 2020  calculate.      
-0000cd10: 2020 2020 2020 6672 6571 7565 6e63 6965        frequencie
-0000cd20: 732e 0a20 2020 2020 2020 2020 2020 2022  s..            "
-0000cd30: 2222 0a20 2020 2020 2020 2020 2020 2062  "".            b
-0000cd40: 696e 5f74 6573 7420 3d20 5b30 2e30 3030  in_test = [0.000
-0000cd50: 315d 0a20 2020 2020 2020 2020 2020 2066  1].            f
-0000cd60: 6f72 2069 6920 696e 2072 616e 6765 2831  or ii in range(1
-0000cd70: 2c20 3431 293a 0a20 2020 2020 2020 2020  , 41):.         
-0000cd80: 2020 2020 2020 2062 696e 5f74 6573 742e         bin_test.
-0000cd90: 6170 7065 6e64 2830 2e30 3235 202a 2069  append(0.025 * i
-0000cda0: 6929 0a20 2020 2020 2020 2020 2020 2066  i).            f
-0000cdb0: 7265 715f 7465 7374 203d 206e 702e 6869  req_test = np.hi
-0000cdc0: 7374 6f67 7261 6d28 6d61 7031 5f66 696c  stogram(map1_fil
-0000cdd0: 7465 722e 6675 6c6c 4d61 702c 2062 696e  ter.fullMap, bin
-0000cde0: 5f74 6573 7429 5b30 5d0a 2020 2020 2020  _test)[0].      
-0000cdf0: 2020 2020 2020 6d61 7031 5f66 696c 6c65        map1_fille
-0000ce00: 6420 3d20 6e70 2e73 756d 286d 6170 315f  d = np.sum(map1_
-0000ce10: 6669 6c74 6572 2e66 756c 6c4d 6170 203e  filter.fullMap >
-0000ce20: 2030 290a 0a20 2020 2020 2020 2020 2020   0)..           
-0000ce30: 2073 756d 5f66 7265 7120 3d20 302e 300a   sum_freq = 0.0.
-0000ce40: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-0000ce50: 6672 2069 6e20 7261 6e67 6528 6c65 6e28  fr in range(len(
-0000ce60: 6672 6571 5f74 6573 7429 293a 0a20 2020  freq_test)):.   
-0000ce70: 2020 2020 2020 2020 2020 2020 2073 756d               sum
-0000ce80: 5f66 7265 7120 2b3d 2066 6c6f 6174 2866  _freq += float(f
-0000ce90: 7265 715f 7465 7374 5b66 725d 290a 2020  req_test[fr]).  
-0000cea0: 2020 2020 2020 2020 2020 2020 2020 6966                if
-0000ceb0: 2073 756d 5f66 7265 7120 2f20 6d61 7031   sum_freq / map1
-0000cec0: 5f66 696c 6c65 6420 3e20 302e 3035 2061  _filled > 0.05 a
-0000ced0: 6e64 2062 696e 5f74 6573 745b 6672 2b31  nd bin_test[fr+1
-0000cee0: 5d20 3e3d 2030 2e33 3a0a 2020 2020 2020  ] >= 0.3:.      
-0000cef0: 2020 2020 2020 2020 2020 2020 2020 7431                t1
-0000cf00: 203d 2062 696e 5f74 6573 745b 6672 2b31   = bin_test[fr+1
-0000cf10: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
-0000cf20: 2020 2020 2020 6272 6561 6b0a 2020 2020        break.    
-0000cf30: 2020 2020 2020 2020 2020 2020 6966 2073              if s
-0000cf40: 756d 5f66 7265 7120 2f20 6d61 7031 5f66  um_freq / map1_f
-0000cf50: 696c 6c65 6420 3e20 302e 3130 206f 7220  illed > 0.10 or 
-0000cf60: 7375 6d5f 6672 6571 203e 2032 3030 3030  sum_freq > 20000
-0000cf70: 303a 0a20 2020 2020 2020 2020 2020 2020  0:.             
-0000cf80: 2020 2020 2020 2074 3120 3d20 6269 6e5f         t1 = bin_
-0000cf90: 7465 7374 5b66 722b 315d 0a20 2020 2020  test[fr+1].     
-0000cfa0: 2020 2020 2020 2020 2020 2020 2020 2062                 b
-0000cfb0: 7265 616b 0a20 2020 2020 2020 2020 2020  reak.           
-0000cfc0: 2073 756d 5f66 7265 7120 3d20 302e 300a   sum_freq = 0.0.
-0000cfd0: 2020 2020 2020 2020 2020 2020 6672 6571              freq
-0000cfe0: 5f74 6573 7420 3d20 6e70 2e68 6973 746f  _test = np.histo
-0000cff0: 6772 616d 286d 6170 325f 6669 6c74 6572  gram(map2_filter
-0000d000: 2e66 756c 6c4d 6170 2c20 6269 6e5f 7465  .fullMap, bin_te
-0000d010: 7374 295b 305d 0a20 2020 2020 2020 2020  st)[0].         
-0000d020: 2020 206d 6170 325f 6669 6c6c 6564 203d     map2_filled =
-0000d030: 206e 702e 7375 6d28 6d61 7032 5f66 696c   np.sum(map2_fil
-0000d040: 7465 722e 6675 6c6c 4d61 7020 3e20 3029  ter.fullMap > 0)
-0000d050: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
-0000d060: 2066 7220 696e 2072 616e 6765 286c 656e   fr in range(len
-0000d070: 2866 7265 715f 7465 7374 2929 3a0a 2020  (freq_test)):.  
-0000d080: 2020 2020 2020 2020 2020 2020 2020 7375                su
-0000d090: 6d5f 6672 6571 202b 3d20 666c 6f61 7428  m_freq += float(
-0000d0a0: 6672 6571 5f74 6573 745b 6672 5d29 0a20  freq_test[fr]). 
-0000d0b0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-0000d0c0: 6620 7375 6d5f 6672 6571 2f6d 6170 325f  f sum_freq/map2_
-0000d0d0: 6669 6c6c 6564 203e 2030 2e30 3520 616e  filled > 0.05 an
-0000d0e0: 6420 6269 6e5f 7465 7374 5b66 722b 315d  d bin_test[fr+1]
-0000d0f0: 203e 3d20 302e 333a 0a20 2020 2020 2020   >= 0.3:.       
-0000d100: 2020 2020 2020 2020 2020 2020 2074 3220               t2 
-0000d110: 3d20 6269 6e5f 7465 7374 5b66 722b 315d  = bin_test[fr+1]
-0000d120: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000d130: 2020 2020 2062 7265 616b 0a20 2020 2020       break.     
-0000d140: 2020 2020 2020 2020 2020 2069 6620 7375             if su
-0000d150: 6d5f 6672 6571 2f6d 6170 325f 6669 6c6c  m_freq/map2_fill
-0000d160: 6564 203e 2030 2e31 3020 6f72 2073 756d  ed > 0.10 or sum
-0000d170: 5f66 7265 7120 3e20 3230 3030 3030 3a0a  _freq > 200000:.
-0000d180: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d190: 2020 2020 7432 203d 2062 696e 5f74 6573      t2 = bin_tes
-0000d1a0: 745b 6672 2b31 5d0a 2020 2020 2020 2020  t[fr+1].        
-0000d1b0: 2020 2020 2020 2020 2020 2020 6272 6561              brea
-0000d1c0: 6b0a 2020 2020 2020 2020 2020 2020 2320  k.            # 
-0000d1d0: 7431 2061 6e64 2074 3220 6172 6520 7468  t1 and t2 are th
-0000d1e0: 6520 7365 6c65 6374 6564 206c 6576 656c  e selected level
-0000d1f0: 7320 6261 7365 6420 6f6e 2066 696c 7465  s based on filte
-0000d200: 7265 6420 7661 6c75 6573 2061 6e64 0a20  red values and. 
-0000d210: 2020 2020 2020 2020 2020 2023 2070 6572             # per
-0000d220: 6365 6e74 206f 6620 706f 696e 7473 0a20  cent of points. 
-0000d230: 2020 2020 2020 2020 2020 2074 6172 6765             targe
-0000d240: 745f 706f 696e 7473 203d 206e 702e 6172  t_points = np.ar
-0000d250: 6777 6865 7265 280a 2020 2020 2020 2020  gwhere(.        
-0000d260: 2020 2020 2020 2020 286d 6170 315f 6669          (map1_fi
-0000d270: 6c74 6572 2e66 756c 6c4d 6170 203e 2030  lter.fullMap > 0
-0000d280: 2e30 2920 2620 286d 6170 315f 6669 6c74  .0) & (map1_filt
-0000d290: 6572 2e66 756c 6c4d 6170 203c 3d20 7431  er.fullMap <= t1
-0000d2a0: 290a 2020 2020 2020 2020 2020 2020 290a  ).            ).
-0000d2b0: 2020 2020 2020 2020 2020 2020 7072 6f62              prob
-0000d2c0: 655f 706f 696e 7473 203d 206e 702e 6172  e_points = np.ar
-0000d2d0: 6777 6865 7265 280a 2020 2020 2020 2020  gwhere(.        
-0000d2e0: 2020 2020 2020 2020 286d 6170 325f 6669          (map2_fi
-0000d2f0: 6c74 6572 2e66 756c 6c4d 6170 203e 2030  lter.fullMap > 0
-0000d300: 2e30 2920 2620 286d 6170 325f 6669 6c74  .0) & (map2_filt
-0000d310: 6572 2e66 756c 6c4d 6170 203c 3d20 7432  er.fullMap <= t2
-0000d320: 290a 2020 2020 2020 2020 2020 2020 290a  ).            ).
-0000d330: 2020 2020 2020 2020 2020 2020 6966 206c              if l
-0000d340: 656e 2874 6172 6765 745f 706f 696e 7473  en(target_points
-0000d350: 2920 3d3d 2030 206f 7220 6c65 6e28 7072  ) == 0 or len(pr
-0000d360: 6f62 655f 706f 696e 7473 2920 3d3d 2030  obe_points) == 0
-0000d370: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0000d380: 2020 7072 696e 7428 2753 7572 6661 6365    print('Surface
-0000d390: 2064 6574 6563 7469 6f6e 2066 6169 6c65   detection faile
-0000d3a0: 6420 284d 6561 6e20 6669 6c74 6572 292c  d (Mean filter),
-0000d3b0: 2065 7869 7469 6e67 2e2e 2729 0a20 2020   exiting..').   
-0000d3c0: 2020 2020 2020 2020 2020 2020 2072 6574               ret
-0000d3d0: 7572 6e20 4e6f 6e65 0a20 2020 2020 2020  urn None.       
-0000d3e0: 2020 2020 2069 6620 6c65 6e28 7461 7267       if len(targ
-0000d3f0: 6574 5f70 6f69 6e74 7329 203c 206c 656e  et_points) < len
-0000d400: 2870 726f 6265 5f70 6f69 6e74 7329 3a0a  (probe_points):.
-0000d410: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d420: 7072 6f62 655f 706f 696e 7473 3120 3d20  probe_points1 = 
-0000d430: 6e70 2e63 6f70 7928 7461 7267 6574 5f70  np.copy(target_p
-0000d440: 6f69 6e74 7329 0a20 2020 2020 2020 2020  oints).         
-0000d450: 2020 2020 2020 2074 6172 6765 745f 706f         target_po
-0000d460: 696e 7473 203d 206e 702e 636f 7079 2870  ints = np.copy(p
-0000d470: 726f 6265 5f70 6f69 6e74 7329 0a20 2020  robe_points).   
-0000d480: 2020 2020 2020 2020 2020 2020 2070 726f               pro
-0000d490: 6265 5f70 6f69 6e74 7320 3d20 6e70 2e63  be_points = np.c
-0000d4a0: 6f70 7928 7072 6f62 655f 706f 696e 7473  opy(probe_points
-0000d4b0: 3129 0a20 2020 2020 2020 2020 2020 2074  1).            t
-0000d4c0: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
-0000d4d0: 2020 2020 6672 6f6d 2073 6369 7079 2e73      from scipy.s
-0000d4e0: 7061 7469 616c 2069 6d70 6f72 7420 634b  patial import cK
-0000d4f0: 4454 7265 650a 2020 2020 2020 2020 2020  DTree.          
-0000d500: 2020 2020 2020 7472 793a 0a20 2020 2020        try:.     
-0000d510: 2020 2020 2020 2020 2020 2020 2020 206b                 k
-0000d520: 6474 7265 6520 3d20 634b 4454 7265 6528  dtree = cKDTree(
-0000d530: 7461 7267 6574 5f70 6f69 6e74 7329 0a20  target_points). 
-0000d540: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-0000d550: 7863 6570 7420 5275 6e74 696d 6545 7272  xcept RuntimeErr
-0000d560: 6f72 3a0a 2020 2020 2020 2020 2020 2020  or:.            
-0000d570: 2020 2020 2020 2020 7265 7475 726e 204e          return N
-0000d580: 6f6e 650a 2020 2020 2020 2020 2020 2020  one.            
-0000d590: 6578 6365 7074 2049 6d70 6f72 7445 7272  except ImportErr
-0000d5a0: 6f72 3a0a 2020 2020 2020 2020 2020 2020  or:.            
-0000d5b0: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
-0000d5c0: 2020 2020 2020 2020 2020 2020 206b 6474               kdt
-0000d5d0: 7265 6520 3d20 4b44 5472 6565 2874 6172  ree = KDTree(tar
-0000d5e0: 6765 745f 706f 696e 7473 290a 2020 2020  get_points).    
-0000d5f0: 2020 2020 2020 2020 2020 2020 6578 6365              exce
-0000d600: 7074 2052 756e 7469 6d65 4572 726f 723a  pt RuntimeError:
-0000d610: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000d620: 2020 2020 2072 6574 7572 6e20 4e6f 6e65       return None
-0000d630: 0a20 2020 2020 2020 2065 6c69 6620 4669  .        elif Fi
-0000d640: 6c74 6572 203d 3d20 274d 696e 696d 756d  lter == 'Minimum
-0000d650: 273a 0a20 2020 2020 2020 2020 2020 206d  ':.            m
-0000d660: 6170 315f 7375 7266 6163 6520 3d20 6d61  ap1_surface = ma
-0000d670: 705f 7461 7267 6574 2e5f 7375 7266 6163  p_target._surfac
-0000d680: 655f 6d69 6e69 6d75 6d5f 6669 6c74 6572  e_minimum_filter
-0000d690: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-0000d6a0: 2020 666c 6f61 7428 6d61 705f 7461 7267    float(map_targ
-0000d6b0: 6574 5f74 6872 6573 686f 6c64 3129 0a20  et_threshold1). 
-0000d6c0: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
-0000d6d0: 2020 2020 2020 2020 206d 6170 325f 7375           map2_su
-0000d6e0: 7266 6163 6520 3d20 6d61 705f 7072 6f62  rface = map_prob
-0000d6f0: 652e 5f73 7572 6661 6365 5f6d 696e 696d  e._surface_minim
-0000d700: 756d 5f66 696c 7465 7228 0a20 2020 2020  um_filter(.     
-0000d710: 2020 2020 2020 2020 2020 2066 6c6f 6174             float
-0000d720: 286d 6170 5f70 726f 6265 5f74 6872 6573  (map_probe_thres
-0000d730: 686f 6c64 290a 2020 2020 2020 2020 2020  hold).          
-0000d740: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
-0000d750: 2320 7365 6c65 6374 2074 6865 2073 7572  # select the sur
-0000d760: 6661 6365 2070 6f69 6e74 7320 7265 7072  face points repr
-0000d770: 6573 656e 7465 6420 6279 2074 6865 206d  esented by the m
-0000d780: 6173 6b0a 2020 2020 2020 2020 2020 2020  ask.            
-0000d790: 7461 7267 6574 5f70 6f69 6e74 7320 3d20  target_points = 
-0000d7a0: 6e70 2e61 7267 7768 6572 6528 6d61 7031  np.argwhere(map1
-0000d7b0: 5f73 7572 6661 6365 203d 3d20 3129 0a20  _surface == 1). 
-0000d7c0: 2020 2020 2020 2020 2020 2070 726f 6265             probe
-0000d7d0: 5f70 6f69 6e74 7320 3d20 6e70 2e61 7267  _points = np.arg
-0000d7e0: 7768 6572 6528 6d61 7032 5f73 7572 6661  where(map2_surfa
-0000d7f0: 6365 203d 3d20 3129 0a20 2020 2020 2020  ce == 1).       
-0000d800: 2020 2020 2069 6620 6c65 6e28 7461 7267       if len(targ
-0000d810: 6574 5f70 6f69 6e74 7329 203d 3d20 3020  et_points) == 0 
-0000d820: 6f72 206c 656e 2870 726f 6265 5f70 6f69  or len(probe_poi
-0000d830: 6e74 7329 203d 3d20 303a 0a20 2020 2020  nts) == 0:.     
-0000d840: 2020 2020 2020 2020 2020 2070 7269 6e74             print
-0000d850: 2827 5375 7266 6163 6520 6465 7465 6374  ('Surface detect
-0000d860: 696f 6e20 6661 696c 6564 2028 4d69 6e69  ion failed (Mini
-0000d870: 6d75 6d20 6669 6c74 6572 292c 2065 7869  mum filter), exi
-0000d880: 7469 6e67 2e2e 2729 0a20 2020 2020 2020  ting..').       
-0000d890: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-0000d8a0: 4e6f 6e65 0a20 2020 2020 2020 2020 2020  None.           
-0000d8b0: 2069 6620 6c65 6e28 7461 7267 6574 5f70   if len(target_p
-0000d8c0: 6f69 6e74 7329 202b 206c 656e 2870 726f  oints) + len(pro
-0000d8d0: 6265 5f70 6f69 6e74 7329 203e 2032 3530  be_points) > 250
-0000d8e0: 3030 303a 0a20 2020 2020 2020 2020 2020  000:.           
-0000d8f0: 2020 2020 2072 6574 7572 6e20 4e6f 6e65       return None
-0000d900: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-0000d910: 6c65 6e28 7461 7267 6574 5f70 6f69 6e74  len(target_point
-0000d920: 7329 203c 206c 656e 2870 726f 6265 5f70  s) < len(probe_p
-0000d930: 6f69 6e74 7329 3a0a 2020 2020 2020 2020  oints):.        
-0000d940: 2020 2020 2020 2020 7072 6f62 655f 706f          probe_po
-0000d950: 696e 7473 3120 3d20 6e70 2e63 6f70 7928  ints1 = np.copy(
-0000d960: 7461 7267 6574 5f70 6f69 6e74 7329 0a20  target_points). 
-0000d970: 2020 2020 2020 2020 2020 2020 2020 2074                 t
-0000d980: 6172 6765 745f 706f 696e 7473 203d 206e  arget_points = n
-0000d990: 702e 636f 7079 2870 726f 6265 5f70 6f69  p.copy(probe_poi
-0000d9a0: 6e74 7329 0a20 2020 2020 2020 2020 2020  nts).           
-0000d9b0: 2020 2020 2070 726f 6265 5f70 6f69 6e74       probe_point
-0000d9c0: 7320 3d20 6e70 2e63 6f70 7928 7072 6f62  s = np.copy(prob
-0000d9d0: 655f 706f 696e 7473 3129 0a20 2020 2020  e_points1).     
-0000d9e0: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
-0000d9f0: 2020 2020 2020 2020 2020 2020 6672 6f6d              from
-0000da00: 2073 6369 7079 2e73 7061 7469 616c 2069   scipy.spatial i
-0000da10: 6d70 6f72 7420 634b 4454 7265 650a 2020  mport cKDTree.  
-0000da20: 2020 2020 2020 2020 2020 2020 2020 7472                tr
-0000da30: 793a 0a20 2020 2020 2020 2020 2020 2020  y:.             
-0000da40: 2020 2020 2020 206b 6474 7265 6520 3d20         kdtree = 
-0000da50: 634b 4454 7265 6528 7461 7267 6574 5f70  cKDTree(target_p
-0000da60: 6f69 6e74 7329 0a20 2020 2020 2020 2020  oints).         
-0000da70: 2020 2020 2020 2065 7863 6570 7420 5275         except Ru
-0000da80: 6e74 696d 6545 7272 6f72 3a0a 2020 2020  ntimeError:.    
-0000da90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000daa0: 7265 7475 726e 204e 6f6e 650a 2020 2020  return None.    
-0000dab0: 2020 2020 2020 2020 6578 6365 7074 2049          except I
-0000dac0: 6d70 6f72 7445 7272 6f72 3a0a 2020 2020  mportError:.    
-0000dad0: 2020 2020 2020 2020 2020 2020 7472 793a              try:
-0000dae0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000daf0: 2020 2020 206b 6474 7265 6520 3d20 4b44       kdtree = KD
-0000db00: 5472 6565 2874 6172 6765 745f 706f 696e  Tree(target_poin
-0000db10: 7473 290a 2020 2020 2020 2020 2020 2020  ts).            
-0000db20: 2020 2020 6578 6365 7074 2052 756e 7469      except Runti
-0000db30: 6d65 4572 726f 723a 0a20 2020 2020 2020  meError:.       
-0000db40: 2020 2020 2020 2020 2020 2020 2072 6574               ret
-0000db50: 7572 6e20 4e6f 6e65 0a20 2020 2020 2020  urn None.       
-0000db60: 2065 6c69 6620 4669 6c74 6572 203d 3d20   elif Filter == 
-0000db70: 2753 6f62 656c 273a 0a20 2020 2020 2020  'Sobel':.       
-0000db80: 2020 2020 206d 6170 315f 7375 7266 6163       map1_surfac
-0000db90: 6520 3d20 6d61 705f 7461 7267 6574 2e5f  e = map_target._
-0000dba0: 736f 6265 6c5f 6669 6c74 6572 5f63 6f6e  sobel_filter_con
-0000dbb0: 746f 7572 280a 2020 2020 2020 2020 2020  tour(.          
-0000dbc0: 2020 2020 2020 666c 6f61 7428 6d61 705f        float(map_
-0000dbd0: 7461 7267 6574 5f74 6872 6573 686f 6c64  target_threshold
-0000dbe0: 3129 0a20 2020 2020 2020 2020 2020 2029  1).            )
-0000dbf0: 0a20 2020 2020 2020 2020 2020 206d 6170  .            map
-0000dc00: 325f 7375 7266 6163 6520 3d20 6d61 705f  2_surface = map_
-0000dc10: 7072 6f62 652e 5f73 6f62 656c 5f66 696c  probe._sobel_fil
-0000dc20: 7465 725f 636f 6e74 6f75 7228 0a20 2020  ter_contour(.   
-0000dc30: 2020 2020 2020 2020 2020 2020 2066 6c6f               flo
-0000dc40: 6174 286d 6170 5f70 726f 6265 5f74 6872  at(map_probe_thr
-0000dc50: 6573 686f 6c64 290a 2020 2020 2020 2020  eshold).        
-0000dc60: 2020 2020 290a 0a20 2020 2020 2020 2020      )..         
-0000dc70: 2020 2074 6172 6765 745f 706f 696e 7473     target_points
-0000dc80: 203d 206e 702e 6172 6777 6865 7265 280a   = np.argwhere(.
-0000dc90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000dca0: 6d61 7031 5f73 7572 6661 6365 2e66 756c  map1_surface.ful
-0000dcb0: 6c4d 6170 203e 206d 6170 315f 7375 7266  lMap > map1_surf
-0000dcc0: 6163 652e 6d61 7828 2920 2f20 666c 6f61  ace.max() / floa
-0000dcd0: 7428 3229 0a20 2020 2020 2020 2020 2020  t(2).           
-0000dce0: 2029 0a20 2020 2020 2020 2020 2020 2070   ).            p
-0000dcf0: 726f 6265 5f70 6f69 6e74 7320 3d20 6e70  robe_points = np
-0000dd00: 2e61 7267 7768 6572 6528 0a20 2020 2020  .argwhere(.     
-0000dd10: 2020 2020 2020 2020 2020 206d 6170 325f             map2_
-0000dd20: 7375 7266 6163 652e 6675 6c6c 4d61 7020  surface.fullMap 
-0000dd30: 3e20 6d61 7032 5f73 7572 6661 6365 2e6d  > map2_surface.m
-0000dd40: 6178 2829 202f 2066 6c6f 6174 2832 290a  ax() / float(2).
-0000dd50: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
-0000dd60: 2020 2020 2020 2020 2020 6966 206c 656e            if len
-0000dd70: 2874 6172 6765 745f 706f 696e 7473 2920  (target_points) 
-0000dd80: 3d3d 2030 206f 7220 6c65 6e28 7072 6f62  == 0 or len(prob
-0000dd90: 655f 706f 696e 7473 2920 3d3d 2030 3a0a  e_points) == 0:.
-0000dda0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ddb0: 7072 696e 7428 2753 7572 6661 6365 2064  print('Surface d
-0000ddc0: 6574 6563 7469 6f6e 2066 6169 6c65 6420  etection failed 
-0000ddd0: 2853 6f62 656c 2066 696c 7465 7229 2c20  (Sobel filter), 
-0000dde0: 6578 6974 696e 672e 2e27 290a 2020 2020  exiting..').    
-0000ddf0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-0000de00: 726e 204e 6f6e 650a 2020 2020 2020 2020  rn None.        
-0000de10: 2020 2020 6966 206c 656e 2874 6172 6765      if len(targe
-0000de20: 745f 706f 696e 7473 2920 3c20 6c65 6e28  t_points) < len(
-0000de30: 7072 6f62 655f 706f 696e 7473 293a 0a20  probe_points):. 
-0000de40: 2020 2020 2020 2020 2020 2020 2020 2070                 p
-0000de50: 726f 6265 5f70 6f69 6e74 7331 203d 206e  robe_points1 = n
-0000de60: 702e 636f 7079 2874 6172 6765 745f 706f  p.copy(target_po
-0000de70: 696e 7473 290a 2020 2020 2020 2020 2020  ints).          
-0000de80: 2020 2020 2020 7461 7267 6574 5f70 6f69        target_poi
-0000de90: 6e74 7320 3d20 6e70 2e63 6f70 7928 7072  nts = np.copy(pr
-0000dea0: 6f62 655f 706f 696e 7473 290a 2020 2020  obe_points).    
-0000deb0: 2020 2020 2020 2020 2020 2020 7072 6f62              prob
-0000dec0: 655f 706f 696e 7473 203d 206e 702e 636f  e_points = np.co
-0000ded0: 7079 2870 726f 6265 5f70 6f69 6e74 7331  py(probe_points1
-0000dee0: 290a 2020 2020 2020 2020 2020 2020 7472  ).            tr
-0000def0: 793a 0a20 2020 2020 2020 2020 2020 2020  y:.             
-0000df00: 2020 2066 726f 6d20 7363 6970 792e 7370     from scipy.sp
-0000df10: 6174 6961 6c20 696d 706f 7274 2063 4b44  atial import cKD
-0000df20: 5472 6565 0a20 2020 2020 2020 2020 2020  Tree.           
-0000df30: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
-0000df40: 2020 2020 2020 2020 2020 2020 2020 6b64                kd
-0000df50: 7472 6565 203d 2063 4b44 5472 6565 2874  tree = cKDTree(t
-0000df60: 6172 6765 745f 706f 696e 7473 290a 2020  arget_points).  
-0000df70: 2020 2020 2020 2020 2020 2020 2020 6578                ex
-0000df80: 6365 7074 2052 756e 7469 6d65 4572 726f  cept RuntimeErro
-0000df90: 723a 0a20 2020 2020 2020 2020 2020 2020  r:.             
-0000dfa0: 2020 2020 2020 2072 6574 7572 6e20 4e6f         return No
-0000dfb0: 6e65 0a20 2020 2020 2020 2020 2020 2065  ne.            e
-0000dfc0: 7863 6570 7420 496d 706f 7274 4572 726f  xcept ImportErro
-0000dfd0: 723a 0a20 2020 2020 2020 2020 2020 2020  r:.             
-0000dfe0: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
-0000dff0: 2020 2020 2020 2020 2020 2020 6b64 7472              kdtr
-0000e000: 6565 203d 204b 4454 7265 6528 7461 7267  ee = KDTree(targ
-0000e010: 6574 5f70 6f69 6e74 7329 0a20 2020 2020  et_points).     
-0000e020: 2020 2020 2020 2020 2020 2065 7863 6570             excep
-0000e030: 7420 5275 6e74 696d 6545 7272 6f72 3a0a  t RuntimeError:.
-0000e040: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e050: 2020 2020 7265 7475 726e 204e 6f6e 650a      return None.
-0000e060: 2020 2020 2020 2020 6469 7374 616e 6365          distance
-0000e070: 7320 3d20 6b64 7472 6565 2e71 7565 7279  s = kdtree.query
-0000e080: 2870 726f 6265 5f70 6f69 6e74 7329 5b30  (probe_points)[0
-0000e090: 5d0a 2020 2020 2020 2020 6966 206c 656e  ].        if len
-0000e0a0: 2864 6973 7461 6e63 6573 2920 3d3d 2030  (distances) == 0
-0000e0b0: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
-0000e0c0: 7475 726e 204e 6f6e 650a 2020 2020 2020  turn None.      
-0000e0d0: 2020 6966 206e 6f74 2077 6569 6768 743a    if not weight:
-0000e0e0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-0000e0f0: 6e6f 7420 6e70 2e6d 6561 6e28 6469 7374  not np.mean(dist
-0000e100: 616e 6365 7329 203c 3d20 302e 3035 3a0a  ances) <= 0.05:.
-0000e110: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e120: 7265 7475 726e 2031 202f 206e 702e 6d65  return 1 / np.me
-0000e130: 616e 2864 6973 7461 6e63 6573 290a 2020  an(distances).  
-0000e140: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
-0000e150: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e160: 7265 7475 726e 2031 2f30 2e30 350a 0a20  return 1/0.05.. 
-0000e170: 2020 2020 2020 2078 203d 2069 6e74 2833         x = int(3
-0000e180: 302e 3020 2f20 6d61 705f 7461 7267 6574  0.0 / map_target
-0000e190: 2e61 7069 7829 0a20 2020 2020 2020 2069  .apix).        i
-0000e1a0: 6620 6e70 2e61 6d69 6e28 6469 7374 616e  f np.amin(distan
-0000e1b0: 6365 7329 203c 2078 202f 2032 3a0a 2020  ces) < x / 2:.  
-0000e1c0: 2020 2020 2020 2020 2020 6469 7374 616e            distan
-0000e1d0: 6365 7320 3d20 6469 7374 616e 6365 7320  ces = distances 
-0000e1e0: 2d20 6e70 2e61 6d69 6e28 6469 7374 616e  - np.amin(distan
-0000e1f0: 6365 7329 0a20 2020 2020 2020 2062 696e  ces).        bin
-0000e200: 7320 3d20 5b5d 0a20 2020 2020 2020 2069  s = [].        i
-0000e210: 203d 2030 0a20 2020 2020 2020 2077 6869   = 0.        whi
-0000e220: 6c65 2069 203c 3d20 666c 6f61 7428 7829  le i <= float(x)
-0000e230: 3a0a 2020 2020 2020 2020 2020 2020 6269  :.            bi
-0000e240: 6e73 2e61 7070 656e 6428 6920 2a20 312e  ns.append(i * 1.
-0000e250: 3029 0a20 2020 2020 2020 2020 2020 2069  0).            i
-0000e260: 202b 3d20 310a 2020 2020 2020 2020 6e75   += 1.        nu
-0000e270: 6d5f 6469 7374 616e 6365 7320 3d20 6c65  m_distances = le
-0000e280: 6e28 6469 7374 616e 6365 7329 0a20 2020  n(distances).   
-0000e290: 2020 2020 206f 7665 726c 6170 5f66 7265       overlap_fre
-0000e2a0: 7120 3d20 6e70 2e68 6973 746f 6772 616d  q = np.histogram
-0000e2b0: 2864 6973 7461 6e63 6573 2c20 6269 6e73  (distances, bins
-0000e2c0: 295b 305d 0a20 2020 2020 2020 2066 6f72  )[0].        for
-0000e2d0: 2066 725f 6920 696e 2072 616e 6765 286c   fr_i in range(l
-0000e2e0: 656e 286f 7665 726c 6170 5f66 7265 7129  en(overlap_freq)
-0000e2f0: 293a 0a20 2020 2020 2020 2020 2020 2069  ):.            i
-0000e300: 6620 6f76 6572 6c61 705f 6672 6571 5b66  f overlap_freq[f
-0000e310: 725f 695d 203e 206e 702e 616d 6178 286f  r_i] > np.amax(o
-0000e320: 7665 726c 6170 5f66 7265 7129 202f 2033  verlap_freq) / 3
-0000e330: 2e3a 0a20 2020 2020 2020 2020 2020 2020  .:.             
-0000e340: 2020 2062 7265 616b 0a20 2020 2020 2020     break.       
-0000e350: 2074 6f74 616c 5f65 7874 203d 2066 725f   total_ext = fr_
-0000e360: 690a 2020 2020 2020 2020 6269 6e73 203d  i.        bins =
-0000e370: 2062 696e 735b 6672 5f69 3a5d 0a20 2020   bins[fr_i:].   
-0000e380: 2020 2020 2069 6620 636c 3a20 2023 206e       if cl:  # n
-0000e390: 6f71 613a 4638 3231 0a20 2020 2020 2020  oqa:F821.       
-0000e3a0: 2020 2020 2070 6f69 6e74 735f 636c 203d       points_cl =
-0000e3b0: 2070 726f 6265 5f70 6f69 6e74 730a 2020   probe_points.  
-0000e3c0: 2020 2020 2020 2020 2020 6966 206c 656e            if len
-0000e3d0: 2870 6f69 6e74 735f 636c 2920 3d3d 2030  (points_cl) == 0
-0000e3e0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0000e3f0: 2020 7265 7475 726e 204e 6f6e 652c 204e    return None, N
-0000e400: 6f6e 650a 2020 2020 2020 2020 2020 2020  one.            
-0000e410: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
-0000e420: 2020 2020 206b 6474 7265 6520 3d20 634b       kdtree = cK
-0000e430: 4454 7265 6528 706f 696e 7473 5f63 6c29  DTree(points_cl)
-0000e440: 0a20 2020 2020 2020 2020 2020 2065 7863  .            exc
-0000e450: 6570 7420 4578 6365 7074 696f 6e3a 0a20  ept Exception:. 
-0000e460: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-0000e470: 6574 7572 6e20 4e6f 6e65 2c20 4e6f 6e65  eturn None, None
-0000e480: 0a20 2020 2020 2020 2020 2020 206e 6569  .            nei
-0000e490: 6768 626f 7273 5f6e 756d 203d 2032 300a  ghbors_num = 20.
-0000e4a0: 2020 2020 2020 2020 2020 2020 6469 7374              dist
-0000e4b0: 616e 6365 5f6c 696d 203d 2033 2e30 0a20  ance_lim = 3.0. 
-0000e4c0: 2020 2020 2020 2020 2020 206e 6569 6768             neigh
-0000e4d0: 203d 206b 6474 7265 652e 7175 6572 7928   = kdtree.query(
-0000e4e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000e4f0: 2070 6f69 6e74 735f 636c 2c0a 2020 2020   points_cl,.    
-0000e500: 2020 2020 2020 2020 2020 2020 6b3d 6e65              k=ne
-0000e510: 6967 6862 6f72 735f 6e75 6d2c 0a20 2020  ighbors_num,.   
-0000e520: 2020 2020 2020 2020 2020 2020 2064 6973               dis
-0000e530: 7461 6e63 655f 7570 7065 725f 626f 756e  tance_upper_boun
-0000e540: 643d 6469 7374 616e 6365 5f6c 696d 2c0a  d=distance_lim,.
-0000e550: 2020 2020 2020 2020 2020 2020 295b 315d              )[1]
-0000e560: 0a0a 2020 2020 2020 2020 2020 2020 636c  ..            cl
-0000e570: 5f77 6569 6768 7420 3d20 280a 2020 2020  _weight = (.    
+0000bc20: 2020 6869 6768 6c79 2065 7870 6f73 6564    highly exposed
+0000bc30: 2073 7572 6661 6365 2070 6f69 6e74 7320   surface points 
+0000bc40: 6861 7665 2076 6572 7920 6c6f 770a 2020  have very low.  
+0000bc50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000bc60: 2020 2020 2020 2020 2020 2020 2020 2076                 v
+0000bc70: 616c 7565 7320 616e 6420 7061 7274 6961  alues and partia
+0000bc80: 6c6c 7920 6578 706f 7365 6420 7375 7266  lly exposed surf
+0000bc90: 6163 6573 2f67 726f 6f76 6573 0a20 2020  aces/grooves.   
+0000bca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000bcb0: 2020 2020 2020 2020 2020 2020 2020 6861                ha
+0000bcc0: 7665 2072 656c 6174 6976 656c 7920 6869  ve relatively hi
+0000bcd0: 6768 6572 2076 616c 7565 732e 0a20 2020  gher values..   
+0000bce0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000bcf0: 2020 2020 2020 2020 2020 2020 2020 5468                Th
+0000bd00: 6973 2064 6566 696e 6974 696f 6e20 6973  is definition is
+0000bd10: 2075 7365 6675 6c20 6573 7065 6369 616c   useful especial
+0000bd20: 6c79 2077 6865 6e20 7468 650a 2020 2020  ly when the.    
+0000bd30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000bd40: 2020 2020 2020 2020 2020 2020 206d 6170               map
+0000bd50: 2073 7572 6661 6365 2068 6173 206d 616e   surface has man
+0000bd60: 7920 6665 6174 7572 6573 2f70 726f 6a65  y features/proje
+0000bd70: 6374 696f 6e73 2e0a 2020 2020 2020 2020  ctions..        
+0000bd80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000bd90: 3429 204d 696e 696d 756d 3a20 6120 6d69  4) Minimum: a mi
+0000bda0: 6e69 6d75 6d20 6669 6c74 6572 2069 7320  nimum filter is 
+0000bdb0: 6170 706c 6965 6420 6f6e 2061 2062 696e  applied on a bin
+0000bdc0: 6172 790a 2020 2020 2020 2020 2020 2020  ary.            
+0000bdd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000bde0: 2020 2020 2020 2020 636f 6e74 6f75 7220          contour 
+0000bdf0: 6d61 736b 2074 6f20 6c6f 6361 7465 2073  mask to locate s
+0000be00: 7572 6661 6365 2070 6f69 6e74 732e 0a20  urface points.. 
+0000be10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000be20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000be30: 2020 2056 6f78 656c 7320 7375 7272 6f75     Voxels surrou
+0000be40: 6e64 6564 2062 7920 706f 696e 7473 206f  nded by points o
+0000be50: 7574 7369 6465 2074 6865 0a20 2020 2020  utside the.     
+0000be60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000be70: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+0000be80: 6f6e 746f 7572 2028 7a65 726f 6573 2920  ontour (zeroes) 
+0000be90: 6172 6520 6465 7465 6374 6564 2061 7320  are detected as 
+0000bea0: 7375 7266 6163 652e 0a20 2020 2020 2020  surface..       
+0000beb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000bec0: 2020 2020 2020 2020 2020 2020 2056 6f78               Vox
+0000bed0: 656c 7320 7375 7272 6f75 6e64 6564 2062  els surrounded b
+0000bee0: 7920 706f 696e 7473 206f 7574 7369 6465  y points outside
+0000bef0: 2074 6865 0a20 2020 2020 2020 2020 2020   the.           
+0000bf00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000bf10: 2020 2020 2020 2020 2063 6f6e 746f 7572           contour
+0000bf20: 2028 7a65 726f 6573 2920 6172 6520 6465   (zeroes) are de
+0000bf30: 7465 6374 6564 2061 7320 7375 7266 6163  tected as surfac
+0000bf40: 652e 0a20 2020 2020 2020 2020 2020 2020  e..             
+0000bf50: 2020 2020 2020 2020 2020 2035 2920 536f             5) So
+0000bf60: 6265 6c3a 2073 6f62 656c 2066 696c 7465  bel: sobel filte
+0000bf70: 7220 6973 2061 7070 6c69 6564 206f 6e20  r is applied on 
+0000bf80: 7468 6520 6d61 7020 746f 2064 6574 6563  the map to detec
+0000bf90: 740a 2020 2020 2020 2020 2020 2020 2020  t.              
+0000bfa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000bfb0: 2020 2020 6869 6768 2064 656e 7369 7479      high density
+0000bfc0: 2067 7261 6469 656e 7473 2e20 4265 666f   gradients. Befo
+0000bfd0: 7265 2061 7070 6c79 696e 6720 7468 650a  re applying the.
+0000bfe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000bff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c000: 2020 736f 6265 6c20 6669 6c74 6572 2c20    sobel filter, 
+0000c010: 6974 2069 7320 696d 706f 7274 616e 7420  it is important 
+0000c020: 746f 2072 6564 7563 6520 7468 650a 2020  to reduce the.  
+0000c030: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c040: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c050: 6e6f 6973 6520 6465 6e73 6974 7920 616e  noise density an
+0000c060: 6420 6c61 7267 6520 7661 7269 6174 696f  d large variatio
+0000c070: 6e73 0a20 2020 2020 2020 2020 2020 2020  ns.             
+0000c080: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c090: 2020 2020 2028 6772 6164 6965 6e74 7329       (gradients)
+0000c0a0: 2069 6e20 7468 6520 6e6f 6973 6520 7265   in the noise re
+0000c0b0: 6769 6f6e 2e0a 2020 2020 2020 2020 2020  gion..          
+0000c0c0: 2020 2a77 6569 6768 742a 0a20 2020 2020    *weight*.     
+0000c0d0: 2020 2020 2020 2020 2020 2049 6620 7365             If se
+0000c0e0: 7420 7472 7565 2c20 7468 6520 6469 7374  t true, the dist
+0000c0f0: 616e 6365 7320 6265 7477 6565 6e20 7468  ances between th
+0000c100: 6520 7375 7266 6163 6520 706f 696e 7473  e surface points
+0000c110: 2069 730a 2020 2020 2020 2020 2020 2020   is.            
+0000c120: 2020 2020 6e6f 726d 616c 697a 6564 2069      normalized i
+0000c130: 6e20 6120 7761 7920 7369 6d69 6c61 7220  n a way similar 
+0000c140: 746f 2047 4454 2028 5a65 6d6c 6120 3230  to GDT (Zemla 20
+0000c150: 3037 290a 2020 2020 2020 2020 2020 2020  07).            
+0000c160: 2020 2020 6361 6c63 756c 6174 696f 6e20      calculation 
+0000c170: 666f 7220 6174 6f6d 6963 2063 6f2d 6f72  for atomic co-or
+0000c180: 6469 6e61 7465 2061 6c69 676e 6d65 6e74  dinate alignment
+0000c190: 732e 0a20 2020 2020 2020 2022 2222 0a20  s..        """. 
+0000c1a0: 2020 2020 2020 2023 2063 6865 636b 2069         # check i
+0000c1b0: 6620 626f 7468 206d 6170 7320 6172 6520  f both maps are 
+0000c1c0: 6f6e 2074 6865 2073 616d 6520 6772 6964  on the same grid
+0000c1d0: 0a20 2020 2020 2020 2069 6620 6e6f 7420  .        if not 
+0000c1e0: 7365 6c66 2e6d 6170 436f 6d70 6172 6973  self.mapComparis
+0000c1f0: 6f6e 286d 6170 5f74 6172 6765 742c 206d  on(map_target, m
+0000c200: 6170 5f70 726f 6265 293a 0a20 2020 2020  ap_probe):.     
+0000c210: 2020 2020 2020 2070 7269 6e74 2827 4040         print('@@
+0000c220: 4020 4d61 7073 2063 6f75 6c64 206e 6f74  @ Maps could not
+0000c230: 2062 6520 6d61 7463 6865 6427 290a 2020   be matched').  
+0000c240: 2020 2020 2020 2020 2020 7265 7475 726e            return
+0000c250: 202d 3939 392e 0a20 2020 2020 2020 2023   -999..        #
+0000c260: 2069 6620 7468 6520 626f 756e 6461 7269   if the boundari
+0000c270: 6573 2061 7265 206b 6e6f 776e 2c20 6361  es are known, ca
+0000c280: 6c63 756c 6174 6520 7468 6520 6b64 7472  lculate the kdtr
+0000c290: 6565 0a20 2020 2020 2020 2069 6620 4669  ee.        if Fi
+0000c2a0: 6c74 6572 2069 7320 4e6f 6e65 3a0a 2020  lter is None:.  
+0000c2b0: 2020 2020 2020 2020 2020 6b64 7472 6565            kdtree
+0000c2c0: 203d 206d 6170 5f74 6172 6765 742e 6d61   = map_target.ma
+0000c2d0: 6b65 4b44 5472 6565 280a 2020 2020 2020  keKDTree(.      
+0000c2e0: 2020 2020 2020 2020 2020 6d61 705f 7461            map_ta
+0000c2f0: 7267 6574 5f74 6872 6573 686f 6c64 312c  rget_threshold1,
+0000c300: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000c310: 206d 6170 5f74 6172 6765 745f 7468 7265   map_target_thre
+0000c320: 7368 6f6c 6432 0a20 2020 2020 2020 2020  shold2.         
+0000c330: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
+0000c340: 2070 726f 6265 5f70 6f69 6e74 7320 3d20   probe_points = 
+0000c350: 6d61 705f 7072 6f62 652e 6765 745f 706f  map_probe.get_po
+0000c360: 7328 0a20 2020 2020 2020 2020 2020 2020  s(.             
+0000c370: 2020 206d 6170 5f74 6172 6765 745f 7468     map_target_th
+0000c380: 7265 7368 6f6c 6431 2c0a 2020 2020 2020  reshold1,.      
+0000c390: 2020 2020 2020 2020 2020 6d61 705f 7461            map_ta
+0000c3a0: 7267 6574 5f74 6872 6573 686f 6c64 320a  rget_threshold2.
+0000c3b0: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+0000c3c0: 2020 2020 2020 656c 6966 2046 696c 7465        elif Filte
+0000c3d0: 7220 3d3d 2027 5374 6427 3a0a 2020 2020  r == 'Std':.    
+0000c3e0: 2020 2020 2020 2020 7461 7267 6574 5f70          target_p
+0000c3f0: 6f69 6e74 7320 3d20 6e70 2e61 7267 7768  oints = np.argwh
+0000c400: 6572 6528 0a20 2020 2020 2020 2020 2020  ere(.           
+0000c410: 2020 2020 2028 6d61 705f 7461 7267 6574       (map_target
+0000c420: 2e66 756c 6c4d 6170 203e 2028 0a20 2020  .fullMap > (.   
+0000c430: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c440: 2020 2020 2066 6c6f 6174 286d 6170 5f74       float(map_t
+0000c450: 6172 6765 745f 7468 7265 7368 6f6c 6431  arget_threshold1
+0000c460: 292d 286d 6170 5f74 6172 6765 742e 7374  )-(map_target.st
+0000c470: 6428 292a 302e 3130 2929 0a20 2020 2020  d()*0.10)).     
+0000c480: 2020 2020 2020 2020 2020 2020 2920 260a              ) &.
+0000c490: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c4a0: 286d 6170 5f74 6172 6765 742e 6675 6c6c  (map_target.full
+0000c4b0: 4d61 7020 3c20 280a 2020 2020 2020 2020  Map < (.        
+0000c4c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c4d0: 666c 6f61 7428 6d61 705f 7461 7267 6574  float(map_target
+0000c4e0: 5f74 6872 6573 686f 6c64 3129 2b28 6d61  _threshold1)+(ma
+0000c4f0: 705f 7461 7267 6574 2e73 7464 2829 2a30  p_target.std()*0
+0000c500: 2e31 3029 290a 2020 2020 2020 2020 2020  .10)).          
+0000c510: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+0000c520: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
+0000c530: 2020 2070 726f 6265 5f70 6f69 6e74 7320     probe_points 
+0000c540: 3d20 6e70 2e61 7267 7768 6572 6528 0a20  = np.argwhere(. 
+0000c550: 2020 2020 2020 2020 2020 2020 2020 2028                 (
+0000c560: 6d61 705f 7072 6f62 652e 6675 6c6c 4d61  map_probe.fullMa
+0000c570: 7020 3e20 280a 2020 2020 2020 2020 2020  p > (.          
+0000c580: 2020 2020 2020 2020 2020 2020 2020 666c                fl
+0000c590: 6f61 7428 6d61 705f 7072 6f62 655f 7468  oat(map_probe_th
+0000c5a0: 7265 7368 6f6c 6429 2d28 6d61 705f 7072  reshold)-(map_pr
+0000c5b0: 6f62 652e 7374 6428 292a 302e 3130 2929  obe.std()*0.10))
+0000c5c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000c5d0: 2020 2920 260a 2020 2020 2020 2020 2020    ) &.          
+0000c5e0: 2020 2020 2020 286d 6170 5f70 726f 6265        (map_probe
+0000c5f0: 2e66 756c 6c4d 6170 203c 2028 0a20 2020  .fullMap < (.   
+0000c600: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c610: 2020 2020 2066 6c6f 6174 286d 6170 5f70       float(map_p
+0000c620: 726f 6265 5f74 6872 6573 686f 6c64 292b  robe_threshold)+
+0000c630: 286d 6170 5f70 726f 6265 2e73 7464 2829  (map_probe.std()
+0000c640: 2a30 2e31 3029 290a 2020 2020 2020 2020  *0.10)).        
+0000c650: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
+0000c660: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+0000c670: 2020 2020 2069 6620 6c65 6e28 7461 7267       if len(targ
+0000c680: 6574 5f70 6f69 6e74 7329 203c 206c 656e  et_points) < len
+0000c690: 2870 726f 6265 5f70 6f69 6e74 7329 3a0a  (probe_points):.
+0000c6a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c6b0: 7072 6f62 655f 706f 696e 7473 3120 3d20  probe_points1 = 
+0000c6c0: 6e70 2e63 6f70 7928 7461 7267 6574 5f70  np.copy(target_p
+0000c6d0: 6f69 6e74 7329 0a20 2020 2020 2020 2020  oints).         
+0000c6e0: 2020 2020 2020 2074 6172 6765 745f 706f         target_po
+0000c6f0: 696e 7473 203d 206e 702e 636f 7079 2870  ints = np.copy(p
+0000c700: 726f 6265 5f70 6f69 6e74 7329 0a20 2020  robe_points).   
+0000c710: 2020 2020 2020 2020 2020 2020 2070 726f               pro
+0000c720: 6265 5f70 6f69 6e74 7320 3d20 6e70 2e63  be_points = np.c
+0000c730: 6f70 7928 7072 6f62 655f 706f 696e 7473  opy(probe_points
+0000c740: 3129 0a20 2020 2020 2020 2020 2020 2069  1).            i
+0000c750: 6620 6c65 6e28 7461 7267 6574 5f70 6f69  f len(target_poi
+0000c760: 6e74 7329 203d 3d20 3020 6f72 206c 656e  nts) == 0 or len
+0000c770: 2870 726f 6265 5f70 6f69 6e74 7329 203d  (probe_points) =
+0000c780: 3d20 303a 0a20 2020 2020 2020 2020 2020  = 0:.           
+0000c790: 2020 2020 2070 7269 6e74 2827 5375 7266       print('Surf
+0000c7a0: 6163 6520 6465 7465 6374 696f 6e20 6661  ace detection fa
+0000c7b0: 696c 6564 2028 5374 6420 6669 6c74 6572  iled (Std filter
+0000c7c0: 292c 2065 7869 7469 6e67 2e2e 2729 0a20  ), exiting..'). 
+0000c7d0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+0000c7e0: 6574 7572 6e20 4e6f 6e65 0a20 2020 2020  eturn None.     
+0000c7f0: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
+0000c800: 2020 2020 2020 2020 2020 2020 6672 6f6d              from
+0000c810: 2073 6369 7079 2e73 7061 7469 616c 2069   scipy.spatial i
+0000c820: 6d70 6f72 7420 634b 4454 7265 650a 2020  mport cKDTree.  
+0000c830: 2020 2020 2020 2020 2020 2020 2020 7472                tr
+0000c840: 793a 0a20 2020 2020 2020 2020 2020 2020  y:.             
+0000c850: 2020 2020 2020 206b 6474 7265 6520 3d20         kdtree = 
+0000c860: 634b 4454 7265 6528 7461 7267 6574 5f70  cKDTree(target_p
+0000c870: 6f69 6e74 7329 0a20 2020 2020 2020 2020  oints).         
+0000c880: 2020 2020 2020 2065 7863 6570 7420 5275         except Ru
+0000c890: 6e74 696d 6545 7272 6f72 3a0a 2020 2020  ntimeError:.    
+0000c8a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c8b0: 7265 7475 726e 204e 6f6e 650a 2020 2020  return None.    
+0000c8c0: 2020 2020 2020 2020 6578 6365 7074 2049          except I
+0000c8d0: 6d70 6f72 7445 7272 6f72 3a0a 2020 2020  mportError:.    
+0000c8e0: 2020 2020 2020 2020 2020 2020 7472 793a              try:
+0000c8f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000c900: 2020 2020 206b 6474 7265 6520 3d20 4b44       kdtree = KD
+0000c910: 5472 6565 2874 6172 6765 745f 706f 696e  Tree(target_poin
+0000c920: 7473 290a 2020 2020 2020 2020 2020 2020  ts).            
+0000c930: 2020 2020 6578 6365 7074 2052 756e 7469      except Runti
+0000c940: 6d65 4572 726f 723a 0a20 2020 2020 2020  meError:.       
+0000c950: 2020 2020 2020 2020 2020 2020 2072 6574               ret
+0000c960: 7572 6e20 4e6f 6e65 0a20 2020 2020 2020  urn None.       
+0000c970: 2065 6c69 6620 4669 6c74 6572 203d 3d20   elif Filter == 
+0000c980: 274d 6561 6e27 3a0a 2020 2020 2020 2020  'Mean':.        
+0000c990: 2020 2020 6d61 7031 5f66 696c 7465 7220      map1_filter 
+0000c9a0: 3d20 6d61 705f 7461 7267 6574 2e5f 7375  = map_target._su
+0000c9b0: 7266 6163 655f 6665 6174 7572 6573 280a  rface_features(.
+0000c9c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c9d0: 666c 6f61 7428 6d61 705f 7461 7267 6574  float(map_target
+0000c9e0: 5f74 6872 6573 686f 6c64 3129 0a20 2020  _threshold1).   
+0000c9f0: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
+0000ca00: 2020 2020 2020 206d 6170 325f 6669 6c74         map2_filt
+0000ca10: 6572 203d 206d 6170 5f70 726f 6265 2e5f  er = map_probe._
+0000ca20: 7375 7266 6163 655f 6665 6174 7572 6573  surface_features
+0000ca30: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+0000ca40: 2020 666c 6f61 7428 6d61 705f 7072 6f62    float(map_prob
+0000ca50: 655f 7468 7265 7368 6f6c 6429 0a20 2020  e_threshold).   
+0000ca60: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
+0000ca70: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
+0000ca80: 2020 2020 2020 2064 6566 696e 6520 7375         define su
+0000ca90: 7266 6163 6520 6261 7365 6420 6f6e 2074  rface based on t
+0000caa0: 6865 2066 696c 7465 7265 6420 6d61 736b  he filtered mask
+0000cab0: 2076 616c 7565 732e 0a20 2020 2020 2020   values..       
+0000cac0: 2020 2020 2070 6f69 6e74 7320 7769 7468       points with
+0000cad0: 2076 616c 7565 7320 6c65 7373 2074 6861   values less tha
+0000cae0: 6e20 302e 3320 6172 6520 7573 7561 6c6c  n 0.3 are usuall
+0000caf0: 7920 7072 6566 6572 7265 642e 2042 7574  y preferred. But
+0000cb00: 2069 6e0a 2020 2020 2020 2020 2020 2020   in.            
+0000cb10: 736f 6d65 2063 6173 6573 206c 696b 6520  some cases like 
+0000cb20: 7669 7275 7365 732c 206d 6f73 7420 7375  viruses, most su
+0000cb30: 7266 6163 6520 706f 696e 7473 2061 7265  rface points are
+0000cb40: 2068 6967 686c 7920 6578 706f 7365 640a   highly exposed.
+0000cb50: 2020 2020 2020 2020 2020 2020 616e 6420              and 
+0000cb60: 6120 6c61 7267 6520 6e75 6d62 6572 206f  a large number o
+0000cb70: 6620 706f 696e 7473 2061 7265 2072 6574  f points are ret
+0000cb80: 7572 6e65 6420 616e 6420 7468 6520 6361  urned and the ca
+0000cb90: 6c63 756c 6174 696f 6e0a 2020 2020 2020  lculation.      
+0000cba0: 2020 2020 2020 6265 636f 6d65 7320 736c        becomes sl
+0000cbb0: 6f77 2e0a 2020 2020 2020 2020 2020 2020  ow..            
+0000cbc0: 4865 6e63 6520 616e 2061 6464 6974 696f  Hence an additio
+0000cbd0: 6e61 6c20 6669 6c74 6572 2069 7320 6164  nal filter is ad
+0000cbe0: 6465 643a 2074 6865 206d 6178 696d 756d  ded: the maximum
+0000cbf0: 2061 6c6c 6f77 6564 2070 6f69 6e74 730a   allowed points.
+0000cc00: 2020 2020 2020 2020 2020 2020 6973 2031              is 1
+0000cc10: 3025 206f 6620 626f 7820 7369 7a65 2e0a  0% of box size..
+0000cc20: 2020 2020 2020 2020 2020 2020 5468 6520              The 
+0000cc30: 6d69 6e69 6d75 6d20 6e75 6d62 6572 206f  minimum number o
+0000cc40: 6620 706f 696e 7473 2069 7320 6b65 7074  f points is kept
+0000cc50: 2061 7320 3725 2e20 5468 6973 206d 6f64   as 7%. This mod
+0000cc60: 6520 6973 206c 6573 730a 2020 2020 2020  e is less.      
+0000cc70: 2020 2020 2020 7365 6e73 6974 6976 6520        sensitive 
+0000cc80: 746f 2074 6865 206e 756d 6265 7220 6f66  to the number of
+0000cc90: 2073 7572 6661 6365 2070 6f69 6e74 7320   surface points 
+0000cca0: 6368 6f73 656e 0a20 2020 2020 2020 2020  chosen.         
+0000ccb0: 2020 2061 7320 7468 6520 6578 7465 6e74     as the extent
+0000ccc0: 206f 6620 6578 706f 7375 7265 2069 7320   of exposure is 
+0000ccd0: 7573 6564 2066 6f72 2064 6566 696e 696e  used for definin
+0000cce0: 6720 7375 7266 6163 652e 2048 656e 6365  g surface. Hence
+0000ccf0: 0a20 2020 2020 2020 2020 2020 2074 6869  .            thi
+0000cd00: 636b 2073 7572 6661 6365 2069 7320 6e6f  ck surface is no
+0000cd10: 7420 7573 7561 6c6c 7920 7265 7175 6972  t usually requir
+0000cd20: 6564 2e0a 2020 2020 2020 2020 2020 2020  ed..            
+0000cd30: 6361 6c63 756c 6174 6520 6672 6571 7565  calculate freque
+0000cd40: 6e63 6965 7320 696e 2062 696e 7320 666f  ncies in bins fo
+0000cd50: 7220 6669 6c74 6572 6564 206d 6173 6b2e  r filtered mask.
+0000cd60: 0a20 2020 2020 2020 2020 2020 2054 6865  .            The
+0000cd70: 2073 6d61 6c6c 6572 2074 6865 2062 696e   smaller the bin
+0000cd80: 732c 206d 6f72 6520 7072 6563 6973 6520  s, more precise 
+0000cd90: 7769 6c6c 2062 6520 7468 6520 6361 6c63  will be the calc
+0000cda0: 756c 6174 696f 6e20 6f66 0a20 2020 2020  ulation of.     
+0000cdb0: 2020 2020 2020 2070 6f69 6e74 7320 616c         points al
+0000cdc0: 6c6f 7765 6420 6261 7365 6420 6f6e 2070  lowed based on p
+0000cdd0: 6572 6365 6e74 206f 6620 706f 696e 7473  ercent of points
+0000cde0: 2063 686f 7365 6e2e 0a20 2020 2020 2020   chosen..       
+0000cdf0: 2020 2020 2041 7320 7468 6973 2069 7320       As this is 
+0000ce00: 6a75 7374 2061 6e20 6164 6469 7469 6f6e  just an addition
+0000ce10: 616c 2066 696c 7465 7220 616e 6420 646f  al filter and do
+0000ce20: 6573 6e27 7420 6166 6665 6374 2074 6865  esn't affect the
+0000ce30: 0a20 2020 2020 2020 2020 2020 2063 616c  .            cal
+0000ce40: 6375 6c61 7469 6f6e 7320 6472 6173 7469  culations drasti
+0000ce50: 6361 6c6c 792c 2034 3020 6269 6e73 2061  cally, 40 bins a
+0000ce60: 7265 2075 7365 6420 746f 2063 616c 6375  re used to calcu
+0000ce70: 6c61 7465 0a20 2020 2020 2020 2020 2020  late.           
+0000ce80: 2066 7265 7175 656e 6369 6573 2e0a 2020   frequencies..  
+0000ce90: 2020 2020 2020 2020 2020 2222 220a 2020            """.  
+0000cea0: 2020 2020 2020 2020 2020 6269 6e5f 7465            bin_te
+0000ceb0: 7374 203d 205b 302e 3030 3031 5d0a 2020  st = [0.0001].  
+0000cec0: 2020 2020 2020 2020 2020 666f 7220 6969            for ii
+0000ced0: 2069 6e20 7261 6e67 6528 312c 2034 3129   in range(1, 41)
+0000cee0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0000cef0: 2020 6269 6e5f 7465 7374 2e61 7070 656e    bin_test.appen
+0000cf00: 6428 302e 3032 3520 2a20 6969 290a 2020  d(0.025 * ii).  
+0000cf10: 2020 2020 2020 2020 2020 6672 6571 5f74            freq_t
+0000cf20: 6573 7420 3d20 6e70 2e68 6973 746f 6772  est = np.histogr
+0000cf30: 616d 286d 6170 315f 6669 6c74 6572 2e66  am(map1_filter.f
+0000cf40: 756c 6c4d 6170 2c20 6269 6e5f 7465 7374  ullMap, bin_test
+0000cf50: 295b 305d 0a20 2020 2020 2020 2020 2020  )[0].           
+0000cf60: 206d 6170 315f 6669 6c6c 6564 203d 206e   map1_filled = n
+0000cf70: 702e 7375 6d28 6d61 7031 5f66 696c 7465  p.sum(map1_filte
+0000cf80: 722e 6675 6c6c 4d61 7020 3e20 3029 0a0a  r.fullMap > 0)..
+0000cf90: 2020 2020 2020 2020 2020 2020 7375 6d5f              sum_
+0000cfa0: 6672 6571 203d 2030 2e30 0a20 2020 2020  freq = 0.0.     
+0000cfb0: 2020 2020 2020 2066 6f72 2066 7220 696e         for fr in
+0000cfc0: 2072 616e 6765 286c 656e 2866 7265 715f   range(len(freq_
+0000cfd0: 7465 7374 2929 3a0a 2020 2020 2020 2020  test)):.        
+0000cfe0: 2020 2020 2020 2020 7375 6d5f 6672 6571          sum_freq
+0000cff0: 202b 3d20 666c 6f61 7428 6672 6571 5f74   += float(freq_t
+0000d000: 6573 745b 6672 5d29 0a20 2020 2020 2020  est[fr]).       
+0000d010: 2020 2020 2020 2020 2069 6620 7375 6d5f           if sum_
+0000d020: 6672 6571 202f 206d 6170 315f 6669 6c6c  freq / map1_fill
+0000d030: 6564 203e 2030 2e30 3520 616e 6420 6269  ed > 0.05 and bi
+0000d040: 6e5f 7465 7374 5b66 722b 315d 203e 3d20  n_test[fr+1] >= 
+0000d050: 302e 333a 0a20 2020 2020 2020 2020 2020  0.3:.           
+0000d060: 2020 2020 2020 2020 2074 3120 3d20 6269           t1 = bi
+0000d070: 6e5f 7465 7374 5b66 722b 315d 0a20 2020  n_test[fr+1].   
+0000d080: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d090: 2062 7265 616b 0a20 2020 2020 2020 2020   break.         
+0000d0a0: 2020 2020 2020 2069 6620 7375 6d5f 6672         if sum_fr
+0000d0b0: 6571 202f 206d 6170 315f 6669 6c6c 6564  eq / map1_filled
+0000d0c0: 203e 2030 2e31 3020 6f72 2073 756d 5f66   > 0.10 or sum_f
+0000d0d0: 7265 7120 3e20 3230 3030 3030 3a0a 2020  req > 200000:.  
+0000d0e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d0f0: 2020 7431 203d 2062 696e 5f74 6573 745b    t1 = bin_test[
+0000d100: 6672 2b31 5d0a 2020 2020 2020 2020 2020  fr+1].          
+0000d110: 2020 2020 2020 2020 2020 6272 6561 6b0a            break.
+0000d120: 2020 2020 2020 2020 2020 2020 7375 6d5f              sum_
+0000d130: 6672 6571 203d 2030 2e30 0a20 2020 2020  freq = 0.0.     
+0000d140: 2020 2020 2020 2066 7265 715f 7465 7374         freq_test
+0000d150: 203d 206e 702e 6869 7374 6f67 7261 6d28   = np.histogram(
+0000d160: 6d61 7032 5f66 696c 7465 722e 6675 6c6c  map2_filter.full
+0000d170: 4d61 702c 2062 696e 5f74 6573 7429 5b30  Map, bin_test)[0
+0000d180: 5d0a 2020 2020 2020 2020 2020 2020 6d61  ].            ma
+0000d190: 7032 5f66 696c 6c65 6420 3d20 6e70 2e73  p2_filled = np.s
+0000d1a0: 756d 286d 6170 325f 6669 6c74 6572 2e66  um(map2_filter.f
+0000d1b0: 756c 6c4d 6170 203e 2030 290a 2020 2020  ullMap > 0).    
+0000d1c0: 2020 2020 2020 2020 666f 7220 6672 2069          for fr i
+0000d1d0: 6e20 7261 6e67 6528 6c65 6e28 6672 6571  n range(len(freq
+0000d1e0: 5f74 6573 7429 293a 0a20 2020 2020 2020  _test)):.       
+0000d1f0: 2020 2020 2020 2020 2073 756d 5f66 7265           sum_fre
+0000d200: 7120 2b3d 2066 6c6f 6174 2866 7265 715f  q += float(freq_
+0000d210: 7465 7374 5b66 725d 290a 2020 2020 2020  test[fr]).      
+0000d220: 2020 2020 2020 2020 2020 6966 2073 756d            if sum
+0000d230: 5f66 7265 712f 6d61 7032 5f66 696c 6c65  _freq/map2_fille
+0000d240: 6420 3e20 302e 3035 2061 6e64 2062 696e  d > 0.05 and bin
+0000d250: 5f74 6573 745b 6672 2b31 5d20 3e3d 2030  _test[fr+1] >= 0
+0000d260: 2e33 3a0a 2020 2020 2020 2020 2020 2020  .3:.            
+0000d270: 2020 2020 2020 2020 7432 203d 2062 696e          t2 = bin
+0000d280: 5f74 6573 745b 6672 2b31 5d0a 2020 2020  _test[fr+1].    
+0000d290: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d2a0: 6272 6561 6b0a 2020 2020 2020 2020 2020  break.          
+0000d2b0: 2020 2020 2020 6966 2073 756d 5f66 7265        if sum_fre
+0000d2c0: 712f 6d61 7032 5f66 696c 6c65 6420 3e20  q/map2_filled > 
+0000d2d0: 302e 3130 206f 7220 7375 6d5f 6672 6571  0.10 or sum_freq
+0000d2e0: 203e 2032 3030 3030 303a 0a20 2020 2020   > 200000:.     
+0000d2f0: 2020 2020 2020 2020 2020 2020 2020 2074                 t
+0000d300: 3220 3d20 6269 6e5f 7465 7374 5b66 722b  2 = bin_test[fr+
+0000d310: 315d 0a20 2020 2020 2020 2020 2020 2020  1].             
+0000d320: 2020 2020 2020 2062 7265 616b 0a20 2020         break.   
+0000d330: 2020 2020 2020 2020 2023 2074 3120 616e           # t1 an
+0000d340: 6420 7432 2061 7265 2074 6865 2073 656c  d t2 are the sel
+0000d350: 6563 7465 6420 6c65 7665 6c73 2062 6173  ected levels bas
+0000d360: 6564 206f 6e20 6669 6c74 6572 6564 2076  ed on filtered v
+0000d370: 616c 7565 7320 616e 640a 2020 2020 2020  alues and.      
+0000d380: 2020 2020 2020 2320 7065 7263 656e 7420        # percent 
+0000d390: 6f66 2070 6f69 6e74 730a 2020 2020 2020  of points.      
+0000d3a0: 2020 2020 2020 7461 7267 6574 5f70 6f69        target_poi
+0000d3b0: 6e74 7320 3d20 6e70 2e61 7267 7768 6572  nts = np.argwher
+0000d3c0: 6528 0a20 2020 2020 2020 2020 2020 2020  e(.             
+0000d3d0: 2020 2028 6d61 7031 5f66 696c 7465 722e     (map1_filter.
+0000d3e0: 6675 6c6c 4d61 7020 3e20 302e 3029 2026  fullMap > 0.0) &
+0000d3f0: 2028 6d61 7031 5f66 696c 7465 722e 6675   (map1_filter.fu
+0000d400: 6c6c 4d61 7020 3c3d 2074 3129 0a20 2020  llMap <= t1).   
+0000d410: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
+0000d420: 2020 2020 2020 2070 726f 6265 5f70 6f69         probe_poi
+0000d430: 6e74 7320 3d20 6e70 2e61 7267 7768 6572  nts = np.argwher
+0000d440: 6528 0a20 2020 2020 2020 2020 2020 2020  e(.             
+0000d450: 2020 2028 6d61 7032 5f66 696c 7465 722e     (map2_filter.
+0000d460: 6675 6c6c 4d61 7020 3e20 302e 3029 2026  fullMap > 0.0) &
+0000d470: 2028 6d61 7032 5f66 696c 7465 722e 6675   (map2_filter.fu
+0000d480: 6c6c 4d61 7020 3c3d 2074 3229 0a20 2020  llMap <= t2).   
+0000d490: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
+0000d4a0: 2020 2020 2020 2069 6620 6c65 6e28 7461         if len(ta
+0000d4b0: 7267 6574 5f70 6f69 6e74 7329 203d 3d20  rget_points) == 
+0000d4c0: 3020 6f72 206c 656e 2870 726f 6265 5f70  0 or len(probe_p
+0000d4d0: 6f69 6e74 7329 203d 3d20 303a 0a20 2020  oints) == 0:.   
+0000d4e0: 2020 2020 2020 2020 2020 2020 2070 7269               pri
+0000d4f0: 6e74 2827 5375 7266 6163 6520 6465 7465  nt('Surface dete
+0000d500: 6374 696f 6e20 6661 696c 6564 2028 4d65  ction failed (Me
+0000d510: 616e 2066 696c 7465 7229 2c20 6578 6974  an filter), exit
+0000d520: 696e 672e 2e27 290a 2020 2020 2020 2020  ing..').        
+0000d530: 2020 2020 2020 2020 7265 7475 726e 204e          return N
+0000d540: 6f6e 650a 2020 2020 2020 2020 2020 2020  one.            
+0000d550: 6966 206c 656e 2874 6172 6765 745f 706f  if len(target_po
+0000d560: 696e 7473 2920 3c20 6c65 6e28 7072 6f62  ints) < len(prob
+0000d570: 655f 706f 696e 7473 293a 0a20 2020 2020  e_points):.     
+0000d580: 2020 2020 2020 2020 2020 2070 726f 6265             probe
+0000d590: 5f70 6f69 6e74 7331 203d 206e 702e 636f  _points1 = np.co
+0000d5a0: 7079 2874 6172 6765 745f 706f 696e 7473  py(target_points
+0000d5b0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0000d5c0: 2020 7461 7267 6574 5f70 6f69 6e74 7320    target_points 
+0000d5d0: 3d20 6e70 2e63 6f70 7928 7072 6f62 655f  = np.copy(probe_
+0000d5e0: 706f 696e 7473 290a 2020 2020 2020 2020  points).        
+0000d5f0: 2020 2020 2020 2020 7072 6f62 655f 706f          probe_po
+0000d600: 696e 7473 203d 206e 702e 636f 7079 2870  ints = np.copy(p
+0000d610: 726f 6265 5f70 6f69 6e74 7331 290a 2020  robe_points1).  
+0000d620: 2020 2020 2020 2020 2020 7472 793a 0a20            try:. 
+0000d630: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+0000d640: 726f 6d20 7363 6970 792e 7370 6174 6961  rom scipy.spatia
+0000d650: 6c20 696d 706f 7274 2063 4b44 5472 6565  l import cKDTree
+0000d660: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000d670: 2074 7279 3a0a 2020 2020 2020 2020 2020   try:.          
+0000d680: 2020 2020 2020 2020 2020 6b64 7472 6565            kdtree
+0000d690: 203d 2063 4b44 5472 6565 2874 6172 6765   = cKDTree(targe
+0000d6a0: 745f 706f 696e 7473 290a 2020 2020 2020  t_points).      
+0000d6b0: 2020 2020 2020 2020 2020 6578 6365 7074            except
+0000d6c0: 2052 756e 7469 6d65 4572 726f 723a 0a20   RuntimeError:. 
+0000d6d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d6e0: 2020 2072 6574 7572 6e20 4e6f 6e65 0a20     return None. 
+0000d6f0: 2020 2020 2020 2020 2020 2065 7863 6570             excep
+0000d700: 7420 496d 706f 7274 4572 726f 723a 0a20  t ImportError:. 
+0000d710: 2020 2020 2020 2020 2020 2020 2020 2074                 t
+0000d720: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
+0000d730: 2020 2020 2020 2020 6b64 7472 6565 203d          kdtree =
+0000d740: 204b 4454 7265 6528 7461 7267 6574 5f70   KDTree(target_p
+0000d750: 6f69 6e74 7329 0a20 2020 2020 2020 2020  oints).         
+0000d760: 2020 2020 2020 2065 7863 6570 7420 5275         except Ru
+0000d770: 6e74 696d 6545 7272 6f72 3a0a 2020 2020  ntimeError:.    
+0000d780: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d790: 7265 7475 726e 204e 6f6e 650a 2020 2020  return None.    
+0000d7a0: 2020 2020 656c 6966 2046 696c 7465 7220      elif Filter 
+0000d7b0: 3d3d 2027 4d69 6e69 6d75 6d27 3a0a 2020  == 'Minimum':.  
+0000d7c0: 2020 2020 2020 2020 2020 6d61 7031 5f73            map1_s
+0000d7d0: 7572 6661 6365 203d 206d 6170 5f74 6172  urface = map_tar
+0000d7e0: 6765 742e 5f73 7572 6661 6365 5f6d 696e  get._surface_min
+0000d7f0: 696d 756d 5f66 696c 7465 7228 0a20 2020  imum_filter(.   
+0000d800: 2020 2020 2020 2020 2020 2020 2066 6c6f               flo
+0000d810: 6174 286d 6170 5f74 6172 6765 745f 7468  at(map_target_th
+0000d820: 7265 7368 6f6c 6431 290a 2020 2020 2020  reshold1).      
+0000d830: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+0000d840: 2020 2020 6d61 7032 5f73 7572 6661 6365      map2_surface
+0000d850: 203d 206d 6170 5f70 726f 6265 2e5f 7375   = map_probe._su
+0000d860: 7266 6163 655f 6d69 6e69 6d75 6d5f 6669  rface_minimum_fi
+0000d870: 6c74 6572 280a 2020 2020 2020 2020 2020  lter(.          
+0000d880: 2020 2020 2020 666c 6f61 7428 6d61 705f        float(map_
+0000d890: 7072 6f62 655f 7468 7265 7368 6f6c 6429  probe_threshold)
+0000d8a0: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
+0000d8b0: 2020 2020 2020 2020 2020 2023 2073 656c             # sel
+0000d8c0: 6563 7420 7468 6520 7375 7266 6163 6520  ect the surface 
+0000d8d0: 706f 696e 7473 2072 6570 7265 7365 6e74  points represent
+0000d8e0: 6564 2062 7920 7468 6520 6d61 736b 0a20  ed by the mask. 
+0000d8f0: 2020 2020 2020 2020 2020 2074 6172 6765             targe
+0000d900: 745f 706f 696e 7473 203d 206e 702e 6172  t_points = np.ar
+0000d910: 6777 6865 7265 286d 6170 315f 7375 7266  gwhere(map1_surf
+0000d920: 6163 6520 3d3d 2031 290a 2020 2020 2020  ace == 1).      
+0000d930: 2020 2020 2020 7072 6f62 655f 706f 696e        probe_poin
+0000d940: 7473 203d 206e 702e 6172 6777 6865 7265  ts = np.argwhere
+0000d950: 286d 6170 325f 7375 7266 6163 6520 3d3d  (map2_surface ==
+0000d960: 2031 290a 2020 2020 2020 2020 2020 2020   1).            
+0000d970: 6966 206c 656e 2874 6172 6765 745f 706f  if len(target_po
+0000d980: 696e 7473 2920 3d3d 2030 206f 7220 6c65  ints) == 0 or le
+0000d990: 6e28 7072 6f62 655f 706f 696e 7473 2920  n(probe_points) 
+0000d9a0: 3d3d 2030 3a0a 2020 2020 2020 2020 2020  == 0:.          
+0000d9b0: 2020 2020 2020 7072 696e 7428 2753 7572        print('Sur
+0000d9c0: 6661 6365 2064 6574 6563 7469 6f6e 2066  face detection f
+0000d9d0: 6169 6c65 6420 284d 696e 696d 756d 2066  ailed (Minimum f
+0000d9e0: 696c 7465 7229 2c20 6578 6974 696e 672e  ilter), exiting.
+0000d9f0: 2e27 290a 2020 2020 2020 2020 2020 2020  .').            
+0000da00: 2020 2020 7265 7475 726e 204e 6f6e 650a      return None.
+0000da10: 2020 2020 2020 2020 2020 2020 6966 206c              if l
+0000da20: 656e 2874 6172 6765 745f 706f 696e 7473  en(target_points
+0000da30: 2920 2b20 6c65 6e28 7072 6f62 655f 706f  ) + len(probe_po
+0000da40: 696e 7473 2920 3e20 3235 3030 3030 3a0a  ints) > 250000:.
+0000da50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000da60: 7265 7475 726e 204e 6f6e 650a 2020 2020  return None.    
+0000da70: 2020 2020 2020 2020 6966 206c 656e 2874          if len(t
+0000da80: 6172 6765 745f 706f 696e 7473 2920 3c20  arget_points) < 
+0000da90: 6c65 6e28 7072 6f62 655f 706f 696e 7473  len(probe_points
+0000daa0: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+0000dab0: 2020 2070 726f 6265 5f70 6f69 6e74 7331     probe_points1
+0000dac0: 203d 206e 702e 636f 7079 2874 6172 6765   = np.copy(targe
+0000dad0: 745f 706f 696e 7473 290a 2020 2020 2020  t_points).      
+0000dae0: 2020 2020 2020 2020 2020 7461 7267 6574            target
+0000daf0: 5f70 6f69 6e74 7320 3d20 6e70 2e63 6f70  _points = np.cop
+0000db00: 7928 7072 6f62 655f 706f 696e 7473 290a  y(probe_points).
+0000db10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000db20: 7072 6f62 655f 706f 696e 7473 203d 206e  probe_points = n
+0000db30: 702e 636f 7079 2870 726f 6265 5f70 6f69  p.copy(probe_poi
+0000db40: 6e74 7331 290a 2020 2020 2020 2020 2020  nts1).          
+0000db50: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
+0000db60: 2020 2020 2020 2066 726f 6d20 7363 6970         from scip
+0000db70: 792e 7370 6174 6961 6c20 696d 706f 7274  y.spatial import
+0000db80: 2063 4b44 5472 6565 0a20 2020 2020 2020   cKDTree.       
+0000db90: 2020 2020 2020 2020 2074 7279 3a0a 2020           try:.  
+0000dba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000dbb0: 2020 6b64 7472 6565 203d 2063 4b44 5472    kdtree = cKDTr
+0000dbc0: 6565 2874 6172 6765 745f 706f 696e 7473  ee(target_points
+0000dbd0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0000dbe0: 2020 6578 6365 7074 2052 756e 7469 6d65    except Runtime
+0000dbf0: 4572 726f 723a 0a20 2020 2020 2020 2020  Error:.         
+0000dc00: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+0000dc10: 6e20 4e6f 6e65 0a20 2020 2020 2020 2020  n None.         
+0000dc20: 2020 2065 7863 6570 7420 496d 706f 7274     except Import
+0000dc30: 4572 726f 723a 0a20 2020 2020 2020 2020  Error:.         
+0000dc40: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
+0000dc50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000dc60: 6b64 7472 6565 203d 204b 4454 7265 6528  kdtree = KDTree(
+0000dc70: 7461 7267 6574 5f70 6f69 6e74 7329 0a20  target_points). 
+0000dc80: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+0000dc90: 7863 6570 7420 5275 6e74 696d 6545 7272  xcept RuntimeErr
+0000dca0: 6f72 3a0a 2020 2020 2020 2020 2020 2020  or:.            
+0000dcb0: 2020 2020 2020 2020 7265 7475 726e 204e          return N
+0000dcc0: 6f6e 650a 2020 2020 2020 2020 656c 6966  one.        elif
+0000dcd0: 2046 696c 7465 7220 3d3d 2027 536f 6265   Filter == 'Sobe
+0000dce0: 6c27 3a0a 2020 2020 2020 2020 2020 2020  l':.            
+0000dcf0: 6d61 7031 5f73 7572 6661 6365 203d 206d  map1_surface = m
+0000dd00: 6170 5f74 6172 6765 742e 5f73 6f62 656c  ap_target._sobel
+0000dd10: 5f66 696c 7465 725f 636f 6e74 6f75 7228  _filter_contour(
+0000dd20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000dd30: 2066 6c6f 6174 286d 6170 5f74 6172 6765   float(map_targe
+0000dd40: 745f 7468 7265 7368 6f6c 6431 290a 2020  t_threshold1).  
+0000dd50: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+0000dd60: 2020 2020 2020 2020 6d61 7032 5f73 7572          map2_sur
+0000dd70: 6661 6365 203d 206d 6170 5f70 726f 6265  face = map_probe
+0000dd80: 2e5f 736f 6265 6c5f 6669 6c74 6572 5f63  ._sobel_filter_c
+0000dd90: 6f6e 746f 7572 280a 2020 2020 2020 2020  ontour(.        
+0000dda0: 2020 2020 2020 2020 666c 6f61 7428 6d61          float(ma
+0000ddb0: 705f 7072 6f62 655f 7468 7265 7368 6f6c  p_probe_threshol
+0000ddc0: 6429 0a20 2020 2020 2020 2020 2020 2029  d).            )
+0000ddd0: 0a0a 2020 2020 2020 2020 2020 2020 7461  ..            ta
+0000dde0: 7267 6574 5f70 6f69 6e74 7320 3d20 6e70  rget_points = np
+0000ddf0: 2e61 7267 7768 6572 6528 0a20 2020 2020  .argwhere(.     
+0000de00: 2020 2020 2020 2020 2020 206d 6170 315f             map1_
+0000de10: 7375 7266 6163 652e 6675 6c6c 4d61 7020  surface.fullMap 
+0000de20: 3e20 6d61 7031 5f73 7572 6661 6365 2e6d  > map1_surface.m
+0000de30: 6178 2829 202f 2066 6c6f 6174 2832 290a  ax() / float(2).
+0000de40: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+0000de50: 2020 2020 2020 2020 2020 7072 6f62 655f            probe_
+0000de60: 706f 696e 7473 203d 206e 702e 6172 6777  points = np.argw
+0000de70: 6865 7265 280a 2020 2020 2020 2020 2020  here(.          
+0000de80: 2020 2020 2020 6d61 7032 5f73 7572 6661        map2_surfa
+0000de90: 6365 2e66 756c 6c4d 6170 203e 206d 6170  ce.fullMap > map
+0000dea0: 325f 7375 7266 6163 652e 6d61 7828 2920  2_surface.max() 
+0000deb0: 2f20 666c 6f61 7428 3229 0a20 2020 2020  / float(2).     
+0000dec0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+0000ded0: 2020 2020 2069 6620 6c65 6e28 7461 7267       if len(targ
+0000dee0: 6574 5f70 6f69 6e74 7329 203d 3d20 3020  et_points) == 0 
+0000def0: 6f72 206c 656e 2870 726f 6265 5f70 6f69  or len(probe_poi
+0000df00: 6e74 7329 203d 3d20 303a 0a20 2020 2020  nts) == 0:.     
+0000df10: 2020 2020 2020 2020 2020 2070 7269 6e74             print
+0000df20: 2827 5375 7266 6163 6520 6465 7465 6374  ('Surface detect
+0000df30: 696f 6e20 6661 696c 6564 2028 536f 6265  ion failed (Sobe
+0000df40: 6c20 6669 6c74 6572 292c 2065 7869 7469  l filter), exiti
+0000df50: 6e67 2e2e 2729 0a20 2020 2020 2020 2020  ng..').         
+0000df60: 2020 2020 2020 2072 6574 7572 6e20 4e6f         return No
+0000df70: 6e65 0a20 2020 2020 2020 2020 2020 2069  ne.            i
+0000df80: 6620 6c65 6e28 7461 7267 6574 5f70 6f69  f len(target_poi
+0000df90: 6e74 7329 203c 206c 656e 2870 726f 6265  nts) < len(probe
+0000dfa0: 5f70 6f69 6e74 7329 3a0a 2020 2020 2020  _points):.      
+0000dfb0: 2020 2020 2020 2020 2020 7072 6f62 655f            probe_
+0000dfc0: 706f 696e 7473 3120 3d20 6e70 2e63 6f70  points1 = np.cop
+0000dfd0: 7928 7461 7267 6574 5f70 6f69 6e74 7329  y(target_points)
+0000dfe0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000dff0: 2074 6172 6765 745f 706f 696e 7473 203d   target_points =
+0000e000: 206e 702e 636f 7079 2870 726f 6265 5f70   np.copy(probe_p
+0000e010: 6f69 6e74 7329 0a20 2020 2020 2020 2020  oints).         
+0000e020: 2020 2020 2020 2070 726f 6265 5f70 6f69         probe_poi
+0000e030: 6e74 7320 3d20 6e70 2e63 6f70 7928 7072  nts = np.copy(pr
+0000e040: 6f62 655f 706f 696e 7473 3129 0a20 2020  obe_points1).   
+0000e050: 2020 2020 2020 2020 2074 7279 3a0a 2020           try:.  
+0000e060: 2020 2020 2020 2020 2020 2020 2020 6672                fr
+0000e070: 6f6d 2073 6369 7079 2e73 7061 7469 616c  om scipy.spatial
+0000e080: 2069 6d70 6f72 7420 634b 4454 7265 650a   import cKDTree.
+0000e090: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e0a0: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
+0000e0b0: 2020 2020 2020 2020 206b 6474 7265 6520           kdtree 
+0000e0c0: 3d20 634b 4454 7265 6528 7461 7267 6574  = cKDTree(target
+0000e0d0: 5f70 6f69 6e74 7329 0a20 2020 2020 2020  _points).       
+0000e0e0: 2020 2020 2020 2020 2065 7863 6570 7420           except 
+0000e0f0: 5275 6e74 696d 6545 7272 6f72 3a0a 2020  RuntimeError:.  
+0000e100: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e110: 2020 7265 7475 726e 204e 6f6e 650a 2020    return None.  
+0000e120: 2020 2020 2020 2020 2020 6578 6365 7074            except
+0000e130: 2049 6d70 6f72 7445 7272 6f72 3a0a 2020   ImportError:.  
+0000e140: 2020 2020 2020 2020 2020 2020 2020 7472                tr
+0000e150: 793a 0a20 2020 2020 2020 2020 2020 2020  y:.             
+0000e160: 2020 2020 2020 206b 6474 7265 6520 3d20         kdtree = 
+0000e170: 4b44 5472 6565 2874 6172 6765 745f 706f  KDTree(target_po
+0000e180: 696e 7473 290a 2020 2020 2020 2020 2020  ints).          
+0000e190: 2020 2020 2020 6578 6365 7074 2052 756e        except Run
+0000e1a0: 7469 6d65 4572 726f 723a 0a20 2020 2020  timeError:.     
+0000e1b0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+0000e1c0: 6574 7572 6e20 4e6f 6e65 0a20 2020 2020  eturn None.     
+0000e1d0: 2020 2064 6973 7461 6e63 6573 203d 206b     distances = k
+0000e1e0: 6474 7265 652e 7175 6572 7928 7072 6f62  dtree.query(prob
+0000e1f0: 655f 706f 696e 7473 295b 305d 0a20 2020  e_points)[0].   
+0000e200: 2020 2020 2069 6620 6c65 6e28 6469 7374       if len(dist
+0000e210: 616e 6365 7329 203d 3d20 303a 0a20 2020  ances) == 0:.   
+0000e220: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+0000e230: 4e6f 6e65 0a20 2020 2020 2020 2069 6620  None.        if 
+0000e240: 6e6f 7420 7765 6967 6874 3a0a 2020 2020  not weight:.    
+0000e250: 2020 2020 2020 2020 6966 206e 6f74 206e          if not n
+0000e260: 702e 6d65 616e 2864 6973 7461 6e63 6573  p.mean(distances
+0000e270: 2920 3c3d 2030 2e30 353a 0a20 2020 2020  ) <= 0.05:.     
+0000e280: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+0000e290: 6e20 3120 2f20 6e70 2e6d 6561 6e28 6469  n 1 / np.mean(di
+0000e2a0: 7374 616e 6365 7329 0a20 2020 2020 2020  stances).       
+0000e2b0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+0000e2c0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+0000e2d0: 6e20 312f 302e 3035 0a0a 2020 2020 2020  n 1/0.05..      
+0000e2e0: 2020 7820 3d20 696e 7428 3330 2e30 202f    x = int(30.0 /
+0000e2f0: 206d 6170 5f74 6172 6765 742e 6170 6978   map_target.apix
+0000e300: 290a 2020 2020 2020 2020 6966 206e 702e  ).        if np.
+0000e310: 616d 696e 2864 6973 7461 6e63 6573 2920  amin(distances) 
+0000e320: 3c20 7820 2f20 323a 0a20 2020 2020 2020  < x / 2:.       
+0000e330: 2020 2020 2064 6973 7461 6e63 6573 203d       distances =
+0000e340: 2064 6973 7461 6e63 6573 202d 206e 702e   distances - np.
+0000e350: 616d 696e 2864 6973 7461 6e63 6573 290a  amin(distances).
+0000e360: 2020 2020 2020 2020 6269 6e73 203d 205b          bins = [
+0000e370: 5d0a 2020 2020 2020 2020 6920 3d20 300a  ].        i = 0.
+0000e380: 2020 2020 2020 2020 7768 696c 6520 6920          while i 
+0000e390: 3c3d 2066 6c6f 6174 2878 293a 0a20 2020  <= float(x):.   
+0000e3a0: 2020 2020 2020 2020 2062 696e 732e 6170           bins.ap
+0000e3b0: 7065 6e64 2869 202a 2031 2e30 290a 2020  pend(i * 1.0).  
+0000e3c0: 2020 2020 2020 2020 2020 6920 2b3d 2031            i += 1
+0000e3d0: 0a20 2020 2020 2020 206e 756d 5f64 6973  .        num_dis
+0000e3e0: 7461 6e63 6573 203d 206c 656e 2864 6973  tances = len(dis
+0000e3f0: 7461 6e63 6573 290a 2020 2020 2020 2020  tances).        
+0000e400: 6f76 6572 6c61 705f 6672 6571 203d 206e  overlap_freq = n
+0000e410: 702e 6869 7374 6f67 7261 6d28 6469 7374  p.histogram(dist
+0000e420: 616e 6365 732c 2062 696e 7329 5b30 5d0a  ances, bins)[0].
+0000e430: 2020 2020 2020 2020 666f 7220 6672 5f69          for fr_i
+0000e440: 2069 6e20 7261 6e67 6528 6c65 6e28 6f76   in range(len(ov
+0000e450: 6572 6c61 705f 6672 6571 2929 3a0a 2020  erlap_freq)):.  
+0000e460: 2020 2020 2020 2020 2020 6966 206f 7665            if ove
+0000e470: 726c 6170 5f66 7265 715b 6672 5f69 5d20  rlap_freq[fr_i] 
+0000e480: 3e20 6e70 2e61 6d61 7828 6f76 6572 6c61  > np.amax(overla
+0000e490: 705f 6672 6571 2920 2f20 332e 3a0a 2020  p_freq) / 3.:.  
+0000e4a0: 2020 2020 2020 2020 2020 2020 2020 6272                br
+0000e4b0: 6561 6b0a 2020 2020 2020 2020 746f 7461  eak.        tota
+0000e4c0: 6c5f 6578 7420 3d20 6672 5f69 0a20 2020  l_ext = fr_i.   
+0000e4d0: 2020 2020 2062 696e 7320 3d20 6269 6e73       bins = bins
+0000e4e0: 5b66 725f 693a 5d0a 2020 2020 2020 2020  [fr_i:].        
+0000e4f0: 6966 2063 6c3a 2020 2320 6e6f 7161 3a46  if cl:  # noqa:F
+0000e500: 3832 310a 2020 2020 2020 2020 2020 2020  821.            
+0000e510: 706f 696e 7473 5f63 6c20 3d20 7072 6f62  points_cl = prob
+0000e520: 655f 706f 696e 7473 0a20 2020 2020 2020  e_points.       
+0000e530: 2020 2020 2069 6620 6c65 6e28 706f 696e       if len(poin
+0000e540: 7473 5f63 6c29 203d 3d20 303a 0a20 2020  ts_cl) == 0:.   
+0000e550: 2020 2020 2020 2020 2020 2020 2072 6574               ret
+0000e560: 7572 6e20 4e6f 6e65 2c20 4e6f 6e65 0a20  urn None, None. 
+0000e570: 2020 2020 2020 2020 2020 2074 7279 3a0a             try:.
 0000e580: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e590: 6e70 2e6e 756d 7375 6d28 6e70 2e73 756d  np.numsum(np.sum
-0000e5a0: 286e 6569 6768 203c 206c 656e 286e 6569  (neigh < len(nei
-0000e5b0: 6768 292c 2061 7869 733d 3129 203e 2031  gh), axis=1) > 1
-0000e5c0: 3729 202f 0a20 2020 2020 2020 2020 2020  7) /.           
-0000e5d0: 2020 2020 2020 2020 2066 6c6f 6174 286c           float(l
-0000e5e0: 656e 2870 726f 6265 5f70 6f69 6e74 7329  en(probe_points)
-0000e5f0: 290a 2020 2020 2020 2020 2020 2020 290a  ).            ).
-0000e600: 2020 2020 2020 2020 2020 2020 6469 7374              dist
-0000e610: 616e 6365 735f 616c 6967 6e20 3d20 6469  ances_align = di
-0000e620: 7374 616e 6365 730a 2020 2020 2020 2020  stances.        
-0000e630: 2020 2020 6469 7374 616e 6365 735f 7365      distances_se
-0000e640: 6c20 3d20 6469 7374 616e 6365 735f 616c  l = distances_al
-0000e650: 6967 6e5b 0a20 2020 2020 2020 2020 2020  ign[.           
-0000e660: 2020 2020 206e 702e 7375 6d28 6e65 6967       np.sum(neig
-0000e670: 6820 3c20 6c65 6e28 6e65 6967 6829 2c20  h < len(neigh), 
-0000e680: 6178 6973 3d31 2920 3e20 3137 0a20 2020  axis=1) > 17.   
-0000e690: 2020 2020 2020 2020 205d 0a20 2020 2020           ].     
-0000e6a0: 2020 2020 2020 2064 6973 7461 6e63 6573         distances
-0000e6b0: 203d 2064 6973 7461 6e63 6573 5f73 656c   = distances_sel
-0000e6c0: 5b3a 5d0a 0a20 2020 2020 2020 206f 7665  [:]..        ove
-0000e6d0: 726c 6170 5f66 7265 7120 3d20 6e70 2e68  rlap_freq = np.h
-0000e6e0: 6973 746f 6772 616d 2864 6973 7461 6e63  istogram(distanc
-0000e6f0: 6573 2c20 6269 6e73 295b 305d 0a20 2020  es, bins)[0].   
-0000e700: 2020 2020 2074 6f74 616c 203d 2074 6f74       total = tot
-0000e710: 616c 5f65 7874 0a20 2020 2020 2020 2063  al_ext.        c
-0000e720: 756d 756c 5f66 7265 7120 3d20 302e 300a  umul_freq = 0.0.
-0000e730: 2020 2020 2020 2020 656e 7465 7220 3d20          enter = 
-0000e740: 300a 2020 2020 2020 2020 7375 6d5f 7363  0.        sum_sc
-0000e750: 203d 2030 2e30 0a20 2020 2020 2020 2066   = 0.0.        f
-0000e760: 6f72 2069 2069 6e20 7261 6e67 6528 6c65  or i in range(le
-0000e770: 6e28 6f76 6572 6c61 705f 6672 6571 2929  n(overlap_freq))
-0000e780: 3a0a 2020 2020 2020 2020 2020 2020 7720  :.            w 
-0000e790: 3d20 6c65 6e28 6f76 6572 6c61 705f 6672  = len(overlap_fr
-0000e7a0: 6571 2920 2d20 2869 290a 2020 2020 2020  eq) - (i).      
-0000e7b0: 2020 2020 2020 7472 793a 0a20 2020 2020        try:.     
-0000e7c0: 2020 2020 2020 2020 2020 2063 756d 756c             cumul
-0000e7d0: 5f66 7265 7120 2b3d 206f 7665 726c 6170  _freq += overlap
-0000e7e0: 5f66 7265 715b 695d 0a20 2020 2020 2020  _freq[i].       
-0000e7f0: 2020 2020 2065 7863 6570 7420 496e 6465       except Inde
-0000e800: 7845 7272 6f72 3a0a 2020 2020 2020 2020  xError:.        
-0000e810: 2020 2020 2020 2020 7061 7373 0a20 2020          pass.   
-0000e820: 2020 2020 2020 2020 2074 7279 3a0a 2020           try:.  
-0000e830: 2020 2020 2020 2020 2020 2020 2020 7065                pe
-0000e840: 7263 5f65 7175 6976 203d 2066 6c6f 6174  rc_equiv = float
-0000e850: 2863 756d 756c 5f66 7265 7129 202f 206e  (cumul_freq) / n
-0000e860: 756d 5f64 6973 7461 6e63 6573 0a20 2020  um_distances.   
-0000e870: 2020 2020 2020 2020 2065 7863 6570 7420           except 
-0000e880: 5a65 726f 4469 7669 7369 6f6e 4572 726f  ZeroDivisionErro
-0000e890: 723a 0a20 2020 2020 2020 2020 2020 2020  r:.             
-0000e8a0: 2020 2070 7269 6e74 2827 4469 7374 616e     print('Distan
-0000e8b0: 6365 2077 6569 6768 7469 6e67 2066 6169  ce weighting fai
-0000e8c0: 6c65 6421 212e 2043 6865 636b 2073 7572  led!!. Check sur
-0000e8d0: 6661 6365 2064 6566 696e 6564 2729 0a20  face defined'). 
-0000e8e0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-0000e8f0: 6574 7572 6e20 4e6f 6e65 2c20 4e6f 6e65  eturn None, None
-0000e900: 0a20 2020 2020 2020 2020 2020 2073 756d  .            sum
-0000e910: 5f73 6320 3d20 7375 6d5f 7363 202b 2028  _sc = sum_sc + (
-0000e920: 2877 2920 2a20 7065 7263 5f65 7175 6976  (w) * perc_equiv
-0000e930: 290a 2020 2020 2020 2020 2020 2020 746f  ).            to
-0000e940: 7461 6c20 2b3d 2028 7729 0a20 2020 2020  tal += (w).     
-0000e950: 2020 2020 2020 2065 6e74 6572 203d 2031         enter = 1
-0000e960: 0a20 2020 2020 2020 2073 636f 7265 203d  .        score =
-0000e970: 2066 6c6f 6174 2873 756d 5f73 6329 202f   float(sum_sc) /
-0000e980: 2074 6f74 616c 0a20 2020 2020 2020 2069   total.        i
-0000e990: 6620 636c 3a20 2023 206e 6f71 613a 4638  f cl:  # noqa:F8
-0000e9a0: 3231 0a20 2020 2020 2020 2020 2020 2069  21.            i
-0000e9b0: 6620 656e 7465 7220 3d3d 2031 3a0a 2020  f enter == 1:.  
-0000e9c0: 2020 2020 2020 2020 2020 2020 2020 6966                if
-0000e9d0: 206c 656e 2864 6973 7461 6e63 6573 5f73   len(distances_s
-0000e9e0: 656c 2920 3d3d 2030 2e30 3a0a 2020 2020  el) == 0.0:.    
-0000e9f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ea00: 7265 7475 726e 2030 2e30 0a20 2020 2020  return 0.0.     
-0000ea10: 2020 2020 2020 2020 2020 2069 6620 6e70             if np
-0000ea20: 2e6d 6561 6e28 6469 7374 616e 6365 735f  .mean(distances_
-0000ea30: 7365 6c29 203d 3d20 302e 303a 0a20 2020  sel) == 0.0:.   
-0000ea40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ea50: 2072 6574 7572 6e20 302e 300a 2020 2020   return 0.0.    
-0000ea60: 2020 2020 2020 2020 2020 2020 6966 2063              if c
-0000ea70: 6c5f 7765 6967 6874 203d 3d20 302e 303a  l_weight == 0.0:
-0000ea80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000ea90: 2020 2020 2072 6574 7572 6e20 302e 300a       return 0.0.
-0000eaa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000eab0: 7265 7475 726e 2073 636f 7265 0a20 2020  return score.   
-0000eac0: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
-0000ead0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-0000eae0: 6574 7572 6e20 4e6f 6e65 2c20 4e6f 6e65  eturn None, None
-0000eaf0: 0a20 2020 2020 2020 2069 6620 656e 7465  .        if ente
-0000eb00: 7220 3d3d 2031 3a0a 2020 2020 2020 2020  r == 1:.        
-0000eb10: 2020 2020 6966 206e 702e 6d65 616e 2864      if np.mean(d
-0000eb20: 6973 7461 6e63 6573 2920 3c3d 2030 2e30  istances) <= 0.0
-0000eb30: 353a 0a20 2020 2020 2020 2020 2020 2020  5:.             
-0000eb40: 2020 2072 6574 7572 6e20 312e 300a 2020     return 1.0.  
-0000eb50: 2020 2020 2020 2020 2020 6966 206e 702e            if np.
-0000eb60: 6d65 616e 2864 6973 7461 6e63 6573 2920  mean(distances) 
-0000eb70: 3d3d 2030 2e30 3a0a 2020 2020 2020 2020  == 0.0:.        
-0000eb80: 2020 2020 2020 2020 7265 7475 726e 2031          return 1
-0000eb90: 2e30 0a20 2020 2020 2020 2020 2020 2072  .0.            r
-0000eba0: 6574 7572 6e20 7363 6f72 650a 2020 2020  eturn score.    
-0000ebb0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-0000ebc0: 2020 2020 2020 7265 7475 726e 204e 6f6e        return Non
-0000ebd0: 652c 204e 6f6e 650a 0a20 2020 2064 6566  e, None..    def
-0000ebe0: 2065 6e76 656c 6f70 655f 7363 6f72 6528   envelope_score(
-0000ebf0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-0000ec00: 662c 0a20 2020 2020 2020 2020 2020 206d  f,.            m
-0000ec10: 6170 5f74 6172 6765 742c 0a20 2020 2020  ap_target,.     
-0000ec20: 2020 2020 2020 2070 7269 6d61 7279 5f62         primary_b
-0000ec30: 6f75 6e64 6172 792c 0a20 2020 2020 2020  oundary,.       
-0000ec40: 2020 2020 2073 7472 7563 7475 7265 5f69       structure_i
-0000ec50: 6e73 7461 6e63 652c 0a20 2020 2020 2020  nstance,.       
-0000ec60: 2020 2020 206e 6f72 6d3d 5472 7565 2c0a       norm=True,.
-0000ec70: 2020 2020 2020 2020 2020 2020 293a 0a20              ):. 
-0000ec80: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
-0000ec90: 2020 2043 616c 6375 6c61 7465 2074 6865     Calculate the
-0000eca0: 2065 6e76 656c 6f70 6520 7363 6f72 6520   envelope score 
-0000ecb0: 6265 7477 6565 6e20 6120 7461 7267 6574  between a target
-0000ecc0: 204d 6170 2061 6e64 2061 2053 7472 7563   Map and a Struc
-0000ecd0: 7475 7265 0a20 2020 2020 2020 2049 6e73  ture.        Ins
-0000ece0: 7461 6e63 6573 2e0a 0a20 2020 2020 2020  tances...       
-0000ecf0: 2041 7267 756d 656e 7473 3a0a 2020 2020   Arguments:.    
-0000ed00: 2020 2020 2020 2020 6d61 705f 7461 7267          map_targ
-0000ed10: 6574 3a20 5461 7267 6574 204d 6170 2049  et: Target Map I
-0000ed20: 6e73 7461 6e63 652e 0a20 2020 2020 2020  nstance..       
-0000ed30: 2020 2020 2070 7269 6d61 7279 5f62 6f75       primary_bou
-0000ed40: 6e64 6172 793a 2056 616c 7565 2073 7065  ndary: Value spe
-0000ed50: 6369 6669 6564 2069 7320 6361 6c63 756c  cified is calcul
-0000ed60: 6174 6564 2077 6974 680a 2020 2020 2020  ated with.      
-0000ed70: 2020 2020 2020 2020 2020 7072 696d 6172            primar
-0000ed80: 795f 626f 756e 6461 7279 206f 6620 7468  y_boundary of th
-0000ed90: 6520 6d61 7020 6f62 6a65 6374 2e0a 2020  e map object..  
-0000eda0: 2020 2020 2020 2020 2020 7374 7275 6374            struct
-0000edb0: 7572 655f 696e 7374 616e 6365 3a20 4d6f  ure_instance: Mo
-0000edc0: 6465 6c20 7374 7275 6374 7572 6520 696e  del structure in
-0000edd0: 7374 616e 6365 2e0a 2020 2020 2020 2020  stance..        
-0000ede0: 2020 2020 6e6f 726d 3a20 4e6f 726d 616c      norm: Normal
-0000edf0: 6973 6520 7468 6520 7363 6f72 6520 6265  ise the score be
-0000ee00: 7477 6565 6e20 3020 616e 6420 3120 6966  tween 0 and 1 if
-0000ee10: 2054 7275 652e 0a0a 2020 2020 2020 2020   True...        
-0000ee20: 5265 7475 726e 733a 0a20 2020 2020 2020  Returns:.       
-0000ee30: 2020 2020 2045 6e76 656c 6f70 6520 7363       Envelope sc
-0000ee40: 6f72 652c 206e 6f72 6d61 6c69 7365 6420  ore, normalised 
-0000ee50: 6265 7477 6565 6e20 3020 616e 6420 3120  between 0 and 1 
-0000ee60: 6966 206e 6f72 6d20 6973 2054 7275 650a  if norm is True.
-0000ee70: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
-0000ee80: 2020 2020 2062 696e 4d61 7020 3d20 6d61       binMap = ma
-0000ee90: 705f 7461 7267 6574 2e6d 616b 655f 6269  p_target.make_bi
-0000eea0: 6e5f 6d61 7028 7072 696d 6172 795f 626f  n_map(primary_bo
-0000eeb0: 756e 6461 7279 290a 2020 2020 2020 2020  undary).        
-0000eec0: 6d61 785f 7363 6f72 6520 3d20 666c 6f61  max_score = floa
-0000eed0: 7428 2d32 202a 206e 702e 7375 6d28 6269  t(-2 * np.sum(bi
-0000eee0: 6e4d 6170 2e66 756c 6c4d 6170 2929 0a20  nMap.fullMap)). 
-0000eef0: 2020 2020 2020 206d 696e 5f73 636f 7265         min_score
-0000ef00: 203d 2066 6c6f 6174 286e 702e 7375 6d28   = float(np.sum(
-0000ef10: 6269 6e4d 6170 2e66 756c 6c4d 6170 292d  binMap.fullMap)-
-0000ef20: 3220 2a20 6e70 2e73 756d 2862 696e 4d61  2 * np.sum(binMa
-0000ef30: 702e 6675 6c6c 4d61 702b 3129 290a 0a20  p.fullMap+1)).. 
-0000ef40: 2020 2020 2020 2062 6c75 7272 6572 203d         blurrer =
-0000ef50: 2053 7472 7563 7475 7265 426c 7572 7265   StructureBlurre
-0000ef60: 7228 290a 2020 2020 2020 2020 7374 7275  r().        stru
-0000ef70: 6374 5f62 696e 4d61 7020 3d20 626c 7572  ct_binMap = blur
-0000ef80: 7265 722e 6d61 6b65 5f61 746f 6d5f 6f76  rer.make_atom_ov
-0000ef90: 6572 6c61 795f 6d61 7031 280a 2020 2020  erlay_map1(.    
-0000efa0: 2020 2020 2020 2020 6d61 705f 7461 7267          map_targ
-0000efb0: 6574 2c0a 2020 2020 2020 2020 2020 2020  et,.            
-0000efc0: 7374 7275 6374 7572 655f 696e 7374 616e  structure_instan
-0000efd0: 6365 0a20 2020 2020 2020 2029 0a20 2020  ce.        ).   
-0000efe0: 2020 2020 2067 7269 6420 3d20 7374 7275       grid = stru
-0000eff0: 6374 5f62 696e 4d61 702e 6765 745f 706f  ct_binMap.get_po
-0000f000: 7328 302e 392c 2031 2e31 290a 2020 2020  s(0.9, 1.1).    
-0000f010: 2020 2020 666f 7220 782c 2079 2c20 7a20      for x, y, z 
-0000f020: 696e 2067 7269 643a 0a20 2020 2020 2020  in grid:.       
-0000f030: 2020 2020 2067 203d 2062 696e 4d61 705b       g = binMap[
-0000f040: 7a5d 5b79 5d5b 785d 0a20 2020 2020 2020  z][y][x].       
-0000f050: 2020 2020 2069 6620 6720 3d3d 202d 313a       if g == -1:
-0000f060: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000f070: 2062 696e 4d61 705b 7a5d 5b79 5d5b 785d   binMap[z][y][x]
-0000f080: 203d 2032 0a20 2020 2020 2020 2020 2020   = 2.           
-0000f090: 2065 6c69 6620 6720 3d3d 2030 3a0a 2020   elif g == 0:.  
-0000f0a0: 2020 2020 2020 2020 2020 2020 2020 6269                bi
-0000f0b0: 6e4d 6170 5b7a 5d5b 795d 5b78 5d20 3d20  nMap[z][y][x] = 
-0000f0c0: 2d32 0a20 2020 2020 2020 2073 636f 7265  -2.        score
-0000f0d0: 203d 2066 6c6f 6174 286e 702e 7375 6d28   = float(np.sum(
-0000f0e0: 6269 6e4d 6170 2e66 756c 6c4d 6170 2929  binMap.fullMap))
-0000f0f0: 0a20 2020 2020 2020 2069 6620 6e6f 726d  .        if norm
-0000f100: 3a0a 2020 2020 2020 2020 2020 2020 6e6f  :.            no
-0000f110: 726d 5f73 636f 7265 203d 2066 6c6f 6174  rm_score = float
-0000f120: 2828 7363 6f72 652d 6d69 6e5f 7363 6f72  ((score-min_scor
-0000f130: 6529 202f 2028 6d61 785f 7363 6f72 652d  e) / (max_score-
-0000f140: 6d69 6e5f 7363 6f72 6529 290a 2020 2020  min_score)).    
-0000f150: 2020 2020 2020 2020 7265 7475 726e 206e          return n
-0000f160: 6f72 6d5f 7363 6f72 650a 2020 2020 2020  orm_score.      
-0000f170: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-0000f180: 2020 2020 7265 7475 726e 2073 636f 7265      return score
-0000f190: 0a0a 2020 2020 6465 6620 656e 7665 6c6f  ..    def envelo
-0000f1a0: 7065 5f73 636f 7265 5f6d 6170 280a 2020  pe_score_map(.  
-0000f1b0: 2020 2020 2020 2020 2020 7365 6c66 2c0a            self,.
-0000f1c0: 2020 2020 2020 2020 2020 2020 6d61 705f              map_
-0000f1d0: 7461 7267 6574 2c0a 2020 2020 2020 2020  target,.        
-0000f1e0: 2020 2020 6d61 705f 7072 6f62 652c 0a20      map_probe,. 
-0000f1f0: 2020 2020 2020 2020 2020 206d 6170 5f74             map_t
-0000f200: 6172 6765 745f 7468 7265 7368 6f6c 643d  arget_threshold=
-0000f210: 302c 0a20 2020 2020 2020 2020 2020 206d  0,.            m
-0000f220: 6170 5f70 726f 6265 5f74 6872 6573 686f  ap_probe_thresho
-0000f230: 6c64 3d30 2c0a 2020 2020 2020 2020 2020  ld=0,.          
-0000f240: 2020 6e6f 726d 3d54 7275 652c 0a20 2020    norm=True,.   
-0000f250: 2029 3a0a 2020 2020 2020 2020 2222 2243   ):.        """C
-0000f260: 616c 6375 6c61 7465 2074 6865 2065 6e76  alculate the env
-0000f270: 656c 6f70 6520 7363 6f72 6520 6265 7477  elope score betw
-0000f280: 6565 6e20 7477 6f20 6d61 7073 0a0a 2020  een two maps..  
-0000f290: 2020 2020 2020 4172 6775 6d65 6e74 733a        Arguments:
-0000f2a0: 0a20 2020 2020 2020 2020 2020 206d 6170  .            map
-0000f2b0: 5f74 6172 6765 742c 206d 6170 5f70 726f  _target, map_pro
-0000f2c0: 6265 3a20 4d61 7020 696e 7374 616e 6365  be: Map instance
-0000f2d0: 2074 6f20 636f 6d70 6172 652e 0a20 2020   to compare..   
-0000f2e0: 2020 2020 2020 2020 206d 6170 5f74 6172           map_tar
-0000f2f0: 6765 745f 7468 7265 7368 6f6c 642c 206d  get_threshold, m
-0000f300: 6170 5f70 726f 6265 5f74 6872 6573 686f  ap_probe_thresho
-0000f310: 6c64 3a0a 2020 2020 2020 2020 2020 2020  ld:.            
-0000f320: 2020 2020 4d61 7020 7468 7265 7368 6f6c      Map threshol
-0000f330: 6420 7468 6174 2064 6566 696e 6573 2074  d that defines t
-0000f340: 6865 2065 6e76 656c 6f70 652c 206f 7220  he envelope, or 
-0000f350: 7375 7266 6163 652c 206f 6620 7468 650a  surface, of the.
-0000f360: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f370: 6d61 702e 2057 696c 6c20 6265 2061 7574  map. Will be aut
-0000f380: 6f6d 6174 6963 616c 6c79 2063 616c 6375  omatically calcu
-0000f390: 6c61 7465 6420 7573 696e 670a 2020 2020  lated using.    
-0000f3a0: 2020 2020 2020 2020 2020 2020 3a6d 6574              :met
-0000f3b0: 683a 6073 656c 662e 6361 6c63 756c 6174  h:`self.calculat
-0000f3c0: 655f 6d61 705f 7468 7265 7368 6f6c 6420  e_map_threshold 
-0000f3d0: 3c54 454d 5079 2e70 726f 7465 696e 2e73  <TEMPy.protein.s
-0000f3e0: 636f 7269 6e67 5f66 756e 6374 696f 6e73  coring_functions
-0000f3f0: 2e53 636f 7269 6e67 4675 6e63 7469 6f6e  .ScoringFunction
-0000f400: 732e 6361 6c63 756c 6174 655f 6d61 705f  s.calculate_map_
-0000f410: 7468 7265 7368 6f6c 643e 600a 2020 2020  threshold>`.    
-0000f420: 2020 2020 2020 2020 2020 2020 6966 206e              if n
-0000f430: 6f74 2073 7065 6369 6669 6564 2e0a 2020  ot specified..  
-0000f440: 2020 2020 2020 2020 2020 6e6f 726d 3a20            norm: 
-0000f450: 4e6f 726d 616c 6973 6520 7468 6520 7363  Normalise the sc
-0000f460: 6f72 6520 6265 7477 6565 6e20 3020 616e  ore between 0 an
-0000f470: 6420 3120 6966 2054 7275 652e 0a0a 2020  d 1 if True...  
-0000f480: 2020 2020 2020 5265 7475 726e 733a 0a20        Returns:. 
-0000f490: 2020 2020 2020 2020 2020 2045 6e76 656c             Envel
-0000f4a0: 6f70 6520 7363 6f72 652c 206e 6f72 6d61  ope score, norma
-0000f4b0: 6c69 7365 6420 6265 7477 6565 6e20 3020  lised between 0 
-0000f4c0: 616e 6420 3120 6966 206e 6f72 6d20 6973  and 1 if norm is
-0000f4d0: 2054 7275 650a 2020 2020 2020 2020 2222   True.        ""
-0000f4e0: 220a 2020 2020 2020 2020 6966 2073 656c  ".        if sel
-0000f4f0: 662e 6d61 7043 6f6d 7061 7269 736f 6e28  f.mapComparison(
-0000f500: 6d61 705f 7461 7267 6574 2c20 6d61 705f  map_target, map_
-0000f510: 7072 6f62 6529 3a0a 2020 2020 2020 2020  probe):.        
-0000f520: 2020 2020 6966 206d 6170 5f74 6172 6765      if map_targe
-0000f530: 745f 7468 7265 7368 6f6c 6420 3d3d 2030  t_threshold == 0
-0000f540: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0000f550: 2020 6d61 705f 7461 7267 6574 5f74 6872    map_target_thr
-0000f560: 6573 686f 6c64 203d 2073 656c 662e 6361  eshold = self.ca
-0000f570: 6c63 756c 6174 655f 6d61 705f 7468 7265  lculate_map_thre
-0000f580: 7368 6f6c 6428 6d61 705f 7461 7267 6574  shold(map_target
-0000f590: 290a 2020 2020 2020 2020 2020 2020 6966  ).            if
-0000f5a0: 206d 6170 5f70 726f 6265 5f74 6872 6573   map_probe_thres
-0000f5b0: 686f 6c64 203d 3d20 303a 0a20 2020 2020  hold == 0:.     
-0000f5c0: 2020 2020 2020 2020 2020 206d 6170 5f70             map_p
-0000f5d0: 726f 6265 5f74 6872 6573 686f 6c64 203d  robe_threshold =
-0000f5e0: 2073 656c 662e 6361 6c63 756c 6174 655f   self.calculate_
-0000f5f0: 6d61 705f 7468 7265 7368 6f6c 6428 6d61  map_threshold(ma
-0000f600: 705f 7072 6f62 6529 0a0a 2020 2020 2020  p_probe)..      
-0000f610: 2020 6269 6e4d 6170 203d 206d 6170 5f74    binMap = map_t
-0000f620: 6172 6765 742e 6d61 6b65 5f62 696e 5f6d  arget.make_bin_m
-0000f630: 6170 286d 6170 5f74 6172 6765 745f 7468  ap(map_target_th
-0000f640: 7265 7368 6f6c 6429 0a20 2020 2020 2020  reshold).       
-0000f650: 206d 6178 5f73 636f 7265 203d 2066 6c6f   max_score = flo
-0000f660: 6174 282d 3220 2a20 6e70 2e73 756d 2862  at(-2 * np.sum(b
-0000f670: 696e 4d61 702e 6675 6c6c 4d61 7029 290a  inMap.fullMap)).
-0000f680: 2020 2020 2020 2020 6d69 6e5f 7363 6f72          min_scor
-0000f690: 6520 3d20 666c 6f61 7428 0a20 2020 2020  e = float(.     
-0000f6a0: 2020 2020 2020 206e 702e 7375 6d28 6269         np.sum(bi
-0000f6b0: 6e4d 6170 2e66 756c 6c4d 6170 292d 3220  nMap.fullMap)-2 
-0000f6c0: 2a20 6e70 2e73 756d 2862 696e 4d61 702e  * np.sum(binMap.
-0000f6d0: 6675 6c6c 4d61 7020 2b20 3129 0a20 2020  fullMap + 1).   
-0000f6e0: 2020 2020 2029 0a20 2020 2020 2020 2073       ).        s
-0000f6f0: 7472 7563 745f 6269 6e4d 6170 203d 206d  truct_binMap = m
-0000f700: 6170 5f70 726f 6265 2e6d 616b 655f 6269  ap_probe.make_bi
-0000f710: 6e5f 6d61 7028 6d61 705f 7072 6f62 655f  n_map(map_probe_
-0000f720: 7468 7265 7368 6f6c 6429 0a20 2020 2020  threshold).     
-0000f730: 2020 206e 6577 4d61 7020 3d20 6269 6e4d     newMap = binM
-0000f740: 6170 2e66 756c 6c4d 6170 202b 2032 202a  ap.fullMap + 2 *
-0000f750: 2073 7472 7563 745f 6269 6e4d 6170 2e66   struct_binMap.f
-0000f760: 756c 6c4d 6170 0a20 2020 2020 2020 2068  ullMap.        h
-0000f770: 6973 745f 6172 7261 7920 3d20 6e70 2e68  ist_array = np.h
-0000f780: 6973 746f 6772 616d 286e 6577 4d61 702c  istogram(newMap,
-0000f790: 2034 290a 2020 2020 2020 2020 7363 6f72   4).        scor
-0000f7a0: 6520 3d20 280a 2020 2020 2020 2020 2020  e = (.          
-0000f7b0: 2020 2020 2020 3220 2a0a 2020 2020 2020        2 *.      
-0000f7c0: 2020 2020 2020 2020 2020 6869 7374 5f61            hist_a
-0000f7d0: 7272 6179 5b30 5d5b 305d 202d 0a20 2020  rray[0][0] -.   
-0000f7e0: 2020 2020 2020 2020 2020 2020 2028 3220               (2 
-0000f7f0: 2a20 2868 6973 745f 6172 7261 795b 305d  * (hist_array[0]
-0000f800: 5b31 5d29 2920 2d0a 2020 2020 2020 2020  [1])) -.        
-0000f810: 2020 2020 2020 2020 2868 6973 745f 6172          (hist_ar
-0000f820: 7261 795b 305d 5b32 5d29 0a20 2020 2020  ray[0][2]).     
-0000f830: 2020 2029 0a20 2020 2020 2020 2069 6620     ).        if 
-0000f840: 6e6f 726d 3a0a 2020 2020 2020 2020 2020  norm:.          
-0000f850: 2020 6e6f 726d 5f73 636f 7265 203d 2066    norm_score = f
-0000f860: 6c6f 6174 2828 7363 6f72 6520 2d20 6d69  loat((score - mi
-0000f870: 6e5f 7363 6f72 6529 2920 2f20 286d 6178  n_score)) / (max
-0000f880: 5f73 636f 7265 202d 206d 696e 5f73 636f  _score - min_sco
-0000f890: 7265 290a 2020 2020 2020 2020 2020 2020  re).            
-0000f8a0: 7265 7475 726e 206e 6f72 6d5f 7363 6f72  return norm_scor
-0000f8b0: 650a 2020 2020 2020 2020 656c 7365 3a0a  e.        else:.
-0000f8c0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-0000f8d0: 726e 2073 636f 7265 0a0a 2020 2020 6465  rn score..    de
-0000f8e0: 6620 5f70 6572 6365 6e74 5f6f 7665 726c  f _percent_overl
-0000f8f0: 6170 280a 2020 2020 2020 2020 2020 2020  ap(.            
-0000f900: 7365 6c66 2c0a 2020 2020 2020 2020 2020  self,.          
-0000f910: 2020 6d61 705f 7461 7267 6574 2c0a 2020    map_target,.  
-0000f920: 2020 2020 2020 2020 2020 6d61 705f 7072            map_pr
-0000f930: 6f62 652c 0a20 2020 2020 2020 2020 2020  obe,.           
-0000f940: 206d 6170 5f74 6172 6765 745f 7468 7265   map_target_thre
-0000f950: 7368 6f6c 642c 0a20 2020 2020 2020 2020  shold,.         
-0000f960: 2020 206d 6170 5f70 726f 6265 5f74 6872     map_probe_thr
-0000f970: 6573 686f 6c64 2c0a 2020 2020 2020 2020  eshold,.        
-0000f980: 2020 2020 666c 6167 7369 7a65 3d30 2c0a      flagsize=0,.
-0000f990: 2020 2020 293a 0a20 2020 2020 2020 2022      ):.        "
-0000f9a0: 2222 4361 6c63 756c 6174 6520 7468 6520  ""Calculate the 
-0000f9b0: 6672 6163 7469 6f6e 206f 6620 6f76 6572  fraction of over
-0000f9c0: 6c61 7020 6265 7477 6565 6e20 7477 6f20  lap between two 
-0000f9d0: 6d61 7020 6772 6964 732e 0a0a 2020 2020  map grids...    
-0000f9e0: 2020 2020 4172 6775 6d65 6e74 733a 0a20      Arguments:. 
-0000f9f0: 2020 2020 2020 2020 2020 206d 6170 5f74             map_t
-0000fa00: 6172 6765 742c 206d 6170 5f70 726f 6265  arget, map_probe
-0000fa10: 3a20 4d61 7020 696e 7374 616e 6365 2074  : Map instance t
-0000fa20: 6f20 636f 6d70 6172 652e 0a20 2020 2020  o compare..     
-0000fa30: 2020 2020 2020 206d 6170 5f74 6172 6765         map_targe
-0000fa40: 745f 7468 7265 7368 6f6c 642c 206d 6170  t_threshold, map
-0000fa50: 5f70 726f 6265 5f74 6872 6573 686f 6c64  _probe_threshold
-0000fa60: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0000fa70: 2020 6d61 7020 636f 6e74 6f75 7220 7468    map contour th
-0000fa80: 7265 7368 6f6c 6473 2066 6f72 206d 6170  resholds for map
-0000fa90: 5f74 6172 6765 7420 616e 6420 6d61 705f  _target and map_
-0000faa0: 7072 6f62 652e 0a20 2020 2020 2020 2052  probe..        R
-0000fab0: 6574 7572 6e3a 0a20 2020 2020 2020 2020  eturn:.         
-0000fac0: 2020 2050 6572 6365 6e74 206f 7665 726c     Percent overl
-0000fad0: 6170 2077 6974 6820 7265 7370 6563 7420  ap with respect 
-0000fae0: 746f 2073 6d61 6c6c 6572 2067 7269 640a  to smaller grid.
-0000faf0: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
-0000fb00: 2020 2020 6966 2073 656c 662e 6d61 7043      if self.mapC
-0000fb10: 6f6d 7061 7269 736f 6e28 6d61 705f 7461  omparison(map_ta
-0000fb20: 7267 6574 2c20 6d61 705f 7072 6f62 6529  rget, map_probe)
-0000fb30: 3a0a 2020 2020 2020 2020 2020 2020 6269  :.            bi
-0000fb40: 6e6d 6170 3120 3d20 6d61 705f 7461 7267  nmap1 = map_targ
-0000fb50: 6574 2e66 756c 6c4d 6170 203e 2066 6c6f  et.fullMap > flo
-0000fb60: 6174 286d 6170 5f74 6172 6765 745f 7468  at(map_target_th
-0000fb70: 7265 7368 6f6c 6429 0a20 2020 2020 2020  reshold).       
-0000fb80: 2020 2020 2062 696e 6d61 7032 203d 206d       binmap2 = m
-0000fb90: 6170 5f70 726f 6265 2e66 756c 6c4d 6170  ap_probe.fullMap
-0000fba0: 203e 2066 6c6f 6174 286d 6170 5f70 726f   > float(map_pro
-0000fbb0: 6265 5f74 6872 6573 686f 6c64 290a 2020  be_threshold).  
-0000fbc0: 2020 2020 2020 2020 2020 6d69 6e69 6d20            minim 
-0000fbd0: 3d20 6c65 6e28 6d61 705f 7461 7267 6574  = len(map_target
-0000fbe0: 2e66 756c 6c4d 6170 5b62 696e 6d61 7031  .fullMap[binmap1
-0000fbf0: 5d29 0a20 2020 2020 2020 2020 2020 2069  ]).            i
-0000fc00: 6620 6c65 6e28 6d61 705f 7072 6f62 652e  f len(map_probe.
-0000fc10: 6675 6c6c 4d61 705b 6269 6e6d 6170 325d  fullMap[binmap2]
-0000fc20: 2920 3c20 6d69 6e69 6d3a 0a20 2020 2020  ) < minim:.     
-0000fc30: 2020 2020 2020 2020 2020 206d 696e 696d             minim
-0000fc40: 203d 206c 656e 286d 6170 5f70 726f 6265   = len(map_probe
-0000fc50: 2e66 756c 6c4d 6170 5b62 696e 6d61 7032  .fullMap[binmap2
-0000fc60: 5d29 0a20 2020 2020 2020 2020 2020 206d  ]).            m
-0000fc70: 6173 6b6d 6170 203d 2028 6269 6e6d 6170  askmap = (binmap
-0000fc80: 3120 2a20 6269 6e6d 6170 3229 203e 2030  1 * binmap2) > 0
-0000fc90: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-0000fca0: 666c 6167 7369 7a65 203d 3d20 313a 0a20  flagsize == 1:. 
-0000fcb0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-0000fcc0: 6574 7572 6e20 6e70 2e73 756d 286d 6173  eturn np.sum(mas
-0000fcd0: 6b6d 6170 292c 206e 702e 7375 6d28 6269  kmap), np.sum(bi
-0000fce0: 6e6d 6170 3129 2c20 6e70 2e73 756d 2862  nmap1), np.sum(b
-0000fcf0: 696e 6d61 7032 290a 2020 2020 2020 2020  inmap2).        
-0000fd00: 2020 2020 6966 206e 6f74 206d 696e 696d      if not minim
-0000fd10: 203d 3d20 302e 303a 0a20 2020 2020 2020   == 0.0:.       
-0000fd20: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-0000fd30: 666c 6f61 7428 6c65 6e28 6d61 705f 7461  float(len(map_ta
-0000fd40: 7267 6574 2e66 756c 6c4d 6170 5b6d 6173  rget.fullMap[mas
-0000fd50: 6b6d 6170 5d29 292f 6d69 6e69 6d0a 2020  kmap]))/minim.  
-0000fd60: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
-0000fd70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000fd80: 7072 696e 7428 2743 6865 636b 206d 6170  print('Check map
-0000fd90: 2063 6f6e 746f 7572 2121 2729 0a20 2020   contour!!').   
-0000fda0: 2020 2020 2020 2020 2020 2020 2072 6574               ret
-0000fdb0: 7572 6e20 302e 300a 2020 2020 2020 2020  urn 0.0.        
-0000fdc0: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-0000fdd0: 2020 7072 696e 7428 2740 4040 204d 6170    print('@@@ Map
-0000fde0: 7320 636f 756c 6420 6e6f 7420 6265 206d  s could not be m
-0000fdf0: 6174 6368 6564 2729 0a20 2020 2020 2020  atched').       
-0000fe00: 2020 2020 2072 6574 7572 6e20 2d31 2e30       return -1.0
-0000fe10: 0a0a 2020 2020 6465 6620 5343 4343 280a  ..    def SCCC(.
-0000fe20: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-0000fe30: 2c0a 2020 2020 2020 2020 2020 2020 6d61  ,.            ma
-0000fe40: 705f 7461 7267 6574 2c0a 2020 2020 2020  p_target,.      
-0000fe50: 2020 2020 2020 7265 736f 6c75 7469 6f6e        resolution
-0000fe60: 5f64 656e 734d 6170 2c0a 2020 2020 2020  _densMap,.      
-0000fe70: 2020 2020 2020 7369 676d 615f 6d61 702c        sigma_map,
-0000fe80: 0a20 2020 2020 2020 2020 2020 2073 7472  .            str
-0000fe90: 7563 7475 7265 5f69 6e73 7461 6e63 652c  ucture_instance,
-0000fea0: 0a20 2020 2020 2020 2020 2020 2072 6967  .            rig
-0000feb0: 6964 5f62 6f64 795f 7374 7275 6374 7572  id_body_structur
-0000fec0: 652c 0a20 2020 2020 2020 2020 2020 2077  e,.            w
-0000fed0: 7269 7465 3d46 616c 7365 2c0a 2020 2020  rite=False,.    
-0000fee0: 2020 2020 2020 2020 635f 6d6f 6465 3d46          c_mode=F
-0000fef0: 616c 7365 2c0a 2020 2020 293a 0a20 2020  alse,.    ):.   
-0000ff00: 2020 2020 2022 2222 4361 6c63 756c 6174       """Calculat
-0000ff10: 6520 6c6f 6361 6c20 6372 6f73 732d 636f  e local cross-co
-0000ff20: 7272 656c 6174 696f 6e20 666f 7220 6120  rrelation for a 
-0000ff30: 7365 676d 656e 7420 6f66 2061 2070 726f  segment of a pro
-0000ff40: 7465 696e 206d 6f64 656c 0a0a 2020 2020  tein model..    
-0000ff50: 2020 2020 5365 676d 656e 7473 2061 7265      Segments are
-0000ff60: 2064 6566 696e 6564 2075 7369 6e67 2061   defined using a
-0000ff70: 2072 6967 6964 2d62 6f64 7920 7374 7275   rigid-body stru
-0000ff80: 6374 7572 6520 696e 7374 616e 6365 2c20  cture instance, 
-0000ff90: 7768 6963 6820 6361 6e0a 2020 2020 2020  which can.      
-0000ffa0: 2020 6265 2067 656e 6572 6174 6564 2075    be generated u
-0000ffb0: 7369 6e67 2060 5249 4246 494e 4420 3c68  sing `RIBFIND <h
-0000ffc0: 7474 7073 3a2f 2f72 6962 6669 6e64 2e69  ttps://ribfind.i
-0000ffd0: 736d 622e 6c6f 6e2e 6163 2e75 6b2f 3e60  smb.lon.ac.uk/>`
-0000ffe0: 5f2e 0a20 2020 2020 2020 2054 6865 2043  _..        The C
-0000fff0: 4343 2069 7320 6361 6c63 756c 6174 6564  CC is calculated
-00010000: 2075 7369 6e67 0a20 2020 2020 2020 203a   using.        :
-00010010: 6d65 7468 3a60 4343 435f 6d61 7020 3c54  meth:`CCC_map <T
-00010020: 454d 5079 2e70 726f 7465 696e 2e73 636f  EMPy.protein.sco
-00010030: 7269 6e67 5f66 756e 6374 696f 6e73 2e53  ring_functions.S
-00010040: 636f 7269 6e67 4675 6e63 7469 6f6e 732e  coringFunctions.
-00010050: 4343 435f 6d61 703e 602e 0a0a 2020 2020  CCC_map>`...    
-00010060: 2020 2020 496d 706c 656d 656e 7461 7469      Implementati
-00010070: 6f6e 2064 6973 6375 7373 6564 2069 6e20  on discussed in 
-00010080: 6d6f 7265 2064 6574 6169 6c20 6174 2074  more detail at t
-00010090: 6865 2066 6f6c 6c6f 7769 6e67 2072 6566  he following ref
-000100a0: 6572 656e 6365 3a0a 2020 2020 2020 2020  erence:.        
-000100b0: 2020 2020 2a20 6050 616e 6475 7261 6e67      * `Pandurang
-000100c0: 616e 2065 7420 616c 2e2c 204a 2053 7472  an et al., J Str
-000100d0: 7563 7420 4269 6f6c 2e20 3230 3133 2044  uct Biol. 2013 D
-000100e0: 6563 2031 3220 3c68 7474 7073 3a2f 2f77  ec 12 <https://w
-000100f0: 7777 2e6e 6362 692e 6e6c 6d2e 6e69 682e  ww.ncbi.nlm.nih.
-00010100: 676f 762f 706d 632f 6172 7469 636c 6573  gov/pmc/articles
-00010110: 2f50 4d43 3339 3838 3932 322f 3e60 5f0a  /PMC3988922/>`_.
-00010120: 0a20 2020 2020 2020 2041 7267 733a 0a20  .        Args:. 
-00010130: 2020 2020 2020 2020 2020 206d 6170 5f74             map_t
-00010140: 6172 6765 743a 204d 6170 2049 6e73 7461  arget: Map Insta
-00010150: 6e63 652e 0a20 2020 2020 2020 2020 2020  nce..           
-00010160: 2072 6573 6f6c 7574 696f 6e5f 6465 6e73   resolution_dens
-00010170: 4d61 703a 2052 6573 6f6c 7574 696f 6e20  Map: Resolution 
-00010180: 6f66 2074 6865 2069 6e70 7574 206d 6170  of the input map
-00010190: 2e0a 2020 2020 2020 2020 2020 2020 7369  ..            si
-000101a0: 676d 615f 6d61 703a 2050 6172 616d 6574  gma_map: Paramet
-000101b0: 6572 206e 6565 6420 666f 7220 5374 7275  er need for Stru
-000101c0: 6374 7572 6520 426c 7572 7265 722e 2046  cture Blurrer. F
-000101d0: 756c 6c20 6578 706c 616e 6174 696f 6e0a  ull explanation.
-000101e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000101f0: 3a72 6566 3a60 6865 7265 3c4e 6f74 6520  :ref:`here<Note 
-00010200: 6f6e 2072 6561 6c20 7370 6163 6520 626c  on real space bl
-00010210: 7572 7269 6e67 3a3e 600a 2020 2020 2020  urring:>`.      
-00010220: 2020 2020 2020 7374 7275 6374 7572 655f        structure_
-00010230: 696e 7374 616e 6365 3a20 5374 7275 6374  instance: Struct
-00010240: 7572 6520 696e 7374 616e 6365 2074 6f20  ure instance to 
-00010250: 636f 6d70 6172 650a 2020 2020 2020 2020  compare.        
-00010260: 2020 2020 7269 6769 645f 626f 6479 5f73      rigid_body_s
-00010270: 7472 7563 7475 7265 3a20 5269 6769 642d  tructure: Rigid-
-00010280: 626f 6479 2053 7472 7563 7475 7265 2069  body Structure i
-00010290: 6e73 7461 6e63 6520 7468 6174 2064 6566  nstance that def
-000102a0: 696e 6573 0a20 2020 2020 2020 2020 2020  ines.           
-000102b0: 2020 2020 2074 6865 2073 6567 6d65 6e74       the segment
-000102c0: 2e0a 2020 2020 2020 2020 2020 2020 7772  ..            wr
-000102d0: 6974 653a 2049 6620 5472 7565 2c20 6120  ite: If True, a 
-000102e0: 7374 7269 6e67 2069 7320 7265 7475 726e  string is return
-000102f0: 6564 2077 6974 6820 666f 726d 6174 203a  ed with format :
-00010300: 636f 6465 3a60 6627 5343 4343 2066 6f72  code:`f'SCCC for
-00010310: 2073 6567 6d65 6e74 207b 5343 4343 5f73   segment {SCCC_s
-00010320: 636f 7265 7d27 600a 2020 2020 2020 2020  core}'`.        
-00010330: 2020 2020 635f 6d6f 6465 3a20 4e6f 206c      c_mode: No l
-00010340: 6f6e 6765 7220 696e 2075 7365 0a20 2020  onger in use.   
-00010350: 2020 2020 2052 6574 7572 6e73 3a0a 2020       Returns:.  
-00010360: 2020 2020 2020 2020 2020 666c 6f61 7420            float 
-00010370: 6966 203a 636f 6465 3a60 7772 6974 653d  if :code:`write=
-00010380: 4661 6c73 6560 2c20 656c 7365 2073 7472  False`, else str
-00010390: 696e 673a 0a20 2020 2020 2020 2020 2020  ing:.           
-000103a0: 2020 2020 2053 4343 4320 5363 6f72 650a       SCCC Score.
-000103b0: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
-000103c0: 2020 2020 626c 7572 7265 7220 3d20 5374      blurrer = St
-000103d0: 7275 6374 7572 6542 6c75 7272 6572 2829  ructureBlurrer()
-000103e0: 0a20 2020 2020 2020 2073 636f 7265 7220  .        scorer 
-000103f0: 3d20 5363 6f72 696e 6746 756e 6374 696f  = ScoringFunctio
-00010400: 6e73 2829 0a20 2020 2020 2020 206f 7574  ns().        out
-00010410: 6c69 6e65 203d 2022 220a 2020 2020 2020  line = "".      
-00010420: 2020 7265 736f 6c75 7469 6f6e 5f64 656e    resolution_den
-00010430: 734d 6170 203d 2066 6c6f 6174 2872 6573  sMap = float(res
-00010440: 6f6c 7574 696f 6e5f 6465 6e73 4d61 7029  olution_densMap)
-00010450: 0a20 2020 2020 2020 2077 686f 6c65 5f66  .        whole_f
-00010460: 6974 5f6d 6170 203d 2062 6c75 7272 6572  it_map = blurrer
-00010470: 2e67 6175 7373 6961 6e5f 626c 7572 280a  .gaussian_blur(.
-00010480: 2020 2020 2020 2020 2020 2020 7374 7275              stru
-00010490: 6374 7572 655f 696e 7374 616e 6365 2c0a  cture_instance,.
-000104a0: 2020 2020 2020 2020 2020 2020 7265 736f              reso
-000104b0: 6c75 7469 6f6e 5f64 656e 734d 6170 2c0a  lution_densMap,.
-000104c0: 2020 2020 2020 2020 2020 2020 6465 6e73              dens
-000104d0: 4d61 703d 6d61 705f 7461 7267 6574 2c0a  Map=map_target,.
-000104e0: 2020 2020 2020 2020 2020 2020 7369 676d              sigm
-000104f0: 615f 636f 6566 663d 7369 676d 615f 6d61  a_coeff=sigma_ma
-00010500: 702c 0a20 2020 2020 2020 2020 2020 206e  p,.            n
-00010510: 6f72 6d61 6c69 7365 3d54 7275 652c 0a20  ormalise=True,. 
-00010520: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-00010530: 2073 696d 5f6d 6170 203d 2062 6c75 7272   sim_map = blurr
-00010540: 6572 2e67 6175 7373 6961 6e5f 626c 7572  er.gaussian_blur
-00010550: 280a 2020 2020 2020 2020 2020 2020 7269  (.            ri
-00010560: 6769 645f 626f 6479 5f73 7472 7563 7475  gid_body_structu
-00010570: 7265 2c0a 2020 2020 2020 2020 2020 2020  re,.            
-00010580: 7265 736f 6c75 7469 6f6e 5f64 656e 734d  resolution_densM
-00010590: 6170 2c0a 2020 2020 2020 2020 2020 2020  ap,.            
-000105a0: 6465 6e73 4d61 703d 6d61 705f 7461 7267  densMap=map_targ
-000105b0: 6574 2c0a 2020 2020 2020 2020 2020 2020  et,.            
-000105c0: 7369 676d 615f 636f 6566 663d 7369 676d  sigma_coeff=sigm
-000105d0: 615f 6d61 702c 0a20 2020 2020 2020 2020  a_map,.         
-000105e0: 2020 206e 6f72 6d61 6c69 7365 3d54 7275     normalise=Tru
-000105f0: 652c 0a20 2020 2020 2020 2029 0a20 2020  e,.        ).   
-00010600: 2020 2020 206d 696e 4465 6e73 203d 2073       minDens = s
-00010610: 696d 5f6d 6170 2e73 7464 2829 0a20 2020  im_map.std().   
-00010620: 2020 2020 2073 696d 5f6d 6173 6b5f 6172       sim_mask_ar
-00010630: 7261 7920 3d20 7369 6d5f 6d61 702e 5f67  ray = sim_map._g
-00010640: 6574 5f6d 6173 6b41 7272 6179 286d 696e  et_maskArray(min
-00010650: 4465 6e73 290a 2020 2020 2020 2020 6d61  Dens).        ma
-00010660: 736b 5f65 6d4d 6170 203d 206d 6170 5f74  sk_emMap = map_t
-00010670: 6172 6765 742e 5f67 6574 5f6d 6173 6b4d  arget._get_maskM
-00010680: 6170 2873 696d 5f6d 6173 6b5f 6172 7261  ap(sim_mask_arra
-00010690: 7929 0a20 2020 2020 2020 206d 6173 6b5f  y).        mask_
-000106a0: 7369 6d4d 6170 203d 2077 686f 6c65 5f66  simMap = whole_f
-000106b0: 6974 5f6d 6170 2e5f 6765 745f 6d61 736b  it_map._get_mask
-000106c0: 4d61 7028 7369 6d5f 6d61 736b 5f61 7272  Map(sim_mask_arr
-000106d0: 6179 290a 2020 2020 2020 2020 7373 655f  ay).        sse_
-000106e0: 6c63 6366 2c20 6f76 203d 2073 636f 7265  lccf, ov = score
-000106f0: 722e 4343 435f 6d61 7028 6d61 736b 5f65  r.CCC_map(mask_e
-00010700: 6d4d 6170 2c20 6d61 736b 5f73 696d 4d61  mMap, mask_simMa
-00010710: 702c 2063 6d6f 6465 3d63 5f6d 6f64 6529  p, cmode=c_mode)
-00010720: 0a20 2020 2020 2020 2069 6620 7772 6974  .        if writ
-00010730: 6520 6973 2054 7275 653a 0a20 2020 2020  e is True:.     
-00010740: 2020 2020 2020 206f 7574 6c69 6e65 202b         outline +
-00010750: 3d20 2753 4343 4320 666f 7220 7365 676d  = 'SCCC for segm
-00010760: 656e 7420 2566 5c6e 2720 2520 2873 7365  ent %f\n' % (sse
-00010770: 5f6c 6363 6629 0a20 2020 2020 2020 2020  _lccf).         
-00010780: 2020 2072 6574 7572 6e20 6f75 746c 696e     return outlin
-00010790: 650a 2020 2020 2020 2020 7265 7475 726e  e.        return
-000107a0: 2073 7365 5f6c 6363 660a 0a20 2020 2064   sse_lccf..    d
-000107b0: 6566 2053 4343 435f 4c41 5028 0a20 2020  ef SCCC_LAP(.   
-000107c0: 2020 2020 2020 2020 2073 656c 662c 0a20           self,. 
-000107d0: 2020 2020 2020 2020 2020 206d 6170 5f74             map_t
-000107e0: 6172 6765 742c 0a20 2020 2020 2020 2020  arget,.         
-000107f0: 2020 2072 6573 6f6c 7574 696f 6e5f 6465     resolution_de
-00010800: 6e73 4d61 702c 0a20 2020 2020 2020 2020  nsMap,.         
-00010810: 2020 2073 6967 6d61 5f6d 6170 2c0a 2020     sigma_map,.  
-00010820: 2020 2020 2020 2020 2020 7374 7275 6374            struct
-00010830: 7572 655f 696e 7374 616e 6365 2c0a 2020  ure_instance,.  
-00010840: 2020 2020 2020 2020 2020 7269 6769 645f            rigid_
-00010850: 626f 6479 5f73 7472 7563 7475 7265 2c0a  body_structure,.
-00010860: 2020 2020 2020 2020 2020 2020 7772 6974              writ
-00010870: 653d 4661 6c73 652c 0a20 2020 2029 3a0a  e=False,.    ):.
-00010880: 2020 2020 2020 2020 2222 2243 616c 6375          """Calcu
-00010890: 6c61 7465 2074 6865 204c 6170 6c61 6369  late the Laplaci
-000108a0: 616e 2066 696c 7465 7265 6420 6372 6f73  an filtered cros
-000108b0: 7320 636f 7272 656c 6174 696f 6e20 666f  s correlation fo
-000108c0: 7220 6120 7365 676d 656e 7420 6f66 0a20  r a segment of. 
-000108d0: 2020 2020 2020 2061 2070 726f 7465 696e         a protein
-000108e0: 206d 6f64 656c 2e0a 0a20 2020 2020 2020   model...       
-000108f0: 2053 6567 6d65 6e74 7320 6172 6520 6465   Segments are de
-00010900: 6669 6e65 6420 7573 696e 6720 6120 7269  fined using a ri
-00010910: 6769 642d 626f 6479 2073 7472 7563 7475  gid-body structu
-00010920: 7265 2069 6e73 7461 6e63 652c 2077 6869  re instance, whi
-00010930: 6368 2063 616e 0a20 2020 2020 2020 2062  ch can.        b
-00010940: 6520 6765 6e65 7261 7465 6420 7573 696e  e generated usin
-00010950: 6720 6052 4942 4649 4e44 203c 6874 7470  g `RIBFIND <http
-00010960: 733a 2f2f 7269 6266 696e 642e 6973 6d62  s://ribfind.ismb
-00010970: 2e6c 6f6e 2e61 632e 756b 2f3e 605f 2e0a  .lon.ac.uk/>`_..
-00010980: 2020 2020 2020 2020 5363 6f72 6520 6361          Score ca
-00010990: 6c63 756c 6174 6564 2075 7369 6e67 0a20  lculated using. 
-000109a0: 2020 2020 2020 203a 6d65 7468 3a60 6c61         :meth:`la
-000109b0: 706c 6163 655f 4343 4320 3c54 454d 5079  place_CCC <TEMPy
-000109c0: 2e70 726f 7465 696e 2e73 636f 7269 6e67  .protein.scoring
-000109d0: 5f66 756e 6374 696f 6e73 2e53 636f 7269  _functions.Scori
-000109e0: 6e67 4675 6e63 7469 6f6e 732e 6c61 706c  ngFunctions.lapl
-000109f0: 6163 655f 4343 433e 600a 0a20 2020 2020  ace_CCC>`..     
-00010a00: 2020 2041 7267 756d 656e 7473 3a0a 2020     Arguments:.  
-00010a10: 2020 2020 2020 2020 2020 6d61 705f 7461            map_ta
-00010a20: 7267 6574 3a20 4d61 7020 496e 7374 616e  rget: Map Instan
-00010a30: 6365 2e0a 2020 2020 2020 2020 2020 2020  ce..            
-00010a40: 7265 736f 6c75 7469 6f6e 5f64 656e 734d  resolution_densM
-00010a50: 6170 3a20 5265 736f 6c75 7469 6f6e 206f  ap: Resolution o
-00010a60: 6620 7468 6520 6d61 7020 696e 7374 616e  f the map instan
-00010a70: 6365 2e0a 2020 2020 2020 2020 2020 2020  ce..            
-00010a80: 7369 676d 615f 6d61 703a 2050 6172 616d  sigma_map: Param
-00010a90: 6574 6572 206e 6565 6420 666f 7220 5374  eter need for St
-00010aa0: 7275 6374 7572 6520 426c 7572 7265 722e  ructure Blurrer.
-00010ab0: 2046 756c 6c20 6578 706c 616e 6174 696f   Full explanatio
-00010ac0: 6e0a 2020 2020 2020 2020 2020 2020 2020  n.              
-00010ad0: 2020 3a72 6566 3a60 6865 7265 3c4e 6f74    :ref:`here<Not
-00010ae0: 6520 6f6e 2072 6561 6c20 7370 6163 6520  e on real space 
-00010af0: 626c 7572 7269 6e67 3a3e 600a 2020 2020  blurring:>`.    
-00010b00: 2020 2020 2020 2020 7374 7275 6374 7572          structur
-00010b10: 655f 696e 7374 616e 6365 3a20 5374 7275  e_instance: Stru
-00010b20: 6374 7572 6520 696e 7374 616e 6365 2074  cture instance t
-00010b30: 6f20 636f 6d70 6172 650a 2020 2020 2020  o compare.      
-00010b40: 2020 2020 2020 7269 6769 645f 626f 6479        rigid_body
-00010b50: 5f73 7472 7563 7475 7265 3a20 5269 6769  _structure: Rigi
-00010b60: 642d 626f 6479 2053 7472 7563 7475 7265  d-body Structure
-00010b70: 2069 6e73 7461 6e63 652e 0a20 2020 2020   instance..     
-00010b80: 2020 2020 2020 2077 7269 7465 3a20 4966         write: If
-00010b90: 2054 7275 652c 2061 2073 7472 696e 6720   True, a string 
-00010ba0: 6973 2072 6574 7572 6e65 6420 7769 7468  is returned with
-00010bb0: 2066 6f72 6d61 740a 2020 2020 2020 2020   format.        
-00010bc0: 2020 2020 2020 2020 3a63 6f64 653a 6066          :code:`f
-00010bd0: 2753 4343 435f 4c41 5020 666f 7220 7365  'SCCC_LAP for se
-00010be0: 676d 656e 7420 7b53 4343 435f 4c41 505f  gment {SCCC_LAP_
-00010bf0: 7363 6f72 657d 2760 0a20 2020 2020 2020  score}'`.       
-00010c00: 2052 6574 7572 6e3a 0a20 2020 2020 2020   Return:.       
-00010c10: 2020 2020 2066 6c6f 6174 2069 6620 3a63       float if :c
-00010c20: 6f64 653a 6077 7269 7465 3d46 616c 7365  ode:`write=False
-00010c30: 602c 2065 6c73 6520 7374 7269 6e67 3a0a  `, else string:.
-00010c40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010c50: 5343 4343 5f4c 4150 2073 636f 7265 0a20  SCCC_LAP score. 
-00010c60: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
-00010c70: 2020 2062 6c75 7272 6572 203d 2053 7472     blurrer = Str
-00010c80: 7563 7475 7265 426c 7572 7265 7228 290a  uctureBlurrer().
-00010c90: 2020 2020 2020 2020 7363 6f72 6572 203d          scorer =
-00010ca0: 2053 636f 7269 6e67 4675 6e63 7469 6f6e   ScoringFunction
-00010cb0: 7328 290a 2020 2020 2020 2020 6f75 746c  s().        outl
-00010cc0: 696e 6520 3d20 2222 0a20 2020 2020 2020  ine = "".       
-00010cd0: 2072 6573 6f6c 7574 696f 6e5f 6465 6e73   resolution_dens
-00010ce0: 4d61 7020 3d20 666c 6f61 7428 7265 736f  Map = float(reso
-00010cf0: 6c75 7469 6f6e 5f64 656e 734d 6170 290a  lution_densMap).
-00010d00: 2020 2020 2020 2020 7768 6f6c 655f 6669          whole_fi
-00010d10: 745f 6d61 7020 3d20 626c 7572 7265 722e  t_map = blurrer.
-00010d20: 6761 7573 7369 616e 5f62 6c75 7228 0a20  gaussian_blur(. 
-00010d30: 2020 2020 2020 2020 2020 2073 7472 7563             struc
-00010d40: 7475 7265 5f69 6e73 7461 6e63 652c 0a20  ture_instance,. 
-00010d50: 2020 2020 2020 2020 2020 2072 6573 6f6c             resol
-00010d60: 7574 696f 6e5f 6465 6e73 4d61 702c 0a20  ution_densMap,. 
-00010d70: 2020 2020 2020 2020 2020 2064 656e 734d             densM
-00010d80: 6170 3d6d 6170 5f74 6172 6765 742c 0a20  ap=map_target,. 
-00010d90: 2020 2020 2020 2020 2020 2073 6967 6d61             sigma
-00010da0: 5f63 6f65 6666 3d73 6967 6d61 5f6d 6170  _coeff=sigma_map
-00010db0: 2c0a 2020 2020 2020 2020 2020 2020 6e6f  ,.            no
-00010dc0: 726d 616c 6973 653d 5472 7565 2c0a 2020  rmalise=True,.  
-00010dd0: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-00010de0: 7369 6d5f 6d61 7020 3d20 626c 7572 7265  sim_map = blurre
-00010df0: 722e 6761 7573 7369 616e 5f62 6c75 7228  r.gaussian_blur(
-00010e00: 0a20 2020 2020 2020 2020 2020 2072 6967  .            rig
-00010e10: 6964 5f62 6f64 795f 7374 7275 6374 7572  id_body_structur
-00010e20: 652c 0a20 2020 2020 2020 2020 2020 2072  e,.            r
-00010e30: 6573 6f6c 7574 696f 6e5f 6465 6e73 4d61  esolution_densMa
-00010e40: 702c 0a20 2020 2020 2020 2020 2020 2064  p,.            d
-00010e50: 656e 734d 6170 3d6d 6170 5f74 6172 6765  ensMap=map_targe
-00010e60: 742c 0a20 2020 2020 2020 2020 2020 2073  t,.            s
-00010e70: 6967 6d61 5f63 6f65 6666 3d73 6967 6d61  igma_coeff=sigma
-00010e80: 5f6d 6170 2c0a 2020 2020 2020 2020 2020  _map,.          
-00010e90: 2020 6e6f 726d 616c 6973 653d 5472 7565    normalise=True
-00010ea0: 2c0a 2020 2020 2020 2020 290a 2020 2020  ,.        ).    
-00010eb0: 2020 2020 6d69 6e44 656e 7320 3d20 7369      minDens = si
-00010ec0: 6d5f 6d61 702e 7374 6428 290a 2020 2020  m_map.std().    
-00010ed0: 2020 2020 7369 6d5f 6d61 736b 5f61 7272      sim_mask_arr
-00010ee0: 6179 203d 2073 696d 5f6d 6170 2e5f 6765  ay = sim_map._ge
-00010ef0: 745f 6d61 736b 4172 7261 7928 6d69 6e44  t_maskArray(minD
-00010f00: 656e 7329 0a20 2020 2020 2020 206d 6173  ens).        mas
-00010f10: 6b5f 656d 4d61 7020 3d20 6d61 705f 7461  k_emMap = map_ta
-00010f20: 7267 6574 2e5f 6765 745f 6d61 736b 4d61  rget._get_maskMa
-00010f30: 7028 7369 6d5f 6d61 736b 5f61 7272 6179  p(sim_mask_array
-00010f40: 290a 2020 2020 2020 2020 6d61 736b 5f73  ).        mask_s
-00010f50: 696d 4d61 7020 3d20 7768 6f6c 655f 6669  imMap = whole_fi
-00010f60: 745f 6d61 702e 5f67 6574 5f6d 6173 6b4d  t_map._get_maskM
-00010f70: 6170 2873 696d 5f6d 6173 6b5f 6172 7261  ap(sim_mask_arra
-00010f80: 7929 0a20 2020 2020 2020 2073 7365 5f6c  y).        sse_l
-00010f90: 6363 6620 3d20 7363 6f72 6572 2e6c 6170  ccf = scorer.lap
-00010fa0: 6c61 6365 5f43 4343 286d 6173 6b5f 656d  lace_CCC(mask_em
-00010fb0: 4d61 702c 206d 6173 6b5f 7369 6d4d 6170  Map, mask_simMap
-00010fc0: 290a 2020 2020 2020 2020 6966 2077 7269  ).        if wri
-00010fd0: 7465 2069 7320 5472 7565 3a0a 2020 2020  te is True:.    
-00010fe0: 2020 2020 2020 2020 6f75 746c 696e 6520          outline 
-00010ff0: 2b3d 2027 5343 4343 2066 6f72 2073 6567  += 'SCCC for seg
-00011000: 6d65 6e74 2025 665c 6e27 2025 2028 7373  ment %f\n' % (ss
-00011010: 655f 6c63 6366 290a 2020 2020 2020 2020  e_lccf).        
-00011020: 2020 2020 7265 7475 726e 206f 7574 6c69      return outli
-00011030: 6e65 0a20 2020 2020 2020 2072 6574 7572  ne.        retur
-00011040: 6e20 7373 655f 6c63 6366 0a0a 2020 2020  n sse_lccf..    
-00011050: 6465 6620 5343 4343 5f4d 4928 0a20 2020  def SCCC_MI(.   
-00011060: 2020 2020 2020 2020 2073 656c 662c 0a20           self,. 
-00011070: 2020 2020 2020 2020 2020 206d 6170 5f74             map_t
-00011080: 6172 6765 742c 0a20 2020 2020 2020 2020  arget,.         
-00011090: 2020 2072 6573 6f6c 7574 696f 6e5f 6465     resolution_de
-000110a0: 6e73 4d61 702c 0a20 2020 2020 2020 2020  nsMap,.         
-000110b0: 2020 2073 6967 6d61 5f6d 6170 2c0a 2020     sigma_map,.  
-000110c0: 2020 2020 2020 2020 2020 7374 7275 6374            struct
-000110d0: 7572 655f 696e 7374 616e 6365 2c0a 2020  ure_instance,.  
-000110e0: 2020 2020 2020 2020 2020 7269 6769 645f            rigid_
-000110f0: 626f 6479 5f73 7472 7563 7475 7265 2c0a  body_structure,.
-00011100: 2020 2020 2020 2020 2020 2020 7772 6974              writ
-00011110: 653d 4661 6c73 652c 0a20 2020 2029 3a0a  e=False,.    ):.
-00011120: 2020 2020 2020 2020 2222 2243 616c 6375          """Calcu
-00011130: 6c61 7465 2074 6865 206d 7574 7561 6c20  late the mutual 
-00011140: 696e 666f 726d 6174 696f 6e20 7363 6f72  information scor
-00011150: 6520 666f 7220 6120 7365 676d 656e 7420  e for a segment 
-00011160: 6f66 2061 2070 726f 7465 696e 0a20 2020  of a protein.   
-00011170: 2020 2020 206d 6f64 656c 2e0a 0a20 2020       model...   
-00011180: 2020 2020 2053 6567 6d65 6e74 7320 6172       Segments ar
-00011190: 6520 6465 6669 6e65 6420 7573 696e 6720  e defined using 
-000111a0: 6120 7269 6769 642d 626f 6479 2073 7472  a rigid-body str
-000111b0: 7563 7475 7265 2069 6e73 7461 6e63 652c  ucture instance,
-000111c0: 2077 6869 6368 2063 616e 0a20 2020 2020   which can.     
-000111d0: 2020 2062 6520 6765 6e65 7261 7465 6420     be generated 
-000111e0: 7573 696e 6720 6052 4942 4649 4e44 203c  using `RIBFIND <
-000111f0: 6874 7470 733a 2f2f 7269 6266 696e 642e  https://ribfind.
-00011200: 6973 6d62 2e6c 6f6e 2e61 632e 756b 2f3e  ismb.lon.ac.uk/>
-00011210: 605f 2e0a 2020 2020 2020 2020 5468 6520  `_..        The 
-00011220: 7363 6f72 6520 666f 7220 7468 6520 7365  score for the se
-00011230: 676d 656e 7420 6973 2063 616c 6375 6c61  gment is calcula
-00011240: 7465 6420 7573 696e 670a 2020 2020 2020  ted using.      
-00011250: 2020 3a6d 6574 683a 604d 4920 3c54 454d    :meth:`MI <TEM
-00011260: 5079 2e70 726f 7465 696e 2e73 636f 7269  Py.protein.scori
-00011270: 6e67 5f66 756e 6374 696f 6e73 2e53 636f  ng_functions.Sco
-00011280: 7269 6e67 4675 6e63 7469 6f6e 732e 4d49  ringFunctions.MI
-00011290: 3e60 0a0a 2020 2020 2020 2020 4172 6775  >`..        Argu
-000112a0: 6d65 6e74 733a 0a20 2020 2020 2020 2020  ments:.         
-000112b0: 2020 206d 6170 5f74 6172 6765 743a 204d     map_target: M
-000112c0: 6170 2049 6e73 7461 6e63 652e 0a20 2020  ap Instance..   
-000112d0: 2020 2020 2020 2020 2072 6573 6f6c 7574           resolut
-000112e0: 696f 6e5f 6465 6e73 4d61 703a 2052 6573  ion_densMap: Res
-000112f0: 6f6c 7574 696f 6e20 6f66 2074 6865 206d  olution of the m
-00011300: 6170 2069 6e73 7461 6e63 652e 0a20 2020  ap instance..   
-00011310: 2020 2020 2020 2020 2073 6967 6d61 5f6d           sigma_m
-00011320: 6170 3a20 5061 7261 6d65 7465 7220 6e65  ap: Parameter ne
-00011330: 6564 2066 6f72 2053 7472 7563 7475 7265  ed for Structure
-00011340: 2042 6c75 7272 6572 2e20 4675 6c6c 2065   Blurrer. Full e
-00011350: 7870 6c61 6e61 7469 6f6e 0a20 2020 2020  xplanation.     
-00011360: 2020 2020 2020 2020 2020 203a 7265 663a             :ref:
-00011370: 6068 6572 653c 4e6f 7465 206f 6e20 7265  `here<Note on re
-00011380: 616c 2073 7061 6365 2062 6c75 7272 696e  al space blurrin
-00011390: 673a 3e60 0a20 2020 2020 2020 2020 2020  g:>`.           
-000113a0: 2073 7472 7563 7475 7265 5f69 6e73 7461   structure_insta
-000113b0: 6e63 653a 2053 7472 7563 7475 7265 2069  nce: Structure i
-000113c0: 6e73 7461 6e63 6520 746f 2063 6f6d 7061  nstance to compa
-000113d0: 7265 0a20 2020 2020 2020 2020 2020 2072  re.            r
-000113e0: 6967 6964 5f62 6f64 795f 7374 7275 6374  igid_body_struct
-000113f0: 7572 653a 2052 6967 6964 2d62 6f64 7920  ure: Rigid-body 
-00011400: 5374 7275 6374 7572 6520 696e 7374 616e  Structure instan
-00011410: 6365 2e0a 2020 2020 2020 2020 2020 2020  ce..            
-00011420: 7772 6974 653a 2049 6620 5472 7565 2c20  write: If True, 
-00011430: 6120 7374 7269 6e67 2069 7320 7265 7475  a string is retu
-00011440: 726e 6564 2077 6974 6820 666f 726d 6174  rned with format
-00011450: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00011460: 203a 636f 6465 3a60 6627 5343 4343 5f4c   :code:`f'SCCC_L
-00011470: 4150 2066 6f72 2073 6567 6d65 6e74 207b  AP for segment {
-00011480: 5343 4343 5f4c 4150 5f73 636f 7265 7d27  SCCC_LAP_score}'
-00011490: 600a 2020 2020 2020 2020 5265 7475 726e  `.        Return
-000114a0: 3a0a 2020 2020 2020 2020 2020 2020 666c  :.            fl
-000114b0: 6f61 7420 6966 203a 636f 6465 3a60 7772  oat if :code:`wr
-000114c0: 6974 653d 4661 6c73 6560 2c20 656c 7365  ite=False`, else
-000114d0: 2073 7472 696e 673a 0a20 2020 2020 2020   string:.       
-000114e0: 2020 2020 2020 2020 2053 4343 435f 4d49           SCCC_MI
-000114f0: 2073 636f 7265 0a20 2020 2020 2020 2022   score.        "
-00011500: 2222 0a20 2020 2020 2020 2062 6c75 7272  "".        blurr
-00011510: 6572 203d 2053 7472 7563 7475 7265 426c  er = StructureBl
-00011520: 7572 7265 7228 290a 2020 2020 2020 2020  urrer().        
-00011530: 7363 6f72 6572 203d 2053 636f 7269 6e67  scorer = Scoring
-00011540: 4675 6e63 7469 6f6e 7328 290a 2020 2020  Functions().    
-00011550: 2020 2020 6f75 746c 696e 6520 3d20 2222      outline = ""
-00011560: 0a20 2020 2020 2020 2072 6573 6f6c 7574  .        resolut
-00011570: 696f 6e5f 6465 6e73 4d61 7020 3d20 666c  ion_densMap = fl
-00011580: 6f61 7428 7265 736f 6c75 7469 6f6e 5f64  oat(resolution_d
-00011590: 656e 734d 6170 290a 2020 2020 2020 2020  ensMap).        
-000115a0: 7768 6f6c 655f 6669 745f 6d61 7020 3d20  whole_fit_map = 
-000115b0: 626c 7572 7265 722e 6761 7573 7369 616e  blurrer.gaussian
-000115c0: 5f62 6c75 7228 0a20 2020 2020 2020 2020  _blur(.         
-000115d0: 2020 2073 7472 7563 7475 7265 5f69 6e73     structure_ins
-000115e0: 7461 6e63 652c 0a20 2020 2020 2020 2020  tance,.         
-000115f0: 2020 2072 6573 6f6c 7574 696f 6e5f 6465     resolution_de
-00011600: 6e73 4d61 702c 0a20 2020 2020 2020 2020  nsMap,.         
-00011610: 2020 2064 656e 734d 6170 3d6d 6170 5f74     densMap=map_t
-00011620: 6172 6765 742c 0a20 2020 2020 2020 2020  arget,.         
-00011630: 2020 2073 6967 6d61 5f63 6f65 6666 3d73     sigma_coeff=s
-00011640: 6967 6d61 5f6d 6170 2c0a 2020 2020 2020  igma_map,.      
-00011650: 2020 2020 2020 6e6f 726d 616c 6973 653d        normalise=
-00011660: 5472 7565 0a20 2020 2020 2020 2029 0a20  True.        ). 
-00011670: 2020 2020 2020 2073 696d 5f6d 6170 203d         sim_map =
-00011680: 2062 6c75 7272 6572 2e67 6175 7373 6961   blurrer.gaussia
-00011690: 6e5f 626c 7572 280a 2020 2020 2020 2020  n_blur(.        
-000116a0: 2020 2020 7269 6769 645f 626f 6479 5f73      rigid_body_s
-000116b0: 7472 7563 7475 7265 2c0a 2020 2020 2020  tructure,.      
-000116c0: 2020 2020 2020 7265 736f 6c75 7469 6f6e        resolution
-000116d0: 5f64 656e 734d 6170 2c0a 2020 2020 2020  _densMap,.      
-000116e0: 2020 2020 2020 6465 6e73 4d61 703d 6d61        densMap=ma
-000116f0: 705f 7461 7267 6574 2c0a 2020 2020 2020  p_target,.      
-00011700: 2020 2020 2020 7369 676d 615f 636f 6566        sigma_coef
-00011710: 663d 7369 676d 615f 6d61 702c 0a20 2020  f=sigma_map,.   
-00011720: 2020 2020 2020 2020 206e 6f72 6d61 6c69           normali
-00011730: 7365 3d54 7275 650a 2020 2020 2020 2020  se=True.        
-00011740: 290a 2020 2020 2020 2020 6d69 6e44 656e  ).        minDen
-00011750: 7320 3d20 7369 6d5f 6d61 702e 7374 6428  s = sim_map.std(
-00011760: 290a 2020 2020 2020 2020 7369 6d5f 6d61  ).        sim_ma
-00011770: 736b 5f61 7272 6179 203d 2073 696d 5f6d  sk_array = sim_m
-00011780: 6170 2e5f 6765 745f 6d61 736b 4172 7261  ap._get_maskArra
-00011790: 7928 6d69 6e44 656e 7329 0a20 2020 2020  y(minDens).     
-000117a0: 2020 206d 6173 6b5f 656d 4d61 7020 3d20     mask_emMap = 
-000117b0: 6d61 705f 7461 7267 6574 2e5f 6765 745f  map_target._get_
-000117c0: 6d61 736b 4d61 7028 7369 6d5f 6d61 736b  maskMap(sim_mask
-000117d0: 5f61 7272 6179 290a 2020 2020 2020 2020  _array).        
-000117e0: 6d61 736b 5f73 696d 4d61 7020 3d20 7768  mask_simMap = wh
-000117f0: 6f6c 655f 6669 745f 6d61 702e 5f67 6574  ole_fit_map._get
-00011800: 5f6d 6173 6b4d 6170 2873 696d 5f6d 6173  _maskMap(sim_mas
-00011810: 6b5f 6172 7261 7929 0a20 2020 2020 2020  k_array).       
-00011820: 2073 7365 5f6c 6363 6620 3d20 7363 6f72   sse_lccf = scor
-00011830: 6572 2e4d 4928 6d61 736b 5f65 6d4d 6170  er.MI(mask_emMap
-00011840: 2c20 6d61 736b 5f73 696d 4d61 7029 0a20  , mask_simMap). 
-00011850: 2020 2020 2020 2069 6620 7772 6974 6520         if write 
-00011860: 6973 2054 7275 653a 0a20 2020 2020 2020  is True:.       
-00011870: 2020 2020 206f 7574 6c69 6e65 202b 3d20       outline += 
-00011880: 2753 4343 4320 666f 7220 7365 676d 656e  'SCCC for segmen
-00011890: 7420 2566 5c6e 2720 2520 2873 7365 5f6c  t %f\n' % (sse_l
-000118a0: 6363 6629 0a20 2020 2020 2020 2020 2020  ccf).           
-000118b0: 2072 6574 7572 6e20 6f75 746c 696e 650a   return outline.
-000118c0: 2020 2020 2020 2020 7265 7475 726e 2073          return s
-000118d0: 7365 5f6c 6363 660a 0a20 2020 2064 6566  se_lccf..    def
-000118e0: 2067 6574 5f73 6363 6328 0a20 2020 2020   get_sccc(.     
-000118f0: 2020 2020 2020 2073 656c 662c 0a20 2020         self,.   
-00011900: 2020 2020 2020 2020 206d 6170 5f74 6172           map_tar
-00011910: 6765 742c 0a20 2020 2020 2020 2020 2020  get,.           
-00011920: 2073 7472 7563 7475 7265 5f69 6e73 7461   structure_insta
-00011930: 6e63 652c 0a20 2020 2020 2020 2020 2020  nce,.           
-00011940: 2072 6967 6964 5f62 6f64 795f 6669 6c65   rigid_body_file
-00011950: 2c0a 2020 2020 2020 2020 2020 2020 7265  ,.            re
-00011960: 736f 6c75 7469 6f6e 2c0a 2020 2020 2020  solution,.      
-00011970: 2020 2020 2020 7369 676d 615f 6d61 703d        sigma_map=
-00011980: 302e 3138 370a 2020 2020 293a 0a20 2020  0.187.    ):.   
-00011990: 2020 2020 2022 2222 5265 6164 2072 6967       """Read rig
-000119a0: 6964 2062 6f64 7920 6669 6c65 2061 6e64  id body file and
-000119b0: 2063 616c 6375 6c61 7465 2073 6363 6320   calculate sccc 
-000119c0: 7363 6f72 6573 2066 6f72 2065 6163 6820  scores for each 
-000119d0: 7269 6769 6420 626f 6479 0a0a 2020 2020  rigid body..    
-000119e0: 2020 2020 4172 6773 3a0a 2020 2020 2020      Args:.      
-000119f0: 2020 2020 2020 6d61 705f 7461 7267 6574        map_target
-00011a00: 3a20 4d61 7020 696e 7374 616e 6365 0a20  : Map instance. 
-00011a10: 2020 2020 2020 2020 2020 2073 7472 7563             struc
-00011a20: 7475 7265 5f69 6e73 7461 6e63 653a 204d  ture_instance: M
-00011a30: 6f64 656c 2073 7472 7563 7475 7265 2069  odel structure i
-00011a40: 6e73 7461 6e63 650a 2020 2020 2020 2020  nstance.        
-00011a50: 2020 2020 7269 6769 645f 626f 6479 5f66      rigid_body_f
-00011a60: 696c 653a 2050 6174 6820 746f 2072 6967  ile: Path to rig
-00011a70: 6964 2062 6f64 7920 6669 6c65 0a20 2020  id body file.   
-00011a80: 2020 2020 2020 2020 2072 6573 6f6c 7574           resolut
-00011a90: 696f 6e3a 2052 6573 6f6c 7574 696f 6e20  ion: Resolution 
-00011aa0: 6f66 206d 6170 2069 6e73 7461 6e63 650a  of map instance.
-00011ab0: 2020 2020 2020 2020 2020 2020 7369 676d              sigm
-00011ac0: 615f 6d61 703a 2050 6172 616d 6574 6572  a_map: Parameter
-00011ad0: 206e 6565 6420 666f 7220 5374 7275 6374   need for Struct
-00011ae0: 7572 6520 426c 7572 7265 722e 2046 756c  ure Blurrer. Ful
-00011af0: 6c20 6578 706c 616e 6174 696f 6e0a 2020  l explanation.  
-00011b00: 2020 2020 2020 2020 2020 2020 2020 3a72                :r
-00011b10: 6566 3a60 6865 7265 3c4e 6f74 6520 6f6e  ef:`here<Note on
-00011b20: 2072 6561 6c20 7370 6163 6520 626c 7572   real space blur
-00011b30: 7269 6e67 3a3e 600a 0a20 2020 2020 2020  ring:>`..       
-00011b40: 2052 6574 7572 6e73 3a0a 2020 2020 2020   Returns:.      
-00011b50: 2020 2020 2020 5477 6f20 6469 6374 696f        Two dictio
-00011b60: 6e61 7269 6573 3b20 6469 6374 5f63 6861  naries; dict_cha
-00011b70: 696e 5f73 636f 7265 732c 2064 6963 745f  in_scores, dict_
-00011b80: 7269 6769 645f 7363 6f72 6573 0a20 2020  rigid_scores.   
-00011b90: 2020 2020 2020 2020 2020 2020 202a 2064               * d
-00011ba0: 6963 745f 6368 6169 6e5f 7363 6f72 6573  ict_chain_scores
-00011bb0: 2069 7320 6120 6469 6374 696f 6e61 7279   is a dictionary
-00011bc0: 2077 6974 6820 6b65 7973 2065 7175 616c   with keys equal
-00011bd0: 2074 6f20 6368 6169 6e0a 2020 2020 2020   to chain.      
-00011be0: 2020 2020 2020 2020 2020 2020 6c61 6265              labe
-00011bf0: 6c73 2028 652e 672e 203a 636f 6465 3a60  ls (e.g. :code:`
-00011c00: 5b27 4127 2c20 2742 272c 2027 4327 5d60  ['A', 'B', 'C']`
-00011c10: 292e 2045 6163 6820 7661 6c75 6520 6973  ). Each value is
-00011c20: 2061 6e6f 7468 6572 0a20 2020 2020 2020   another.       
-00011c30: 2020 2020 2020 2020 2020 2064 6963 7469             dicti
-00011c40: 6f6e 6172 792c 2077 6974 6820 6b65 7973  onary, with keys
-00011c50: 2061 7320 7265 7369 6475 6520 6e75 6d62   as residue numb
-00011c60: 6572 2066 6f72 2065 6163 6820 7265 7369  er for each resi
-00011c70: 6475 6520 696e 2061 0a20 2020 2020 2020  due in a.       
-00011c80: 2020 2020 2020 2020 2020 2072 6967 6964             rigid
-00011c90: 2062 6f64 792c 2061 6e64 2076 616c 7565   body, and value
-00011ca0: 7320 7468 6520 4343 4320 7363 6f72 6520  s the CCC score 
-00011cb0: 666f 7220 7468 6174 2072 6573 6964 7565  for that residue
-00011cc0: 2e0a 0a20 2020 2020 2020 2020 2020 2020  ...             
-00011cd0: 2020 202a 2064 6963 745f 7269 6769 645f     * dict_rigid_
-00011ce0: 7363 6f72 6573 2069 7320 6120 6469 6374  scores is a dict
-00011cf0: 696f 6e61 7279 2077 6974 6820 6b65 7973  ionary with keys
-00011d00: 2065 7175 616c 2074 6f20 6561 6368 0a20   equal to each. 
-00011d10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011d20: 2072 6967 6964 2062 6f64 7920 2873 7472   rigid body (str
-00011d30: 696e 673f 3f20 6e6f 7420 7375 7265 2920  ing?? not sure) 
-00011d40: 616e 6420 7661 6c75 6573 2074 6865 2043  and values the C
-00011d50: 4343 2073 636f 7265 2066 6f72 0a20 2020  CC score for.   
-00011d60: 2020 2020 2020 2020 2020 2020 2020 2074                 t
-00011d70: 6861 7420 626f 6479 2e0a 0a20 2020 2020  hat body...     
-00011d80: 2020 2022 2222 0a20 2020 2020 2020 2064     """.        d
-00011d90: 6963 745f 7262 6620 3d20 5242 5061 7273  ict_rbf = RBPars
-00011da0: 6572 2e67 6574 5f72 6967 6964 5f62 6f64  er.get_rigid_bod
-00011db0: 795f 7374 725f 696e 7374 616e 6365 7328  y_str_instances(
-00011dc0: 0a20 2020 2020 2020 2020 2020 2072 6967  .            rig
-00011dd0: 6964 5f62 6f64 795f 6669 6c65 2c0a 2020  id_body_file,.  
-00011de0: 2020 2020 2020 2020 2020 7374 7275 6374            struct
-00011df0: 7572 655f 696e 7374 616e 6365 2c0a 2020  ure_instance,.  
-00011e00: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-00011e10: 6469 6374 5f63 6861 696e 5f64 6574 6169  dict_chain_detai
-00011e20: 6c73 203d 2073 7472 7563 7475 7265 5f69  ls = structure_i
-00011e30: 6e73 7461 6e63 652e 6765 745f 6469 6374  nstance.get_dict
-00011e40: 5f73 7472 2829 0a20 2020 2020 2020 2064  _str().        d
-00011e50: 6963 745f 6368 6169 6e5f 7363 6f72 6573  ict_chain_scores
-00011e60: 203d 207b 7d0a 2020 2020 2020 2020 6469   = {}.        di
-00011e70: 6374 5f72 6967 6964 5f73 636f 7265 7320  ct_rigid_scores 
-00011e80: 3d20 7b7d 0a20 2020 2020 2020 206d 696e  = {}.        min
-00011e90: 7363 6f72 6520 3d20 312e 300a 2020 2020  score = 1.0.    
-00011ea0: 2020 2020 6d61 7873 636f 7265 203d 202d      maxscore = -
-00011eb0: 312e 300a 2020 2020 2020 2020 666f 7220  1.0.        for 
-00011ec0: 6368 2069 6e20 6469 6374 5f63 6861 696e  ch in dict_chain
-00011ed0: 5f64 6574 6169 6c73 3a0a 2020 2020 2020  _details:.      
-00011ee0: 2020 2020 2020 6469 6374 5f72 6573 5f73        dict_res_s
-00011ef0: 636f 7265 7320 3d20 7b7d 0a20 2020 2020  cores = {}.     
-00011f00: 2020 2020 2020 2066 6f72 2072 6573 2069         for res i
-00011f10: 6e20 6469 6374 5f63 6861 696e 5f64 6574  n dict_chain_det
-00011f20: 6169 6c73 5b63 685d 3a0a 2020 2020 2020  ails[ch]:.      
-00011f30: 2020 2020 2020 2020 2020 6469 6374 5f72            dict_r
-00011f40: 6573 5f73 636f 7265 735b 7265 735d 203d  es_scores[res] =
-00011f50: 202d 322e 300a 2020 2020 2020 2020 2020   -2.0.          
-00011f60: 2020 6966 2063 6820 6e6f 7420 696e 2064    if ch not in d
-00011f70: 6963 745f 7262 663a 0a20 2020 2020 2020  ict_rbf:.       
-00011f80: 2020 2020 2020 2020 2063 6f6e 7469 6e75           continu
-00011f90: 650a 2020 2020 2020 2020 2020 2020 666f  e.            fo
-00011fa0: 7220 7262 2069 6e20 6469 6374 5f72 6266  r rb in dict_rbf
-00011fb0: 5b63 685d 3a0a 2020 2020 2020 2020 2020  [ch]:.          
-00011fc0: 2020 2020 2020 7265 735f 6c69 7374 203d        res_list =
-00011fd0: 205b 5d0a 2020 2020 2020 2020 2020 2020   [].            
-00011fe0: 2020 2020 666f 7220 7365 6720 696e 2064      for seg in d
-00011ff0: 6963 745f 7262 665b 6368 5d5b 7262 5d5b  ict_rbf[ch][rb][
-00012000: 305d 3a0a 2020 2020 2020 2020 2020 2020  0]:.            
-00012010: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
-00012020: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012030: 2020 2020 2066 6f72 2072 2069 6e20 7261       for r in ra
-00012040: 6e67 6528 696e 7428 7365 675b 305d 292c  nge(int(seg[0]),
-00012050: 2069 6e74 2873 6567 5b31 5d29 202b 2031   int(seg[1]) + 1
-00012060: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-00012070: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-00012080: 6573 5f6c 6973 742e 6170 7065 6e64 2872  es_list.append(r
-00012090: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-000120a0: 2020 2020 2020 6578 6365 7074 2054 7970        except Typ
-000120b0: 6545 7272 6f72 3a0a 2020 2020 2020 2020  eError:.        
-000120c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000120d0: 636f 6e74 696e 7565 0a20 2020 2020 2020  continue.       
-000120e0: 2020 2020 2020 2020 2073 636f 7265 5f53           score_S
-000120f0: 4343 4320 3d20 7365 6c66 2e53 4343 4328  CCC = self.SCCC(
-00012100: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00012110: 2020 2020 206d 6170 5f74 6172 6765 742c       map_target,
+0000e590: 6b64 7472 6565 203d 2063 4b44 5472 6565  kdtree = cKDTree
+0000e5a0: 2870 6f69 6e74 735f 636c 290a 2020 2020  (points_cl).    
+0000e5b0: 2020 2020 2020 2020 6578 6365 7074 2045          except E
+0000e5c0: 7863 6570 7469 6f6e 3a0a 2020 2020 2020  xception:.      
+0000e5d0: 2020 2020 2020 2020 2020 7265 7475 726e            return
+0000e5e0: 204e 6f6e 652c 204e 6f6e 650a 2020 2020   None, None.    
+0000e5f0: 2020 2020 2020 2020 6e65 6967 6862 6f72          neighbor
+0000e600: 735f 6e75 6d20 3d20 3230 0a20 2020 2020  s_num = 20.     
+0000e610: 2020 2020 2020 2064 6973 7461 6e63 655f         distance_
+0000e620: 6c69 6d20 3d20 332e 300a 2020 2020 2020  lim = 3.0.      
+0000e630: 2020 2020 2020 6e65 6967 6820 3d20 6b64        neigh = kd
+0000e640: 7472 6565 2e71 7565 7279 280a 2020 2020  tree.query(.    
+0000e650: 2020 2020 2020 2020 2020 2020 706f 696e              poin
+0000e660: 7473 5f63 6c2c 0a20 2020 2020 2020 2020  ts_cl,.         
+0000e670: 2020 2020 2020 206b 3d6e 6569 6768 626f         k=neighbo
+0000e680: 7273 5f6e 756d 2c0a 2020 2020 2020 2020  rs_num,.        
+0000e690: 2020 2020 2020 2020 6469 7374 616e 6365          distance
+0000e6a0: 5f75 7070 6572 5f62 6f75 6e64 3d64 6973  _upper_bound=dis
+0000e6b0: 7461 6e63 655f 6c69 6d2c 0a20 2020 2020  tance_lim,.     
+0000e6c0: 2020 2020 2020 2029 5b31 5d0a 0a20 2020         )[1]..   
+0000e6d0: 2020 2020 2020 2020 2063 6c5f 7765 6967           cl_weig
+0000e6e0: 6874 203d 2028 0a20 2020 2020 2020 2020  ht = (.         
+0000e6f0: 2020 2020 2020 2020 2020 206e 702e 6e75             np.nu
+0000e700: 6d73 756d 286e 702e 7375 6d28 6e65 6967  msum(np.sum(neig
+0000e710: 6820 3c20 6c65 6e28 6e65 6967 6829 2c20  h < len(neigh), 
+0000e720: 6178 6973 3d31 2920 3e20 3137 2920 2f0a  axis=1) > 17) /.
+0000e730: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e740: 2020 2020 666c 6f61 7428 6c65 6e28 7072      float(len(pr
+0000e750: 6f62 655f 706f 696e 7473 2929 0a20 2020  obe_points)).   
+0000e760: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
+0000e770: 2020 2020 2020 2064 6973 7461 6e63 6573         distances
+0000e780: 5f61 6c69 676e 203d 2064 6973 7461 6e63  _align = distanc
+0000e790: 6573 0a20 2020 2020 2020 2020 2020 2064  es.            d
+0000e7a0: 6973 7461 6e63 6573 5f73 656c 203d 2064  istances_sel = d
+0000e7b0: 6973 7461 6e63 6573 5f61 6c69 676e 5b0a  istances_align[.
+0000e7c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e7d0: 6e70 2e73 756d 286e 6569 6768 203c 206c  np.sum(neigh < l
+0000e7e0: 656e 286e 6569 6768 292c 2061 7869 733d  en(neigh), axis=
+0000e7f0: 3129 203e 2031 370a 2020 2020 2020 2020  1) > 17.        
+0000e800: 2020 2020 5d0a 2020 2020 2020 2020 2020      ].          
+0000e810: 2020 6469 7374 616e 6365 7320 3d20 6469    distances = di
+0000e820: 7374 616e 6365 735f 7365 6c5b 3a5d 0a0a  stances_sel[:]..
+0000e830: 2020 2020 2020 2020 6f76 6572 6c61 705f          overlap_
+0000e840: 6672 6571 203d 206e 702e 6869 7374 6f67  freq = np.histog
+0000e850: 7261 6d28 6469 7374 616e 6365 732c 2062  ram(distances, b
+0000e860: 696e 7329 5b30 5d0a 2020 2020 2020 2020  ins)[0].        
+0000e870: 746f 7461 6c20 3d20 746f 7461 6c5f 6578  total = total_ex
+0000e880: 740a 2020 2020 2020 2020 6375 6d75 6c5f  t.        cumul_
+0000e890: 6672 6571 203d 2030 2e30 0a20 2020 2020  freq = 0.0.     
+0000e8a0: 2020 2065 6e74 6572 203d 2030 0a20 2020     enter = 0.   
+0000e8b0: 2020 2020 2073 756d 5f73 6320 3d20 302e       sum_sc = 0.
+0000e8c0: 300a 2020 2020 2020 2020 666f 7220 6920  0.        for i 
+0000e8d0: 696e 2072 616e 6765 286c 656e 286f 7665  in range(len(ove
+0000e8e0: 726c 6170 5f66 7265 7129 293a 0a20 2020  rlap_freq)):.   
+0000e8f0: 2020 2020 2020 2020 2077 203d 206c 656e           w = len
+0000e900: 286f 7665 726c 6170 5f66 7265 7129 202d  (overlap_freq) -
+0000e910: 2028 6929 0a20 2020 2020 2020 2020 2020   (i).           
+0000e920: 2074 7279 3a0a 2020 2020 2020 2020 2020   try:.          
+0000e930: 2020 2020 2020 6375 6d75 6c5f 6672 6571        cumul_freq
+0000e940: 202b 3d20 6f76 6572 6c61 705f 6672 6571   += overlap_freq
+0000e950: 5b69 5d0a 2020 2020 2020 2020 2020 2020  [i].            
+0000e960: 6578 6365 7074 2049 6e64 6578 4572 726f  except IndexErro
+0000e970: 723a 0a20 2020 2020 2020 2020 2020 2020  r:.             
+0000e980: 2020 2070 6173 730a 2020 2020 2020 2020     pass.        
+0000e990: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
+0000e9a0: 2020 2020 2020 2020 2070 6572 635f 6571           perc_eq
+0000e9b0: 7569 7620 3d20 666c 6f61 7428 6375 6d75  uiv = float(cumu
+0000e9c0: 6c5f 6672 6571 2920 2f20 6e75 6d5f 6469  l_freq) / num_di
+0000e9d0: 7374 616e 6365 730a 2020 2020 2020 2020  stances.        
+0000e9e0: 2020 2020 6578 6365 7074 205a 6572 6f44      except ZeroD
+0000e9f0: 6976 6973 696f 6e45 7272 6f72 3a0a 2020  ivisionError:.  
+0000ea00: 2020 2020 2020 2020 2020 2020 2020 7072                pr
+0000ea10: 696e 7428 2744 6973 7461 6e63 6520 7765  int('Distance we
+0000ea20: 6967 6874 696e 6720 6661 696c 6564 2121  ighting failed!!
+0000ea30: 2e20 4368 6563 6b20 7375 7266 6163 6520  . Check surface 
+0000ea40: 6465 6669 6e65 6427 290a 2020 2020 2020  defined').      
+0000ea50: 2020 2020 2020 2020 2020 7265 7475 726e            return
+0000ea60: 204e 6f6e 652c 204e 6f6e 650a 2020 2020   None, None.    
+0000ea70: 2020 2020 2020 2020 7375 6d5f 7363 203d          sum_sc =
+0000ea80: 2073 756d 5f73 6320 2b20 2828 7729 202a   sum_sc + ((w) *
+0000ea90: 2070 6572 635f 6571 7569 7629 0a20 2020   perc_equiv).   
+0000eaa0: 2020 2020 2020 2020 2074 6f74 616c 202b           total +
+0000eab0: 3d20 2877 290a 2020 2020 2020 2020 2020  = (w).          
+0000eac0: 2020 656e 7465 7220 3d20 310a 2020 2020    enter = 1.    
+0000ead0: 2020 2020 7363 6f72 6520 3d20 666c 6f61      score = floa
+0000eae0: 7428 7375 6d5f 7363 2920 2f20 746f 7461  t(sum_sc) / tota
+0000eaf0: 6c0a 2020 2020 2020 2020 6966 2063 6c3a  l.        if cl:
+0000eb00: 2020 2320 6e6f 7161 3a46 3832 310a 2020    # noqa:F821.  
+0000eb10: 2020 2020 2020 2020 2020 6966 2065 6e74            if ent
+0000eb20: 6572 203d 3d20 313a 0a20 2020 2020 2020  er == 1:.       
+0000eb30: 2020 2020 2020 2020 2069 6620 6c65 6e28           if len(
+0000eb40: 6469 7374 616e 6365 735f 7365 6c29 203d  distances_sel) =
+0000eb50: 3d20 302e 303a 0a20 2020 2020 2020 2020  = 0.0:.         
+0000eb60: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+0000eb70: 6e20 302e 300a 2020 2020 2020 2020 2020  n 0.0.          
+0000eb80: 2020 2020 2020 6966 206e 702e 6d65 616e        if np.mean
+0000eb90: 2864 6973 7461 6e63 6573 5f73 656c 2920  (distances_sel) 
+0000eba0: 3d3d 2030 2e30 3a0a 2020 2020 2020 2020  == 0.0:.        
+0000ebb0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+0000ebc0: 726e 2030 2e30 0a20 2020 2020 2020 2020  rn 0.0.         
+0000ebd0: 2020 2020 2020 2069 6620 636c 5f77 6569         if cl_wei
+0000ebe0: 6768 7420 3d3d 2030 2e30 3a0a 2020 2020  ght == 0.0:.    
+0000ebf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ec00: 7265 7475 726e 2030 2e30 0a20 2020 2020  return 0.0.     
+0000ec10: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+0000ec20: 6e20 7363 6f72 650a 2020 2020 2020 2020  n score.        
+0000ec30: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+0000ec40: 2020 2020 2020 2020 2020 7265 7475 726e            return
+0000ec50: 204e 6f6e 652c 204e 6f6e 650a 2020 2020   None, None.    
+0000ec60: 2020 2020 6966 2065 6e74 6572 203d 3d20      if enter == 
+0000ec70: 313a 0a20 2020 2020 2020 2020 2020 2069  1:.            i
+0000ec80: 6620 6e70 2e6d 6561 6e28 6469 7374 616e  f np.mean(distan
+0000ec90: 6365 7329 203c 3d20 302e 3035 3a0a 2020  ces) <= 0.05:.  
+0000eca0: 2020 2020 2020 2020 2020 2020 2020 7265                re
+0000ecb0: 7475 726e 2031 2e30 0a20 2020 2020 2020  turn 1.0.       
+0000ecc0: 2020 2020 2069 6620 6e70 2e6d 6561 6e28       if np.mean(
+0000ecd0: 6469 7374 616e 6365 7329 203d 3d20 302e  distances) == 0.
+0000ece0: 303a 0a20 2020 2020 2020 2020 2020 2020  0:.             
+0000ecf0: 2020 2072 6574 7572 6e20 312e 300a 2020     return 1.0.  
+0000ed00: 2020 2020 2020 2020 2020 7265 7475 726e            return
+0000ed10: 2073 636f 7265 0a20 2020 2020 2020 2065   score.        e
+0000ed20: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+0000ed30: 2072 6574 7572 6e20 4e6f 6e65 2c20 4e6f   return None, No
+0000ed40: 6e65 0a0a 2020 2020 6465 6620 656e 7665  ne..    def enve
+0000ed50: 6c6f 7065 5f73 636f 7265 280a 2020 2020  lope_score(.    
+0000ed60: 2020 2020 2020 2020 7365 6c66 2c0a 2020          self,.  
+0000ed70: 2020 2020 2020 2020 2020 6d61 705f 7461            map_ta
+0000ed80: 7267 6574 2c0a 2020 2020 2020 2020 2020  rget,.          
+0000ed90: 2020 7072 696d 6172 795f 626f 756e 6461    primary_bounda
+0000eda0: 7279 2c0a 2020 2020 2020 2020 2020 2020  ry,.            
+0000edb0: 7374 7275 6374 7572 655f 696e 7374 616e  structure_instan
+0000edc0: 6365 2c0a 2020 2020 2020 2020 2020 2020  ce,.            
+0000edd0: 6e6f 726d 3d54 7275 652c 0a20 2020 2020  norm=True,.     
+0000ede0: 2020 2020 2020 2029 3a0a 2020 2020 2020         ):.      
+0000edf0: 2020 2222 220a 2020 2020 2020 2020 4361    """.        Ca
+0000ee00: 6c63 756c 6174 6520 7468 6520 656e 7665  lculate the enve
+0000ee10: 6c6f 7065 2073 636f 7265 2062 6574 7765  lope score betwe
+0000ee20: 656e 2061 2074 6172 6765 7420 4d61 7020  en a target Map 
+0000ee30: 616e 6420 6120 5374 7275 6374 7572 650a  and a Structure.
+0000ee40: 2020 2020 2020 2020 496e 7374 616e 6365          Instance
+0000ee50: 732e 0a0a 2020 2020 2020 2020 4172 6775  s...        Argu
+0000ee60: 6d65 6e74 733a 0a20 2020 2020 2020 2020  ments:.         
+0000ee70: 2020 206d 6170 5f74 6172 6765 743a 2054     map_target: T
+0000ee80: 6172 6765 7420 4d61 7020 496e 7374 616e  arget Map Instan
+0000ee90: 6365 2e0a 2020 2020 2020 2020 2020 2020  ce..            
+0000eea0: 7072 696d 6172 795f 626f 756e 6461 7279  primary_boundary
+0000eeb0: 3a20 5661 6c75 6520 7370 6563 6966 6965  : Value specifie
+0000eec0: 6420 6973 2063 616c 6375 6c61 7465 6420  d is calculated 
+0000eed0: 7769 7468 0a20 2020 2020 2020 2020 2020  with.           
+0000eee0: 2020 2020 2070 7269 6d61 7279 5f62 6f75       primary_bou
+0000eef0: 6e64 6172 7920 6f66 2074 6865 206d 6170  ndary of the map
+0000ef00: 206f 626a 6563 742e 0a20 2020 2020 2020   object..       
+0000ef10: 2020 2020 2073 7472 7563 7475 7265 5f69       structure_i
+0000ef20: 6e73 7461 6e63 653a 204d 6f64 656c 2073  nstance: Model s
+0000ef30: 7472 7563 7475 7265 2069 6e73 7461 6e63  tructure instanc
+0000ef40: 652e 0a20 2020 2020 2020 2020 2020 206e  e..            n
+0000ef50: 6f72 6d3a 204e 6f72 6d61 6c69 7365 2074  orm: Normalise t
+0000ef60: 6865 2073 636f 7265 2062 6574 7765 656e  he score between
+0000ef70: 2030 2061 6e64 2031 2069 6620 5472 7565   0 and 1 if True
+0000ef80: 2e0a 0a20 2020 2020 2020 2052 6574 7572  ...        Retur
+0000ef90: 6e73 3a0a 2020 2020 2020 2020 2020 2020  ns:.            
+0000efa0: 456e 7665 6c6f 7065 2073 636f 7265 2c20  Envelope score, 
+0000efb0: 6e6f 726d 616c 6973 6564 2062 6574 7765  normalised betwe
+0000efc0: 656e 2030 2061 6e64 2031 2069 6620 6e6f  en 0 and 1 if no
+0000efd0: 726d 2069 7320 5472 7565 0a0a 2020 2020  rm is True..    
+0000efe0: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
+0000eff0: 6269 6e4d 6170 203d 206d 6170 5f74 6172  binMap = map_tar
+0000f000: 6765 742e 6d61 6b65 5f62 696e 5f6d 6170  get.make_bin_map
+0000f010: 2870 7269 6d61 7279 5f62 6f75 6e64 6172  (primary_boundar
+0000f020: 7929 0a20 2020 2020 2020 206d 6178 5f73  y).        max_s
+0000f030: 636f 7265 203d 2066 6c6f 6174 282d 3220  core = float(-2 
+0000f040: 2a20 6e70 2e73 756d 2862 696e 4d61 702e  * np.sum(binMap.
+0000f050: 6675 6c6c 4d61 7029 290a 2020 2020 2020  fullMap)).      
+0000f060: 2020 6d69 6e5f 7363 6f72 6520 3d20 666c    min_score = fl
+0000f070: 6f61 7428 6e70 2e73 756d 2862 696e 4d61  oat(np.sum(binMa
+0000f080: 702e 6675 6c6c 4d61 7029 2d32 202a 206e  p.fullMap)-2 * n
+0000f090: 702e 7375 6d28 6269 6e4d 6170 2e66 756c  p.sum(binMap.ful
+0000f0a0: 6c4d 6170 2b31 2929 0a0a 2020 2020 2020  lMap+1))..      
+0000f0b0: 2020 626c 7572 7265 7220 3d20 5374 7275    blurrer = Stru
+0000f0c0: 6374 7572 6542 6c75 7272 6572 2829 0a20  ctureBlurrer(). 
+0000f0d0: 2020 2020 2020 2073 7472 7563 745f 6269         struct_bi
+0000f0e0: 6e4d 6170 203d 2062 6c75 7272 6572 2e6d  nMap = blurrer.m
+0000f0f0: 616b 655f 6174 6f6d 5f6f 7665 726c 6179  ake_atom_overlay
+0000f100: 5f6d 6170 3128 0a20 2020 2020 2020 2020  _map1(.         
+0000f110: 2020 206d 6170 5f74 6172 6765 742c 0a20     map_target,. 
+0000f120: 2020 2020 2020 2020 2020 2073 7472 7563             struc
+0000f130: 7475 7265 5f69 6e73 7461 6e63 650a 2020  ture_instance.  
+0000f140: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+0000f150: 6772 6964 203d 2073 7472 7563 745f 6269  grid = struct_bi
+0000f160: 6e4d 6170 2e67 6574 5f70 6f73 2830 2e39  nMap.get_pos(0.9
+0000f170: 2c20 312e 3129 0a20 2020 2020 2020 2066  , 1.1).        f
+0000f180: 6f72 2078 2c20 792c 207a 2069 6e20 6772  or x, y, z in gr
+0000f190: 6964 3a0a 2020 2020 2020 2020 2020 2020  id:.            
+0000f1a0: 6720 3d20 6269 6e4d 6170 5b7a 5d5b 795d  g = binMap[z][y]
+0000f1b0: 5b78 5d0a 2020 2020 2020 2020 2020 2020  [x].            
+0000f1c0: 6966 2067 203d 3d20 2d31 3a0a 2020 2020  if g == -1:.    
+0000f1d0: 2020 2020 2020 2020 2020 2020 6269 6e4d              binM
+0000f1e0: 6170 5b7a 5d5b 795d 5b78 5d20 3d20 320a  ap[z][y][x] = 2.
+0000f1f0: 2020 2020 2020 2020 2020 2020 656c 6966              elif
+0000f200: 2067 203d 3d20 303a 0a20 2020 2020 2020   g == 0:.       
+0000f210: 2020 2020 2020 2020 2062 696e 4d61 705b           binMap[
+0000f220: 7a5d 5b79 5d5b 785d 203d 202d 320a 2020  z][y][x] = -2.  
+0000f230: 2020 2020 2020 7363 6f72 6520 3d20 666c        score = fl
+0000f240: 6f61 7428 6e70 2e73 756d 2862 696e 4d61  oat(np.sum(binMa
+0000f250: 702e 6675 6c6c 4d61 7029 290a 2020 2020  p.fullMap)).    
+0000f260: 2020 2020 6966 206e 6f72 6d3a 0a20 2020      if norm:.   
+0000f270: 2020 2020 2020 2020 206e 6f72 6d5f 7363           norm_sc
+0000f280: 6f72 6520 3d20 666c 6f61 7428 2873 636f  ore = float((sco
+0000f290: 7265 2d6d 696e 5f73 636f 7265 2920 2f20  re-min_score) / 
+0000f2a0: 286d 6178 5f73 636f 7265 2d6d 696e 5f73  (max_score-min_s
+0000f2b0: 636f 7265 2929 0a20 2020 2020 2020 2020  core)).         
+0000f2c0: 2020 2072 6574 7572 6e20 6e6f 726d 5f73     return norm_s
+0000f2d0: 636f 7265 0a20 2020 2020 2020 2065 6c73  core.        els
+0000f2e0: 653a 0a20 2020 2020 2020 2020 2020 2072  e:.            r
+0000f2f0: 6574 7572 6e20 7363 6f72 650a 0a20 2020  eturn score..   
+0000f300: 2064 6566 2065 6e76 656c 6f70 655f 7363   def envelope_sc
+0000f310: 6f72 655f 6d61 7028 0a20 2020 2020 2020  ore_map(.       
+0000f320: 2020 2020 2073 656c 662c 0a20 2020 2020       self,.     
+0000f330: 2020 2020 2020 206d 6170 5f74 6172 6765         map_targe
+0000f340: 742c 0a20 2020 2020 2020 2020 2020 206d  t,.            m
+0000f350: 6170 5f70 726f 6265 2c0a 2020 2020 2020  ap_probe,.      
+0000f360: 2020 2020 2020 6d61 705f 7461 7267 6574        map_target
+0000f370: 5f74 6872 6573 686f 6c64 3d30 2c0a 2020  _threshold=0,.  
+0000f380: 2020 2020 2020 2020 2020 6d61 705f 7072            map_pr
+0000f390: 6f62 655f 7468 7265 7368 6f6c 643d 302c  obe_threshold=0,
+0000f3a0: 0a20 2020 2020 2020 2020 2020 206e 6f72  .            nor
+0000f3b0: 6d3d 5472 7565 2c0a 2020 2020 293a 0a20  m=True,.    ):. 
+0000f3c0: 2020 2020 2020 2022 2222 4361 6c63 756c         """Calcul
+0000f3d0: 6174 6520 7468 6520 656e 7665 6c6f 7065  ate the envelope
+0000f3e0: 2073 636f 7265 2062 6574 7765 656e 2074   score between t
+0000f3f0: 776f 206d 6170 730a 0a20 2020 2020 2020  wo maps..       
+0000f400: 2041 7267 756d 656e 7473 3a0a 2020 2020   Arguments:.    
+0000f410: 2020 2020 2020 2020 6d61 705f 7461 7267          map_targ
+0000f420: 6574 2c20 6d61 705f 7072 6f62 653a 204d  et, map_probe: M
+0000f430: 6170 2069 6e73 7461 6e63 6520 746f 2063  ap instance to c
+0000f440: 6f6d 7061 7265 2e0a 2020 2020 2020 2020  ompare..        
+0000f450: 2020 2020 6d61 705f 7461 7267 6574 5f74      map_target_t
+0000f460: 6872 6573 686f 6c64 2c20 6d61 705f 7072  hreshold, map_pr
+0000f470: 6f62 655f 7468 7265 7368 6f6c 643a 0a20  obe_threshold:. 
+0000f480: 2020 2020 2020 2020 2020 2020 2020 204d                 M
+0000f490: 6170 2074 6872 6573 686f 6c64 2074 6861  ap threshold tha
+0000f4a0: 7420 6465 6669 6e65 7320 7468 6520 656e  t defines the en
+0000f4b0: 7665 6c6f 7065 2c20 6f72 2073 7572 6661  velope, or surfa
+0000f4c0: 6365 2c20 6f66 2074 6865 0a20 2020 2020  ce, of the.     
+0000f4d0: 2020 2020 2020 2020 2020 206d 6170 2e20             map. 
+0000f4e0: 5769 6c6c 2062 6520 6175 746f 6d61 7469  Will be automati
+0000f4f0: 6361 6c6c 7920 6361 6c63 756c 6174 6564  cally calculated
+0000f500: 2075 7369 6e67 0a20 2020 2020 2020 2020   using.         
+0000f510: 2020 2020 2020 203a 6d65 7468 3a60 7365         :meth:`se
+0000f520: 6c66 2e63 616c 6375 6c61 7465 5f6d 6170  lf.calculate_map
+0000f530: 5f74 6872 6573 686f 6c64 203c 5445 4d50  _threshold <TEMP
+0000f540: 792e 7072 6f74 6569 6e2e 7363 6f72 696e  y.protein.scorin
+0000f550: 675f 6675 6e63 7469 6f6e 732e 5363 6f72  g_functions.Scor
+0000f560: 696e 6746 756e 6374 696f 6e73 2e63 616c  ingFunctions.cal
+0000f570: 6375 6c61 7465 5f6d 6170 5f74 6872 6573  culate_map_thres
+0000f580: 686f 6c64 3e60 0a20 2020 2020 2020 2020  hold>`.         
+0000f590: 2020 2020 2020 2069 6620 6e6f 7420 7370         if not sp
+0000f5a0: 6563 6966 6965 642e 0a20 2020 2020 2020  ecified..       
+0000f5b0: 2020 2020 206e 6f72 6d3a 204e 6f72 6d61       norm: Norma
+0000f5c0: 6c69 7365 2074 6865 2073 636f 7265 2062  lise the score b
+0000f5d0: 6574 7765 656e 2030 2061 6e64 2031 2069  etween 0 and 1 i
+0000f5e0: 6620 5472 7565 2e0a 0a20 2020 2020 2020  f True...       
+0000f5f0: 2052 6574 7572 6e73 3a0a 2020 2020 2020   Returns:.      
+0000f600: 2020 2020 2020 456e 7665 6c6f 7065 2073        Envelope s
+0000f610: 636f 7265 2c20 6e6f 726d 616c 6973 6564  core, normalised
+0000f620: 2062 6574 7765 656e 2030 2061 6e64 2031   between 0 and 1
+0000f630: 2069 6620 6e6f 726d 2069 7320 5472 7565   if norm is True
+0000f640: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
+0000f650: 2020 2020 2069 6620 7365 6c66 2e6d 6170       if self.map
+0000f660: 436f 6d70 6172 6973 6f6e 286d 6170 5f74  Comparison(map_t
+0000f670: 6172 6765 742c 206d 6170 5f70 726f 6265  arget, map_probe
+0000f680: 293a 0a20 2020 2020 2020 2020 2020 2069  ):.            i
+0000f690: 6620 6d61 705f 7461 7267 6574 5f74 6872  f map_target_thr
+0000f6a0: 6573 686f 6c64 203d 3d20 303a 0a20 2020  eshold == 0:.   
+0000f6b0: 2020 2020 2020 2020 2020 2020 206d 6170               map
+0000f6c0: 5f74 6172 6765 745f 7468 7265 7368 6f6c  _target_threshol
+0000f6d0: 6420 3d20 7365 6c66 2e63 616c 6375 6c61  d = self.calcula
+0000f6e0: 7465 5f6d 6170 5f74 6872 6573 686f 6c64  te_map_threshold
+0000f6f0: 286d 6170 5f74 6172 6765 7429 0a20 2020  (map_target).   
+0000f700: 2020 2020 2020 2020 2069 6620 6d61 705f           if map_
+0000f710: 7072 6f62 655f 7468 7265 7368 6f6c 6420  probe_threshold 
+0000f720: 3d3d 2030 3a0a 2020 2020 2020 2020 2020  == 0:.          
+0000f730: 2020 2020 2020 6d61 705f 7072 6f62 655f        map_probe_
+0000f740: 7468 7265 7368 6f6c 6420 3d20 7365 6c66  threshold = self
+0000f750: 2e63 616c 6375 6c61 7465 5f6d 6170 5f74  .calculate_map_t
+0000f760: 6872 6573 686f 6c64 286d 6170 5f70 726f  hreshold(map_pro
+0000f770: 6265 290a 0a20 2020 2020 2020 2062 696e  be)..        bin
+0000f780: 4d61 7020 3d20 6d61 705f 7461 7267 6574  Map = map_target
+0000f790: 2e6d 616b 655f 6269 6e5f 6d61 7028 6d61  .make_bin_map(ma
+0000f7a0: 705f 7461 7267 6574 5f74 6872 6573 686f  p_target_thresho
+0000f7b0: 6c64 290a 2020 2020 2020 2020 6d61 785f  ld).        max_
+0000f7c0: 7363 6f72 6520 3d20 666c 6f61 7428 2d32  score = float(-2
+0000f7d0: 202a 206e 702e 7375 6d28 6269 6e4d 6170   * np.sum(binMap
+0000f7e0: 2e66 756c 6c4d 6170 2929 0a20 2020 2020  .fullMap)).     
+0000f7f0: 2020 206d 696e 5f73 636f 7265 203d 2066     min_score = f
+0000f800: 6c6f 6174 280a 2020 2020 2020 2020 2020  loat(.          
+0000f810: 2020 6e70 2e73 756d 2862 696e 4d61 702e    np.sum(binMap.
+0000f820: 6675 6c6c 4d61 7029 2d32 202a 206e 702e  fullMap)-2 * np.
+0000f830: 7375 6d28 6269 6e4d 6170 2e66 756c 6c4d  sum(binMap.fullM
+0000f840: 6170 202b 2031 290a 2020 2020 2020 2020  ap + 1).        
+0000f850: 290a 2020 2020 2020 2020 7374 7275 6374  ).        struct
+0000f860: 5f62 696e 4d61 7020 3d20 6d61 705f 7072  _binMap = map_pr
+0000f870: 6f62 652e 6d61 6b65 5f62 696e 5f6d 6170  obe.make_bin_map
+0000f880: 286d 6170 5f70 726f 6265 5f74 6872 6573  (map_probe_thres
+0000f890: 686f 6c64 290a 2020 2020 2020 2020 6e65  hold).        ne
+0000f8a0: 774d 6170 203d 2062 696e 4d61 702e 6675  wMap = binMap.fu
+0000f8b0: 6c6c 4d61 7020 2b20 3220 2a20 7374 7275  llMap + 2 * stru
+0000f8c0: 6374 5f62 696e 4d61 702e 6675 6c6c 4d61  ct_binMap.fullMa
+0000f8d0: 700a 2020 2020 2020 2020 6869 7374 5f61  p.        hist_a
+0000f8e0: 7272 6179 203d 206e 702e 6869 7374 6f67  rray = np.histog
+0000f8f0: 7261 6d28 6e65 774d 6170 2c20 3429 0a20  ram(newMap, 4). 
+0000f900: 2020 2020 2020 2073 636f 7265 203d 2028         score = (
+0000f910: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000f920: 2032 202a 0a20 2020 2020 2020 2020 2020   2 *.           
+0000f930: 2020 2020 2068 6973 745f 6172 7261 795b       hist_array[
+0000f940: 305d 5b30 5d20 2d0a 2020 2020 2020 2020  0][0] -.        
+0000f950: 2020 2020 2020 2020 2832 202a 2028 6869          (2 * (hi
+0000f960: 7374 5f61 7272 6179 5b30 5d5b 315d 2929  st_array[0][1]))
+0000f970: 202d 0a20 2020 2020 2020 2020 2020 2020   -.             
+0000f980: 2020 2028 6869 7374 5f61 7272 6179 5b30     (hist_array[0
+0000f990: 5d5b 325d 290a 2020 2020 2020 2020 290a  ][2]).        ).
+0000f9a0: 2020 2020 2020 2020 6966 206e 6f72 6d3a          if norm:
+0000f9b0: 0a20 2020 2020 2020 2020 2020 206e 6f72  .            nor
+0000f9c0: 6d5f 7363 6f72 6520 3d20 666c 6f61 7428  m_score = float(
+0000f9d0: 2873 636f 7265 202d 206d 696e 5f73 636f  (score - min_sco
+0000f9e0: 7265 2929 202f 2028 6d61 785f 7363 6f72  re)) / (max_scor
+0000f9f0: 6520 2d20 6d69 6e5f 7363 6f72 6529 0a20  e - min_score). 
+0000fa00: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+0000fa10: 6e20 6e6f 726d 5f73 636f 7265 0a20 2020  n norm_score.   
+0000fa20: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+0000fa30: 2020 2020 2020 2072 6574 7572 6e20 7363         return sc
+0000fa40: 6f72 650a 0a20 2020 2064 6566 205f 7065  ore..    def _pe
+0000fa50: 7263 656e 745f 6f76 6572 6c61 7028 0a20  rcent_overlap(. 
+0000fa60: 2020 2020 2020 2020 2020 2073 656c 662c             self,
+0000fa70: 0a20 2020 2020 2020 2020 2020 206d 6170  .            map
+0000fa80: 5f74 6172 6765 742c 0a20 2020 2020 2020  _target,.       
+0000fa90: 2020 2020 206d 6170 5f70 726f 6265 2c0a       map_probe,.
+0000faa0: 2020 2020 2020 2020 2020 2020 6d61 705f              map_
+0000fab0: 7461 7267 6574 5f74 6872 6573 686f 6c64  target_threshold
+0000fac0: 2c0a 2020 2020 2020 2020 2020 2020 6d61  ,.            ma
+0000fad0: 705f 7072 6f62 655f 7468 7265 7368 6f6c  p_probe_threshol
+0000fae0: 642c 0a20 2020 2020 2020 2020 2020 2066  d,.            f
+0000faf0: 6c61 6773 697a 653d 302c 0a20 2020 2029  lagsize=0,.    )
+0000fb00: 3a0a 2020 2020 2020 2020 2222 2243 616c  :.        """Cal
+0000fb10: 6375 6c61 7465 2074 6865 2066 7261 6374  culate the fract
+0000fb20: 696f 6e20 6f66 206f 7665 726c 6170 2062  ion of overlap b
+0000fb30: 6574 7765 656e 2074 776f 206d 6170 2067  etween two map g
+0000fb40: 7269 6473 2e0a 0a20 2020 2020 2020 2041  rids...        A
+0000fb50: 7267 756d 656e 7473 3a0a 2020 2020 2020  rguments:.      
+0000fb60: 2020 2020 2020 6d61 705f 7461 7267 6574        map_target
+0000fb70: 2c20 6d61 705f 7072 6f62 653a 204d 6170  , map_probe: Map
+0000fb80: 2069 6e73 7461 6e63 6520 746f 2063 6f6d   instance to com
+0000fb90: 7061 7265 2e0a 2020 2020 2020 2020 2020  pare..          
+0000fba0: 2020 6d61 705f 7461 7267 6574 5f74 6872    map_target_thr
+0000fbb0: 6573 686f 6c64 2c20 6d61 705f 7072 6f62  eshold, map_prob
+0000fbc0: 655f 7468 7265 7368 6f6c 643a 0a20 2020  e_threshold:.   
+0000fbd0: 2020 2020 2020 2020 2020 2020 206d 6170               map
+0000fbe0: 2063 6f6e 746f 7572 2074 6872 6573 686f   contour thresho
+0000fbf0: 6c64 7320 666f 7220 6d61 705f 7461 7267  lds for map_targ
+0000fc00: 6574 2061 6e64 206d 6170 5f70 726f 6265  et and map_probe
+0000fc10: 2e0a 2020 2020 2020 2020 5265 7475 726e  ..        Return
+0000fc20: 3a0a 2020 2020 2020 2020 2020 2020 5065  :.            Pe
+0000fc30: 7263 656e 7420 6f76 6572 6c61 7020 7769  rcent overlap wi
+0000fc40: 7468 2072 6573 7065 6374 2074 6f20 736d  th respect to sm
+0000fc50: 616c 6c65 7220 6772 6964 0a20 2020 2020  aller grid.     
+0000fc60: 2020 2022 2222 0a20 2020 2020 2020 2069     """.        i
+0000fc70: 6620 7365 6c66 2e6d 6170 436f 6d70 6172  f self.mapCompar
+0000fc80: 6973 6f6e 286d 6170 5f74 6172 6765 742c  ison(map_target,
+0000fc90: 206d 6170 5f70 726f 6265 293a 0a20 2020   map_probe):.   
+0000fca0: 2020 2020 2020 2020 2062 696e 6d61 7031           binmap1
+0000fcb0: 203d 206d 6170 5f74 6172 6765 742e 6675   = map_target.fu
+0000fcc0: 6c6c 4d61 7020 3e20 666c 6f61 7428 6d61  llMap > float(ma
+0000fcd0: 705f 7461 7267 6574 5f74 6872 6573 686f  p_target_thresho
+0000fce0: 6c64 290a 2020 2020 2020 2020 2020 2020  ld).            
+0000fcf0: 6269 6e6d 6170 3220 3d20 6d61 705f 7072  binmap2 = map_pr
+0000fd00: 6f62 652e 6675 6c6c 4d61 7020 3e20 666c  obe.fullMap > fl
+0000fd10: 6f61 7428 6d61 705f 7072 6f62 655f 7468  oat(map_probe_th
+0000fd20: 7265 7368 6f6c 6429 0a20 2020 2020 2020  reshold).       
+0000fd30: 2020 2020 206d 696e 696d 203d 206c 656e       minim = len
+0000fd40: 286d 6170 5f74 6172 6765 742e 6675 6c6c  (map_target.full
+0000fd50: 4d61 705b 6269 6e6d 6170 315d 290a 2020  Map[binmap1]).  
+0000fd60: 2020 2020 2020 2020 2020 6966 206c 656e            if len
+0000fd70: 286d 6170 5f70 726f 6265 2e66 756c 6c4d  (map_probe.fullM
+0000fd80: 6170 5b62 696e 6d61 7032 5d29 203c 206d  ap[binmap2]) < m
+0000fd90: 696e 696d 3a0a 2020 2020 2020 2020 2020  inim:.          
+0000fda0: 2020 2020 2020 6d69 6e69 6d20 3d20 6c65        minim = le
+0000fdb0: 6e28 6d61 705f 7072 6f62 652e 6675 6c6c  n(map_probe.full
+0000fdc0: 4d61 705b 6269 6e6d 6170 325d 290a 2020  Map[binmap2]).  
+0000fdd0: 2020 2020 2020 2020 2020 6d61 736b 6d61            maskma
+0000fde0: 7020 3d20 2862 696e 6d61 7031 202a 2062  p = (binmap1 * b
+0000fdf0: 696e 6d61 7032 2920 3e20 300a 2020 2020  inmap2) > 0.    
+0000fe00: 2020 2020 2020 2020 6966 2066 6c61 6773          if flags
+0000fe10: 697a 6520 3d3d 2031 3a0a 2020 2020 2020  ize == 1:.      
+0000fe20: 2020 2020 2020 2020 2020 7265 7475 726e            return
+0000fe30: 206e 702e 7375 6d28 6d61 736b 6d61 7029   np.sum(maskmap)
+0000fe40: 2c20 6e70 2e73 756d 2862 696e 6d61 7031  , np.sum(binmap1
+0000fe50: 292c 206e 702e 7375 6d28 6269 6e6d 6170  ), np.sum(binmap
+0000fe60: 3229 0a20 2020 2020 2020 2020 2020 2069  2).            i
+0000fe70: 6620 6e6f 7420 6d69 6e69 6d20 3d3d 2030  f not minim == 0
+0000fe80: 2e30 3a0a 2020 2020 2020 2020 2020 2020  .0:.            
+0000fe90: 2020 2020 7265 7475 726e 2066 6c6f 6174      return float
+0000fea0: 286c 656e 286d 6170 5f74 6172 6765 742e  (len(map_target.
+0000feb0: 6675 6c6c 4d61 705b 6d61 736b 6d61 705d  fullMap[maskmap]
+0000fec0: 2929 2f6d 696e 696d 0a20 2020 2020 2020  ))/minim.       
+0000fed0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+0000fee0: 2020 2020 2020 2020 2020 2070 7269 6e74             print
+0000fef0: 2827 4368 6563 6b20 6d61 7020 636f 6e74  ('Check map cont
+0000ff00: 6f75 7221 2127 290a 2020 2020 2020 2020  our!!').        
+0000ff10: 2020 2020 2020 2020 7265 7475 726e 2030          return 0
+0000ff20: 2e30 0a20 2020 2020 2020 2065 6c73 653a  .0.        else:
+0000ff30: 0a20 2020 2020 2020 2020 2020 2070 7269  .            pri
+0000ff40: 6e74 2827 4040 4020 4d61 7073 2063 6f75  nt('@@@ Maps cou
+0000ff50: 6c64 206e 6f74 2062 6520 6d61 7463 6865  ld not be matche
+0000ff60: 6427 290a 2020 2020 2020 2020 2020 2020  d').            
+0000ff70: 7265 7475 726e 202d 312e 300a 0a20 2020  return -1.0..   
+0000ff80: 2064 6566 2053 4343 4328 0a20 2020 2020   def SCCC(.     
+0000ff90: 2020 2020 2020 2073 656c 662c 0a20 2020         self,.   
+0000ffa0: 2020 2020 2020 2020 206d 6170 5f74 6172           map_tar
+0000ffb0: 6765 742c 0a20 2020 2020 2020 2020 2020  get,.           
+0000ffc0: 2072 6573 6f6c 7574 696f 6e5f 6465 6e73   resolution_dens
+0000ffd0: 4d61 702c 0a20 2020 2020 2020 2020 2020  Map,.           
+0000ffe0: 2073 6967 6d61 5f6d 6170 2c0a 2020 2020   sigma_map,.    
+0000fff0: 2020 2020 2020 2020 7374 7275 6374 7572          structur
+00010000: 655f 696e 7374 616e 6365 2c0a 2020 2020  e_instance,.    
+00010010: 2020 2020 2020 2020 7269 6769 645f 626f          rigid_bo
+00010020: 6479 5f73 7472 7563 7475 7265 2c0a 2020  dy_structure,.  
+00010030: 2020 2020 2020 2020 2020 7772 6974 653d            write=
+00010040: 4661 6c73 652c 0a20 2020 2020 2020 2020  False,.         
+00010050: 2020 2063 5f6d 6f64 653d 4661 6c73 652c     c_mode=False,
+00010060: 0a20 2020 2029 3a0a 2020 2020 2020 2020  .    ):.        
+00010070: 2222 2243 616c 6375 6c61 7465 206c 6f63  """Calculate loc
+00010080: 616c 2063 726f 7373 2d63 6f72 7265 6c61  al cross-correla
+00010090: 7469 6f6e 2066 6f72 2061 2073 6567 6d65  tion for a segme
+000100a0: 6e74 206f 6620 6120 7072 6f74 6569 6e20  nt of a protein 
+000100b0: 6d6f 6465 6c0a 0a20 2020 2020 2020 2053  model..        S
+000100c0: 6567 6d65 6e74 7320 6172 6520 6465 6669  egments are defi
+000100d0: 6e65 6420 7573 696e 6720 6120 7269 6769  ned using a rigi
+000100e0: 642d 626f 6479 2073 7472 7563 7475 7265  d-body structure
+000100f0: 2069 6e73 7461 6e63 652c 2077 6869 6368   instance, which
+00010100: 2063 616e 0a20 2020 2020 2020 2062 6520   can.        be 
+00010110: 6765 6e65 7261 7465 6420 7573 696e 6720  generated using 
+00010120: 6052 4942 4649 4e44 203c 6874 7470 733a  `RIBFIND <https:
+00010130: 2f2f 7269 6266 696e 642e 6973 6d62 2e6c  //ribfind.ismb.l
+00010140: 6f6e 2e61 632e 756b 2f3e 605f 2e0a 2020  on.ac.uk/>`_..  
+00010150: 2020 2020 2020 5468 6520 4343 4320 6973        The CCC is
+00010160: 2063 616c 6375 6c61 7465 6420 7573 696e   calculated usin
+00010170: 670a 2020 2020 2020 2020 3a6d 6574 683a  g.        :meth:
+00010180: 6043 4343 5f6d 6170 203c 5445 4d50 792e  `CCC_map <TEMPy.
+00010190: 7072 6f74 6569 6e2e 7363 6f72 696e 675f  protein.scoring_
+000101a0: 6675 6e63 7469 6f6e 732e 5363 6f72 696e  functions.Scorin
+000101b0: 6746 756e 6374 696f 6e73 2e43 4343 5f6d  gFunctions.CCC_m
+000101c0: 6170 3e60 2e0a 0a20 2020 2020 2020 2049  ap>`...        I
+000101d0: 6d70 6c65 6d65 6e74 6174 696f 6e20 6469  mplementation di
+000101e0: 7363 7573 7365 6420 696e 206d 6f72 6520  scussed in more 
+000101f0: 6465 7461 696c 2061 7420 7468 6520 666f  detail at the fo
+00010200: 6c6c 6f77 696e 6720 7265 6665 7265 6e63  llowing referenc
+00010210: 653a 0a20 2020 2020 2020 2020 2020 202a  e:.            *
+00010220: 2060 5061 6e64 7572 616e 6761 6e20 6574   `Pandurangan et
+00010230: 2061 6c2e 2c20 4a20 5374 7275 6374 2042   al., J Struct B
+00010240: 696f 6c2e 2032 3031 3320 4465 6320 3132  iol. 2013 Dec 12
+00010250: 203c 6874 7470 733a 2f2f 7777 772e 6e63   <https://www.nc
+00010260: 6269 2e6e 6c6d 2e6e 6968 2e67 6f76 2f70  bi.nlm.nih.gov/p
+00010270: 6d63 2f61 7274 6963 6c65 732f 504d 4333  mc/articles/PMC3
+00010280: 3938 3839 3232 2f3e 605f 0a0a 2020 2020  988922/>`_..    
+00010290: 2020 2020 4172 6773 3a0a 2020 2020 2020      Args:.      
+000102a0: 2020 2020 2020 6d61 705f 7461 7267 6574        map_target
+000102b0: 3a20 4d61 7020 496e 7374 616e 6365 2e0a  : Map Instance..
+000102c0: 2020 2020 2020 2020 2020 2020 7265 736f              reso
+000102d0: 6c75 7469 6f6e 5f64 656e 734d 6170 3a20  lution_densMap: 
+000102e0: 5265 736f 6c75 7469 6f6e 206f 6620 7468  Resolution of th
+000102f0: 6520 696e 7075 7420 6d61 702e 0a20 2020  e input map..   
+00010300: 2020 2020 2020 2020 2073 6967 6d61 5f6d           sigma_m
+00010310: 6170 3a20 5061 7261 6d65 7465 7220 6e65  ap: Parameter ne
+00010320: 6564 2066 6f72 2053 7472 7563 7475 7265  ed for Structure
+00010330: 2042 6c75 7272 6572 2e20 4675 6c6c 2065   Blurrer. Full e
+00010340: 7870 6c61 6e61 7469 6f6e 0a20 2020 2020  xplanation.     
+00010350: 2020 2020 2020 2020 2020 203a 7265 663a             :ref:
+00010360: 6068 6572 653c 4e6f 7465 206f 6e20 7265  `here<Note on re
+00010370: 616c 2073 7061 6365 2062 6c75 7272 696e  al space blurrin
+00010380: 673a 3e60 0a20 2020 2020 2020 2020 2020  g:>`.           
+00010390: 2073 7472 7563 7475 7265 5f69 6e73 7461   structure_insta
+000103a0: 6e63 653a 2053 7472 7563 7475 7265 2069  nce: Structure i
+000103b0: 6e73 7461 6e63 6520 746f 2063 6f6d 7061  nstance to compa
+000103c0: 7265 0a20 2020 2020 2020 2020 2020 2072  re.            r
+000103d0: 6967 6964 5f62 6f64 795f 7374 7275 6374  igid_body_struct
+000103e0: 7572 653a 2052 6967 6964 2d62 6f64 7920  ure: Rigid-body 
+000103f0: 5374 7275 6374 7572 6520 696e 7374 616e  Structure instan
+00010400: 6365 2074 6861 7420 6465 6669 6e65 730a  ce that defines.
+00010410: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010420: 7468 6520 7365 676d 656e 742e 0a20 2020  the segment..   
+00010430: 2020 2020 2020 2020 2077 7269 7465 3a20           write: 
+00010440: 4966 2054 7275 652c 2061 2073 7472 696e  If True, a strin
+00010450: 6720 6973 2072 6574 7572 6e65 6420 7769  g is returned wi
+00010460: 7468 2066 6f72 6d61 7420 3a63 6f64 653a  th format :code:
+00010470: 6066 2753 4343 4320 666f 7220 7365 676d  `f'SCCC for segm
+00010480: 656e 7420 7b53 4343 435f 7363 6f72 657d  ent {SCCC_score}
+00010490: 2760 0a20 2020 2020 2020 2020 2020 2063  '`.            c
+000104a0: 5f6d 6f64 653a 204e 6f20 6c6f 6e67 6572  _mode: No longer
+000104b0: 2069 6e20 7573 650a 2020 2020 2020 2020   in use.        
+000104c0: 5265 7475 726e 733a 0a20 2020 2020 2020  Returns:.       
+000104d0: 2020 2020 2066 6c6f 6174 2069 6620 3a63       float if :c
+000104e0: 6f64 653a 6077 7269 7465 3d46 616c 7365  ode:`write=False
+000104f0: 602c 2065 6c73 6520 7374 7269 6e67 3a0a  `, else string:.
+00010500: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010510: 5343 4343 2053 636f 7265 0a20 2020 2020  SCCC Score.     
+00010520: 2020 2022 2222 0a20 2020 2020 2020 2062     """.        b
+00010530: 6c75 7272 6572 203d 2053 7472 7563 7475  lurrer = Structu
+00010540: 7265 426c 7572 7265 7228 290a 2020 2020  reBlurrer().    
+00010550: 2020 2020 7363 6f72 6572 203d 2053 636f      scorer = Sco
+00010560: 7269 6e67 4675 6e63 7469 6f6e 7328 290a  ringFunctions().
+00010570: 2020 2020 2020 2020 6f75 746c 696e 6520          outline 
+00010580: 3d20 2222 0a20 2020 2020 2020 2072 6573  = "".        res
+00010590: 6f6c 7574 696f 6e5f 6465 6e73 4d61 7020  olution_densMap 
+000105a0: 3d20 666c 6f61 7428 7265 736f 6c75 7469  = float(resoluti
+000105b0: 6f6e 5f64 656e 734d 6170 290a 2020 2020  on_densMap).    
+000105c0: 2020 2020 7768 6f6c 655f 6669 745f 6d61      whole_fit_ma
+000105d0: 7020 3d20 626c 7572 7265 722e 6761 7573  p = blurrer.gaus
+000105e0: 7369 616e 5f62 6c75 7228 0a20 2020 2020  sian_blur(.     
+000105f0: 2020 2020 2020 2073 7472 7563 7475 7265         structure
+00010600: 5f69 6e73 7461 6e63 652c 0a20 2020 2020  _instance,.     
+00010610: 2020 2020 2020 2072 6573 6f6c 7574 696f         resolutio
+00010620: 6e5f 6465 6e73 4d61 702c 0a20 2020 2020  n_densMap,.     
+00010630: 2020 2020 2020 2064 656e 734d 6170 3d6d         densMap=m
+00010640: 6170 5f74 6172 6765 742c 0a20 2020 2020  ap_target,.     
+00010650: 2020 2020 2020 2073 6967 6d61 5f63 6f65         sigma_coe
+00010660: 6666 3d73 6967 6d61 5f6d 6170 2c0a 2020  ff=sigma_map,.  
+00010670: 2020 2020 2020 2020 2020 6e6f 726d 616c            normal
+00010680: 6973 653d 5472 7565 2c0a 2020 2020 2020  ise=True,.      
+00010690: 2020 290a 2020 2020 2020 2020 7369 6d5f    ).        sim_
+000106a0: 6d61 7020 3d20 626c 7572 7265 722e 6761  map = blurrer.ga
+000106b0: 7573 7369 616e 5f62 6c75 7228 0a20 2020  ussian_blur(.   
+000106c0: 2020 2020 2020 2020 2072 6967 6964 5f62           rigid_b
+000106d0: 6f64 795f 7374 7275 6374 7572 652c 0a20  ody_structure,. 
+000106e0: 2020 2020 2020 2020 2020 2072 6573 6f6c             resol
+000106f0: 7574 696f 6e5f 6465 6e73 4d61 702c 0a20  ution_densMap,. 
+00010700: 2020 2020 2020 2020 2020 2064 656e 734d             densM
+00010710: 6170 3d6d 6170 5f74 6172 6765 742c 0a20  ap=map_target,. 
+00010720: 2020 2020 2020 2020 2020 2073 6967 6d61             sigma
+00010730: 5f63 6f65 6666 3d73 6967 6d61 5f6d 6170  _coeff=sigma_map
+00010740: 2c0a 2020 2020 2020 2020 2020 2020 6e6f  ,.            no
+00010750: 726d 616c 6973 653d 5472 7565 2c0a 2020  rmalise=True,.  
+00010760: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+00010770: 6d69 6e44 656e 7320 3d20 7369 6d5f 6d61  minDens = sim_ma
+00010780: 702e 7374 6428 290a 2020 2020 2020 2020  p.std().        
+00010790: 7369 6d5f 6d61 736b 5f61 7272 6179 203d  sim_mask_array =
+000107a0: 2073 696d 5f6d 6170 2e5f 6765 745f 6d61   sim_map._get_ma
+000107b0: 736b 4172 7261 7928 6d69 6e44 656e 7329  skArray(minDens)
+000107c0: 0a20 2020 2020 2020 206d 6173 6b5f 656d  .        mask_em
+000107d0: 4d61 7020 3d20 6d61 705f 7461 7267 6574  Map = map_target
+000107e0: 2e5f 6765 745f 6d61 736b 4d61 7028 7369  ._get_maskMap(si
+000107f0: 6d5f 6d61 736b 5f61 7272 6179 290a 2020  m_mask_array).  
+00010800: 2020 2020 2020 6d61 736b 5f73 696d 4d61        mask_simMa
+00010810: 7020 3d20 7768 6f6c 655f 6669 745f 6d61  p = whole_fit_ma
+00010820: 702e 5f67 6574 5f6d 6173 6b4d 6170 2873  p._get_maskMap(s
+00010830: 696d 5f6d 6173 6b5f 6172 7261 7929 0a20  im_mask_array). 
+00010840: 2020 2020 2020 2073 7365 5f6c 6363 662c         sse_lccf,
+00010850: 206f 7620 3d20 7363 6f72 6572 2e43 4343   ov = scorer.CCC
+00010860: 5f6d 6170 286d 6173 6b5f 656d 4d61 702c  _map(mask_emMap,
+00010870: 206d 6173 6b5f 7369 6d4d 6170 2c20 636d   mask_simMap, cm
+00010880: 6f64 653d 635f 6d6f 6465 290a 2020 2020  ode=c_mode).    
+00010890: 2020 2020 6966 2077 7269 7465 2069 7320      if write is 
+000108a0: 5472 7565 3a0a 2020 2020 2020 2020 2020  True:.          
+000108b0: 2020 6f75 746c 696e 6520 2b3d 2027 5343    outline += 'SC
+000108c0: 4343 2066 6f72 2073 6567 6d65 6e74 2025  CC for segment %
+000108d0: 665c 6e27 2025 2028 7373 655f 6c63 6366  f\n' % (sse_lccf
+000108e0: 290a 2020 2020 2020 2020 2020 2020 7265  ).            re
+000108f0: 7475 726e 206f 7574 6c69 6e65 0a20 2020  turn outline.   
+00010900: 2020 2020 2072 6574 7572 6e20 7373 655f       return sse_
+00010910: 6c63 6366 0a0a 2020 2020 6465 6620 5343  lccf..    def SC
+00010920: 4343 5f4c 4150 280a 2020 2020 2020 2020  CC_LAP(.        
+00010930: 2020 2020 7365 6c66 2c0a 2020 2020 2020      self,.      
+00010940: 2020 2020 2020 6d61 705f 7461 7267 6574        map_target
+00010950: 2c0a 2020 2020 2020 2020 2020 2020 7265  ,.            re
+00010960: 736f 6c75 7469 6f6e 5f64 656e 734d 6170  solution_densMap
+00010970: 2c0a 2020 2020 2020 2020 2020 2020 7369  ,.            si
+00010980: 676d 615f 6d61 702c 0a20 2020 2020 2020  gma_map,.       
+00010990: 2020 2020 2073 7472 7563 7475 7265 5f69       structure_i
+000109a0: 6e73 7461 6e63 652c 0a20 2020 2020 2020  nstance,.       
+000109b0: 2020 2020 2072 6967 6964 5f62 6f64 795f       rigid_body_
+000109c0: 7374 7275 6374 7572 652c 0a20 2020 2020  structure,.     
+000109d0: 2020 2020 2020 2077 7269 7465 3d46 616c         write=Fal
+000109e0: 7365 2c0a 2020 2020 293a 0a20 2020 2020  se,.    ):.     
+000109f0: 2020 2022 2222 4361 6c63 756c 6174 6520     """Calculate 
+00010a00: 7468 6520 4c61 706c 6163 6961 6e20 6669  the Laplacian fi
+00010a10: 6c74 6572 6564 2063 726f 7373 2063 6f72  ltered cross cor
+00010a20: 7265 6c61 7469 6f6e 2066 6f72 2061 2073  relation for a s
+00010a30: 6567 6d65 6e74 206f 660a 2020 2020 2020  egment of.      
+00010a40: 2020 6120 7072 6f74 6569 6e20 6d6f 6465    a protein mode
+00010a50: 6c2e 0a0a 2020 2020 2020 2020 5365 676d  l...        Segm
+00010a60: 656e 7473 2061 7265 2064 6566 696e 6564  ents are defined
+00010a70: 2075 7369 6e67 2061 2072 6967 6964 2d62   using a rigid-b
+00010a80: 6f64 7920 7374 7275 6374 7572 6520 696e  ody structure in
+00010a90: 7374 616e 6365 2c20 7768 6963 6820 6361  stance, which ca
+00010aa0: 6e0a 2020 2020 2020 2020 6265 2067 656e  n.        be gen
+00010ab0: 6572 6174 6564 2075 7369 6e67 2060 5249  erated using `RI
+00010ac0: 4246 494e 4420 3c68 7474 7073 3a2f 2f72  BFIND <https://r
+00010ad0: 6962 6669 6e64 2e69 736d 622e 6c6f 6e2e  ibfind.ismb.lon.
+00010ae0: 6163 2e75 6b2f 3e60 5f2e 0a20 2020 2020  ac.uk/>`_..     
+00010af0: 2020 2053 636f 7265 2063 616c 6375 6c61     Score calcula
+00010b00: 7465 6420 7573 696e 670a 2020 2020 2020  ted using.      
+00010b10: 2020 3a6d 6574 683a 606c 6170 6c61 6365    :meth:`laplace
+00010b20: 5f43 4343 203c 5445 4d50 792e 7072 6f74  _CCC <TEMPy.prot
+00010b30: 6569 6e2e 7363 6f72 696e 675f 6675 6e63  ein.scoring_func
+00010b40: 7469 6f6e 732e 5363 6f72 696e 6746 756e  tions.ScoringFun
+00010b50: 6374 696f 6e73 2e6c 6170 6c61 6365 5f43  ctions.laplace_C
+00010b60: 4343 3e60 0a0a 2020 2020 2020 2020 4172  CC>`..        Ar
+00010b70: 6775 6d65 6e74 733a 0a20 2020 2020 2020  guments:.       
+00010b80: 2020 2020 206d 6170 5f74 6172 6765 743a       map_target:
+00010b90: 204d 6170 2049 6e73 7461 6e63 652e 0a20   Map Instance.. 
+00010ba0: 2020 2020 2020 2020 2020 2072 6573 6f6c             resol
+00010bb0: 7574 696f 6e5f 6465 6e73 4d61 703a 2052  ution_densMap: R
+00010bc0: 6573 6f6c 7574 696f 6e20 6f66 2074 6865  esolution of the
+00010bd0: 206d 6170 2069 6e73 7461 6e63 652e 0a20   map instance.. 
+00010be0: 2020 2020 2020 2020 2020 2073 6967 6d61             sigma
+00010bf0: 5f6d 6170 3a20 5061 7261 6d65 7465 7220  _map: Parameter 
+00010c00: 6e65 6564 2066 6f72 2053 7472 7563 7475  need for Structu
+00010c10: 7265 2042 6c75 7272 6572 2e20 4675 6c6c  re Blurrer. Full
+00010c20: 2065 7870 6c61 6e61 7469 6f6e 0a20 2020   explanation.   
+00010c30: 2020 2020 2020 2020 2020 2020 203a 7265               :re
+00010c40: 663a 6068 6572 653c 4e6f 7465 206f 6e20  f:`here<Note on 
+00010c50: 7265 616c 2073 7061 6365 2062 6c75 7272  real space blurr
+00010c60: 696e 673a 3e60 0a20 2020 2020 2020 2020  ing:>`.         
+00010c70: 2020 2073 7472 7563 7475 7265 5f69 6e73     structure_ins
+00010c80: 7461 6e63 653a 2053 7472 7563 7475 7265  tance: Structure
+00010c90: 2069 6e73 7461 6e63 6520 746f 2063 6f6d   instance to com
+00010ca0: 7061 7265 0a20 2020 2020 2020 2020 2020  pare.           
+00010cb0: 2072 6967 6964 5f62 6f64 795f 7374 7275   rigid_body_stru
+00010cc0: 6374 7572 653a 2052 6967 6964 2d62 6f64  cture: Rigid-bod
+00010cd0: 7920 5374 7275 6374 7572 6520 696e 7374  y Structure inst
+00010ce0: 616e 6365 2e0a 2020 2020 2020 2020 2020  ance..          
+00010cf0: 2020 7772 6974 653a 2049 6620 5472 7565    write: If True
+00010d00: 2c20 6120 7374 7269 6e67 2069 7320 7265  , a string is re
+00010d10: 7475 726e 6564 2077 6974 6820 666f 726d  turned with form
+00010d20: 6174 0a20 2020 2020 2020 2020 2020 2020  at.             
+00010d30: 2020 203a 636f 6465 3a60 6627 5343 4343     :code:`f'SCCC
+00010d40: 5f4c 4150 2066 6f72 2073 6567 6d65 6e74  _LAP for segment
+00010d50: 207b 5343 4343 5f4c 4150 5f73 636f 7265   {SCCC_LAP_score
+00010d60: 7d27 600a 2020 2020 2020 2020 5265 7475  }'`.        Retu
+00010d70: 726e 3a0a 2020 2020 2020 2020 2020 2020  rn:.            
+00010d80: 666c 6f61 7420 6966 203a 636f 6465 3a60  float if :code:`
+00010d90: 7772 6974 653d 4661 6c73 6560 2c20 656c  write=False`, el
+00010da0: 7365 2073 7472 696e 673a 0a20 2020 2020  se string:.     
+00010db0: 2020 2020 2020 2020 2020 2053 4343 435f             SCCC_
+00010dc0: 4c41 5020 7363 6f72 650a 2020 2020 2020  LAP score.      
+00010dd0: 2020 2222 220a 2020 2020 2020 2020 626c    """.        bl
+00010de0: 7572 7265 7220 3d20 5374 7275 6374 7572  urrer = Structur
+00010df0: 6542 6c75 7272 6572 2829 0a20 2020 2020  eBlurrer().     
+00010e00: 2020 2073 636f 7265 7220 3d20 5363 6f72     scorer = Scor
+00010e10: 696e 6746 756e 6374 696f 6e73 2829 0a20  ingFunctions(). 
+00010e20: 2020 2020 2020 206f 7574 6c69 6e65 203d         outline =
+00010e30: 2022 220a 2020 2020 2020 2020 7265 736f   "".        reso
+00010e40: 6c75 7469 6f6e 5f64 656e 734d 6170 203d  lution_densMap =
+00010e50: 2066 6c6f 6174 2872 6573 6f6c 7574 696f   float(resolutio
+00010e60: 6e5f 6465 6e73 4d61 7029 0a20 2020 2020  n_densMap).     
+00010e70: 2020 2077 686f 6c65 5f66 6974 5f6d 6170     whole_fit_map
+00010e80: 203d 2062 6c75 7272 6572 2e67 6175 7373   = blurrer.gauss
+00010e90: 6961 6e5f 626c 7572 280a 2020 2020 2020  ian_blur(.      
+00010ea0: 2020 2020 2020 7374 7275 6374 7572 655f        structure_
+00010eb0: 696e 7374 616e 6365 2c0a 2020 2020 2020  instance,.      
+00010ec0: 2020 2020 2020 7265 736f 6c75 7469 6f6e        resolution
+00010ed0: 5f64 656e 734d 6170 2c0a 2020 2020 2020  _densMap,.      
+00010ee0: 2020 2020 2020 6465 6e73 4d61 703d 6d61        densMap=ma
+00010ef0: 705f 7461 7267 6574 2c0a 2020 2020 2020  p_target,.      
+00010f00: 2020 2020 2020 7369 676d 615f 636f 6566        sigma_coef
+00010f10: 663d 7369 676d 615f 6d61 702c 0a20 2020  f=sigma_map,.   
+00010f20: 2020 2020 2020 2020 206e 6f72 6d61 6c69           normali
+00010f30: 7365 3d54 7275 652c 0a20 2020 2020 2020  se=True,.       
+00010f40: 2029 0a20 2020 2020 2020 2073 696d 5f6d   ).        sim_m
+00010f50: 6170 203d 2062 6c75 7272 6572 2e67 6175  ap = blurrer.gau
+00010f60: 7373 6961 6e5f 626c 7572 280a 2020 2020  ssian_blur(.    
+00010f70: 2020 2020 2020 2020 7269 6769 645f 626f          rigid_bo
+00010f80: 6479 5f73 7472 7563 7475 7265 2c0a 2020  dy_structure,.  
+00010f90: 2020 2020 2020 2020 2020 7265 736f 6c75            resolu
+00010fa0: 7469 6f6e 5f64 656e 734d 6170 2c0a 2020  tion_densMap,.  
+00010fb0: 2020 2020 2020 2020 2020 6465 6e73 4d61            densMa
+00010fc0: 703d 6d61 705f 7461 7267 6574 2c0a 2020  p=map_target,.  
+00010fd0: 2020 2020 2020 2020 2020 7369 676d 615f            sigma_
+00010fe0: 636f 6566 663d 7369 676d 615f 6d61 702c  coeff=sigma_map,
+00010ff0: 0a20 2020 2020 2020 2020 2020 206e 6f72  .            nor
+00011000: 6d61 6c69 7365 3d54 7275 652c 0a20 2020  malise=True,.   
+00011010: 2020 2020 2029 0a20 2020 2020 2020 206d       ).        m
+00011020: 696e 4465 6e73 203d 2073 696d 5f6d 6170  inDens = sim_map
+00011030: 2e73 7464 2829 0a20 2020 2020 2020 2073  .std().        s
+00011040: 696d 5f6d 6173 6b5f 6172 7261 7920 3d20  im_mask_array = 
+00011050: 7369 6d5f 6d61 702e 5f67 6574 5f6d 6173  sim_map._get_mas
+00011060: 6b41 7272 6179 286d 696e 4465 6e73 290a  kArray(minDens).
+00011070: 2020 2020 2020 2020 6d61 736b 5f65 6d4d          mask_emM
+00011080: 6170 203d 206d 6170 5f74 6172 6765 742e  ap = map_target.
+00011090: 5f67 6574 5f6d 6173 6b4d 6170 2873 696d  _get_maskMap(sim
+000110a0: 5f6d 6173 6b5f 6172 7261 7929 0a20 2020  _mask_array).   
+000110b0: 2020 2020 206d 6173 6b5f 7369 6d4d 6170       mask_simMap
+000110c0: 203d 2077 686f 6c65 5f66 6974 5f6d 6170   = whole_fit_map
+000110d0: 2e5f 6765 745f 6d61 736b 4d61 7028 7369  ._get_maskMap(si
+000110e0: 6d5f 6d61 736b 5f61 7272 6179 290a 2020  m_mask_array).  
+000110f0: 2020 2020 2020 7373 655f 6c63 6366 203d        sse_lccf =
+00011100: 2073 636f 7265 722e 6c61 706c 6163 655f   scorer.laplace_
+00011110: 4343 4328 6d61 736b 5f65 6d4d 6170 2c20  CCC(mask_emMap, 
+00011120: 6d61 736b 5f73 696d 4d61 7029 0a20 2020  mask_simMap).   
+00011130: 2020 2020 2069 6620 7772 6974 6520 6973       if write is
+00011140: 2054 7275 653a 0a20 2020 2020 2020 2020   True:.         
+00011150: 2020 206f 7574 6c69 6e65 202b 3d20 2753     outline += 'S
+00011160: 4343 4320 666f 7220 7365 676d 656e 7420  CCC for segment 
+00011170: 2566 5c6e 2720 2520 2873 7365 5f6c 6363  %f\n' % (sse_lcc
+00011180: 6629 0a20 2020 2020 2020 2020 2020 2072  f).            r
+00011190: 6574 7572 6e20 6f75 746c 696e 650a 2020  eturn outline.  
+000111a0: 2020 2020 2020 7265 7475 726e 2073 7365        return sse
+000111b0: 5f6c 6363 660a 0a20 2020 2064 6566 2053  _lccf..    def S
+000111c0: 4343 435f 4d49 280a 2020 2020 2020 2020  CCC_MI(.        
+000111d0: 2020 2020 7365 6c66 2c0a 2020 2020 2020      self,.      
+000111e0: 2020 2020 2020 6d61 705f 7461 7267 6574        map_target
+000111f0: 2c0a 2020 2020 2020 2020 2020 2020 7265  ,.            re
+00011200: 736f 6c75 7469 6f6e 5f64 656e 734d 6170  solution_densMap
+00011210: 2c0a 2020 2020 2020 2020 2020 2020 7369  ,.            si
+00011220: 676d 615f 6d61 702c 0a20 2020 2020 2020  gma_map,.       
+00011230: 2020 2020 2073 7472 7563 7475 7265 5f69       structure_i
+00011240: 6e73 7461 6e63 652c 0a20 2020 2020 2020  nstance,.       
+00011250: 2020 2020 2072 6967 6964 5f62 6f64 795f       rigid_body_
+00011260: 7374 7275 6374 7572 652c 0a20 2020 2020  structure,.     
+00011270: 2020 2020 2020 2077 7269 7465 3d46 616c         write=Fal
+00011280: 7365 2c0a 2020 2020 293a 0a20 2020 2020  se,.    ):.     
+00011290: 2020 2022 2222 4361 6c63 756c 6174 6520     """Calculate 
+000112a0: 7468 6520 6d75 7475 616c 2069 6e66 6f72  the mutual infor
+000112b0: 6d61 7469 6f6e 2073 636f 7265 2066 6f72  mation score for
+000112c0: 2061 2073 6567 6d65 6e74 206f 6620 6120   a segment of a 
+000112d0: 7072 6f74 6569 6e0a 2020 2020 2020 2020  protein.        
+000112e0: 6d6f 6465 6c2e 0a0a 2020 2020 2020 2020  model...        
+000112f0: 5365 676d 656e 7473 2061 7265 2064 6566  Segments are def
+00011300: 696e 6564 2075 7369 6e67 2061 2072 6967  ined using a rig
+00011310: 6964 2d62 6f64 7920 7374 7275 6374 7572  id-body structur
+00011320: 6520 696e 7374 616e 6365 2c20 7768 6963  e instance, whic
+00011330: 6820 6361 6e0a 2020 2020 2020 2020 6265  h can.        be
+00011340: 2067 656e 6572 6174 6564 2075 7369 6e67   generated using
+00011350: 2060 5249 4246 494e 4420 3c68 7474 7073   `RIBFIND <https
+00011360: 3a2f 2f72 6962 6669 6e64 2e69 736d 622e  ://ribfind.ismb.
+00011370: 6c6f 6e2e 6163 2e75 6b2f 3e60 5f2e 0a20  lon.ac.uk/>`_.. 
+00011380: 2020 2020 2020 2054 6865 2073 636f 7265         The score
+00011390: 2066 6f72 2074 6865 2073 6567 6d65 6e74   for the segment
+000113a0: 2069 7320 6361 6c63 756c 6174 6564 2075   is calculated u
+000113b0: 7369 6e67 0a20 2020 2020 2020 203a 6d65  sing.        :me
+000113c0: 7468 3a60 4d49 203c 5445 4d50 792e 7072  th:`MI <TEMPy.pr
+000113d0: 6f74 6569 6e2e 7363 6f72 696e 675f 6675  otein.scoring_fu
+000113e0: 6e63 7469 6f6e 732e 5363 6f72 696e 6746  nctions.ScoringF
+000113f0: 756e 6374 696f 6e73 2e4d 493e 600a 0a20  unctions.MI>`.. 
+00011400: 2020 2020 2020 2041 7267 756d 656e 7473         Arguments
+00011410: 3a0a 2020 2020 2020 2020 2020 2020 6d61  :.            ma
+00011420: 705f 7461 7267 6574 3a20 4d61 7020 496e  p_target: Map In
+00011430: 7374 616e 6365 2e0a 2020 2020 2020 2020  stance..        
+00011440: 2020 2020 7265 736f 6c75 7469 6f6e 5f64      resolution_d
+00011450: 656e 734d 6170 3a20 5265 736f 6c75 7469  ensMap: Resoluti
+00011460: 6f6e 206f 6620 7468 6520 6d61 7020 696e  on of the map in
+00011470: 7374 616e 6365 2e0a 2020 2020 2020 2020  stance..        
+00011480: 2020 2020 7369 676d 615f 6d61 703a 2050      sigma_map: P
+00011490: 6172 616d 6574 6572 206e 6565 6420 666f  arameter need fo
+000114a0: 7220 5374 7275 6374 7572 6520 426c 7572  r Structure Blur
+000114b0: 7265 722e 2046 756c 6c20 6578 706c 616e  rer. Full explan
+000114c0: 6174 696f 6e0a 2020 2020 2020 2020 2020  ation.          
+000114d0: 2020 2020 2020 3a72 6566 3a60 6865 7265        :ref:`here
+000114e0: 3c4e 6f74 6520 6f6e 2072 6561 6c20 7370  <Note on real sp
+000114f0: 6163 6520 626c 7572 7269 6e67 3a3e 600a  ace blurring:>`.
+00011500: 2020 2020 2020 2020 2020 2020 7374 7275              stru
+00011510: 6374 7572 655f 696e 7374 616e 6365 3a20  cture_instance: 
+00011520: 5374 7275 6374 7572 6520 696e 7374 616e  Structure instan
+00011530: 6365 2074 6f20 636f 6d70 6172 650a 2020  ce to compare.  
+00011540: 2020 2020 2020 2020 2020 7269 6769 645f            rigid_
+00011550: 626f 6479 5f73 7472 7563 7475 7265 3a20  body_structure: 
+00011560: 5269 6769 642d 626f 6479 2053 7472 7563  Rigid-body Struc
+00011570: 7475 7265 2069 6e73 7461 6e63 652e 0a20  ture instance.. 
+00011580: 2020 2020 2020 2020 2020 2077 7269 7465             write
+00011590: 3a20 4966 2054 7275 652c 2061 2073 7472  : If True, a str
+000115a0: 696e 6720 6973 2072 6574 7572 6e65 6420  ing is returned 
+000115b0: 7769 7468 2066 6f72 6d61 740a 2020 2020  with format.    
+000115c0: 2020 2020 2020 2020 2020 2020 3a63 6f64              :cod
+000115d0: 653a 6066 2753 4343 435f 4c41 5020 666f  e:`f'SCCC_LAP fo
+000115e0: 7220 7365 676d 656e 7420 7b53 4343 435f  r segment {SCCC_
+000115f0: 4c41 505f 7363 6f72 657d 2760 0a20 2020  LAP_score}'`.   
+00011600: 2020 2020 2052 6574 7572 6e3a 0a20 2020       Return:.   
+00011610: 2020 2020 2020 2020 2066 6c6f 6174 2069           float i
+00011620: 6620 3a63 6f64 653a 6077 7269 7465 3d46  f :code:`write=F
+00011630: 616c 7365 602c 2065 6c73 6520 7374 7269  alse`, else stri
+00011640: 6e67 3a0a 2020 2020 2020 2020 2020 2020  ng:.            
+00011650: 2020 2020 5343 4343 5f4d 4920 7363 6f72      SCCC_MI scor
+00011660: 650a 2020 2020 2020 2020 2222 220a 2020  e.        """.  
+00011670: 2020 2020 2020 626c 7572 7265 7220 3d20        blurrer = 
+00011680: 5374 7275 6374 7572 6542 6c75 7272 6572  StructureBlurrer
+00011690: 2829 0a20 2020 2020 2020 2073 636f 7265  ().        score
+000116a0: 7220 3d20 5363 6f72 696e 6746 756e 6374  r = ScoringFunct
+000116b0: 696f 6e73 2829 0a20 2020 2020 2020 206f  ions().        o
+000116c0: 7574 6c69 6e65 203d 2022 220a 2020 2020  utline = "".    
+000116d0: 2020 2020 7265 736f 6c75 7469 6f6e 5f64      resolution_d
+000116e0: 656e 734d 6170 203d 2066 6c6f 6174 2872  ensMap = float(r
+000116f0: 6573 6f6c 7574 696f 6e5f 6465 6e73 4d61  esolution_densMa
+00011700: 7029 0a20 2020 2020 2020 2077 686f 6c65  p).        whole
+00011710: 5f66 6974 5f6d 6170 203d 2062 6c75 7272  _fit_map = blurr
+00011720: 6572 2e67 6175 7373 6961 6e5f 626c 7572  er.gaussian_blur
+00011730: 280a 2020 2020 2020 2020 2020 2020 7374  (.            st
+00011740: 7275 6374 7572 655f 696e 7374 616e 6365  ructure_instance
+00011750: 2c0a 2020 2020 2020 2020 2020 2020 7265  ,.            re
+00011760: 736f 6c75 7469 6f6e 5f64 656e 734d 6170  solution_densMap
+00011770: 2c0a 2020 2020 2020 2020 2020 2020 6465  ,.            de
+00011780: 6e73 4d61 703d 6d61 705f 7461 7267 6574  nsMap=map_target
+00011790: 2c0a 2020 2020 2020 2020 2020 2020 7369  ,.            si
+000117a0: 676d 615f 636f 6566 663d 7369 676d 615f  gma_coeff=sigma_
+000117b0: 6d61 702c 0a20 2020 2020 2020 2020 2020  map,.           
+000117c0: 206e 6f72 6d61 6c69 7365 3d54 7275 650a   normalise=True.
+000117d0: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+000117e0: 2020 7369 6d5f 6d61 7020 3d20 626c 7572    sim_map = blur
+000117f0: 7265 722e 6761 7573 7369 616e 5f62 6c75  rer.gaussian_blu
+00011800: 7228 0a20 2020 2020 2020 2020 2020 2072  r(.            r
+00011810: 6967 6964 5f62 6f64 795f 7374 7275 6374  igid_body_struct
+00011820: 7572 652c 0a20 2020 2020 2020 2020 2020  ure,.           
+00011830: 2072 6573 6f6c 7574 696f 6e5f 6465 6e73   resolution_dens
+00011840: 4d61 702c 0a20 2020 2020 2020 2020 2020  Map,.           
+00011850: 2064 656e 734d 6170 3d6d 6170 5f74 6172   densMap=map_tar
+00011860: 6765 742c 0a20 2020 2020 2020 2020 2020  get,.           
+00011870: 2073 6967 6d61 5f63 6f65 6666 3d73 6967   sigma_coeff=sig
+00011880: 6d61 5f6d 6170 2c0a 2020 2020 2020 2020  ma_map,.        
+00011890: 2020 2020 6e6f 726d 616c 6973 653d 5472      normalise=Tr
+000118a0: 7565 0a20 2020 2020 2020 2029 0a20 2020  ue.        ).   
+000118b0: 2020 2020 206d 696e 4465 6e73 203d 2073       minDens = s
+000118c0: 696d 5f6d 6170 2e73 7464 2829 0a20 2020  im_map.std().   
+000118d0: 2020 2020 2073 696d 5f6d 6173 6b5f 6172       sim_mask_ar
+000118e0: 7261 7920 3d20 7369 6d5f 6d61 702e 5f67  ray = sim_map._g
+000118f0: 6574 5f6d 6173 6b41 7272 6179 286d 696e  et_maskArray(min
+00011900: 4465 6e73 290a 2020 2020 2020 2020 6d61  Dens).        ma
+00011910: 736b 5f65 6d4d 6170 203d 206d 6170 5f74  sk_emMap = map_t
+00011920: 6172 6765 742e 5f67 6574 5f6d 6173 6b4d  arget._get_maskM
+00011930: 6170 2873 696d 5f6d 6173 6b5f 6172 7261  ap(sim_mask_arra
+00011940: 7929 0a20 2020 2020 2020 206d 6173 6b5f  y).        mask_
+00011950: 7369 6d4d 6170 203d 2077 686f 6c65 5f66  simMap = whole_f
+00011960: 6974 5f6d 6170 2e5f 6765 745f 6d61 736b  it_map._get_mask
+00011970: 4d61 7028 7369 6d5f 6d61 736b 5f61 7272  Map(sim_mask_arr
+00011980: 6179 290a 2020 2020 2020 2020 7373 655f  ay).        sse_
+00011990: 6c63 6366 203d 2073 636f 7265 722e 4d49  lccf = scorer.MI
+000119a0: 286d 6173 6b5f 656d 4d61 702c 206d 6173  (mask_emMap, mas
+000119b0: 6b5f 7369 6d4d 6170 290a 2020 2020 2020  k_simMap).      
+000119c0: 2020 6966 2077 7269 7465 2069 7320 5472    if write is Tr
+000119d0: 7565 3a0a 2020 2020 2020 2020 2020 2020  ue:.            
+000119e0: 6f75 746c 696e 6520 2b3d 2027 5343 4343  outline += 'SCCC
+000119f0: 2066 6f72 2073 6567 6d65 6e74 2025 665c   for segment %f\
+00011a00: 6e27 2025 2028 7373 655f 6c63 6366 290a  n' % (sse_lccf).
+00011a10: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+00011a20: 726e 206f 7574 6c69 6e65 0a20 2020 2020  rn outline.     
+00011a30: 2020 2072 6574 7572 6e20 7373 655f 6c63     return sse_lc
+00011a40: 6366 0a0a 2020 2020 6465 6620 6765 745f  cf..    def get_
+00011a50: 7363 6363 280a 2020 2020 2020 2020 2020  sccc(.          
+00011a60: 2020 7365 6c66 2c0a 2020 2020 2020 2020    self,.        
+00011a70: 2020 2020 6d61 705f 7461 7267 6574 2c0a      map_target,.
+00011a80: 2020 2020 2020 2020 2020 2020 7374 7275              stru
+00011a90: 6374 7572 655f 696e 7374 616e 6365 2c0a  cture_instance,.
+00011aa0: 2020 2020 2020 2020 2020 2020 7269 6769              rigi
+00011ab0: 645f 626f 6479 5f66 696c 652c 0a20 2020  d_body_file,.   
+00011ac0: 2020 2020 2020 2020 2072 6573 6f6c 7574           resolut
+00011ad0: 696f 6e2c 0a20 2020 2020 2020 2020 2020  ion,.           
+00011ae0: 2073 6967 6d61 5f6d 6170 3d30 2e31 3837   sigma_map=0.187
+00011af0: 0a20 2020 2029 3a0a 2020 2020 2020 2020  .    ):.        
+00011b00: 2222 2252 6561 6420 7269 6769 6420 626f  """Read rigid bo
+00011b10: 6479 2066 696c 6520 616e 6420 6361 6c63  dy file and calc
+00011b20: 756c 6174 6520 7363 6363 2073 636f 7265  ulate sccc score
+00011b30: 7320 666f 7220 6561 6368 2072 6967 6964  s for each rigid
+00011b40: 2062 6f64 790a 0a20 2020 2020 2020 2041   body..        A
+00011b50: 7267 733a 0a20 2020 2020 2020 2020 2020  rgs:.           
+00011b60: 206d 6170 5f74 6172 6765 743a 204d 6170   map_target: Map
+00011b70: 2069 6e73 7461 6e63 650a 2020 2020 2020   instance.      
+00011b80: 2020 2020 2020 7374 7275 6374 7572 655f        structure_
+00011b90: 696e 7374 616e 6365 3a20 4d6f 6465 6c20  instance: Model 
+00011ba0: 7374 7275 6374 7572 6520 696e 7374 616e  structure instan
+00011bb0: 6365 0a20 2020 2020 2020 2020 2020 2072  ce.            r
+00011bc0: 6967 6964 5f62 6f64 795f 6669 6c65 3a20  igid_body_file: 
+00011bd0: 5061 7468 2074 6f20 7269 6769 6420 626f  Path to rigid bo
+00011be0: 6479 2066 696c 650a 2020 2020 2020 2020  dy file.        
+00011bf0: 2020 2020 7265 736f 6c75 7469 6f6e 3a20      resolution: 
+00011c00: 5265 736f 6c75 7469 6f6e 206f 6620 6d61  Resolution of ma
+00011c10: 7020 696e 7374 616e 6365 0a20 2020 2020  p instance.     
+00011c20: 2020 2020 2020 2073 6967 6d61 5f6d 6170         sigma_map
+00011c30: 3a20 5061 7261 6d65 7465 7220 6e65 6564  : Parameter need
+00011c40: 2066 6f72 2053 7472 7563 7475 7265 2042   for Structure B
+00011c50: 6c75 7272 6572 2e20 4675 6c6c 2065 7870  lurrer. Full exp
+00011c60: 6c61 6e61 7469 6f6e 0a20 2020 2020 2020  lanation.       
+00011c70: 2020 2020 2020 2020 203a 7265 663a 6068           :ref:`h
+00011c80: 6572 653c 4e6f 7465 206f 6e20 7265 616c  ere<Note on real
+00011c90: 2073 7061 6365 2062 6c75 7272 696e 673a   space blurring:
+00011ca0: 3e60 0a0a 2020 2020 2020 2020 5265 7475  >`..        Retu
+00011cb0: 726e 733a 0a20 2020 2020 2020 2020 2020  rns:.           
+00011cc0: 2054 776f 2064 6963 7469 6f6e 6172 6965   Two dictionarie
+00011cd0: 733b 2064 6963 745f 6368 6169 6e5f 7363  s; dict_chain_sc
+00011ce0: 6f72 6573 2c20 6469 6374 5f72 6967 6964  ores, dict_rigid
+00011cf0: 5f73 636f 7265 730a 2020 2020 2020 2020  _scores.        
+00011d00: 2020 2020 2020 2020 2a20 6469 6374 5f63          * dict_c
+00011d10: 6861 696e 5f73 636f 7265 7320 6973 2061  hain_scores is a
+00011d20: 2064 6963 7469 6f6e 6172 7920 7769 7468   dictionary with
+00011d30: 206b 6579 7320 6571 7561 6c20 746f 2063   keys equal to c
+00011d40: 6861 696e 0a20 2020 2020 2020 2020 2020  hain.           
+00011d50: 2020 2020 2020 206c 6162 656c 7320 2865         labels (e
+00011d60: 2e67 2e20 3a63 6f64 653a 605b 2741 272c  .g. :code:`['A',
+00011d70: 2027 4227 2c20 2743 275d 6029 2e20 4561   'B', 'C']`). Ea
+00011d80: 6368 2076 616c 7565 2069 7320 616e 6f74  ch value is anot
+00011d90: 6865 720a 2020 2020 2020 2020 2020 2020  her.            
+00011da0: 2020 2020 2020 6469 6374 696f 6e61 7279        dictionary
+00011db0: 2c20 7769 7468 206b 6579 7320 6173 2072  , with keys as r
+00011dc0: 6573 6964 7565 206e 756d 6265 7220 666f  esidue number fo
+00011dd0: 7220 6561 6368 2072 6573 6964 7565 2069  r each residue i
+00011de0: 6e20 610a 2020 2020 2020 2020 2020 2020  n a.            
+00011df0: 2020 2020 2020 7269 6769 6420 626f 6479        rigid body
+00011e00: 2c20 616e 6420 7661 6c75 6573 2074 6865  , and values the
+00011e10: 2043 4343 2073 636f 7265 2066 6f72 2074   CCC score for t
+00011e20: 6861 7420 7265 7369 6475 652e 0a0a 2020  hat residue...  
+00011e30: 2020 2020 2020 2020 2020 2020 2020 2a20                * 
+00011e40: 6469 6374 5f72 6967 6964 5f73 636f 7265  dict_rigid_score
+00011e50: 7320 6973 2061 2064 6963 7469 6f6e 6172  s is a dictionar
+00011e60: 7920 7769 7468 206b 6579 7320 6571 7561  y with keys equa
+00011e70: 6c20 746f 2065 6163 680a 2020 2020 2020  l to each.      
+00011e80: 2020 2020 2020 2020 2020 2020 7269 6769              rigi
+00011e90: 6420 626f 6479 2028 7374 7269 6e67 3f3f  d body (string??
+00011ea0: 206e 6f74 2073 7572 6529 2061 6e64 2076   not sure) and v
+00011eb0: 616c 7565 7320 7468 6520 4343 4320 7363  alues the CCC sc
+00011ec0: 6f72 6520 666f 720a 2020 2020 2020 2020  ore for.        
+00011ed0: 2020 2020 2020 2020 2020 7468 6174 2062            that b
+00011ee0: 6f64 792e 0a0a 2020 2020 2020 2020 2222  ody...        ""
+00011ef0: 220a 2020 2020 2020 2020 6469 6374 5f72  ".        dict_r
+00011f00: 6266 203d 2052 4250 6172 7365 722e 6765  bf = RBParser.ge
+00011f10: 745f 7269 6769 645f 626f 6479 5f73 7472  t_rigid_body_str
+00011f20: 5f69 6e73 7461 6e63 6573 280a 2020 2020  _instances(.    
+00011f30: 2020 2020 2020 2020 7269 6769 645f 626f          rigid_bo
+00011f40: 6479 5f66 696c 652c 0a20 2020 2020 2020  dy_file,.       
+00011f50: 2020 2020 2073 7472 7563 7475 7265 5f69       structure_i
+00011f60: 6e73 7461 6e63 652c 0a20 2020 2020 2020  nstance,.       
+00011f70: 2029 0a20 2020 2020 2020 2064 6963 745f   ).        dict_
+00011f80: 6368 6169 6e5f 6465 7461 696c 7320 3d20  chain_details = 
+00011f90: 7374 7275 6374 7572 655f 696e 7374 616e  structure_instan
+00011fa0: 6365 2e67 6574 5f64 6963 745f 7374 7228  ce.get_dict_str(
+00011fb0: 290a 2020 2020 2020 2020 6469 6374 5f63  ).        dict_c
+00011fc0: 6861 696e 5f73 636f 7265 7320 3d20 7b7d  hain_scores = {}
+00011fd0: 0a20 2020 2020 2020 2064 6963 745f 7269  .        dict_ri
+00011fe0: 6769 645f 7363 6f72 6573 203d 207b 7d0a  gid_scores = {}.
+00011ff0: 2020 2020 2020 2020 6d69 6e73 636f 7265          minscore
+00012000: 203d 2031 2e30 0a20 2020 2020 2020 206d   = 1.0.        m
+00012010: 6178 7363 6f72 6520 3d20 2d31 2e30 0a20  axscore = -1.0. 
+00012020: 2020 2020 2020 2066 6f72 2063 6820 696e         for ch in
+00012030: 2064 6963 745f 6368 6169 6e5f 6465 7461   dict_chain_deta
+00012040: 696c 733a 0a20 2020 2020 2020 2020 2020  ils:.           
+00012050: 2064 6963 745f 7265 735f 7363 6f72 6573   dict_res_scores
+00012060: 203d 207b 7d0a 2020 2020 2020 2020 2020   = {}.          
+00012070: 2020 666f 7220 7265 7320 696e 2064 6963    for res in dic
+00012080: 745f 6368 6169 6e5f 6465 7461 696c 735b  t_chain_details[
+00012090: 6368 5d3a 0a20 2020 2020 2020 2020 2020  ch]:.           
+000120a0: 2020 2020 2064 6963 745f 7265 735f 7363       dict_res_sc
+000120b0: 6f72 6573 5b72 6573 5d20 3d20 2d32 2e30  ores[res] = -2.0
+000120c0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+000120d0: 6368 206e 6f74 2069 6e20 6469 6374 5f72  ch not in dict_r
+000120e0: 6266 3a0a 2020 2020 2020 2020 2020 2020  bf:.            
+000120f0: 2020 2020 636f 6e74 696e 7565 0a20 2020      continue.   
+00012100: 2020 2020 2020 2020 2066 6f72 2072 6220           for rb 
+00012110: 696e 2064 6963 745f 7262 665b 6368 5d3a  in dict_rbf[ch]:
 00012120: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00012130: 2020 2020 2072 6573 6f6c 7574 696f 6e2c       resolution,
-00012140: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00012150: 2020 2020 2073 6967 6d61 5f6d 6170 2c0a       sigma_map,.
-00012160: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012170: 2020 2020 7374 7275 6374 7572 655f 696e      structure_in
-00012180: 7374 616e 6365 2c0a 2020 2020 2020 2020  stance,.        
-00012190: 2020 2020 2020 2020 2020 2020 6469 6374              dict
-000121a0: 5f72 6266 5b63 685d 5b72 625d 5b31 5d0a  _rbf[ch][rb][1].
-000121b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000121c0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-000121d0: 2020 6966 2072 6220 6e6f 7420 696e 2064    if rb not in d
-000121e0: 6963 745f 7269 6769 645f 7363 6f72 6573  ict_rigid_scores
-000121f0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00012200: 2020 2020 2020 6469 6374 5f72 6967 6964        dict_rigid
-00012210: 5f73 636f 7265 735b 7262 5d20 3d20 7363  _scores[rb] = sc
-00012220: 6f72 655f 5343 4343 0a20 2020 2020 2020  ore_SCCC.       
-00012230: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-00012240: 7363 6f72 655f 5343 4343 203c 206d 696e  score_SCCC < min
-00012250: 7363 6f72 653a 0a20 2020 2020 2020 2020  score:.         
-00012260: 2020 2020 2020 2020 2020 2020 2020 206d                 m
-00012270: 696e 7363 6f72 6520 3d20 7363 6f72 655f  inscore = score_
-00012280: 5343 4343 0a20 2020 2020 2020 2020 2020  SCCC.           
-00012290: 2020 2020 2020 2020 2069 6620 7363 6f72           if scor
-000122a0: 655f 5343 4343 203e 206d 6178 7363 6f72  e_SCCC > maxscor
-000122b0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-000122c0: 2020 2020 2020 2020 2020 206d 6178 7363             maxsc
-000122d0: 6f72 6520 3d20 7363 6f72 655f 5343 4343  ore = score_SCCC
-000122e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000122f0: 2066 6f72 2072 6573 2069 6e20 7265 735f   for res in res_
-00012300: 6c69 7374 3a0a 2020 2020 2020 2020 2020  list:.          
-00012310: 2020 2020 2020 2020 2020 6469 6374 5f72            dict_r
-00012320: 6573 5f73 636f 7265 735b 7265 735d 203d  es_scores[res] =
-00012330: 2073 636f 7265 5f53 4343 430a 0a20 2020   score_SCCC..   
-00012340: 2020 2020 2020 2020 2064 6963 745f 6368           dict_ch
-00012350: 6169 6e5f 7363 6f72 6573 5b63 685d 203d  ain_scores[ch] =
-00012360: 2064 6963 745f 7265 735f 7363 6f72 6573   dict_res_scores
-00012370: 0a0a 2020 2020 2020 2020 6d69 6e73 636f  ..        minsco
-00012380: 7265 203d 206d 6178 286d 696e 7363 6f72  re = max(minscor
-00012390: 6520 2d20 286d 6178 7363 6f72 6520 2d20  e - (maxscore - 
-000123a0: 6d69 6e73 636f 7265 2920 2f20 352e 2c20  minscore) / 5., 
-000123b0: 2d31 2e30 290a 2020 2020 2020 2020 666f  -1.0).        fo
-000123c0: 7220 6368 2069 6e20 6469 6374 5f63 6861  r ch in dict_cha
-000123d0: 696e 5f73 636f 7265 733a 0a20 2020 2020  in_scores:.     
-000123e0: 2020 2020 2020 2066 6f72 2072 6573 2069         for res i
-000123f0: 6e20 6469 6374 5f63 6861 696e 5f73 636f  n dict_chain_sco
-00012400: 7265 735b 6368 5d3a 0a20 2020 2020 2020  res[ch]:.       
-00012410: 2020 2020 2020 2020 2069 6620 6469 6374           if dict
-00012420: 5f63 6861 696e 5f73 636f 7265 735b 6368  _chain_scores[ch
-00012430: 5d5b 7265 735d 203d 3d20 2d32 2e30 3a0a  ][res] == -2.0:.
-00012440: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012450: 2020 2020 6469 6374 5f63 6861 696e 5f73      dict_chain_s
-00012460: 636f 7265 735b 6368 5d5b 7265 735d 203d  cores[ch][res] =
-00012470: 206d 696e 7363 6f72 650a 0a20 2020 2020   minscore..     
-00012480: 2020 2072 6574 7572 6e20 6469 6374 5f63     return dict_c
-00012490: 6861 696e 5f73 636f 7265 732c 2064 6963  hain_scores, dic
-000124a0: 745f 7269 6769 645f 7363 6f72 6573 0a0a  t_rigid_scores..
-000124b0: 2020 2020 6465 6620 6361 6c63 5f6d 6f63      def calc_moc
-000124c0: 280a 2020 2020 2020 2020 2020 2020 7365  (.            se
-000124d0: 6c66 2c0a 2020 2020 2020 2020 2020 2020  lf,.            
-000124e0: 696e 6469 6365 732c 0a20 2020 2020 2020  indices,.       
-000124f0: 2020 2020 206d 6170 5f70 726f 6265 2c0a       map_probe,.
-00012500: 2020 2020 2020 2020 2020 2020 6d61 705f              map_
-00012510: 7461 7267 6574 2c0a 2020 2020 293a 0a20  target,.    ):. 
-00012520: 2020 2020 2020 206d 6170 5f74 6172 6765         map_targe
-00012530: 745f 6d61 736b 203d 206d 6170 5f74 6172  t_mask = map_tar
-00012540: 6765 742e 6675 6c6c 4d61 705b 696e 6469  get.fullMap[indi
-00012550: 6365 735d 0a20 2020 2020 2020 206d 6170  ces].        map
-00012560: 5f70 726f 6265 5f6d 6173 6b20 3d20 6d61  _probe_mask = ma
-00012570: 705f 7072 6f62 652e 6675 6c6c 4d61 705b  p_probe.fullMap[
-00012580: 696e 6469 6365 735d 0a20 2020 2020 2020  indices].       
-00012590: 206e 756d 203d 206e 702e 7375 6d28 6d61   num = np.sum(ma
-000125a0: 705f 7461 7267 6574 5f6d 6173 6b20 2a20  p_target_mask * 
-000125b0: 6d61 705f 7072 6f62 655f 6d61 736b 290a  map_probe_mask).
-000125c0: 2020 2020 2020 2020 6465 6e20 3d20 6e70          den = np
-000125d0: 2e73 7172 7428 0a20 2020 2020 2020 2020  .sqrt(.         
-000125e0: 2020 206e 702e 7375 6d28 6e70 2e73 7175     np.sum(np.squ
-000125f0: 6172 6528 6d61 705f 7461 7267 6574 5f6d  are(map_target_m
-00012600: 6173 6b29 2920 2a0a 2020 2020 2020 2020  ask)) *.        
-00012610: 2020 2020 6e70 2e73 756d 286e 702e 7371      np.sum(np.sq
-00012620: 7561 7265 286d 6170 5f70 726f 6265 5f6d  uare(map_probe_m
-00012630: 6173 6b29 290a 2020 2020 2020 2020 290a  ask)).        ).
-00012640: 2020 2020 2020 2020 6966 2064 656e 203d          if den =
-00012650: 3d20 302e 303a 0a20 2020 2020 2020 2020  = 0.0:.         
-00012660: 2020 2072 6574 7572 6e20 2d31 2e30 0a20     return -1.0. 
-00012670: 2020 2020 2020 2072 6574 7572 6e20 6e75         return nu
-00012680: 6d20 2f20 6465 6e0a 0a20 2020 2064 6566  m / den..    def
-00012690: 2063 616c 635f 6363 6328 0a20 2020 2020   calc_ccc(.     
-000126a0: 2020 2020 2020 2073 656c 662c 0a20 2020         self,.   
-000126b0: 2020 2020 2020 2020 2069 6e64 6963 6573           indices
-000126c0: 2c0a 2020 2020 2020 2020 2020 2020 6d61  ,.            ma
-000126d0: 705f 7072 6f62 652c 0a20 2020 2020 2020  p_probe,.       
-000126e0: 2020 2020 206d 6170 5f74 6172 6765 740a       map_target.
-000126f0: 2020 2020 293a 0a20 2020 2020 2020 206d      ):.        m
-00012700: 6170 5f74 6172 6765 745f 6d61 736b 203d  ap_target_mask =
-00012710: 206d 6170 5f74 6172 6765 742e 6675 6c6c   map_target.full
-00012720: 4d61 705b 696e 6469 6365 735d 0a20 2020  Map[indices].   
-00012730: 2020 2020 206d 6170 5f74 6172 6765 745f       map_target_
-00012740: 6d61 736b 203d 206d 6170 5f74 6172 6765  mask = map_targe
-00012750: 745f 6d61 736b 202d 2066 6c6f 6174 280a  t_mask - float(.
-00012760: 2020 2020 2020 2020 2020 2020 6d61 705f              map_
-00012770: 7461 7267 6574 5f6d 6173 6b2e 7375 6d28  target_mask.sum(
-00012780: 292f 6c65 6e28 6d61 705f 7461 7267 6574  )/len(map_target
-00012790: 5f6d 6173 6b29 0a20 2020 2020 2020 2029  _mask).        )
-000127a0: 0a20 2020 2020 2020 206d 6170 5f70 726f  .        map_pro
-000127b0: 6265 5f6d 6173 6b20 3d20 6d61 705f 7072  be_mask = map_pr
-000127c0: 6f62 652e 6675 6c6c 4d61 705b 696e 6469  obe.fullMap[indi
-000127d0: 6365 735d 0a20 2020 2020 2020 206d 6170  ces].        map
-000127e0: 5f70 726f 6265 5f6d 6173 6b20 3d20 6d61  _probe_mask = ma
-000127f0: 705f 7072 6f62 655f 6d61 736b 202d 2066  p_probe_mask - f
-00012800: 6c6f 6174 280a 2020 2020 2020 2020 2020  loat(.          
-00012810: 2020 6d61 705f 7072 6f62 655f 6d61 736b    map_probe_mask
-00012820: 2e73 756d 2829 2f6c 656e 286d 6170 5f70  .sum()/len(map_p
-00012830: 726f 6265 5f6d 6173 6b29 0a20 2020 2020  robe_mask).     
-00012840: 2020 2029 0a20 2020 2020 2020 206e 756d     ).        num
-00012850: 203d 206e 702e 7375 6d28 6d61 705f 7461   = np.sum(map_ta
-00012860: 7267 6574 5f6d 6173 6b20 2a20 6d61 705f  rget_mask * map_
-00012870: 7072 6f62 655f 6d61 736b 290a 2020 2020  probe_mask).    
-00012880: 2020 2020 6465 6e20 3d20 6e70 2e73 7172      den = np.sqr
-00012890: 7428 0a20 2020 2020 2020 2020 2020 206e  t(.            n
-000128a0: 702e 7375 6d28 6e70 2e73 7175 6172 6528  p.sum(np.square(
-000128b0: 6d61 705f 7461 7267 6574 5f6d 6173 6b29  map_target_mask)
-000128c0: 2920 2a0a 2020 2020 2020 2020 2020 2020  ) *.            
-000128d0: 6e70 2e73 756d 286e 702e 7371 7561 7265  np.sum(np.square
-000128e0: 286d 6170 5f70 726f 6265 5f6d 6173 6b29  (map_probe_mask)
-000128f0: 290a 2020 2020 2020 2020 290a 2020 2020  ).        ).    
-00012900: 2020 2020 6966 2064 656e 203d 3d20 302e      if den == 0.
-00012910: 303a 0a20 2020 2020 2020 2020 2020 2072  0:.            r
-00012920: 6574 7572 6e20 2d31 2e30 0a20 2020 2020  eturn -1.0.     
-00012930: 2020 2072 6574 7572 6e20 6e75 6d20 2f20     return num / 
-00012940: 6465 6e0a 0a20 2020 2064 6566 2069 6e64  den..    def ind
-00012950: 6963 6573 5f73 6d6f 6328 0a20 2020 2020  ices_smoc(.     
-00012960: 2020 2020 2020 2073 656c 662c 0a20 2020         self,.   
-00012970: 2020 2020 2020 2020 2073 636f 7265 5f69           score_i
-00012980: 6e64 6963 6573 2c0a 2020 2020 2020 2020  ndices,.        
-00012990: 2020 2020 6772 6964 5f69 6e64 6963 6573      grid_indices
-000129a0: 0a20 2020 2029 3a0a 2020 2020 2020 2020  .    ):.        
-000129b0: 746d 706c 6973 7420 3d20 7363 6f72 655f  tmplist = score_
-000129c0: 696e 6469 6365 735b 3a5d 0a20 2020 2020  indices[:].     
-000129d0: 2020 2073 6574 6c69 7374 203d 2073 6574     setlist = set
-000129e0: 2874 6d70 6c69 7374 290a 2020 2020 2020  (tmplist).      
-000129f0: 2020 696e 6469 6365 7320 3d20 6c69 7374    indices = list
-00012a00: 2873 6574 6c69 7374 290a 2020 2020 2020  (setlist).      
-00012a10: 2020 7363 5f69 6e64 6963 6573 203d 205b    sc_indices = [
-00012a20: 5d0a 2020 2020 2020 2020 666f 7220 6969  ].        for ii
-00012a30: 2069 6e20 696e 6469 6365 733a 0a20 2020   in indices:.   
-00012a40: 2020 2020 2020 2020 2073 635f 696e 6469           sc_indi
-00012a50: 6365 732e 6170 7065 6e64 2867 7269 645f  ces.append(grid_
-00012a60: 696e 6469 6365 735b 6969 5d29 0a20 2020  indices[ii]).   
-00012a70: 2020 2020 2061 7272 6179 5f69 6e64 6963       array_indic
-00012a80: 6573 203d 206e 702e 6172 7261 7928 7363  es = np.array(sc
-00012a90: 5f69 6e64 6963 6573 290a 2020 2020 2020  _indices).      
-00012aa0: 2020 696e 645f 6172 7278 797a 203d 206e    ind_arrxyz = n
-00012ab0: 702e 7472 616e 7370 6f73 6528 6172 7261  p.transpose(arra
-00012ac0: 795f 696e 6469 6365 7329 0a20 2020 2020  y_indices).     
-00012ad0: 2020 2069 6e64 5f61 7272 7a79 7820 3d20     ind_arrzyx = 
-00012ae0: 2869 6e64 5f61 7272 7879 7a5b 325d 2c20  (ind_arrxyz[2], 
-00012af0: 696e 645f 6172 7278 797a 5b31 5d2c 2069  ind_arrxyz[1], i
-00012b00: 6e64 5f61 7272 7879 7a5b 305d 290a 2020  nd_arrxyz[0]).  
-00012b10: 2020 2020 2020 7265 7475 726e 2069 6e64        return ind
-00012b20: 5f61 7272 7a79 780a 0a20 2020 2064 6566  _arrzyx..    def
-00012b30: 2073 6574 5f73 636f 7265 5f61 735f 6266   set_score_as_bf
-00012b40: 6163 746f 7228 0a20 2020 2020 2020 2020  actor(.         
-00012b50: 2020 2073 656c 662c 0a20 2020 2020 2020     self,.       
-00012b60: 2020 2020 2073 7472 7563 7475 7265 5f69       structure_i
-00012b70: 6e73 7461 6e63 652c 0a20 2020 2020 2020  nstance,.       
-00012b80: 2020 2020 2064 6963 745f 7363 6f72 6573       dict_scores
-00012b90: 2c0a 2020 2020 2020 2020 2020 2020 6465  ,.            de
-00012ba0: 6661 756c 743d 302e 302c 0a20 2020 2020  fault=0.0,.     
-00012bb0: 2020 2020 2020 2063 6869 643d 4e6f 6e65         chid=None
-00012bc0: 2c0a 2020 2020 2020 2020 2020 2020 6f75  ,.            ou
-00012bd0: 7466 696c 653d 2773 636f 7265 2e70 6462  tfile='score.pdb
-00012be0: 272c 0a20 2020 2029 3a0a 2020 2020 2020  ',.    ):.      
-00012bf0: 2020 2320 696e 636c 7564 6520 7363 6f72    # include scor
-00012c00: 6573 2061 7320 622d 6661 6374 6f72 2072  es as b-factor r
-00012c10: 6563 6f72 6473 0a20 2020 2020 2020 2066  ecords.        f
-00012c20: 6f72 2078 2069 6e20 7374 7275 6374 7572  or x in structur
-00012c30: 655f 696e 7374 616e 6365 2e61 746f 6d4c  e_instance.atomL
-00012c40: 6973 743a 0a20 2020 2020 2020 2020 2020  ist:.           
-00012c50: 2063 7572 5f63 6861 696e 203d 2078 2e63   cur_chain = x.c
-00012c60: 6861 696e 0a20 2020 2020 2020 2020 2020  hain.           
-00012c70: 2063 7572 5f72 6573 203d 2078 2e67 6574   cur_res = x.get
-00012c80: 5f72 6573 5f6e 6f28 290a 2020 2020 2020  _res_no().      
-00012c90: 2020 2020 2020 6966 2063 7572 5f63 6861        if cur_cha
-00012ca0: 696e 2069 6e20 6469 6374 5f73 636f 7265  in in dict_score
-00012cb0: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
-00012cc0: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
-00012cd0: 2020 2020 2020 2020 2020 2020 782e 7465              x.te
-00012ce0: 6d70 5f66 6163 203d 2022 7b30 3a2e 3266  mp_fac = "{0:.2f
-00012cf0: 7d22 2e66 6f72 6d61 7428 0a20 2020 2020  }".format(.     
-00012d00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012d10: 2020 2066 6c6f 6174 2864 6963 745f 7363     float(dict_sc
-00012d20: 6f72 6573 5b63 7572 5f63 6861 696e 5d5b  ores[cur_chain][
-00012d30: 6375 725f 7265 735d 290a 2020 2020 2020  cur_res]).      
-00012d40: 2020 2020 2020 2020 2020 2020 2020 290a                ).
-00012d50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012d60: 6578 6365 7074 2028 4b65 7945 7272 6f72  except (KeyError
-00012d70: 2c20 496e 6465 7845 7272 6f72 293a 0a20  , IndexError):. 
-00012d80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012d90: 2020 2070 7269 6e74 2827 5265 7369 6475     print('Residu
-00012da0: 6520 6d69 7373 696e 673a 2027 2c20 6375  e missing: ', cu
-00012db0: 725f 7265 732c 2063 6869 6429 0a20 2020  r_res, chid).   
-00012dc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012dd0: 2078 2e74 656d 705f 6661 6320 3d20 6465   x.temp_fac = de
-00012de0: 6661 756c 740a 2020 2020 2020 2020 2020  fault.          
-00012df0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-00012e00: 2020 2020 2020 2020 782e 7465 6d70 5f66          x.temp_f
-00012e10: 6163 203d 2064 6566 6175 6c74 0a20 2020  ac = default.   
-00012e20: 2020 2020 2073 7472 7563 7475 7265 5f69       structure_i
-00012e30: 6e73 7461 6e63 652e 7772 6974 655f 746f  nstance.write_to
-00012e40: 5f50 4442 286f 7574 6669 6c65 290a 0a20  _PDB(outfile).. 
-00012e50: 2020 2064 6566 2073 6d6f 635f 7363 6f72     def smoc_scor
-00012e60: 655f 7269 6769 645f 626f 6469 6573 280a  e_rigid_bodies(.
-00012e70: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00012e80: 2c0a 2020 2020 2020 2020 2020 2020 6469  ,.            di
-00012e90: 6374 5f72 6573 5f69 6e64 6963 6573 2c0a  ct_res_indices,.
-00012ea0: 2020 2020 2020 2020 2020 2020 7269 6769              rigi
-00012eb0: 645f 626f 6479 5f66 696c 652c 0a20 2020  d_body_file,.   
-00012ec0: 2020 2020 2020 2020 2063 682c 0a20 2020           ch,.   
-00012ed0: 2020 2020 2020 2020 2069 6e64 692c 0a20           indi,. 
-00012ee0: 2020 2020 2020 2020 2020 206d 6170 5f74             map_t
-00012ef0: 6172 6765 742c 0a20 2020 2020 2020 2020  arget,.         
-00012f00: 2020 2073 696d 5f6d 6170 0a20 2020 2029     sim_map.    )
-00012f10: 3a0a 2020 2020 2020 2020 6469 6374 5f72  :.        dict_r
-00012f20: 6573 5f73 636f 7265 7320 3d20 7b7d 0a20  es_scores = {}. 
-00012f30: 2020 2020 2020 2064 6963 745f 7262 6620         dict_rbf 
-00012f40: 3d20 5242 5061 7273 6572 2e72 6561 645f  = RBParser.read_
-00012f50: 7269 6769 645f 626f 6479 5f66 696c 6528  rigid_body_file(
-00012f60: 7269 6769 645f 626f 6479 5f66 696c 6529  rigid_body_file)
-00012f70: 0a20 2020 2020 2020 2063 6861 696e 6964  .        chainid
-00012f80: 5f73 6574 203d 2063 680a 2020 2020 2020  _set = ch.      
-00012f90: 2020 6966 206c 656e 2863 6829 203d 3d20    if len(ch) == 
-00012fa0: 303a 0a20 2020 2020 2020 2020 2020 2063  0:.            c
-00012fb0: 6861 696e 6964 5f73 6574 203d 2027 2d27  hainid_set = '-'
-00012fc0: 0a20 2020 2020 2020 2069 6620 6368 6169  .        if chai
-00012fd0: 6e69 645f 7365 7420 696e 2064 6963 745f  nid_set in dict_
-00012fe0: 7262 663a 0a20 2020 2020 2020 2020 2020  rbf:.           
-00012ff0: 2066 6f72 2072 6220 696e 2064 6963 745f   for rb in dict_
-00013000: 7262 665b 6368 6169 6e69 645f 7365 745d  rbf[chainid_set]
-00013010: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00013020: 2020 2320 6561 6368 2072 6967 6964 2062    # each rigid b
-00013030: 6f64 790a 2020 2020 2020 2020 2020 2020  ody.            
-00013040: 2020 2020 696e 6469 6365 7320 3d20 5b5d      indices = []
-00013050: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00013060: 2072 6573 5f6c 6973 7420 3d20 5b5d 0a20   res_list = []. 
-00013070: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00013080: 6f72 2073 6567 2069 6e20 6469 6374 5f72  or seg in dict_r
-00013090: 6266 5b63 6861 696e 6964 5f73 6574 5d5b  bf[chainid_set][
-000130a0: 7262 5d3a 0a20 2020 2020 2020 2020 2020  rb]:.           
-000130b0: 2020 2020 2020 2020 2074 7279 3a0a 2020           try:.  
-000130c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000130d0: 2020 2020 2020 666f 7220 7220 696e 2072        for r in r
-000130e0: 616e 6765 2869 6e74 2873 6567 5b30 5d29  ange(int(seg[0])
-000130f0: 2c20 696e 7428 7365 675b 315d 2920 2b20  , int(seg[1]) + 
-00013100: 3129 3a0a 2020 2020 2020 2020 2020 2020  1):.            
-00013110: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013120: 696e 6469 6365 732e 6578 7465 6e64 2864  indices.extend(d
-00013130: 6963 745f 7265 735f 696e 6469 6365 735b  ict_res_indices[
-00013140: 725d 290a 2020 2020 2020 2020 2020 2020  r]).            
-00013150: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013160: 7265 735f 6c69 7374 2e61 7070 656e 6428  res_list.append(
-00013170: 7229 0a20 2020 2020 2020 2020 2020 2020  r).             
-00013180: 2020 2020 2020 2065 7863 6570 7420 5479         except Ty
-00013190: 7065 4572 726f 723a 0a20 2020 2020 2020  peError:.       
-000131a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000131b0: 2063 6f6e 7469 6e75 650a 2020 2020 2020   continue.      
-000131c0: 2020 2020 2020 2020 2020 2320 6d69 6e69            # mini
-000131d0: 6d75 6d20 7661 6c75 6520 7365 7420 6173  mum value set as
-000131e0: 2030 2068 6572 6520 2861 7373 756d 696e   0 here (assumin
-000131f0: 6720 6f6e 6c79 2070 6f73 6974 6976 6520  g only positive 
-00013200: 7661 6c75 6573 2129 0a20 2020 2020 2020  values!).       
-00013210: 2020 2020 2020 2020 2069 6620 6c65 6e28           if len(
-00013220: 696e 6469 6365 7329 203d 3d20 303a 0a20  indices) == 0:. 
+00012130: 2072 6573 5f6c 6973 7420 3d20 5b5d 0a20   res_list = []. 
+00012140: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00012150: 6f72 2073 6567 2069 6e20 6469 6374 5f72  or seg in dict_r
+00012160: 6266 5b63 685d 5b72 625d 5b30 5d3a 0a20  bf[ch][rb][0]:. 
+00012170: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012180: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
+00012190: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000121a0: 666f 7220 7220 696e 2072 616e 6765 2869  for r in range(i
+000121b0: 6e74 2873 6567 5b30 5d29 2c20 696e 7428  nt(seg[0]), int(
+000121c0: 7365 675b 315d 2920 2b20 3129 3a0a 2020  seg[1]) + 1):.  
+000121d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000121e0: 2020 2020 2020 2020 2020 7265 735f 6c69            res_li
+000121f0: 7374 2e61 7070 656e 6428 7229 0a20 2020  st.append(r).   
+00012200: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012210: 2065 7863 6570 7420 5479 7065 4572 726f   except TypeErro
+00012220: 723a 0a20 2020 2020 2020 2020 2020 2020  r:.             
+00012230: 2020 2020 2020 2020 2020 2063 6f6e 7469             conti
+00012240: 6e75 650a 2020 2020 2020 2020 2020 2020  nue.            
+00012250: 2020 2020 7363 6f72 655f 5343 4343 203d      score_SCCC =
+00012260: 2073 656c 662e 5343 4343 280a 2020 2020   self.SCCC(.    
+00012270: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012280: 6d61 705f 7461 7267 6574 2c0a 2020 2020  map_target,.    
+00012290: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000122a0: 7265 736f 6c75 7469 6f6e 2c0a 2020 2020  resolution,.    
+000122b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000122c0: 7369 676d 615f 6d61 702c 0a20 2020 2020  sigma_map,.     
+000122d0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+000122e0: 7472 7563 7475 7265 5f69 6e73 7461 6e63  tructure_instanc
+000122f0: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
+00012300: 2020 2020 2020 2064 6963 745f 7262 665b         dict_rbf[
+00012310: 6368 5d5b 7262 5d5b 315d 0a20 2020 2020  ch][rb][1].     
+00012320: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
+00012330: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+00012340: 7262 206e 6f74 2069 6e20 6469 6374 5f72  rb not in dict_r
+00012350: 6967 6964 5f73 636f 7265 733a 0a20 2020  igid_scores:.   
+00012360: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012370: 2064 6963 745f 7269 6769 645f 7363 6f72   dict_rigid_scor
+00012380: 6573 5b72 625d 203d 2073 636f 7265 5f53  es[rb] = score_S
+00012390: 4343 430a 2020 2020 2020 2020 2020 2020  CCC.            
+000123a0: 2020 2020 2020 2020 6966 2073 636f 7265          if score
+000123b0: 5f53 4343 4320 3c20 6d69 6e73 636f 7265  _SCCC < minscore
+000123c0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+000123d0: 2020 2020 2020 2020 2020 6d69 6e73 636f            minsco
+000123e0: 7265 203d 2073 636f 7265 5f53 4343 430a  re = score_SCCC.
+000123f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012400: 2020 2020 6966 2073 636f 7265 5f53 4343      if score_SCC
+00012410: 4320 3e20 6d61 7873 636f 7265 3a0a 2020  C > maxscore:.  
+00012420: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012430: 2020 2020 2020 6d61 7873 636f 7265 203d        maxscore =
+00012440: 2073 636f 7265 5f53 4343 430a 2020 2020   score_SCCC.    
+00012450: 2020 2020 2020 2020 2020 2020 666f 7220              for 
+00012460: 7265 7320 696e 2072 6573 5f6c 6973 743a  res in res_list:
+00012470: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00012480: 2020 2020 2064 6963 745f 7265 735f 7363       dict_res_sc
+00012490: 6f72 6573 5b72 6573 5d20 3d20 7363 6f72  ores[res] = scor
+000124a0: 655f 5343 4343 0a0a 2020 2020 2020 2020  e_SCCC..        
+000124b0: 2020 2020 6469 6374 5f63 6861 696e 5f73      dict_chain_s
+000124c0: 636f 7265 735b 6368 5d20 3d20 6469 6374  cores[ch] = dict
+000124d0: 5f72 6573 5f73 636f 7265 730a 0a20 2020  _res_scores..   
+000124e0: 2020 2020 206d 696e 7363 6f72 6520 3d20       minscore = 
+000124f0: 6d61 7828 6d69 6e73 636f 7265 202d 2028  max(minscore - (
+00012500: 6d61 7873 636f 7265 202d 206d 696e 7363  maxscore - minsc
+00012510: 6f72 6529 202f 2035 2e2c 202d 312e 3029  ore) / 5., -1.0)
+00012520: 0a20 2020 2020 2020 2066 6f72 2063 6820  .        for ch 
+00012530: 696e 2064 6963 745f 6368 6169 6e5f 7363  in dict_chain_sc
+00012540: 6f72 6573 3a0a 2020 2020 2020 2020 2020  ores:.          
+00012550: 2020 666f 7220 7265 7320 696e 2064 6963    for res in dic
+00012560: 745f 6368 6169 6e5f 7363 6f72 6573 5b63  t_chain_scores[c
+00012570: 685d 3a0a 2020 2020 2020 2020 2020 2020  h]:.            
+00012580: 2020 2020 6966 2064 6963 745f 6368 6169      if dict_chai
+00012590: 6e5f 7363 6f72 6573 5b63 685d 5b72 6573  n_scores[ch][res
+000125a0: 5d20 3d3d 202d 322e 303a 0a20 2020 2020  ] == -2.0:.     
+000125b0: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+000125c0: 6963 745f 6368 6169 6e5f 7363 6f72 6573  ict_chain_scores
+000125d0: 5b63 685d 5b72 6573 5d20 3d20 6d69 6e73  [ch][res] = mins
+000125e0: 636f 7265 0a0a 2020 2020 2020 2020 7265  core..        re
+000125f0: 7475 726e 2064 6963 745f 6368 6169 6e5f  turn dict_chain_
+00012600: 7363 6f72 6573 2c20 6469 6374 5f72 6967  scores, dict_rig
+00012610: 6964 5f73 636f 7265 730a 0a20 2020 2064  id_scores..    d
+00012620: 6566 2063 616c 635f 6d6f 6328 0a20 2020  ef calc_moc(.   
+00012630: 2020 2020 2020 2020 2073 656c 662c 0a20           self,. 
+00012640: 2020 2020 2020 2020 2020 2069 6e64 6963             indic
+00012650: 6573 2c0a 2020 2020 2020 2020 2020 2020  es,.            
+00012660: 6d61 705f 7072 6f62 652c 0a20 2020 2020  map_probe,.     
+00012670: 2020 2020 2020 206d 6170 5f74 6172 6765         map_targe
+00012680: 742c 0a20 2020 2029 3a0a 2020 2020 2020  t,.    ):.      
+00012690: 2020 6d61 705f 7461 7267 6574 5f6d 6173    map_target_mas
+000126a0: 6b20 3d20 6d61 705f 7461 7267 6574 2e66  k = map_target.f
+000126b0: 756c 6c4d 6170 5b69 6e64 6963 6573 5d0a  ullMap[indices].
+000126c0: 2020 2020 2020 2020 6d61 705f 7072 6f62          map_prob
+000126d0: 655f 6d61 736b 203d 206d 6170 5f70 726f  e_mask = map_pro
+000126e0: 6265 2e66 756c 6c4d 6170 5b69 6e64 6963  be.fullMap[indic
+000126f0: 6573 5d0a 2020 2020 2020 2020 6e75 6d20  es].        num 
+00012700: 3d20 6e70 2e73 756d 286d 6170 5f74 6172  = np.sum(map_tar
+00012710: 6765 745f 6d61 736b 202a 206d 6170 5f70  get_mask * map_p
+00012720: 726f 6265 5f6d 6173 6b29 0a20 2020 2020  robe_mask).     
+00012730: 2020 2064 656e 203d 206e 702e 7371 7274     den = np.sqrt
+00012740: 280a 2020 2020 2020 2020 2020 2020 6e70  (.            np
+00012750: 2e73 756d 286e 702e 7371 7561 7265 286d  .sum(np.square(m
+00012760: 6170 5f74 6172 6765 745f 6d61 736b 2929  ap_target_mask))
+00012770: 202a 0a20 2020 2020 2020 2020 2020 206e   *.            n
+00012780: 702e 7375 6d28 6e70 2e73 7175 6172 6528  p.sum(np.square(
+00012790: 6d61 705f 7072 6f62 655f 6d61 736b 2929  map_probe_mask))
+000127a0: 0a20 2020 2020 2020 2029 0a20 2020 2020  .        ).     
+000127b0: 2020 2069 6620 6465 6e20 3d3d 2030 2e30     if den == 0.0
+000127c0: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
+000127d0: 7475 726e 202d 312e 300a 2020 2020 2020  turn -1.0.      
+000127e0: 2020 7265 7475 726e 206e 756d 202f 2064    return num / d
+000127f0: 656e 0a0a 2020 2020 6465 6620 6361 6c63  en..    def calc
+00012800: 5f63 6363 280a 2020 2020 2020 2020 2020  _ccc(.          
+00012810: 2020 7365 6c66 2c0a 2020 2020 2020 2020    self,.        
+00012820: 2020 2020 696e 6469 6365 732c 0a20 2020      indices,.   
+00012830: 2020 2020 2020 2020 206d 6170 5f70 726f           map_pro
+00012840: 6265 2c0a 2020 2020 2020 2020 2020 2020  be,.            
+00012850: 6d61 705f 7461 7267 6574 0a20 2020 2029  map_target.    )
+00012860: 3a0a 2020 2020 2020 2020 6d61 705f 7461  :.        map_ta
+00012870: 7267 6574 5f6d 6173 6b20 3d20 6d61 705f  rget_mask = map_
+00012880: 7461 7267 6574 2e66 756c 6c4d 6170 5b69  target.fullMap[i
+00012890: 6e64 6963 6573 5d0a 2020 2020 2020 2020  ndices].        
+000128a0: 6d61 705f 7461 7267 6574 5f6d 6173 6b20  map_target_mask 
+000128b0: 3d20 6d61 705f 7461 7267 6574 5f6d 6173  = map_target_mas
+000128c0: 6b20 2d20 666c 6f61 7428 0a20 2020 2020  k - float(.     
+000128d0: 2020 2020 2020 206d 6170 5f74 6172 6765         map_targe
+000128e0: 745f 6d61 736b 2e73 756d 2829 2f6c 656e  t_mask.sum()/len
+000128f0: 286d 6170 5f74 6172 6765 745f 6d61 736b  (map_target_mask
+00012900: 290a 2020 2020 2020 2020 290a 2020 2020  ).        ).    
+00012910: 2020 2020 6d61 705f 7072 6f62 655f 6d61      map_probe_ma
+00012920: 736b 203d 206d 6170 5f70 726f 6265 2e66  sk = map_probe.f
+00012930: 756c 6c4d 6170 5b69 6e64 6963 6573 5d0a  ullMap[indices].
+00012940: 2020 2020 2020 2020 6d61 705f 7072 6f62          map_prob
+00012950: 655f 6d61 736b 203d 206d 6170 5f70 726f  e_mask = map_pro
+00012960: 6265 5f6d 6173 6b20 2d20 666c 6f61 7428  be_mask - float(
+00012970: 0a20 2020 2020 2020 2020 2020 206d 6170  .            map
+00012980: 5f70 726f 6265 5f6d 6173 6b2e 7375 6d28  _probe_mask.sum(
+00012990: 292f 6c65 6e28 6d61 705f 7072 6f62 655f  )/len(map_probe_
+000129a0: 6d61 736b 290a 2020 2020 2020 2020 290a  mask).        ).
+000129b0: 2020 2020 2020 2020 6e75 6d20 3d20 6e70          num = np
+000129c0: 2e73 756d 286d 6170 5f74 6172 6765 745f  .sum(map_target_
+000129d0: 6d61 736b 202a 206d 6170 5f70 726f 6265  mask * map_probe
+000129e0: 5f6d 6173 6b29 0a20 2020 2020 2020 2064  _mask).        d
+000129f0: 656e 203d 206e 702e 7371 7274 280a 2020  en = np.sqrt(.  
+00012a00: 2020 2020 2020 2020 2020 6e70 2e73 756d            np.sum
+00012a10: 286e 702e 7371 7561 7265 286d 6170 5f74  (np.square(map_t
+00012a20: 6172 6765 745f 6d61 736b 2929 202a 0a20  arget_mask)) *. 
+00012a30: 2020 2020 2020 2020 2020 206e 702e 7375             np.su
+00012a40: 6d28 6e70 2e73 7175 6172 6528 6d61 705f  m(np.square(map_
+00012a50: 7072 6f62 655f 6d61 736b 2929 0a20 2020  probe_mask)).   
+00012a60: 2020 2020 2029 0a20 2020 2020 2020 2069       ).        i
+00012a70: 6620 6465 6e20 3d3d 2030 2e30 3a0a 2020  f den == 0.0:.  
+00012a80: 2020 2020 2020 2020 2020 7265 7475 726e            return
+00012a90: 202d 312e 300a 2020 2020 2020 2020 7265   -1.0.        re
+00012aa0: 7475 726e 206e 756d 202f 2064 656e 0a0a  turn num / den..
+00012ab0: 2020 2020 6465 6620 696e 6469 6365 735f      def indices_
+00012ac0: 736d 6f63 280a 2020 2020 2020 2020 2020  smoc(.          
+00012ad0: 2020 7365 6c66 2c0a 2020 2020 2020 2020    self,.        
+00012ae0: 2020 2020 7363 6f72 655f 696e 6469 6365      score_indice
+00012af0: 732c 0a20 2020 2020 2020 2020 2020 2067  s,.            g
+00012b00: 7269 645f 696e 6469 6365 730a 2020 2020  rid_indices.    
+00012b10: 293a 0a20 2020 2020 2020 2074 6d70 6c69  ):.        tmpli
+00012b20: 7374 203d 2073 636f 7265 5f69 6e64 6963  st = score_indic
+00012b30: 6573 5b3a 5d0a 2020 2020 2020 2020 7365  es[:].        se
+00012b40: 746c 6973 7420 3d20 7365 7428 746d 706c  tlist = set(tmpl
+00012b50: 6973 7429 0a20 2020 2020 2020 2069 6e64  ist).        ind
+00012b60: 6963 6573 203d 206c 6973 7428 7365 746c  ices = list(setl
+00012b70: 6973 7429 0a20 2020 2020 2020 2073 635f  ist).        sc_
+00012b80: 696e 6469 6365 7320 3d20 5b5d 0a20 2020  indices = [].   
+00012b90: 2020 2020 2066 6f72 2069 6920 696e 2069       for ii in i
+00012ba0: 6e64 6963 6573 3a0a 2020 2020 2020 2020  ndices:.        
+00012bb0: 2020 2020 7363 5f69 6e64 6963 6573 2e61      sc_indices.a
+00012bc0: 7070 656e 6428 6772 6964 5f69 6e64 6963  ppend(grid_indic
+00012bd0: 6573 5b69 695d 290a 2020 2020 2020 2020  es[ii]).        
+00012be0: 6172 7261 795f 696e 6469 6365 7320 3d20  array_indices = 
+00012bf0: 6e70 2e61 7272 6179 2873 635f 696e 6469  np.array(sc_indi
+00012c00: 6365 7329 0a20 2020 2020 2020 2069 6e64  ces).        ind
+00012c10: 5f61 7272 7879 7a20 3d20 6e70 2e74 7261  _arrxyz = np.tra
+00012c20: 6e73 706f 7365 2861 7272 6179 5f69 6e64  nspose(array_ind
+00012c30: 6963 6573 290a 2020 2020 2020 2020 696e  ices).        in
+00012c40: 645f 6172 727a 7978 203d 2028 696e 645f  d_arrzyx = (ind_
+00012c50: 6172 7278 797a 5b32 5d2c 2069 6e64 5f61  arrxyz[2], ind_a
+00012c60: 7272 7879 7a5b 315d 2c20 696e 645f 6172  rrxyz[1], ind_ar
+00012c70: 7278 797a 5b30 5d29 0a20 2020 2020 2020  rxyz[0]).       
+00012c80: 2072 6574 7572 6e20 696e 645f 6172 727a   return ind_arrz
+00012c90: 7978 0a0a 2020 2020 6465 6620 7365 745f  yx..    def set_
+00012ca0: 7363 6f72 655f 6173 5f62 6661 6374 6f72  score_as_bfactor
+00012cb0: 280a 2020 2020 2020 2020 2020 2020 7365  (.            se
+00012cc0: 6c66 2c0a 2020 2020 2020 2020 2020 2020  lf,.            
+00012cd0: 7374 7275 6374 7572 655f 696e 7374 616e  structure_instan
+00012ce0: 6365 2c0a 2020 2020 2020 2020 2020 2020  ce,.            
+00012cf0: 6469 6374 5f73 636f 7265 732c 0a20 2020  dict_scores,.   
+00012d00: 2020 2020 2020 2020 2064 6566 6175 6c74           default
+00012d10: 3d30 2e30 2c0a 2020 2020 2020 2020 2020  =0.0,.          
+00012d20: 2020 6368 6964 3d4e 6f6e 652c 0a20 2020    chid=None,.   
+00012d30: 2020 2020 2020 2020 206f 7574 6669 6c65           outfile
+00012d40: 3d27 7363 6f72 652e 7064 6227 2c0a 2020  ='score.pdb',.  
+00012d50: 2020 293a 0a20 2020 2020 2020 2023 2069    ):.        # i
+00012d60: 6e63 6c75 6465 2073 636f 7265 7320 6173  nclude scores as
+00012d70: 2062 2d66 6163 746f 7220 7265 636f 7264   b-factor record
+00012d80: 730a 2020 2020 2020 2020 666f 7220 7820  s.        for x 
+00012d90: 696e 2073 7472 7563 7475 7265 5f69 6e73  in structure_ins
+00012da0: 7461 6e63 652e 6174 6f6d 4c69 7374 3a0a  tance.atomList:.
+00012db0: 2020 2020 2020 2020 2020 2020 6375 725f              cur_
+00012dc0: 6368 6169 6e20 3d20 782e 6368 6169 6e0a  chain = x.chain.
+00012dd0: 2020 2020 2020 2020 2020 2020 6375 725f              cur_
+00012de0: 7265 7320 3d20 782e 6765 745f 7265 735f  res = x.get_res_
+00012df0: 6e6f 2829 0a20 2020 2020 2020 2020 2020  no().           
+00012e00: 2069 6620 6375 725f 6368 6169 6e20 696e   if cur_chain in
+00012e10: 2064 6963 745f 7363 6f72 6573 3a0a 2020   dict_scores:.  
+00012e20: 2020 2020 2020 2020 2020 2020 2020 7472                tr
+00012e30: 793a 0a20 2020 2020 2020 2020 2020 2020  y:.             
+00012e40: 2020 2020 2020 2078 2e74 656d 705f 6661         x.temp_fa
+00012e50: 6320 3d20 227b 303a 2e32 667d 222e 666f  c = "{0:.2f}".fo
+00012e60: 726d 6174 280a 2020 2020 2020 2020 2020  rmat(.          
+00012e70: 2020 2020 2020 2020 2020 2020 2020 666c                fl
+00012e80: 6f61 7428 6469 6374 5f73 636f 7265 735b  oat(dict_scores[
+00012e90: 6375 725f 6368 6169 6e5d 5b63 7572 5f72  cur_chain][cur_r
+00012ea0: 6573 5d29 0a20 2020 2020 2020 2020 2020  es]).           
+00012eb0: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
+00012ec0: 2020 2020 2020 2020 2020 2065 7863 6570             excep
+00012ed0: 7420 284b 6579 4572 726f 722c 2049 6e64  t (KeyError, Ind
+00012ee0: 6578 4572 726f 7229 3a0a 2020 2020 2020  exError):.      
+00012ef0: 2020 2020 2020 2020 2020 2020 2020 7072                pr
+00012f00: 696e 7428 2752 6573 6964 7565 206d 6973  int('Residue mis
+00012f10: 7369 6e67 3a20 272c 2063 7572 5f72 6573  sing: ', cur_res
+00012f20: 2c20 6368 6964 290a 2020 2020 2020 2020  , chid).        
+00012f30: 2020 2020 2020 2020 2020 2020 782e 7465              x.te
+00012f40: 6d70 5f66 6163 203d 2064 6566 6175 6c74  mp_fac = default
+00012f50: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
+00012f60: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+00012f70: 2020 2078 2e74 656d 705f 6661 6320 3d20     x.temp_fac = 
+00012f80: 6465 6661 756c 740a 2020 2020 2020 2020  default.        
+00012f90: 7374 7275 6374 7572 655f 696e 7374 616e  structure_instan
+00012fa0: 6365 2e77 7269 7465 5f74 6f5f 5044 4228  ce.write_to_PDB(
+00012fb0: 6f75 7466 696c 6529 0a0a 2020 2020 6465  outfile)..    de
+00012fc0: 6620 736d 6f63 5f73 636f 7265 5f72 6967  f smoc_score_rig
+00012fd0: 6964 5f62 6f64 6965 7328 0a20 2020 2020  id_bodies(.     
+00012fe0: 2020 2020 2020 2073 656c 662c 0a20 2020         self,.   
+00012ff0: 2020 2020 2020 2020 2064 6963 745f 7265           dict_re
+00013000: 735f 696e 6469 6365 732c 0a20 2020 2020  s_indices,.     
+00013010: 2020 2020 2020 2072 6967 6964 5f62 6f64         rigid_bod
+00013020: 795f 6669 6c65 2c0a 2020 2020 2020 2020  y_file,.        
+00013030: 2020 2020 6368 2c0a 2020 2020 2020 2020      ch,.        
+00013040: 2020 2020 696e 6469 2c0a 2020 2020 2020      indi,.      
+00013050: 2020 2020 2020 6d61 705f 7461 7267 6574        map_target
+00013060: 2c0a 2020 2020 2020 2020 2020 2020 7369  ,.            si
+00013070: 6d5f 6d61 700a 2020 2020 293a 0a20 2020  m_map.    ):.   
+00013080: 2020 2020 2064 6963 745f 7265 735f 7363       dict_res_sc
+00013090: 6f72 6573 203d 207b 7d0a 2020 2020 2020  ores = {}.      
+000130a0: 2020 6469 6374 5f72 6266 203d 2052 4250    dict_rbf = RBP
+000130b0: 6172 7365 722e 7265 6164 5f72 6967 6964  arser.read_rigid
+000130c0: 5f62 6f64 795f 6669 6c65 2872 6967 6964  _body_file(rigid
+000130d0: 5f62 6f64 795f 6669 6c65 290a 2020 2020  _body_file).    
+000130e0: 2020 2020 6368 6169 6e69 645f 7365 7420      chainid_set 
+000130f0: 3d20 6368 0a20 2020 2020 2020 2069 6620  = ch.        if 
+00013100: 6c65 6e28 6368 2920 3d3d 2030 3a0a 2020  len(ch) == 0:.  
+00013110: 2020 2020 2020 2020 2020 6368 6169 6e69            chaini
+00013120: 645f 7365 7420 3d20 272d 270a 2020 2020  d_set = '-'.    
+00013130: 2020 2020 6966 2063 6861 696e 6964 5f73      if chainid_s
+00013140: 6574 2069 6e20 6469 6374 5f72 6266 3a0a  et in dict_rbf:.
+00013150: 2020 2020 2020 2020 2020 2020 666f 7220              for 
+00013160: 7262 2069 6e20 6469 6374 5f72 6266 5b63  rb in dict_rbf[c
+00013170: 6861 696e 6964 5f73 6574 5d3a 0a20 2020  hainid_set]:.   
+00013180: 2020 2020 2020 2020 2020 2020 2023 2065               # e
+00013190: 6163 6820 7269 6769 6420 626f 6479 0a20  ach rigid body. 
+000131a0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+000131b0: 6e64 6963 6573 203d 205b 5d0a 2020 2020  ndices = [].    
+000131c0: 2020 2020 2020 2020 2020 2020 7265 735f              res_
+000131d0: 6c69 7374 203d 205b 5d0a 2020 2020 2020  list = [].      
+000131e0: 2020 2020 2020 2020 2020 666f 7220 7365            for se
+000131f0: 6720 696e 2064 6963 745f 7262 665b 6368  g in dict_rbf[ch
+00013200: 6169 6e69 645f 7365 745d 5b72 625d 3a0a  ainid_set][rb]:.
+00013210: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013220: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
 00013230: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013240: 2020 2066 6f72 2072 6573 2069 6e20 7265     for res in re
-00013250: 735f 6c69 7374 3a0a 2020 2020 2020 2020  s_list:.        
-00013260: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013270: 6469 6374 5f72 6573 5f73 636f 7265 735b  dict_res_scores[
-00013280: 7265 735d 203d 2030 2e30 2020 2320 2d30  res] = 0.0  # -0
-00013290: 2e39 390a 2020 2020 2020 2020 2020 2020  .99.            
-000132a0: 2020 2020 2020 2020 636f 6e74 696e 7565          continue
-000132b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000132c0: 2074 7279 3a0a 2020 2020 2020 2020 2020   try:.          
-000132d0: 2020 2020 2020 2020 2020 696e 645f 6172            ind_ar
-000132e0: 727a 7978 203d 2073 656c 662e 696e 6469  rzyx = self.indi
-000132f0: 6365 735f 736d 6f63 2869 6e64 6963 6573  ces_smoc(indices
-00013300: 2c20 696e 6469 290a 2020 2020 2020 2020  , indi).        
-00013310: 2020 2020 2020 2020 2020 2020 736d 6f63              smoc
-00013320: 203d 2073 656c 662e 6361 6c63 5f6d 6f63   = self.calc_moc
-00013330: 2869 6e64 5f61 7272 7a79 782c 2073 696d  (ind_arrzyx, sim
-00013340: 5f6d 6170 2c20 6d61 705f 7461 7267 6574  _map, map_target
-00013350: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00013360: 2020 6578 6365 7074 2049 6e64 6578 4572    except IndexEr
-00013370: 726f 723a 0a20 2020 2020 2020 2020 2020  ror:.           
-00013380: 2020 2020 2020 2020 2073 6d6f 6320 3d20           smoc = 
-00013390: 302e 300a 2020 2020 2020 2020 2020 2020  0.0.            
-000133a0: 2020 2020 2320 7361 7665 2073 636f 7265      # save score
-000133b0: 730a 2020 2020 2020 2020 2020 2020 2020  s.              
-000133c0: 2020 666f 7220 7265 7320 696e 2072 6573    for res in res
-000133d0: 5f6c 6973 743a 0a20 2020 2020 2020 2020  _list:.         
-000133e0: 2020 2020 2020 2020 2020 2064 6963 745f             dict_
-000133f0: 7265 735f 7363 6f72 6573 5b72 6573 5d20  res_scores[res] 
-00013400: 3d20 736d 6f63 0a20 2020 2020 2020 2072  = smoc.        r
-00013410: 6574 7572 6e20 6469 6374 5f72 6573 5f73  eturn dict_res_s
-00013420: 636f 7265 730a 0a20 2020 2064 6566 2073  cores..    def s
-00013430: 6d6f 635f 6765 745f 696e 6469 6365 735f  moc_get_indices_
-00013440: 6672 6167 6d65 6e74 5f77 696e 646f 7728  fragment_window(
-00013450: 7365 6c66 2c20 6469 6374 5f72 6573 5f69  self, dict_res_i
-00013460: 6e64 6963 6573 2c0a 2020 2020 2020 2020  ndices,.        
-00013470: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013480: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013490: 2064 6963 745f 6368 6169 6e5f 7265 732c   dict_chain_res,
-000134a0: 2063 682c 2072 6573 2c0a 2020 2020 2020   ch, res,.      
-000134b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000134c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000134d0: 2020 2077 696e 293a 0a20 2020 2020 2020     win):.       
-000134e0: 2069 6e64 6963 6573 203d 2064 6963 745f   indices = dict_
-000134f0: 7265 735f 696e 6469 6365 735b 7265 735d  res_indices[res]
-00013500: 5b3a 5d0a 2020 2020 2020 2020 2320 636f  [:].        # co
-00013510: 6e73 6964 6572 2072 6573 6964 7565 7320  nsider residues 
-00013520: 6f6e 2062 6f74 6820 7369 6465 732e 204e  on both sides. N
-00013530: 4f54 453a 2077 6f6e 7420 776f 726b 2066  OTE: wont work f
-00013540: 6f72 2069 6e73 6572 7469 6f6e 2063 6f64  or insertion cod
-00013550: 6573 210a 2020 2020 2020 2020 2320 6e65  es!.        # ne
-00013560: 6564 2074 6f20 7265 7769 7465 2072 6573  ed to rewite res
-00013570: 206e 756d 6265 7273 2074 6f20 6176 6f69   numbers to avoi
-00013580: 6420 696e 7365 7274 696f 6e20 636f 6465  d insertion code
-00013590: 730a 2020 2020 2020 2020 666f 7220 6969  s.        for ii
-000135a0: 2069 6e20 7261 6e67 6528 312c 2069 6e74   in range(1, int
-000135b0: 2872 6f75 6e64 2828 7769 6e20 2b20 3129  (round((win + 1)
-000135c0: 202f 2032 2929 293a 0a20 2020 2020 2020   / 2))):.       
-000135d0: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
-000135e0: 2020 2020 2020 2020 2020 7265 735f 6964            res_id
-000135f0: 7820 3d20 6469 6374 5f63 6861 696e 5f72  x = dict_chain_r
-00013600: 6573 5b63 685d 2e69 6e64 6578 2872 6573  es[ch].index(res
-00013610: 2920 2d20 6969 0a20 2020 2020 2020 2020  ) - ii.         
-00013620: 2020 2020 2020 2069 6620 7265 735f 6964         if res_id
-00013630: 7820 3c20 303a 0a20 2020 2020 2020 2020  x < 0:.         
-00013640: 2020 2020 2020 2020 2020 2063 6f6e 7469             conti
-00013650: 6e75 650a 2020 2020 2020 2020 2020 2020  nue.            
-00013660: 2020 2020 2320 6765 7420 7072 6576 2072      # get prev r
-00013670: 6573 6964 7565 2069 6e64 6963 6573 0a20  esidue indices. 
-00013680: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00013690: 6e64 6963 6573 2e65 7874 656e 6428 0a20  ndices.extend(. 
-000136a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000136b0: 2020 2064 6963 745f 7265 735f 696e 6469     dict_res_indi
-000136c0: 6365 735b 0a20 2020 2020 2020 2020 2020  ces[.           
-000136d0: 2020 2020 2020 2020 2020 2020 2064 6963               dic
-000136e0: 745f 6368 6169 6e5f 7265 735b 6368 5d0a  t_chain_res[ch].
-000136f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013700: 2020 2020 2020 2020 5b0a 2020 2020 2020          [.      
-00013710: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013720: 2020 2020 2020 7265 735f 6964 780a 2020        res_idx.  
-00013730: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013740: 2020 2020 2020 5d0a 2020 2020 2020 2020        ].        
-00013750: 2020 2020 2020 2020 2020 2020 5d0a 2020              ].  
-00013760: 2020 2020 2020 2020 2020 2020 2020 290a                ).
-00013770: 2020 2020 2020 2020 2020 2020 6578 6365              exce
-00013780: 7074 2028 4b65 7945 7272 6f72 2c20 496e  pt (KeyError, In
-00013790: 6465 7845 7272 6f72 293a 0a20 2020 2020  dexError):.     
-000137a0: 2020 2020 2020 2020 2020 2070 6173 730a             pass.
-000137b0: 2020 2020 2020 2020 666f 7220 6969 2069          for ii i
-000137c0: 6e20 7261 6e67 6528 312c 2069 6e74 2872  n range(1, int(r
-000137d0: 6f75 6e64 2828 7769 6e20 2b20 3129 202f  ound((win + 1) /
-000137e0: 2032 2929 293a 0a20 2020 2020 2020 2020   2))):.         
-000137f0: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
-00013800: 2020 2020 2020 2020 696e 6469 6365 732e          indices.
-00013810: 6578 7465 6e64 280a 2020 2020 2020 2020  extend(.        
-00013820: 2020 2020 2020 2020 2020 2020 6469 6374              dict
-00013830: 5f72 6573 5f69 6e64 6963 6573 5b0a 2020  _res_indices[.  
-00013840: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013850: 2020 2020 2020 6469 6374 5f63 6861 696e        dict_chain
-00013860: 5f72 6573 5b63 685d 0a20 2020 2020 2020  _res[ch].       
-00013870: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013880: 205b 0a20 2020 2020 2020 2020 2020 2020   [.             
-00013890: 2020 2020 2020 2020 2020 2020 2020 2064                 d
-000138a0: 6963 745f 6368 6169 6e5f 7265 735b 6368  ict_chain_res[ch
-000138b0: 5d2e 696e 6465 7828 7265 7329 202b 2069  ].index(res) + i
-000138c0: 690a 2020 2020 2020 2020 2020 2020 2020  i.              
-000138d0: 2020 2020 2020 2020 2020 5d0a 2020 2020            ].    
-000138e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000138f0: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
-00013900: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
-00013910: 6578 6365 7074 2028 496e 6465 7845 7272  except (IndexErr
-00013920: 6f72 2c20 4b65 7945 7272 6f72 293a 0a20  or, KeyError):. 
-00013930: 2020 2020 2020 2020 2020 2020 2020 2070                 p
-00013940: 6173 730a 2020 2020 2020 2020 7265 7475  ass.        retu
-00013950: 726e 2069 6e64 6963 6573 0a0a 2020 2020  rn indices..    
-00013960: 6465 6620 736d 6f63 5f67 6574 5f69 6e64  def smoc_get_ind
-00013970: 6963 6573 5f73 7068 6572 6528 7365 6c66  ices_sphere(self
-00013980: 2c20 6772 6964 7472 6565 2c20 636f 6f72  , gridtree, coor
-00013990: 642c 2064 6973 743d 352e 3029 3a0a 2020  d, dist=5.0):.  
-000139a0: 2020 2020 2020 6c69 7374 5f70 6f69 6e74        list_point
-000139b0: 7320 3d20 6772 6964 7472 6565 2e71 7565  s = gridtree.que
-000139c0: 7279 5f62 616c 6c5f 706f 696e 7428 0a20  ry_ball_point(. 
-000139d0: 2020 2020 2020 2020 2020 205b 636f 6f72             [coor
-000139e0: 645b 305d 2c20 636f 6f72 645b 315d 2c20  d[0], coord[1], 
-000139f0: 636f 6f72 645b 325d 5d2c 0a20 2020 2020  coord[2]],.     
-00013a00: 2020 2020 2020 2064 6973 740a 2020 2020         dist.    
-00013a10: 2020 2020 290a 2020 2020 2020 2020 7265      ).        re
-00013a20: 7475 726e 206c 6973 745f 706f 696e 7473  turn list_points
-00013a30: 0a0a 2020 2020 6465 6620 534d 4f43 2873  ..    def SMOC(s
-00013a40: 656c 662c 0a20 2020 2020 2020 2020 2020  elf,.           
-00013a50: 2020 6d61 705f 7461 7267 6574 2c0a 2020    map_target,.  
-00013a60: 2020 2020 2020 2020 2020 2072 6573 6f6c             resol
-00013a70: 7574 696f 6e5f 6465 6e73 4d61 702c 0a20  ution_densMap,. 
-00013a80: 2020 2020 2020 2020 2020 2020 7374 7275              stru
-00013a90: 6374 7572 655f 696e 7374 616e 6365 3d4e  cture_instance=N
-00013aa0: 6f6e 652c 0a20 2020 2020 2020 2020 2020  one,.           
-00013ab0: 2020 7769 6e3d 3131 2c0a 2020 2020 2020    win=11,.      
-00013ac0: 2020 2020 2020 2072 6967 6964 5f62 6f64         rigid_bod
-00013ad0: 795f 6669 6c65 3d4e 6f6e 652c 0a20 2020  y_file=None,.   
-00013ae0: 2020 2020 2020 2020 2020 7369 6d5f 6d61            sim_ma
-00013af0: 703d 4e6f 6e65 2c0a 2020 2020 2020 2020  p=None,.        
-00013b00: 2020 2020 2073 6967 6d61 5f6d 6170 3d30       sigma_map=0
-00013b10: 2e32 3235 2c0a 2020 2020 2020 2020 2020  .225,.          
-00013b20: 2020 2077 7269 7465 3d46 616c 7365 2c0a     write=False,.
-00013b30: 2020 2020 2020 2020 2020 2020 2063 5f6d               c_m
-00013b40: 6f64 653d 5472 7565 2c0a 2020 2020 2020  ode=True,.      
-00013b50: 2020 2020 2020 2073 6967 6d61 5f74 6872         sigma_thr
-00013b60: 3d32 2e35 2c0a 2020 2020 2020 2020 2020  =2.5,.          
-00013b70: 2020 2066 7261 676d 656e 745f 7363 6f72     fragment_scor
-00013b80: 653d 5472 7565 2c0a 2020 2020 2020 2020  e=True,.        
-00013b90: 2020 2020 2064 6973 743d 352e 302c 0a20       dist=5.0,. 
-00013ba0: 2020 2020 2020 2020 2020 2020 6174 6f6d              atom
-00013bb0: 5f63 656e 7472 653d 2743 4127 2c0a 2020  _centre='CA',.  
-00013bc0: 2020 2020 2020 2020 2020 2063 616c 635f             calc_
-00013bd0: 6d65 7472 6963 3d27 736d 6f63 272c 0a20  metric='smoc',. 
-00013be0: 2020 2020 2020 2020 2020 2020 6765 745f              get_
-00013bf0: 636f 6f72 643d 5472 7565 0a20 2020 2020  coord=True.     
-00013c00: 2020 2020 2020 2020 293a 0a20 2020 2020          ):.     
-00013c10: 2020 2022 2222 4361 6c63 756c 6174 6520     """Calculate 
-00013c20: 7468 6520 6c6f 6361 6c20 4d61 6e64 6572  the local Mander
-00013c30: 2773 204f 7665 726c 6170 2066 6f72 2065  's Overlap for e
-00013c40: 6163 6820 7265 7369 6475 6520 696e 2061  ach residue in a
-00013c50: 2070 726f 7465 696e 0a20 2020 2020 2020   protein.       
-00013c60: 206d 6f64 656c 0a0a 2020 2020 2020 2020   model..        
-00013c70: 534d 4f43 2063 616e 2062 6520 6361 6c63  SMOC can be calc
-00013c80: 756c 6174 6564 2069 6e20 7477 6f20 7761  ulated in two wa
-00013c90: 7973 3a0a 0a20 2020 2020 2020 2020 2020  ys:..           
-00013ca0: 202a 202a 2a53 4d4f 4366 2a2a 3a20 5468   * **SMOCf**: Th
-00013cb0: 6520 534d 4f43 2073 636f 7265 2069 7320  e SMOC score is 
-00013cc0: 6361 6c63 756c 6174 6564 2066 6f72 2072  calculated for r
-00013cd0: 6573 6964 7565 7320 6164 6a61 6365 6e74  esidues adjacent
-00013ce0: 2069 6e0a 2020 2020 2020 2020 2020 2020   in.            
-00013cf0: 2020 7365 7175 656e 6365 2c20 7573 696e    sequence, usin
-00013d00: 6720 6120 736c 6964 696e 6720 616e 6420  g a sliding and 
-00013d10: 6f76 6572 6c61 7070 696e 6720 7769 6e64  overlapping wind
-00013d20: 6f77 2e0a 2020 2020 2020 2020 2020 2020  ow..            
-00013d30: 2a20 2a2a 534d 4f43 642a 2a3a 2050 6978  * **SMOCd**: Pix
-00013d40: 656c 7320 6172 6520 7363 6f72 6564 2069  els are scored i
-00013d50: 6e20 6120 7370 6865 7269 6361 6c20 7261  n a spherical ra
-00013d60: 6469 7573 2061 726f 756e 6420 6561 6368  dius around each
-00013d70: 0a20 2020 2020 2020 2020 2020 2020 2072  .              r
-00013d80: 6573 6964 7565 0a0a 2020 2020 2020 2020  esidue..        
-00013d90: 4172 6775 6d65 6e74 733a 0a20 2020 2020  Arguments:.     
-00013da0: 2020 2020 2020 206d 6170 5f74 6172 6765         map_targe
-00013db0: 743a 2054 6172 6765 7420 4d61 7020 496e  t: Target Map In
-00013dc0: 7374 616e 6365 2e0a 2020 2020 2020 2020  stance..        
-00013dd0: 2020 2020 7265 736f 6c75 7469 6f6e 5f64      resolution_d
-00013de0: 656e 734d 6170 3a20 5265 736f 6c75 7469  ensMap: Resoluti
-00013df0: 6f6e 206f 6620 7468 6520 7461 7267 6574  on of the target
-00013e00: 206d 6170 2e0a 2020 2020 2020 2020 2020   map..          
-00013e10: 2020 7374 7275 6374 7572 655f 696e 7374    structure_inst
-00013e20: 616e 6365 3a20 4d6f 6465 6c20 7374 7275  ance: Model stru
-00013e30: 6374 7572 6520 696e 7374 616e 6365 2e0a  cture instance..
-00013e40: 2020 2020 2020 2020 2020 2020 7769 6e3a              win:
-00013e50: 204f 7665 726c 6170 7069 6e67 2057 696e   Overlapping Win
-00013e60: 646f 7720 6c65 6e67 7468 2074 6f20 6361  dow length to ca
-00013e70: 6c63 756c 6174 6520 7468 6520 7363 6f72  lculate the scor
-00013e80: 650a 2020 2020 2020 2020 2020 2020 7269  e.            ri
-00013e90: 6769 645f 626f 6479 5f66 696c 653a 2050  gid_body_file: P
-00013ea0: 6174 6820 746f 2072 6967 6964 2d62 6f64  ath to rigid-bod
-00013eb0: 7920 6669 6c65 2e0a 2020 2020 2020 2020  y file..        
-00013ec0: 2020 2020 7369 6d5f 6d61 703a 2050 7265      sim_map: Pre
-00013ed0: 636f 6d70 7574 6564 2073 696d 756c 6174  computed simulat
-00013ee0: 6564 206d 6170 2e20 4966 203a 636f 6465  ed map. If :code
-00013ef0: 3a60 4e6f 6e65 602c 2073 696d 5f6d 6170  :`None`, sim_map
-00013f00: 2069 730a 2020 2020 2020 2020 2020 2020   is.            
-00013f10: 2020 2020 6361 6c63 756c 6174 6564 2061      calculated a
-00013f20: 7574 6f6d 6174 6963 616c 6c79 2e0a 2020  utomatically..  
-00013f30: 2020 2020 2020 2020 2020 7369 676d 615f            sigma_
-00013f40: 6d61 703a 2050 6172 616d 6574 6572 206e  map: Parameter n
-00013f50: 6565 6420 666f 7220 5374 7275 6374 7572  eed for Structur
-00013f60: 6520 426c 7572 7265 722e 2046 756c 6c20  e Blurrer. Full 
-00013f70: 6578 706c 616e 6174 696f 6e0a 2020 2020  explanation.    
-00013f80: 2020 2020 2020 2020 2020 2020 3a72 6566              :ref
-00013f90: 3a60 6865 7265 3c4e 6f74 6520 6f6e 2072  :`here<Note on r
-00013fa0: 6561 6c20 7370 6163 6520 626c 7572 7269  eal space blurri
-00013fb0: 6e67 3a3e 600a 2020 2020 2020 2020 2020  ng:>`.          
-00013fc0: 2020 7772 6974 653a 2044 6570 7265 6361    write: Depreca
-00013fd0: 7465 642c 206e 6f74 2075 7365 642e 0a20  ted, not used.. 
-00013fe0: 2020 2020 2020 2020 2020 2063 5f6d 6f64             c_mod
-00013ff0: 653a 2044 6570 7265 6361 7465 642c 206e  e: Deprecated, n
-00014000: 6f74 2075 7365 642e 0a20 2020 2020 2020  ot used..       
-00014010: 2020 2020 2073 6967 6d61 5f74 6872 3a20       sigma_thr: 
-00014020: 5061 7261 6d65 7465 7220 7573 6564 2074  Parameter used t
-00014030: 6f20 6c61 6265 6c20 7069 7865 6c73 206e  o label pixels n
-00014040: 6561 7220 6561 6368 2061 746f 6d20 696e  ear each atom in
-00014050: 2074 6865 0a20 2020 2020 2020 2020 2020   the.           
-00014060: 2020 2020 206d 6f64 656c 2e20 4578 706c       model. Expl
-00014070: 6169 6e65 6420 696e 2066 7572 7468 6572  ained in further
-00014080: 2064 6574 6169 6c0a 2020 2020 2020 2020   detail.        
-00014090: 2020 2020 2020 2020 3a6d 6574 683a 6068          :meth:`h
-000140a0: 6572 6520 3c54 454d 5079 2e70 726f 7465  ere <TEMPy.prote
-000140b0: 696e 2e73 7472 7563 7475 7265 5f62 6c75  in.structure_blu
-000140c0: 7272 6572 2e53 7472 7563 7475 7265 426c  rrer.StructureBl
-000140d0: 7572 7265 722e 6765 745f 696e 6469 6365  urrer.get_indice
-000140e0: 733e 600a 2020 2020 2020 2020 2020 2020  s>`.            
-000140f0: 6672 6167 6d65 6e74 5f73 636f 7265 3a20  fragment_score: 
-00014100: 4966 2054 7275 652c 2075 7365 2053 4d4f  If True, use SMO
-00014110: 4366 206d 6574 686f 642e 2049 6620 4661  Cf method. If Fa
-00014120: 6c73 652c 2075 7365 2053 4d4f 4364 0a20  lse, use SMOCd. 
-00014130: 2020 2020 2020 2020 2020 2020 2020 206d                 m
-00014140: 6574 686f 642e 0a20 2020 2020 2020 2020  ethod..         
-00014150: 2020 2064 6973 743a 2044 6570 7265 6361     dist: Depreca
-00014160: 7465 642c 206e 6f74 2075 7365 642e 0a20  ted, not used.. 
-00014170: 2020 2020 2020 2020 2020 2061 746f 6d5f             atom_
-00014180: 6365 6e74 7265 3a20 5768 6963 6820 6174  centre: Which at
-00014190: 6f6d 2074 7970 6520 7368 6f75 6c64 2062  om type should b
-000141a0: 6520 636f 6e73 6964 6572 6564 2074 6865  e considered the
-000141b0: 2063 656e 7472 6520 6f66 0a20 2020 2020   centre of.     
-000141c0: 2020 2020 2020 2020 2020 2072 6573 6964             resid
-000141d0: 7565 732e 0a20 2020 2020 2020 2020 2020  ues..           
-000141e0: 2063 616c 635f 6d65 7472 6963 3a20 5768   calc_metric: Wh
-000141f0: 6963 6820 6d65 7468 6f64 2074 6f20 7573  ich method to us
-00014200: 6520 666f 7220 6361 6c63 756c 6174 696e  e for calculatin
-00014210: 6720 7468 6520 6c6f 6361 6c20 7363 6f72  g the local scor
-00014220: 6520 6174 0a20 2020 2020 2020 2020 2020  e at.           
-00014230: 2020 2020 2065 6163 6820 7265 7369 6475       each residu
-00014240: 652e 2043 616e 2062 6520 3a63 6f64 653a  e. Can be :code:
-00014250: 6022 736d 6f63 2260 206f 7220 3a63 6f64  `"smoc"` or :cod
-00014260: 653a 6022 7363 6363 2260 0a20 2020 2020  e:`"sccc"`.     
-00014270: 2020 2020 2020 2067 6574 5f63 6f6f 7264         get_coord
-00014280: 3a20 5265 7475 726e 2061 6464 6974 696f  : Return additio
-00014290: 6e61 6c20 6469 6374 5f63 6861 696e 5f43  nal dict_chain_C
-000142a0: 4120 6469 6374 696f 6e61 7279 2e0a 0a20  A dictionary... 
-000142b0: 2020 2020 2020 2052 6574 7572 6e73 3a0a         Returns:.
-000142c0: 2020 2020 2020 2020 2020 2020 4469 6374              Dict
-000142d0: 696f 6e61 7279 3a0a 2020 2020 2020 2020  ionary:.        
-000142e0: 2020 2020 2020 2020 5468 6520 6469 6374          The dict
-000142f0: 696f 6e61 7269 6573 2064 6963 745f 6368  ionaries dict_ch
-00014300: 6169 6e5f 7363 6f72 6573 2c20 6469 6374  ain_scores, dict
-00014310: 5f63 6861 696e 5f72 6573 2e0a 2020 2020  _chain_res..    
-00014320: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014330: 6469 6374 5f63 6861 696e 5f43 4120 6973  dict_chain_CA is
-00014340: 2072 6574 7572 6e65 6420 6164 6469 7469   returned additi
-00014350: 6f6e 616c 6c79 2069 6620 6765 745f 636f  onally if get_co
-00014360: 6f72 6420 3d20 5472 7565 0a0a 2020 2020  ord = True..    
-00014370: 2020 2020 2020 2020 2020 2020 2a20 6469              * di
-00014380: 6374 5f63 6861 696e 5f73 636f 7265 733a  ct_chain_scores:
-00014390: 2032 4420 6469 6374 696f 6e61 7279 2063   2D dictionary c
-000143a0: 6f6e 7461 696e 696e 6720 7468 6520 534d  ontaining the SM
-000143b0: 4f43 2073 636f 7265 730a 2020 2020 2020  OC scores.      
-000143c0: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-000143d0: 6561 6368 2072 6573 6964 7565 2e20 4b65  each residue. Ke
-000143e0: 7973 2061 7265 2063 6861 696e 5f6c 6162  ys are chain_lab
-000143f0: 656c 2066 6f72 2066 6972 7374 2064 6963  el for first dic
-00014400: 7469 6f6e 6172 790a 2020 2020 2020 2020  tionary.        
-00014410: 2020 2020 2020 2020 2020 616e 6420 7265            and re
-00014420: 7369 6475 655f 6e75 6d62 6572 2066 6f72  sidue_number for
-00014430: 2073 6563 6f6e 6420 6469 6374 696f 6e61   second dictiona
-00014440: 7279 2c20 652e 672e 3a0a 2020 2020 2020  ry, e.g.:.      
-00014450: 2020 2020 2020 2020 2020 2020 3a63 6f64              :cod
-00014460: 653a 6064 6963 745f 6368 6169 6e5f 7363  e:`dict_chain_sc
-00014470: 6f72 6573 5b63 6861 696e 5f6c 6162 656c  ores[chain_label
-00014480: 5d5b 7265 7369 6475 655f 6e75 6d62 6572  ][residue_number
-00014490: 5d20 3d20 534d 4f43 5f73 636f 7265 600a  ] = SMOC_score`.
-000144a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000144b0: 202a 2064 6963 745f 6368 6169 6e5f 7265   * dict_chain_re
-000144c0: 733a 2044 6963 7469 6f6e 6172 7920 7769  s: Dictionary wi
-000144d0: 7468 2063 6861 696e 206c 6162 656c 7320  th chain labels 
-000144e0: 2865 2e67 2e0a 2020 2020 2020 2020 2020  (e.g..          
-000144f0: 2020 2020 2020 2020 3a63 6f64 653a 6022          :code:`"
-00014500: 4122 6029 2061 7320 6b65 7973 2061 6e64  A"`) as keys and
-00014510: 2061 206c 6973 7420 6f66 2061 6c6c 2072   a list of all r
-00014520: 6573 6964 7565 206e 756d 6265 7273 2066  esidue numbers f
-00014530: 6f72 0a20 2020 2020 2020 2020 2020 2020  or.             
-00014540: 2020 2020 2061 2067 6976 656e 2063 6861       a given cha
-00014550: 696e 2061 7320 7661 6c75 6573 2e0a 0a20  in as values... 
-00014560: 2020 2020 2020 2020 2020 2020 2020 202a                 *
-00014570: 2064 6963 745f 6368 6169 6e5f 4341 3a20   dict_chain_CA: 
-00014580: 3244 2064 6963 7469 6f6e 6172 7920 636f  2D dictionary co
-00014590: 6e74 6169 6e69 6e67 2061 206c 6973 7420  ntaining a list 
-000145a0: 666f 7220 6561 6368 0a20 2020 2020 2020  for each.       
-000145b0: 2020 2020 2020 2020 2020 2072 6573 6964             resid
-000145c0: 7565 2c20 636f 6e74 6169 6e69 6e67 2074  ue, containing t
-000145d0: 6865 2061 6d69 6e6f 2061 6369 6420 7479  he amino acid ty
-000145e0: 7065 206f 6620 6561 6368 2072 6573 6964  pe of each resid
-000145f0: 7565 2061 6e64 0a20 2020 2020 2020 2020  ue and.         
-00014600: 2020 2020 2020 2020 2069 7473 2033 4420           its 3D 
-00014610: 636f 6f72 6469 6e61 7465 732e 204b 6579  coordinates. Key
-00014620: 7320 6172 6520 6368 6169 6e5f 6c61 6265  s are chain_labe
-00014630: 6c20 666f 7220 6669 7273 7420 6469 6374  l for first dict
-00014640: 696f 6e61 7279 0a20 2020 2020 2020 2020  ionary.         
-00014650: 2020 2020 2020 2020 2061 6e64 2072 6573           and res
-00014660: 6964 7565 5f6e 756d 6265 7220 666f 7220  idue_number for 
-00014670: 7365 636f 6e64 2064 6963 7469 6f6e 6172  second dictionar
-00014680: 792c 2065 2e67 2e3a 0a20 2020 2020 2020  y, e.g.:.       
-00014690: 2020 2020 2020 2020 2020 203a 636f 6465             :code
-000146a0: 3a60 6469 6374 5f63 6861 696e 5f43 415b  :`dict_chain_CA[
-000146b0: 6368 6169 6e5f 6c61 6265 6c5d 5b72 6573  chain_label][res
-000146c0: 6964 7565 5f6e 756d 6265 725d 203d 2072  idue_number] = r
-000146d0: 6573 6964 7565 5f69 6e66 6f60 0a20 2020  esidue_info`.   
-000146e0: 2020 2020 2020 2020 2020 2020 2020 2077                 w
-000146f0: 6865 7265 2c20 3a63 6f64 653a 6072 6573  here, :code:`res
-00014700: 6964 7565 5f69 6e66 6f20 3d20 5b72 6573  idue_info = [res
-00014710: 6964 7565 5f74 7970 652c 2078 2c20 792c  idue_type, x, y,
-00014720: 207a 5d60 0a20 2020 2020 2020 2022 2222   z]`.        """
-00014730: 0a20 2020 2020 2020 2062 6c75 7272 6572  .        blurrer
-00014740: 203d 2053 7472 7563 7475 7265 426c 7572   = StructureBlur
-00014750: 7265 7228 290a 2020 2020 2020 2020 6966  rer().        if
-00014760: 2073 696d 5f6d 6170 2069 7320 4e6f 6e65   sim_map is None
-00014770: 3a0a 2020 2020 2020 2020 2020 2020 7369  :.            si
-00014780: 6d5f 6d61 7020 3d20 626c 7572 7265 722e  m_map = blurrer.
-00014790: 6761 7573 7369 616e 5f62 6c75 725f 7265  gaussian_blur_re
-000147a0: 616c 5f73 7061 6365 280a 2020 2020 2020  al_space(.      
-000147b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000147c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000147d0: 2020 2020 2020 2020 2020 2020 2020 7374                st
-000147e0: 7275 6374 7572 655f 696e 7374 616e 6365  ructure_instance
-000147f0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00014800: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014810: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014820: 2020 2020 2020 7265 736f 6c75 7469 6f6e        resolution
-00014830: 5f64 656e 734d 6170 2c0a 2020 2020 2020  _densMap,.      
-00014840: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014850: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014860: 2020 2020 2020 2020 2020 2020 2020 6465                de
-00014870: 6e73 4d61 703d 6d61 705f 7461 7267 6574  nsMap=map_target
-00014880: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00014890: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000148a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000148b0: 2020 2020 2020 7369 676d 615f 636f 6566        sigma_coef
-000148c0: 663d 7369 676d 615f 6d61 702c 0a20 2020  f=sigma_map,.   
-000148d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000148e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000148f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014900: 206e 6f72 6d61 6c69 7365 3d54 7275 6529   normalise=True)
-00014910: 0a20 2020 2020 2020 2023 206d 6173 6b20  .        # mask 
-00014920: 6f75 7420 6261 636b 6772 6f75 6e64 0a20  out background. 
-00014930: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
-00014940: 2020 2020 2020 2020 7065 616b 2c20 6176          peak, av
-00014950: 652c 2073 6967 6d61 203d 2073 696d 5f6d  e, sigma = sim_m
-00014960: 6170 2e70 6561 6b5f 6465 6e73 6974 7928  ap.peak_density(
-00014970: 290a 2020 2020 2020 2020 2020 2020 6966  ).            if
-00014980: 2070 6561 6b20 3e3d 2061 7665 202d 2073   peak >= ave - s
-00014990: 6967 6d61 2061 6e64 2070 6561 6b20 3c20  igma and peak < 
-000149a0: 2861 7665 202b 2035 202a 2073 6967 6d61  (ave + 5 * sigma
-000149b0: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-000149c0: 2020 2073 696d 5f6d 6170 2e66 756c 6c4d     sim_map.fullM
-000149d0: 6170 203d 2073 696d 5f6d 6170 2e66 756c  ap = sim_map.ful
-000149e0: 6c4d 6170 202a 2028 7369 6d5f 6d61 702e  lMap * (sim_map.
-000149f0: 6675 6c6c 4d61 7020 3e20 7065 616b 290a  fullMap > peak).
-00014a00: 2020 2020 2020 2020 6578 6365 7074 3a20          except: 
-00014a10: 2023 206e 6f71 613a 2045 3732 320a 2020   # noqa: E722.  
-00014a20: 2020 2020 2020 2020 2020 7061 7373 0a0a            pass..
-00014a30: 2020 2020 2020 2020 6469 6374 5f63 6861          dict_cha
-00014a40: 696e 5f69 6e64 6963 6573 2c20 6469 6374  in_indices, dict
-00014a50: 5f63 6861 696e 5f72 6573 2c20 6469 6374  _chain_res, dict
-00014a60: 5f63 6861 696e 5f43 412c 2067 7269 6474  _chain_CA, gridt
-00014a70: 7265 6520 3d20 5c0a 2020 2020 2020 2020  ree = \.        
-00014a80: 2020 2020 626c 7572 7265 722e 6765 745f      blurrer.get_
-00014a90: 696e 6469 6365 7328 0a20 2020 2020 2020  indices(.       
-00014aa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014ab0: 2020 2020 2020 2020 2073 7472 7563 7475           structu
-00014ac0: 7265 5f69 6e73 7461 6e63 652c 0a20 2020  re_instance,.   
-00014ad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014ae0: 2020 2020 2020 2020 2020 2020 206d 6170               map
-00014af0: 5f74 6172 6765 742c 0a20 2020 2020 2020  _target,.       
-00014b00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014b10: 2020 2020 2020 2020 2072 6573 6f6c 7574           resolut
-00014b20: 696f 6e5f 6465 6e73 4d61 702c 0a20 2020  ion_densMap,.   
-00014b30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014b40: 2020 2020 2020 2020 2020 2020 2073 696d               sim
-00014b50: 5f73 6967 6d61 5f63 6f65 6666 3d73 6967  _sigma_coeff=sig
-00014b60: 6d61 5f6d 6170 2c0a 2020 2020 2020 2020  ma_map,.        
-00014b70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014b80: 2020 2020 2020 2020 7369 676d 615f 7468          sigma_th
-00014b90: 723d 7369 676d 615f 7468 722c 0a20 2020  r=sigma_thr,.   
-00014ba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014bb0: 2020 2020 2020 2020 2020 2020 2061 746f               ato
-00014bc0: 6d5f 6365 6e74 7265 3d61 746f 6d5f 6365  m_centre=atom_ce
-00014bd0: 6e74 7265 290a 2020 2020 2020 2020 6465  ntre).        de
-00014be0: 6c20 7374 7275 6374 7572 655f 696e 7374  l structure_inst
-00014bf0: 616e 6365 0a20 2020 2020 2020 2067 632e  ance.        gc.
-00014c00: 636f 6c6c 6563 7428 290a 2020 2020 2020  collect().      
-00014c10: 2020 2320 6765 7420 6465 7461 696c 7320    # get details 
-00014c20: 6f66 206d 6170 0a20 2020 2020 2020 206e  of map.        n
-00014c30: 7a2c 206e 792c 206e 7820 3d20 6d61 705f  z, ny, nx = map_
-00014c40: 7461 7267 6574 2e66 756c 6c4d 6170 2e73  target.fullMap.s
-00014c50: 6861 7065 0a20 2020 2020 2020 207a 672c  hape.        zg,
-00014c60: 2079 672c 2078 6720 3d20 6e70 2e6d 6772   yg, xg = np.mgr
-00014c70: 6964 5b30 3a6e 7a2c 2030 3a6e 792c 2030  id[0:nz, 0:ny, 0
-00014c80: 3a6e 785d 0a20 2020 2020 2020 2023 2078  :nx].        # x
-00014c90: 2079 2c7a 2063 6f6f 7264 696e 6174 6573   y,z coordinates
-00014ca0: 206f 6620 7468 6520 6772 6964 0a20 2020   of the grid.   
-00014cb0: 2020 2020 2069 6e64 6920 3d20 6c69 7374       indi = list
-00014cc0: 287a 6970 2878 672e 7261 7665 6c28 292c  (zip(xg.ravel(),
-00014cd0: 2079 672e 7261 7665 6c28 292c 207a 672e   yg.ravel(), zg.
-00014ce0: 7261 7665 6c28 2929 290a 0a20 2020 2020  ravel()))..     
-00014cf0: 2020 206c 6973 745f 7363 6363 203d 205b     list_sccc = [
-00014d00: 5d0a 2020 2020 2020 2020 2320 7361 7665  ].        # save
-00014d10: 2073 636f 7265 7320 666f 7220 6561 6368   scores for each
-00014d20: 2063 6861 696e 2061 6e64 2072 6573 0a20   chain and res. 
-00014d30: 2020 2020 2020 2064 6963 745f 6368 6169         dict_chai
-00014d40: 6e5f 7363 6f72 6573 203d 204f 7264 6572  n_scores = Order
-00014d50: 6564 4469 6374 2829 0a20 2020 2020 2020  edDict().       
-00014d60: 2066 6f72 2063 6820 696e 2064 6963 745f   for ch in dict_
-00014d70: 6368 6169 6e5f 696e 6469 6365 733a 0a20  chain_indices:. 
-00014d80: 2020 2020 2020 2020 2020 2064 6963 745f             dict_
-00014d90: 7265 735f 7363 6f72 6573 203d 204f 7264  res_scores = Ord
-00014da0: 6572 6564 4469 6374 2829 0a20 2020 2020  eredDict().     
-00014db0: 2020 2020 2020 2064 6963 745f 7265 735f         dict_res_
-00014dc0: 696e 6469 6365 7320 3d20 6469 6374 5f63  indices = dict_c
-00014dd0: 6861 696e 5f69 6e64 6963 6573 5b63 685d  hain_indices[ch]
-00014de0: 0a20 2020 2020 2020 2020 2020 2023 206d  .            # m
-00014df0: 756c 7469 2d63 6861 696e 2072 6967 6964  ulti-chain rigid
-00014e00: 2062 6f64 7920 7061 7273 6572 0a20 2020   body parser.   
-00014e10: 2020 2020 2020 2020 2069 6620 7269 6769           if rigi
-00014e20: 645f 626f 6479 5f66 696c 6520 6973 206e  d_body_file is n
-00014e30: 6f74 204e 6f6e 653a 0a20 2020 2020 2020  ot None:.       
-00014e40: 2020 2020 2020 2020 2064 6963 745f 7265           dict_re
-00014e50: 735f 7363 6f72 6573 203d 2073 656c 662e  s_scores = self.
-00014e60: 736d 6f63 5f73 636f 7265 5f72 6967 6964  smoc_score_rigid
-00014e70: 5f62 6f64 6965 7328 0a20 2020 2020 2020  _bodies(.       
-00014e80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014e90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014ea0: 2020 2020 2020 2020 2064 6963 745f 7265           dict_re
-00014eb0: 735f 696e 6469 6365 732c 0a20 2020 2020  s_indices,.     
-00014ec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014ed0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014ee0: 2020 2020 2020 2020 2020 2072 6967 6964             rigid
-00014ef0: 5f62 6f64 795f 6669 6c65 2c0a 2020 2020  _body_file,.    
-00014f00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014f10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014f20: 2020 2020 2020 2020 2020 2020 6368 2c0a              ch,.
-00014f30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014f40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014f50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014f60: 696e 6469 2c0a 2020 2020 2020 2020 2020  indi,.          
-00014f70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014f80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014f90: 2020 2020 2020 6d61 705f 7461 7267 6574        map_target
-00014fa0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00014fb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014fc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014fd0: 2020 7369 6d5f 6d61 7029 0a20 2020 2020    sim_map).     
-00014fe0: 2020 2020 2020 2023 2066 6f72 2072 6573         # for res
-00014ff0: 6964 7565 7320 6e6f 7420 696e 2072 6967  idues not in rig
-00015000: 6964 2062 6f64 6965 730a 2020 2020 2020  id bodies.      
-00015010: 2020 2020 2020 666f 7220 7265 7320 696e        for res in
-00015020: 2064 6963 745f 7265 735f 696e 6469 6365   dict_res_indice
-00015030: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
-00015040: 2020 2023 2069 6620 6e6f 7420 6469 6374     # if not dict
-00015050: 5f72 6573 5f73 636f 7265 732e 6861 735f  _res_scores.has_
-00015060: 6b65 7928 7265 7329 3a0a 2020 2020 2020  key(res):.      
-00015070: 2020 2020 2020 2020 2020 6966 2072 6573            if res
-00015080: 206e 6f74 2069 6e20 6469 6374 5f72 6573   not in dict_res
-00015090: 5f73 636f 7265 733a 0a20 2020 2020 2020  _scores:.       
-000150a0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-000150b0: 6672 6167 6d65 6e74 5f73 636f 7265 3a0a  fragment_score:.
-000150c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000150d0: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
+00013240: 2066 6f72 2072 2069 6e20 7261 6e67 6528   for r in range(
+00013250: 696e 7428 7365 675b 305d 292c 2069 6e74  int(seg[0]), int
+00013260: 2873 6567 5b31 5d29 202b 2031 293a 0a20  (seg[1]) + 1):. 
+00013270: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013280: 2020 2020 2020 2020 2020 2069 6e64 6963             indic
+00013290: 6573 2e65 7874 656e 6428 6469 6374 5f72  es.extend(dict_r
+000132a0: 6573 5f69 6e64 6963 6573 5b72 5d29 0a20  es_indices[r]). 
+000132b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000132c0: 2020 2020 2020 2020 2020 2072 6573 5f6c             res_l
+000132d0: 6973 742e 6170 7065 6e64 2872 290a 2020  ist.append(r).  
+000132e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000132f0: 2020 6578 6365 7074 2054 7970 6545 7272    except TypeErr
+00013300: 6f72 3a0a 2020 2020 2020 2020 2020 2020  or:.            
+00013310: 2020 2020 2020 2020 2020 2020 636f 6e74              cont
+00013320: 696e 7565 0a20 2020 2020 2020 2020 2020  inue.           
+00013330: 2020 2020 2023 206d 696e 696d 756d 2076       # minimum v
+00013340: 616c 7565 2073 6574 2061 7320 3020 6865  alue set as 0 he
+00013350: 7265 2028 6173 7375 6d69 6e67 206f 6e6c  re (assuming onl
+00013360: 7920 706f 7369 7469 7665 2076 616c 7565  y positive value
+00013370: 7321 290a 2020 2020 2020 2020 2020 2020  s!).            
+00013380: 2020 2020 6966 206c 656e 2869 6e64 6963      if len(indic
+00013390: 6573 2920 3d3d 2030 3a0a 2020 2020 2020  es) == 0:.      
+000133a0: 2020 2020 2020 2020 2020 2020 2020 666f                fo
+000133b0: 7220 7265 7320 696e 2072 6573 5f6c 6973  r res in res_lis
+000133c0: 743a 0a20 2020 2020 2020 2020 2020 2020  t:.             
+000133d0: 2020 2020 2020 2020 2020 2064 6963 745f             dict_
+000133e0: 7265 735f 7363 6f72 6573 5b72 6573 5d20  res_scores[res] 
+000133f0: 3d20 302e 3020 2023 202d 302e 3939 0a20  = 0.0  # -0.99. 
+00013400: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013410: 2020 2063 6f6e 7469 6e75 650a 2020 2020     continue.    
+00013420: 2020 2020 2020 2020 2020 2020 7472 793a              try:
+00013430: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00013440: 2020 2020 2069 6e64 5f61 7272 7a79 7820       ind_arrzyx 
+00013450: 3d20 7365 6c66 2e69 6e64 6963 6573 5f73  = self.indices_s
+00013460: 6d6f 6328 696e 6469 6365 732c 2069 6e64  moc(indices, ind
+00013470: 6929 0a20 2020 2020 2020 2020 2020 2020  i).             
+00013480: 2020 2020 2020 2073 6d6f 6320 3d20 7365         smoc = se
+00013490: 6c66 2e63 616c 635f 6d6f 6328 696e 645f  lf.calc_moc(ind_
+000134a0: 6172 727a 7978 2c20 7369 6d5f 6d61 702c  arrzyx, sim_map,
+000134b0: 206d 6170 5f74 6172 6765 7429 0a20 2020   map_target).   
+000134c0: 2020 2020 2020 2020 2020 2020 2065 7863               exc
+000134d0: 6570 7420 496e 6465 7845 7272 6f72 3a0a  ept IndexError:.
+000134e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000134f0: 2020 2020 736d 6f63 203d 2030 2e30 0a20      smoc = 0.0. 
+00013500: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+00013510: 2073 6176 6520 7363 6f72 6573 0a20 2020   save scores.   
+00013520: 2020 2020 2020 2020 2020 2020 2066 6f72               for
+00013530: 2072 6573 2069 6e20 7265 735f 6c69 7374   res in res_list
+00013540: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00013550: 2020 2020 2020 6469 6374 5f72 6573 5f73        dict_res_s
+00013560: 636f 7265 735b 7265 735d 203d 2073 6d6f  cores[res] = smo
+00013570: 630a 2020 2020 2020 2020 7265 7475 726e  c.        return
+00013580: 2064 6963 745f 7265 735f 7363 6f72 6573   dict_res_scores
+00013590: 0a0a 2020 2020 6465 6620 736d 6f63 5f67  ..    def smoc_g
+000135a0: 6574 5f69 6e64 6963 6573 5f66 7261 676d  et_indices_fragm
+000135b0: 656e 745f 7769 6e64 6f77 2873 656c 662c  ent_window(self,
+000135c0: 2064 6963 745f 7265 735f 696e 6469 6365   dict_res_indice
+000135d0: 732c 0a20 2020 2020 2020 2020 2020 2020  s,.             
+000135e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000135f0: 2020 2020 2020 2020 2020 2020 6469 6374              dict
+00013600: 5f63 6861 696e 5f72 6573 2c20 6368 2c20  _chain_res, ch, 
+00013610: 7265 732c 0a20 2020 2020 2020 2020 2020  res,.           
+00013620: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013630: 2020 2020 2020 2020 2020 2020 2020 7769                wi
+00013640: 6e29 3a0a 2020 2020 2020 2020 696e 6469  n):.        indi
+00013650: 6365 7320 3d20 6469 6374 5f72 6573 5f69  ces = dict_res_i
+00013660: 6e64 6963 6573 5b72 6573 5d5b 3a5d 0a20  ndices[res][:]. 
+00013670: 2020 2020 2020 2023 2063 6f6e 7369 6465         # conside
+00013680: 7220 7265 7369 6475 6573 206f 6e20 626f  r residues on bo
+00013690: 7468 2073 6964 6573 2e20 4e4f 5445 3a20  th sides. NOTE: 
+000136a0: 776f 6e74 2077 6f72 6b20 666f 7220 696e  wont work for in
+000136b0: 7365 7274 696f 6e20 636f 6465 7321 0a20  sertion codes!. 
+000136c0: 2020 2020 2020 2023 206e 6565 6420 746f         # need to
+000136d0: 2072 6577 6974 6520 7265 7320 6e75 6d62   rewite res numb
+000136e0: 6572 7320 746f 2061 766f 6964 2069 6e73  ers to avoid ins
+000136f0: 6572 7469 6f6e 2063 6f64 6573 0a20 2020  ertion codes.   
+00013700: 2020 2020 2066 6f72 2069 6920 696e 2072       for ii in r
+00013710: 616e 6765 2831 2c20 696e 7428 726f 756e  ange(1, int(roun
+00013720: 6428 2877 696e 202b 2031 2920 2f20 3229  d((win + 1) / 2)
+00013730: 2929 3a0a 2020 2020 2020 2020 2020 2020  )):.            
+00013740: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
+00013750: 2020 2020 2072 6573 5f69 6478 203d 2064       res_idx = d
+00013760: 6963 745f 6368 6169 6e5f 7265 735b 6368  ict_chain_res[ch
+00013770: 5d2e 696e 6465 7828 7265 7329 202d 2069  ].index(res) - i
+00013780: 690a 2020 2020 2020 2020 2020 2020 2020  i.              
+00013790: 2020 6966 2072 6573 5f69 6478 203c 2030    if res_idx < 0
+000137a0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+000137b0: 2020 2020 2020 636f 6e74 696e 7565 0a20        continue. 
+000137c0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+000137d0: 2067 6574 2070 7265 7620 7265 7369 6475   get prev residu
+000137e0: 6520 696e 6469 6365 730a 2020 2020 2020  e indices.      
+000137f0: 2020 2020 2020 2020 2020 696e 6469 6365            indice
+00013800: 732e 6578 7465 6e64 280a 2020 2020 2020  s.extend(.      
+00013810: 2020 2020 2020 2020 2020 2020 2020 6469                di
+00013820: 6374 5f72 6573 5f69 6e64 6963 6573 5b0a  ct_res_indices[.
+00013830: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013840: 2020 2020 2020 2020 6469 6374 5f63 6861          dict_cha
+00013850: 696e 5f72 6573 5b63 685d 0a20 2020 2020  in_res[ch].     
+00013860: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013870: 2020 205b 0a20 2020 2020 2020 2020 2020     [.           
+00013880: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013890: 2072 6573 5f69 6478 0a20 2020 2020 2020   res_idx.       
+000138a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000138b0: 205d 0a20 2020 2020 2020 2020 2020 2020   ].             
+000138c0: 2020 2020 2020 205d 0a20 2020 2020 2020         ].       
+000138d0: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
+000138e0: 2020 2020 2020 2065 7863 6570 7420 284b         except (K
+000138f0: 6579 4572 726f 722c 2049 6e64 6578 4572  eyError, IndexEr
+00013900: 726f 7229 3a0a 2020 2020 2020 2020 2020  ror):.          
+00013910: 2020 2020 2020 7061 7373 0a20 2020 2020        pass.     
+00013920: 2020 2066 6f72 2069 6920 696e 2072 616e     for ii in ran
+00013930: 6765 2831 2c20 696e 7428 726f 756e 6428  ge(1, int(round(
+00013940: 2877 696e 202b 2031 2920 2f20 3229 2929  (win + 1) / 2)))
+00013950: 3a0a 2020 2020 2020 2020 2020 2020 7472  :.            tr
+00013960: 793a 0a20 2020 2020 2020 2020 2020 2020  y:.             
+00013970: 2020 2069 6e64 6963 6573 2e65 7874 656e     indices.exten
+00013980: 6428 0a20 2020 2020 2020 2020 2020 2020  d(.             
+00013990: 2020 2020 2020 2064 6963 745f 7265 735f         dict_res_
+000139a0: 696e 6469 6365 735b 0a20 2020 2020 2020  indices[.       
+000139b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000139c0: 2064 6963 745f 6368 6169 6e5f 7265 735b   dict_chain_res[
+000139d0: 6368 5d0a 2020 2020 2020 2020 2020 2020  ch].            
+000139e0: 2020 2020 2020 2020 2020 2020 5b0a 2020              [.  
+000139f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013a00: 2020 2020 2020 2020 2020 6469 6374 5f63            dict_c
+00013a10: 6861 696e 5f72 6573 5b63 685d 2e69 6e64  hain_res[ch].ind
+00013a20: 6578 2872 6573 2920 2b20 6969 0a20 2020  ex(res) + ii.   
+00013a30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013a40: 2020 2020 205d 0a20 2020 2020 2020 2020       ].         
+00013a50: 2020 2020 2020 2020 2020 205d 0a20 2020             ].   
+00013a60: 2020 2020 2020 2020 2020 2020 2029 0a20               ). 
+00013a70: 2020 2020 2020 2020 2020 2065 7863 6570             excep
+00013a80: 7420 2849 6e64 6578 4572 726f 722c 204b  t (IndexError, K
+00013a90: 6579 4572 726f 7229 3a0a 2020 2020 2020  eyError):.      
+00013aa0: 2020 2020 2020 2020 2020 7061 7373 0a20            pass. 
+00013ab0: 2020 2020 2020 2072 6574 7572 6e20 696e         return in
+00013ac0: 6469 6365 730a 0a20 2020 2064 6566 2073  dices..    def s
+00013ad0: 6d6f 635f 6765 745f 696e 6469 6365 735f  moc_get_indices_
+00013ae0: 7370 6865 7265 2873 656c 662c 2067 7269  sphere(self, gri
+00013af0: 6474 7265 652c 2063 6f6f 7264 2c20 6469  dtree, coord, di
+00013b00: 7374 3d35 2e30 293a 0a20 2020 2020 2020  st=5.0):.       
+00013b10: 206c 6973 745f 706f 696e 7473 203d 2067   list_points = g
+00013b20: 7269 6474 7265 652e 7175 6572 795f 6261  ridtree.query_ba
+00013b30: 6c6c 5f70 6f69 6e74 280a 2020 2020 2020  ll_point(.      
+00013b40: 2020 2020 2020 5b63 6f6f 7264 5b30 5d2c        [coord[0],
+00013b50: 2063 6f6f 7264 5b31 5d2c 2063 6f6f 7264   coord[1], coord
+00013b60: 5b32 5d5d 2c0a 2020 2020 2020 2020 2020  [2]],.          
+00013b70: 2020 6469 7374 0a20 2020 2020 2020 2029    dist.        )
+00013b80: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+00013b90: 6c69 7374 5f70 6f69 6e74 730a 0a20 2020  list_points..   
+00013ba0: 2064 6566 2053 4d4f 4328 7365 6c66 2c0a   def SMOC(self,.
+00013bb0: 2020 2020 2020 2020 2020 2020 206d 6170               map
+00013bc0: 5f74 6172 6765 742c 0a20 2020 2020 2020  _target,.       
+00013bd0: 2020 2020 2020 7265 736f 6c75 7469 6f6e        resolution
+00013be0: 5f64 656e 734d 6170 2c0a 2020 2020 2020  _densMap,.      
+00013bf0: 2020 2020 2020 2073 7472 7563 7475 7265         structure
+00013c00: 5f69 6e73 7461 6e63 653d 4e6f 6e65 2c0a  _instance=None,.
+00013c10: 2020 2020 2020 2020 2020 2020 2077 696e               win
+00013c20: 3d31 312c 0a20 2020 2020 2020 2020 2020  =11,.           
+00013c30: 2020 7269 6769 645f 626f 6479 5f66 696c    rigid_body_fil
+00013c40: 653d 4e6f 6e65 2c0a 2020 2020 2020 2020  e=None,.        
+00013c50: 2020 2020 2073 696d 5f6d 6170 3d4e 6f6e       sim_map=Non
+00013c60: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
+00013c70: 7369 676d 615f 6d61 703d 302e 3232 352c  sigma_map=0.225,
+00013c80: 0a20 2020 2020 2020 2020 2020 2020 7772  .             wr
+00013c90: 6974 653d 4661 6c73 652c 0a20 2020 2020  ite=False,.     
+00013ca0: 2020 2020 2020 2020 635f 6d6f 6465 3d54          c_mode=T
+00013cb0: 7275 652c 0a20 2020 2020 2020 2020 2020  rue,.           
+00013cc0: 2020 7369 676d 615f 7468 723d 322e 352c    sigma_thr=2.5,
+00013cd0: 0a20 2020 2020 2020 2020 2020 2020 6672  .             fr
+00013ce0: 6167 6d65 6e74 5f73 636f 7265 3d54 7275  agment_score=Tru
+00013cf0: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
+00013d00: 6469 7374 3d35 2e30 2c0a 2020 2020 2020  dist=5.0,.      
+00013d10: 2020 2020 2020 2061 746f 6d5f 6365 6e74         atom_cent
+00013d20: 7265 3d27 4341 272c 0a20 2020 2020 2020  re='CA',.       
+00013d30: 2020 2020 2020 6361 6c63 5f6d 6574 7269        calc_metri
+00013d40: 633d 2773 6d6f 6327 2c0a 2020 2020 2020  c='smoc',.      
+00013d50: 2020 2020 2020 2067 6574 5f63 6f6f 7264         get_coord
+00013d60: 3d54 7275 650a 2020 2020 2020 2020 2020  =True.          
+00013d70: 2020 2029 3a0a 2020 2020 2020 2020 2222     ):.        ""
+00013d80: 2243 616c 6375 6c61 7465 2074 6865 206c  "Calculate the l
+00013d90: 6f63 616c 204d 616e 6465 7227 7320 4f76  ocal Mander's Ov
+00013da0: 6572 6c61 7020 666f 7220 6561 6368 2072  erlap for each r
+00013db0: 6573 6964 7565 2069 6e20 6120 7072 6f74  esidue in a prot
+00013dc0: 6569 6e0a 2020 2020 2020 2020 6d6f 6465  ein.        mode
+00013dd0: 6c0a 0a20 2020 2020 2020 2053 4d4f 4320  l..        SMOC 
+00013de0: 6361 6e20 6265 2063 616c 6375 6c61 7465  can be calculate
+00013df0: 6420 696e 2074 776f 2077 6179 733a 0a0a  d in two ways:..
+00013e00: 2020 2020 2020 2020 2020 2020 2a20 2a2a              * **
+00013e10: 534d 4f43 662a 2a3a 2054 6865 2053 4d4f  SMOCf**: The SMO
+00013e20: 4320 7363 6f72 6520 6973 2063 616c 6375  C score is calcu
+00013e30: 6c61 7465 6420 666f 7220 7265 7369 6475  lated for residu
+00013e40: 6573 2061 646a 6163 656e 7420 696e 0a20  es adjacent in. 
+00013e50: 2020 2020 2020 2020 2020 2020 2073 6571               seq
+00013e60: 7565 6e63 652c 2075 7369 6e67 2061 2073  uence, using a s
+00013e70: 6c69 6469 6e67 2061 6e64 206f 7665 726c  liding and overl
+00013e80: 6170 7069 6e67 2077 696e 646f 772e 0a20  apping window.. 
+00013e90: 2020 2020 2020 2020 2020 202a 202a 2a53             * **S
+00013ea0: 4d4f 4364 2a2a 3a20 5069 7865 6c73 2061  MOCd**: Pixels a
+00013eb0: 7265 2073 636f 7265 6420 696e 2061 2073  re scored in a s
+00013ec0: 7068 6572 6963 616c 2072 6164 6975 7320  pherical radius 
+00013ed0: 6172 6f75 6e64 2065 6163 680a 2020 2020  around each.    
+00013ee0: 2020 2020 2020 2020 2020 7265 7369 6475            residu
+00013ef0: 650a 0a20 2020 2020 2020 2041 7267 756d  e..        Argum
+00013f00: 656e 7473 3a0a 2020 2020 2020 2020 2020  ents:.          
+00013f10: 2020 6d61 705f 7461 7267 6574 3a20 5461    map_target: Ta
+00013f20: 7267 6574 204d 6170 2049 6e73 7461 6e63  rget Map Instanc
+00013f30: 652e 0a20 2020 2020 2020 2020 2020 2072  e..            r
+00013f40: 6573 6f6c 7574 696f 6e5f 6465 6e73 4d61  esolution_densMa
+00013f50: 703a 2052 6573 6f6c 7574 696f 6e20 6f66  p: Resolution of
+00013f60: 2074 6865 2074 6172 6765 7420 6d61 702e   the target map.
+00013f70: 0a20 2020 2020 2020 2020 2020 2073 7472  .            str
+00013f80: 7563 7475 7265 5f69 6e73 7461 6e63 653a  ucture_instance:
+00013f90: 204d 6f64 656c 2073 7472 7563 7475 7265   Model structure
+00013fa0: 2069 6e73 7461 6e63 652e 0a20 2020 2020   instance..     
+00013fb0: 2020 2020 2020 2077 696e 3a20 4f76 6572         win: Over
+00013fc0: 6c61 7070 696e 6720 5769 6e64 6f77 206c  lapping Window l
+00013fd0: 656e 6774 6820 746f 2063 616c 6375 6c61  ength to calcula
+00013fe0: 7465 2074 6865 2073 636f 7265 0a20 2020  te the score.   
+00013ff0: 2020 2020 2020 2020 2072 6967 6964 5f62           rigid_b
+00014000: 6f64 795f 6669 6c65 3a20 5061 7468 2074  ody_file: Path t
+00014010: 6f20 7269 6769 642d 626f 6479 2066 696c  o rigid-body fil
+00014020: 652e 0a20 2020 2020 2020 2020 2020 2073  e..            s
+00014030: 696d 5f6d 6170 3a20 5072 6563 6f6d 7075  im_map: Precompu
+00014040: 7465 6420 7369 6d75 6c61 7465 6420 6d61  ted simulated ma
+00014050: 702e 2049 6620 3a63 6f64 653a 604e 6f6e  p. If :code:`Non
+00014060: 6560 2c20 7369 6d5f 6d61 7020 6973 0a20  e`, sim_map is. 
+00014070: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+00014080: 616c 6375 6c61 7465 6420 6175 746f 6d61  alculated automa
+00014090: 7469 6361 6c6c 792e 0a20 2020 2020 2020  tically..       
+000140a0: 2020 2020 2073 6967 6d61 5f6d 6170 3a20       sigma_map: 
+000140b0: 5061 7261 6d65 7465 7220 6e65 6564 2066  Parameter need f
+000140c0: 6f72 2053 7472 7563 7475 7265 2042 6c75  or Structure Blu
+000140d0: 7272 6572 2e20 4675 6c6c 2065 7870 6c61  rrer. Full expla
+000140e0: 6e61 7469 6f6e 0a20 2020 2020 2020 2020  nation.         
+000140f0: 2020 2020 2020 203a 7265 663a 6068 6572         :ref:`her
+00014100: 653c 4e6f 7465 206f 6e20 7265 616c 2073  e<Note on real s
+00014110: 7061 6365 2062 6c75 7272 696e 673a 3e60  pace blurring:>`
+00014120: 0a20 2020 2020 2020 2020 2020 2077 7269  .            wri
+00014130: 7465 3a20 4465 7072 6563 6174 6564 2c20  te: Deprecated, 
+00014140: 6e6f 7420 7573 6564 2e0a 2020 2020 2020  not used..      
+00014150: 2020 2020 2020 635f 6d6f 6465 3a20 4465        c_mode: De
+00014160: 7072 6563 6174 6564 2c20 6e6f 7420 7573  precated, not us
+00014170: 6564 2e0a 2020 2020 2020 2020 2020 2020  ed..            
+00014180: 7369 676d 615f 7468 723a 2050 6172 616d  sigma_thr: Param
+00014190: 6574 6572 2075 7365 6420 746f 206c 6162  eter used to lab
+000141a0: 656c 2070 6978 656c 7320 6e65 6172 2065  el pixels near e
+000141b0: 6163 6820 6174 6f6d 2069 6e20 7468 650a  ach atom in the.
+000141c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000141d0: 6d6f 6465 6c2e 2045 7870 6c61 696e 6564  model. Explained
+000141e0: 2069 6e20 6675 7274 6865 7220 6465 7461   in further deta
+000141f0: 696c 0a20 2020 2020 2020 2020 2020 2020  il.             
+00014200: 2020 203a 6d65 7468 3a60 6865 7265 203c     :meth:`here <
+00014210: 5445 4d50 792e 7072 6f74 6569 6e2e 7374  TEMPy.protein.st
+00014220: 7275 6374 7572 655f 626c 7572 7265 722e  ructure_blurrer.
+00014230: 5374 7275 6374 7572 6542 6c75 7272 6572  StructureBlurrer
+00014240: 2e67 6574 5f69 6e64 6963 6573 3e60 0a20  .get_indices>`. 
+00014250: 2020 2020 2020 2020 2020 2066 7261 676d             fragm
+00014260: 656e 745f 7363 6f72 653a 2049 6620 5472  ent_score: If Tr
+00014270: 7565 2c20 7573 6520 534d 4f43 6620 6d65  ue, use SMOCf me
+00014280: 7468 6f64 2e20 4966 2046 616c 7365 2c20  thod. If False, 
+00014290: 7573 6520 534d 4f43 640a 2020 2020 2020  use SMOCd.      
+000142a0: 2020 2020 2020 2020 2020 6d65 7468 6f64            method
+000142b0: 2e0a 2020 2020 2020 2020 2020 2020 6469  ..            di
+000142c0: 7374 3a20 4465 7072 6563 6174 6564 2c20  st: Deprecated, 
+000142d0: 6e6f 7420 7573 6564 2e0a 2020 2020 2020  not used..      
+000142e0: 2020 2020 2020 6174 6f6d 5f63 656e 7472        atom_centr
+000142f0: 653a 2057 6869 6368 2061 746f 6d20 7479  e: Which atom ty
+00014300: 7065 2073 686f 756c 6420 6265 2063 6f6e  pe should be con
+00014310: 7369 6465 7265 6420 7468 6520 6365 6e74  sidered the cent
+00014320: 7265 206f 660a 2020 2020 2020 2020 2020  re of.          
+00014330: 2020 2020 2020 7265 7369 6475 6573 2e0a        residues..
+00014340: 2020 2020 2020 2020 2020 2020 6361 6c63              calc
+00014350: 5f6d 6574 7269 633a 2057 6869 6368 206d  _metric: Which m
+00014360: 6574 686f 6420 746f 2075 7365 2066 6f72  ethod to use for
+00014370: 2063 616c 6375 6c61 7469 6e67 2074 6865   calculating the
+00014380: 206c 6f63 616c 2073 636f 7265 2061 740a   local score at.
+00014390: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000143a0: 6561 6368 2072 6573 6964 7565 2e20 4361  each residue. Ca
+000143b0: 6e20 6265 203a 636f 6465 3a60 2273 6d6f  n be :code:`"smo
+000143c0: 6322 6020 6f72 203a 636f 6465 3a60 2273  c"` or :code:`"s
+000143d0: 6363 6322 600a 2020 2020 2020 2020 2020  ccc"`.          
+000143e0: 2020 6765 745f 636f 6f72 643a 2052 6574    get_coord: Ret
+000143f0: 7572 6e20 6164 6469 7469 6f6e 616c 2064  urn additional d
+00014400: 6963 745f 6368 6169 6e5f 4341 2064 6963  ict_chain_CA dic
+00014410: 7469 6f6e 6172 792e 0a0a 2020 2020 2020  tionary...      
+00014420: 2020 5265 7475 726e 733a 0a20 2020 2020    Returns:.     
+00014430: 2020 2020 2020 2044 6963 7469 6f6e 6172         Dictionar
+00014440: 793a 0a20 2020 2020 2020 2020 2020 2020  y:.             
+00014450: 2020 2054 6865 2064 6963 7469 6f6e 6172     The dictionar
+00014460: 6965 7320 6469 6374 5f63 6861 696e 5f73  ies dict_chain_s
+00014470: 636f 7265 732c 2064 6963 745f 6368 6169  cores, dict_chai
+00014480: 6e5f 7265 732e 0a20 2020 2020 2020 2020  n_res..         
+00014490: 2020 2020 2020 2020 2020 2064 6963 745f             dict_
+000144a0: 6368 6169 6e5f 4341 2069 7320 7265 7475  chain_CA is retu
+000144b0: 726e 6564 2061 6464 6974 696f 6e61 6c6c  rned additionall
+000144c0: 7920 6966 2067 6574 5f63 6f6f 7264 203d  y if get_coord =
+000144d0: 2054 7275 650a 0a20 2020 2020 2020 2020   True..         
+000144e0: 2020 2020 2020 202a 2064 6963 745f 6368         * dict_ch
+000144f0: 6169 6e5f 7363 6f72 6573 3a20 3244 2064  ain_scores: 2D d
+00014500: 6963 7469 6f6e 6172 7920 636f 6e74 6169  ictionary contai
+00014510: 6e69 6e67 2074 6865 2053 4d4f 4320 7363  ning the SMOC sc
+00014520: 6f72 6573 0a20 2020 2020 2020 2020 2020  ores.           
+00014530: 2020 2020 2020 2066 6f72 2065 6163 6820         for each 
+00014540: 7265 7369 6475 652e 204b 6579 7320 6172  residue. Keys ar
+00014550: 6520 6368 6169 6e5f 6c61 6265 6c20 666f  e chain_label fo
+00014560: 7220 6669 7273 7420 6469 6374 696f 6e61  r first dictiona
+00014570: 7279 0a20 2020 2020 2020 2020 2020 2020  ry.             
+00014580: 2020 2020 2061 6e64 2072 6573 6964 7565       and residue
+00014590: 5f6e 756d 6265 7220 666f 7220 7365 636f  _number for seco
+000145a0: 6e64 2064 6963 7469 6f6e 6172 792c 2065  nd dictionary, e
+000145b0: 2e67 2e3a 0a20 2020 2020 2020 2020 2020  .g.:.           
+000145c0: 2020 2020 2020 203a 636f 6465 3a60 6469         :code:`di
+000145d0: 6374 5f63 6861 696e 5f73 636f 7265 735b  ct_chain_scores[
+000145e0: 6368 6169 6e5f 6c61 6265 6c5d 5b72 6573  chain_label][res
+000145f0: 6964 7565 5f6e 756d 6265 725d 203d 2053  idue_number] = S
+00014600: 4d4f 435f 7363 6f72 6560 0a0a 2020 2020  MOC_score`..    
+00014610: 2020 2020 2020 2020 2020 2020 2a20 6469              * di
+00014620: 6374 5f63 6861 696e 5f72 6573 3a20 4469  ct_chain_res: Di
+00014630: 6374 696f 6e61 7279 2077 6974 6820 6368  ctionary with ch
+00014640: 6169 6e20 6c61 6265 6c73 2028 652e 672e  ain labels (e.g.
+00014650: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00014660: 2020 203a 636f 6465 3a60 2241 2260 2920     :code:`"A"`) 
+00014670: 6173 206b 6579 7320 616e 6420 6120 6c69  as keys and a li
+00014680: 7374 206f 6620 616c 6c20 7265 7369 6475  st of all residu
+00014690: 6520 6e75 6d62 6572 7320 666f 720a 2020  e numbers for.  
+000146a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000146b0: 6120 6769 7665 6e20 6368 6169 6e20 6173  a given chain as
+000146c0: 2076 616c 7565 732e 0a0a 2020 2020 2020   values...      
+000146d0: 2020 2020 2020 2020 2020 2a20 6469 6374            * dict
+000146e0: 5f63 6861 696e 5f43 413a 2032 4420 6469  _chain_CA: 2D di
+000146f0: 6374 696f 6e61 7279 2063 6f6e 7461 696e  ctionary contain
+00014700: 696e 6720 6120 6c69 7374 2066 6f72 2065  ing a list for e
+00014710: 6163 680a 2020 2020 2020 2020 2020 2020  ach.            
+00014720: 2020 2020 2020 7265 7369 6475 652c 2063        residue, c
+00014730: 6f6e 7461 696e 696e 6720 7468 6520 616d  ontaining the am
+00014740: 696e 6f20 6163 6964 2074 7970 6520 6f66  ino acid type of
+00014750: 2065 6163 6820 7265 7369 6475 6520 616e   each residue an
+00014760: 640a 2020 2020 2020 2020 2020 2020 2020  d.              
+00014770: 2020 2020 6974 7320 3344 2063 6f6f 7264      its 3D coord
+00014780: 696e 6174 6573 2e20 4b65 7973 2061 7265  inates. Keys are
+00014790: 2063 6861 696e 5f6c 6162 656c 2066 6f72   chain_label for
+000147a0: 2066 6972 7374 2064 6963 7469 6f6e 6172   first dictionar
+000147b0: 790a 2020 2020 2020 2020 2020 2020 2020  y.              
+000147c0: 2020 2020 616e 6420 7265 7369 6475 655f      and residue_
+000147d0: 6e75 6d62 6572 2066 6f72 2073 6563 6f6e  number for secon
+000147e0: 6420 6469 6374 696f 6e61 7279 2c20 652e  d dictionary, e.
+000147f0: 672e 3a0a 2020 2020 2020 2020 2020 2020  g.:.            
+00014800: 2020 2020 2020 3a63 6f64 653a 6064 6963        :code:`dic
+00014810: 745f 6368 6169 6e5f 4341 5b63 6861 696e  t_chain_CA[chain
+00014820: 5f6c 6162 656c 5d5b 7265 7369 6475 655f  _label][residue_
+00014830: 6e75 6d62 6572 5d20 3d20 7265 7369 6475  number] = residu
+00014840: 655f 696e 666f 600a 2020 2020 2020 2020  e_info`.        
+00014850: 2020 2020 2020 2020 2020 7768 6572 652c            where,
+00014860: 203a 636f 6465 3a60 7265 7369 6475 655f   :code:`residue_
+00014870: 696e 666f 203d 205b 7265 7369 6475 655f  info = [residue_
+00014880: 7479 7065 2c20 782c 2079 2c20 7a5d 600a  type, x, y, z]`.
+00014890: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
+000148a0: 2020 2020 626c 7572 7265 7220 3d20 5374      blurrer = St
+000148b0: 7275 6374 7572 6542 6c75 7272 6572 2829  ructureBlurrer()
+000148c0: 0a20 2020 2020 2020 2069 6620 7369 6d5f  .        if sim_
+000148d0: 6d61 7020 6973 204e 6f6e 653a 0a20 2020  map is None:.   
+000148e0: 2020 2020 2020 2020 2073 696d 5f6d 6170           sim_map
+000148f0: 203d 2062 6c75 7272 6572 2e67 6175 7373   = blurrer.gauss
+00014900: 6961 6e5f 626c 7572 5f72 6561 6c5f 7370  ian_blur_real_sp
+00014910: 6163 6528 0a20 2020 2020 2020 2020 2020  ace(.           
+00014920: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014930: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014940: 2020 2020 2020 2020 2073 7472 7563 7475           structu
+00014950: 7265 5f69 6e73 7461 6e63 652c 0a20 2020  re_instance,.   
+00014960: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014970: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014980: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014990: 2072 6573 6f6c 7574 696f 6e5f 6465 6e73   resolution_dens
+000149a0: 4d61 702c 0a20 2020 2020 2020 2020 2020  Map,.           
+000149b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000149c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000149d0: 2020 2020 2020 2020 2064 656e 734d 6170           densMap
+000149e0: 3d6d 6170 5f74 6172 6765 742c 0a20 2020  =map_target,.   
+000149f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014a00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014a10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014a20: 2073 6967 6d61 5f63 6f65 6666 3d73 6967   sigma_coeff=sig
+00014a30: 6d61 5f6d 6170 2c0a 2020 2020 2020 2020  ma_map,.        
+00014a40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014a50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014a60: 2020 2020 2020 2020 2020 2020 6e6f 726d              norm
+00014a70: 616c 6973 653d 5472 7565 290a 2020 2020  alise=True).    
+00014a80: 2020 2020 2320 6d61 736b 206f 7574 2062      # mask out b
+00014a90: 6163 6b67 726f 756e 640a 2020 2020 2020  ackground.      
+00014aa0: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
+00014ab0: 2020 2070 6561 6b2c 2061 7665 2c20 7369     peak, ave, si
+00014ac0: 676d 6120 3d20 7369 6d5f 6d61 702e 7065  gma = sim_map.pe
+00014ad0: 616b 5f64 656e 7369 7479 2829 0a20 2020  ak_density().   
+00014ae0: 2020 2020 2020 2020 2069 6620 7065 616b           if peak
+00014af0: 203e 3d20 6176 6520 2d20 7369 676d 6120   >= ave - sigma 
+00014b00: 616e 6420 7065 616b 203c 2028 6176 6520  and peak < (ave 
+00014b10: 2b20 3520 2a20 7369 676d 6129 3a0a 2020  + 5 * sigma):.  
+00014b20: 2020 2020 2020 2020 2020 2020 2020 7369                si
+00014b30: 6d5f 6d61 702e 6675 6c6c 4d61 7020 3d20  m_map.fullMap = 
+00014b40: 7369 6d5f 6d61 702e 6675 6c6c 4d61 7020  sim_map.fullMap 
+00014b50: 2a20 2873 696d 5f6d 6170 2e66 756c 6c4d  * (sim_map.fullM
+00014b60: 6170 203e 2070 6561 6b29 0a20 2020 2020  ap > peak).     
+00014b70: 2020 2065 7863 6570 743a 2020 2320 6e6f     except:  # no
+00014b80: 7161 3a20 4537 3232 0a20 2020 2020 2020  qa: E722.       
+00014b90: 2020 2020 2070 6173 730a 0a20 2020 2020       pass..     
+00014ba0: 2020 2064 6963 745f 6368 6169 6e5f 696e     dict_chain_in
+00014bb0: 6469 6365 732c 2064 6963 745f 6368 6169  dices, dict_chai
+00014bc0: 6e5f 7265 732c 2064 6963 745f 6368 6169  n_res, dict_chai
+00014bd0: 6e5f 4341 2c20 6772 6964 7472 6565 203d  n_CA, gridtree =
+00014be0: 205c 0a20 2020 2020 2020 2020 2020 2062   \.            b
+00014bf0: 6c75 7272 6572 2e67 6574 5f69 6e64 6963  lurrer.get_indic
+00014c00: 6573 280a 2020 2020 2020 2020 2020 2020  es(.            
+00014c10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014c20: 2020 2020 7374 7275 6374 7572 655f 696e      structure_in
+00014c30: 7374 616e 6365 2c0a 2020 2020 2020 2020  stance,.        
+00014c40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014c50: 2020 2020 2020 2020 6d61 705f 7461 7267          map_targ
+00014c60: 6574 2c0a 2020 2020 2020 2020 2020 2020  et,.            
+00014c70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014c80: 2020 2020 7265 736f 6c75 7469 6f6e 5f64      resolution_d
+00014c90: 656e 734d 6170 2c0a 2020 2020 2020 2020  ensMap,.        
+00014ca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014cb0: 2020 2020 2020 2020 7369 6d5f 7369 676d          sim_sigm
+00014cc0: 615f 636f 6566 663d 7369 676d 615f 6d61  a_coeff=sigma_ma
+00014cd0: 702c 0a20 2020 2020 2020 2020 2020 2020  p,.             
+00014ce0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014cf0: 2020 2073 6967 6d61 5f74 6872 3d73 6967     sigma_thr=sig
+00014d00: 6d61 5f74 6872 2c0a 2020 2020 2020 2020  ma_thr,.        
+00014d10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014d20: 2020 2020 2020 2020 6174 6f6d 5f63 656e          atom_cen
+00014d30: 7472 653d 6174 6f6d 5f63 656e 7472 6529  tre=atom_centre)
+00014d40: 0a20 2020 2020 2020 2064 656c 2073 7472  .        del str
+00014d50: 7563 7475 7265 5f69 6e73 7461 6e63 650a  ucture_instance.
+00014d60: 2020 2020 2020 2020 6763 2e63 6f6c 6c65          gc.colle
+00014d70: 6374 2829 0a20 2020 2020 2020 2023 2067  ct().        # g
+00014d80: 6574 2064 6574 6169 6c73 206f 6620 6d61  et details of ma
+00014d90: 700a 2020 2020 2020 2020 6e7a 2c20 6e79  p.        nz, ny
+00014da0: 2c20 6e78 203d 206d 6170 5f74 6172 6765  , nx = map_targe
+00014db0: 742e 6675 6c6c 4d61 702e 7368 6170 650a  t.fullMap.shape.
+00014dc0: 2020 2020 2020 2020 7a67 2c20 7967 2c20          zg, yg, 
+00014dd0: 7867 203d 206e 702e 6d67 7269 645b 303a  xg = np.mgrid[0:
+00014de0: 6e7a 2c20 303a 6e79 2c20 303a 6e78 5d0a  nz, 0:ny, 0:nx].
+00014df0: 2020 2020 2020 2020 2320 7820 792c 7a20          # x y,z 
+00014e00: 636f 6f72 6469 6e61 7465 7320 6f66 2074  coordinates of t
+00014e10: 6865 2067 7269 640a 2020 2020 2020 2020  he grid.        
+00014e20: 696e 6469 203d 206c 6973 7428 7a69 7028  indi = list(zip(
+00014e30: 7867 2e72 6176 656c 2829 2c20 7967 2e72  xg.ravel(), yg.r
+00014e40: 6176 656c 2829 2c20 7a67 2e72 6176 656c  avel(), zg.ravel
+00014e50: 2829 2929 0a0a 2020 2020 2020 2020 6c69  ()))..        li
+00014e60: 7374 5f73 6363 6320 3d20 5b5d 0a20 2020  st_sccc = [].   
+00014e70: 2020 2020 2023 2073 6176 6520 7363 6f72       # save scor
+00014e80: 6573 2066 6f72 2065 6163 6820 6368 6169  es for each chai
+00014e90: 6e20 616e 6420 7265 730a 2020 2020 2020  n and res.      
+00014ea0: 2020 6469 6374 5f63 6861 696e 5f73 636f    dict_chain_sco
+00014eb0: 7265 7320 3d20 4f72 6465 7265 6444 6963  res = OrderedDic
+00014ec0: 7428 290a 2020 2020 2020 2020 666f 7220  t().        for 
+00014ed0: 6368 2069 6e20 6469 6374 5f63 6861 696e  ch in dict_chain
+00014ee0: 5f69 6e64 6963 6573 3a0a 2020 2020 2020  _indices:.      
+00014ef0: 2020 2020 2020 6469 6374 5f72 6573 5f73        dict_res_s
+00014f00: 636f 7265 7320 3d20 4f72 6465 7265 6444  cores = OrderedD
+00014f10: 6963 7428 290a 2020 2020 2020 2020 2020  ict().          
+00014f20: 2020 6469 6374 5f72 6573 5f69 6e64 6963    dict_res_indic
+00014f30: 6573 203d 2064 6963 745f 6368 6169 6e5f  es = dict_chain_
+00014f40: 696e 6469 6365 735b 6368 5d0a 2020 2020  indices[ch].    
+00014f50: 2020 2020 2020 2020 2320 6d75 6c74 692d          # multi-
+00014f60: 6368 6169 6e20 7269 6769 6420 626f 6479  chain rigid body
+00014f70: 2070 6172 7365 720a 2020 2020 2020 2020   parser.        
+00014f80: 2020 2020 6966 2072 6967 6964 5f62 6f64      if rigid_bod
+00014f90: 795f 6669 6c65 2069 7320 6e6f 7420 4e6f  y_file is not No
+00014fa0: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
+00014fb0: 2020 2020 6469 6374 5f72 6573 5f73 636f      dict_res_sco
+00014fc0: 7265 7320 3d20 7365 6c66 2e73 6d6f 635f  res = self.smoc_
+00014fd0: 7363 6f72 655f 7269 6769 645f 626f 6469  score_rigid_bodi
+00014fe0: 6573 280a 2020 2020 2020 2020 2020 2020  es(.            
+00014ff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015000: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015010: 2020 2020 6469 6374 5f72 6573 5f69 6e64      dict_res_ind
+00015020: 6963 6573 2c0a 2020 2020 2020 2020 2020  ices,.          
+00015030: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015040: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015050: 2020 2020 2020 7269 6769 645f 626f 6479        rigid_body
+00015060: 5f66 696c 652c 0a20 2020 2020 2020 2020  _file,.         
+00015070: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015080: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015090: 2020 2020 2020 2063 682c 0a20 2020 2020         ch,.     
+000150a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000150b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000150c0: 2020 2020 2020 2020 2020 2069 6e64 692c             indi,
+000150d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
 000150e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000150f0: 2020 2020 2020 2020 2069 6e64 6963 6573           indices
-00015100: 203d 2073 656c 662e 736d 6f63 5f67 6574   = self.smoc_get
-00015110: 5f69 6e64 6963 6573 5f66 7261 676d 656e  _indices_fragmen
-00015120: 745f 7769 6e64 6f77 280a 2020 2020 2020  t_window(.      
-00015130: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015140: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015150: 2020 2020 2020 2020 2020 2020 2020 6469                di
-00015160: 6374 5f72 6573 5f69 6e64 6963 6573 2c0a  ct_res_indices,.
-00015170: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015180: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015190: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000151a0: 2020 2020 6469 6374 5f63 6861 696e 5f72      dict_chain_r
-000151b0: 6573 2c0a 2020 2020 2020 2020 2020 2020  es,.            
-000151c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000151d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000151e0: 2020 2020 2020 2020 6368 2c0a 2020 2020          ch,.    
-000151f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015200: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015210: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015220: 7265 732c 0a20 2020 2020 2020 2020 2020  res,.           
+000150f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015100: 206d 6170 5f74 6172 6765 742c 0a20 2020   map_target,.   
+00015110: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015120: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015130: 2020 2020 2020 2020 2020 2020 2073 696d               sim
+00015140: 5f6d 6170 290a 2020 2020 2020 2020 2020  _map).          
+00015150: 2020 2320 666f 7220 7265 7369 6475 6573    # for residues
+00015160: 206e 6f74 2069 6e20 7269 6769 6420 626f   not in rigid bo
+00015170: 6469 6573 0a20 2020 2020 2020 2020 2020  dies.           
+00015180: 2066 6f72 2072 6573 2069 6e20 6469 6374   for res in dict
+00015190: 5f72 6573 5f69 6e64 6963 6573 3a0a 2020  _res_indices:.  
+000151a0: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+000151b0: 6966 206e 6f74 2064 6963 745f 7265 735f  if not dict_res_
+000151c0: 7363 6f72 6573 2e68 6173 5f6b 6579 2872  scores.has_key(r
+000151d0: 6573 293a 0a20 2020 2020 2020 2020 2020  es):.           
+000151e0: 2020 2020 2069 6620 7265 7320 6e6f 7420       if res not 
+000151f0: 696e 2064 6963 745f 7265 735f 7363 6f72  in dict_res_scor
+00015200: 6573 3a0a 2020 2020 2020 2020 2020 2020  es:.            
+00015210: 2020 2020 2020 2020 6966 2066 7261 676d          if fragm
+00015220: 656e 745f 7363 6f72 653a 0a20 2020 2020  ent_score:.     
 00015230: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015240: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015250: 2020 2020 2020 2020 2077 696e 290a 2020           win).  
-00015260: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015270: 2020 2020 2020 6578 6365 7074 2054 7970        except Typ
-00015280: 6545 7272 6f72 3a0a 2020 2020 2020 2020  eError:.        
-00015290: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000152a0: 2020 2020 696e 6469 6365 7320 3d20 5b5d      indices = []
-000152b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000152c0: 2020 2020 2020 2020 2023 2075 6e75 7375           # unusu
-000152d0: 616c 2063 6173 6573 0a20 2020 2020 2020  al cases.       
+00015240: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
+00015250: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015260: 2020 2020 696e 6469 6365 7320 3d20 7365      indices = se
+00015270: 6c66 2e73 6d6f 635f 6765 745f 696e 6469  lf.smoc_get_indi
+00015280: 6365 735f 6672 6167 6d65 6e74 5f77 696e  ces_fragment_win
+00015290: 646f 7728 0a20 2020 2020 2020 2020 2020  dow(.           
+000152a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000152b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000152c0: 2020 2020 2020 2020 2064 6963 745f 7265           dict_re
+000152d0: 735f 696e 6469 6365 732c 0a20 2020 2020  s_indices,.     
 000152e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000152f0: 2069 6620 6c65 6e28 696e 6469 6365 7329   if len(indices)
-00015300: 203e 2030 2061 6e64 206c 656e 2869 6e64   > 0 and len(ind
-00015310: 6963 6573 2920 3c20 3130 3a0a 2020 2020  ices) < 10:.    
+000152f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015300: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+00015310: 6963 745f 6368 6169 6e5f 7265 732c 0a20  ict_chain_res,. 
 00015320: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015330: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
+00015330: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00015340: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015350: 2020 2020 2020 2020 2020 2020 2064 6963               dic
-00015360: 745f 7265 735f 7363 6f72 6573 5b72 6573  t_res_scores[res
-00015370: 5d20 3d20 5c0a 2020 2020 2020 2020 2020  ] = \.          
-00015380: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015390: 2020 2020 2020 2020 2020 6469 6374 5f72            dict_r
-000153a0: 6573 5f73 636f 7265 735b 6469 6374 5f63  es_scores[dict_c
-000153b0: 6861 696e 5f72 6573 5b63 685d 5b64 6963  hain_res[ch][dic
-000153c0: 745f 6368 6169 6e5f 7265 735b 6368 5d2e  t_chain_res[ch].
-000153d0: 696e 6465 7828 7265 7329 2d31 5d5d 2020  index(res)-1]]  
-000153e0: 2320 6e6f 7161 3a20 4535 3031 0a20 2020  # noqa: E501.   
-000153f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015400: 2020 2020 2020 2020 2020 2020 2074 7279               try
-00015410: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00015350: 2020 2063 682c 0a20 2020 2020 2020 2020     ch,.         
+00015360: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015370: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015380: 2020 2020 2020 2020 2020 2072 6573 2c0a             res,.
+00015390: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000153a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000153b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000153c0: 2020 2020 7769 6e29 0a20 2020 2020 2020      win).       
+000153d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000153e0: 2065 7863 6570 7420 5479 7065 4572 726f   except TypeErro
+000153f0: 723a 0a20 2020 2020 2020 2020 2020 2020  r:.             
+00015400: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00015410: 6e64 6963 6573 203d 205b 5d0a 2020 2020  ndices = [].    
 00015420: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015430: 2020 2020 2020 6469 6374 5f72 6573 5f73        dict_res_s
-00015440: 636f 7265 735b 7265 735d 203d 205c 0a20  cores[res] = \. 
-00015450: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015460: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015470: 2020 2020 2020 2028 6469 6374 5f72 6573         (dict_res
-00015480: 5f73 636f 7265 735b 7265 735d 202b 0a20  _scores[res] +. 
+00015430: 2020 2020 2320 756e 7573 7561 6c20 6361      # unusual ca
+00015440: 7365 730a 2020 2020 2020 2020 2020 2020  ses.            
+00015450: 2020 2020 2020 2020 2020 2020 6966 206c              if l
+00015460: 656e 2869 6e64 6963 6573 2920 3e20 3020  en(indices) > 0 
+00015470: 616e 6420 6c65 6e28 696e 6469 6365 7329  and len(indices)
+00015480: 203c 2031 303a 0a20 2020 2020 2020 2020   < 10:.         
 00015490: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000154a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000154b0: 2020 2020 2020 2020 2020 2064 6963 745f             dict_
-000154c0: 7265 735f 7363 6f72 6573 5b64 6963 745f  res_scores[dict_
-000154d0: 6368 6169 6e5f 7265 735b 6368 5d5b 6469  chain_res[ch][di
-000154e0: 6374 5f63 6861 696e 5f72 6573 5b63 685d  ct_chain_res[ch]
-000154f0: 2e69 6e64 6578 2872 6573 292b 315d 5d29  .index(res)+1]])
-00015500: 2f32 2e30 2020 2320 6e6f 7161 3a20 4535  /2.0  # noqa: E5
-00015510: 3031 0a20 2020 2020 2020 2020 2020 2020  01.             
-00015520: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015530: 2020 2065 7863 6570 7420 2849 6e64 6578     except (Index
-00015540: 4572 726f 722c 204b 6579 4572 726f 7229  Error, KeyError)
-00015550: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+000154a0: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
+000154b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000154c0: 2020 2020 2020 2020 6469 6374 5f72 6573          dict_res
+000154d0: 5f73 636f 7265 735b 7265 735d 203d 205c  _scores[res] = \
+000154e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000154f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015500: 2020 2020 2064 6963 745f 7265 735f 7363       dict_res_sc
+00015510: 6f72 6573 5b64 6963 745f 6368 6169 6e5f  ores[dict_chain_
+00015520: 7265 735b 6368 5d5b 6469 6374 5f63 6861  res[ch][dict_cha
+00015530: 696e 5f72 6573 5b63 685d 2e69 6e64 6578  in_res[ch].index
+00015540: 2872 6573 292d 315d 5d20 2023 206e 6f71  (res)-1]]  # noq
+00015550: 613a 2045 3530 310a 2020 2020 2020 2020  a: E501.        
 00015560: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015570: 2020 2020 2020 7061 7373 0a20 2020 2020        pass.     
+00015570: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
 00015580: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015590: 2020 2020 2020 2065 7863 6570 7420 2849         except (I
-000155a0: 6e64 6578 4572 726f 722c 204b 6579 4572  ndexError, KeyEr
-000155b0: 726f 7229 3a0a 2020 2020 2020 2020 2020  ror):.          
+00015590: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000155a0: 2064 6963 745f 7265 735f 7363 6f72 6573   dict_res_scores
+000155b0: 5b72 6573 5d20 3d20 5c0a 2020 2020 2020  [res] = \.      
 000155c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000155d0: 2020 2020 2020 7472 793a 0a20 2020 2020        try:.     
-000155e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000155f0: 2020 2020 2020 2020 2020 2020 2020 2064                 d
-00015600: 6963 745f 7265 735f 7363 6f72 6573 5b72  ict_res_scores[r
-00015610: 6573 5d20 3d20 5c0a 2020 2020 2020 2020  es] = \.        
-00015620: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015630: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015640: 6469 6374 5f72 6573 5f73 636f 7265 735b  dict_res_scores[
-00015650: 6469 6374 5f63 6861 696e 5f72 6573 5b63  dict_chain_res[c
-00015660: 685d 5b64 6963 745f 6368 6169 6e5f 7265  h][dict_chain_re
-00015670: 735b 6368 5d2e 696e 6465 7828 7265 7329  s[ch].index(res)
-00015680: 2b31 5d5d 2020 2320 6e6f 7161 3a20 4535  +1]]  # noqa: E5
-00015690: 3031 0a20 2020 2020 2020 2020 2020 2020  01.             
-000156a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000156b0: 2020 2065 7863 6570 7420 2849 6e64 6578     except (Index
-000156c0: 4572 726f 722c 204b 6579 4572 726f 7229  Error, KeyError)
-000156d0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-000156e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000156f0: 2020 2020 2020 6469 6374 5f72 6573 5f73        dict_res_s
-00015700: 636f 7265 735b 7265 735d 203d 2030 2e30  cores[res] = 0.0
-00015710: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00015720: 2020 2020 2020 2020 2020 2020 2063 6f6e               con
-00015730: 7469 6e75 650a 2020 2020 2020 2020 2020  tinue.          
-00015740: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
+000155d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000155e0: 2020 2864 6963 745f 7265 735f 7363 6f72    (dict_res_scor
+000155f0: 6573 5b72 6573 5d20 2b0a 2020 2020 2020  es[res] +.      
+00015600: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015610: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015620: 2020 2020 2020 6469 6374 5f72 6573 5f73        dict_res_s
+00015630: 636f 7265 735b 6469 6374 5f63 6861 696e  cores[dict_chain
+00015640: 5f72 6573 5b63 685d 5b64 6963 745f 6368  _res[ch][dict_ch
+00015650: 6169 6e5f 7265 735b 6368 5d2e 696e 6465  ain_res[ch].inde
+00015660: 7828 7265 7329 2b31 5d5d 292f 322e 3020  x(res)+1]])/2.0 
+00015670: 2023 206e 6f71 613a 2045 3530 310a 2020   # noqa: E501.  
+00015680: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015690: 2020 2020 2020 2020 2020 2020 2020 6578                ex
+000156a0: 6365 7074 2028 496e 6465 7845 7272 6f72  cept (IndexError
+000156b0: 2c20 4b65 7945 7272 6f72 293a 0a20 2020  , KeyError):.   
+000156c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000156d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000156e0: 2070 6173 730a 2020 2020 2020 2020 2020   pass.          
+000156f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015700: 2020 6578 6365 7074 2028 496e 6465 7845    except (IndexE
+00015710: 7272 6f72 2c20 4b65 7945 7272 6f72 293a  rror, KeyError):
+00015720: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00015730: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015740: 2074 7279 3a0a 2020 2020 2020 2020 2020   try:.          
 00015750: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015760: 2020 2020 2020 2020 696e 6469 6365 7320          indices 
-00015770: 3d20 6469 6374 5f72 6573 5f69 6e64 6963  = dict_res_indic
-00015780: 6573 5b72 6573 5d5b 3a5d 0a20 2020 2020  es[res][:].     
+00015760: 2020 2020 2020 2020 2020 6469 6374 5f72            dict_r
+00015770: 6573 5f73 636f 7265 735b 7265 735d 203d  es_scores[res] =
+00015780: 205c 0a20 2020 2020 2020 2020 2020 2020   \.             
 00015790: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000157a0: 2020 2023 2066 6f72 206c 6f77 6572 2072     # for lower r
-000157b0: 6573 6f6c 7574 696f 6e73 2063 616c 6375  esolutions calcu
-000157c0: 6c61 7465 2073 636f 7265 2069 6e20 6120  late score in a 
-000157d0: 7370 6865 7265 0a20 2020 2020 2020 2020  sphere.         
-000157e0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-000157f0: 6620 7265 736f 6c75 7469 6f6e 5f64 656e  f resolution_den
-00015800: 734d 6170 203e 2033 2e35 3a0a 2020 2020  sMap > 3.5:.    
-00015810: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015820: 2020 2020 2020 2020 6469 7374 203d 2031          dist = 1
-00015830: 2e30 2a72 6573 6f6c 7574 696f 6e5f 6465  .0*resolution_de
-00015840: 6e73 4d61 700a 2020 2020 2020 2020 2020  nsMap.          
+000157a0: 2020 2020 2020 2020 2020 2064 6963 745f             dict_
+000157b0: 7265 735f 7363 6f72 6573 5b64 6963 745f  res_scores[dict_
+000157c0: 6368 6169 6e5f 7265 735b 6368 5d5b 6469  chain_res[ch][di
+000157d0: 6374 5f63 6861 696e 5f72 6573 5b63 685d  ct_chain_res[ch]
+000157e0: 2e69 6e64 6578 2872 6573 292b 315d 5d20  .index(res)+1]] 
+000157f0: 2023 206e 6f71 613a 2045 3530 310a 2020   # noqa: E501.  
+00015800: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015810: 2020 2020 2020 2020 2020 2020 2020 6578                ex
+00015820: 6365 7074 2028 496e 6465 7845 7272 6f72  cept (IndexError
+00015830: 2c20 4b65 7945 7272 6f72 293a 0a20 2020  , KeyError):.   
+00015840: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00015850: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015860: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
-00015870: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015880: 2020 2020 2020 2069 6e64 6963 6573 5f6c         indices_l
-00015890: 6f63 616c 203d 205c 0a20 2020 2020 2020  ocal = \.       
-000158a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000158b0: 2020 2020 2020 2020 2020 2020 2073 656c               sel
-000158c0: 662e 736d 6f63 5f67 6574 5f69 6e64 6963  f.smoc_get_indic
-000158d0: 6573 5f73 7068 6572 6528 0a20 2020 2020  es_sphere(.     
-000158e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000158f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015900: 2020 2020 2020 2020 2020 2020 2020 2067                 g
-00015910: 7269 6474 7265 652c 0a20 2020 2020 2020  ridtree,.       
-00015920: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015930: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015940: 2020 2020 2020 2020 2020 2020 2064 6963               dic
-00015950: 745f 6368 6169 6e5f 4341 5b63 685d 5b72  t_chain_CA[ch][r
-00015960: 6573 5d5b 313a 5d2c 0a20 2020 2020 2020  es][1:],.       
-00015970: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015860: 2064 6963 745f 7265 735f 7363 6f72 6573   dict_res_scores
+00015870: 5b72 6573 5d20 3d20 302e 300a 2020 2020  [res] = 0.0.    
+00015880: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015890: 2020 2020 2020 2020 636f 6e74 696e 7565          continue
+000158a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000158b0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+000158c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000158d0: 2020 2069 6e64 6963 6573 203d 2064 6963     indices = dic
+000158e0: 745f 7265 735f 696e 6469 6365 735b 7265  t_res_indices[re
+000158f0: 735d 5b3a 5d0a 2020 2020 2020 2020 2020  s][:].          
+00015900: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+00015910: 666f 7220 6c6f 7765 7220 7265 736f 6c75  for lower resolu
+00015920: 7469 6f6e 7320 6361 6c63 756c 6174 6520  tions calculate 
+00015930: 7363 6f72 6520 696e 2061 2073 7068 6572  score in a spher
+00015940: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
+00015950: 2020 2020 2020 2020 2020 6966 2072 6573            if res
+00015960: 6f6c 7574 696f 6e5f 6465 6e73 4d61 7020  olution_densMap 
+00015970: 3e20 332e 353a 0a20 2020 2020 2020 2020  > 3.5:.         
 00015980: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015990: 2020 2020 2020 2020 2020 2020 2064 6973               dis
-000159a0: 743d 6469 7374 290a 2020 2020 2020 2020  t=dist).        
-000159b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000159c0: 2020 2020 2020 2020 696e 6469 6365 732e          indices.
-000159d0: 6578 7465 6e64 2869 6e64 6963 6573 5f6c  extend(indices_l
-000159e0: 6f63 616c 290a 2020 2020 2020 2020 2020  ocal).          
-000159f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015a00: 2020 6578 6365 7074 2028 5479 7065 4572    except (TypeEr
-00015a10: 726f 722c 204b 6579 4572 726f 7229 3a0a  ror, KeyError):.
-00015a20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015a30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015a40: 7061 7373 0a0a 2020 2020 2020 2020 2020  pass..          
-00015a50: 2020 2020 2020 2020 2020 6966 206c 656e            if len
-00015a60: 2869 6e64 6963 6573 2920 3d3d 2030 3a0a  (indices) == 0:.
-00015a70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015a80: 2020 2020 2020 2020 7072 696e 7428 2753          print('S
-00015a90: 636f 7265 2063 616c 6375 6c61 7469 6f6e  core calculation
-00015aa0: 2066 6169 6c65 6420 666f 723a 2027 2c20   failed for: ', 
-00015ab0: 6368 2c20 7265 7329 0a20 2020 2020 2020  ch, res).       
-00015ac0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015ad0: 2073 6d6f 6320 3d20 2d31 2e30 0a20 2020   smoc = -1.0.   
+00015990: 2020 2064 6973 7420 3d20 312e 302a 7265     dist = 1.0*re
+000159a0: 736f 6c75 7469 6f6e 5f64 656e 734d 6170  solution_densMap
+000159b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000159c0: 2020 2020 2020 2020 2020 2020 2074 7279               try
+000159d0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+000159e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000159f0: 2020 696e 6469 6365 735f 6c6f 6361 6c20    indices_local 
+00015a00: 3d20 5c0a 2020 2020 2020 2020 2020 2020  = \.            
+00015a10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015a20: 2020 2020 2020 2020 7365 6c66 2e73 6d6f          self.smo
+00015a30: 635f 6765 745f 696e 6469 6365 735f 7370  c_get_indices_sp
+00015a40: 6865 7265 280a 2020 2020 2020 2020 2020  here(.          
+00015a50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015a60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015a70: 2020 2020 2020 2020 2020 6772 6964 7472            gridtr
+00015a80: 6565 2c0a 2020 2020 2020 2020 2020 2020  ee,.            
+00015a90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015aa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015ab0: 2020 2020 2020 2020 6469 6374 5f63 6861          dict_cha
+00015ac0: 696e 5f43 415b 6368 5d5b 7265 735d 5b31  in_CA[ch][res][1
+00015ad0: 3a5d 2c0a 2020 2020 2020 2020 2020 2020  :],.            
 00015ae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015af0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-00015b00: 2020 2020 2020 2020 2020 2020 2020 2074                 t
-00015b10: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
+00015af0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015b00: 2020 2020 2020 2020 6469 7374 3d64 6973          dist=dis
+00015b10: 7429 0a20 2020 2020 2020 2020 2020 2020  t).             
 00015b20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015b30: 696e 645f 6172 727a 7978 203d 2073 656c  ind_arrzyx = sel
-00015b40: 662e 696e 6469 6365 735f 736d 6f63 2869  f.indices_smoc(i
-00015b50: 6e64 6963 6573 2c20 696e 6469 290a 2020  ndices, indi).  
-00015b60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015b70: 2020 2020 2020 2020 2020 6966 2063 616c            if cal
-00015b80: 635f 6d65 7472 6963 203d 3d20 2773 6d6f  c_metric == 'smo
-00015b90: 6327 3a0a 2020 2020 2020 2020 2020 2020  c':.            
-00015ba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015bb0: 2020 2020 736d 6f63 203d 2073 656c 662e      smoc = self.
-00015bc0: 6361 6c63 5f6d 6f63 280a 2020 2020 2020  calc_moc(.      
-00015bd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015b30: 2020 2069 6e64 6963 6573 2e65 7874 656e     indices.exten
+00015b40: 6428 696e 6469 6365 735f 6c6f 6361 6c29  d(indices_local)
+00015b50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00015b60: 2020 2020 2020 2020 2020 2020 2065 7863               exc
+00015b70: 6570 7420 2854 7970 6545 7272 6f72 2c20  ept (TypeError, 
+00015b80: 4b65 7945 7272 6f72 293a 0a20 2020 2020  KeyError):.     
+00015b90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015ba0: 2020 2020 2020 2020 2020 2070 6173 730a             pass.
+00015bb0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00015bc0: 2020 2020 2069 6620 6c65 6e28 696e 6469       if len(indi
+00015bd0: 6365 7329 203d 3d20 303a 0a20 2020 2020  ces) == 0:.     
 00015be0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015bf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015c00: 2020 696e 645f 6172 727a 7978 2c0a 2020    ind_arrzyx,.  
-00015c10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015c20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015c30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015c40: 2020 2020 2020 7369 6d5f 6d61 702c 0a20        sim_map,. 
-00015c50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015c60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015c70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015c80: 2020 2020 2020 206d 6170 5f74 6172 6765         map_targe
-00015c90: 7429 0a20 2020 2020 2020 2020 2020 2020  t).             
-00015ca0: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-00015cb0: 6c69 6620 6361 6c63 5f6d 6574 7269 6320  lif calc_metric 
-00015cc0: 3d3d 2027 7363 6363 273a 0a20 2020 2020  == 'sccc':.     
+00015bf0: 2020 2070 7269 6e74 2827 5363 6f72 6520     print('Score 
+00015c00: 6361 6c63 756c 6174 696f 6e20 6661 696c  calculation fail
+00015c10: 6564 2066 6f72 3a20 272c 2063 682c 2072  ed for: ', ch, r
+00015c20: 6573 290a 2020 2020 2020 2020 2020 2020  es).            
+00015c30: 2020 2020 2020 2020 2020 2020 736d 6f63              smoc
+00015c40: 203d 202d 312e 300a 2020 2020 2020 2020   = -1.0.        
+00015c50: 2020 2020 2020 2020 2020 2020 656c 7365              else
+00015c60: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00015c70: 2020 2020 2020 2020 2020 7472 793a 0a20            try:. 
+00015c80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015c90: 2020 2020 2020 2020 2020 2069 6e64 5f61             ind_a
+00015ca0: 7272 7a79 7820 3d20 7365 6c66 2e69 6e64  rrzyx = self.ind
+00015cb0: 6963 6573 5f73 6d6f 6328 696e 6469 6365  ices_smoc(indice
+00015cc0: 732c 2069 6e64 6929 0a20 2020 2020 2020  s, indi).       
 00015cd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015ce0: 2020 2020 2020 2020 2020 2073 6d6f 6320             smoc 
-00015cf0: 3d20 7365 6c66 2e63 616c 635f 6363 6328  = self.calc_ccc(
-00015d00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00015d10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015d20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015d30: 2020 2020 2069 6e64 5f61 7272 7a79 782c       ind_arrzyx,
-00015d40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00015ce0: 2020 2020 2069 6620 6361 6c63 5f6d 6574       if calc_met
+00015cf0: 7269 6320 3d3d 2027 736d 6f63 273a 0a20  ric == 'smoc':. 
+00015d00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015d10: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00015d20: 6d6f 6320 3d20 7365 6c66 2e63 616c 635f  moc = self.calc_
+00015d30: 6d6f 6328 0a20 2020 2020 2020 2020 2020  moc(.           
+00015d40: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00015d50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015d60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015d70: 2020 2020 2073 696d 5f6d 6170 2c0a 2020       sim_map,.  
+00015d60: 2020 2020 2020 2020 2020 2020 2069 6e64               ind
+00015d70: 5f61 7272 7a79 782c 0a20 2020 2020 2020  _arrzyx,.       
 00015d80: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00015d90: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00015da0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015db0: 2020 6d61 705f 7461 7267 6574 290a 2020    map_target).  
+00015db0: 2073 696d 5f6d 6170 2c0a 2020 2020 2020   sim_map,.      
 00015dc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015dd0: 2020 2020 2020 6578 6365 7074 2049 6e64        except Ind
-00015de0: 6578 4572 726f 723a 0a20 2020 2020 2020  exError:.       
-00015df0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015e00: 2020 2020 2073 6d6f 6320 3d20 302e 300a       smoc = 0.0.
-00015e10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015e20: 2020 2020 6469 6374 5f72 6573 5f73 636f      dict_res_sco
-00015e30: 7265 735b 7265 735d 203d 2073 6d6f 630a  res[res] = smoc.
+00015dd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015de0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015df0: 2020 6d61 705f 7461 7267 6574 290a 2020    map_target).  
+00015e00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015e10: 2020 2020 2020 2020 2020 656c 6966 2063            elif c
+00015e20: 616c 635f 6d65 7472 6963 203d 3d20 2773  alc_metric == 's
+00015e30: 6363 6327 3a0a 2020 2020 2020 2020 2020  ccc':.          
 00015e40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015e50: 2020 2020 2320 6572 726f 7220 696e 2073      # error in s
-00015e60: 636f 7265 2063 616c 6375 6c61 7469 6f6e  core calculation
-00015e70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00015e80: 2020 2020 2069 6620 736d 6f63 203d 3d20       if smoc == 
-00015e90: 2d31 2e30 3a0a 2020 2020 2020 2020 2020  -1.0:.          
-00015ea0: 2020 2020 2020 2020 2020 2020 2020 6469                di
-00015eb0: 6374 5f72 6573 5f73 636f 7265 735b 7265  ct_res_scores[re
-00015ec0: 735d 203d 2030 2e30 0a20 2020 2020 2020  s] = 0.0.       
+00015e50: 2020 2020 2020 736d 6f63 203d 2073 656c        smoc = sel
+00015e60: 662e 6361 6c63 5f63 6363 280a 2020 2020  f.calc_ccc(.    
+00015e70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015e80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015e90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015ea0: 696e 645f 6172 727a 7978 2c0a 2020 2020  ind_arrzyx,.    
+00015eb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015ec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00015ed0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015ee0: 2074 7279 3a0a 2020 2020 2020 2020 2020   try:.          
+00015ee0: 7369 6d5f 6d61 702c 0a20 2020 2020 2020  sim_map,.       
 00015ef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015f00: 2020 6469 6374 5f72 6573 5f73 636f 7265    dict_res_score
-00015f10: 735b 7265 735d 203d 205c 0a20 2020 2020  s[res] = \.     
-00015f20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015f30: 2020 2020 2020 2020 2020 2064 6963 745f             dict_
-00015f40: 7265 735f 7363 6f72 6573 5b64 6963 745f  res_scores[dict_
-00015f50: 6368 6169 6e5f 7265 735b 6368 5d5b 6469  chain_res[ch][di
-00015f60: 6374 5f63 6861 696e 5f72 6573 5b63 685d  ct_chain_res[ch]
-00015f70: 2e69 6e64 6578 2872 6573 292d 315d 5d20  .index(res)-1]] 
-00015f80: 2023 206e 6f71 613a 2045 3530 310a 2020   # noqa: E501.  
-00015f90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015fa0: 2020 2020 2020 2020 2020 7472 793a 0a20            try:. 
-00015fb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015fc0: 2020 2020 2020 2020 2020 2020 2020 2064                 d
-00015fd0: 6963 745f 7265 735f 7363 6f72 6573 5b72  ict_res_scores[r
-00015fe0: 6573 5d20 3d20 5c0a 2020 2020 2020 2020  es] = \.        
-00015ff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016000: 2020 2020 2020 2020 2020 2020 2864 6963              (dic
-00016010: 745f 7265 735f 7363 6f72 6573 5b72 6573  t_res_scores[res
-00016020: 5d20 2b0a 2020 2020 2020 2020 2020 2020  ] +.            
-00016030: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016040: 2020 2020 2020 2020 2020 2020 6469 6374              dict
-00016050: 5f72 6573 5f73 636f 7265 735b 6469 6374  _res_scores[dict
-00016060: 5f63 6861 696e 5f72 6573 5b63 685d 5b64  _chain_res[ch][d
-00016070: 6963 745f 6368 6169 6e5f 7265 735b 6368  ict_chain_res[ch
-00016080: 5d2e 696e 6465 7828 7265 7329 2b31 5d5d  ].index(res)+1]]
-00016090: 292f 322e 3020 2023 206e 6f71 613a 2045  )/2.0  # noqa: E
-000160a0: 3530 310a 2020 2020 2020 2020 2020 2020  501.            
-000160b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000160c0: 6578 6365 7074 2028 496e 6465 7845 7272  except (IndexErr
-000160d0: 6f72 2c20 4b65 7945 7272 6f72 293a 0a20  or, KeyError):. 
-000160e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000160f0: 2020 2020 2020 2020 2020 2020 2020 2070                 p
-00016100: 6173 730a 2020 2020 2020 2020 2020 2020  ass.            
-00016110: 2020 2020 2020 2020 2020 2020 6578 6365              exce
-00016120: 7074 2028 496e 6465 7845 7272 6f72 2c20  pt (IndexError, 
-00016130: 4b65 7945 7272 6f72 293a 0a20 2020 2020  KeyError):.     
-00016140: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016150: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
+00015f00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015f10: 2020 2020 2020 2020 2020 2020 206d 6170               map
+00015f20: 5f74 6172 6765 7429 0a20 2020 2020 2020  _target).       
+00015f30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015f40: 2065 7863 6570 7420 496e 6465 7845 7272   except IndexErr
+00015f50: 6f72 3a0a 2020 2020 2020 2020 2020 2020  or:.            
+00015f60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015f70: 736d 6f63 203d 2030 2e30 0a20 2020 2020  smoc = 0.0.     
+00015f80: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+00015f90: 6963 745f 7265 735f 7363 6f72 6573 5b72  ict_res_scores[r
+00015fa0: 6573 5d20 3d20 736d 6f63 0a20 2020 2020  es] = smoc.     
+00015fb0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+00015fc0: 2065 7272 6f72 2069 6e20 7363 6f72 6520   error in score 
+00015fd0: 6361 6c63 756c 6174 696f 6e0a 2020 2020  calculation.    
+00015fe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015ff0: 6966 2073 6d6f 6320 3d3d 202d 312e 303a  if smoc == -1.0:
+00016000: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00016010: 2020 2020 2020 2020 2064 6963 745f 7265           dict_re
+00016020: 735f 7363 6f72 6573 5b72 6573 5d20 3d20  s_scores[res] = 
+00016030: 302e 300a 2020 2020 2020 2020 2020 2020  0.0.            
+00016040: 2020 2020 2020 2020 2020 2020 7472 793a              try:
+00016050: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00016060: 2020 2020 2020 2020 2020 2020 2064 6963               dic
+00016070: 745f 7265 735f 7363 6f72 6573 5b72 6573  t_res_scores[res
+00016080: 5d20 3d20 5c0a 2020 2020 2020 2020 2020  ] = \.          
+00016090: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000160a0: 2020 2020 2020 6469 6374 5f72 6573 5f73        dict_res_s
+000160b0: 636f 7265 735b 6469 6374 5f63 6861 696e  cores[dict_chain
+000160c0: 5f72 6573 5b63 685d 5b64 6963 745f 6368  _res[ch][dict_ch
+000160d0: 6169 6e5f 7265 735b 6368 5d2e 696e 6465  ain_res[ch].inde
+000160e0: 7828 7265 7329 2d31 5d5d 2020 2320 6e6f  x(res)-1]]  # no
+000160f0: 7161 3a20 4535 3031 0a20 2020 2020 2020  qa: E501.       
+00016100: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016110: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
+00016120: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016130: 2020 2020 2020 2020 2020 6469 6374 5f72            dict_r
+00016140: 6573 5f73 636f 7265 735b 7265 735d 203d  es_scores[res] =
+00016150: 205c 0a20 2020 2020 2020 2020 2020 2020   \.             
 00016160: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016170: 2020 2020 2020 2020 2020 2020 6469 6374              dict
-00016180: 5f72 6573 5f73 636f 7265 735b 7265 735d  _res_scores[res]
-00016190: 203d 205c 0a20 2020 2020 2020 2020 2020   = \.           
+00016170: 2020 2020 2020 2028 6469 6374 5f72 6573         (dict_res
+00016180: 5f73 636f 7265 735b 7265 735d 202b 0a20  _scores[res] +. 
+00016190: 2020 2020 2020 2020 2020 2020 2020 2020                  
 000161a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000161b0: 2020 2020 2020 2020 2064 6963 745f 7265           dict_re
-000161c0: 735f 7363 6f72 6573 5b64 6963 745f 6368  s_scores[dict_ch
-000161d0: 6169 6e5f 7265 735b 6368 5d5b 6469 6374  ain_res[ch][dict
-000161e0: 5f63 6861 696e 5f72 6573 5b63 685d 2e69  _chain_res[ch].i
-000161f0: 6e64 6578 2872 6573 292b 315d 5d20 2023  ndex(res)+1]]  #
-00016200: 206e 6f71 613a 2045 3530 310a 2020 2020   noqa: E501.    
+000161b0: 2020 2020 2020 2064 6963 745f 7265 735f         dict_res_
+000161c0: 7363 6f72 6573 5b64 6963 745f 6368 6169  scores[dict_chai
+000161d0: 6e5f 7265 735b 6368 5d5b 6469 6374 5f63  n_res[ch][dict_c
+000161e0: 6861 696e 5f72 6573 5b63 685d 2e69 6e64  hain_res[ch].ind
+000161f0: 6578 2872 6573 292b 315d 5d29 2f32 2e30  ex(res)+1]])/2.0
+00016200: 2020 2320 6e6f 7161 3a20 4535 3031 0a20    # noqa: E501. 
 00016210: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016220: 2020 2020 2020 2020 6578 6365 7074 2028          except (
-00016230: 496e 6465 7845 7272 6f72 2c20 4b65 7945  IndexError, KeyE
-00016240: 7272 6f72 293a 0a20 2020 2020 2020 2020  rror):.         
+00016220: 2020 2020 2020 2020 2020 2065 7863 6570             excep
+00016230: 7420 2849 6e64 6578 4572 726f 722c 204b  t (IndexError, K
+00016240: 6579 4572 726f 7229 3a0a 2020 2020 2020  eyError):.      
 00016250: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016260: 2020 2020 2020 2064 6963 745f 7265 735f         dict_res_
-00016270: 7363 6f72 6573 5b72 6573 5d20 3d20 302e  scores[res] = 0.
-00016280: 300a 2020 2020 2020 2020 2020 2020 2020  0.              
-00016290: 2020 2020 2020 2020 2020 636f 6e74 696e            contin
-000162a0: 7565 0a0a 2020 2020 2020 2020 2020 2020  ue..            
-000162b0: 2020 2020 2020 2020 6c69 7374 5f73 6363          list_scc
-000162c0: 632e 6170 7065 6e64 2873 6d6f 6329 0a20  c.append(smoc). 
-000162d0: 2020 2020 2020 2020 2020 2064 6963 745f             dict_
-000162e0: 6368 6169 6e5f 7363 6f72 6573 5b63 685d  chain_scores[ch]
-000162f0: 203d 204f 7264 6572 6564 4469 6374 2829   = OrderedDict()
-00016300: 0a20 2020 2020 2020 2020 2020 2064 6963  .            dic
-00016310: 745f 6368 6169 6e5f 7363 6f72 6573 5b63  t_chain_scores[c
-00016320: 685d 203d 2064 6963 745f 7265 735f 7363  h] = dict_res_sc
-00016330: 6f72 6573 0a20 2020 2020 2020 2064 656c  ores.        del
-00016340: 2067 7269 6474 7265 650a 2020 2020 2020   gridtree.      
-00016350: 2020 6465 6c20 6469 6374 5f63 6861 696e    del dict_chain
-00016360: 5f69 6e64 6963 6573 0a0a 2020 2020 2020  _indices..      
-00016370: 2020 6763 2e63 6f6c 6c65 6374 2829 0a20    gc.collect(). 
-00016380: 2020 2020 2020 2069 6620 6765 745f 636f         if get_co
-00016390: 6f72 643a 0a20 2020 2020 2020 2020 2020  ord:.           
-000163a0: 2072 6574 7572 6e20 6469 6374 5f63 6861   return dict_cha
-000163b0: 696e 5f73 636f 7265 732c 2064 6963 745f  in_scores, dict_
-000163c0: 6368 6169 6e5f 7265 732c 2064 6963 745f  chain_res, dict_
-000163d0: 6368 6169 6e5f 4341 0a20 2020 2020 2020  chain_CA.       
-000163e0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-000163f0: 2020 2064 656c 2064 6963 745f 6368 6169     del dict_chai
-00016400: 6e5f 4341 0a20 2020 2020 2020 2020 2020  n_CA.           
-00016410: 2072 6574 7572 6e20 6469 6374 5f63 6861   return dict_cha
-00016420: 696e 5f73 636f 7265 732c 2064 6963 745f  in_scores, dict_
-00016430: 6368 6169 6e5f 7265 730a 0a20 2020 2064  chain_res..    d
-00016440: 6566 205f 534d 4f43 3128 2020 2320 6361  ef _SMOC1(  # ca
-00016450: 6e20 7765 2064 656c 6574 6520 7468 6973  n we delete this
-00016460: 3f0a 2020 2020 2020 2020 2020 2020 7365  ?.            se
-00016470: 6c66 2c0a 2020 2020 2020 2020 2020 2020  lf,.            
-00016480: 6d61 705f 7461 7267 6574 2c0a 2020 2020  map_target,.    
-00016490: 2020 2020 2020 2020 7265 736f 6c75 7469          resoluti
-000164a0: 6f6e 5f64 656e 734d 6170 2c0a 2020 2020  on_densMap,.    
-000164b0: 2020 2020 2020 2020 7374 7275 6374 7572          structur
-000164c0: 655f 696e 7374 616e 6365 2c0a 2020 2020  e_instance,.    
-000164d0: 2020 2020 2020 2020 7769 6e3d 3131 2c0a          win=11,.
-000164e0: 2020 2020 2020 2020 2020 2020 7269 6769              rigi
-000164f0: 645f 626f 6479 5f66 696c 653d 4e6f 6e65  d_body_file=None
-00016500: 2c0a 2020 2020 2020 2020 2020 2020 7369  ,.            si
-00016510: 676d 615f 6d61 703d 302e 3232 352c 0a20  gma_map=0.225,. 
-00016520: 2020 2020 2020 2020 2020 2077 7269 7465             write
-00016530: 3d46 616c 7365 2c0a 2020 2020 293a 0a20  =False,.    ):. 
-00016540: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
-00016550: 2020 2043 616c 6375 6c61 7465 204c 6f63     Calculate Loc
-00016560: 616c 2063 726f 7373 2063 6f72 7265 6c61  al cross correla
-00016570: 7469 6f6e 2028 4d61 6e64 6572 2773 204f  tion (Mander's O
-00016580: 7665 726c 6170 290a 2020 2020 2020 2020  verlap).        
-00016590: 4974 2069 7320 6120 6c6f 6361 6c20 4f76  It is a local Ov
-000165a0: 6572 6c61 7020 436f 6566 6669 6369 656e  erlap Coefficien
-000165b0: 7420 6361 6c63 756c 6174 6564 206f 6e20  t calculated on 
-000165c0: 6174 6f6d 7320 696e 2073 6c69 6469 6e67  atoms in sliding
-000165d0: 0a20 2020 2020 2020 2072 6573 6964 7565  .        residue
-000165e0: 2077 696e 646f 7773 2061 6c6f 6e67 2074   windows along t
-000165f0: 6865 2063 6861 696e 2e0a 0a20 2020 2020  he chain...     
-00016600: 2020 2041 7267 756d 656e 7473 3a0a 2020     Arguments:.  
-00016610: 2020 2020 2020 2020 2020 2a6d 6170 5f74            *map_t
-00016620: 6172 6765 742a 0a20 2020 2020 2020 2020  arget*.         
-00016630: 2020 2020 2020 2054 6172 6765 7420 4d61         Target Ma
-00016640: 7020 496e 7374 616e 6365 2e0a 2020 2020  p Instance..    
-00016650: 2020 2020 2020 2020 2a72 6573 6f6c 7574          *resolut
-00016660: 696f 6e5f 6465 6e73 4d61 702a 0a20 2020  ion_densMap*.   
-00016670: 2020 2020 2020 2020 2020 2020 2050 6172               Par
-00016680: 616d 6574 6572 206e 6565 6420 666f 7220  ameter need for 
-00016690: 5374 7275 6374 7572 6520 426c 7572 7265  Structure Blurre
-000166a0: 722e 0a20 2020 2020 2020 2020 2020 2020  r..             
-000166b0: 2020 2052 6573 6f6c 7574 696f 6e20 6f66     Resolution of
-000166c0: 2074 6865 2074 6172 6765 7420 6d61 702e   the target map.
-000166d0: 0a20 2020 2020 2020 2020 2020 202a 7374  .            *st
-000166e0: 7275 6374 7572 655f 696e 7374 616e 6365  ructure_instance
-000166f0: 2a0a 2020 2020 2020 2020 2020 2020 2020  *.              
-00016700: 2020 4d6f 6465 6c20 7374 7275 6374 7572    Model structur
-00016710: 6520 696e 7374 616e 6365 2e0a 2020 2020  e instance..    
-00016720: 2020 2020 2020 2020 2a77 696e 2a0a 2020          *win*.  
-00016730: 2020 2020 2020 2020 2020 2020 2020 4f76                Ov
-00016740: 6572 6c61 7070 696e 6720 5769 6e64 6f77  erlapping Window
-00016750: 206c 656e 6774 6820 746f 2063 616c 6375   length to calcu
-00016760: 6c61 7465 2074 6865 2073 636f 7265 0a20  late the score. 
-00016770: 2020 2020 2020 2020 2020 202a 7269 6769             *rigi
-00016780: 645f 626f 6479 5f66 696c 652a 0a20 2020  d_body_file*.   
-00016790: 2020 2020 2020 2020 2020 2020 2052 6967               Rig
-000167a0: 6964 2d62 6f64 7920 6669 6c65 2e0a 2020  id-body file..  
-000167b0: 2020 2020 2020 2020 2020 7369 676d 615f            sigma_
-000167c0: 6d61 703a 2050 6172 616d 6574 6572 206e  map: Parameter n
-000167d0: 6565 6420 666f 7220 5374 7275 6374 7572  eed for Structur
-000167e0: 6520 426c 7572 7265 722e 2046 756c 6c20  e Blurrer. Full 
-000167f0: 6578 706c 616e 6174 696f 6e0a 2020 2020  explanation.    
-00016800: 2020 2020 2020 2020 2020 2020 3a72 6566              :ref
-00016810: 3a60 6865 7265 3c4e 6f74 6520 6f6e 2072  :`here<Note on r
-00016820: 6561 6c20 7370 6163 6520 626c 7572 7269  eal space blurri
-00016830: 6e67 3a3e 600a 2020 2020 2020 2020 5265  ng:>`.        Re
-00016840: 7475 726e 3a0a 2020 2020 2020 2020 2020  turn:.          
-00016850: 2020 4469 6374 696f 6e61 7279 206f 6620    Dictionary of 
-00016860: 736d 6f63 2073 636f 7265 7320 666f 7220  smoc scores for 
-00016870: 7265 7369 6475 6573 2069 6e20 7468 6520  residues in the 
-00016880: 6368 6169 6e0a 2020 2020 2020 2020 2222  chain.        ""
-00016890: 220a 2020 2020 2020 2020 626c 7572 7265  ".        blurre
-000168a0: 7220 3d20 5374 7275 6374 7572 6542 6c75  r = StructureBlu
-000168b0: 7272 6572 2829 0a20 2020 2020 2020 2073  rrer().        s
-000168c0: 696d 5f6d 6170 203d 2062 6c75 7272 6572  im_map = blurrer
-000168d0: 2e67 6175 7373 6961 6e5f 626c 7572 5f72  .gaussian_blur_r
-000168e0: 6561 6c5f 7370 6163 6528 0a20 2020 2020  eal_space(.     
-000168f0: 2020 2020 2020 2073 7472 7563 7475 7265         structure
-00016900: 5f69 6e73 7461 6e63 652c 0a20 2020 2020  _instance,.     
-00016910: 2020 2020 2020 2072 6573 6f6c 7574 696f         resolutio
-00016920: 6e5f 6465 6e73 4d61 702c 0a20 2020 2020  n_densMap,.     
-00016930: 2020 2020 2020 2064 656e 734d 6170 3d6d         densMap=m
-00016940: 6170 5f74 6172 6765 742c 0a20 2020 2020  ap_target,.     
-00016950: 2020 2020 2020 2073 6967 6d61 5f63 6f65         sigma_coe
-00016960: 6666 3d73 6967 6d61 5f6d 6170 2c0a 2020  ff=sigma_map,.  
-00016970: 2020 2020 2020 2020 2020 6e6f 726d 616c            normal
-00016980: 6973 653d 5472 7565 2c0a 2020 2020 2020  ise=True,.      
-00016990: 2020 290a 2020 2020 2020 2020 7065 616b    ).        peak
-000169a0: 2c20 6176 652c 2073 6967 6d61 203d 2073  , ave, sigma = s
-000169b0: 696d 5f6d 6170 2e5f 7065 616b 5f64 656e  im_map._peak_den
-000169c0: 7369 7479 2829 0a20 2020 2020 2020 2023  sity().        #
-000169d0: 204e 4f54 453a 2066 696c 7465 7220 6261   NOTE: filter ba
-000169e0: 636b 6772 6f75 6e64 0a20 2020 2020 2020  ckground.       
-000169f0: 205f 2c20 6469 6374 5f72 6573 5f69 6e64   _, dict_res_ind
-00016a00: 6963 6573 2c20 6469 6374 5f72 6573 5f64  ices, dict_res_d
-00016a10: 6973 7420 3d20 626c 7572 7265 722e 6765  ist = blurrer.ge
-00016a20: 745f 696e 6469 6365 7328 0a20 2020 2020  t_indices(.     
-00016a30: 2020 2020 2020 2073 7472 7563 7475 7265         structure
-00016a40: 5f69 6e73 7461 6e63 652c 0a20 2020 2020  _instance,.     
-00016a50: 2020 2020 2020 206d 6170 5f74 6172 6765         map_targe
-00016a60: 742c 0a20 2020 2020 2020 2020 2020 2072  t,.            r
-00016a70: 6573 6f6c 7574 696f 6e5f 6465 6e73 4d61  esolution_densMa
-00016a80: 700a 2020 2020 2020 2020 290a 2020 2020  p.        ).    
-00016a90: 2020 2020 2320 6765 7420 6465 7461 696c      # get detail
-00016aa0: 7320 6f66 206d 6170 0a20 2020 2020 2020  s of map.       
-00016ab0: 2023 206f 7269 6769 6e20 3d20 6d61 705f   # origin = map_
-00016ac0: 7461 7267 6574 2e6f 7269 6769 6e0a 2020  target.origin.  
-00016ad0: 2020 2020 2020 2320 6170 6978 203d 206d        # apix = m
-00016ae0: 6170 5f74 6172 6765 742e 6170 6978 0a20  ap_target.apix. 
-00016af0: 2020 2020 2020 2023 2062 6f78 5f73 697a         # box_siz
-00016b00: 6520 3d20 6d61 705f 7461 7267 6574 2e62  e = map_target.b
-00016b10: 6f78 5f73 697a 6528 290a 2020 2020 2020  ox_size().      
-00016b20: 2020 6e7a 2c20 6e79 2c20 6e78 203d 206d    nz, ny, nx = m
-00016b30: 6170 5f74 6172 6765 742e 6675 6c6c 4d61  ap_target.fullMa
-00016b40: 702e 7368 6170 650a 2020 2020 2020 2020  p.shape.        
-00016b50: 7a67 2c20 7967 2c20 7867 203d 206e 702e  zg, yg, xg = np.
-00016b60: 6d67 7269 645b 303a 6e7a 2c20 303a 6e79  mgrid[0:nz, 0:ny
-00016b70: 2c20 303a 6e78 5d0a 2020 2020 2020 2020  , 0:nx].        
-00016b80: 696e 6469 203d 207a 6970 2878 672e 7261  indi = zip(xg.ra
-00016b90: 7665 6c28 292c 2079 672e 7261 7665 6c28  vel(), yg.ravel(
-00016ba0: 292c 207a 672e 7261 7665 6c28 2929 0a0a  ), zg.ravel())..
-00016bb0: 2020 2020 2020 2020 2320 7361 7665 2072          # save r
-00016bc0: 6967 6964 2062 6f64 7920 6465 7461 696c  igid body detail
-00016bd0: 730a 2020 2020 2020 2020 6469 6374 5f72  s.        dict_r
-00016be0: 665f 7265 7320 3d20 7b7d 0a20 2020 2020  f_res = {}.     
-00016bf0: 2020 2064 6963 745f 7266 5f73 6320 3d20     dict_rf_sc = 
-00016c00: 7b7d 0a20 2020 2020 2020 2072 6573 5f6c  {}.        res_l
-00016c10: 6973 7420 3d20 5b5d 0a20 2020 2020 2020  ist = [].       
-00016c20: 2072 625f 6c69 7374 203d 205b 5d0a 2020   rb_list = [].  
-00016c30: 2020 2020 2020 6c69 7374 5f73 6363 6320        list_sccc 
-00016c40: 3d20 5b5d 0a20 2020 2020 2020 2023 2073  = [].        # s
-00016c50: 6176 6520 7363 6f72 6573 2066 6f72 2065  ave scores for e
-00016c60: 6163 6820 7265 730a 2020 2020 2020 2020  ach res.        
-00016c70: 6469 6374 5f72 6573 5f73 636f 7265 7320  dict_res_scores 
-00016c80: 3d20 7b7d 0a20 2020 2020 2020 2072 5f63  = {}.        r_c
-00016c90: 7420 3d20 300a 2020 2020 2020 2020 6966  t = 0.        if
-00016ca0: 2072 6967 6964 5f62 6f64 795f 6669 6c65   rigid_body_file
-00016cb0: 2069 7320 6e6f 7420 4e6f 6e65 3a0a 2020   is not None:.  
-00016cc0: 2020 2020 2020 2020 2020 696e 7020 3d20            inp = 
-00016cd0: 6f70 656e 2872 6967 6964 5f62 6f64 795f  open(rigid_body_
-00016ce0: 6669 6c65 2c20 2772 2729 0a20 2020 2020  file, 'r').     
-00016cf0: 2020 2020 2020 2066 6f72 206c 6e20 696e         for ln in
-00016d00: 2069 6e70 3a0a 2020 2020 2020 2020 2020   inp:.          
-00016d10: 2020 2020 2020 6966 206c 6e5b 305d 2021        if ln[0] !
-00016d20: 3d20 2723 273a 0a20 2020 2020 2020 2020  = '#':.         
-00016d30: 2020 2020 2020 2020 2020 2073 636f 7265             score
-00016d40: 5f69 6e64 6963 6573 203d 205b 5d0a 2020  _indices = [].  
-00016d50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016d60: 2020 6c72 6220 3d20 6c6e 2e73 706c 6974    lrb = ln.split
-00016d70: 2829 0a20 2020 2020 2020 2020 2020 2020  ().             
-00016d80: 2020 2020 2020 2069 6620 6c65 6e28 6c72         if len(lr
-00016d90: 6229 203d 3d20 303a 0a20 2020 2020 2020  b) == 0:.       
-00016da0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016db0: 2063 6f6e 7469 6e75 650a 2020 2020 2020   continue.      
-00016dc0: 2020 2020 2020 2020 2020 2020 2020 725f                r_
-00016dd0: 6374 202b 3d20 310a 2020 2020 2020 2020  ct += 1.        
-00016de0: 2020 2020 2020 2020 2020 2020 7265 735f              res_
-00016df0: 6c69 7374 203d 205b 5d0a 2020 2020 2020  list = [].      
-00016e00: 2020 2020 2020 2020 2020 2020 2020 7262                rb
-00016e10: 5f70 6169 7273 203d 205b 5d0a 2020 2020  _pairs = [].    
-00016e20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016e30: 2320 6765 7420 7363 6f72 6573 2066 6f72  # get scores for
-00016e40: 2065 6163 6820 7265 7320 616e 6420 6561   each res and ea
-00016e50: 6368 2072 6967 6964 2062 6f64 790a 2020  ch rigid body.  
-00016e60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016e70: 2020 666f 7220 6920 696e 2072 616e 6765    for i in range
-00016e80: 286d 6178 2828 6c65 6e28 6c72 6229 202f  (max((len(lrb) /
-00016e90: 2032 2920 2d20 312c 2031 2929 3a0a 2020   2) - 1, 1)):.  
-00016ea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016eb0: 2020 2020 2020 7262 5f70 6169 7273 2e61        rb_pairs.a
-00016ec0: 7070 656e 6428 5b69 6e74 286c 7262 5b32  ppend([int(lrb[2
-00016ed0: 202a 2069 5d29 2c20 696e 7428 6c72 625b   * i]), int(lrb[
-00016ee0: 3220 2a20 6920 2b20 315d 295d 290a 2020  2 * i + 1])]).  
-00016ef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016f00: 2020 2020 2020 2320 4e4f 5445 3a20 776f        # NOTE: wo
-00016f10: 6e74 2077 6f72 6b20 666f 7220 696e 7365  nt work for inse
-00016f20: 7274 696f 6e20 636f 6465 730a 2020 2020  rtion codes.    
-00016f30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016f40: 2020 2020 666f 7220 7220 696e 2072 616e      for r in ran
-00016f50: 6765 2869 6e74 286c 7262 5b32 202a 2069  ge(int(lrb[2 * i
-00016f60: 5d29 2c20 696e 7428 6c72 625b 322a 6920  ]), int(lrb[2*i 
-00016f70: 2b20 315d 2920 2b20 3129 3a0a 2020 2020  + 1]) + 1):.    
-00016f80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016f90: 2020 2020 2020 2020 7363 6f72 655f 696e          score_in
-00016fa0: 6469 6365 732e 6578 7465 6e64 2864 6963  dices.extend(dic
-00016fb0: 745f 7265 735f 696e 6469 6365 735b 725d  t_res_indices[r]
-00016fc0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00016fd0: 2020 2020 2020 2020 2020 2020 2020 7265                re
-00016fe0: 735f 6c69 7374 2e61 7070 656e 6428 7229  s_list.append(r)
-00016ff0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00017000: 2020 2020 2072 625f 6c69 7374 2e61 7070       rb_list.app
-00017010: 656e 6428 6c72 6229 0a20 2020 2020 2020  end(lrb).       
-00017020: 2020 2020 2020 2020 2020 2020 2064 6963               dic
-00017030: 745f 7266 5f72 6573 5b72 5f63 745d 203d  t_rf_res[r_ct] =
-00017040: 2072 625f 7061 6972 730a 2020 2020 2020   rb_pairs.      
-00017050: 2020 2020 2020 2020 2020 2020 2020 6966                if
-00017060: 206c 656e 2873 636f 7265 5f69 6e64 6963   len(score_indic
-00017070: 6573 2920 3d3d 2030 3a0a 2020 2020 2020  es) == 0:.      
-00017080: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017090: 2020 6469 6374 5f72 665f 7363 5b72 5f63    dict_rf_sc[r_c
-000170a0: 745d 203d 2030 2e30 0a20 2020 2020 2020  t] = 0.0.       
-000170b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000170c0: 2066 6f72 2072 6573 2069 6e20 7265 735f   for res in res_
-000170d0: 6c69 7374 3a0a 2020 2020 2020 2020 2020  list:.          
-000170e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000170f0: 2020 6469 6374 5f72 6573 5f73 636f 7265    dict_res_score
-00017100: 735b 7265 735d 203d 2030 2e30 0a20 2020  s[res] = 0.0.   
-00017110: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017120: 2020 2020 2063 6f6e 7469 6e75 650a 0a20       continue.. 
+00016260: 2020 2020 2020 2020 2020 7061 7373 0a20            pass. 
+00016270: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016280: 2020 2020 2020 2065 7863 6570 7420 2849         except (I
+00016290: 6e64 6578 4572 726f 722c 204b 6579 4572  ndexError, KeyEr
+000162a0: 726f 7229 3a0a 2020 2020 2020 2020 2020  ror):.          
+000162b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000162c0: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
+000162d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000162e0: 2020 2020 2020 2064 6963 745f 7265 735f         dict_res_
+000162f0: 7363 6f72 6573 5b72 6573 5d20 3d20 5c0a  scores[res] = \.
+00016300: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016310: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016320: 2020 2020 6469 6374 5f72 6573 5f73 636f      dict_res_sco
+00016330: 7265 735b 6469 6374 5f63 6861 696e 5f72  res[dict_chain_r
+00016340: 6573 5b63 685d 5b64 6963 745f 6368 6169  es[ch][dict_chai
+00016350: 6e5f 7265 735b 6368 5d2e 696e 6465 7828  n_res[ch].index(
+00016360: 7265 7329 2b31 5d5d 2020 2320 6e6f 7161  res)+1]]  # noqa
+00016370: 3a20 4535 3031 0a20 2020 2020 2020 2020  : E501.         
+00016380: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016390: 2020 2065 7863 6570 7420 2849 6e64 6578     except (Index
+000163a0: 4572 726f 722c 204b 6579 4572 726f 7229  Error, KeyError)
+000163b0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+000163c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000163d0: 2020 6469 6374 5f72 6573 5f73 636f 7265    dict_res_score
+000163e0: 735b 7265 735d 203d 2030 2e30 0a20 2020  s[res] = 0.0.   
+000163f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016400: 2020 2020 2063 6f6e 7469 6e75 650a 0a20       continue.. 
+00016410: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016420: 2020 206c 6973 745f 7363 6363 2e61 7070     list_sccc.app
+00016430: 656e 6428 736d 6f63 290a 2020 2020 2020  end(smoc).      
+00016440: 2020 2020 2020 6469 6374 5f63 6861 696e        dict_chain
+00016450: 5f73 636f 7265 735b 6368 5d20 3d20 4f72  _scores[ch] = Or
+00016460: 6465 7265 6444 6963 7428 290a 2020 2020  deredDict().    
+00016470: 2020 2020 2020 2020 6469 6374 5f63 6861          dict_cha
+00016480: 696e 5f73 636f 7265 735b 6368 5d20 3d20  in_scores[ch] = 
+00016490: 6469 6374 5f72 6573 5f73 636f 7265 730a  dict_res_scores.
+000164a0: 2020 2020 2020 2020 6465 6c20 6772 6964          del grid
+000164b0: 7472 6565 0a20 2020 2020 2020 2064 656c  tree.        del
+000164c0: 2064 6963 745f 6368 6169 6e5f 696e 6469   dict_chain_indi
+000164d0: 6365 730a 0a20 2020 2020 2020 2067 632e  ces..        gc.
+000164e0: 636f 6c6c 6563 7428 290a 2020 2020 2020  collect().      
+000164f0: 2020 6966 2067 6574 5f63 6f6f 7264 3a0a    if get_coord:.
+00016500: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+00016510: 726e 2064 6963 745f 6368 6169 6e5f 7363  rn dict_chain_sc
+00016520: 6f72 6573 2c20 6469 6374 5f63 6861 696e  ores, dict_chain
+00016530: 5f72 6573 2c20 6469 6374 5f63 6861 696e  _res, dict_chain
+00016540: 5f43 410a 2020 2020 2020 2020 656c 7365  _CA.        else
+00016550: 3a0a 2020 2020 2020 2020 2020 2020 6465  :.            de
+00016560: 6c20 6469 6374 5f63 6861 696e 5f43 410a  l dict_chain_CA.
+00016570: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+00016580: 726e 2064 6963 745f 6368 6169 6e5f 7363  rn dict_chain_sc
+00016590: 6f72 6573 2c20 6469 6374 5f63 6861 696e  ores, dict_chain
+000165a0: 5f72 6573 0a0a 2020 2020 6465 6620 5f53  _res..    def _S
+000165b0: 4d4f 4331 2820 2023 2063 616e 2077 6520  MOC1(  # can we 
+000165c0: 6465 6c65 7465 2074 6869 733f 0a20 2020  delete this?.   
+000165d0: 2020 2020 2020 2020 2073 656c 662c 0a20           self,. 
+000165e0: 2020 2020 2020 2020 2020 206d 6170 5f74             map_t
+000165f0: 6172 6765 742c 0a20 2020 2020 2020 2020  arget,.         
+00016600: 2020 2072 6573 6f6c 7574 696f 6e5f 6465     resolution_de
+00016610: 6e73 4d61 702c 0a20 2020 2020 2020 2020  nsMap,.         
+00016620: 2020 2073 7472 7563 7475 7265 5f69 6e73     structure_ins
+00016630: 7461 6e63 652c 0a20 2020 2020 2020 2020  tance,.         
+00016640: 2020 2077 696e 3d31 312c 0a20 2020 2020     win=11,.     
+00016650: 2020 2020 2020 2072 6967 6964 5f62 6f64         rigid_bod
+00016660: 795f 6669 6c65 3d4e 6f6e 652c 0a20 2020  y_file=None,.   
+00016670: 2020 2020 2020 2020 2073 6967 6d61 5f6d           sigma_m
+00016680: 6170 3d30 2e32 3235 2c0a 2020 2020 2020  ap=0.225,.      
+00016690: 2020 2020 2020 7772 6974 653d 4661 6c73        write=Fals
+000166a0: 652c 0a20 2020 2029 3a0a 2020 2020 2020  e,.    ):.      
+000166b0: 2020 2222 220a 2020 2020 2020 2020 4361    """.        Ca
+000166c0: 6c63 756c 6174 6520 4c6f 6361 6c20 6372  lculate Local cr
+000166d0: 6f73 7320 636f 7272 656c 6174 696f 6e20  oss correlation 
+000166e0: 284d 616e 6465 7227 7320 4f76 6572 6c61  (Mander's Overla
+000166f0: 7029 0a20 2020 2020 2020 2049 7420 6973  p).        It is
+00016700: 2061 206c 6f63 616c 204f 7665 726c 6170   a local Overlap
+00016710: 2043 6f65 6666 6963 6965 6e74 2063 616c   Coefficient cal
+00016720: 6375 6c61 7465 6420 6f6e 2061 746f 6d73  culated on atoms
+00016730: 2069 6e20 736c 6964 696e 670a 2020 2020   in sliding.    
+00016740: 2020 2020 7265 7369 6475 6520 7769 6e64      residue wind
+00016750: 6f77 7320 616c 6f6e 6720 7468 6520 6368  ows along the ch
+00016760: 6169 6e2e 0a0a 2020 2020 2020 2020 4172  ain...        Ar
+00016770: 6775 6d65 6e74 733a 0a20 2020 2020 2020  guments:.       
+00016780: 2020 2020 202a 6d61 705f 7461 7267 6574       *map_target
+00016790: 2a0a 2020 2020 2020 2020 2020 2020 2020  *.              
+000167a0: 2020 5461 7267 6574 204d 6170 2049 6e73    Target Map Ins
+000167b0: 7461 6e63 652e 0a20 2020 2020 2020 2020  tance..         
+000167c0: 2020 202a 7265 736f 6c75 7469 6f6e 5f64     *resolution_d
+000167d0: 656e 734d 6170 2a0a 2020 2020 2020 2020  ensMap*.        
+000167e0: 2020 2020 2020 2020 5061 7261 6d65 7465          Paramete
+000167f0: 7220 6e65 6564 2066 6f72 2053 7472 7563  r need for Struc
+00016800: 7475 7265 2042 6c75 7272 6572 2e0a 2020  ture Blurrer..  
+00016810: 2020 2020 2020 2020 2020 2020 2020 5265                Re
+00016820: 736f 6c75 7469 6f6e 206f 6620 7468 6520  solution of the 
+00016830: 7461 7267 6574 206d 6170 2e0a 2020 2020  target map..    
+00016840: 2020 2020 2020 2020 2a73 7472 7563 7475          *structu
+00016850: 7265 5f69 6e73 7461 6e63 652a 0a20 2020  re_instance*.   
+00016860: 2020 2020 2020 2020 2020 2020 204d 6f64               Mod
+00016870: 656c 2073 7472 7563 7475 7265 2069 6e73  el structure ins
+00016880: 7461 6e63 652e 0a20 2020 2020 2020 2020  tance..         
+00016890: 2020 202a 7769 6e2a 0a20 2020 2020 2020     *win*.       
+000168a0: 2020 2020 2020 2020 204f 7665 726c 6170           Overlap
+000168b0: 7069 6e67 2057 696e 646f 7720 6c65 6e67  ping Window leng
+000168c0: 7468 2074 6f20 6361 6c63 756c 6174 6520  th to calculate 
+000168d0: 7468 6520 7363 6f72 650a 2020 2020 2020  the score.      
+000168e0: 2020 2020 2020 2a72 6967 6964 5f62 6f64        *rigid_bod
+000168f0: 795f 6669 6c65 2a0a 2020 2020 2020 2020  y_file*.        
+00016900: 2020 2020 2020 2020 5269 6769 642d 626f          Rigid-bo
+00016910: 6479 2066 696c 652e 0a20 2020 2020 2020  dy file..       
+00016920: 2020 2020 2073 6967 6d61 5f6d 6170 3a20       sigma_map: 
+00016930: 5061 7261 6d65 7465 7220 6e65 6564 2066  Parameter need f
+00016940: 6f72 2053 7472 7563 7475 7265 2042 6c75  or Structure Blu
+00016950: 7272 6572 2e20 4675 6c6c 2065 7870 6c61  rrer. Full expla
+00016960: 6e61 7469 6f6e 0a20 2020 2020 2020 2020  nation.         
+00016970: 2020 2020 2020 203a 7265 663a 6068 6572         :ref:`her
+00016980: 653c 4e6f 7465 206f 6e20 7265 616c 2073  e<Note on real s
+00016990: 7061 6365 2062 6c75 7272 696e 673a 3e60  pace blurring:>`
+000169a0: 0a20 2020 2020 2020 2052 6574 7572 6e3a  .        Return:
+000169b0: 0a20 2020 2020 2020 2020 2020 2044 6963  .            Dic
+000169c0: 7469 6f6e 6172 7920 6f66 2073 6d6f 6320  tionary of smoc 
+000169d0: 7363 6f72 6573 2066 6f72 2072 6573 6964  scores for resid
+000169e0: 7565 7320 696e 2074 6865 2063 6861 696e  ues in the chain
+000169f0: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
+00016a00: 2020 2020 2062 6c75 7272 6572 203d 2053       blurrer = S
+00016a10: 7472 7563 7475 7265 426c 7572 7265 7228  tructureBlurrer(
+00016a20: 290a 2020 2020 2020 2020 7369 6d5f 6d61  ).        sim_ma
+00016a30: 7020 3d20 626c 7572 7265 722e 6761 7573  p = blurrer.gaus
+00016a40: 7369 616e 5f62 6c75 725f 7265 616c 5f73  sian_blur_real_s
+00016a50: 7061 6365 280a 2020 2020 2020 2020 2020  pace(.          
+00016a60: 2020 7374 7275 6374 7572 655f 696e 7374    structure_inst
+00016a70: 616e 6365 2c0a 2020 2020 2020 2020 2020  ance,.          
+00016a80: 2020 7265 736f 6c75 7469 6f6e 5f64 656e    resolution_den
+00016a90: 734d 6170 2c0a 2020 2020 2020 2020 2020  sMap,.          
+00016aa0: 2020 6465 6e73 4d61 703d 6d61 705f 7461    densMap=map_ta
+00016ab0: 7267 6574 2c0a 2020 2020 2020 2020 2020  rget,.          
+00016ac0: 2020 7369 676d 615f 636f 6566 663d 7369    sigma_coeff=si
+00016ad0: 676d 615f 6d61 702c 0a20 2020 2020 2020  gma_map,.       
+00016ae0: 2020 2020 206e 6f72 6d61 6c69 7365 3d54       normalise=T
+00016af0: 7275 652c 0a20 2020 2020 2020 2029 0a20  rue,.        ). 
+00016b00: 2020 2020 2020 2070 6561 6b2c 2061 7665         peak, ave
+00016b10: 2c20 7369 676d 6120 3d20 7369 6d5f 6d61  , sigma = sim_ma
+00016b20: 702e 5f70 6561 6b5f 6465 6e73 6974 7928  p._peak_density(
+00016b30: 290a 2020 2020 2020 2020 2320 4e4f 5445  ).        # NOTE
+00016b40: 3a20 6669 6c74 6572 2062 6163 6b67 726f  : filter backgro
+00016b50: 756e 640a 2020 2020 2020 2020 5f2c 2064  und.        _, d
+00016b60: 6963 745f 7265 735f 696e 6469 6365 732c  ict_res_indices,
+00016b70: 2064 6963 745f 7265 735f 6469 7374 203d   dict_res_dist =
+00016b80: 2062 6c75 7272 6572 2e67 6574 5f69 6e64   blurrer.get_ind
+00016b90: 6963 6573 280a 2020 2020 2020 2020 2020  ices(.          
+00016ba0: 2020 7374 7275 6374 7572 655f 696e 7374    structure_inst
+00016bb0: 616e 6365 2c0a 2020 2020 2020 2020 2020  ance,.          
+00016bc0: 2020 6d61 705f 7461 7267 6574 2c0a 2020    map_target,.  
+00016bd0: 2020 2020 2020 2020 2020 7265 736f 6c75            resolu
+00016be0: 7469 6f6e 5f64 656e 734d 6170 0a20 2020  tion_densMap.   
+00016bf0: 2020 2020 2029 0a20 2020 2020 2020 2023       ).        #
+00016c00: 2067 6574 2064 6574 6169 6c73 206f 6620   get details of 
+00016c10: 6d61 700a 2020 2020 2020 2020 2320 6f72  map.        # or
+00016c20: 6967 696e 203d 206d 6170 5f74 6172 6765  igin = map_targe
+00016c30: 742e 6f72 6967 696e 0a20 2020 2020 2020  t.origin.       
+00016c40: 2023 2061 7069 7820 3d20 6d61 705f 7461   # apix = map_ta
+00016c50: 7267 6574 2e61 7069 780a 2020 2020 2020  rget.apix.      
+00016c60: 2020 2320 626f 785f 7369 7a65 203d 206d    # box_size = m
+00016c70: 6170 5f74 6172 6765 742e 626f 785f 7369  ap_target.box_si
+00016c80: 7a65 2829 0a20 2020 2020 2020 206e 7a2c  ze().        nz,
+00016c90: 206e 792c 206e 7820 3d20 6d61 705f 7461   ny, nx = map_ta
+00016ca0: 7267 6574 2e66 756c 6c4d 6170 2e73 6861  rget.fullMap.sha
+00016cb0: 7065 0a20 2020 2020 2020 207a 672c 2079  pe.        zg, y
+00016cc0: 672c 2078 6720 3d20 6e70 2e6d 6772 6964  g, xg = np.mgrid
+00016cd0: 5b30 3a6e 7a2c 2030 3a6e 792c 2030 3a6e  [0:nz, 0:ny, 0:n
+00016ce0: 785d 0a20 2020 2020 2020 2069 6e64 6920  x].        indi 
+00016cf0: 3d20 7a69 7028 7867 2e72 6176 656c 2829  = zip(xg.ravel()
+00016d00: 2c20 7967 2e72 6176 656c 2829 2c20 7a67  , yg.ravel(), zg
+00016d10: 2e72 6176 656c 2829 290a 0a20 2020 2020  .ravel())..     
+00016d20: 2020 2023 2073 6176 6520 7269 6769 6420     # save rigid 
+00016d30: 626f 6479 2064 6574 6169 6c73 0a20 2020  body details.   
+00016d40: 2020 2020 2064 6963 745f 7266 5f72 6573       dict_rf_res
+00016d50: 203d 207b 7d0a 2020 2020 2020 2020 6469   = {}.        di
+00016d60: 6374 5f72 665f 7363 203d 207b 7d0a 2020  ct_rf_sc = {}.  
+00016d70: 2020 2020 2020 7265 735f 6c69 7374 203d        res_list =
+00016d80: 205b 5d0a 2020 2020 2020 2020 7262 5f6c   [].        rb_l
+00016d90: 6973 7420 3d20 5b5d 0a20 2020 2020 2020  ist = [].       
+00016da0: 206c 6973 745f 7363 6363 203d 205b 5d0a   list_sccc = [].
+00016db0: 2020 2020 2020 2020 2320 7361 7665 2073          # save s
+00016dc0: 636f 7265 7320 666f 7220 6561 6368 2072  cores for each r
+00016dd0: 6573 0a20 2020 2020 2020 2064 6963 745f  es.        dict_
+00016de0: 7265 735f 7363 6f72 6573 203d 207b 7d0a  res_scores = {}.
+00016df0: 2020 2020 2020 2020 725f 6374 203d 2030          r_ct = 0
+00016e00: 0a20 2020 2020 2020 2069 6620 7269 6769  .        if rigi
+00016e10: 645f 626f 6479 5f66 696c 6520 6973 206e  d_body_file is n
+00016e20: 6f74 204e 6f6e 653a 0a20 2020 2020 2020  ot None:.       
+00016e30: 2020 2020 2069 6e70 203d 206f 7065 6e28       inp = open(
+00016e40: 7269 6769 645f 626f 6479 5f66 696c 652c  rigid_body_file,
+00016e50: 2027 7227 290a 2020 2020 2020 2020 2020   'r').          
+00016e60: 2020 666f 7220 6c6e 2069 6e20 696e 703a    for ln in inp:
+00016e70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00016e80: 2069 6620 6c6e 5b30 5d20 213d 2027 2327   if ln[0] != '#'
+00016e90: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00016ea0: 2020 2020 2020 7363 6f72 655f 696e 6469        score_indi
+00016eb0: 6365 7320 3d20 5b5d 0a20 2020 2020 2020  ces = [].       
+00016ec0: 2020 2020 2020 2020 2020 2020 206c 7262               lrb
+00016ed0: 203d 206c 6e2e 7370 6c69 7428 290a 2020   = ln.split().  
+00016ee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016ef0: 2020 6966 206c 656e 286c 7262 2920 3d3d    if len(lrb) ==
+00016f00: 2030 3a0a 2020 2020 2020 2020 2020 2020   0:.            
+00016f10: 2020 2020 2020 2020 2020 2020 636f 6e74              cont
+00016f20: 696e 7565 0a20 2020 2020 2020 2020 2020  inue.           
+00016f30: 2020 2020 2020 2020 2072 5f63 7420 2b3d           r_ct +=
+00016f40: 2031 0a20 2020 2020 2020 2020 2020 2020   1.             
+00016f50: 2020 2020 2020 2072 6573 5f6c 6973 7420         res_list 
+00016f60: 3d20 5b5d 0a20 2020 2020 2020 2020 2020  = [].           
+00016f70: 2020 2020 2020 2020 2072 625f 7061 6972           rb_pair
+00016f80: 7320 3d20 5b5d 0a20 2020 2020 2020 2020  s = [].         
+00016f90: 2020 2020 2020 2020 2020 2023 2067 6574             # get
+00016fa0: 2073 636f 7265 7320 666f 7220 6561 6368   scores for each
+00016fb0: 2072 6573 2061 6e64 2065 6163 6820 7269   res and each ri
+00016fc0: 6769 6420 626f 6479 0a20 2020 2020 2020  gid body.       
+00016fd0: 2020 2020 2020 2020 2020 2020 2066 6f72               for
+00016fe0: 2069 2069 6e20 7261 6e67 6528 6d61 7828   i in range(max(
+00016ff0: 286c 656e 286c 7262 2920 2f20 3229 202d  (len(lrb) / 2) -
+00017000: 2031 2c20 3129 293a 0a20 2020 2020 2020   1, 1)):.       
+00017010: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017020: 2072 625f 7061 6972 732e 6170 7065 6e64   rb_pairs.append
+00017030: 285b 696e 7428 6c72 625b 3220 2a20 695d  ([int(lrb[2 * i]
+00017040: 292c 2069 6e74 286c 7262 5b32 202a 2069  ), int(lrb[2 * i
+00017050: 202b 2031 5d29 5d29 0a20 2020 2020 2020   + 1])]).       
+00017060: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017070: 2023 204e 4f54 453a 2077 6f6e 7420 776f   # NOTE: wont wo
+00017080: 726b 2066 6f72 2069 6e73 6572 7469 6f6e  rk for insertion
+00017090: 2063 6f64 6573 0a20 2020 2020 2020 2020   codes.         
+000170a0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+000170b0: 6f72 2072 2069 6e20 7261 6e67 6528 696e  or r in range(in
+000170c0: 7428 6c72 625b 3220 2a20 695d 292c 2069  t(lrb[2 * i]), i
+000170d0: 6e74 286c 7262 5b32 2a69 202b 2031 5d29  nt(lrb[2*i + 1])
+000170e0: 202b 2031 293a 0a20 2020 2020 2020 2020   + 1):.         
+000170f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017100: 2020 2073 636f 7265 5f69 6e64 6963 6573     score_indices
+00017110: 2e65 7874 656e 6428 6469 6374 5f72 6573  .extend(dict_res
+00017120: 5f69 6e64 6963 6573 5b72 5d29 0a20 2020  _indices[r]).   
 00017130: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017140: 2020 2074 6d70 6c69 7374 203d 2073 636f     tmplist = sco
-00017150: 7265 5f69 6e64 6963 6573 5b3a 5d0a 2020  re_indices[:].  
+00017140: 2020 2020 2020 2020 2072 6573 5f6c 6973           res_lis
+00017150: 742e 6170 7065 6e64 2872 290a 2020 2020  t.append(r).    
 00017160: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017170: 2020 7365 746c 6973 7420 3d20 7365 7428    setlist = set(
-00017180: 746d 706c 6973 7429 0a20 2020 2020 2020  tmplist).       
-00017190: 2020 2020 2020 2020 2020 2020 2073 636f               sco
-000171a0: 7265 5f69 6e64 6963 6573 203d 206c 6973  re_indices = lis
-000171b0: 7428 7365 746c 6973 7429 0a20 2020 2020  t(setlist).     
-000171c0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-000171d0: 635f 696e 6469 6365 7320 3d20 5b5d 0a20  c_indices = []. 
-000171e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000171f0: 2020 2066 6f72 2069 6920 696e 2073 636f     for ii in sco
-00017200: 7265 5f69 6e64 6963 6573 3a0a 2020 2020  re_indices:.    
-00017210: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017220: 2020 2020 7363 5f69 6e64 6963 6573 2e61      sc_indices.a
-00017230: 7070 656e 6428 696e 6469 5b69 695d 290a  ppend(indi[ii]).
-00017240: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017250: 2020 2020 6172 7261 795f 696e 6469 6365      array_indice
-00017260: 7320 3d20 6e70 2e61 7272 6179 2873 635f  s = np.array(sc_
-00017270: 696e 6469 6365 7329 0a20 2020 2020 2020  indices).       
-00017280: 2020 2020 2020 2020 2020 2020 2069 6e64               ind
-00017290: 5f61 7272 7879 7a20 3d20 6e70 2e74 7261  _arrxyz = np.tra
-000172a0: 6e73 706f 7365 2861 7272 6179 5f69 6e64  nspose(array_ind
-000172b0: 6963 6573 290a 0a20 2020 2020 2020 2020  ices)..         
-000172c0: 2020 2020 2020 2020 2020 2069 6e64 5f61             ind_a
-000172d0: 7272 7a79 7820 3d20 2869 6e64 5f61 7272  rrzyx = (ind_arr
-000172e0: 7879 7a5b 325d 2c20 696e 645f 6172 7278  xyz[2], ind_arrx
-000172f0: 797a 5b31 5d2c 2069 6e64 5f61 7272 7879  yz[1], ind_arrxy
-00017300: 7a5b 305d 290a 2020 2020 2020 2020 2020  z[0]).          
-00017310: 2020 2020 2020 2020 2020 7363 6363 203d            sccc =
-00017320: 2073 656c 662e 6361 6c63 5f6d 6f63 2869   self.calc_moc(i
-00017330: 6e64 5f61 7272 7a79 782c 2073 696d 5f6d  nd_arrzyx, sim_m
-00017340: 6170 2c20 6d61 705f 7461 7267 6574 290a  ap, map_target).
-00017350: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017360: 2020 2020 6469 6374 5f72 665f 7363 5b72      dict_rf_sc[r
-00017370: 5f63 745d 203d 2073 6363 630a 2020 2020  _ct] = sccc.    
-00017380: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017390: 2320 7361 7665 2073 636f 7265 730a 2020  # save scores.  
-000173a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000173b0: 2020 666f 7220 7265 7320 696e 2072 6573    for res in res
-000173c0: 5f6c 6973 743a 0a20 2020 2020 2020 2020  _list:.         
-000173d0: 2020 2020 2020 2020 2020 2020 2020 2064                 d
-000173e0: 6963 745f 7265 735f 7363 6f72 6573 5b72  ict_res_scores[r
-000173f0: 6573 5d20 3d20 7363 6363 0a20 2020 2020  es] = sccc.     
-00017400: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017410: 2020 206c 6973 745f 7363 6363 2e61 7070     list_sccc.app
-00017420: 656e 6428 7363 6363 290a 2020 2020 2020  end(sccc).      
-00017430: 2020 2020 2020 696e 702e 636c 6f73 6528        inp.close(
-00017440: 290a 2020 2020 2020 2020 2320 666f 7220  ).        # for 
-00017450: 7265 7369 6475 6573 206e 6f74 2069 6e20  residues not in 
-00017460: 7269 6769 6420 626f 6469 6573 3a20 636f  rigid bodies: co
-00017470: 6e73 6964 6572 2070 656e 7461 7065 7074  nsider pentapept
-00017480: 6964 6573 0a20 2020 2020 2020 2066 6f72  ides.        for
-00017490: 2072 6573 2069 6e20 6469 6374 5f72 6573   res in dict_res
-000174a0: 5f69 6e64 6963 6573 3a0a 2020 2020 2020  _indices:.      
-000174b0: 2020 2020 2020 6966 2072 6573 2069 6e20        if res in 
-000174c0: 6469 6374 5f72 6573 5f73 636f 7265 733a  dict_res_scores:
-000174d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000174e0: 2069 6e64 6963 6573 203d 2064 6963 745f   indices = dict_
-000174f0: 7265 735f 696e 6469 6365 735b 7265 735d  res_indices[res]
-00017500: 5b3a 5d0a 2020 2020 2020 2020 2020 2020  [:].            
-00017510: 2020 2020 2320 636f 6e73 6964 6572 2072      # consider r
-00017520: 6573 6964 7565 7320 6f6e 2062 6f74 6820  esidues on both 
-00017530: 7369 6465 732e 204e 4f54 453a 2077 6f6e  sides. NOTE: won
-00017540: 7420 776f 726b 2066 6f72 0a20 2020 2020  t work for.     
-00017550: 2020 2020 2020 2020 2020 2023 2069 6e73             # ins
-00017560: 6572 7469 6f6e 2063 6f64 6573 210a 2020  ertion codes!.  
-00017570: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-00017580: 6e65 6564 2074 6f20 7265 7769 7465 2072  need to rewite r
-00017590: 6573 206e 756d 6265 7273 2074 6f20 6176  es numbers to av
-000175a0: 6f69 6420 696e 7365 7274 696f 6e20 636f  oid insertion co
-000175b0: 6465 730a 2020 2020 2020 2020 2020 2020  des.            
-000175c0: 2020 2020 666f 7220 6969 2069 6e20 7261      for ii in ra
-000175d0: 6e67 6528 312c 2069 6e74 2872 6f75 6e64  nge(1, int(round
-000175e0: 2828 7769 6e20 2b20 3129 202f 2032 2929  ((win + 1) / 2))
-000175f0: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-00017600: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
-00017610: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017620: 2020 2020 696e 6469 6365 732e 6578 7465      indices.exte
-00017630: 6e64 2864 6963 745f 7265 735f 696e 6469  nd(dict_res_indi
-00017640: 6365 735b 7265 7320 2d20 6969 5d29 0a20  ces[res - ii]). 
-00017650: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017660: 2020 2065 7863 6570 7420 4578 6365 7074     except Except
-00017670: 696f 6e3a 0a20 2020 2020 2020 2020 2020  ion:.           
-00017680: 2020 2020 2020 2020 2020 2020 2070 6173               pas
-00017690: 730a 2020 2020 2020 2020 2020 2020 2020  s.              
-000176a0: 2020 666f 7220 6969 2069 6e20 7261 6e67    for ii in rang
-000176b0: 6528 312c 2069 6e74 2872 6f75 6e64 2828  e(1, int(round((
-000176c0: 7769 6e20 2b20 3129 202f 2032 2929 293a  win + 1) / 2))):
-000176d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000176e0: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
-000176f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017700: 2020 696e 6469 6365 732e 6578 7465 6e64    indices.extend
-00017710: 2864 6963 745f 7265 735f 696e 6469 6365  (dict_res_indice
-00017720: 735b 7265 7320 2b20 6969 5d29 0a20 2020  s[res + ii]).   
-00017730: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017740: 2065 7863 6570 7420 4578 6365 7074 696f   except Exceptio
-00017750: 6e3a 0a20 2020 2020 2020 2020 2020 2020  n:.             
-00017760: 2020 2020 2020 2020 2020 2070 6173 730a             pass.
-00017770: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00017780: 2074 6d70 6c69 7374 203d 2069 6e64 6963   tmplist = indic
-00017790: 6573 5b3a 5d0a 2020 2020 2020 2020 2020  es[:].          
-000177a0: 2020 2020 2020 7365 746c 6973 7420 3d20        setlist = 
-000177b0: 7365 7428 746d 706c 6973 7429 0a20 2020  set(tmplist).   
-000177c0: 2020 2020 2020 2020 2020 2020 2069 6e64               ind
-000177d0: 6963 6573 203d 206c 6973 7428 7365 746c  ices = list(setl
-000177e0: 6973 7429 0a20 2020 2020 2020 2020 2020  ist).           
-000177f0: 2020 2020 2073 635f 696e 6469 6365 7320       sc_indices 
-00017800: 3d20 5b5d 0a20 2020 2020 2020 2020 2020  = [].           
-00017810: 2020 2020 2066 6f72 2069 6920 696e 2069       for ii in i
-00017820: 6e64 6963 6573 3a0a 2020 2020 2020 2020  ndices:.        
-00017830: 2020 2020 2020 2020 2020 2020 7363 5f69              sc_i
-00017840: 6e64 6963 6573 2e61 7070 656e 6428 696e  ndices.append(in
-00017850: 6469 5b69 695d 290a 2020 2020 2020 2020  di[ii]).        
-00017860: 2020 2020 2020 2020 6966 206c 656e 2869          if len(i
-00017870: 6e64 6963 6573 2920 3d3d 2030 3a0a 2020  ndices) == 0:.  
-00017880: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017890: 2020 6469 6374 5f72 6573 5f73 636f 7265    dict_res_score
-000178a0: 735b 7265 735d 203d 2030 2e30 0a20 2020  s[res] = 0.0.   
-000178b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000178c0: 2063 6f6e 7469 6e75 650a 2020 2020 2020   continue.      
-000178d0: 2020 2020 2020 2020 2020 6172 7261 795f            array_
-000178e0: 696e 6469 6365 7320 3d20 6e70 2e61 7272  indices = np.arr
-000178f0: 6179 2873 635f 696e 6469 6365 7329 0a20  ay(sc_indices). 
-00017900: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00017910: 6e64 5f61 7272 7879 7a20 3d20 6e70 2e74  nd_arrxyz = np.t
-00017920: 7261 6e73 706f 7365 2861 7272 6179 5f69  ranspose(array_i
-00017930: 6e64 6963 6573 290a 2020 2020 2020 2020  ndices).        
-00017940: 2020 2020 2020 2020 696e 645f 6172 727a          ind_arrz
-00017950: 7978 203d 2028 696e 645f 6172 7278 797a  yx = (ind_arrxyz
-00017960: 5b32 5d2c 2069 6e64 5f61 7272 7879 7a5b  [2], ind_arrxyz[
-00017970: 315d 2c20 696e 645f 6172 7278 797a 5b30  1], ind_arrxyz[0
-00017980: 5d29 0a20 2020 2020 2020 2020 2020 2020  ]).             
-00017990: 2020 2073 6363 6320 3d20 7365 6c66 2e63     sccc = self.c
-000179a0: 616c 635f 6d6f 6328 696e 645f 6172 727a  alc_moc(ind_arrz
-000179b0: 7978 2c20 7369 6d5f 6d61 702c 206d 6170  yx, sim_map, map
-000179c0: 5f74 6172 6765 7429 0a20 2020 2020 2020  _target).       
-000179d0: 2020 2020 2020 2020 2064 6963 745f 7265           dict_re
-000179e0: 735f 7363 6f72 6573 5b72 6573 5d20 3d20  s_scores[res] = 
-000179f0: 7363 6363 0a20 2020 2020 2020 2020 2020  sccc.           
-00017a00: 2020 2020 206c 6973 745f 7363 6363 2e61       list_sccc.a
-00017a10: 7070 656e 6428 7363 6363 290a 2020 2020  ppend(sccc).    
-00017a20: 2020 2020 7265 7475 726e 2064 6963 745f      return dict_
-00017a30: 7265 735f 7363 6f72 6573 0a0a 2020 2020  res_scores..    
-00017a40: 6465 6620 5f67 6574 5f73 6865 6c6c 2873  def _get_shell(s
-00017a50: 656c 662c 2064 6973 7431 2c20 6d61 786c  elf, dist1, maxl
-00017a60: 6576 656c 2c20 7374 6570 2c20 7829 3a0a  evel, step, x):.
-00017a70: 2020 2020 2020 2020 2320 696e 6469 6365          # indice
-00017a80: 7320 6265 7477 6565 6e20 7570 7065 7220  s between upper 
-00017a90: 616e 6420 6c6f 7765 7220 7368 656c 6c20  and lower shell 
-00017aa0: 626f 756e 640a 2020 2020 2020 2020 7265  bound.        re
-00017ab0: 7475 726e 206e 702e 6172 6777 6865 7265  turn np.argwhere
-00017ac0: 2828 6469 7374 3120 3c20 6d69 6e28 6d61  ((dist1 < min(ma
-00017ad0: 786c 6576 656c 2c20 7820 2b20 7374 6570  xlevel, x + step
-00017ae0: 2929 2026 2028 6469 7374 3120 3e3d 2078  )) & (dist1 >= x
-00017af0: 2929 0a0a 2020 2020 2020 2020 2320 6d61  ))..        # ma
-00017b00: 7463 6820 706f 7765 7220 7370 6563 7472  tch power spectr
-00017b10: 6120 666f 7220 7477 6f20 6d61 7073 0a20  a for two maps. 
-00017b20: 2020 2064 6566 205f 616d 706c 6974 7564     def _amplitud
-00017b30: 655f 6d61 7463 6828 0a20 2020 2020 2020  e_match(.       
-00017b40: 2020 2020 2073 656c 662c 0a20 2020 2020       self,.     
-00017b50: 2020 2020 2020 206d 6170 5f31 2c0a 2020         map_1,.  
-00017b60: 2020 2020 2020 2020 2020 6d61 705f 322c            map_2,
-00017b70: 0a20 2020 2020 2020 2020 2020 2073 6865  .            she
-00017b80: 6c6c 6d69 6e2c 0a20 2020 2020 2020 2020  llmin,.         
-00017b90: 2020 2073 6865 6c6c 6d61 782c 0a20 2020     shellmax,.   
-00017ba0: 2020 2020 2020 2020 2073 7465 703d 302e           step=0.
-00017bb0: 3030 352c 0a20 2020 2020 2020 2020 2020  005,.           
-00017bc0: 2063 313d 302c 0a20 2020 2020 2020 2020   c1=0,.         
-00017bd0: 2020 2063 323d 302c 0a20 2020 2020 2020     c2=0,.       
-00017be0: 2020 2020 2072 6573 6f3d 4e6f 6e65 2c0a       reso=None,.
-00017bf0: 2020 2020 2020 2020 2020 2020 6c70 6669              lpfi
-00017c00: 6c74 623d 4661 6c73 652c 0a20 2020 2020  ltb=False,.     
-00017c10: 2020 2020 2020 206c 7066 696c 7461 3d46         lpfilta=F
-00017c20: 616c 7365 2c0a 2020 2020 2020 2020 2020  alse,.          
-00017c30: 2020 7265 663d 4661 6c73 652c 0a20 2020    ref=False,.   
-00017c40: 2029 3a0a 2020 2020 2020 2020 2222 220a   ):.        """.
-00017c50: 2020 2020 2020 2020 5363 616c 6520 616d          Scale am
-00017c60: 706c 6974 7564 6573 2074 6f20 7468 6520  plitudes to the 
-00017c70: 6176 6572 6167 6520 696e 2065 6163 6820  average in each 
-00017c80: 7265 736f 6c75 7469 6f6e 7320 7368 656c  resolutions shel
-00017c90: 6c0a 0a20 2020 2020 2020 2041 7267 756d  l..        Argum
-00017ca0: 656e 7473 3a0a 2020 2020 2020 2020 2020  ents:.          
-00017cb0: 2020 2a73 7465 7020 3a20 7368 656c 6c20    *step : shell 
-00017cc0: 7769 6474 6820 2831 2f41 290a 2020 2020  width (1/A).    
-00017cd0: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
-00017ce0: 2320 666f 7572 6965 7220 7472 616e 7366  # fourier transf
-00017cf0: 6f72 6d3a 2075 7365 2070 7966 6674 7720  orm: use pyfftw 
-00017d00: 6966 2061 7661 696c 6162 6c65 0a20 2020  if available.   
-00017d10: 2020 2020 2070 7966 6674 775f 666c 6167       pyfftw_flag
-00017d20: 203d 2031 0a20 2020 2020 2020 2074 7279   = 1.        try
-00017d30: 3a0a 2020 2020 2020 2020 2020 2020 696d  :.            im
-00017d40: 706f 7274 2070 7966 6674 770a 2020 2020  port pyfftw.    
-00017d50: 2020 2020 6578 6365 7074 2049 6d70 6f72      except Impor
-00017d60: 7445 7272 6f72 3a0a 2020 2020 2020 2020  tError:.        
-00017d70: 2020 2020 7079 6666 7477 5f66 6c61 6720      pyfftw_flag 
-00017d80: 3d20 300a 2020 2020 2020 2020 7472 793a  = 0.        try:
-00017d90: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-00017da0: 7079 6666 7477 5f66 6c61 6720 3d3d 2030  pyfftw_flag == 0
-00017db0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00017dc0: 2020 7261 6973 6520 496d 706f 7274 4572    raise ImportEr
-00017dd0: 726f 720a 2020 2020 2020 2020 2020 2020  ror.            
-00017de0: 696e 7075 7461 3120 3d20 7079 6666 7477  inputa1 = pyfftw
-00017df0: 2e6e 5f62 7974 655f 616c 6967 6e5f 656d  .n_byte_align_em
-00017e00: 7074 7928 0a20 2020 2020 2020 2020 2020  pty(.           
-00017e10: 2020 2020 206d 6170 5f31 2e66 756c 6c4d       map_1.fullM
-00017e20: 6170 2e73 6861 7065 2c0a 2020 2020 2020  ap.shape,.      
-00017e30: 2020 2020 2020 2020 2020 3136 2c0a 2020            16,.  
-00017e40: 2020 2020 2020 2020 2020 2020 2020 2763                'c
-00017e50: 6f6d 706c 6578 3132 3827 2c0a 2020 2020  omplex128',.    
-00017e60: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-00017e70: 2020 2020 2020 6f75 7470 7574 6131 203d        outputa1 =
-00017e80: 2070 7966 6674 772e 6e5f 6279 7465 5f61   pyfftw.n_byte_a
-00017e90: 6c69 676e 5f65 6d70 7479 280a 2020 2020  lign_empty(.    
-00017ea0: 2020 2020 2020 2020 2020 2020 6d61 705f              map_
-00017eb0: 312e 6675 6c6c 4d61 702e 7368 6170 652c  1.fullMap.shape,
-00017ec0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00017ed0: 2031 362c 0a20 2020 2020 2020 2020 2020   16,.           
-00017ee0: 2020 2020 2027 636f 6d70 6c65 7831 3238       'complex128
-00017ef0: 272c 0a20 2020 2020 2020 2020 2020 2029  ',.            )
-00017f00: 0a20 2020 2020 2020 2020 2020 2023 2066  .            # f
-00017f10: 6674 2070 6c61 6e6e 696e 672c 2073 6574  ft planning, set
-00017f20: 2070 6c61 6e6e 696e 675f 7469 6d65 6c69   planning_timeli
-00017f30: 6d69 7420 6f72 2066 6c61 6773 2074 6f20  mit or flags to 
-00017f40: 6d61 6b65 2069 7420 6661 7374 6572 0a20  make it faster. 
-00017f50: 2020 2020 2020 2020 2020 2066 6674 203d             fft =
-00017f60: 2070 7966 6674 772e 4646 5457 280a 2020   pyfftw.FFTW(.  
-00017f70: 2020 2020 2020 2020 2020 2020 2020 696e                in
-00017f80: 7075 7461 312c 0a20 2020 2020 2020 2020  puta1,.         
-00017f90: 2020 2020 2020 206f 7574 7075 7461 312c         outputa1,
-00017fa0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00017fb0: 2064 6972 6563 7469 6f6e 3d27 4646 5457   direction='FFTW
-00017fc0: 5f46 4f52 5741 5244 272c 0a20 2020 2020  _FORWARD',.     
-00017fd0: 2020 2020 2020 2020 2020 2061 7865 733d             axes=
-00017fe0: 2830 2c20 312c 2032 292c 0a20 2020 2020  (0, 1, 2),.     
-00017ff0: 2020 2020 2020 2020 2020 2066 6c61 6773             flags
-00018000: 3d5b 2746 4654 575f 4553 5449 4d41 5445  =['FFTW_ESTIMATE
-00018010: 275d 2c0a 2020 2020 2020 2020 2020 2020  '],.            
-00018020: 290a 2020 2020 2020 2020 2020 2020 696e  ).            in
-00018030: 7075 7461 315b 3a2c 203a 2c20 3a5d 203d  puta1[:, :, :] =
-00018040: 206d 6170 5f31 2e66 756c 6c4d 6170 5b3a   map_1.fullMap[:
-00018050: 2c20 3a2c 203a 5d0a 2020 2020 2020 2020  , :, :].        
-00018060: 2020 2020 6666 7428 290a 2020 2020 2020      fft().      
-00018070: 2020 2020 2020 6674 3120 3d20 4d61 7028        ft1 = Map(
-00018080: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00018090: 2066 6674 7368 6966 7428 6f75 7470 7574   fftshift(output
-000180a0: 6131 292c 0a20 2020 2020 2020 2020 2020  a1),.           
-000180b0: 2020 2020 206d 6170 5f31 2e6f 7269 6769       map_1.origi
-000180c0: 6e2c 0a20 2020 2020 2020 2020 2020 2020  n,.             
-000180d0: 2020 206d 6170 5f31 2e61 7069 782c 0a20     map_1.apix,. 
-000180e0: 2020 2020 2020 2020 2020 2020 2020 206d                 m
-000180f0: 6170 5f31 2e66 696c 656e 616d 652c 0a20  ap_1.filename,. 
-00018100: 2020 2020 2020 2020 2020 2020 2020 206d                 m
-00018110: 6170 5f31 2e68 6561 6465 725b 3a5d 2c0a  ap_1.header[:],.
-00018120: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
-00018130: 2020 2020 2020 6578 6365 7074 2045 7863        except Exc
-00018140: 6570 7469 6f6e 3a0a 2020 2020 2020 2020  eption:.        
-00018150: 2020 2020 2320 7573 6520 6e75 6d70 7920      # use numpy 
-00018160: 6666 7420 696e 7374 6561 640a 2020 2020  fft instead.    
-00018170: 2020 2020 2020 2020 6674 3120 3d20 6d61          ft1 = ma
-00018180: 705f 312e 666f 7572 6965 725f 7472 616e  p_1.fourier_tran
-00018190: 7366 6f72 6d28 290a 2020 2020 2020 2020  sform().        
-000181a0: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
-000181b0: 2069 6620 7079 6666 7477 5f66 6c61 6720   if pyfftw_flag 
-000181c0: 3d3d 2030 3a0a 2020 2020 2020 2020 2020  == 0:.          
-000181d0: 2020 2020 2020 7261 6973 6520 496d 706f        raise Impo
-000181e0: 7274 4572 726f 720a 2020 2020 2020 2020  rtError.        
-000181f0: 2020 2020 696e 7075 7461 3220 3d20 7079      inputa2 = py
-00018200: 6666 7477 2e6e 5f62 7974 655f 616c 6967  fftw.n_byte_alig
-00018210: 6e5f 656d 7074 7928 0a20 2020 2020 2020  n_empty(.       
-00018220: 2020 2020 2020 2020 206d 6170 5f32 2e66           map_2.f
-00018230: 756c 6c4d 6170 2e73 6861 7065 2c0a 2020  ullMap.shape,.  
-00018240: 2020 2020 2020 2020 2020 2020 2020 3136                16
-00018250: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00018260: 2020 2763 6f6d 706c 6578 3132 3827 2c0a    'complex128',.
-00018270: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
-00018280: 2020 2020 2020 2020 2020 6f75 7470 7574            output
-00018290: 6132 203d 2070 7966 6674 772e 6e5f 6279  a2 = pyfftw.n_by
-000182a0: 7465 5f61 6c69 676e 5f65 6d70 7479 280a  te_align_empty(.
-000182b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000182c0: 6d61 705f 322e 6675 6c6c 4d61 702e 7368  map_2.fullMap.sh
-000182d0: 6170 652c 0a20 2020 2020 2020 2020 2020  ape,.           
-000182e0: 2020 2020 2031 362c 0a20 2020 2020 2020       16,.       
-000182f0: 2020 2020 2020 2020 2027 636f 6d70 6c65           'comple
-00018300: 7831 3238 272c 0a20 2020 2020 2020 2020  x128',.         
-00018310: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
-00018320: 2066 6674 203d 2070 7966 6674 772e 4646   fft = pyfftw.FF
-00018330: 5457 280a 2020 2020 2020 2020 2020 2020  TW(.            
-00018340: 2020 2020 696e 7075 7461 322c 0a20 2020      inputa2,.   
-00018350: 2020 2020 2020 2020 2020 2020 206f 7574               out
-00018360: 7075 7461 322c 0a20 2020 2020 2020 2020  puta2,.         
-00018370: 2020 2020 2020 2064 6972 6563 7469 6f6e         direction
-00018380: 3d27 4646 5457 5f46 4f52 5741 5244 272c  ='FFTW_FORWARD',
-00018390: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000183a0: 2061 7865 733d 2830 2c20 312c 2032 292c   axes=(0, 1, 2),
-000183b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000183c0: 2066 6c61 6773 3d5b 2746 4654 575f 4553   flags=['FFTW_ES
-000183d0: 5449 4d41 5445 275d 2c0a 2020 2020 2020  TIMATE'],.      
-000183e0: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-000183f0: 2020 2020 696e 7075 7461 325b 3a2c 203a      inputa2[:, :
-00018400: 2c20 3a5d 203d 206d 6170 5f32 2e66 756c  , :] = map_2.ful
-00018410: 6c4d 6170 5b3a 2c20 3a2c 203a 5d0a 2020  lMap[:, :, :].  
-00018420: 2020 2020 2020 2020 2020 6666 7428 290a            fft().
-00018430: 2020 2020 2020 2020 2020 2020 6674 3220              ft2 
-00018440: 3d20 4d61 7028 0a20 2020 2020 2020 2020  = Map(.         
-00018450: 2020 2020 2020 2066 6674 7368 6966 7428         fftshift(
-00018460: 6f75 7470 7574 6132 292c 0a20 2020 2020  outputa2),.     
-00018470: 2020 2020 2020 2020 2020 206d 6170 5f32             map_2
-00018480: 2e6f 7269 6769 6e2c 0a20 2020 2020 2020  .origin,.       
-00018490: 2020 2020 2020 2020 206d 6170 5f32 2e61           map_2.a
-000184a0: 7069 782c 0a20 2020 2020 2020 2020 2020  pix,.           
-000184b0: 2020 2020 206d 6170 5f32 2e66 696c 656e       map_2.filen
-000184c0: 616d 652c 0a20 2020 2020 2020 2020 2020  ame,.           
-000184d0: 2020 2020 206d 6170 5f32 2e68 6561 6465       map_2.heade
-000184e0: 725b 3a5d 2c0a 2020 2020 2020 2020 2020  r[:],.          
-000184f0: 2020 290a 2020 2020 2020 2020 6578 6365    ).        exce
-00018500: 7074 2045 7863 6570 7469 6f6e 3a0a 2020  pt Exception:.  
-00018510: 2020 2020 2020 2020 2020 6674 3220 3d20            ft2 = 
-00018520: 6d61 705f 322e 666f 7572 6965 725f 7472  map_2.fourier_tr
-00018530: 616e 7366 6f72 6d28 290a 2020 2020 2020  ansform().      
-00018540: 2020 2320 6c6f 7720 7061 7373 2066 696c    # low pass fil
-00018550: 7465 7220 6265 666f 7265 2073 6361 6c69  ter before scali
-00018560: 6e67 0a20 2020 2020 2020 2069 6620 7265  ng.        if re
-00018570: 736f 2069 7320 6e6f 7420 4e6f 6e65 3a0a  so is not None:.
-00018580: 2020 2020 2020 2020 2020 2020 6375 746f              cuto
-00018590: 6666 3120 3d20 6d61 705f 312e 6170 6978  ff1 = map_1.apix
-000185a0: 202f 2066 6c6f 6174 2872 6573 6f29 0a20   / float(reso). 
-000185b0: 2020 2020 2020 2020 2020 2063 7574 6f66             cutof
-000185c0: 6632 203d 206d 6170 5f32 2e61 7069 7820  f2 = map_2.apix 
-000185d0: 2f20 666c 6f61 7428 7265 736f 290a 2020  / float(reso).  
-000185e0: 2020 2020 2020 2020 2020 6966 206c 7066            if lpf
-000185f0: 696c 7462 2061 6e64 206e 6f74 206c 7066  iltb and not lpf
-00018600: 696c 7461 3a0a 2020 2020 2020 2020 2020  ilta:.          
-00018610: 2020 2020 2020 6674 312e 5f74 616e 685f        ft1._tanh_
-00018620: 6c6f 7770 6173 7328 6375 746f 6666 312c  lowpass(cutoff1,
-00018630: 2066 616c 6c3d 302e 322c 2066 746d 6170   fall=0.2, ftmap
-00018640: 3d54 7275 6529 0a20 2020 2020 2020 2020  =True).         
-00018650: 2020 2020 2020 2066 7432 2e5f 7461 6e68         ft2._tanh
-00018660: 5f6c 6f77 7061 7373 2863 7574 6f66 6632  _lowpass(cutoff2
-00018670: 2c20 6661 6c6c 3d30 2e32 2c20 6674 6d61  , fall=0.2, ftma
-00018680: 703d 5472 7565 290a 2020 2020 2020 2020  p=True).        
-00018690: 2320 7369 7a65 3120 3d20 6d61 7828 6d61  # size1 = max(ma
-000186a0: 705f 312e 785f 7369 7a65 2829 2c6d 6170  p_1.x_size(),map
-000186b0: 5f31 2e79 5f73 697a 6528 292c 6d61 705f  _1.y_size(),map_
-000186c0: 312e 7a5f 7369 7a65 2829 290a 2020 2020  1.z_size()).    
-000186d0: 2020 2020 6469 7374 3120 3d20 6d61 705f      dist1 = map_
-000186e0: 312e 5f6d 616b 655f 666f 7572 6965 725f  1._make_fourier_
-000186f0: 7368 656c 6c28 3129 2f6d 6170 5f31 2e61  shell(1)/map_1.a
-00018700: 7069 785b 305d 0a20 2020 2020 2020 2023  pix[0].        #
-00018710: 2073 697a 6532 203d 206d 6178 286d 6170   size2 = max(map
-00018720: 5f32 2e78 5f73 697a 6528 292c 206d 6170  _2.x_size(), map
-00018730: 5f32 2e79 5f73 697a 6528 292c 206d 6170  _2.y_size(), map
-00018740: 5f32 2e7a 5f73 697a 6528 2929 0a20 2020  _2.z_size()).   
-00018750: 2020 2020 2064 6973 7432 203d 206d 6170       dist2 = map
-00018760: 5f32 2e5f 6d61 6b65 5f66 6f75 7269 6572  _2._make_fourier
-00018770: 5f73 6865 6c6c 2831 2920 2f20 6d61 705f  _shell(1) / map_
-00018780: 322e 6170 6978 5b30 5d0a 2020 2020 2020  2.apix[0].      
-00018790: 2020 6674 315f 6176 6720 3d20 5b5d 0a20    ft1_avg = []. 
-000187a0: 2020 2020 2020 2066 7432 5f61 7667 203d         ft2_avg =
-000187b0: 205b 5d0a 2020 2020 2020 2020 6674 315f   [].        ft1_
-000187c0: 6176 675f 6e65 7720 3d20 5b5d 0a20 2020  avg_new = [].   
-000187d0: 2020 2020 206c 6672 6571 203d 205b 5d0a       lfreq = [].
-000187e0: 2020 2020 2020 2020 2320 7365 6c65 6374          # select
-000187f0: 206d 6178 2073 7061 7469 616c 2066 7265   max spatial fre
-00018800: 7175 656e 6379 2074 6f20 6974 6572 6174  quency to iterat
-00018810: 6520 746f 2e20 6c6f 7720 7265 736f 6c75  e to. low resolu
-00018820: 7469 6f6e 206d 6170 0a20 2020 2020 2020  tion map.       
-00018830: 206d 6178 6c65 7665 6c20 3d20 302e 3520   maxlevel = 0.5 
-00018840: 2f20 6e70 2e6d 6178 2828 6d61 705f 312e  / np.max((map_1.
-00018850: 6170 6978 5b30 5d2c 206d 6170 5f32 2e61  apix[0], map_2.a
-00018860: 7069 785b 305d 292c 2061 7869 733d 3029  pix[0]), axis=0)
-00018870: 0a20 2020 2020 2020 2023 206c 6f6f 7020  .        # loop 
-00018880: 6f76 6572 2066 7265 7120 7368 656c 6c73  over freq shells
-00018890: 2c20 7368 656c 6c77 6964 7468 3d30 2e30  , shellwidth=0.0
-000188a0: 3035 0a20 2020 2020 2020 2023 2066 6f72  05.        # for
-000188b0: 2078 2069 6e20 6172 616e 6765 2830 2c6d   x in arange(0,m
-000188c0: 6178 6c65 7665 6c2b 7374 6570 2c73 7465  axlevel+step,ste
-000188d0: 7029 3a0a 2020 2020 2020 2020 6e63 203d  p):.        nc =
-000188e0: 2030 0a20 2020 2020 2020 2078 203d 2030   0.        x = 0
-000188f0: 2e30 0a20 2020 2020 2020 2068 6967 686c  .0.        highl
-00018900: 6576 656c 203d 2078 202b 2073 7465 700a  evel = x + step.
-00018910: 2020 2020 2020 2020 7768 696c 6520 2878          while (x
-00018920: 203c 206d 6178 6c65 7665 6c29 3a0a 2020   < maxlevel):.  
-00018930: 2020 2020 2020 2020 2020 2320 7072 696e            # prin
-00018940: 7420 782c 6869 6768 6c65 7665 6c2c 206d  t x,highlevel, m
-00018950: 6178 6c65 7665 6c0a 2020 2020 2020 2020  axlevel.        
-00018960: 2020 2020 2320 696e 6469 6365 7320 6265      # indices be
-00018970: 7477 6565 6e20 7570 7065 7220 616e 6420  tween upper and 
-00018980: 6c6f 7765 7220 7368 656c 6c20 626f 756e  lower shell boun
-00018990: 640a 2020 2020 2020 2020 2020 2020 6673  d.            fs
-000189a0: 6865 6c6c 7331 203d 2028 2864 6973 7431  hells1 = ((dist1
-000189b0: 203c 206d 696e 286d 6178 6c65 7665 6c2c   < min(maxlevel,
-000189c0: 2068 6967 686c 6576 656c 2929 2026 2028   highlevel)) & (
-000189d0: 6469 7374 3120 3e3d 2078 2929 0a20 2020  dist1 >= x)).   
-000189e0: 2020 2020 2020 2020 2023 2072 6164 6961           # radia
-000189f0: 6c20 6176 6572 6167 650a 2020 2020 2020  l average.      
-00018a00: 2020 2020 2020 7368 656c 6c76 6563 3120        shellvec1 
-00018a10: 3d20 6674 312e 6675 6c6c 4d61 705b 6673  = ft1.fullMap[fs
-00018a20: 6865 6c6c 7331 5d0a 2020 2020 2020 2020  hells1].        
-00018a30: 2020 2020 2320 696e 6469 6365 7320 6265      # indices be
-00018a40: 7477 6565 6e20 7570 7065 7220 616e 6420  tween upper and 
-00018a50: 6c6f 7765 7220 7368 656c 6c20 626f 756e  lower shell boun
-00018a60: 640a 2020 2020 2020 2020 2020 2020 6673  d.            fs
-00018a70: 6865 6c6c 7332 203d 2028 2864 6973 7432  hells2 = ((dist2
-00018a80: 203c 206d 696e 286d 6178 6c65 7665 6c2c   < min(maxlevel,
-00018a90: 2068 6967 686c 6576 656c 2929 2026 2028   highlevel)) & (
-00018aa0: 6469 7374 3220 3e3d 2078 2929 0a20 2020  dist2 >= x)).   
-00018ab0: 2020 2020 2020 2020 2023 2072 6164 6961           # radia
-00018ac0: 6c20 6176 6572 6167 650a 2020 2020 2020  l average.      
-00018ad0: 2020 2020 2020 7368 656c 6c76 6563 3220        shellvec2 
-00018ae0: 3d20 6674 322e 6675 6c6c 4d61 705b 6673  = ft2.fullMap[fs
-00018af0: 6865 6c6c 7332 5d0a 2020 2020 2020 2020  hells2].        
-00018b00: 2020 2020 6162 7331 203d 2061 6273 2873      abs1 = abs(s
-00018b10: 6865 6c6c 7665 6331 290a 2020 2020 2020  hellvec1).      
-00018b20: 2020 2020 2020 6162 7332 203d 2061 6273        abs2 = abs
-00018b30: 2873 6865 6c6c 7665 6332 290a 2020 2020  (shellvec2).    
-00018b40: 2020 2020 2020 2020 6e73 3120 3d20 6c65          ns1 = le
-00018b50: 6e28 6e70 2e6e 6f6e 7a65 726f 2861 6273  n(np.nonzero(abs
-00018b60: 3129 5b30 5d29 0a20 2020 2020 2020 2020  1)[0]).         
-00018b70: 2020 206e 7332 203d 206c 656e 286e 702e     ns2 = len(np.
-00018b80: 6e6f 6e7a 6572 6f28 6162 7332 295b 305d  nonzero(abs2)[0]
-00018b90: 290a 2020 2020 2020 2020 2020 2020 6966  ).            if
-00018ba0: 206e 7331 203c 2031 3020 6f72 206e 7332   ns1 < 10 or ns2
-00018bb0: 203c 2031 303a 0a20 2020 2020 2020 2020   < 10:.         
-00018bc0: 2020 2020 2020 206e 6320 2b3d 2031 0a20         nc += 1. 
-00018bd0: 2020 2020 2020 2020 2020 2020 2020 2068                 h
-00018be0: 6967 686c 6576 656c 203d 206d 696e 286d  ighlevel = min(m
-00018bf0: 6178 6c65 7665 6c2c 2078 202b 2028 6e63  axlevel, x + (nc
-00018c00: 202b 2031 2920 2a20 7374 6570 290a 2020   + 1) * step).  
-00018c10: 2020 2020 2020 2020 2020 2020 2020 7820                x 
-00018c20: 3d20 6d61 7828 302e 302c 2078 202d 206e  = max(0.0, x - n
-00018c30: 6320 2a20 7374 6570 290a 2020 2020 2020  c * step).      
-00018c40: 2020 2020 2020 2020 2020 636f 6e74 696e            contin
-00018c50: 7565 0a20 2020 2020 2020 2020 2020 2065  ue.            e
-00018c60: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-00018c70: 2020 2020 206e 6320 3d20 300a 2020 2020       nc = 0.    
-00018c80: 2020 2020 2020 2020 6d66 7431 203d 206e          mft1 = n
-00018c90: 702e 6d65 616e 2861 6273 3129 0a20 2020  p.mean(abs1).   
-00018ca0: 2020 2020 2020 2020 206d 6674 3220 3d20           mft2 = 
-00018cb0: 6e70 2e6d 6561 6e28 6162 7332 290a 2020  np.mean(abs2).  
-00018cc0: 2020 2020 2020 2020 2020 6966 206d 6674            if mft
-00018cd0: 3120 3d3d 2030 2e30 2061 6e64 206d 6674  1 == 0.0 and mft
-00018ce0: 3220 3d3d 2030 2e30 3a0a 2020 2020 2020  2 == 0.0:.      
-00018cf0: 2020 2020 2020 2020 2020 636f 6e74 696e            contin
-00018d00: 7565 0a20 2020 2020 2020 2020 2020 2023  ue.            #
-00018d10: 2073 7120 6f66 2072 6164 6961 6c20 6176   sq of radial av
-00018d20: 6720 616d 706c 6974 7564 650a 2020 2020  g amplitude.    
-00018d30: 2020 2020 2020 2020 6674 315f 6176 672e          ft1_avg.
-00018d40: 6170 7065 6e64 286e 702e 6c6f 6731 3028  append(np.log10(
-00018d50: 6e70 2e6d 6561 6e28 6e70 2e73 7175 6172  np.mean(np.squar
-00018d60: 6528 6162 7331 2929 2929 0a20 2020 2020  e(abs1)))).     
-00018d70: 2020 2020 2020 2066 7432 5f61 7667 2e61         ft2_avg.a
-00018d80: 7070 656e 6428 6e70 2e6c 6f67 3130 286e  ppend(np.log10(n
-00018d90: 702e 6d65 616e 286e 702e 7371 7561 7265  p.mean(np.square
-00018da0: 2861 6273 3229 2929 290a 0a20 2020 2020  (abs2))))..     
-00018db0: 2020 2020 2020 2023 2073 6361 6c65 2074         # scale t
-00018dc0: 6f20 616d 706c 6974 7564 6573 206f 6620  o amplitudes of 
-00018dd0: 7468 6520 7265 6620 6d61 700a 2020 2020  the ref map.    
-00018de0: 2020 2020 2020 2020 6966 2072 6566 3a0a          if ref:.
-00018df0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018e00: 6966 206d 6674 3120 3d3d 2030 2e30 3a0a  if mft1 == 0.0:.
-00018e10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018e20: 2020 2020 636f 6e74 696e 7565 0a20 2020      continue.   
-00018e30: 2020 2020 2020 2020 2020 2020 2066 7431               ft1
-00018e40: 2e66 756c 6c4d 6170 5b66 7368 656c 6c73  .fullMap[fshells
-00018e50: 315d 203d 2073 6865 6c6c 7665 6331 202a  1] = shellvec1 *
-00018e60: 2028 6d66 7432 202f 206d 6674 3129 0a20   (mft2 / mft1). 
-00018e70: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
-00018e80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00018e90: 2023 2072 6570 6c61 6365 2077 6974 6820   # replace with 
-00018ea0: 6176 6720 616d 706c 6974 7564 6573 2066  avg amplitudes f
-00018eb0: 6f72 2074 6865 2074 776f 206d 6170 730a  or the two maps.
-00018ec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018ed0: 6674 312e 6675 6c6c 4d61 705b 6673 6865  ft1.fullMap[fshe
-00018ee0: 6c6c 7331 5d20 3d20 7368 656c 6c76 6563  lls1] = shellvec
-00018ef0: 3120 2a20 286d 6674 3220 2b20 6d66 7431  1 * (mft2 + mft1
-00018f00: 2920 2f20 2832 202a 206d 6674 3129 0a20  ) / (2 * mft1). 
-00018f10: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00018f20: 7432 2e66 756c 6c4d 6170 5b66 7368 656c  t2.fullMap[fshel
-00018f30: 6c73 325d 203d 2073 6865 6c6c 7665 6332  ls2] = shellvec2
-00018f40: 202a 2028 6d66 7432 202b 206d 6674 3129   * (mft2 + mft1)
-00018f50: 202f 2028 3220 2a20 6d66 7432 290a 0a20   / (2 * mft2).. 
-00018f60: 2020 2020 2020 2020 2020 2023 206e 6577             # new
-00018f70: 2072 6164 6961 6c20 6176 6572 6167 6520   radial average 
-00018f80: 2874 6f20 6368 6563 6b29 0a20 2020 2020  (to check).     
-00018f90: 2020 2020 2020 206d 6674 3120 3d20 6e70         mft1 = np
-00018fa0: 2e6d 6561 6e28 6162 7328 6674 312e 6675  .mean(abs(ft1.fu
-00018fb0: 6c6c 4d61 705b 6673 6865 6c6c 7331 5d29  llMap[fshells1])
-00018fc0: 290a 2020 2020 2020 2020 2020 2020 6674  ).            ft
-00018fd0: 315f 6176 675f 6e65 772e 6170 7065 6e64  1_avg_new.append
-00018fe0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-00018ff0: 2020 6e70 2e6c 6f67 3130 280a 2020 2020    np.log10(.    
-00019000: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019010: 6e70 2e6d 6561 6e28 0a20 2020 2020 2020  np.mean(.       
-00019020: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019030: 206e 702e 7371 7561 7265 2861 6273 2866   np.square(abs(f
-00019040: 7431 2e66 756c 6c4d 6170 5b66 7368 656c  t1.fullMap[fshel
-00019050: 6c73 315d 2929 0a20 2020 2020 2020 2020  ls1])).         
-00019060: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
-00019070: 2020 2020 2020 2020 2020 2020 2029 0a20               ). 
-00019080: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
-00019090: 2020 2020 2020 2020 206c 6672 6571 2e61           lfreq.a
-000190a0: 7070 656e 6428 6869 6768 6c65 7665 6c29  ppend(highlevel)
-000190b0: 0a0a 2020 2020 2020 2020 2020 2020 7361  ..            sa
-000190c0: 6d70 6c69 6e67 5f66 7271 203d 2068 6967  mpling_frq = hig
-000190d0: 686c 6576 656c 0a0a 2020 2020 2020 2020  hlevel..        
-000190e0: 2020 2020 6375 746f 6666 5f66 7265 7120      cutoff_freq 
-000190f0: 3d20 6d69 6e28 2831 2e30 202f 2072 6573  = min((1.0 / res
-00019100: 6f29 202b 2030 2e32 352c 206d 6178 6c65  o) + 0.25, maxle
-00019110: 7665 6c29 0a0a 2020 2020 2020 2020 2020  vel)..          
-00019120: 2020 2320 7363 616c 6520 7468 6520 7265    # scale the re
-00019130: 7374 2061 6e64 2062 7265 616b 2061 6674  st and break aft
-00019140: 6572 2072 656c 6576 616e 7420 6672 6571  er relevant freq
-00019150: 7565 6e63 6965 730a 2020 2020 2020 2020  uencies.        
-00019160: 2020 2020 6966 2073 616d 706c 696e 675f      if sampling_
-00019170: 6672 7120 3e20 6375 746f 6666 5f66 7265  frq > cutoff_fre
-00019180: 713a 0a20 2020 2020 2020 2020 2020 2020  q:.             
-00019190: 2020 2066 7368 656c 6c73 3120 3d20 2864     fshells1 = (d
-000191a0: 6973 7431 203e 3d20 6869 6768 6c65 7665  ist1 >= highleve
-000191b0: 6c29 0a20 2020 2020 2020 2020 2020 2020  l).             
-000191c0: 2020 2073 6865 6c6c 7665 6331 203d 2066     shellvec1 = f
-000191d0: 7431 2e66 756c 6c4d 6170 5b66 7368 656c  t1.fullMap[fshel
-000191e0: 6c73 315d 0a20 2020 2020 2020 2020 2020  ls1].           
-000191f0: 2020 2020 206d 6674 3120 3d20 6e70 2e6d       mft1 = np.m
-00019200: 6561 6e28 6162 7328 7368 656c 6c76 6563  ean(abs(shellvec
-00019210: 3129 290a 2020 2020 2020 2020 2020 2020  1)).            
-00019220: 2020 2020 6673 6865 6c6c 7332 203d 2028      fshells2 = (
-00019230: 6469 7374 3220 3e3d 2068 6967 686c 6576  dist2 >= highlev
-00019240: 656c 290a 2020 2020 2020 2020 2020 2020  el).            
-00019250: 2020 2020 7368 656c 6c76 6563 3220 3d20      shellvec2 = 
-00019260: 6674 322e 6675 6c6c 4d61 705b 6673 6865  ft2.fullMap[fshe
-00019270: 6c6c 7332 5d0a 2020 2020 2020 2020 2020  lls2].          
-00019280: 2020 2020 2020 6d66 7432 203d 206e 702e        mft2 = np.
-00019290: 6d65 616e 2861 6273 2873 6865 6c6c 7665  mean(abs(shellve
-000192a0: 6332 2929 0a20 2020 2020 2020 2020 2020  c2)).           
-000192b0: 2020 2020 2069 6620 6d66 7431 203d 3d20       if mft1 == 
-000192c0: 302e 3020 616e 6420 6d66 7432 203d 3d20  0.0 and mft2 == 
-000192d0: 302e 303a 0a20 2020 2020 2020 2020 2020  0.0:.           
-000192e0: 2020 2020 2020 2020 2062 7265 616b 0a20           break. 
-000192f0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00019300: 7431 5f61 7667 2e61 7070 656e 6428 6e70  t1_avg.append(np
-00019310: 2e6c 6f67 3130 286e 702e 6d65 616e 286e  .log10(np.mean(n
-00019320: 702e 7371 7561 7265 2861 6273 2873 6865  p.square(abs(she
-00019330: 6c6c 7665 6331 2929 2929 290a 2020 2020  llvec1))))).    
-00019340: 2020 2020 2020 2020 2020 2020 6674 325f              ft2_
-00019350: 6176 672e 6170 7065 6e64 286e 702e 6c6f  avg.append(np.lo
-00019360: 6731 3028 6e70 2e6d 6561 6e28 6e70 2e73  g10(np.mean(np.s
-00019370: 7175 6172 6528 6162 7328 7368 656c 6c76  quare(abs(shellv
-00019380: 6563 3229 2929 2929 0a0a 2020 2020 2020  ec2)))))..      
-00019390: 2020 2020 2020 2020 2020 6966 2072 6566            if ref
-000193a0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-000193b0: 2020 2020 2020 6966 206d 6674 3120 3d3d        if mft1 ==
-000193c0: 2030 2e30 3a0a 2020 2020 2020 2020 2020   0.0:.          
-000193d0: 2020 2020 2020 2020 2020 2020 2020 6272                br
-000193e0: 6561 6b0a 2020 2020 2020 2020 2020 2020  eak.            
-000193f0: 2020 2020 2020 2020 6674 312e 6675 6c6c          ft1.full
-00019400: 4d61 705b 6673 6865 6c6c 7331 5d20 3d20  Map[fshells1] = 
-00019410: 7368 656c 6c76 6563 312a 286d 6674 322f  shellvec1*(mft2/
-00019420: 6d66 7431 290a 2020 2020 2020 2020 2020  mft1).          
-00019430: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+00017170: 7262 5f6c 6973 742e 6170 7065 6e64 286c  rb_list.append(l
+00017180: 7262 290a 2020 2020 2020 2020 2020 2020  rb).            
+00017190: 2020 2020 2020 2020 6469 6374 5f72 665f          dict_rf_
+000171a0: 7265 735b 725f 6374 5d20 3d20 7262 5f70  res[r_ct] = rb_p
+000171b0: 6169 7273 0a20 2020 2020 2020 2020 2020  airs.           
+000171c0: 2020 2020 2020 2020 2069 6620 6c65 6e28           if len(
+000171d0: 7363 6f72 655f 696e 6469 6365 7329 203d  score_indices) =
+000171e0: 3d20 303a 0a20 2020 2020 2020 2020 2020  = 0:.           
+000171f0: 2020 2020 2020 2020 2020 2020 2064 6963               dic
+00017200: 745f 7266 5f73 635b 725f 6374 5d20 3d20  t_rf_sc[r_ct] = 
+00017210: 302e 300a 2020 2020 2020 2020 2020 2020  0.0.            
+00017220: 2020 2020 2020 2020 2020 2020 666f 7220              for 
+00017230: 7265 7320 696e 2072 6573 5f6c 6973 743a  res in res_list:
+00017240: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00017250: 2020 2020 2020 2020 2020 2020 2064 6963               dic
+00017260: 745f 7265 735f 7363 6f72 6573 5b72 6573  t_res_scores[res
+00017270: 5d20 3d20 302e 300a 2020 2020 2020 2020  ] = 0.0.        
+00017280: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017290: 636f 6e74 696e 7565 0a0a 2020 2020 2020  continue..      
+000172a0: 2020 2020 2020 2020 2020 2020 2020 746d                tm
+000172b0: 706c 6973 7420 3d20 7363 6f72 655f 696e  plist = score_in
+000172c0: 6469 6365 735b 3a5d 0a20 2020 2020 2020  dices[:].       
+000172d0: 2020 2020 2020 2020 2020 2020 2073 6574               set
+000172e0: 6c69 7374 203d 2073 6574 2874 6d70 6c69  list = set(tmpli
+000172f0: 7374 290a 2020 2020 2020 2020 2020 2020  st).            
+00017300: 2020 2020 2020 2020 7363 6f72 655f 696e          score_in
+00017310: 6469 6365 7320 3d20 6c69 7374 2873 6574  dices = list(set
+00017320: 6c69 7374 290a 2020 2020 2020 2020 2020  list).          
+00017330: 2020 2020 2020 2020 2020 7363 5f69 6e64            sc_ind
+00017340: 6963 6573 203d 205b 5d0a 2020 2020 2020  ices = [].      
+00017350: 2020 2020 2020 2020 2020 2020 2020 666f                fo
+00017360: 7220 6969 2069 6e20 7363 6f72 655f 696e  r ii in score_in
+00017370: 6469 6365 733a 0a20 2020 2020 2020 2020  dices:.         
+00017380: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00017390: 635f 696e 6469 6365 732e 6170 7065 6e64  c_indices.append
+000173a0: 2869 6e64 695b 6969 5d29 0a20 2020 2020  (indi[ii]).     
+000173b0: 2020 2020 2020 2020 2020 2020 2020 2061                 a
+000173c0: 7272 6179 5f69 6e64 6963 6573 203d 206e  rray_indices = n
+000173d0: 702e 6172 7261 7928 7363 5f69 6e64 6963  p.array(sc_indic
+000173e0: 6573 290a 2020 2020 2020 2020 2020 2020  es).            
+000173f0: 2020 2020 2020 2020 696e 645f 6172 7278          ind_arrx
+00017400: 797a 203d 206e 702e 7472 616e 7370 6f73  yz = np.transpos
+00017410: 6528 6172 7261 795f 696e 6469 6365 7329  e(array_indices)
+00017420: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00017430: 2020 2020 2020 696e 645f 6172 727a 7978        ind_arrzyx
+00017440: 203d 2028 696e 645f 6172 7278 797a 5b32   = (ind_arrxyz[2
+00017450: 5d2c 2069 6e64 5f61 7272 7879 7a5b 315d  ], ind_arrxyz[1]
+00017460: 2c20 696e 645f 6172 7278 797a 5b30 5d29  , ind_arrxyz[0])
+00017470: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00017480: 2020 2020 2073 6363 6320 3d20 7365 6c66       sccc = self
+00017490: 2e63 616c 635f 6d6f 6328 696e 645f 6172  .calc_moc(ind_ar
+000174a0: 727a 7978 2c20 7369 6d5f 6d61 702c 206d  rzyx, sim_map, m
+000174b0: 6170 5f74 6172 6765 7429 0a20 2020 2020  ap_target).     
+000174c0: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+000174d0: 6963 745f 7266 5f73 635b 725f 6374 5d20  ict_rf_sc[r_ct] 
+000174e0: 3d20 7363 6363 0a20 2020 2020 2020 2020  = sccc.         
+000174f0: 2020 2020 2020 2020 2020 2023 2073 6176             # sav
+00017500: 6520 7363 6f72 6573 0a20 2020 2020 2020  e scores.       
+00017510: 2020 2020 2020 2020 2020 2020 2066 6f72               for
+00017520: 2072 6573 2069 6e20 7265 735f 6c69 7374   res in res_list
+00017530: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00017540: 2020 2020 2020 2020 2020 6469 6374 5f72            dict_r
+00017550: 6573 5f73 636f 7265 735b 7265 735d 203d  es_scores[res] =
+00017560: 2073 6363 630a 2020 2020 2020 2020 2020   sccc.          
+00017570: 2020 2020 2020 2020 2020 2020 2020 6c69                li
+00017580: 7374 5f73 6363 632e 6170 7065 6e64 2873  st_sccc.append(s
+00017590: 6363 6329 0a20 2020 2020 2020 2020 2020  ccc).           
+000175a0: 2069 6e70 2e63 6c6f 7365 2829 0a20 2020   inp.close().   
+000175b0: 2020 2020 2023 2066 6f72 2072 6573 6964       # for resid
+000175c0: 7565 7320 6e6f 7420 696e 2072 6967 6964  ues not in rigid
+000175d0: 2062 6f64 6965 733a 2063 6f6e 7369 6465   bodies: conside
+000175e0: 7220 7065 6e74 6170 6570 7469 6465 730a  r pentapeptides.
+000175f0: 2020 2020 2020 2020 666f 7220 7265 7320          for res 
+00017600: 696e 2064 6963 745f 7265 735f 696e 6469  in dict_res_indi
+00017610: 6365 733a 0a20 2020 2020 2020 2020 2020  ces:.           
+00017620: 2069 6620 7265 7320 696e 2064 6963 745f   if res in dict_
+00017630: 7265 735f 7363 6f72 6573 3a0a 2020 2020  res_scores:.    
+00017640: 2020 2020 2020 2020 2020 2020 696e 6469              indi
+00017650: 6365 7320 3d20 6469 6374 5f72 6573 5f69  ces = dict_res_i
+00017660: 6e64 6963 6573 5b72 6573 5d5b 3a5d 0a20  ndices[res][:]. 
+00017670: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+00017680: 2063 6f6e 7369 6465 7220 7265 7369 6475   consider residu
+00017690: 6573 206f 6e20 626f 7468 2073 6964 6573  es on both sides
+000176a0: 2e20 4e4f 5445 3a20 776f 6e74 2077 6f72  . NOTE: wont wor
+000176b0: 6b20 666f 720a 2020 2020 2020 2020 2020  k for.          
+000176c0: 2020 2020 2020 2320 696e 7365 7274 696f        # insertio
+000176d0: 6e20 636f 6465 7321 0a20 2020 2020 2020  n codes!.       
+000176e0: 2020 2020 2020 2020 2023 206e 6565 6420           # need 
+000176f0: 746f 2072 6577 6974 6520 7265 7320 6e75  to rewite res nu
+00017700: 6d62 6572 7320 746f 2061 766f 6964 2069  mbers to avoid i
+00017710: 6e73 6572 7469 6f6e 2063 6f64 6573 0a20  nsertion codes. 
+00017720: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00017730: 6f72 2069 6920 696e 2072 616e 6765 2831  or ii in range(1
+00017740: 2c20 696e 7428 726f 756e 6428 2877 696e  , int(round((win
+00017750: 202b 2031 2920 2f20 3229 2929 3a0a 2020   + 1) / 2))):.  
+00017760: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017770: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
+00017780: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00017790: 6e64 6963 6573 2e65 7874 656e 6428 6469  ndices.extend(di
+000177a0: 6374 5f72 6573 5f69 6e64 6963 6573 5b72  ct_res_indices[r
+000177b0: 6573 202d 2069 695d 290a 2020 2020 2020  es - ii]).      
+000177c0: 2020 2020 2020 2020 2020 2020 2020 6578                ex
+000177d0: 6365 7074 2045 7863 6570 7469 6f6e 3a0a  cept Exception:.
+000177e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000177f0: 2020 2020 2020 2020 7061 7373 0a20 2020          pass.   
+00017800: 2020 2020 2020 2020 2020 2020 2066 6f72               for
+00017810: 2069 6920 696e 2072 616e 6765 2831 2c20   ii in range(1, 
+00017820: 696e 7428 726f 756e 6428 2877 696e 202b  int(round((win +
+00017830: 2031 2920 2f20 3229 2929 3a0a 2020 2020   1) / 2))):.    
+00017840: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017850: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
+00017860: 2020 2020 2020 2020 2020 2020 2069 6e64               ind
+00017870: 6963 6573 2e65 7874 656e 6428 6469 6374  ices.extend(dict
+00017880: 5f72 6573 5f69 6e64 6963 6573 5b72 6573  _res_indices[res
+00017890: 202b 2069 695d 290a 2020 2020 2020 2020   + ii]).        
+000178a0: 2020 2020 2020 2020 2020 2020 6578 6365              exce
+000178b0: 7074 2045 7863 6570 7469 6f6e 3a0a 2020  pt Exception:.  
+000178c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000178d0: 2020 2020 2020 7061 7373 0a0a 2020 2020        pass..    
+000178e0: 2020 2020 2020 2020 2020 2020 746d 706c              tmpl
+000178f0: 6973 7420 3d20 696e 6469 6365 735b 3a5d  ist = indices[:]
+00017900: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00017910: 2073 6574 6c69 7374 203d 2073 6574 2874   setlist = set(t
+00017920: 6d70 6c69 7374 290a 2020 2020 2020 2020  mplist).        
+00017930: 2020 2020 2020 2020 696e 6469 6365 7320          indices 
+00017940: 3d20 6c69 7374 2873 6574 6c69 7374 290a  = list(setlist).
+00017950: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017960: 7363 5f69 6e64 6963 6573 203d 205b 5d0a  sc_indices = [].
+00017970: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017980: 666f 7220 6969 2069 6e20 696e 6469 6365  for ii in indice
+00017990: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
+000179a0: 2020 2020 2020 2073 635f 696e 6469 6365         sc_indice
+000179b0: 732e 6170 7065 6e64 2869 6e64 695b 6969  s.append(indi[ii
+000179c0: 5d29 0a20 2020 2020 2020 2020 2020 2020  ]).             
+000179d0: 2020 2069 6620 6c65 6e28 696e 6469 6365     if len(indice
+000179e0: 7329 203d 3d20 303a 0a20 2020 2020 2020  s) == 0:.       
+000179f0: 2020 2020 2020 2020 2020 2020 2064 6963               dic
+00017a00: 745f 7265 735f 7363 6f72 6573 5b72 6573  t_res_scores[res
+00017a10: 5d20 3d20 302e 300a 2020 2020 2020 2020  ] = 0.0.        
+00017a20: 2020 2020 2020 2020 2020 2020 636f 6e74              cont
+00017a30: 696e 7565 0a20 2020 2020 2020 2020 2020  inue.           
+00017a40: 2020 2020 2061 7272 6179 5f69 6e64 6963       array_indic
+00017a50: 6573 203d 206e 702e 6172 7261 7928 7363  es = np.array(sc
+00017a60: 5f69 6e64 6963 6573 290a 2020 2020 2020  _indices).      
+00017a70: 2020 2020 2020 2020 2020 696e 645f 6172            ind_ar
+00017a80: 7278 797a 203d 206e 702e 7472 616e 7370  rxyz = np.transp
+00017a90: 6f73 6528 6172 7261 795f 696e 6469 6365  ose(array_indice
+00017aa0: 7329 0a20 2020 2020 2020 2020 2020 2020  s).             
+00017ab0: 2020 2069 6e64 5f61 7272 7a79 7820 3d20     ind_arrzyx = 
+00017ac0: 2869 6e64 5f61 7272 7879 7a5b 325d 2c20  (ind_arrxyz[2], 
+00017ad0: 696e 645f 6172 7278 797a 5b31 5d2c 2069  ind_arrxyz[1], i
+00017ae0: 6e64 5f61 7272 7879 7a5b 305d 290a 2020  nd_arrxyz[0]).  
+00017af0: 2020 2020 2020 2020 2020 2020 2020 7363                sc
+00017b00: 6363 203d 2073 656c 662e 6361 6c63 5f6d  cc = self.calc_m
+00017b10: 6f63 2869 6e64 5f61 7272 7a79 782c 2073  oc(ind_arrzyx, s
+00017b20: 696d 5f6d 6170 2c20 6d61 705f 7461 7267  im_map, map_targ
+00017b30: 6574 290a 2020 2020 2020 2020 2020 2020  et).            
+00017b40: 2020 2020 6469 6374 5f72 6573 5f73 636f      dict_res_sco
+00017b50: 7265 735b 7265 735d 203d 2073 6363 630a  res[res] = sccc.
+00017b60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017b70: 6c69 7374 5f73 6363 632e 6170 7065 6e64  list_sccc.append
+00017b80: 2873 6363 6329 0a20 2020 2020 2020 2072  (sccc).        r
+00017b90: 6574 7572 6e20 6469 6374 5f72 6573 5f73  eturn dict_res_s
+00017ba0: 636f 7265 730a 0a20 2020 2064 6566 205f  cores..    def _
+00017bb0: 6765 745f 7368 656c 6c28 7365 6c66 2c20  get_shell(self, 
+00017bc0: 6469 7374 312c 206d 6178 6c65 7665 6c2c  dist1, maxlevel,
+00017bd0: 2073 7465 702c 2078 293a 0a20 2020 2020   step, x):.     
+00017be0: 2020 2023 2069 6e64 6963 6573 2062 6574     # indices bet
+00017bf0: 7765 656e 2075 7070 6572 2061 6e64 206c  ween upper and l
+00017c00: 6f77 6572 2073 6865 6c6c 2062 6f75 6e64  ower shell bound
+00017c10: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+00017c20: 6e70 2e61 7267 7768 6572 6528 2864 6973  np.argwhere((dis
+00017c30: 7431 203c 206d 696e 286d 6178 6c65 7665  t1 < min(maxleve
+00017c40: 6c2c 2078 202b 2073 7465 7029 2920 2620  l, x + step)) & 
+00017c50: 2864 6973 7431 203e 3d20 7829 290a 0a20  (dist1 >= x)).. 
+00017c60: 2020 2020 2020 2023 206d 6174 6368 2070         # match p
+00017c70: 6f77 6572 2073 7065 6374 7261 2066 6f72  ower spectra for
+00017c80: 2074 776f 206d 6170 730a 2020 2020 6465   two maps.    de
+00017c90: 6620 5f61 6d70 6c69 7475 6465 5f6d 6174  f _amplitude_mat
+00017ca0: 6368 280a 2020 2020 2020 2020 2020 2020  ch(.            
+00017cb0: 7365 6c66 2c0a 2020 2020 2020 2020 2020  self,.          
+00017cc0: 2020 6d61 705f 312c 0a20 2020 2020 2020    map_1,.       
+00017cd0: 2020 2020 206d 6170 5f32 2c0a 2020 2020       map_2,.    
+00017ce0: 2020 2020 2020 2020 7368 656c 6c6d 696e          shellmin
+00017cf0: 2c0a 2020 2020 2020 2020 2020 2020 7368  ,.            sh
+00017d00: 656c 6c6d 6178 2c0a 2020 2020 2020 2020  ellmax,.        
+00017d10: 2020 2020 7374 6570 3d30 2e30 3035 2c0a      step=0.005,.
+00017d20: 2020 2020 2020 2020 2020 2020 6331 3d30              c1=0
+00017d30: 2c0a 2020 2020 2020 2020 2020 2020 6332  ,.            c2
+00017d40: 3d30 2c0a 2020 2020 2020 2020 2020 2020  =0,.            
+00017d50: 7265 736f 3d4e 6f6e 652c 0a20 2020 2020  reso=None,.     
+00017d60: 2020 2020 2020 206c 7066 696c 7462 3d46         lpfiltb=F
+00017d70: 616c 7365 2c0a 2020 2020 2020 2020 2020  alse,.          
+00017d80: 2020 6c70 6669 6c74 613d 4661 6c73 652c    lpfilta=False,
+00017d90: 0a20 2020 2020 2020 2020 2020 2072 6566  .            ref
+00017da0: 3d46 616c 7365 2c0a 2020 2020 293a 0a20  =False,.    ):. 
+00017db0: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
+00017dc0: 2020 2053 6361 6c65 2061 6d70 6c69 7475     Scale amplitu
+00017dd0: 6465 7320 746f 2074 6865 2061 7665 7261  des to the avera
+00017de0: 6765 2069 6e20 6561 6368 2072 6573 6f6c  ge in each resol
+00017df0: 7574 696f 6e73 2073 6865 6c6c 0a0a 2020  utions shell..  
+00017e00: 2020 2020 2020 4172 6775 6d65 6e74 733a        Arguments:
+00017e10: 0a20 2020 2020 2020 2020 2020 202a 7374  .            *st
+00017e20: 6570 203a 2073 6865 6c6c 2077 6964 7468  ep : shell width
+00017e30: 2028 312f 4129 0a20 2020 2020 2020 2022   (1/A).        "
+00017e40: 2222 0a20 2020 2020 2020 2023 2066 6f75  "".        # fou
+00017e50: 7269 6572 2074 7261 6e73 666f 726d 3a20  rier transform: 
+00017e60: 7573 6520 7079 6666 7477 2069 6620 6176  use pyfftw if av
+00017e70: 6169 6c61 626c 650a 2020 2020 2020 2020  ailable.        
+00017e80: 7079 6666 7477 5f66 6c61 6720 3d20 310a  pyfftw_flag = 1.
+00017e90: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
+00017ea0: 2020 2020 2020 2020 2069 6d70 6f72 7420           import 
+00017eb0: 7079 6666 7477 0a20 2020 2020 2020 2065  pyfftw.        e
+00017ec0: 7863 6570 7420 496d 706f 7274 4572 726f  xcept ImportErro
+00017ed0: 723a 0a20 2020 2020 2020 2020 2020 2070  r:.            p
+00017ee0: 7966 6674 775f 666c 6167 203d 2030 0a20  yfftw_flag = 0. 
+00017ef0: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
+00017f00: 2020 2020 2020 2020 6966 2070 7966 6674          if pyfft
+00017f10: 775f 666c 6167 203d 3d20 303a 0a20 2020  w_flag == 0:.   
+00017f20: 2020 2020 2020 2020 2020 2020 2072 6169               rai
+00017f30: 7365 2049 6d70 6f72 7445 7272 6f72 0a20  se ImportError. 
+00017f40: 2020 2020 2020 2020 2020 2069 6e70 7574             input
+00017f50: 6131 203d 2070 7966 6674 772e 6e5f 6279  a1 = pyfftw.n_by
+00017f60: 7465 5f61 6c69 676e 5f65 6d70 7479 280a  te_align_empty(.
+00017f70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017f80: 6d61 705f 312e 6675 6c6c 4d61 702e 7368  map_1.fullMap.sh
+00017f90: 6170 652c 0a20 2020 2020 2020 2020 2020  ape,.           
+00017fa0: 2020 2020 2031 362c 0a20 2020 2020 2020       16,.       
+00017fb0: 2020 2020 2020 2020 2027 636f 6d70 6c65           'comple
+00017fc0: 7831 3238 272c 0a20 2020 2020 2020 2020  x128',.         
+00017fd0: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
+00017fe0: 206f 7574 7075 7461 3120 3d20 7079 6666   outputa1 = pyff
+00017ff0: 7477 2e6e 5f62 7974 655f 616c 6967 6e5f  tw.n_byte_align_
+00018000: 656d 7074 7928 0a20 2020 2020 2020 2020  empty(.         
+00018010: 2020 2020 2020 206d 6170 5f31 2e66 756c         map_1.ful
+00018020: 6c4d 6170 2e73 6861 7065 2c0a 2020 2020  lMap.shape,.    
+00018030: 2020 2020 2020 2020 2020 2020 3136 2c0a              16,.
+00018040: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018050: 2763 6f6d 706c 6578 3132 3827 2c0a 2020  'complex128',.  
+00018060: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+00018070: 2020 2020 2020 2020 2320 6666 7420 706c          # fft pl
+00018080: 616e 6e69 6e67 2c20 7365 7420 706c 616e  anning, set plan
+00018090: 6e69 6e67 5f74 696d 656c 696d 6974 206f  ning_timelimit o
+000180a0: 7220 666c 6167 7320 746f 206d 616b 6520  r flags to make 
+000180b0: 6974 2066 6173 7465 720a 2020 2020 2020  it faster.      
+000180c0: 2020 2020 2020 6666 7420 3d20 7079 6666        fft = pyff
+000180d0: 7477 2e46 4654 5728 0a20 2020 2020 2020  tw.FFTW(.       
+000180e0: 2020 2020 2020 2020 2069 6e70 7574 6131           inputa1
+000180f0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00018100: 2020 6f75 7470 7574 6131 2c0a 2020 2020    outputa1,.    
+00018110: 2020 2020 2020 2020 2020 2020 6469 7265              dire
+00018120: 6374 696f 6e3d 2746 4654 575f 464f 5257  ction='FFTW_FORW
+00018130: 4152 4427 2c0a 2020 2020 2020 2020 2020  ARD',.          
+00018140: 2020 2020 2020 6178 6573 3d28 302c 2031        axes=(0, 1
+00018150: 2c20 3229 2c0a 2020 2020 2020 2020 2020  , 2),.          
+00018160: 2020 2020 2020 666c 6167 733d 5b27 4646        flags=['FF
+00018170: 5457 5f45 5354 494d 4154 4527 5d2c 0a20  TW_ESTIMATE'],. 
+00018180: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
+00018190: 2020 2020 2020 2020 2069 6e70 7574 6131           inputa1
+000181a0: 5b3a 2c20 3a2c 203a 5d20 3d20 6d61 705f  [:, :, :] = map_
+000181b0: 312e 6675 6c6c 4d61 705b 3a2c 203a 2c20  1.fullMap[:, :, 
+000181c0: 3a5d 0a20 2020 2020 2020 2020 2020 2066  :].            f
+000181d0: 6674 2829 0a20 2020 2020 2020 2020 2020  ft().           
+000181e0: 2066 7431 203d 204d 6170 280a 2020 2020   ft1 = Map(.    
+000181f0: 2020 2020 2020 2020 2020 2020 6666 7473              ffts
+00018200: 6869 6674 286f 7574 7075 7461 3129 2c0a  hift(outputa1),.
+00018210: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018220: 6d61 705f 312e 6f72 6967 696e 2c0a 2020  map_1.origin,.  
+00018230: 2020 2020 2020 2020 2020 2020 2020 6d61                ma
+00018240: 705f 312e 6170 6978 2c0a 2020 2020 2020  p_1.apix,.      
+00018250: 2020 2020 2020 2020 2020 6d61 705f 312e            map_1.
+00018260: 6669 6c65 6e61 6d65 2c0a 2020 2020 2020  filename,.      
+00018270: 2020 2020 2020 2020 2020 6d61 705f 312e            map_1.
+00018280: 6865 6164 6572 5b3a 5d2c 0a20 2020 2020  header[:],.     
+00018290: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+000182a0: 2065 7863 6570 7420 4578 6365 7074 696f   except Exceptio
+000182b0: 6e3a 0a20 2020 2020 2020 2020 2020 2023  n:.            #
+000182c0: 2075 7365 206e 756d 7079 2066 6674 2069   use numpy fft i
+000182d0: 6e73 7465 6164 0a20 2020 2020 2020 2020  nstead.         
+000182e0: 2020 2066 7431 203d 206d 6170 5f31 2e66     ft1 = map_1.f
+000182f0: 6f75 7269 6572 5f74 7261 6e73 666f 726d  ourier_transform
+00018300: 2829 0a20 2020 2020 2020 2074 7279 3a0a  ().        try:.
+00018310: 2020 2020 2020 2020 2020 2020 6966 2070              if p
+00018320: 7966 6674 775f 666c 6167 203d 3d20 303a  yfftw_flag == 0:
+00018330: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00018340: 2072 6169 7365 2049 6d70 6f72 7445 7272   raise ImportErr
+00018350: 6f72 0a20 2020 2020 2020 2020 2020 2069  or.            i
+00018360: 6e70 7574 6132 203d 2070 7966 6674 772e  nputa2 = pyfftw.
+00018370: 6e5f 6279 7465 5f61 6c69 676e 5f65 6d70  n_byte_align_emp
+00018380: 7479 280a 2020 2020 2020 2020 2020 2020  ty(.            
+00018390: 2020 2020 6d61 705f 322e 6675 6c6c 4d61      map_2.fullMa
+000183a0: 702e 7368 6170 652c 0a20 2020 2020 2020  p.shape,.       
+000183b0: 2020 2020 2020 2020 2031 362c 0a20 2020           16,.   
+000183c0: 2020 2020 2020 2020 2020 2020 2027 636f               'co
+000183d0: 6d70 6c65 7831 3238 272c 0a20 2020 2020  mplex128',.     
+000183e0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+000183f0: 2020 2020 206f 7574 7075 7461 3220 3d20       outputa2 = 
+00018400: 7079 6666 7477 2e6e 5f62 7974 655f 616c  pyfftw.n_byte_al
+00018410: 6967 6e5f 656d 7074 7928 0a20 2020 2020  ign_empty(.     
+00018420: 2020 2020 2020 2020 2020 206d 6170 5f32             map_2
+00018430: 2e66 756c 6c4d 6170 2e73 6861 7065 2c0a  .fullMap.shape,.
+00018440: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018450: 3136 2c0a 2020 2020 2020 2020 2020 2020  16,.            
+00018460: 2020 2020 2763 6f6d 706c 6578 3132 3827      'complex128'
+00018470: 2c0a 2020 2020 2020 2020 2020 2020 290a  ,.            ).
+00018480: 2020 2020 2020 2020 2020 2020 6666 7420              fft 
+00018490: 3d20 7079 6666 7477 2e46 4654 5728 0a20  = pyfftw.FFTW(. 
+000184a0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+000184b0: 6e70 7574 6132 2c0a 2020 2020 2020 2020  nputa2,.        
+000184c0: 2020 2020 2020 2020 6f75 7470 7574 6132          outputa2
+000184d0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+000184e0: 2020 6469 7265 6374 696f 6e3d 2746 4654    direction='FFT
+000184f0: 575f 464f 5257 4152 4427 2c0a 2020 2020  W_FORWARD',.    
+00018500: 2020 2020 2020 2020 2020 2020 6178 6573              axes
+00018510: 3d28 302c 2031 2c20 3229 2c0a 2020 2020  =(0, 1, 2),.    
+00018520: 2020 2020 2020 2020 2020 2020 666c 6167              flag
+00018530: 733d 5b27 4646 5457 5f45 5354 494d 4154  s=['FFTW_ESTIMAT
+00018540: 4527 5d2c 0a20 2020 2020 2020 2020 2020  E'],.           
+00018550: 2029 0a20 2020 2020 2020 2020 2020 2069   ).            i
+00018560: 6e70 7574 6132 5b3a 2c20 3a2c 203a 5d20  nputa2[:, :, :] 
+00018570: 3d20 6d61 705f 322e 6675 6c6c 4d61 705b  = map_2.fullMap[
+00018580: 3a2c 203a 2c20 3a5d 0a20 2020 2020 2020  :, :, :].       
+00018590: 2020 2020 2066 6674 2829 0a20 2020 2020       fft().     
+000185a0: 2020 2020 2020 2066 7432 203d 204d 6170         ft2 = Map
+000185b0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+000185c0: 2020 6666 7473 6869 6674 286f 7574 7075    fftshift(outpu
+000185d0: 7461 3229 2c0a 2020 2020 2020 2020 2020  ta2),.          
+000185e0: 2020 2020 2020 6d61 705f 322e 6f72 6967        map_2.orig
+000185f0: 696e 2c0a 2020 2020 2020 2020 2020 2020  in,.            
+00018600: 2020 2020 6d61 705f 322e 6170 6978 2c0a      map_2.apix,.
+00018610: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018620: 6d61 705f 322e 6669 6c65 6e61 6d65 2c0a  map_2.filename,.
+00018630: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018640: 6d61 705f 322e 6865 6164 6572 5b3a 5d2c  map_2.header[:],
+00018650: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
+00018660: 2020 2020 2020 2065 7863 6570 7420 4578         except Ex
+00018670: 6365 7074 696f 6e3a 0a20 2020 2020 2020  ception:.       
+00018680: 2020 2020 2066 7432 203d 206d 6170 5f32       ft2 = map_2
+00018690: 2e66 6f75 7269 6572 5f74 7261 6e73 666f  .fourier_transfo
+000186a0: 726d 2829 0a20 2020 2020 2020 2023 206c  rm().        # l
+000186b0: 6f77 2070 6173 7320 6669 6c74 6572 2062  ow pass filter b
+000186c0: 6566 6f72 6520 7363 616c 696e 670a 2020  efore scaling.  
+000186d0: 2020 2020 2020 6966 2072 6573 6f20 6973        if reso is
+000186e0: 206e 6f74 204e 6f6e 653a 0a20 2020 2020   not None:.     
+000186f0: 2020 2020 2020 2063 7574 6f66 6631 203d         cutoff1 =
+00018700: 206d 6170 5f31 2e61 7069 7820 2f20 666c   map_1.apix / fl
+00018710: 6f61 7428 7265 736f 290a 2020 2020 2020  oat(reso).      
+00018720: 2020 2020 2020 6375 746f 6666 3220 3d20        cutoff2 = 
+00018730: 6d61 705f 322e 6170 6978 202f 2066 6c6f  map_2.apix / flo
+00018740: 6174 2872 6573 6f29 0a20 2020 2020 2020  at(reso).       
+00018750: 2020 2020 2069 6620 6c70 6669 6c74 6220       if lpfiltb 
+00018760: 616e 6420 6e6f 7420 6c70 6669 6c74 613a  and not lpfilta:
+00018770: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00018780: 2066 7431 2e5f 7461 6e68 5f6c 6f77 7061   ft1._tanh_lowpa
+00018790: 7373 2863 7574 6f66 6631 2c20 6661 6c6c  ss(cutoff1, fall
+000187a0: 3d30 2e32 2c20 6674 6d61 703d 5472 7565  =0.2, ftmap=True
+000187b0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+000187c0: 2020 6674 322e 5f74 616e 685f 6c6f 7770    ft2._tanh_lowp
+000187d0: 6173 7328 6375 746f 6666 322c 2066 616c  ass(cutoff2, fal
+000187e0: 6c3d 302e 322c 2066 746d 6170 3d54 7275  l=0.2, ftmap=Tru
+000187f0: 6529 0a20 2020 2020 2020 2023 2073 697a  e).        # siz
+00018800: 6531 203d 206d 6178 286d 6170 5f31 2e78  e1 = max(map_1.x
+00018810: 5f73 697a 6528 292c 6d61 705f 312e 795f  _size(),map_1.y_
+00018820: 7369 7a65 2829 2c6d 6170 5f31 2e7a 5f73  size(),map_1.z_s
+00018830: 697a 6528 2929 0a20 2020 2020 2020 2064  ize()).        d
+00018840: 6973 7431 203d 206d 6170 5f31 2e5f 6d61  ist1 = map_1._ma
+00018850: 6b65 5f66 6f75 7269 6572 5f73 6865 6c6c  ke_fourier_shell
+00018860: 2831 292f 6d61 705f 312e 6170 6978 5b30  (1)/map_1.apix[0
+00018870: 5d0a 2020 2020 2020 2020 2320 7369 7a65  ].        # size
+00018880: 3220 3d20 6d61 7828 6d61 705f 322e 785f  2 = max(map_2.x_
+00018890: 7369 7a65 2829 2c20 6d61 705f 322e 795f  size(), map_2.y_
+000188a0: 7369 7a65 2829 2c20 6d61 705f 322e 7a5f  size(), map_2.z_
+000188b0: 7369 7a65 2829 290a 2020 2020 2020 2020  size()).        
+000188c0: 6469 7374 3220 3d20 6d61 705f 322e 5f6d  dist2 = map_2._m
+000188d0: 616b 655f 666f 7572 6965 725f 7368 656c  ake_fourier_shel
+000188e0: 6c28 3129 202f 206d 6170 5f32 2e61 7069  l(1) / map_2.api
+000188f0: 785b 305d 0a20 2020 2020 2020 2066 7431  x[0].        ft1
+00018900: 5f61 7667 203d 205b 5d0a 2020 2020 2020  _avg = [].      
+00018910: 2020 6674 325f 6176 6720 3d20 5b5d 0a20    ft2_avg = []. 
+00018920: 2020 2020 2020 2066 7431 5f61 7667 5f6e         ft1_avg_n
+00018930: 6577 203d 205b 5d0a 2020 2020 2020 2020  ew = [].        
+00018940: 6c66 7265 7120 3d20 5b5d 0a20 2020 2020  lfreq = [].     
+00018950: 2020 2023 2073 656c 6563 7420 6d61 7820     # select max 
+00018960: 7370 6174 6961 6c20 6672 6571 7565 6e63  spatial frequenc
+00018970: 7920 746f 2069 7465 7261 7465 2074 6f2e  y to iterate to.
+00018980: 206c 6f77 2072 6573 6f6c 7574 696f 6e20   low resolution 
+00018990: 6d61 700a 2020 2020 2020 2020 6d61 786c  map.        maxl
+000189a0: 6576 656c 203d 2030 2e35 202f 206e 702e  evel = 0.5 / np.
+000189b0: 6d61 7828 286d 6170 5f31 2e61 7069 785b  max((map_1.apix[
+000189c0: 305d 2c20 6d61 705f 322e 6170 6978 5b30  0], map_2.apix[0
+000189d0: 5d29 2c20 6178 6973 3d30 290a 2020 2020  ]), axis=0).    
+000189e0: 2020 2020 2320 6c6f 6f70 206f 7665 7220      # loop over 
+000189f0: 6672 6571 2073 6865 6c6c 732c 2073 6865  freq shells, she
+00018a00: 6c6c 7769 6474 683d 302e 3030 350a 2020  llwidth=0.005.  
+00018a10: 2020 2020 2020 2320 666f 7220 7820 696e        # for x in
+00018a20: 2061 7261 6e67 6528 302c 6d61 786c 6576   arange(0,maxlev
+00018a30: 656c 2b73 7465 702c 7374 6570 293a 0a20  el+step,step):. 
+00018a40: 2020 2020 2020 206e 6320 3d20 300a 2020         nc = 0.  
+00018a50: 2020 2020 2020 7820 3d20 302e 300a 2020        x = 0.0.  
+00018a60: 2020 2020 2020 6869 6768 6c65 7665 6c20        highlevel 
+00018a70: 3d20 7820 2b20 7374 6570 0a20 2020 2020  = x + step.     
+00018a80: 2020 2077 6869 6c65 2028 7820 3c20 6d61     while (x < ma
+00018a90: 786c 6576 656c 293a 0a20 2020 2020 2020  xlevel):.       
+00018aa0: 2020 2020 2023 2070 7269 6e74 2078 2c68       # print x,h
+00018ab0: 6967 686c 6576 656c 2c20 6d61 786c 6576  ighlevel, maxlev
+00018ac0: 656c 0a20 2020 2020 2020 2020 2020 2023  el.            #
+00018ad0: 2069 6e64 6963 6573 2062 6574 7765 656e   indices between
+00018ae0: 2075 7070 6572 2061 6e64 206c 6f77 6572   upper and lower
+00018af0: 2073 6865 6c6c 2062 6f75 6e64 0a20 2020   shell bound.   
+00018b00: 2020 2020 2020 2020 2066 7368 656c 6c73           fshells
+00018b10: 3120 3d20 2828 6469 7374 3120 3c20 6d69  1 = ((dist1 < mi
+00018b20: 6e28 6d61 786c 6576 656c 2c20 6869 6768  n(maxlevel, high
+00018b30: 6c65 7665 6c29 2920 2620 2864 6973 7431  level)) & (dist1
+00018b40: 203e 3d20 7829 290a 2020 2020 2020 2020   >= x)).        
+00018b50: 2020 2020 2320 7261 6469 616c 2061 7665      # radial ave
+00018b60: 7261 6765 0a20 2020 2020 2020 2020 2020  rage.           
+00018b70: 2073 6865 6c6c 7665 6331 203d 2066 7431   shellvec1 = ft1
+00018b80: 2e66 756c 6c4d 6170 5b66 7368 656c 6c73  .fullMap[fshells
+00018b90: 315d 0a20 2020 2020 2020 2020 2020 2023  1].            #
+00018ba0: 2069 6e64 6963 6573 2062 6574 7765 656e   indices between
+00018bb0: 2075 7070 6572 2061 6e64 206c 6f77 6572   upper and lower
+00018bc0: 2073 6865 6c6c 2062 6f75 6e64 0a20 2020   shell bound.   
+00018bd0: 2020 2020 2020 2020 2066 7368 656c 6c73           fshells
+00018be0: 3220 3d20 2828 6469 7374 3220 3c20 6d69  2 = ((dist2 < mi
+00018bf0: 6e28 6d61 786c 6576 656c 2c20 6869 6768  n(maxlevel, high
+00018c00: 6c65 7665 6c29 2920 2620 2864 6973 7432  level)) & (dist2
+00018c10: 203e 3d20 7829 290a 2020 2020 2020 2020   >= x)).        
+00018c20: 2020 2020 2320 7261 6469 616c 2061 7665      # radial ave
+00018c30: 7261 6765 0a20 2020 2020 2020 2020 2020  rage.           
+00018c40: 2073 6865 6c6c 7665 6332 203d 2066 7432   shellvec2 = ft2
+00018c50: 2e66 756c 6c4d 6170 5b66 7368 656c 6c73  .fullMap[fshells
+00018c60: 325d 0a20 2020 2020 2020 2020 2020 2061  2].            a
+00018c70: 6273 3120 3d20 6162 7328 7368 656c 6c76  bs1 = abs(shellv
+00018c80: 6563 3129 0a20 2020 2020 2020 2020 2020  ec1).           
+00018c90: 2061 6273 3220 3d20 6162 7328 7368 656c   abs2 = abs(shel
+00018ca0: 6c76 6563 3229 0a20 2020 2020 2020 2020  lvec2).         
+00018cb0: 2020 206e 7331 203d 206c 656e 286e 702e     ns1 = len(np.
+00018cc0: 6e6f 6e7a 6572 6f28 6162 7331 295b 305d  nonzero(abs1)[0]
+00018cd0: 290a 2020 2020 2020 2020 2020 2020 6e73  ).            ns
+00018ce0: 3220 3d20 6c65 6e28 6e70 2e6e 6f6e 7a65  2 = len(np.nonze
+00018cf0: 726f 2861 6273 3229 5b30 5d29 0a20 2020  ro(abs2)[0]).   
+00018d00: 2020 2020 2020 2020 2069 6620 6e73 3120           if ns1 
+00018d10: 3c20 3130 206f 7220 6e73 3220 3c20 3130  < 10 or ns2 < 10
+00018d20: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00018d30: 2020 6e63 202b 3d20 310a 2020 2020 2020    nc += 1.      
+00018d40: 2020 2020 2020 2020 2020 6869 6768 6c65            highle
+00018d50: 7665 6c20 3d20 6d69 6e28 6d61 786c 6576  vel = min(maxlev
+00018d60: 656c 2c20 7820 2b20 286e 6320 2b20 3129  el, x + (nc + 1)
+00018d70: 202a 2073 7465 7029 0a20 2020 2020 2020   * step).       
+00018d80: 2020 2020 2020 2020 2078 203d 206d 6178           x = max
+00018d90: 2830 2e30 2c20 7820 2d20 6e63 202a 2073  (0.0, x - nc * s
+00018da0: 7465 7029 0a20 2020 2020 2020 2020 2020  tep).           
+00018db0: 2020 2020 2063 6f6e 7469 6e75 650a 2020       continue.  
+00018dc0: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
+00018dd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018de0: 6e63 203d 2030 0a20 2020 2020 2020 2020  nc = 0.         
+00018df0: 2020 206d 6674 3120 3d20 6e70 2e6d 6561     mft1 = np.mea
+00018e00: 6e28 6162 7331 290a 2020 2020 2020 2020  n(abs1).        
+00018e10: 2020 2020 6d66 7432 203d 206e 702e 6d65      mft2 = np.me
+00018e20: 616e 2861 6273 3229 0a20 2020 2020 2020  an(abs2).       
+00018e30: 2020 2020 2069 6620 6d66 7431 203d 3d20       if mft1 == 
+00018e40: 302e 3020 616e 6420 6d66 7432 203d 3d20  0.0 and mft2 == 
+00018e50: 302e 303a 0a20 2020 2020 2020 2020 2020  0.0:.           
+00018e60: 2020 2020 2063 6f6e 7469 6e75 650a 2020       continue.  
+00018e70: 2020 2020 2020 2020 2020 2320 7371 206f            # sq o
+00018e80: 6620 7261 6469 616c 2061 7667 2061 6d70  f radial avg amp
+00018e90: 6c69 7475 6465 0a20 2020 2020 2020 2020  litude.         
+00018ea0: 2020 2066 7431 5f61 7667 2e61 7070 656e     ft1_avg.appen
+00018eb0: 6428 6e70 2e6c 6f67 3130 286e 702e 6d65  d(np.log10(np.me
+00018ec0: 616e 286e 702e 7371 7561 7265 2861 6273  an(np.square(abs
+00018ed0: 3129 2929 290a 2020 2020 2020 2020 2020  1)))).          
+00018ee0: 2020 6674 325f 6176 672e 6170 7065 6e64    ft2_avg.append
+00018ef0: 286e 702e 6c6f 6731 3028 6e70 2e6d 6561  (np.log10(np.mea
+00018f00: 6e28 6e70 2e73 7175 6172 6528 6162 7332  n(np.square(abs2
+00018f10: 2929 2929 0a0a 2020 2020 2020 2020 2020  ))))..          
+00018f20: 2020 2320 7363 616c 6520 746f 2061 6d70    # scale to amp
+00018f30: 6c69 7475 6465 7320 6f66 2074 6865 2072  litudes of the r
+00018f40: 6566 206d 6170 0a20 2020 2020 2020 2020  ef map.         
+00018f50: 2020 2069 6620 7265 663a 0a20 2020 2020     if ref:.     
+00018f60: 2020 2020 2020 2020 2020 2069 6620 6d66             if mf
+00018f70: 7431 203d 3d20 302e 303a 0a20 2020 2020  t1 == 0.0:.     
+00018f80: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+00018f90: 6f6e 7469 6e75 650a 2020 2020 2020 2020  ontinue.        
+00018fa0: 2020 2020 2020 2020 6674 312e 6675 6c6c          ft1.full
+00018fb0: 4d61 705b 6673 6865 6c6c 7331 5d20 3d20  Map[fshells1] = 
+00018fc0: 7368 656c 6c76 6563 3120 2a20 286d 6674  shellvec1 * (mft
+00018fd0: 3220 2f20 6d66 7431 290a 2020 2020 2020  2 / mft1).      
+00018fe0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+00018ff0: 2020 2020 2020 2020 2020 2020 2320 7265              # re
+00019000: 706c 6163 6520 7769 7468 2061 7667 2061  place with avg a
+00019010: 6d70 6c69 7475 6465 7320 666f 7220 7468  mplitudes for th
+00019020: 6520 7477 6f20 6d61 7073 0a20 2020 2020  e two maps.     
+00019030: 2020 2020 2020 2020 2020 2066 7431 2e66             ft1.f
+00019040: 756c 6c4d 6170 5b66 7368 656c 6c73 315d  ullMap[fshells1]
+00019050: 203d 2073 6865 6c6c 7665 6331 202a 2028   = shellvec1 * (
+00019060: 6d66 7432 202b 206d 6674 3129 202f 2028  mft2 + mft1) / (
+00019070: 3220 2a20 6d66 7431 290a 2020 2020 2020  2 * mft1).      
+00019080: 2020 2020 2020 2020 2020 6674 322e 6675            ft2.fu
+00019090: 6c6c 4d61 705b 6673 6865 6c6c 7332 5d20  llMap[fshells2] 
+000190a0: 3d20 7368 656c 6c76 6563 3220 2a20 286d  = shellvec2 * (m
+000190b0: 6674 3220 2b20 6d66 7431 2920 2f20 2832  ft2 + mft1) / (2
+000190c0: 202a 206d 6674 3229 0a0a 2020 2020 2020   * mft2)..      
+000190d0: 2020 2020 2020 2320 6e65 7720 7261 6469        # new radi
+000190e0: 616c 2061 7665 7261 6765 2028 746f 2063  al average (to c
+000190f0: 6865 636b 290a 2020 2020 2020 2020 2020  heck).          
+00019100: 2020 6d66 7431 203d 206e 702e 6d65 616e    mft1 = np.mean
+00019110: 2861 6273 2866 7431 2e66 756c 6c4d 6170  (abs(ft1.fullMap
+00019120: 5b66 7368 656c 6c73 315d 2929 0a20 2020  [fshells1])).   
+00019130: 2020 2020 2020 2020 2066 7431 5f61 7667           ft1_avg
+00019140: 5f6e 6577 2e61 7070 656e 6428 0a20 2020  _new.append(.   
+00019150: 2020 2020 2020 2020 2020 2020 206e 702e               np.
+00019160: 6c6f 6731 3028 0a20 2020 2020 2020 2020  log10(.         
+00019170: 2020 2020 2020 2020 2020 206e 702e 6d65             np.me
+00019180: 616e 280a 2020 2020 2020 2020 2020 2020  an(.            
+00019190: 2020 2020 2020 2020 2020 2020 6e70 2e73              np.s
+000191a0: 7175 6172 6528 6162 7328 6674 312e 6675  quare(abs(ft1.fu
+000191b0: 6c6c 4d61 705b 6673 6865 6c6c 7331 5d29  llMap[fshells1])
+000191c0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+000191d0: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+000191e0: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+000191f0: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+00019200: 2020 2020 6c66 7265 712e 6170 7065 6e64      lfreq.append
+00019210: 2868 6967 686c 6576 656c 290a 0a20 2020  (highlevel)..   
+00019220: 2020 2020 2020 2020 2073 616d 706c 696e           samplin
+00019230: 675f 6672 7120 3d20 6869 6768 6c65 7665  g_frq = highleve
+00019240: 6c0a 0a20 2020 2020 2020 2020 2020 2063  l..            c
+00019250: 7574 6f66 665f 6672 6571 203d 206d 696e  utoff_freq = min
+00019260: 2828 312e 3020 2f20 7265 736f 2920 2b20  ((1.0 / reso) + 
+00019270: 302e 3235 2c20 6d61 786c 6576 656c 290a  0.25, maxlevel).
+00019280: 0a20 2020 2020 2020 2020 2020 2023 2073  .            # s
+00019290: 6361 6c65 2074 6865 2072 6573 7420 616e  cale the rest an
+000192a0: 6420 6272 6561 6b20 6166 7465 7220 7265  d break after re
+000192b0: 6c65 7661 6e74 2066 7265 7175 656e 6369  levant frequenci
+000192c0: 6573 0a20 2020 2020 2020 2020 2020 2069  es.            i
+000192d0: 6620 7361 6d70 6c69 6e67 5f66 7271 203e  f sampling_frq >
+000192e0: 2063 7574 6f66 665f 6672 6571 3a0a 2020   cutoff_freq:.  
+000192f0: 2020 2020 2020 2020 2020 2020 2020 6673                fs
+00019300: 6865 6c6c 7331 203d 2028 6469 7374 3120  hells1 = (dist1 
+00019310: 3e3d 2068 6967 686c 6576 656c 290a 2020  >= highlevel).  
+00019320: 2020 2020 2020 2020 2020 2020 2020 7368                sh
+00019330: 656c 6c76 6563 3120 3d20 6674 312e 6675  ellvec1 = ft1.fu
+00019340: 6c6c 4d61 705b 6673 6865 6c6c 7331 5d0a  llMap[fshells1].
+00019350: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019360: 6d66 7431 203d 206e 702e 6d65 616e 2861  mft1 = np.mean(a
+00019370: 6273 2873 6865 6c6c 7665 6331 2929 0a20  bs(shellvec1)). 
+00019380: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00019390: 7368 656c 6c73 3220 3d20 2864 6973 7432  shells2 = (dist2
+000193a0: 203e 3d20 6869 6768 6c65 7665 6c29 0a20   >= highlevel). 
+000193b0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+000193c0: 6865 6c6c 7665 6332 203d 2066 7432 2e66  hellvec2 = ft2.f
+000193d0: 756c 6c4d 6170 5b66 7368 656c 6c73 325d  ullMap[fshells2]
+000193e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000193f0: 206d 6674 3220 3d20 6e70 2e6d 6561 6e28   mft2 = np.mean(
+00019400: 6162 7328 7368 656c 6c76 6563 3229 290a  abs(shellvec2)).
+00019410: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019420: 6966 206d 6674 3120 3d3d 2030 2e30 2061  if mft1 == 0.0 a
+00019430: 6e64 206d 6674 3220 3d3d 2030 2e30 3a0a  nd mft2 == 0.0:.
 00019440: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019450: 6674 312e 6675 6c6c 4d61 705b 6673 6865  ft1.fullMap[fshe
-00019460: 6c6c 7331 5d20 3d20 7368 656c 6c76 6563  lls1] = shellvec
-00019470: 312a 286d 6674 322b 6d66 7431 292f 2832  1*(mft2+mft1)/(2
-00019480: 2a6d 6674 3129 0a20 2020 2020 2020 2020  *mft1).         
-00019490: 2020 2020 2020 2020 2020 2066 7432 2e66             ft2.f
-000194a0: 756c 6c4d 6170 5b66 7368 656c 6c73 325d  ullMap[fshells2]
-000194b0: 203d 2073 6865 6c6c 7665 6332 2a28 6d66   = shellvec2*(mf
-000194c0: 7432 2b6d 6674 3129 2f28 322a 6d66 7432  t2+mft1)/(2*mft2
-000194d0: 290a 0a20 2020 2020 2020 2020 2020 2020  )..             
-000194e0: 2020 206d 6674 3120 3d20 6e70 2e6d 6561     mft1 = np.mea
-000194f0: 6e28 6162 7328 6674 312e 6675 6c6c 4d61  n(abs(ft1.fullMa
-00019500: 705b 6673 6865 6c6c 7331 5d29 290a 2020  p[fshells1])).  
-00019510: 2020 2020 2020 2020 2020 2020 2020 6674                ft
-00019520: 315f 6176 675f 6e65 772e 6170 7065 6e64  1_avg_new.append
-00019530: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-00019540: 2020 2020 2020 6e70 2e6c 6f67 3130 280a        np.log10(.
+00019450: 2020 2020 6272 6561 6b0a 2020 2020 2020      break.      
+00019460: 2020 2020 2020 2020 2020 6674 315f 6176            ft1_av
+00019470: 672e 6170 7065 6e64 286e 702e 6c6f 6731  g.append(np.log1
+00019480: 3028 6e70 2e6d 6561 6e28 6e70 2e73 7175  0(np.mean(np.squ
+00019490: 6172 6528 6162 7328 7368 656c 6c76 6563  are(abs(shellvec
+000194a0: 3129 2929 2929 0a20 2020 2020 2020 2020  1))))).         
+000194b0: 2020 2020 2020 2066 7432 5f61 7667 2e61         ft2_avg.a
+000194c0: 7070 656e 6428 6e70 2e6c 6f67 3130 286e  ppend(np.log10(n
+000194d0: 702e 6d65 616e 286e 702e 7371 7561 7265  p.mean(np.square
+000194e0: 2861 6273 2873 6865 6c6c 7665 6332 2929  (abs(shellvec2))
+000194f0: 2929 290a 0a20 2020 2020 2020 2020 2020  )))..           
+00019500: 2020 2020 2069 6620 7265 663a 0a20 2020       if ref:.   
+00019510: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019520: 2069 6620 6d66 7431 203d 3d20 302e 303a   if mft1 == 0.0:
+00019530: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00019540: 2020 2020 2020 2020 2062 7265 616b 0a20           break. 
 00019550: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019560: 2020 2020 2020 2020 6e70 2e6d 6561 6e28          np.mean(
-00019570: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00019580: 2020 2020 2020 2020 2020 2020 206e 702e               np.
-00019590: 7371 7561 7265 2861 6273 2866 7431 2e66  square(abs(ft1.f
-000195a0: 756c 6c4d 6170 5b66 7368 656c 6c73 315d  ullMap[fshells1]
-000195b0: 2929 0a20 2020 2020 2020 2020 2020 2020  )).             
-000195c0: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
-000195d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000195e0: 2029 0a20 2020 2020 2020 2020 2020 2020   ).             
-000195f0: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
-00019600: 2020 2020 206c 6672 6571 2e61 7070 656e       lfreq.appen
-00019610: 6428 2868 6967 686c 6576 656c 202b 2073  d((highlevel + s
-00019620: 7465 7020 2f20 3229 290a 2020 2020 2020  tep / 2)).      
-00019630: 2020 2020 2020 2020 2020 6272 6561 6b0a            break.
-00019640: 2020 2020 2020 2020 2020 2020 7820 3d20              x = 
-00019650: 6869 6768 6c65 7665 6c0a 2020 2020 2020  highlevel.      
-00019660: 2020 2020 2020 6869 6768 6c65 7665 6c20        highlevel 
-00019670: 3d20 7820 2b20 7374 6570 0a20 2020 2020  = x + step.     
-00019680: 2020 2023 206c 6f77 2070 6173 7320 6669     # low pass fi
-00019690: 6c74 6572 2061 6674 6572 3f0a 2020 2020  lter after?.    
-000196a0: 2020 2020 2320 6c6f 7720 7061 7373 2066      # low pass f
-000196b0: 696c 7465 7220 6265 666f 7265 2073 6361  ilter before sca
-000196c0: 6c69 6e67 0a20 2020 2020 2020 2069 6620  ling.        if 
-000196d0: 7265 736f 2069 7320 6e6f 7420 4e6f 6e65  reso is not None
-000196e0: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
-000196f0: 206c 7066 696c 7461 2061 6e64 206e 6f74   lpfilta and not
-00019700: 206c 7066 696c 7462 3a0a 2020 2020 2020   lpfiltb:.      
-00019710: 2020 2020 2020 2020 2020 6674 312e 5f74            ft1._t
-00019720: 616e 685f 6c6f 7770 6173 7328 6375 746f  anh_lowpass(cuto
-00019730: 6666 312c 2066 616c 6c3d 302e 322c 2066  ff1, fall=0.2, f
-00019740: 746d 6170 3d54 7275 6529 0a20 2020 2020  tmap=True).     
-00019750: 2020 2020 2020 2020 2020 2066 7432 2e5f             ft2._
-00019760: 7461 6e68 5f6c 6f77 7061 7373 2863 7574  tanh_lowpass(cut
-00019770: 6f66 6632 2c20 6661 6c6c 3d30 2e32 2c20  off2, fall=0.2, 
-00019780: 6674 6d61 703d 5472 7565 290a 2020 2020  ftmap=True).    
-00019790: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
-000197a0: 2020 2020 2069 6620 7079 6666 7477 5f66       if pyfftw_f
-000197b0: 6c61 6720 3d3d 2030 3a0a 2020 2020 2020  lag == 0:.      
-000197c0: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
-000197d0: 496d 706f 7274 4572 726f 720a 2020 2020  ImportError.    
-000197e0: 2020 2020 2020 2020 6966 6674 203d 2070          ifft = p
-000197f0: 7966 6674 772e 4646 5457 280a 2020 2020  yfftw.FFTW(.    
-00019800: 2020 2020 2020 2020 2020 2020 696e 7075              inpu
-00019810: 7461 312c 0a20 2020 2020 2020 2020 2020  ta1,.           
-00019820: 2020 2020 206f 7574 7075 7461 312c 0a20       outputa1,. 
-00019830: 2020 2020 2020 2020 2020 2020 2020 2064                 d
-00019840: 6972 6563 7469 6f6e 3d27 4646 5457 5f42  irection='FFTW_B
-00019850: 4143 4b57 4152 4427 2c0a 2020 2020 2020  ACKWARD',.      
-00019860: 2020 2020 2020 2020 2020 6178 6573 3d28            axes=(
-00019870: 302c 2031 2c20 3229 2c0a 2020 2020 2020  0, 1, 2),.      
-00019880: 2020 2020 2020 2020 2020 666c 6167 733d            flags=
-00019890: 5b27 4646 5457 5f45 5354 494d 4154 4527  ['FFTW_ESTIMATE'
-000198a0: 5d2c 0a20 2020 2020 2020 2020 2020 2029  ],.            )
-000198b0: 0a20 2020 2020 2020 2020 2020 2069 6e70  .            inp
-000198c0: 7574 6131 5b3a 2c20 3a2c 203a 5d20 3d20  uta1[:, :, :] = 
-000198d0: 6966 6674 7368 6966 7428 6674 312e 6675  ifftshift(ft1.fu
-000198e0: 6c6c 4d61 7029 5b3a 2c20 3a2c 203a 5d0a  llMap)[:, :, :].
-000198f0: 2020 2020 2020 2020 2020 2020 6966 6674              ifft
-00019900: 2829 0a20 2020 2020 2020 2020 2020 206d  ().            m
-00019910: 6170 315f 6669 6c74 203d 204d 6170 280a  ap1_filt = Map(.
-00019920: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019930: 6f75 7470 7574 6131 2e72 6561 6c2e 6173  outputa1.real.as
-00019940: 7479 7065 2827 666c 6f61 7427 292c 0a20  type('float'),. 
-00019950: 2020 2020 2020 2020 2020 2020 2020 206d                 m
-00019960: 6170 5f31 2e6f 7269 6769 6e2c 0a20 2020  ap_1.origin,.   
-00019970: 2020 2020 2020 2020 2020 2020 206d 6170               map
-00019980: 5f31 2e61 7069 782c 0a20 2020 2020 2020  _1.apix,.       
-00019990: 2020 2020 2020 2020 206d 6170 5f31 2e66           map_1.f
-000199a0: 696c 656e 616d 652c 0a20 2020 2020 2020  ilename,.       
-000199b0: 2020 2020 2020 2020 206d 6170 5f31 2e68           map_1.h
-000199c0: 6561 6465 725b 3a5d 2c0a 2020 2020 2020  eader[:],.      
-000199d0: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-000199e0: 6578 6365 7074 2045 7863 6570 7469 6f6e  except Exception
-000199f0: 3a0a 2020 2020 2020 2020 2020 2020 2320  :.            # 
-00019a00: 7573 6520 6e75 6d70 7920 6966 6674 2069  use numpy ifft i
-00019a10: 6e73 7465 6164 0a20 2020 2020 2020 2020  nstead.         
-00019a20: 2020 206d 6170 315f 6669 6c74 203d 206d     map1_filt = m
-00019a30: 6170 5f31 2e63 6f70 7928 290a 2020 2020  ap_1.copy().    
-00019a40: 2020 2020 2020 2020 6d61 7031 5f66 696c          map1_fil
-00019a50: 742e 6675 6c6c 4d61 7020 3d20 6e70 2e72  t.fullMap = np.r
-00019a60: 6561 6c28 6966 6674 6e28 6966 6674 7368  eal(ifftn(ifftsh
-00019a70: 6966 7428 6674 312e 6675 6c6c 4d61 7029  ift(ft1.fullMap)
-00019a80: 2929 0a20 2020 2020 2020 2074 7279 3a0a  )).        try:.
-00019a90: 2020 2020 2020 2020 2020 2020 6966 2070              if p
-00019aa0: 7966 6674 775f 666c 6167 203d 3d20 303a  yfftw_flag == 0:
-00019ab0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00019ac0: 2072 6169 7365 2049 6d70 6f72 7445 7272   raise ImportErr
-00019ad0: 6f72 0a20 2020 2020 2020 2020 2020 2069  or.            i
-00019ae0: 6666 7420 3d20 7079 6666 7477 2e46 4654  fft = pyfftw.FFT
-00019af0: 5728 0a20 2020 2020 2020 2020 2020 2020  W(.             
-00019b00: 2020 2069 6e70 7574 6132 2c0a 2020 2020     inputa2,.    
-00019b10: 2020 2020 2020 2020 2020 2020 6f75 7470              outp
-00019b20: 7574 6132 2c0a 2020 2020 2020 2020 2020  uta2,.          
-00019b30: 2020 2020 2020 6469 7265 6374 696f 6e3d        direction=
-00019b40: 2746 4654 575f 4241 434b 5741 5244 272c  'FFTW_BACKWARD',
-00019b50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00019b60: 2061 7865 733d 2830 2c20 312c 2032 292c   axes=(0, 1, 2),
-00019b70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00019b80: 2066 6c61 6773 3d5b 2746 4654 575f 4553   flags=['FFTW_ES
-00019b90: 5449 4d41 5445 275d 2c0a 2020 2020 2020  TIMATE'],.      
-00019ba0: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-00019bb0: 2020 2020 696e 7075 7461 325b 3a2c 203a      inputa2[:, :
-00019bc0: 2c20 3a5d 203d 2069 6666 7473 6869 6674  , :] = ifftshift
-00019bd0: 2866 7432 2e66 756c 6c4d 6170 295b 3a2c  (ft2.fullMap)[:,
-00019be0: 203a 2c20 3a5d 0a20 2020 2020 2020 2020   :, :].         
-00019bf0: 2020 2069 6666 7428 290a 2020 2020 2020     ifft().      
-00019c00: 2020 2020 2020 6d61 7032 5f66 696c 7420        map2_filt 
-00019c10: 3d20 4d61 7028 0a20 2020 2020 2020 2020  = Map(.         
-00019c20: 2020 2020 2020 206f 7574 7075 7461 322e         outputa2.
-00019c30: 7265 616c 2e61 7374 7970 6528 2766 6c6f  real.astype('flo
-00019c40: 6174 2729 2c0a 2020 2020 2020 2020 2020  at'),.          
-00019c50: 2020 2020 2020 6d61 705f 322e 6f72 6967        map_2.orig
-00019c60: 696e 2c0a 2020 2020 2020 2020 2020 2020  in,.            
-00019c70: 2020 2020 6d61 705f 322e 6170 6978 2c0a      map_2.apix,.
-00019c80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019c90: 6d61 705f 322e 6669 6c65 6e61 6d65 2c0a  map_2.filename,.
-00019ca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019cb0: 6d61 705f 322e 6865 6164 6572 5b3a 5d2c  map_2.header[:],
-00019cc0: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
-00019cd0: 2020 2020 2020 2065 7863 6570 7420 4578         except Ex
-00019ce0: 6365 7074 696f 6e3a 0a20 2020 2020 2020  ception:.       
-00019cf0: 2020 2020 206d 6170 325f 6669 6c74 203d       map2_filt =
-00019d00: 206d 6170 5f32 2e63 6f70 7928 290a 2020   map_2.copy().  
-00019d10: 2020 2020 2020 2020 2020 6d61 7032 5f66            map2_f
-00019d20: 696c 742e 6675 6c6c 4d61 7020 3d20 6e70  ilt.fullMap = np
-00019d30: 2e72 6561 6c28 6966 6674 6e28 6966 6674  .real(ifftn(ifft
-00019d40: 7368 6966 7428 6674 322e 6675 6c6c 4d61  shift(ft2.fullMa
-00019d50: 7029 2929 0a20 2020 2020 2020 2074 7279  p))).        try
-00019d60: 3a0a 2020 2020 2020 2020 2020 2020 696d  :.            im
-00019d70: 706f 7274 206d 6174 706c 6f74 6c69 620a  port matplotlib.
-00019d80: 2020 2020 2020 2020 2020 2020 6d61 7470              matp
-00019d90: 6c6f 746c 6962 2e75 7365 2827 4167 6727  lotlib.use('Agg'
-00019da0: 290a 2020 2020 2020 2020 2020 2020 696d  ).            im
-00019db0: 706f 7274 206d 6174 706c 6f74 6c69 622e  port matplotlib.
-00019dc0: 7079 706c 6f74 2061 7320 706c 740a 2020  pyplot as plt.  
-00019dd0: 2020 2020 2020 2020 2020 6672 6f6d 206d            from m
-00019de0: 6174 706c 6f74 6c69 6220 696d 706f 7274  atplotlib import
-00019df0: 2070 796c 6162 0a20 2020 2020 2020 2020   pylab.         
-00019e00: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
-00019e10: 2020 2020 2020 2020 706c 742e 7374 796c          plt.styl
-00019e20: 652e 7573 6528 2767 6770 6c6f 7427 290a  e.use('ggplot').
-00019e30: 2020 2020 2020 2020 2020 2020 6578 6365              exce
-00019e40: 7074 2041 7474 7269 6275 7465 4572 726f  pt AttributeErro
-00019e50: 723a 0a20 2020 2020 2020 2020 2020 2020  r:.             
-00019e60: 2020 2070 6173 730a 2020 2020 2020 2020     pass.        
-00019e70: 2020 2020 706c 742e 7263 5061 7261 6d73      plt.rcParams
-00019e80: 2e75 7064 6174 6528 7b27 666f 6e74 2e73  .update({'font.s
-00019e90: 697a 6527 3a20 3138 7d29 0a20 2020 2020  ize': 18}).     
-00019ea0: 2020 2020 2020 2070 6c74 2e72 6350 6172         plt.rcPar
-00019eb0: 616d 732e 7570 6461 7465 287b 276c 6567  ams.update({'leg
-00019ec0: 656e 642e 666f 6e74 7369 7a65 273a 2031  end.fontsize': 1
-00019ed0: 387d 290a 2020 2020 2020 2020 2020 2020  8}).            
-00019ee0: 706c 742e 706c 6f74 286c 6672 6571 2c20  plt.plot(lfreq, 
-00019ef0: 6674 315f 6176 672c 2027 722d 2d27 2c20  ft1_avg, 'r--', 
-00019f00: 6c61 6265 6c3d 276d 6170 3127 290a 2020  label='map1').  
-00019f10: 2020 2020 2020 2020 2020 706c 742e 706c            plt.pl
-00019f20: 6f74 286c 6672 6571 2c20 6674 325f 6176  ot(lfreq, ft2_av
-00019f30: 672c 2027 6273 272c 206c 6162 656c 3d27  g, 'bs', label='
-00019f40: 6d61 7032 2729 0a20 2020 2020 2020 2020  map2').         
-00019f50: 2020 2070 6c74 2e70 6c6f 7428 6c66 7265     plt.plot(lfre
-00019f60: 712c 2066 7431 5f61 7667 5f6e 6577 2c20  q, ft1_avg_new, 
-00019f70: 2767 5e27 2c20 6c61 6265 6c3d 2773 6361  'g^', label='sca
-00019f80: 6c65 6427 290a 2020 2020 2020 2020 2020  led').          
-00019f90: 2020 6c65 6720 3d20 706c 742e 6c65 6765    leg = plt.lege
-00019fa0: 6e64 286c 6f63 3d27 7570 7065 7220 7269  nd(loc='upper ri
-00019fb0: 6768 7427 290a 2020 2020 2020 2020 2020  ght').          
-00019fc0: 2020 666f 7220 6c65 676f 626a 2069 6e20    for legobj in 
-00019fd0: 6c65 672e 6c65 6765 6e64 4861 6e64 6c65  leg.legendHandle
-00019fe0: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
-00019ff0: 2020 206c 6567 6f62 6a2e 7365 745f 6c69     legobj.set_li
-0001a000: 6e65 7769 6474 6828 322e 3029 0a20 2020  newidth(2.0).   
-0001a010: 2020 2020 2020 2020 2070 796c 6162 2e73           pylab.s
-0001a020: 6176 6566 6967 2822 7370 6563 7472 612e  avefig("spectra.
-0001a030: 706e 6722 290a 2020 2020 2020 2020 2020  png").          
-0001a040: 2020 706c 742e 636c 6f73 6528 290a 2020    plt.close().  
-0001a050: 2020 2020 2020 6578 6365 7074 2045 7863        except Exc
-0001a060: 6570 7469 6f6e 3a0a 2020 2020 2020 2020  eption:.        
-0001a070: 2020 2020 7061 7373 0a20 2020 2020 2020      pass.       
-0001a080: 2072 6574 7572 6e20 6d61 7031 5f66 696c   return map1_fil
-0001a090: 742e 6675 6c6c 4d61 702c 206d 6170 325f  t.fullMap, map2_
-0001a0a0: 6669 6c74 2e66 756c 6c4d 6170 0a0a 2020  filt.fullMap..  
-0001a0b0: 2020 6465 6620 6765 745f 636c 6173 685f    def get_clash_
-0001a0c0: 6d61 7028 7365 6c66 2c20 656d 6d61 702c  map(self, emmap,
-0001a0d0: 2061 7069 7829 3a0a 2020 2020 2020 2020   apix):.        
-0001a0e0: 7465 6d70 6c61 7465 5f67 7269 6420 3d20  template_grid = 
-0001a0f0: 656d 6d61 702e 5f6d 616b 655f 636c 6173  emmap._make_clas
-0001a100: 685f 6d61 7028 6170 6978 290a 2020 2020  h_map(apix).    
-0001a110: 2020 2020 7265 7475 726e 2074 656d 706c      return templ
-0001a120: 6174 655f 6772 6964 0a0a 2020 2020 6465  ate_grid..    de
-0001a130: 6620 6765 745f 736d 5f73 636f 7265 280a  f get_sm_score(.
-0001a140: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-0001a150: 2c0a 2020 2020 2020 2020 2020 2020 7374  ,.            st
-0001a160: 7275 6374 2c0a 2020 2020 2020 2020 2020  ruct,.          
-0001a170: 2020 6e63 6f6d 702c 0a20 2020 2020 2020    ncomp,.       
-0001a180: 2020 2020 2074 656d 706c 6174 655f 6772       template_gr
-0001a190: 6964 2c0a 2020 2020 2020 2020 2020 2020  id,.            
-0001a1a0: 6376 6f6c 2c0a 2020 2020 2020 2020 2020  cvol,.          
-0001a1b0: 2020 6170 6978 2c0a 2020 2020 293a 0a20    apix,.    ):. 
-0001a1c0: 2020 2020 2020 2022 2222 4361 6c63 756c         """Calcul
-0001a1d0: 6174 6520 7468 6520 636c 6173 6820 7363  ate the clash sc
-0001a1e0: 6f72 6520 6265 7477 6565 6e20 6368 6169  ore between chai
-0001a1f0: 6e73 2077 6974 6869 6e20 6120 7072 6f74  ns within a prot
-0001a200: 6569 6e20 6d6f 6465 6c0a 0a20 2020 2020  ein model..     
-0001a210: 2020 2054 6865 2063 6c61 7368 2073 636f     The clash sco
-0001a220: 7265 2063 616c 6375 6c61 7465 7320 7468  re calculates th
-0001a230: 6520 616d 6f75 6e74 2074 6861 7420 6368  e amount that ch
-0001a240: 6169 6e73 2069 6e20 6120 7072 6f74 6569  ains in a protei
-0001a250: 6e20 6f76 6572 6c61 700a 2020 2020 2020  n overlap.      
-0001a260: 2020 6f6e 6520 616e 6f74 6865 722e 2054    one another. T
-0001a270: 6865 2073 7472 7563 7475 7265 2069 7320  he structure is 
-0001a280: 6d61 7070 6564 2069 6e74 6f20 6469 7363  mapped into disc
-0001a290: 7265 7465 2062 696e 7320 696e 2033 4420  rete bins in 3D 
-0001a2a0: 7370 6163 652c 0a20 2020 2020 2020 2064  space,.        d
-0001a2b0: 6566 696e 6564 2062 7920 7468 6520 7465  efined by the te
-0001a2c0: 6d70 6c61 7465 5f67 7269 6420 696e 7075  mplate_grid inpu
-0001a2d0: 742e 2054 6865 2073 636f 7265 2069 7320  t. The score is 
-0001a2e0: 7072 6f70 6f72 7469 6f6e 616c 2074 6f20  proportional to 
-0001a2f0: 7468 650a 2020 2020 2020 2020 6e75 6d62  the.        numb
-0001a300: 6572 206f 6620 7468 6573 6520 6269 6e73  er of these bins
-0001a310: 206f 6363 7570 6965 6420 6279 206d 6f72   occupied by mor
-0001a320: 6520 7468 616e 206f 6e65 206f 6620 7468  e than one of th
-0001a330: 6520 7072 6f74 6569 6e20 6368 6169 6e73  e protein chains
-0001a340: 2e0a 0a20 2020 2020 2020 2052 6563 6f6d  ...        Recom
-0001a350: 6d65 6e64 6564 2070 6978 656c 2073 7061  mended pixel spa
-0001a360: 6369 6e67 206f 6620 7468 6520 7465 6d70  cing of the temp
-0001a370: 6c61 7465 5f67 7269 6420 6973 2033 2e35  late_grid is 3.5
-0001a380: 20c3 852e 0a0a 2020 2020 2020 2020 4172   .....        Ar
-0001a390: 6773 3a0a 2020 2020 2020 2020 2020 2020  gs:.            
-0001a3a0: 7374 7275 6374 3a20 5374 7275 6374 7572  struct: Structur
-0001a3b0: 6520 696e 7374 616e 6365 2e0a 2020 2020  e instance..    
-0001a3c0: 2020 2020 2020 2020 6e63 6f6d 703a 204e          ncomp: N
-0001a3d0: 756d 6265 7220 6f66 2063 6861 696e 7320  umber of chains 
-0001a3e0: 696e 2074 6865 2073 7472 7563 7475 7265  in the structure
-0001a3f0: 2e0a 2020 2020 2020 2020 2020 2020 7465  ..            te
-0001a400: 6d70 6c61 7465 5f67 7269 643a 204d 6170  mplate_grid: Map
-0001a410: 206f 626a 6563 7420 7769 7468 2065 6d70   object with emp
-0001a420: 7479 2033 442d 6772 6964 2028 6669 6c6c  ty 3D-grid (fill
-0001a430: 6564 2077 6974 6820 7a65 726f 7329 2e0a  ed with zeros)..
-0001a440: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a450: 5468 6973 2063 616e 2062 6520 6361 6c63  This can be calc
-0001a460: 756c 6174 6564 2075 7369 6e67 0a20 2020  ulated using.   
-0001a470: 2020 2020 2020 2020 2020 2020 203a 6d65               :me
-0001a480: 7468 3a60 5374 7275 6374 7572 6542 6c75  th:`StructureBlu
-0001a490: 7272 6572 2e70 726f 744d 6170 203c 5445  rrer.protMap <TE
-0001a4a0: 4d50 792e 7072 6f74 6569 6e2e 7374 7275  MPy.protein.stru
-0001a4b0: 6374 7572 655f 626c 7572 7265 722e 5374  cture_blurrer.St
-0001a4c0: 7275 6374 7572 6542 6c75 7272 6572 2e70  ructureBlurrer.p
-0001a4d0: 726f 744d 6170 3e60 0a20 2020 2020 2020  rotMap>`.       
-0001a4e0: 2020 2020 2063 766f 6c3a 204c 6973 7420       cvol: List 
-0001a4f0: 636f 6e74 6169 6e69 6e67 2074 6865 2076  containing the v
-0001a500: 6f6c 756d 6520 6f66 2065 6163 6820 6368  olume of each ch
-0001a510: 6169 6e2e 2054 6869 7320 6361 6e20 6265  ain. This can be
-0001a520: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001a530: 2063 616c 6375 6c61 7465 6420 7573 696e   calculated usin
-0001a540: 670a 2020 2020 2020 2020 2020 2020 2020  g.              
-0001a550: 2020 3a6d 6574 683a 604d 6170 2e5f 6765    :meth:`Map._ge
-0001a560: 745f 636f 6d70 6f6e 656e 745f 766f 6c75  t_component_volu
-0001a570: 6d65 7320 3c54 454d 5079 2e6d 6170 732e  mes <TEMPy.maps.
-0001a580: 656d 5f6d 6170 2e4d 6170 2e5f 6765 745f  em_map.Map._get_
-0001a590: 636f 6d70 6f6e 656e 745f 766f 6c75 6d65  component_volume
-0001a5a0: 733e 600a 2020 2020 2020 2020 2020 2020  s>`.            
-0001a5b0: 6170 6978 3a20 5069 7865 6c20 7369 7a65  apix: Pixel size
-0001a5c0: 206f 6620 7465 6d70 6c61 7465 5f67 7269   of template_gri
-0001a5d0: 642c 2075 7365 6420 666f 7220 7363 616c  d, used for scal
-0001a5e0: 696e 6720 7468 6520 766f 6c75 6d65 0a20  ing the volume. 
-0001a5f0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-0001a600: 616c 6375 6c61 7469 6f6e 732e 0a0a 2020  alculations...  
-0001a610: 2020 2020 2020 5265 7475 726e 733a 0a20        Returns:. 
-0001a620: 2020 2020 2020 2020 2020 2054 6865 2063             The c
-0001a630: 6c61 7368 2073 636f 7265 2066 6f72 2074  lash score for t
-0001a640: 6865 2073 7472 7563 7475 7265 2028 636c  he structure (cl
-0001a650: 6f73 6520 746f 2030 2069 7320 676f 6f64  ose to 0 is good
-0001a660: 2c20 6c61 7267 650a 2020 2020 2020 2020  , large.        
-0001a670: 2020 2020 6e65 6761 7469 7665 2073 636f      negative sco
-0001a680: 7265 2069 7320 6261 6429 0a20 2020 2020  re is bad).     
-0001a690: 2020 2022 2222 0a20 2020 2020 2020 206f     """.        o
-0001a6a0: 7665 726c 6179 5f6d 6170 6c69 7374 203d  verlay_maplist =
-0001a6b0: 205b 5d0a 2020 2020 2020 2020 6f76 6572   [].        over
-0001a6c0: 6c61 795f 6d61 706c 6973 7420 3d20 7365  lay_maplist = se
-0001a6d0: 6c66 2e67 6574 5f6f 7665 726c 6179 5f63  lf.get_overlay_c
-0001a6e0: 6f6d 705f 6d61 706c 6973 7428 7374 7275  omp_maplist(stru
-0001a6f0: 6374 2c20 7465 6d70 6c61 7465 5f67 7269  ct, template_gri
-0001a700: 6429 0a20 2020 2020 2020 206e 6320 3d20  d).        nc = 
-0001a710: 7261 6e67 6528 6e63 6f6d 7029 0a20 2020  range(ncomp).   
-0001a720: 2020 2020 2063 7061 6972 203d 206c 6973       cpair = lis
-0001a730: 7428 6974 6572 746f 6f6c 732e 636f 6d62  t(itertools.comb
-0001a740: 696e 6174 696f 6e73 286e 632c 2032 2929  inations(nc, 2))
-0001a750: 0a20 2020 2020 2020 2073 636f 7265 203d  .        score =
-0001a760: 2030 2e30 0a20 2020 2020 2020 206e 5f6f   0.0.        n_o
-0001a770: 7665 726c 6170 5f76 6f78 656c 203d 2030  verlap_voxel = 0
-0001a780: 0a20 2020 2020 2020 206f 7665 726c 6170  .        overlap
-0001a790: 5f76 6f6c 756d 6520 3d20 302e 300a 2020  _volume = 0.0.  
-0001a7a0: 2020 2020 2020 666f 7220 6920 696e 2063        for i in c
-0001a7b0: 7061 6972 3a0a 2020 2020 2020 2020 2020  pair:.          
-0001a7c0: 2020 6e5f 6f76 6572 6c61 705f 766f 7865    n_overlap_voxe
-0001a7d0: 6c20 3d20 280a 2020 2020 2020 2020 2020  l = (.          
-0001a7e0: 2020 2020 2020 2020 2020 6f76 6572 6c61            overla
-0001a7f0: 795f 6d61 706c 6973 745b 695b 305d 5d2e  y_maplist[i[0]].
-0001a800: 6675 6c6c 4d61 7020 2a0a 2020 2020 2020  fullMap *.      
-0001a810: 2020 2020 2020 2020 2020 2020 2020 6f76                ov
-0001a820: 6572 6c61 795f 6d61 706c 6973 745b 695b  erlay_maplist[i[
-0001a830: 315d 5d2e 6675 6c6c 4d61 700a 2020 2020  1]].fullMap.    
-0001a840: 2020 2020 2020 2020 292e 7375 6d28 290a          ).sum().
-0001a850: 2020 2020 2020 2020 2020 2020 6f76 6572              over
-0001a860: 6c61 705f 766f 6c75 6d65 203d 2028 2861  lap_volume = ((a
-0001a870: 7069 782e 7072 6f64 2829 2920 2a20 6e5f  pix.prod()) * n_
-0001a880: 6f76 6572 6c61 705f 766f 7865 6c29 202a  overlap_voxel) *
-0001a890: 2032 0a20 2020 2020 2020 2020 2020 2063   2.            c
-0001a8a0: 6c61 7368 5f70 6572 6365 6e74 203d 2028  lash_percent = (
-0001a8b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001a8c0: 2066 6c6f 6174 286f 7665 726c 6170 5f76   float(overlap_v
-0001a8d0: 6f6c 756d 6520 2f20 2863 766f 6c5b 695b  olume / (cvol[i[
-0001a8e0: 305d 5d20 2b20 6376 6f6c 5b69 5b31 5d5d  0]] + cvol[i[1]]
-0001a8f0: 2929 0a20 2020 2020 2020 2020 2020 2029  )).            )
-0001a900: 0a20 2020 2020 2020 2020 2020 2073 636f  .            sco
-0001a910: 7265 203d 2073 636f 7265 202b 2063 6c61  re = score + cla
-0001a920: 7368 5f70 6572 6365 6e74 0a20 2020 2020  sh_percent.     
-0001a930: 2020 2072 6574 7572 6e20 2d28 7363 6f72     return -(scor
-0001a940: 6529 0a0a 2020 2020 6465 6620 6765 745f  e)..    def get_
-0001a950: 6f76 6572 6c61 795f 636f 6d70 5f6d 6170  overlay_comp_map
-0001a960: 6c69 7374 2873 656c 662c 2073 7472 7563  list(self, struc
-0001a970: 742c 2074 656d 706c 6174 655f 6772 6964  t, template_grid
-0001a980: 293a 0a20 2020 2020 2020 2062 6c75 7272  ):.        blurr
-0001a990: 6572 203d 2053 7472 7563 7475 7265 426c  er = StructureBl
-0001a9a0: 7572 7265 7228 290a 2020 2020 2020 2020  urrer().        
-0001a9b0: 6f76 6572 6c61 795f 6d61 706c 6973 7420  overlay_maplist 
-0001a9c0: 3d20 5b5d 0a20 2020 2020 2020 2073 7370  = [].        ssp
-0001a9d0: 6c69 7420 3d20 7374 7275 6374 2e73 706c  lit = struct.spl
-0001a9e0: 6974 5f69 6e74 6f5f 6368 6169 6e73 2829  it_into_chains()
-0001a9f0: 0a20 2020 2020 2020 2066 6f72 2078 2069  .        for x i
-0001aa00: 6e20 7373 706c 6974 3a0a 2020 2020 2020  n ssplit:.      
-0001aa10: 2020 2020 2020 6f76 6572 6c61 795f 6d61        overlay_ma
-0001aa20: 706c 6973 742e 6170 7065 6e64 280a 2020  plist.append(.  
-0001aa30: 2020 2020 2020 2020 2020 2020 2020 626c                bl
-0001aa40: 7572 7265 722e 6d61 6b65 5f61 746f 6d5f  urrer.make_atom_
-0001aa50: 6f76 6572 6c61 795f 6d61 7031 280a 2020  overlay_map1(.  
-0001aa60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001aa70: 2020 7465 6d70 6c61 7465 5f67 7269 642c    template_grid,
-0001aa80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001aa90: 2020 2020 2078 2c0a 2020 2020 2020 2020       x,.        
-0001aaa0: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-0001aab0: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-0001aac0: 7265 7475 726e 206f 7665 726c 6179 5f6d  return overlay_m
-0001aad0: 6170 6c69 7374 0a0a 2020 2020 6465 6620  aplist..    def 
-0001aae0: 6361 6c63 756c 6174 655f 616c 6370 7328  calculate_alcps(
-0001aaf0: 7365 6c66 2c20 7265 665f 6368 6169 6e2c  self, ref_chain,
-0001ab00: 2070 726f 6265 5f63 6861 696e 293a 0a20   probe_chain):. 
-0001ab10: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
-0001ab20: 2020 2043 616c 6375 6c61 7465 2074 6865     Calculate the
-0001ab30: 2041 7263 204c 656e 6774 6820 436f 6d70   Arc Length Comp
-0001ab40: 6f6e 656e 7420 506c 6163 656d 656e 7420  onent Placement 
-0001ab50: 5363 6f72 6520 6265 7477 6565 6e20 7477  Score between tw
-0001ab60: 6f20 6d6f 6465 6c73 2e0a 2020 2020 2020  o models..      
-0001ab70: 2020 4765 6e65 7261 6c6c 792c 2074 6869    Generally, thi
-0001ab80: 7320 7363 6f72 6520 6973 2063 616c 6375  s score is calcu
-0001ab90: 6c61 7465 6420 6265 7477 6565 6e20 696e  lated between in
-0001aba0: 6469 7669 6475 616c 2063 6861 696e 7320  dividual chains 
-0001abb0: 696e 2061 0a20 2020 2020 2020 2073 7472  in a.        str
-0001abc0: 7563 7475 7265 2e0a 0a20 2020 2020 2020  ucture...       
-0001abd0: 2049 6e70 7574 733a 0a20 2020 2020 2020   Inputs:.       
-0001abe0: 2020 2020 2072 6566 5f63 6861 696e 3a0a       ref_chain:.
+00019560: 2020 2066 7431 2e66 756c 6c4d 6170 5b66     ft1.fullMap[f
+00019570: 7368 656c 6c73 315d 203d 2073 6865 6c6c  shells1] = shell
+00019580: 7665 6331 2a28 6d66 7432 2f6d 6674 3129  vec1*(mft2/mft1)
+00019590: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000195a0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+000195b0: 2020 2020 2020 2020 2020 2066 7431 2e66             ft1.f
+000195c0: 756c 6c4d 6170 5b66 7368 656c 6c73 315d  ullMap[fshells1]
+000195d0: 203d 2073 6865 6c6c 7665 6331 2a28 6d66   = shellvec1*(mf
+000195e0: 7432 2b6d 6674 3129 2f28 322a 6d66 7431  t2+mft1)/(2*mft1
+000195f0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00019600: 2020 2020 2020 6674 322e 6675 6c6c 4d61        ft2.fullMa
+00019610: 705b 6673 6865 6c6c 7332 5d20 3d20 7368  p[fshells2] = sh
+00019620: 656c 6c76 6563 322a 286d 6674 322b 6d66  ellvec2*(mft2+mf
+00019630: 7431 292f 2832 2a6d 6674 3229 0a0a 2020  t1)/(2*mft2)..  
+00019640: 2020 2020 2020 2020 2020 2020 2020 6d66                mf
+00019650: 7431 203d 206e 702e 6d65 616e 2861 6273  t1 = np.mean(abs
+00019660: 2866 7431 2e66 756c 6c4d 6170 5b66 7368  (ft1.fullMap[fsh
+00019670: 656c 6c73 315d 2929 0a20 2020 2020 2020  ells1])).       
+00019680: 2020 2020 2020 2020 2066 7431 5f61 7667           ft1_avg
+00019690: 5f6e 6577 2e61 7070 656e 6428 0a20 2020  _new.append(.   
+000196a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000196b0: 206e 702e 6c6f 6731 3028 0a20 2020 2020   np.log10(.     
+000196c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000196d0: 2020 206e 702e 6d65 616e 280a 2020 2020     np.mean(.    
+000196e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000196f0: 2020 2020 2020 2020 6e70 2e73 7175 6172          np.squar
+00019700: 6528 6162 7328 6674 312e 6675 6c6c 4d61  e(abs(ft1.fullMa
+00019710: 705b 6673 6865 6c6c 7331 5d29 290a 2020  p[fshells1])).  
+00019720: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019730: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+00019740: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+00019750: 2020 2020 2020 2020 2020 2020 2020 290a                ).
+00019760: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019770: 6c66 7265 712e 6170 7065 6e64 2828 6869  lfreq.append((hi
+00019780: 6768 6c65 7665 6c20 2b20 7374 6570 202f  ghlevel + step /
+00019790: 2032 2929 0a20 2020 2020 2020 2020 2020   2)).           
+000197a0: 2020 2020 2062 7265 616b 0a20 2020 2020       break.     
+000197b0: 2020 2020 2020 2078 203d 2068 6967 686c         x = highl
+000197c0: 6576 656c 0a20 2020 2020 2020 2020 2020  evel.           
+000197d0: 2068 6967 686c 6576 656c 203d 2078 202b   highlevel = x +
+000197e0: 2073 7465 700a 2020 2020 2020 2020 2320   step.        # 
+000197f0: 6c6f 7720 7061 7373 2066 696c 7465 7220  low pass filter 
+00019800: 6166 7465 723f 0a20 2020 2020 2020 2023  after?.        #
+00019810: 206c 6f77 2070 6173 7320 6669 6c74 6572   low pass filter
+00019820: 2062 6566 6f72 6520 7363 616c 696e 670a   before scaling.
+00019830: 2020 2020 2020 2020 6966 2072 6573 6f20          if reso 
+00019840: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
+00019850: 2020 2020 2020 2020 2069 6620 6c70 6669           if lpfi
+00019860: 6c74 6120 616e 6420 6e6f 7420 6c70 6669  lta and not lpfi
+00019870: 6c74 623a 0a20 2020 2020 2020 2020 2020  ltb:.           
+00019880: 2020 2020 2066 7431 2e5f 7461 6e68 5f6c       ft1._tanh_l
+00019890: 6f77 7061 7373 2863 7574 6f66 6631 2c20  owpass(cutoff1, 
+000198a0: 6661 6c6c 3d30 2e32 2c20 6674 6d61 703d  fall=0.2, ftmap=
+000198b0: 5472 7565 290a 2020 2020 2020 2020 2020  True).          
+000198c0: 2020 2020 2020 6674 322e 5f74 616e 685f        ft2._tanh_
+000198d0: 6c6f 7770 6173 7328 6375 746f 6666 322c  lowpass(cutoff2,
+000198e0: 2066 616c 6c3d 302e 322c 2066 746d 6170   fall=0.2, ftmap
+000198f0: 3d54 7275 6529 0a20 2020 2020 2020 2074  =True).        t
+00019900: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
+00019910: 6966 2070 7966 6674 775f 666c 6167 203d  if pyfftw_flag =
+00019920: 3d20 303a 0a20 2020 2020 2020 2020 2020  = 0:.           
+00019930: 2020 2020 2072 6169 7365 2049 6d70 6f72       raise Impor
+00019940: 7445 7272 6f72 0a20 2020 2020 2020 2020  tError.         
+00019950: 2020 2069 6666 7420 3d20 7079 6666 7477     ifft = pyfftw
+00019960: 2e46 4654 5728 0a20 2020 2020 2020 2020  .FFTW(.         
+00019970: 2020 2020 2020 2069 6e70 7574 6131 2c0a         inputa1,.
+00019980: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019990: 6f75 7470 7574 6131 2c0a 2020 2020 2020  outputa1,.      
+000199a0: 2020 2020 2020 2020 2020 6469 7265 6374            direct
+000199b0: 696f 6e3d 2746 4654 575f 4241 434b 5741  ion='FFTW_BACKWA
+000199c0: 5244 272c 0a20 2020 2020 2020 2020 2020  RD',.           
+000199d0: 2020 2020 2061 7865 733d 2830 2c20 312c       axes=(0, 1,
+000199e0: 2032 292c 0a20 2020 2020 2020 2020 2020   2),.           
+000199f0: 2020 2020 2066 6c61 6773 3d5b 2746 4654       flags=['FFT
+00019a00: 575f 4553 5449 4d41 5445 275d 2c0a 2020  W_ESTIMATE'],.  
+00019a10: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+00019a20: 2020 2020 2020 2020 696e 7075 7461 315b          inputa1[
+00019a30: 3a2c 203a 2c20 3a5d 203d 2069 6666 7473  :, :, :] = iffts
+00019a40: 6869 6674 2866 7431 2e66 756c 6c4d 6170  hift(ft1.fullMap
+00019a50: 295b 3a2c 203a 2c20 3a5d 0a20 2020 2020  )[:, :, :].     
+00019a60: 2020 2020 2020 2069 6666 7428 290a 2020         ifft().  
+00019a70: 2020 2020 2020 2020 2020 6d61 7031 5f66            map1_f
+00019a80: 696c 7420 3d20 4d61 7028 0a20 2020 2020  ilt = Map(.     
+00019a90: 2020 2020 2020 2020 2020 206f 7574 7075             outpu
+00019aa0: 7461 312e 7265 616c 2e61 7374 7970 6528  ta1.real.astype(
+00019ab0: 2766 6c6f 6174 2729 2c0a 2020 2020 2020  'float'),.      
+00019ac0: 2020 2020 2020 2020 2020 6d61 705f 312e            map_1.
+00019ad0: 6f72 6967 696e 2c0a 2020 2020 2020 2020  origin,.        
+00019ae0: 2020 2020 2020 2020 6d61 705f 312e 6170          map_1.ap
+00019af0: 6978 2c0a 2020 2020 2020 2020 2020 2020  ix,.            
+00019b00: 2020 2020 6d61 705f 312e 6669 6c65 6e61      map_1.filena
+00019b10: 6d65 2c0a 2020 2020 2020 2020 2020 2020  me,.            
+00019b20: 2020 2020 6d61 705f 312e 6865 6164 6572      map_1.header
+00019b30: 5b3a 5d2c 0a20 2020 2020 2020 2020 2020  [:],.           
+00019b40: 2029 0a20 2020 2020 2020 2065 7863 6570   ).        excep
+00019b50: 7420 4578 6365 7074 696f 6e3a 0a20 2020  t Exception:.   
+00019b60: 2020 2020 2020 2020 2023 2075 7365 206e           # use n
+00019b70: 756d 7079 2069 6666 7420 696e 7374 6561  umpy ifft instea
+00019b80: 640a 2020 2020 2020 2020 2020 2020 6d61  d.            ma
+00019b90: 7031 5f66 696c 7420 3d20 6d61 705f 312e  p1_filt = map_1.
+00019ba0: 636f 7079 2829 0a20 2020 2020 2020 2020  copy().         
+00019bb0: 2020 206d 6170 315f 6669 6c74 2e66 756c     map1_filt.ful
+00019bc0: 6c4d 6170 203d 206e 702e 7265 616c 2869  lMap = np.real(i
+00019bd0: 6666 746e 2869 6666 7473 6869 6674 2866  fftn(ifftshift(f
+00019be0: 7431 2e66 756c 6c4d 6170 2929 290a 2020  t1.fullMap))).  
+00019bf0: 2020 2020 2020 7472 793a 0a20 2020 2020        try:.     
+00019c00: 2020 2020 2020 2069 6620 7079 6666 7477         if pyfftw
+00019c10: 5f66 6c61 6720 3d3d 2030 3a0a 2020 2020  _flag == 0:.    
+00019c20: 2020 2020 2020 2020 2020 2020 7261 6973              rais
+00019c30: 6520 496d 706f 7274 4572 726f 720a 2020  e ImportError.  
+00019c40: 2020 2020 2020 2020 2020 6966 6674 203d            ifft =
+00019c50: 2070 7966 6674 772e 4646 5457 280a 2020   pyfftw.FFTW(.  
+00019c60: 2020 2020 2020 2020 2020 2020 2020 696e                in
+00019c70: 7075 7461 322c 0a20 2020 2020 2020 2020  puta2,.         
+00019c80: 2020 2020 2020 206f 7574 7075 7461 322c         outputa2,
+00019c90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00019ca0: 2064 6972 6563 7469 6f6e 3d27 4646 5457   direction='FFTW
+00019cb0: 5f42 4143 4b57 4152 4427 2c0a 2020 2020  _BACKWARD',.    
+00019cc0: 2020 2020 2020 2020 2020 2020 6178 6573              axes
+00019cd0: 3d28 302c 2031 2c20 3229 2c0a 2020 2020  =(0, 1, 2),.    
+00019ce0: 2020 2020 2020 2020 2020 2020 666c 6167              flag
+00019cf0: 733d 5b27 4646 5457 5f45 5354 494d 4154  s=['FFTW_ESTIMAT
+00019d00: 4527 5d2c 0a20 2020 2020 2020 2020 2020  E'],.           
+00019d10: 2029 0a20 2020 2020 2020 2020 2020 2069   ).            i
+00019d20: 6e70 7574 6132 5b3a 2c20 3a2c 203a 5d20  nputa2[:, :, :] 
+00019d30: 3d20 6966 6674 7368 6966 7428 6674 322e  = ifftshift(ft2.
+00019d40: 6675 6c6c 4d61 7029 5b3a 2c20 3a2c 203a  fullMap)[:, :, :
+00019d50: 5d0a 2020 2020 2020 2020 2020 2020 6966  ].            if
+00019d60: 6674 2829 0a20 2020 2020 2020 2020 2020  ft().           
+00019d70: 206d 6170 325f 6669 6c74 203d 204d 6170   map2_filt = Map
+00019d80: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00019d90: 2020 6f75 7470 7574 6132 2e72 6561 6c2e    outputa2.real.
+00019da0: 6173 7479 7065 2827 666c 6f61 7427 292c  astype('float'),
+00019db0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00019dc0: 206d 6170 5f32 2e6f 7269 6769 6e2c 0a20   map_2.origin,. 
+00019dd0: 2020 2020 2020 2020 2020 2020 2020 206d                 m
+00019de0: 6170 5f32 2e61 7069 782c 0a20 2020 2020  ap_2.apix,.     
+00019df0: 2020 2020 2020 2020 2020 206d 6170 5f32             map_2
+00019e00: 2e66 696c 656e 616d 652c 0a20 2020 2020  .filename,.     
+00019e10: 2020 2020 2020 2020 2020 206d 6170 5f32             map_2
+00019e20: 2e68 6561 6465 725b 3a5d 2c0a 2020 2020  .header[:],.    
+00019e30: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+00019e40: 2020 6578 6365 7074 2045 7863 6570 7469    except Excepti
+00019e50: 6f6e 3a0a 2020 2020 2020 2020 2020 2020  on:.            
+00019e60: 6d61 7032 5f66 696c 7420 3d20 6d61 705f  map2_filt = map_
+00019e70: 322e 636f 7079 2829 0a20 2020 2020 2020  2.copy().       
+00019e80: 2020 2020 206d 6170 325f 6669 6c74 2e66       map2_filt.f
+00019e90: 756c 6c4d 6170 203d 206e 702e 7265 616c  ullMap = np.real
+00019ea0: 2869 6666 746e 2869 6666 7473 6869 6674  (ifftn(ifftshift
+00019eb0: 2866 7432 2e66 756c 6c4d 6170 2929 290a  (ft2.fullMap))).
+00019ec0: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
+00019ed0: 2020 2020 2020 2020 2069 6d70 6f72 7420           import 
+00019ee0: 6d61 7470 6c6f 746c 6962 0a20 2020 2020  matplotlib.     
+00019ef0: 2020 2020 2020 206d 6174 706c 6f74 6c69         matplotli
+00019f00: 622e 7573 6528 2741 6767 2729 0a20 2020  b.use('Agg').   
+00019f10: 2020 2020 2020 2020 2069 6d70 6f72 7420           import 
+00019f20: 6d61 7470 6c6f 746c 6962 2e70 7970 6c6f  matplotlib.pyplo
+00019f30: 7420 6173 2070 6c74 0a20 2020 2020 2020  t as plt.       
+00019f40: 2020 2020 2066 726f 6d20 6d61 7470 6c6f       from matplo
+00019f50: 746c 6962 2069 6d70 6f72 7420 7079 6c61  tlib import pyla
+00019f60: 620a 2020 2020 2020 2020 2020 2020 7472  b.            tr
+00019f70: 793a 0a20 2020 2020 2020 2020 2020 2020  y:.             
+00019f80: 2020 2070 6c74 2e73 7479 6c65 2e75 7365     plt.style.use
+00019f90: 2827 6767 706c 6f74 2729 0a20 2020 2020  ('ggplot').     
+00019fa0: 2020 2020 2020 2065 7863 6570 7420 4174         except At
+00019fb0: 7472 6962 7574 6545 7272 6f72 3a0a 2020  tributeError:.  
+00019fc0: 2020 2020 2020 2020 2020 2020 2020 7061                pa
+00019fd0: 7373 0a20 2020 2020 2020 2020 2020 2070  ss.            p
+00019fe0: 6c74 2e72 6350 6172 616d 732e 7570 6461  lt.rcParams.upda
+00019ff0: 7465 287b 2766 6f6e 742e 7369 7a65 273a  te({'font.size':
+0001a000: 2031 387d 290a 2020 2020 2020 2020 2020   18}).          
+0001a010: 2020 706c 742e 7263 5061 7261 6d73 2e75    plt.rcParams.u
+0001a020: 7064 6174 6528 7b27 6c65 6765 6e64 2e66  pdate({'legend.f
+0001a030: 6f6e 7473 697a 6527 3a20 3138 7d29 0a20  ontsize': 18}). 
+0001a040: 2020 2020 2020 2020 2020 2070 6c74 2e70             plt.p
+0001a050: 6c6f 7428 6c66 7265 712c 2066 7431 5f61  lot(lfreq, ft1_a
+0001a060: 7667 2c20 2772 2d2d 272c 206c 6162 656c  vg, 'r--', label
+0001a070: 3d27 6d61 7031 2729 0a20 2020 2020 2020  ='map1').       
+0001a080: 2020 2020 2070 6c74 2e70 6c6f 7428 6c66       plt.plot(lf
+0001a090: 7265 712c 2066 7432 5f61 7667 2c20 2762  req, ft2_avg, 'b
+0001a0a0: 7327 2c20 6c61 6265 6c3d 276d 6170 3227  s', label='map2'
+0001a0b0: 290a 2020 2020 2020 2020 2020 2020 706c  ).            pl
+0001a0c0: 742e 706c 6f74 286c 6672 6571 2c20 6674  t.plot(lfreq, ft
+0001a0d0: 315f 6176 675f 6e65 772c 2027 675e 272c  1_avg_new, 'g^',
+0001a0e0: 206c 6162 656c 3d27 7363 616c 6564 2729   label='scaled')
+0001a0f0: 0a20 2020 2020 2020 2020 2020 206c 6567  .            leg
+0001a100: 203d 2070 6c74 2e6c 6567 656e 6428 6c6f   = plt.legend(lo
+0001a110: 633d 2775 7070 6572 2072 6967 6874 2729  c='upper right')
+0001a120: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
+0001a130: 206c 6567 6f62 6a20 696e 206c 6567 2e6c   legobj in leg.l
+0001a140: 6567 656e 6448 616e 646c 6573 3a0a 2020  egendHandles:.  
+0001a150: 2020 2020 2020 2020 2020 2020 2020 6c65                le
+0001a160: 676f 626a 2e73 6574 5f6c 696e 6577 6964  gobj.set_linewid
+0001a170: 7468 2832 2e30 290a 2020 2020 2020 2020  th(2.0).        
+0001a180: 2020 2020 7079 6c61 622e 7361 7665 6669      pylab.savefi
+0001a190: 6728 2273 7065 6374 7261 2e70 6e67 2229  g("spectra.png")
+0001a1a0: 0a20 2020 2020 2020 2020 2020 2070 6c74  .            plt
+0001a1b0: 2e63 6c6f 7365 2829 0a20 2020 2020 2020  .close().       
+0001a1c0: 2065 7863 6570 7420 4578 6365 7074 696f   except Exceptio
+0001a1d0: 6e3a 0a20 2020 2020 2020 2020 2020 2070  n:.            p
+0001a1e0: 6173 730a 2020 2020 2020 2020 7265 7475  ass.        retu
+0001a1f0: 726e 206d 6170 315f 6669 6c74 2e66 756c  rn map1_filt.ful
+0001a200: 6c4d 6170 2c20 6d61 7032 5f66 696c 742e  lMap, map2_filt.
+0001a210: 6675 6c6c 4d61 700a 0a20 2020 2064 6566  fullMap..    def
+0001a220: 2067 6574 5f63 6c61 7368 5f6d 6170 2873   get_clash_map(s
+0001a230: 656c 662c 2065 6d6d 6170 2c20 6170 6978  elf, emmap, apix
+0001a240: 293a 0a20 2020 2020 2020 2074 656d 706c  ):.        templ
+0001a250: 6174 655f 6772 6964 203d 2065 6d6d 6170  ate_grid = emmap
+0001a260: 2e5f 6d61 6b65 5f63 6c61 7368 5f6d 6170  ._make_clash_map
+0001a270: 2861 7069 7829 0a20 2020 2020 2020 2072  (apix).        r
+0001a280: 6574 7572 6e20 7465 6d70 6c61 7465 5f67  eturn template_g
+0001a290: 7269 640a 0a20 2020 2064 6566 2067 6574  rid..    def get
+0001a2a0: 5f73 6d5f 7363 6f72 6528 0a20 2020 2020  _sm_score(.     
+0001a2b0: 2020 2020 2020 2073 656c 662c 0a20 2020         self,.   
+0001a2c0: 2020 2020 2020 2020 2073 7472 7563 742c           struct,
+0001a2d0: 0a20 2020 2020 2020 2020 2020 206e 636f  .            nco
+0001a2e0: 6d70 2c0a 2020 2020 2020 2020 2020 2020  mp,.            
+0001a2f0: 7465 6d70 6c61 7465 5f67 7269 642c 0a20  template_grid,. 
+0001a300: 2020 2020 2020 2020 2020 2063 766f 6c2c             cvol,
+0001a310: 0a20 2020 2020 2020 2020 2020 2061 7069  .            api
+0001a320: 782c 0a20 2020 2029 3a0a 2020 2020 2020  x,.    ):.      
+0001a330: 2020 2222 2243 616c 6375 6c61 7465 2074    """Calculate t
+0001a340: 6865 2063 6c61 7368 2073 636f 7265 2062  he clash score b
+0001a350: 6574 7765 656e 2063 6861 696e 7320 7769  etween chains wi
+0001a360: 7468 696e 2061 2070 726f 7465 696e 206d  thin a protein m
+0001a370: 6f64 656c 0a0a 2020 2020 2020 2020 5468  odel..        Th
+0001a380: 6520 636c 6173 6820 7363 6f72 6520 6361  e clash score ca
+0001a390: 6c63 756c 6174 6573 2074 6865 2061 6d6f  lculates the amo
+0001a3a0: 756e 7420 7468 6174 2063 6861 696e 7320  unt that chains 
+0001a3b0: 696e 2061 2070 726f 7465 696e 206f 7665  in a protein ove
+0001a3c0: 726c 6170 0a20 2020 2020 2020 206f 6e65  rlap.        one
+0001a3d0: 2061 6e6f 7468 6572 2e20 5468 6520 7374   another. The st
+0001a3e0: 7275 6374 7572 6520 6973 206d 6170 7065  ructure is mappe
+0001a3f0: 6420 696e 746f 2064 6973 6372 6574 6520  d into discrete 
+0001a400: 6269 6e73 2069 6e20 3344 2073 7061 6365  bins in 3D space
+0001a410: 2c0a 2020 2020 2020 2020 6465 6669 6e65  ,.        define
+0001a420: 6420 6279 2074 6865 2074 656d 706c 6174  d by the templat
+0001a430: 655f 6772 6964 2069 6e70 7574 2e20 5468  e_grid input. Th
+0001a440: 6520 7363 6f72 6520 6973 2070 726f 706f  e score is propo
+0001a450: 7274 696f 6e61 6c20 746f 2074 6865 0a20  rtional to the. 
+0001a460: 2020 2020 2020 206e 756d 6265 7220 6f66         number of
+0001a470: 2074 6865 7365 2062 696e 7320 6f63 6375   these bins occu
+0001a480: 7069 6564 2062 7920 6d6f 7265 2074 6861  pied by more tha
+0001a490: 6e20 6f6e 6520 6f66 2074 6865 2070 726f  n one of the pro
+0001a4a0: 7465 696e 2063 6861 696e 732e 0a0a 2020  tein chains...  
+0001a4b0: 2020 2020 2020 5265 636f 6d6d 656e 6465        Recommende
+0001a4c0: 6420 7069 7865 6c20 7370 6163 696e 6720  d pixel spacing 
+0001a4d0: 6f66 2074 6865 2074 656d 706c 6174 655f  of the template_
+0001a4e0: 6772 6964 2069 7320 332e 3520 c385 2e0a  grid is 3.5 ....
+0001a4f0: 0a20 2020 2020 2020 2041 7267 733a 0a20  .        Args:. 
+0001a500: 2020 2020 2020 2020 2020 2073 7472 7563             struc
+0001a510: 743a 2053 7472 7563 7475 7265 2069 6e73  t: Structure ins
+0001a520: 7461 6e63 652e 0a20 2020 2020 2020 2020  tance..         
+0001a530: 2020 206e 636f 6d70 3a20 4e75 6d62 6572     ncomp: Number
+0001a540: 206f 6620 6368 6169 6e73 2069 6e20 7468   of chains in th
+0001a550: 6520 7374 7275 6374 7572 652e 0a20 2020  e structure..   
+0001a560: 2020 2020 2020 2020 2074 656d 706c 6174           templat
+0001a570: 655f 6772 6964 3a20 4d61 7020 6f62 6a65  e_grid: Map obje
+0001a580: 6374 2077 6974 6820 656d 7074 7920 3344  ct with empty 3D
+0001a590: 2d67 7269 6420 2866 696c 6c65 6420 7769  -grid (filled wi
+0001a5a0: 7468 207a 6572 6f73 292e 0a20 2020 2020  th zeros)..     
+0001a5b0: 2020 2020 2020 2020 2020 2054 6869 7320             This 
+0001a5c0: 6361 6e20 6265 2063 616c 6375 6c61 7465  can be calculate
+0001a5d0: 6420 7573 696e 670a 2020 2020 2020 2020  d using.        
+0001a5e0: 2020 2020 2020 2020 3a6d 6574 683a 6053          :meth:`S
+0001a5f0: 7472 7563 7475 7265 426c 7572 7265 722e  tructureBlurrer.
+0001a600: 7072 6f74 4d61 7020 3c54 454d 5079 2e70  protMap <TEMPy.p
+0001a610: 726f 7465 696e 2e73 7472 7563 7475 7265  rotein.structure
+0001a620: 5f62 6c75 7272 6572 2e53 7472 7563 7475  _blurrer.Structu
+0001a630: 7265 426c 7572 7265 722e 7072 6f74 4d61  reBlurrer.protMa
+0001a640: 703e 600a 2020 2020 2020 2020 2020 2020  p>`.            
+0001a650: 6376 6f6c 3a20 4c69 7374 2063 6f6e 7461  cvol: List conta
+0001a660: 696e 696e 6720 7468 6520 766f 6c75 6d65  ining the volume
+0001a670: 206f 6620 6561 6368 2063 6861 696e 2e20   of each chain. 
+0001a680: 5468 6973 2063 616e 2062 650a 2020 2020  This can be.    
+0001a690: 2020 2020 2020 2020 2020 2020 6361 6c63              calc
+0001a6a0: 756c 6174 6564 2075 7369 6e67 0a20 2020  ulated using.   
+0001a6b0: 2020 2020 2020 2020 2020 2020 203a 6d65               :me
+0001a6c0: 7468 3a60 4d61 702e 5f67 6574 5f63 6f6d  th:`Map._get_com
+0001a6d0: 706f 6e65 6e74 5f76 6f6c 756d 6573 203c  ponent_volumes <
+0001a6e0: 5445 4d50 792e 6d61 7073 2e65 6d5f 6d61  TEMPy.maps.em_ma
+0001a6f0: 702e 4d61 702e 5f67 6574 5f63 6f6d 706f  p.Map._get_compo
+0001a700: 6e65 6e74 5f76 6f6c 756d 6573 3e60 0a20  nent_volumes>`. 
+0001a710: 2020 2020 2020 2020 2020 2061 7069 783a             apix:
+0001a720: 2050 6978 656c 2073 697a 6520 6f66 2074   Pixel size of t
+0001a730: 656d 706c 6174 655f 6772 6964 2c20 7573  emplate_grid, us
+0001a740: 6564 2066 6f72 2073 6361 6c69 6e67 2074  ed for scaling t
+0001a750: 6865 2076 6f6c 756d 650a 2020 2020 2020  he volume.      
+0001a760: 2020 2020 2020 2020 2020 6361 6c63 756c            calcul
+0001a770: 6174 696f 6e73 2e0a 0a20 2020 2020 2020  ations...       
+0001a780: 2052 6574 7572 6e73 3a0a 2020 2020 2020   Returns:.      
+0001a790: 2020 2020 2020 5468 6520 636c 6173 6820        The clash 
+0001a7a0: 7363 6f72 6520 666f 7220 7468 6520 7374  score for the st
+0001a7b0: 7275 6374 7572 6520 2863 6c6f 7365 2074  ructure (close t
+0001a7c0: 6f20 3020 6973 2067 6f6f 642c 206c 6172  o 0 is good, lar
+0001a7d0: 6765 0a20 2020 2020 2020 2020 2020 206e  ge.            n
+0001a7e0: 6567 6174 6976 6520 7363 6f72 6520 6973  egative score is
+0001a7f0: 2062 6164 290a 2020 2020 2020 2020 2222   bad).        ""
+0001a800: 220a 2020 2020 2020 2020 6f76 6572 6c61  ".        overla
+0001a810: 795f 6d61 706c 6973 7420 3d20 5b5d 0a20  y_maplist = []. 
+0001a820: 2020 2020 2020 206f 7665 726c 6179 5f6d         overlay_m
+0001a830: 6170 6c69 7374 203d 2073 656c 662e 6765  aplist = self.ge
+0001a840: 745f 6f76 6572 6c61 795f 636f 6d70 5f6d  t_overlay_comp_m
+0001a850: 6170 6c69 7374 2873 7472 7563 742c 2074  aplist(struct, t
+0001a860: 656d 706c 6174 655f 6772 6964 290a 2020  emplate_grid).  
+0001a870: 2020 2020 2020 6e63 203d 2072 616e 6765        nc = range
+0001a880: 286e 636f 6d70 290a 2020 2020 2020 2020  (ncomp).        
+0001a890: 6370 6169 7220 3d20 6c69 7374 2869 7465  cpair = list(ite
+0001a8a0: 7274 6f6f 6c73 2e63 6f6d 6269 6e61 7469  rtools.combinati
+0001a8b0: 6f6e 7328 6e63 2c20 3229 290a 2020 2020  ons(nc, 2)).    
+0001a8c0: 2020 2020 7363 6f72 6520 3d20 302e 300a      score = 0.0.
+0001a8d0: 2020 2020 2020 2020 6e5f 6f76 6572 6c61          n_overla
+0001a8e0: 705f 766f 7865 6c20 3d20 300a 2020 2020  p_voxel = 0.    
+0001a8f0: 2020 2020 6f76 6572 6c61 705f 766f 6c75      overlap_volu
+0001a900: 6d65 203d 2030 2e30 0a20 2020 2020 2020  me = 0.0.       
+0001a910: 2066 6f72 2069 2069 6e20 6370 6169 723a   for i in cpair:
+0001a920: 0a20 2020 2020 2020 2020 2020 206e 5f6f  .            n_o
+0001a930: 7665 726c 6170 5f76 6f78 656c 203d 2028  verlap_voxel = (
+0001a940: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001a950: 2020 2020 206f 7665 726c 6179 5f6d 6170       overlay_map
+0001a960: 6c69 7374 5b69 5b30 5d5d 2e66 756c 6c4d  list[i[0]].fullM
+0001a970: 6170 202a 0a20 2020 2020 2020 2020 2020  ap *.           
+0001a980: 2020 2020 2020 2020 206f 7665 726c 6179           overlay
+0001a990: 5f6d 6170 6c69 7374 5b69 5b31 5d5d 2e66  _maplist[i[1]].f
+0001a9a0: 756c 6c4d 6170 0a20 2020 2020 2020 2020  ullMap.         
+0001a9b0: 2020 2029 2e73 756d 2829 0a20 2020 2020     ).sum().     
+0001a9c0: 2020 2020 2020 206f 7665 726c 6170 5f76         overlap_v
+0001a9d0: 6f6c 756d 6520 3d20 2828 6170 6978 2e70  olume = ((apix.p
+0001a9e0: 726f 6428 2929 202a 206e 5f6f 7665 726c  rod()) * n_overl
+0001a9f0: 6170 5f76 6f78 656c 2920 2a20 320a 2020  ap_voxel) * 2.  
+0001aa00: 2020 2020 2020 2020 2020 636c 6173 685f            clash_
+0001aa10: 7065 7263 656e 7420 3d20 280a 2020 2020  percent = (.    
+0001aa20: 2020 2020 2020 2020 2020 2020 666c 6f61              floa
+0001aa30: 7428 6f76 6572 6c61 705f 766f 6c75 6d65  t(overlap_volume
+0001aa40: 202f 2028 6376 6f6c 5b69 5b30 5d5d 202b   / (cvol[i[0]] +
+0001aa50: 2063 766f 6c5b 695b 315d 5d29 290a 2020   cvol[i[1]])).  
+0001aa60: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+0001aa70: 2020 2020 2020 2020 7363 6f72 6520 3d20          score = 
+0001aa80: 7363 6f72 6520 2b20 636c 6173 685f 7065  score + clash_pe
+0001aa90: 7263 656e 740a 2020 2020 2020 2020 7265  rcent.        re
+0001aaa0: 7475 726e 202d 2873 636f 7265 290a 0a20  turn -(score).. 
+0001aab0: 2020 2064 6566 2067 6574 5f6f 7665 726c     def get_overl
+0001aac0: 6179 5f63 6f6d 705f 6d61 706c 6973 7428  ay_comp_maplist(
+0001aad0: 7365 6c66 2c20 7374 7275 6374 2c20 7465  self, struct, te
+0001aae0: 6d70 6c61 7465 5f67 7269 6429 3a0a 2020  mplate_grid):.  
+0001aaf0: 2020 2020 2020 626c 7572 7265 7220 3d20        blurrer = 
+0001ab00: 5374 7275 6374 7572 6542 6c75 7272 6572  StructureBlurrer
+0001ab10: 2829 0a20 2020 2020 2020 206f 7665 726c  ().        overl
+0001ab20: 6179 5f6d 6170 6c69 7374 203d 205b 5d0a  ay_maplist = [].
+0001ab30: 2020 2020 2020 2020 7373 706c 6974 203d          ssplit =
+0001ab40: 2073 7472 7563 742e 7370 6c69 745f 696e   struct.split_in
+0001ab50: 746f 5f63 6861 696e 7328 290a 2020 2020  to_chains().    
+0001ab60: 2020 2020 666f 7220 7820 696e 2073 7370      for x in ssp
+0001ab70: 6c69 743a 0a20 2020 2020 2020 2020 2020  lit:.           
+0001ab80: 206f 7665 726c 6179 5f6d 6170 6c69 7374   overlay_maplist
+0001ab90: 2e61 7070 656e 6428 0a20 2020 2020 2020  .append(.       
+0001aba0: 2020 2020 2020 2020 2062 6c75 7272 6572           blurrer
+0001abb0: 2e6d 616b 655f 6174 6f6d 5f6f 7665 726c  .make_atom_overl
+0001abc0: 6179 5f6d 6170 3128 0a20 2020 2020 2020  ay_map1(.       
+0001abd0: 2020 2020 2020 2020 2020 2020 2074 656d               tem
+0001abe0: 706c 6174 655f 6772 6964 2c0a 2020 2020  plate_grid,.    
 0001abf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ac00: 4f6e 6520 6f66 2074 6865 2069 6e70 7574  One of the input
-0001ac10: 2073 7472 7563 7475 7265 2069 6e73 7461   structure insta
-0001ac20: 6e63 6573 2062 6569 6e67 2063 6f6d 7061  nces being compa
-0001ac30: 7265 640a 2020 2020 2020 2020 2020 2020  red.            
-0001ac40: 7072 6f62 655f 6368 6169 6e3a 0a20 2020  probe_chain:.   
-0001ac50: 2020 2020 2020 2020 2020 2020 2054 6865               The
-0001ac60: 206f 7468 6572 2069 6e70 7574 2073 7472   other input str
-0001ac70: 7563 7475 7265 2069 6e73 7461 6e63 6520  ucture instance 
-0001ac80: 6265 696e 6720 636f 6d70 6172 6564 0a20  being compared. 
-0001ac90: 2020 2020 2020 204f 7574 7075 743a 0a20         Output:. 
-0001aca0: 2020 2020 2020 2020 2020 2061 6c63 7073             alcps
-0001acb0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0001acc0: 2020 4172 6320 4c65 6e67 7468 2043 6f6d    Arc Length Com
-0001acd0: 706f 6e65 6e74 2050 6c61 6365 6d65 6e74  ponent Placement
-0001ace0: 2053 636f 7265 0a20 2020 2020 2020 2022   Score.        "
-0001acf0: 2222 0a0a 2020 2020 2020 2020 6469 6666  ""..        diff
-0001ad00: 5f76 6563 203d 2072 6566 5f63 6861 696e  _vec = ref_chain
-0001ad10: 2e43 6f4d 202d 2070 726f 6265 5f63 6861  .CoM - probe_cha
-0001ad20: 696e 2e43 6f4d 0a20 2020 2020 2020 2072  in.CoM.        r
-0001ad30: 203d 2064 6966 665f 7665 632e 6d6f 6428   = diff_vec.mod(
-0001ad40: 290a 0a20 2020 2020 2020 2072 6566 5f6d  )..        ref_m
-0001ad50: 6174 7269 7820 3d20 7665 6374 6f72 2e67  atrix = vector.g
-0001ad60: 6574 5f63 6f6f 7264 696e 6174 655f 6d61  et_coordinate_ma
-0001ad70: 7373 5f61 7272 6179 2872 6566 5f63 6861  ss_array(ref_cha
-0001ad80: 696e 290a 2020 2020 2020 2020 7072 6f62  in).        prob
-0001ad90: 655f 6d61 7472 6978 203d 2076 6563 746f  e_matrix = vecto
-0001ada0: 722e 6765 745f 636f 6f72 6469 6e61 7465  r.get_coordinate
-0001adb0: 5f6d 6173 735f 6172 7261 7928 7072 6f62  _mass_array(prob
-0001adc0: 655f 6368 6169 6e29 0a0a 2020 2020 2020  e_chain)..      
-0001add0: 2020 726f 7461 7469 6f6e 5f6d 6174 7269    rotation_matri
-0001ade0: 782c 205f 7420 3d20 7665 6374 6f72 2e67  x, _t = vector.g
-0001adf0: 6574 5f74 7261 6e73 666f 726d 2872 6566  et_transform(ref
-0001ae00: 5f6d 6174 7269 782c 2070 726f 6265 5f6d  _matrix, probe_m
-0001ae10: 6174 7269 7829 0a0a 2020 2020 2020 2020  atrix)..        
-0001ae20: 7468 6574 612c 206e 312c 206e 322c 206e  theta, n1, n2, n
-0001ae30: 3320 3d20 7665 6374 6f72 2e5f 726f 746d  3 = vector._rotm
-0001ae40: 6174 5f74 6f5f 6178 6973 616e 676c 6528  at_to_axisangle(
-0001ae50: 726f 7461 7469 6f6e 5f6d 6174 7269 7829  rotation_matrix)
-0001ae60: 0a20 2020 2020 2020 2074 6865 7461 203d  .        theta =
-0001ae70: 206d 6174 682e 6465 6772 6565 7328 7468   math.degrees(th
-0001ae80: 6574 6129 0a0a 2020 2020 2020 2020 616c  eta)..        al
-0001ae90: 6370 7320 3d20 3220 2a20 6d61 7468 2e70  cps = 2 * math.p
-0001aea0: 6920 2a20 7220 2a20 7468 6574 6120 2f20  i * r * theta / 
-0001aeb0: 3336 300a 0a20 2020 2020 2020 2072 6574  360..        ret
-0001aec0: 7572 6e20 616c 6370 730a 0a20 2020 2064  urn alcps..    d
-0001aed0: 6566 2067 6574 5f6c 6f67 3130 5f61 6c63  ef get_log10_alc
-0001aee0: 7073 2873 656c 662c 2072 6566 5f63 6861  ps(self, ref_cha
-0001aef0: 696e 2c20 7072 6f62 655f 6368 6169 6e2c  in, probe_chain,
-0001af00: 206c 6f77 6573 745f 7661 6c75 653d 2d32   lowest_value=-2
-0001af10: 293a 0a20 2020 2020 2020 2022 2222 0a20  ):.        """. 
-0001af20: 2020 2020 2020 2043 616c 6375 6c61 7465         Calculate
-0001af30: 2074 6865 206c 6f67 3130 206f 6620 7468   the log10 of th
-0001af40: 6520 414c 4350 5320 7363 6f72 652e 0a0a  e ALCPS score...
-0001af50: 2020 2020 2020 2020 496e 7075 7473 3a0a          Inputs:.
-0001af60: 2020 2020 2020 2020 2020 2020 7265 665f              ref_
-0001af70: 6368 6169 6e3a 0a20 2020 2020 2020 2020  chain:.         
-0001af80: 2020 2020 2020 2052 6566 6572 656e 6365         Reference
-0001af90: 2073 7472 7563 7475 7265 2069 6e73 7461   structure insta
-0001afa0: 6e63 650a 2020 2020 2020 2020 2020 2020  nce.            
-0001afb0: 7072 6f62 655f 6368 6169 6e3a 0a20 2020  probe_chain:.   
-0001afc0: 2020 2020 2020 2020 2020 2020 2050 726f               Pro
-0001afd0: 6265 2073 7472 7563 7475 7265 2069 6e73  be structure ins
-0001afe0: 7461 6e63 650a 2020 2020 2020 2020 2020  tance.          
-0001aff0: 2020 6c6f 7765 7374 5f76 616c 7565 3a0a    lowest_value:.
-0001b000: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b010: 5661 6c75 6520 746f 2075 7365 2069 6620  Value to use if 
-0001b020: 7477 6f20 7374 7275 6374 7572 6573 2061  two structures a
-0001b030: 7265 2070 6572 6665 6374 6c79 2061 6c69  re perfectly ali
-0001b040: 676e 6564 2028 692e 652e 2069 660a 2020  gned (i.e. if.  
-0001b050: 2020 2020 2020 2020 2020 2020 2020 616c                al
-0001b060: 6370 7320 3d20 3029 202d 2064 6566 6175  cps = 0) - defau
-0001b070: 6c74 2076 616c 7565 2069 7320 2d32 0a20  lt value is -2. 
-0001b080: 2020 2020 2020 204f 7574 7075 7473 3a0a         Outputs:.
-0001b090: 2020 2020 2020 2020 2020 2020 6c6f 6731              log1
-0001b0a0: 3028 616c 6370 7329 3a0a 2020 2020 2020  0(alcps):.      
-0001b0b0: 2020 2020 2020 2020 2020 6c6f 6731 3020            log10 
-0001b0c0: 6f66 2074 6865 2041 4c43 5053 0a20 2020  of the ALCPS.   
-0001b0d0: 2020 2020 2020 2020 206c 6f77 6573 745f           lowest_
-0001b0e0: 7661 6c75 653a 0a20 2020 2020 2020 2020  value:.         
-0001b0f0: 2020 2020 2020 2072 6574 7572 6e65 6420         returned 
-0001b100: 6966 2041 4c43 5053 203d 2030 2c20 6465  if ALCPS = 0, de
-0001b110: 6661 756c 7420 7661 6c75 6520 6973 202d  fault value is -
-0001b120: 320a 2020 2020 2020 2020 2222 220a 0a20  2.        """.. 
-0001b130: 2020 2020 2020 2061 6c63 7073 203d 2073         alcps = s
-0001b140: 656c 662e 6361 6c63 756c 6174 655f 616c  elf.calculate_al
-0001b150: 6370 7328 7265 665f 6368 6169 6e2c 2070  cps(ref_chain, p
-0001b160: 726f 6265 5f63 6861 696e 290a 0a20 2020  robe_chain)..   
-0001b170: 2020 2020 2069 6620 616c 6370 7320 3d3d       if alcps ==
-0001b180: 2030 2e30 3a0a 2020 2020 2020 2020 2020   0.0:.          
-0001b190: 2020 7265 7475 726e 206c 6f77 6573 745f    return lowest_
-0001b1a0: 7661 6c75 650a 2020 2020 2020 2020 656c  value.        el
-0001b1b0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-0001b1c0: 7265 7475 726e 206d 6174 682e 6c6f 6731  return math.log1
-0001b1d0: 3028 616c 6370 7329 0a0a 2020 2020 6465  0(alcps)..    de
-0001b1e0: 6620 5f67 6574 5f6d 6178 5f64 6973 7461  f _get_max_dista
-0001b1f0: 6e63 655f 6265 7477 6565 6e5f 7265 7369  nce_between_resi
-0001b200: 6475 6573 2861 746f 6d73 293a 0a0a 2020  dues(atoms):..  
-0001b210: 2020 2020 2020 6d61 785f 6469 7374 203d        max_dist =
-0001b220: 2030 0a20 2020 2020 2020 2061 746f 6d5f   0.        atom_
-0001b230: 6c69 7374 203d 2061 746f 6d73 5b3a 5d0a  list = atoms[:].
-0001b240: 2020 2020 2020 2020 666f 7220 6174 6f6d          for atom
-0001b250: 2069 6e20 6174 6f6d 733a 0a20 2020 2020   in atoms:.     
-0001b260: 2020 2020 2020 2061 746f 6d5f 6c69 7374         atom_list
-0001b270: 2e70 6f70 2861 746f 6d5f 6c69 7374 2e69  .pop(atom_list.i
-0001b280: 6e64 6578 2861 746f 6d29 290a 2020 2020  ndex(atom)).    
-0001b290: 2020 2020 2020 2020 666f 7220 6174 6f6d          for atom
-0001b2a0: 3220 696e 2061 746f 6d5f 6c69 7374 3a0a  2 in atom_list:.
-0001b2b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b2c0: 7665 6320 3d20 6e70 2e6c 696e 616c 672e  vec = np.linalg.
-0001b2d0: 6e6f 726d 285b 6174 6f6d 2e78 2c20 6174  norm([atom.x, at
-0001b2e0: 6f6d 2e79 2c20 6174 6f6d 2e7a 5d2c 0a20  om.y, atom.z],. 
-0001b2f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b300: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b310: 2020 2020 5b61 746f 6d32 2e78 2c20 6174      [atom2.x, at
-0001b320: 6f6d 322e 792c 2061 746f 6d32 2e7a 5d29  om2.y, atom2.z])
-0001b330: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001b340: 2069 6620 7665 6320 3e20 6d61 785f 6469   if vec > max_di
-0001b350: 7374 3a0a 2020 2020 2020 2020 2020 2020  st:.            
-0001b360: 2020 2020 2020 2020 6d61 785f 6469 7374          max_dist
-0001b370: 203d 2076 6563 0a20 2020 2020 2020 2072   = vec.        r
-0001b380: 6574 7572 6e20 6d61 785f 6469 7374 0a0a  eturn max_dist..
-0001b390: 2020 2020 6465 6620 6d61 705f 6d6f 6465      def map_mode
-0001b3a0: 6c5f 6673 635f 7265 736f 6c75 7469 6f6e  l_fsc_resolution
-0001b3b0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-0001b3c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b3d0: 2020 7365 6c66 2c0a 2020 2020 2020 2020    self,.        
-0001b3e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b3f0: 2020 2020 2020 2020 7374 7275 6374 7572          structur
-0001b400: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
-0001b410: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b420: 2020 2074 6172 6765 745f 6d61 702c 0a20     target_map,. 
-0001b430: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b440: 2020 2020 2020 2020 2020 2020 2020 206d                 m
-0001b450: 6170 5f72 6573 6f6c 7574 696f 6e2c 0a20  ap_resolution,. 
+0001ac00: 782c 0a20 2020 2020 2020 2020 2020 2020  x,.             
+0001ac10: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
+0001ac20: 2029 0a20 2020 2020 2020 2072 6574 7572   ).        retur
+0001ac30: 6e20 6f76 6572 6c61 795f 6d61 706c 6973  n overlay_maplis
+0001ac40: 740a 0a20 2020 2064 6566 2063 616c 6375  t..    def calcu
+0001ac50: 6c61 7465 5f61 6c63 7073 2873 656c 662c  late_alcps(self,
+0001ac60: 2072 6566 5f63 6861 696e 2c20 7072 6f62   ref_chain, prob
+0001ac70: 655f 6368 6169 6e29 3a0a 2020 2020 2020  e_chain):.      
+0001ac80: 2020 2222 220a 2020 2020 2020 2020 4361    """.        Ca
+0001ac90: 6c63 756c 6174 6520 7468 6520 4172 6320  lculate the Arc 
+0001aca0: 4c65 6e67 7468 2043 6f6d 706f 6e65 6e74  Length Component
+0001acb0: 2050 6c61 6365 6d65 6e74 2053 636f 7265   Placement Score
+0001acc0: 2062 6574 7765 656e 2074 776f 206d 6f64   between two mod
+0001acd0: 656c 732e 0a20 2020 2020 2020 2047 656e  els..        Gen
+0001ace0: 6572 616c 6c79 2c20 7468 6973 2073 636f  erally, this sco
+0001acf0: 7265 2069 7320 6361 6c63 756c 6174 6564  re is calculated
+0001ad00: 2062 6574 7765 656e 2069 6e64 6976 6964   between individ
+0001ad10: 7561 6c20 6368 6169 6e73 2069 6e20 610a  ual chains in a.
+0001ad20: 2020 2020 2020 2020 7374 7275 6374 7572          structur
+0001ad30: 652e 0a0a 2020 2020 2020 2020 496e 7075  e...        Inpu
+0001ad40: 7473 3a0a 2020 2020 2020 2020 2020 2020  ts:.            
+0001ad50: 7265 665f 6368 6169 6e3a 0a20 2020 2020  ref_chain:.     
+0001ad60: 2020 2020 2020 2020 2020 204f 6e65 206f             One o
+0001ad70: 6620 7468 6520 696e 7075 7420 7374 7275  f the input stru
+0001ad80: 6374 7572 6520 696e 7374 616e 6365 7320  cture instances 
+0001ad90: 6265 696e 6720 636f 6d70 6172 6564 0a20  being compared. 
+0001ada0: 2020 2020 2020 2020 2020 2070 726f 6265             probe
+0001adb0: 5f63 6861 696e 3a0a 2020 2020 2020 2020  _chain:.        
+0001adc0: 2020 2020 2020 2020 5468 6520 6f74 6865          The othe
+0001add0: 7220 696e 7075 7420 7374 7275 6374 7572  r input structur
+0001ade0: 6520 696e 7374 616e 6365 2062 6569 6e67  e instance being
+0001adf0: 2063 6f6d 7061 7265 640a 2020 2020 2020   compared.      
+0001ae00: 2020 4f75 7470 7574 3a0a 2020 2020 2020    Output:.      
+0001ae10: 2020 2020 2020 616c 6370 733a 0a20 2020        alcps:.   
+0001ae20: 2020 2020 2020 2020 2020 2020 2041 7263               Arc
+0001ae30: 204c 656e 6774 6820 436f 6d70 6f6e 656e   Length Componen
+0001ae40: 7420 506c 6163 656d 656e 7420 5363 6f72  t Placement Scor
+0001ae50: 650a 2020 2020 2020 2020 2222 220a 0a20  e.        """.. 
+0001ae60: 2020 2020 2020 2064 6966 665f 7665 6320         diff_vec 
+0001ae70: 3d20 7265 665f 6368 6169 6e2e 436f 4d20  = ref_chain.CoM 
+0001ae80: 2d20 7072 6f62 655f 6368 6169 6e2e 436f  - probe_chain.Co
+0001ae90: 4d0a 2020 2020 2020 2020 7220 3d20 6469  M.        r = di
+0001aea0: 6666 5f76 6563 2e6d 6f64 2829 0a0a 2020  ff_vec.mod()..  
+0001aeb0: 2020 2020 2020 7265 665f 6d61 7472 6978        ref_matrix
+0001aec0: 203d 2076 6563 746f 722e 6765 745f 636f   = vector.get_co
+0001aed0: 6f72 6469 6e61 7465 5f6d 6173 735f 6172  ordinate_mass_ar
+0001aee0: 7261 7928 7265 665f 6368 6169 6e29 0a20  ray(ref_chain). 
+0001aef0: 2020 2020 2020 2070 726f 6265 5f6d 6174         probe_mat
+0001af00: 7269 7820 3d20 7665 6374 6f72 2e67 6574  rix = vector.get
+0001af10: 5f63 6f6f 7264 696e 6174 655f 6d61 7373  _coordinate_mass
+0001af20: 5f61 7272 6179 2870 726f 6265 5f63 6861  _array(probe_cha
+0001af30: 696e 290a 0a20 2020 2020 2020 2072 6f74  in)..        rot
+0001af40: 6174 696f 6e5f 6d61 7472 6978 2c20 5f74  ation_matrix, _t
+0001af50: 203d 2076 6563 746f 722e 6765 745f 7472   = vector.get_tr
+0001af60: 616e 7366 6f72 6d28 7265 665f 6d61 7472  ansform(ref_matr
+0001af70: 6978 2c20 7072 6f62 655f 6d61 7472 6978  ix, probe_matrix
+0001af80: 290a 0a20 2020 2020 2020 2074 6865 7461  )..        theta
+0001af90: 2c20 6e31 2c20 6e32 2c20 6e33 203d 2076  , n1, n2, n3 = v
+0001afa0: 6563 746f 722e 5f72 6f74 6d61 745f 746f  ector._rotmat_to
+0001afb0: 5f61 7869 7361 6e67 6c65 2872 6f74 6174  _axisangle(rotat
+0001afc0: 696f 6e5f 6d61 7472 6978 290a 2020 2020  ion_matrix).    
+0001afd0: 2020 2020 7468 6574 6120 3d20 6d61 7468      theta = math
+0001afe0: 2e64 6567 7265 6573 2874 6865 7461 290a  .degrees(theta).
+0001aff0: 0a20 2020 2020 2020 2061 6c63 7073 203d  .        alcps =
+0001b000: 2032 202a 206d 6174 682e 7069 202a 2072   2 * math.pi * r
+0001b010: 202a 2074 6865 7461 202f 2033 3630 0a0a   * theta / 360..
+0001b020: 2020 2020 2020 2020 7265 7475 726e 2061          return a
+0001b030: 6c63 7073 0a0a 2020 2020 6465 6620 6765  lcps..    def ge
+0001b040: 745f 6c6f 6731 305f 616c 6370 7328 7365  t_log10_alcps(se
+0001b050: 6c66 2c20 7265 665f 6368 6169 6e2c 2070  lf, ref_chain, p
+0001b060: 726f 6265 5f63 6861 696e 2c20 6c6f 7765  robe_chain, lowe
+0001b070: 7374 5f76 616c 7565 3d2d 3229 3a0a 2020  st_value=-2):.  
+0001b080: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
+0001b090: 2020 4361 6c63 756c 6174 6520 7468 6520    Calculate the 
+0001b0a0: 6c6f 6731 3020 6f66 2074 6865 2041 4c43  log10 of the ALC
+0001b0b0: 5053 2073 636f 7265 2e0a 0a20 2020 2020  PS score...     
+0001b0c0: 2020 2049 6e70 7574 733a 0a20 2020 2020     Inputs:.     
+0001b0d0: 2020 2020 2020 2072 6566 5f63 6861 696e         ref_chain
+0001b0e0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0001b0f0: 2020 5265 6665 7265 6e63 6520 7374 7275    Reference stru
+0001b100: 6374 7572 6520 696e 7374 616e 6365 0a20  cture instance. 
+0001b110: 2020 2020 2020 2020 2020 2070 726f 6265             probe
+0001b120: 5f63 6861 696e 3a0a 2020 2020 2020 2020  _chain:.        
+0001b130: 2020 2020 2020 2020 5072 6f62 6520 7374          Probe st
+0001b140: 7275 6374 7572 6520 696e 7374 616e 6365  ructure instance
+0001b150: 0a20 2020 2020 2020 2020 2020 206c 6f77  .            low
+0001b160: 6573 745f 7661 6c75 653a 0a20 2020 2020  est_value:.     
+0001b170: 2020 2020 2020 2020 2020 2056 616c 7565             Value
+0001b180: 2074 6f20 7573 6520 6966 2074 776f 2073   to use if two s
+0001b190: 7472 7563 7475 7265 7320 6172 6520 7065  tructures are pe
+0001b1a0: 7266 6563 746c 7920 616c 6967 6e65 6420  rfectly aligned 
+0001b1b0: 2869 2e65 2e20 6966 0a20 2020 2020 2020  (i.e. if.       
+0001b1c0: 2020 2020 2020 2020 2061 6c63 7073 203d           alcps =
+0001b1d0: 2030 2920 2d20 6465 6661 756c 7420 7661   0) - default va
+0001b1e0: 6c75 6520 6973 202d 320a 2020 2020 2020  lue is -2.      
+0001b1f0: 2020 4f75 7470 7574 733a 0a20 2020 2020    Outputs:.     
+0001b200: 2020 2020 2020 206c 6f67 3130 2861 6c63         log10(alc
+0001b210: 7073 293a 0a20 2020 2020 2020 2020 2020  ps):.           
+0001b220: 2020 2020 206c 6f67 3130 206f 6620 7468       log10 of th
+0001b230: 6520 414c 4350 530a 2020 2020 2020 2020  e ALCPS.        
+0001b240: 2020 2020 6c6f 7765 7374 5f76 616c 7565      lowest_value
+0001b250: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0001b260: 2020 7265 7475 726e 6564 2069 6620 414c    returned if AL
+0001b270: 4350 5320 3d20 302c 2064 6566 6175 6c74  CPS = 0, default
+0001b280: 2076 616c 7565 2069 7320 2d32 0a20 2020   value is -2.   
+0001b290: 2020 2020 2022 2222 0a0a 2020 2020 2020       """..      
+0001b2a0: 2020 616c 6370 7320 3d20 7365 6c66 2e63    alcps = self.c
+0001b2b0: 616c 6375 6c61 7465 5f61 6c63 7073 2872  alculate_alcps(r
+0001b2c0: 6566 5f63 6861 696e 2c20 7072 6f62 655f  ef_chain, probe_
+0001b2d0: 6368 6169 6e29 0a0a 2020 2020 2020 2020  chain)..        
+0001b2e0: 6966 2061 6c63 7073 203d 3d20 302e 303a  if alcps == 0.0:
+0001b2f0: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+0001b300: 7572 6e20 6c6f 7765 7374 5f76 616c 7565  urn lowest_value
+0001b310: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
+0001b320: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+0001b330: 6e20 6d61 7468 2e6c 6f67 3130 2861 6c63  n math.log10(alc
+0001b340: 7073 290a 0a20 2020 2064 6566 205f 6765  ps)..    def _ge
+0001b350: 745f 6d61 785f 6469 7374 616e 6365 5f62  t_max_distance_b
+0001b360: 6574 7765 656e 5f72 6573 6964 7565 7328  etween_residues(
+0001b370: 6174 6f6d 7329 3a0a 0a20 2020 2020 2020  atoms):..       
+0001b380: 206d 6178 5f64 6973 7420 3d20 300a 2020   max_dist = 0.  
+0001b390: 2020 2020 2020 6174 6f6d 5f6c 6973 7420        atom_list 
+0001b3a0: 3d20 6174 6f6d 735b 3a5d 0a20 2020 2020  = atoms[:].     
+0001b3b0: 2020 2066 6f72 2061 746f 6d20 696e 2061     for atom in a
+0001b3c0: 746f 6d73 3a0a 2020 2020 2020 2020 2020  toms:.          
+0001b3d0: 2020 6174 6f6d 5f6c 6973 742e 706f 7028    atom_list.pop(
+0001b3e0: 6174 6f6d 5f6c 6973 742e 696e 6465 7828  atom_list.index(
+0001b3f0: 6174 6f6d 2929 0a20 2020 2020 2020 2020  atom)).         
+0001b400: 2020 2066 6f72 2061 746f 6d32 2069 6e20     for atom2 in 
+0001b410: 6174 6f6d 5f6c 6973 743a 0a20 2020 2020  atom_list:.     
+0001b420: 2020 2020 2020 2020 2020 2076 6563 203d             vec =
+0001b430: 206e 702e 6c69 6e61 6c67 2e6e 6f72 6d28   np.linalg.norm(
+0001b440: 5b61 746f 6d2e 782c 2061 746f 6d2e 792c  [atom.x, atom.y,
+0001b450: 2061 746f 6d2e 7a5d 2c0a 2020 2020 2020   atom.z],.      
 0001b460: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b470: 2020 2020 2020 2020 2020 2020 2020 206d                 m
-0001b480: 6173 6b3d 4e6f 6e65 2c0a 2020 2020 2020  ask=None,.      
-0001b490: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b4a0: 2020 2020 2020 2020 2020 7369 6d5f 6d61            sim_ma
-0001b4b0: 703d 4e6f 6e65 2c0a 2020 2020 2020 2020  p=None,.        
+0001b470: 2020 2020 2020 2020 2020 2020 2020 205b                 [
+0001b480: 6174 6f6d 322e 782c 2061 746f 6d32 2e79  atom2.x, atom2.y
+0001b490: 2c20 6174 6f6d 322e 7a5d 290a 2020 2020  , atom2.z]).    
+0001b4a0: 2020 2020 2020 2020 2020 2020 6966 2076              if v
+0001b4b0: 6563 203e 206d 6178 5f64 6973 743a 0a20  ec > max_dist:. 
 0001b4c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b4d0: 2020 2020 2020 2020 6375 746f 6666 5f63          cutoff_c
-0001b4e0: 6f72 7265 6c61 7469 6f6e 3d30 2e35 2c0a  orrelation=0.5,.
-0001b4f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b500: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b510: 7573 655f 6869 6768 6573 745f 7265 736f  use_highest_reso
-0001b520: 6c75 7469 6f6e 3d54 7275 6529 3a0a 2020  lution=True):.  
-0001b530: 2020 2020 2020 2222 2243 616c 6375 6c61        """Calcula
-0001b540: 7465 2074 6865 204d 6170 2d6d 6f64 656c  te the Map-model
-0001b550: 2022 7265 736f 6c75 7469 6f6e 2220 7573   "resolution" us
-0001b560: 696e 6720 466f 7572 6965 7220 5368 656c  ing Fourier Shel
-0001b570: 6c20 436f 7272 656c 6174 696f 6e20 2846  l Correlation (F
-0001b580: 5343 292e 0a0a 2020 2020 2020 2020 4172  SC)...        Ar
-0001b590: 6775 6d65 6e74 733a 0a20 2020 2020 2020  guments:.       
-0001b5a0: 2020 2020 2073 7472 7563 7475 7265 3a20       structure: 
-0001b5b0: 4120 6d6f 6465 6c20 7374 7275 6374 7572  A model structur
-0001b5c0: 6520 696e 7374 616e 6365 2e0a 2020 2020  e instance..    
-0001b5d0: 2020 2020 2020 2020 7461 7267 6574 5f6d          target_m
-0001b5e0: 6170 3a20 4120 4d61 7020 696e 7374 616e  ap: A Map instan
-0001b5f0: 6365 2e0a 2020 2020 2020 2020 2020 2020  ce..            
-0001b600: 6d61 705f 7265 736f 6c75 7469 6f6e 3a20  map_resolution: 
-0001b610: 5468 6520 7265 736f 6c75 7469 6f6e 206f  The resolution o
-0001b620: 6620 7461 7267 6574 5f6d 6170 0a20 2020  f target_map.   
-0001b630: 2020 2020 2020 2020 206d 6173 6b3a 2041           mask: A
-0001b640: 204d 6170 2069 6e73 7461 6e63 6520 6f66   Map instance of
-0001b650: 2061 2073 6f66 742d 6564 6765 6420 6d61   a soft-edged ma
-0001b660: 736b 2e0a 2020 2020 2020 2020 2020 2020  sk..            
-0001b670: 7369 6d5f 6d61 703a 2041 204d 6170 2069  sim_map: A Map i
-0001b680: 6e73 7461 6e63 6520 6f66 2061 2070 7265  nstance of a pre
-0001b690: 2d63 616c 6375 6c61 7465 6420 7369 6d75  -calculated simu
-0001b6a0: 6c61 7465 6420 6d61 702c 2069 660a 2020  lated map, if.  
-0001b6b0: 2020 2020 2020 2020 2020 2020 2020 6e6f                no
-0001b6c0: 7420 6578 706c 6963 6974 6c79 2073 7570  t explicitly sup
-0001b6d0: 706c 6965 6420 6974 2077 696c 6c20 6265  plied it will be
-0001b6e0: 2063 616c 6375 6c61 7465 6420 6175 746f   calculated auto
-0001b6f0: 6d61 7469 6361 6c6c 790a 2020 2020 2020  matically.      
-0001b700: 2020 2020 2020 2020 2020 6672 6f6d 2074            from t
-0001b710: 6865 2073 7472 7563 7475 7265 2069 6e73  he structure ins
-0001b720: 7461 6e63 652e 0a20 2020 2020 2020 2020  tance..         
-0001b730: 2020 2063 7574 6f66 665f 636f 7272 656c     cutoff_correl
-0001b740: 6174 696f 6e3a 2054 6872 6573 686f 6c64  ation: Threshold
-0001b750: 2063 6f72 7265 6c61 7469 6f6e 2075 7365   correlation use
-0001b760: 6420 746f 2064 6566 696e 6520 7468 650a  d to define the.
-0001b770: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b780: 6d6f 6465 6c2d 6d61 7020 2272 6573 6f6c  model-map "resol
-0001b790: 7574 696f 6e22 2e0a 2020 2020 2020 2020  ution"..        
-0001b7a0: 2020 2020 7573 655f 6869 6768 6573 745f      use_highest_
-0001b7b0: 7265 736f 6c75 7469 6f6e 3a20 4966 2054  resolution: If T
-0001b7c0: 7275 652c 2074 6865 2068 6967 6865 7374  rue, the highest
-0001b7d0: 2072 6573 6f6c 7574 696f 6e20 7368 656c   resolution shel
-0001b7e0: 6c0a 2020 2020 2020 2020 2020 2020 2020  l.              
-0001b7f0: 2020 7468 6174 2063 726f 7373 6573 2074    that crosses t
-0001b800: 6865 2063 7574 6f66 665f 636f 7272 656c  he cutoff_correl
-0001b810: 6174 696f 6e20 7468 7265 7368 6f6c 6420  ation threshold 
-0001b820: 6973 2074 616b 656e 2e0a 2020 2020 2020  is taken..      
-0001b830: 2020 2020 2020 2020 2020 4f74 6865 7277            Otherw
-0001b840: 6973 652c 2074 6865 2066 7265 7175 656e  ise, the frequen
-0001b850: 6379 2074 6861 7420 6669 7273 7420 6372  cy that first cr
-0001b860: 6f73 7365 7320 7468 6520 7468 7265 7368  osses the thresh
-0001b870: 6f6c 640a 2020 2020 2020 2020 2020 2020  old.            
-0001b880: 2020 2020 6973 2074 616b 656e 2e0a 0a20      is taken... 
-0001b890: 2020 2020 2020 2052 6574 7572 6e73 3a0a         Returns:.
-0001b8a0: 2020 2020 2020 2020 2020 2020 4d61 702d              Map-
-0001b8b0: 6d6f 6465 6c20 4653 4320 2272 6573 6f6c  model FSC "resol
-0001b8c0: 7574 696f 6e22 3a20 5468 6520 666f 7572  ution": The four
-0001b8d0: 6965 7220 7368 656c 6c20 6672 6571 7565  ier shell freque
-0001b8e0: 6e63 790a 2020 2020 2020 2020 2020 2020  ncy.            
-0001b8f0: 2869 6e20 616e 6773 7472 6f6d 7329 2077  (in angstroms) w
-0001b900: 6865 7265 2074 6865 2063 6f72 7265 6c61  here the correla
-0001b910: 7469 6f6e 2063 726f 7373 6573 2074 6865  tion crosses the
-0001b920: 2073 7461 7465 640a 2020 2020 2020 2020   stated.        
-0001b930: 2020 2020 7468 7265 7368 6f6c 642e 0a20      threshold.. 
-0001b940: 2020 2020 2020 2022 2222 0a0a 2020 2020         """..    
-0001b950: 2020 2020 6966 2073 696d 5f6d 6170 2069      if sim_map i
-0001b960: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
-0001b970: 2020 2020 626c 7572 7265 7220 3d20 5374      blurrer = St
-0001b980: 7275 6374 7572 6542 6c75 7272 6572 2877  ructureBlurrer(w
-0001b990: 6974 685f 7663 3d54 7275 6529 0a20 2020  ith_vc=True).   
-0001b9a0: 2020 2020 2020 2020 2073 696d 5f6d 6170           sim_map
-0001b9b0: 203d 2062 6c75 7272 6572 2e67 6175 7373   = blurrer.gauss
-0001b9c0: 6961 6e5f 626c 7572 5f72 6561 6c5f 7370  ian_blur_real_sp
-0001b9d0: 6163 6528 0a20 2020 2020 2020 2020 2020  ace(.           
-0001b9e0: 2020 2020 2073 7472 7563 7475 7265 2c0a       structure,.
-0001b9f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ba00: 6d61 705f 7265 736f 6c75 7469 6f6e 2c0a  map_resolution,.
-0001ba10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ba20: 6465 6e73 4d61 703d 7461 7267 6574 5f6d  densMap=target_m
-0001ba30: 6170 2c0a 2020 2020 2020 2020 2020 2020  ap,.            
-0001ba40: 2020 2020 290a 0a20 2020 2020 2020 2066      )..        f
-0001ba50: 7363 203d 2073 656c 662e 6d61 705f 6d6f  sc = self.map_mo
-0001ba60: 6465 6c5f 6673 6328 7374 7275 6374 7572  del_fsc(structur
-0001ba70: 652c 2074 6172 6765 745f 6d61 702c 206d  e, target_map, m
-0001ba80: 6170 5f72 6573 6f6c 7574 696f 6e2c 0a20  ap_resolution,. 
-0001ba90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001baa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001bab0: 6d61 736b 3d6d 6173 6b2c 2073 696d 5f6d  mask=mask, sim_m
-0001bac0: 6170 3d73 696d 5f6d 6170 290a 0a20 2020  ap=sim_map)..   
-0001bad0: 2020 2020 206d 6178 5f66 7265 7175 656e       max_frequen
-0001bae0: 6379 5f61 745f 6375 746f 6666 203d 2066  cy_at_cutoff = f
-0001baf0: 6f75 7269 6572 2e67 6574 5f66 7363 5f72  ourier.get_fsc_r
-0001bb00: 6573 6f6c 7574 696f 6e28 0a20 2020 2020  esolution(.     
-0001bb10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001bb20: 2020 2020 2020 2020 2020 2066 7363 2c0a             fsc,.
-0001bb30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b4d0: 2020 206d 6178 5f64 6973 7420 3d20 7665     max_dist = ve
+0001b4e0: 630a 2020 2020 2020 2020 7265 7475 726e  c.        return
+0001b4f0: 206d 6178 5f64 6973 740a 0a20 2020 2064   max_dist..    d
+0001b500: 6566 206d 6170 5f6d 6f64 656c 5f66 7363  ef map_model_fsc
+0001b510: 5f72 6573 6f6c 7574 696f 6e28 0a20 2020  _resolution(.   
+0001b520: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b530: 2020 2020 2020 2020 2020 2020 2073 656c               sel
+0001b540: 662c 0a20 2020 2020 2020 2020 2020 2020  f,.             
+0001b550: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b560: 2020 2073 7472 7563 7475 7265 2c0a 2020     structure,.  
+0001b570: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b580: 2020 2020 2020 2020 2020 2020 2020 7461                ta
+0001b590: 7267 6574 5f6d 6170 2c0a 2020 2020 2020  rget_map,.      
+0001b5a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b5b0: 2020 2020 2020 2020 2020 6d61 705f 7265            map_re
+0001b5c0: 736f 6c75 7469 6f6e 2c0a 2020 2020 2020  solution,.      
+0001b5d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b5e0: 2020 2020 2020 2020 2020 6d61 736b 3d4e            mask=N
+0001b5f0: 6f6e 652c 0a20 2020 2020 2020 2020 2020  one,.           
+0001b600: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b610: 2020 2020 2073 696d 5f6d 6170 3d4e 6f6e       sim_map=Non
+0001b620: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
+0001b630: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b640: 2020 2063 7574 6f66 665f 636f 7272 656c     cutoff_correl
+0001b650: 6174 696f 6e3d 302e 352c 0a20 2020 2020  ation=0.5,.     
+0001b660: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b670: 2020 2020 2020 2020 2020 2075 7365 5f68             use_h
+0001b680: 6967 6865 7374 5f72 6573 6f6c 7574 696f  ighest_resolutio
+0001b690: 6e3d 5472 7565 293a 0a20 2020 2020 2020  n=True):.       
+0001b6a0: 2022 2222 4361 6c63 756c 6174 6520 7468   """Calculate th
+0001b6b0: 6520 4d61 702d 6d6f 6465 6c20 2272 6573  e Map-model "res
+0001b6c0: 6f6c 7574 696f 6e22 2075 7369 6e67 2046  olution" using F
+0001b6d0: 6f75 7269 6572 2053 6865 6c6c 2043 6f72  ourier Shell Cor
+0001b6e0: 7265 6c61 7469 6f6e 2028 4653 4329 2e0a  relation (FSC)..
+0001b6f0: 0a20 2020 2020 2020 2041 7267 756d 656e  .        Argumen
+0001b700: 7473 3a0a 2020 2020 2020 2020 2020 2020  ts:.            
+0001b710: 7374 7275 6374 7572 653a 2041 206d 6f64  structure: A mod
+0001b720: 656c 2073 7472 7563 7475 7265 2069 6e73  el structure ins
+0001b730: 7461 6e63 652e 0a20 2020 2020 2020 2020  tance..         
+0001b740: 2020 2074 6172 6765 745f 6d61 703a 2041     target_map: A
+0001b750: 204d 6170 2069 6e73 7461 6e63 652e 0a20   Map instance.. 
+0001b760: 2020 2020 2020 2020 2020 206d 6170 5f72             map_r
+0001b770: 6573 6f6c 7574 696f 6e3a 2054 6865 2072  esolution: The r
+0001b780: 6573 6f6c 7574 696f 6e20 6f66 2074 6172  esolution of tar
+0001b790: 6765 745f 6d61 700a 2020 2020 2020 2020  get_map.        
+0001b7a0: 2020 2020 6d61 736b 3a20 4120 4d61 7020      mask: A Map 
+0001b7b0: 696e 7374 616e 6365 206f 6620 6120 736f  instance of a so
+0001b7c0: 6674 2d65 6467 6564 206d 6173 6b2e 0a20  ft-edged mask.. 
+0001b7d0: 2020 2020 2020 2020 2020 2073 696d 5f6d             sim_m
+0001b7e0: 6170 3a20 4120 4d61 7020 696e 7374 616e  ap: A Map instan
+0001b7f0: 6365 206f 6620 6120 7072 652d 6361 6c63  ce of a pre-calc
+0001b800: 756c 6174 6564 2073 696d 756c 6174 6564  ulated simulated
+0001b810: 206d 6170 2c20 6966 0a20 2020 2020 2020   map, if.       
+0001b820: 2020 2020 2020 2020 206e 6f74 2065 7870           not exp
+0001b830: 6c69 6369 746c 7920 7375 7070 6c69 6564  licitly supplied
+0001b840: 2069 7420 7769 6c6c 2062 6520 6361 6c63   it will be calc
+0001b850: 756c 6174 6564 2061 7574 6f6d 6174 6963  ulated automatic
+0001b860: 616c 6c79 0a20 2020 2020 2020 2020 2020  ally.           
+0001b870: 2020 2020 2066 726f 6d20 7468 6520 7374       from the st
+0001b880: 7275 6374 7572 6520 696e 7374 616e 6365  ructure instance
+0001b890: 2e0a 2020 2020 2020 2020 2020 2020 6375  ..            cu
+0001b8a0: 746f 6666 5f63 6f72 7265 6c61 7469 6f6e  toff_correlation
+0001b8b0: 3a20 5468 7265 7368 6f6c 6420 636f 7272  : Threshold corr
+0001b8c0: 656c 6174 696f 6e20 7573 6564 2074 6f20  elation used to 
+0001b8d0: 6465 6669 6e65 2074 6865 0a20 2020 2020  define the.     
+0001b8e0: 2020 2020 2020 2020 2020 206d 6f64 656c             model
+0001b8f0: 2d6d 6170 2022 7265 736f 6c75 7469 6f6e  -map "resolution
+0001b900: 222e 0a20 2020 2020 2020 2020 2020 2075  "..            u
+0001b910: 7365 5f68 6967 6865 7374 5f72 6573 6f6c  se_highest_resol
+0001b920: 7574 696f 6e3a 2049 6620 5472 7565 2c20  ution: If True, 
+0001b930: 7468 6520 6869 6768 6573 7420 7265 736f  the highest reso
+0001b940: 6c75 7469 6f6e 2073 6865 6c6c 0a20 2020  lution shell.   
+0001b950: 2020 2020 2020 2020 2020 2020 2074 6861               tha
+0001b960: 7420 6372 6f73 7365 7320 7468 6520 6375  t crosses the cu
+0001b970: 746f 6666 5f63 6f72 7265 6c61 7469 6f6e  toff_correlation
+0001b980: 2074 6872 6573 686f 6c64 2069 7320 7461   threshold is ta
+0001b990: 6b65 6e2e 0a20 2020 2020 2020 2020 2020  ken..           
+0001b9a0: 2020 2020 204f 7468 6572 7769 7365 2c20       Otherwise, 
+0001b9b0: 7468 6520 6672 6571 7565 6e63 7920 7468  the frequency th
+0001b9c0: 6174 2066 6972 7374 2063 726f 7373 6573  at first crosses
+0001b9d0: 2074 6865 2074 6872 6573 686f 6c64 0a20   the threshold. 
+0001b9e0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+0001b9f0: 7320 7461 6b65 6e2e 0a0a 2020 2020 2020  s taken...      
+0001ba00: 2020 5265 7475 726e 733a 0a20 2020 2020    Returns:.     
+0001ba10: 2020 2020 2020 204d 6170 2d6d 6f64 656c         Map-model
+0001ba20: 2046 5343 2022 7265 736f 6c75 7469 6f6e   FSC "resolution
+0001ba30: 223a 2054 6865 2066 6f75 7269 6572 2073  ": The fourier s
+0001ba40: 6865 6c6c 2066 7265 7175 656e 6379 0a20  hell frequency. 
+0001ba50: 2020 2020 2020 2020 2020 2028 696e 2061             (in a
+0001ba60: 6e67 7374 726f 6d73 2920 7768 6572 6520  ngstroms) where 
+0001ba70: 7468 6520 636f 7272 656c 6174 696f 6e20  the correlation 
+0001ba80: 6372 6f73 7365 7320 7468 6520 7374 6174  crosses the stat
+0001ba90: 6564 0a20 2020 2020 2020 2020 2020 2074  ed.            t
+0001baa0: 6872 6573 686f 6c64 2e0a 2020 2020 2020  hreshold..      
+0001bab0: 2020 2222 220a 0a20 2020 2020 2020 2069    """..        i
+0001bac0: 6620 7369 6d5f 6d61 7020 6973 204e 6f6e  f sim_map is Non
+0001bad0: 653a 0a20 2020 2020 2020 2020 2020 2062  e:.            b
+0001bae0: 6c75 7272 6572 203d 2053 7472 7563 7475  lurrer = Structu
+0001baf0: 7265 426c 7572 7265 7228 7769 7468 5f76  reBlurrer(with_v
+0001bb00: 633d 5472 7565 290a 2020 2020 2020 2020  c=True).        
+0001bb10: 2020 2020 7369 6d5f 6d61 7020 3d20 626c      sim_map = bl
+0001bb20: 7572 7265 722e 6761 7573 7369 616e 5f62  urrer.gaussian_b
+0001bb30: 6c75 725f 7265 616c 5f73 7061 6365 280a  lur_real_space(.
 0001bb40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001bb50: 6673 635f 7468 7265 7368 6f6c 643d 6375  fsc_threshold=cu
-0001bb60: 746f 6666 5f63 6f72 7265 6c61 7469 6f6e  toff_correlation
-0001bb70: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0001bb80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001bb90: 2020 696e 7465 7270 6f6c 6174 655f 6375    interpolate_cu
-0001bba0: 746f 6666 3d46 616c 7365 2c0a 2020 2020  toff=False,.    
-0001bbb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001bbc0: 2020 2020 2020 2020 2020 2020 7573 655f              use_
-0001bbd0: 6869 6768 6573 745f 7265 736f 6c75 7469  highest_resoluti
-0001bbe0: 6f6e 3d75 7365 5f68 6967 6865 7374 5f72  on=use_highest_r
-0001bbf0: 6573 6f6c 7574 696f 6e0a 2020 2020 2020  esolution.      
+0001bb50: 7374 7275 6374 7572 652c 0a20 2020 2020  structure,.     
+0001bb60: 2020 2020 2020 2020 2020 206d 6170 5f72             map_r
+0001bb70: 6573 6f6c 7574 696f 6e2c 0a20 2020 2020  esolution,.     
+0001bb80: 2020 2020 2020 2020 2020 2064 656e 734d             densM
+0001bb90: 6170 3d74 6172 6765 745f 6d61 702c 0a20  ap=target_map,. 
+0001bba0: 2020 2020 2020 2020 2020 2020 2020 2029                 )
+0001bbb0: 0a0a 2020 2020 2020 2020 6673 6320 3d20  ..        fsc = 
+0001bbc0: 7365 6c66 2e6d 6170 5f6d 6f64 656c 5f66  self.map_model_f
+0001bbd0: 7363 2873 7472 7563 7475 7265 2c20 7461  sc(structure, ta
+0001bbe0: 7267 6574 5f6d 6170 2c20 6d61 705f 7265  rget_map, map_re
+0001bbf0: 736f 6c75 7469 6f6e 2c0a 2020 2020 2020  solution,.      
 0001bc00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001bc10: 2020 2020 2020 2020 2020 290a 0a20 2020            )..   
-0001bc20: 2020 2020 2072 6574 7572 6e20 6d61 785f       return max_
-0001bc30: 6672 6571 7565 6e63 795f 6174 5f63 7574  frequency_at_cut
-0001bc40: 6f66 660a 0a20 2020 2064 6566 206d 6170  off..    def map
-0001bc50: 5f6d 6f64 656c 5f66 7363 2873 656c 662c  _model_fsc(self,
-0001bc60: 2073 7472 7563 7475 7265 2c20 7461 7267   structure, targ
-0001bc70: 6574 5f6d 6170 2c20 6d61 705f 7265 736f  et_map, map_reso
-0001bc80: 6c75 7469 6f6e 2c20 6d61 736b 3d4e 6f6e  lution, mask=Non
-0001bc90: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
-0001bca0: 2020 2020 2020 2020 2073 696d 5f6d 6170           sim_map
-0001bcb0: 3d4e 6f6e 6529 3a0a 2020 2020 2020 2020  =None):.        
-0001bcc0: 2222 2243 616c 6375 6c61 7465 2074 6865  """Calculate the
-0001bcd0: 206d 6170 2d6d 6f64 656c 2046 6f75 7269   map-model Fouri
-0001bce0: 6572 2053 6865 6c6c 2043 6f72 7265 6c61  er Shell Correla
-0001bcf0: 7469 6f6e 2028 4653 4329 2e0a 0a20 2020  tion (FSC)...   
-0001bd00: 2020 2020 2041 7267 756d 656e 7473 3a0a       Arguments:.
-0001bd10: 2020 2020 2020 2020 2020 2020 7374 7275              stru
-0001bd20: 6374 7572 653a 2041 206d 6f64 656c 2073  cture: A model s
-0001bd30: 7472 7563 7475 7265 2069 6e73 7461 6e63  tructure instanc
-0001bd40: 652e 0a20 2020 2020 2020 2020 2020 2074  e..            t
-0001bd50: 6172 6765 745f 6d61 703a 2041 204d 6170  arget_map: A Map
-0001bd60: 2069 6e73 7461 6e63 652e 0a20 2020 2020   instance..     
-0001bd70: 2020 2020 2020 206d 6170 5f72 6573 6f6c         map_resol
-0001bd80: 7574 696f 6e3a 2054 6865 2072 6573 6f6c  ution: The resol
-0001bd90: 7574 696f 6e20 6f66 2074 6172 6765 745f  ution of target_
-0001bda0: 6d61 700a 2020 2020 2020 2020 2020 2020  map.            
-0001bdb0: 6d61 736b 3a20 4120 4d61 7020 696e 7374  mask: A Map inst
-0001bdc0: 616e 6365 206f 6620 6120 736f 6674 2d65  ance of a soft-e
-0001bdd0: 6467 6564 206d 6173 6b2e 0a20 2020 2020  dged mask..     
-0001bde0: 2020 2020 2020 2073 696d 5f6d 6170 3a20         sim_map: 
-0001bdf0: 4120 4d61 7020 696e 7374 616e 6365 206f  A Map instance o
-0001be00: 6620 6120 7072 652d 6361 6c63 756c 6174  f a pre-calculat
-0001be10: 6564 2073 696d 756c 6174 6564 206d 6170  ed simulated map
-0001be20: 2c20 6966 0a20 2020 2020 2020 2020 2020  , if.           
-0001be30: 2020 2020 206e 6f74 2065 7870 6c69 6369       not explici
-0001be40: 746c 7920 7375 7070 6c69 6564 2069 7420  tly supplied it 
-0001be50: 7769 6c6c 2062 6520 6361 6c63 756c 6174  will be calculat
-0001be60: 6564 2061 7574 6f6d 6174 6963 616c 6c79  ed automatically
-0001be70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001be80: 2066 726f 6d20 7468 6520 7374 7275 6374   from the struct
-0001be90: 7572 6520 696e 7374 616e 6365 0a0a 2020  ure instance..  
-0001bea0: 2020 2020 2020 5265 7475 726e 733a 0a20        Returns:. 
-0001beb0: 2020 2020 2020 2020 2020 2054 6865 206d             The m
-0001bec0: 6170 2d6d 6f64 656c 2046 5343 2061 7320  ap-model FSC as 
-0001bed0: 616e 206e 702e 6172 7261 7920 7769 7468  an np.array with
-0001bee0: 2073 6861 7065 2028 322c 2028 4e20 2f20   shape (2, (N / 
-0001bef0: 3229 202b 2031 2920 666f 720a 2020 2020  2) + 1) for.    
-0001bf00: 2020 2020 2020 2020 616e 2069 6e70 7574          an input
-0001bf10: 206d 6170 2077 6974 6820 7368 6170 6520   map with shape 
-0001bf20: 284e 2c20 4e2c 204e 292e 204f 7574 7075  (N, N, N). Outpu
-0001bf30: 7420 6861 7320 666f 726d 6174 3a0a 2020  t has format:.  
-0001bf40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001bf50: 2020 5b5b 7368 656c 6c20 6672 6571 7565    [[shell freque
-0001bf60: 6e63 7920 2861 6e67 7374 726f 6d73 292c  ncy (angstroms),
-0001bf70: 2063 6f72 7265 6c61 7469 6f6e 5d0a 2020   correlation].  
-0001bf80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001bf90: 2020 2020 2020 2020 2020 2020 2020 2e2e                ..
-0001bfa0: 2e2e 2e2e 2e2e 0a20 2020 2020 2020 2020  .......         
-0001bfb0: 2020 2020 2020 2020 2020 205b 7368 656c             [shel
-0001bfc0: 6c20 6672 6571 7565 6e63 7920 2861 6e67  l frequency (ang
-0001bfd0: 7374 726f 6d73 292c 2063 6f72 7265 6c61  stroms), correla
-0001bfe0: 7469 6f6e 5d5d 0a0a 2020 2020 2020 2020  tion]]..        
-0001bff0: 2222 220a 2020 2020 2020 2020 6966 2073  """.        if s
-0001c000: 696d 5f6d 6170 2069 7320 4e6f 6e65 3a0a  im_map is None:.
-0001c010: 2020 2020 2020 2020 2020 2020 626c 7572              blur
-0001c020: 7265 7220 3d20 5374 7275 6374 7572 6542  rer = StructureB
-0001c030: 6c75 7272 6572 2877 6974 685f 7663 3d54  lurrer(with_vc=T
-0001c040: 7275 6529 0a20 2020 2020 2020 2020 2020  rue).           
-0001c050: 2073 696d 5f6d 6170 203d 2062 6c75 7272   sim_map = blurr
-0001c060: 6572 2e67 6175 7373 6961 6e5f 626c 7572  er.gaussian_blur
-0001c070: 5f72 6561 6c5f 7370 6163 6528 0a20 2020  _real_space(.   
-0001c080: 2020 2020 2020 2020 2020 2020 2073 7472               str
-0001c090: 7563 7475 7265 2c0a 2020 2020 2020 2020  ucture,.        
-0001c0a0: 2020 2020 2020 2020 6d61 705f 7265 736f          map_reso
-0001c0b0: 6c75 7469 6f6e 2c0a 2020 2020 2020 2020  lution,.        
-0001c0c0: 2020 2020 2020 2020 6465 6e73 4d61 703d          densMap=
-0001c0d0: 7461 7267 6574 5f6d 6170 2c0a 2020 2020  target_map,.    
-0001c0e0: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
-0001c0f0: 2020 2069 6620 6d61 736b 3a0a 2020 2020     if mask:.    
-0001c100: 2020 2020 2020 2020 6673 6320 3d20 666f          fsc = fo
-0001c110: 7572 6965 722e 6361 6c63 756c 6174 655f  urier.calculate_
-0001c120: 6673 635f 7769 7468 5f6d 6173 6b28 0a20  fsc_with_mask(. 
-0001c130: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c140: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c150: 2020 2020 2020 2020 2020 2020 2020 2074                 t
-0001c160: 6172 6765 745f 6d61 702e 6675 6c6c 4d61  arget_map.fullMa
-0001c170: 702c 0a20 2020 2020 2020 2020 2020 2020  p,.             
-0001c180: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c190: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c1a0: 2020 2073 696d 5f6d 6170 2e66 756c 6c4d     sim_map.fullM
-0001c1b0: 6170 2c0a 2020 2020 2020 2020 2020 2020  ap,.            
-0001c1c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c1d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c1e0: 2020 2020 6d61 736b 2c0a 2020 2020 2020      mask,.      
-0001c1f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c200: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c210: 2020 2020 2020 2020 2020 7069 7865 6c5f            pixel_
-0001c220: 7369 7a65 3d74 6172 6765 745f 6d61 702e  size=target_map.
-0001c230: 6170 6978 5b30 5d2c 0a20 2020 2020 2020  apix[0],.       
-0001c240: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c250: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c260: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
-0001c270: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-0001c280: 2020 2020 2066 7363 203d 2066 6f75 7269       fsc = fouri
-0001c290: 6572 2e63 616c 6375 6c61 7465 5f66 7363  er.calculate_fsc
-0001c2a0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+0001bc10: 2020 2020 2020 2020 2020 206d 6173 6b3d             mask=
+0001bc20: 6d61 736b 2c20 7369 6d5f 6d61 703d 7369  mask, sim_map=si
+0001bc30: 6d5f 6d61 7029 0a0a 2020 2020 2020 2020  m_map)..        
+0001bc40: 6d61 785f 6672 6571 7565 6e63 795f 6174  max_frequency_at
+0001bc50: 5f63 7574 6f66 6620 3d20 666f 7572 6965  _cutoff = fourie
+0001bc60: 722e 6765 745f 6673 635f 7265 736f 6c75  r.get_fsc_resolu
+0001bc70: 7469 6f6e 280a 2020 2020 2020 2020 2020  tion(.          
+0001bc80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001bc90: 2020 2020 2020 6673 632c 0a20 2020 2020        fsc,.     
+0001bca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001bcb0: 2020 2020 2020 2020 2020 2066 7363 5f74             fsc_t
+0001bcc0: 6872 6573 686f 6c64 3d63 7574 6f66 665f  hreshold=cutoff_
+0001bcd0: 636f 7272 656c 6174 696f 6e2c 0a20 2020  correlation,.   
+0001bce0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001bcf0: 2020 2020 2020 2020 2020 2020 2069 6e74               int
+0001bd00: 6572 706f 6c61 7465 5f63 7574 6f66 663d  erpolate_cutoff=
+0001bd10: 4661 6c73 652c 0a20 2020 2020 2020 2020  False,.         
+0001bd20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001bd30: 2020 2020 2020 2075 7365 5f68 6967 6865         use_highe
+0001bd40: 7374 5f72 6573 6f6c 7574 696f 6e3d 7573  st_resolution=us
+0001bd50: 655f 6869 6768 6573 745f 7265 736f 6c75  e_highest_resolu
+0001bd60: 7469 6f6e 0a20 2020 2020 2020 2020 2020  tion.           
+0001bd70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001bd80: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
+0001bd90: 7265 7475 726e 206d 6178 5f66 7265 7175  return max_frequ
+0001bda0: 656e 6379 5f61 745f 6375 746f 6666 0a0a  ency_at_cutoff..
+0001bdb0: 2020 2020 6465 6620 6d61 705f 6d6f 6465      def map_mode
+0001bdc0: 6c5f 6673 6328 7365 6c66 2c20 7374 7275  l_fsc(self, stru
+0001bdd0: 6374 7572 652c 2074 6172 6765 745f 6d61  cture, target_ma
+0001bde0: 702c 206d 6170 5f72 6573 6f6c 7574 696f  p, map_resolutio
+0001bdf0: 6e2c 206d 6173 6b3d 4e6f 6e65 2c0a 2020  n, mask=None,.  
+0001be00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001be10: 2020 2020 7369 6d5f 6d61 703d 4e6f 6e65      sim_map=None
+0001be20: 293a 0a20 2020 2020 2020 2022 2222 4361  ):.        """Ca
+0001be30: 6c63 756c 6174 6520 7468 6520 6d61 702d  lculate the map-
+0001be40: 6d6f 6465 6c20 466f 7572 6965 7220 5368  model Fourier Sh
+0001be50: 656c 6c20 436f 7272 656c 6174 696f 6e20  ell Correlation 
+0001be60: 2846 5343 292e 0a0a 2020 2020 2020 2020  (FSC)...        
+0001be70: 4172 6775 6d65 6e74 733a 0a20 2020 2020  Arguments:.     
+0001be80: 2020 2020 2020 2073 7472 7563 7475 7265         structure
+0001be90: 3a20 4120 6d6f 6465 6c20 7374 7275 6374  : A model struct
+0001bea0: 7572 6520 696e 7374 616e 6365 2e0a 2020  ure instance..  
+0001beb0: 2020 2020 2020 2020 2020 7461 7267 6574            target
+0001bec0: 5f6d 6170 3a20 4120 4d61 7020 696e 7374  _map: A Map inst
+0001bed0: 616e 6365 2e0a 2020 2020 2020 2020 2020  ance..          
+0001bee0: 2020 6d61 705f 7265 736f 6c75 7469 6f6e    map_resolution
+0001bef0: 3a20 5468 6520 7265 736f 6c75 7469 6f6e  : The resolution
+0001bf00: 206f 6620 7461 7267 6574 5f6d 6170 0a20   of target_map. 
+0001bf10: 2020 2020 2020 2020 2020 206d 6173 6b3a             mask:
+0001bf20: 2041 204d 6170 2069 6e73 7461 6e63 6520   A Map instance 
+0001bf30: 6f66 2061 2073 6f66 742d 6564 6765 6420  of a soft-edged 
+0001bf40: 6d61 736b 2e0a 2020 2020 2020 2020 2020  mask..          
+0001bf50: 2020 7369 6d5f 6d61 703a 2041 204d 6170    sim_map: A Map
+0001bf60: 2069 6e73 7461 6e63 6520 6f66 2061 2070   instance of a p
+0001bf70: 7265 2d63 616c 6375 6c61 7465 6420 7369  re-calculated si
+0001bf80: 6d75 6c61 7465 6420 6d61 702c 2069 660a  mulated map, if.
+0001bf90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001bfa0: 6e6f 7420 6578 706c 6963 6974 6c79 2073  not explicitly s
+0001bfb0: 7570 706c 6965 6420 6974 2077 696c 6c20  upplied it will 
+0001bfc0: 6265 2063 616c 6375 6c61 7465 6420 6175  be calculated au
+0001bfd0: 746f 6d61 7469 6361 6c6c 790a 2020 2020  tomatically.    
+0001bfe0: 2020 2020 2020 2020 2020 2020 6672 6f6d              from
+0001bff0: 2074 6865 2073 7472 7563 7475 7265 2069   the structure i
+0001c000: 6e73 7461 6e63 650a 0a20 2020 2020 2020  nstance..       
+0001c010: 2052 6574 7572 6e73 3a0a 2020 2020 2020   Returns:.      
+0001c020: 2020 2020 2020 5468 6520 6d61 702d 6d6f        The map-mo
+0001c030: 6465 6c20 4653 4320 6173 2061 6e20 6e70  del FSC as an np
+0001c040: 2e61 7272 6179 2077 6974 6820 7368 6170  .array with shap
+0001c050: 6520 2832 2c20 284e 202f 2032 2920 2b20  e (2, (N / 2) + 
+0001c060: 3129 2066 6f72 0a20 2020 2020 2020 2020  1) for.         
+0001c070: 2020 2061 6e20 696e 7075 7420 6d61 7020     an input map 
+0001c080: 7769 7468 2073 6861 7065 2028 4e2c 204e  with shape (N, N
+0001c090: 2c20 4e29 2e20 4f75 7470 7574 2068 6173  , N). Output has
+0001c0a0: 2066 6f72 6d61 743a 0a20 2020 2020 2020   format:.       
+0001c0b0: 2020 2020 2020 2020 2020 2020 205b 5b73               [[s
+0001c0c0: 6865 6c6c 2066 7265 7175 656e 6379 2028  hell frequency (
+0001c0d0: 616e 6773 7472 6f6d 7329 2c20 636f 7272  angstroms), corr
+0001c0e0: 656c 6174 696f 6e5d 0a20 2020 2020 2020  elation].       
+0001c0f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c100: 2020 2020 2020 2020 202e 2e2e 2e2e 2e2e           .......
+0001c110: 2e0a 2020 2020 2020 2020 2020 2020 2020  ..              
+0001c120: 2020 2020 2020 5b73 6865 6c6c 2066 7265        [shell fre
+0001c130: 7175 656e 6379 2028 616e 6773 7472 6f6d  quency (angstrom
+0001c140: 7329 2c20 636f 7272 656c 6174 696f 6e5d  s), correlation]
+0001c150: 5d0a 0a20 2020 2020 2020 2022 2222 0a20  ]..        """. 
+0001c160: 2020 2020 2020 2069 6620 7369 6d5f 6d61         if sim_ma
+0001c170: 7020 6973 204e 6f6e 653a 0a20 2020 2020  p is None:.     
+0001c180: 2020 2020 2020 2062 6c75 7272 6572 203d         blurrer =
+0001c190: 2053 7472 7563 7475 7265 426c 7572 7265   StructureBlurre
+0001c1a0: 7228 7769 7468 5f76 633d 5472 7565 290a  r(with_vc=True).
+0001c1b0: 2020 2020 2020 2020 2020 2020 7369 6d5f              sim_
+0001c1c0: 6d61 7020 3d20 626c 7572 7265 722e 6761  map = blurrer.ga
+0001c1d0: 7573 7369 616e 5f62 6c75 725f 7265 616c  ussian_blur_real
+0001c1e0: 5f73 7061 6365 280a 2020 2020 2020 2020  _space(.        
+0001c1f0: 2020 2020 2020 2020 7374 7275 6374 7572          structur
+0001c200: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
+0001c210: 2020 206d 6170 5f72 6573 6f6c 7574 696f     map_resolutio
+0001c220: 6e2c 0a20 2020 2020 2020 2020 2020 2020  n,.             
+0001c230: 2020 2064 656e 734d 6170 3d74 6172 6765     densMap=targe
+0001c240: 745f 6d61 702c 0a20 2020 2020 2020 2020  t_map,.         
+0001c250: 2020 2029 0a0a 2020 2020 2020 2020 6966     )..        if
+0001c260: 206d 6173 6b3a 0a20 2020 2020 2020 2020   mask:.         
+0001c270: 2020 2066 7363 203d 2066 6f75 7269 6572     fsc = fourier
+0001c280: 2e63 616c 6375 6c61 7465 5f66 7363 5f77  .calculate_fsc_w
+0001c290: 6974 685f 6d61 736b 280a 2020 2020 2020  ith_mask(.      
+0001c2a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0001c2b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0001c2c0: 2020 2020 2020 2020 2020 7461 7267 6574            target
 0001c2d0: 5f6d 6170 2e66 756c 6c4d 6170 2c0a 2020  _map.fullMap,.  
 0001c2e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0001c2f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c300: 2020 2020 2020 7369 6d5f 6d61 702e 6675        sim_map.fu
-0001c310: 6c6c 4d61 702c 0a20 2020 2020 2020 2020  llMap,.         
+0001c300: 2020 2020 2020 2020 2020 2020 2020 7369                si
+0001c310: 6d5f 6d61 702e 6675 6c6c 4d61 702c 0a20  m_map.fullMap,. 
 0001c320: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c330: 2020 2020 2020 2020 2020 2020 2020 2070                 p
-0001c340: 6978 656c 5f73 697a 653d 7461 7267 6574  ixel_size=target
-0001c350: 5f6d 6170 2e61 7069 785b 305d 2c0a 2020  _map.apix[0],.  
+0001c330: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c340: 2020 2020 2020 2020 2020 2020 2020 206d                 m
+0001c350: 6173 6b2c 0a20 2020 2020 2020 2020 2020  ask,.           
 0001c360: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0001c370: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c380: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
-0001c390: 2072 6574 7572 6e20 6673 630a 0a20 2020   return fsc..   
-0001c3a0: 2064 6566 204c 6f51 4669 7428 0a20 2020   def LoQFit(.   
-0001c3b0: 2020 2020 2020 2020 2073 656c 662c 0a20           self,. 
-0001c3c0: 2020 2020 2020 2020 2020 2073 7472 7563             struc
-0001c3d0: 7475 7265 2c0a 2020 2020 2020 2020 2020  ture,.          
-0001c3e0: 2020 7461 7267 6574 5f6d 6170 2c0a 2020    target_map,.  
-0001c3f0: 2020 2020 2020 2020 2020 7265 736f 6c75            resolu
-0001c400: 7469 6f6e 5f6d 6170 5f74 6172 6765 742c  tion_map_target,
-0001c410: 0a20 2020 2020 2020 2020 2020 2073 696d  .            sim
-0001c420: 5f6d 6170 3d4e 6f6e 652c 0a20 2020 2020  _map=None,.     
-0001c430: 2020 2020 2020 206d 6178 5f72 6573 3d31         max_res=1
-0001c440: 382e 2c0a 2020 2020 2020 2020 2020 2020  8.,.            
-0001c450: 7665 7262 6f73 653d 5472 7565 2c0a 2020  verbose=True,.  
-0001c460: 2020 2020 2020 2020 2020 6861 6c66 5f6d            half_m
-0001c470: 6170 5f31 3d4e 6f6e 652c 0a20 2020 2020  ap_1=None,.     
-0001c480: 2020 2020 2020 2068 616c 665f 6d61 705f         half_map_
-0001c490: 323d 4e6f 6e65 2c0a 2020 2020 2020 2020  2=None,.        
-0001c4a0: 2020 2020 293a 0a20 2020 2020 2020 2022      ):.        "
-0001c4b0: 2222 4361 6c63 756c 6174 6520 7468 6520  ""Calculate the 
-0001c4c0: 4c6f 5146 6974 2073 636f 7265 2066 6f72  LoQFit score for
-0001c4d0: 2065 6163 6820 7265 7369 6475 6520 696e   each residue in
-0001c4e0: 2061 206d 6f64 656c 2e0a 0a20 2020 2020   a model...     
-0001c4f0: 2020 2054 6865 204c 6f51 4669 7420 7363     The LoQFit sc
-0001c500: 6f72 6520 6973 2065 7373 656e 7469 616c  ore is essential
-0001c510: 6c79 2061 206c 6f63 616c 2069 6d70 6c65  ly a local imple
-0001c520: 6d65 6e74 6174 696f 6e20 6f66 2074 6865  mentation of the
-0001c530: 0a20 2020 2020 2020 206d 6170 2d6d 6f64  .        map-mod
-0001c540: 656c 2046 5343 2e20 4d6f 7265 2069 6e66  el FSC. More inf
-0001c550: 6f72 6d61 7469 6f6e 2063 616e 2062 6520  ormation can be 
-0001c560: 666f 756e 6420 6865 7265 3a0a 2020 2020  found here:.    
-0001c570: 2020 2020 6874 7470 733a 2f2f 7777 772e      https://www.
-0001c580: 6269 6f72 7869 762e 6f72 672f 636f 6e74  biorxiv.org/cont
-0001c590: 656e 742f 3130 2e31 3130 312f 3230 3232  ent/10.1101/2022
-0001c5a0: 2e30 362e 3038 2e34 3935 3235 3976 310a  .06.08.495259v1.
-0001c5b0: 0a20 2020 2020 2020 2041 7267 756d 656e  .        Argumen
-0001c5c0: 7473 3a0a 2020 2020 2020 2020 2020 2020  ts:.            
-0001c5d0: 7374 7275 6374 7572 653a 204d 6f64 656c  structure: Model
-0001c5e0: 2073 7472 7563 7475 7265 2069 6e73 7461   structure insta
-0001c5f0: 6e63 650a 2020 2020 2020 2020 2020 2020  nce.            
-0001c600: 7461 7267 6574 5f6d 6170 3a20 4578 7065  target_map: Expe
-0001c610: 7269 6d65 6e74 616c 204d 6170 2069 6e73  rimental Map ins
-0001c620: 7461 6e63 650a 2020 2020 2020 2020 2020  tance.          
-0001c630: 2020 7265 736f 6c75 7469 6f6e 5f6d 6170    resolution_map
-0001c640: 5f74 6172 6765 743a 2054 6865 2072 6573  _target: The res
-0001c650: 6f6c 7574 696f 6e20 6f66 2074 6865 2074  olution of the t
-0001c660: 6172 6765 7420 6d61 700a 2020 2020 2020  arget map.      
-0001c670: 2020 2020 2020 7369 6d5f 6d61 703a 2050        sim_map: P
-0001c680: 7265 2d63 616c 6375 6c61 7465 6420 7369  re-calculated si
-0001c690: 6d75 6c61 7465 6420 6d61 7020 2d20 7769  mulated map - wi
-0001c6a0: 6c6c 2062 6520 6361 6c63 756c 6174 6564  ll be calculated
-0001c6b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001c6c0: 2061 7574 6f6d 6174 6963 616c 6c79 2069   automatically i
-0001c6d0: 6620 6e6f 7420 7375 7070 6c69 6564 0a20  f not supplied. 
-0001c6e0: 2020 2020 2020 2020 2020 206d 6178 5f72             max_r
-0001c6f0: 6573 3a20 5468 6520 6d61 7869 6d75 6d20  es: The maximum 
-0001c700: 616c 6c6f 7765 6420 4c6f 5146 6974 2073  allowed LoQFit s
-0001c710: 636f 7265 2066 6f72 2061 6e79 2072 6573  core for any res
-0001c720: 6964 7565 2c20 7468 6973 0a20 2020 2020  idue, this.     
-0001c730: 2020 2020 2020 2020 2020 2070 6172 616d             param
-0001c740: 6574 6572 2070 7265 7665 6e74 730a 2020  eter prevents.  
-0001c750: 2020 2020 2020 2020 2020 7665 7262 6f73            verbos
-0001c760: 653a 2049 6620 5472 7565 2c20 7072 696e  e: If True, prin
-0001c770: 7473 2061 2070 726f 6772 6573 7320 6261  ts a progress ba
-0001c780: 7220 616e 6420 7761 726e 696e 6773 0a20  r and warnings. 
-0001c790: 2020 2020 2020 2020 2020 2068 616c 665f             half_
-0001c7a0: 6d61 705f 313a 2041 206d 6170 2069 6e73  map_1: A map ins
-0001c7b0: 7461 6e63 6520 6f66 2061 2068 616c 662d  tance of a half-
-0001c7c0: 6d61 7020 6672 6f6d 2072 6563 6f6e 7374  map from reconst
-0001c7d0: 7275 6374 696f 6e20 6f66 2074 6865 0a20  ruction of the. 
-0001c7e0: 2020 2020 2020 2020 2020 2020 2020 2074                 t
-0001c7f0: 6172 6765 7420 6d61 702e 2049 6620 7375  arget map. If su
-0001c800: 7070 6c69 6564 2028 7769 7468 2073 6563  pplied (with sec
-0001c810: 6f6e 6420 6861 6c66 206d 6170 292c 2074  ond half map), t
-0001c820: 6869 7320 7769 6c6c 2062 650a 2020 2020  his will be.    
-0001c830: 2020 2020 2020 2020 2020 2020 7573 6564              used
-0001c840: 2074 6f20 6e6f 726d 616c 6973 6520 7468   to normalise th
-0001c850: 6520 4c6f 5146 6974 2073 636f 7265 0a20  e LoQFit score. 
-0001c860: 2020 2020 2020 2020 2020 2068 616c 665f             half_
-0001c870: 6d61 705f 323a 2041 206d 6170 2069 6e73  map_2: A map ins
-0001c880: 7461 6e63 6520 6f66 2074 6865 2073 6563  tance of the sec
-0001c890: 6f6e 6420 6861 6c66 206d 6170 2066 726f  ond half map fro
-0001c8a0: 6d0a 2020 2020 2020 2020 2020 2020 2020  m.              
-0001c8b0: 2020 7461 7267 6574 5f6d 6170 2072 6563    target_map rec
-0001c8c0: 6f6e 7374 7275 6374 696f 6e2e 0a0a 2020  onstruction...  
-0001c8d0: 2020 2020 2020 5265 7475 726e 733a 0a20        Returns:. 
-0001c8e0: 2020 2020 2020 2020 2020 2054 6865 204c             The L
-0001c8f0: 6f51 4669 7420 7363 6f72 6520 666f 7220  oQFit score for 
-0001c900: 6561 6368 2072 6573 6964 7565 2069 6e20  each residue in 
-0001c910: 7374 7275 6374 7572 6520 696e 7374 616e  structure instan
-0001c920: 6365 2e0a 2020 2020 2020 2020 2020 2020  ce..            
-0001c930: 5468 6520 6f75 7470 7574 2069 7320 6120  The output is a 
-0001c940: 6469 6374 696f 6e61 7279 2077 6974 6820  dictionary with 
-0001c950: 6b65 7973 3a0a 2020 2020 2020 2020 2020  keys:.          
-0001c960: 2020 2020 2020 2020 2863 6861 696e 5f69          (chain_i
-0001c970: 642c 2072 6573 6964 7565 5f6e 756d 6265  d, residue_numbe
-0001c980: 7229 0a20 2020 2020 2020 2020 2020 2077  r).            w
-0001c990: 6865 7265 2065 6163 6820 7661 6c75 6520  here each value 
-0001c9a0: 6973 2074 6865 204c 6f51 4669 7420 7363  is the LoQFit sc
-0001c9b0: 6f72 6520 666f 7220 6120 6769 7665 6e20  ore for a given 
-0001c9c0: 7265 7369 6475 652e 2049 660a 2020 2020  residue. If.    
-0001c9d0: 2020 2020 2020 2020 6861 6c66 5f6d 6170          half_map
-0001c9e0: 5f31 2061 6e64 2068 616c 665f 6d61 705f  _1 and half_map_
-0001c9f0: 3220 6172 6775 6d65 6e74 7320 6172 6520  2 arguments are 
-0001ca00: 7375 7070 6c69 6564 2074 6865 204c 6f51  supplied the LoQ
-0001ca10: 4669 740a 2020 2020 2020 2020 2020 2020  Fit.            
-0001ca20: 7363 6f72 6520 7769 6c6c 2062 6520 6e6f  score will be no
-0001ca30: 726d 616c 6973 6564 2062 6173 6564 206f  rmalised based o
-0001ca40: 6e20 7468 6520 6c6f 6361 6c20 7265 736f  n the local reso
-0001ca50: 6c75 7469 6f6e 2e0a 2020 2020 2020 2020  lution..        
-0001ca60: 2222 220a 2020 2020 2020 2020 7072 696e  """.        prin
-0001ca70: 7428 6622 4361 6c63 756c 6174 696e 6720  t(f"Calculating 
-0001ca80: 4c6f 5146 6974 2073 636f 7265 2066 6f72  LoQFit score for
-0001ca90: 206d 6f64 656c 207b 7374 7275 6374 7572   model {structur
-0001caa0: 652e 6669 6c65 6e61 6d65 7d20 696e 746f  e.filename} into
-0001cab0: 2022 0a20 2020 2020 2020 2020 2020 2020   ".             
-0001cac0: 2066 226d 6170 207b 7461 7267 6574 5f6d   f"map {target_m
-0001cad0: 6170 2e66 696c 656e 616d 657d 2229 0a0a  ap.filename}")..
-0001cae0: 2020 2020 2020 2020 2320 7365 7420 7570          # set up
-0001caf0: 2073 6f6d 6520 7374 7566 660a 2020 2020   some stuff.    
-0001cb00: 2020 2020 7461 7267 6574 5f6d 6170 2e61      target_map.a
-0001cb10: 7069 7820 3d20 6e70 2e61 7272 6179 2874  pix = np.array(t
-0001cb20: 6172 6765 745f 6d61 702e 6170 6978 290a  arget_map.apix).
-0001cb30: 2020 2020 2020 2020 626c 7572 7265 7220          blurrer 
-0001cb40: 3d20 5374 7275 6374 7572 6542 6c75 7272  = StructureBlurr
-0001cb50: 6572 2877 6974 685f 7663 3d54 7275 6529  er(with_vc=True)
-0001cb60: 0a0a 2020 2020 2020 2020 6966 2073 696d  ..        if sim
-0001cb70: 5f6d 6170 2069 7320 4e6f 6e65 3a0a 2020  _map is None:.  
-0001cb80: 2020 2020 2020 2020 2020 7369 6d5f 6d61            sim_ma
-0001cb90: 7020 3d20 626c 7572 7265 722e 6761 7573  p = blurrer.gaus
-0001cba0: 7369 616e 5f62 6c75 725f 7265 616c 5f73  sian_blur_real_s
-0001cbb0: 7061 6365 280a 2020 2020 2020 2020 2020  pace(.          
-0001cbc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001cbd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001cbe0: 2020 2020 2020 2020 2020 7374 7275 6374            struct
-0001cbf0: 7572 652c 0a20 2020 2020 2020 2020 2020  ure,.           
-0001cc00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001cc10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001cc20: 2020 2020 2020 2020 2072 6573 6f6c 7574           resolut
-0001cc30: 696f 6e5f 6d61 705f 7461 7267 6574 2c0a  ion_map_target,.
-0001cc40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001cc50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001cc60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001cc70: 2020 2020 6465 6e73 4d61 703d 7461 7267      densMap=targ
-0001cc80: 6574 5f6d 6170 290a 2020 2020 2020 2020  et_map).        
-0001cc90: 6673 635f 7468 7265 7368 6f6c 6420 3d20  fsc_threshold = 
-0001cca0: 302e 350a 2020 2020 2020 2020 7369 6d5f  0.5.        sim_
-0001ccb0: 6d61 702e 6e6f 726d 616c 6973 655f 746f  map.normalise_to
-0001ccc0: 5f31 5f6d 696e 7573 3128 696e 5f70 6c61  _1_minus1(in_pla
-0001ccd0: 6365 3d54 7275 6529 0a20 2020 2020 2020  ce=True).       
-0001cce0: 2074 6172 6765 745f 6d61 702e 6e6f 726d   target_map.norm
-0001ccf0: 616c 6973 655f 746f 5f31 5f6d 696e 7573  alise_to_1_minus
-0001cd00: 3128 696e 5f70 6c61 6365 3d54 7275 6529  1(in_place=True)
-0001cd10: 0a0a 2020 2020 2020 2020 2320 6170 7072  ..        # appr
-0001cd20: 6f78 696d 6174 6520 6d61 736b 2073 7068  oximate mask sph
-0001cd30: 6572 6520 6469 616d 6574 6572 0a20 2020  ere diameter.   
-0001cd40: 2020 2020 2073 7068 6572 655f 6469 616d       sphere_diam
-0001cd50: 6574 6572 5f61 6e67 7374 726f 6d73 203d  eter_angstroms =
-0001cd60: 2072 6573 6f6c 7574 696f 6e5f 6d61 705f   resolution_map_
-0001cd70: 7461 7267 6574 202a 2035 0a20 2020 2020  target * 5.     
-0001cd80: 2020 2073 7068 6572 655f 6469 616d 6574     sphere_diamet
-0001cd90: 6572 5f70 6978 656c 7320 3d20 696e 7428  er_pixels = int(
-0001cda0: 7370 6865 7265 5f64 6961 6d65 7465 725f  sphere_diameter_
-0001cdb0: 616e 6773 7472 6f6d 7320 2f0a 2020 2020  angstroms /.    
+0001c380: 2020 2020 2070 6978 656c 5f73 697a 653d       pixel_size=
+0001c390: 7461 7267 6574 5f6d 6170 2e61 7069 785b  target_map.apix[
+0001c3a0: 305d 2c0a 2020 2020 2020 2020 2020 2020  0],.            
+0001c3b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c3c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c3d0: 2020 2020 290a 2020 2020 2020 2020 656c      ).        el
+0001c3e0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+0001c3f0: 6673 6320 3d20 666f 7572 6965 722e 6361  fsc = fourier.ca
+0001c400: 6c63 756c 6174 655f 6673 6328 0a20 2020  lculate_fsc(.   
+0001c410: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c420: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c430: 2020 2020 2074 6172 6765 745f 6d61 702e       target_map.
+0001c440: 6675 6c6c 4d61 702c 0a20 2020 2020 2020  fullMap,.       
+0001c450: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c460: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c470: 2073 696d 5f6d 6170 2e66 756c 6c4d 6170   sim_map.fullMap
+0001c480: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0001c490: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c4a0: 2020 2020 2020 2020 2020 7069 7865 6c5f            pixel_
+0001c4b0: 7369 7a65 3d74 6172 6765 745f 6d61 702e  size=target_map.
+0001c4c0: 6170 6978 5b30 5d2c 0a20 2020 2020 2020  apix[0],.       
+0001c4d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c4e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c4f0: 2029 0a0a 2020 2020 2020 2020 7265 7475   )..        retu
+0001c500: 726e 2066 7363 0a0a 2020 2020 6465 6620  rn fsc..    def 
+0001c510: 4c6f 5146 6974 280a 2020 2020 2020 2020  LoQFit(.        
+0001c520: 2020 2020 7365 6c66 2c0a 2020 2020 2020      self,.      
+0001c530: 2020 2020 2020 7374 7275 6374 7572 652c        structure,
+0001c540: 0a20 2020 2020 2020 2020 2020 2074 6172  .            tar
+0001c550: 6765 745f 6d61 702c 0a20 2020 2020 2020  get_map,.       
+0001c560: 2020 2020 2072 6573 6f6c 7574 696f 6e5f       resolution_
+0001c570: 6d61 705f 7461 7267 6574 2c0a 2020 2020  map_target,.    
+0001c580: 2020 2020 2020 2020 7369 6d5f 6d61 703d          sim_map=
+0001c590: 4e6f 6e65 2c0a 2020 2020 2020 2020 2020  None,.          
+0001c5a0: 2020 6d61 785f 7265 733d 3138 2e2c 0a20    max_res=18.,. 
+0001c5b0: 2020 2020 2020 2020 2020 2076 6572 626f             verbo
+0001c5c0: 7365 3d54 7275 652c 0a20 2020 2020 2020  se=True,.       
+0001c5d0: 2020 2020 2068 616c 665f 6d61 705f 313d       half_map_1=
+0001c5e0: 4e6f 6e65 2c0a 2020 2020 2020 2020 2020  None,.          
+0001c5f0: 2020 6861 6c66 5f6d 6170 5f32 3d4e 6f6e    half_map_2=Non
+0001c600: 652c 0a20 2020 2020 2020 2020 2020 2029  e,.            )
+0001c610: 3a0a 2020 2020 2020 2020 2222 2243 616c  :.        """Cal
+0001c620: 6375 6c61 7465 2074 6865 204c 6f51 4669  culate the LoQFi
+0001c630: 7420 7363 6f72 6520 666f 7220 6561 6368  t score for each
+0001c640: 2072 6573 6964 7565 2069 6e20 6120 6d6f   residue in a mo
+0001c650: 6465 6c2e 0a0a 2020 2020 2020 2020 5468  del...        Th
+0001c660: 6520 4c6f 5146 6974 2073 636f 7265 2069  e LoQFit score i
+0001c670: 7320 6573 7365 6e74 6961 6c6c 7920 6120  s essentially a 
+0001c680: 6c6f 6361 6c20 696d 706c 656d 656e 7461  local implementa
+0001c690: 7469 6f6e 206f 6620 7468 650a 2020 2020  tion of the.    
+0001c6a0: 2020 2020 6d61 702d 6d6f 6465 6c20 4653      map-model FS
+0001c6b0: 432e 204d 6f72 6520 696e 666f 726d 6174  C. More informat
+0001c6c0: 696f 6e20 6361 6e20 6265 2066 6f75 6e64  ion can be found
+0001c6d0: 2068 6572 653a 0a20 2020 2020 2020 2068   here:.        h
+0001c6e0: 7474 7073 3a2f 2f77 7777 2e62 696f 7278  ttps://www.biorx
+0001c6f0: 6976 2e6f 7267 2f63 6f6e 7465 6e74 2f31  iv.org/content/1
+0001c700: 302e 3131 3031 2f32 3032 322e 3036 2e30  0.1101/2022.06.0
+0001c710: 382e 3439 3532 3539 7631 0a0a 2020 2020  8.495259v1..    
+0001c720: 2020 2020 4172 6775 6d65 6e74 733a 0a20      Arguments:. 
+0001c730: 2020 2020 2020 2020 2020 2073 7472 7563             struc
+0001c740: 7475 7265 3a20 4d6f 6465 6c20 7374 7275  ture: Model stru
+0001c750: 6374 7572 6520 696e 7374 616e 6365 0a20  cture instance. 
+0001c760: 2020 2020 2020 2020 2020 2074 6172 6765             targe
+0001c770: 745f 6d61 703a 2045 7870 6572 696d 656e  t_map: Experimen
+0001c780: 7461 6c20 4d61 7020 696e 7374 616e 6365  tal Map instance
+0001c790: 0a20 2020 2020 2020 2020 2020 2072 6573  .            res
+0001c7a0: 6f6c 7574 696f 6e5f 6d61 705f 7461 7267  olution_map_targ
+0001c7b0: 6574 3a20 5468 6520 7265 736f 6c75 7469  et: The resoluti
+0001c7c0: 6f6e 206f 6620 7468 6520 7461 7267 6574  on of the target
+0001c7d0: 206d 6170 0a20 2020 2020 2020 2020 2020   map.           
+0001c7e0: 2073 696d 5f6d 6170 3a20 5072 652d 6361   sim_map: Pre-ca
+0001c7f0: 6c63 756c 6174 6564 2073 696d 756c 6174  lculated simulat
+0001c800: 6564 206d 6170 202d 2077 696c 6c20 6265  ed map - will be
+0001c810: 2063 616c 6375 6c61 7465 640a 2020 2020   calculated.    
+0001c820: 2020 2020 2020 2020 2020 2020 6175 746f              auto
+0001c830: 6d61 7469 6361 6c6c 7920 6966 206e 6f74  matically if not
+0001c840: 2073 7570 706c 6965 640a 2020 2020 2020   supplied.      
+0001c850: 2020 2020 2020 6d61 785f 7265 733a 2054        max_res: T
+0001c860: 6865 206d 6178 696d 756d 2061 6c6c 6f77  he maximum allow
+0001c870: 6564 204c 6f51 4669 7420 7363 6f72 6520  ed LoQFit score 
+0001c880: 666f 7220 616e 7920 7265 7369 6475 652c  for any residue,
+0001c890: 2074 6869 730a 2020 2020 2020 2020 2020   this.          
+0001c8a0: 2020 2020 2020 7061 7261 6d65 7465 7220        parameter 
+0001c8b0: 7072 6576 656e 7473 0a20 2020 2020 2020  prevents.       
+0001c8c0: 2020 2020 2076 6572 626f 7365 3a20 4966       verbose: If
+0001c8d0: 2054 7275 652c 2070 7269 6e74 7320 6120   True, prints a 
+0001c8e0: 7072 6f67 7265 7373 2062 6172 2061 6e64  progress bar and
+0001c8f0: 2077 6172 6e69 6e67 730a 2020 2020 2020   warnings.      
+0001c900: 2020 2020 2020 6861 6c66 5f6d 6170 5f31        half_map_1
+0001c910: 3a20 4120 6d61 7020 696e 7374 616e 6365  : A map instance
+0001c920: 206f 6620 6120 6861 6c66 2d6d 6170 2066   of a half-map f
+0001c930: 726f 6d20 7265 636f 6e73 7472 7563 7469  rom reconstructi
+0001c940: 6f6e 206f 6620 7468 650a 2020 2020 2020  on of the.      
+0001c950: 2020 2020 2020 2020 2020 7461 7267 6574            target
+0001c960: 206d 6170 2e20 4966 2073 7570 706c 6965   map. If supplie
+0001c970: 6420 2877 6974 6820 7365 636f 6e64 2068  d (with second h
+0001c980: 616c 6620 6d61 7029 2c20 7468 6973 2077  alf map), this w
+0001c990: 696c 6c20 6265 0a20 2020 2020 2020 2020  ill be.         
+0001c9a0: 2020 2020 2020 2075 7365 6420 746f 206e         used to n
+0001c9b0: 6f72 6d61 6c69 7365 2074 6865 204c 6f51  ormalise the LoQ
+0001c9c0: 4669 7420 7363 6f72 650a 2020 2020 2020  Fit score.      
+0001c9d0: 2020 2020 2020 6861 6c66 5f6d 6170 5f32        half_map_2
+0001c9e0: 3a20 4120 6d61 7020 696e 7374 616e 6365  : A map instance
+0001c9f0: 206f 6620 7468 6520 7365 636f 6e64 2068   of the second h
+0001ca00: 616c 6620 6d61 7020 6672 6f6d 0a20 2020  alf map from.   
+0001ca10: 2020 2020 2020 2020 2020 2020 2074 6172               tar
+0001ca20: 6765 745f 6d61 7020 7265 636f 6e73 7472  get_map reconstr
+0001ca30: 7563 7469 6f6e 2e0a 0a20 2020 2020 2020  uction...       
+0001ca40: 2052 6574 7572 6e73 3a0a 2020 2020 2020   Returns:.      
+0001ca50: 2020 2020 2020 5468 6520 4c6f 5146 6974        The LoQFit
+0001ca60: 2073 636f 7265 2066 6f72 2065 6163 6820   score for each 
+0001ca70: 7265 7369 6475 6520 696e 2073 7472 7563  residue in struc
+0001ca80: 7475 7265 2069 6e73 7461 6e63 652e 0a20  ture instance.. 
+0001ca90: 2020 2020 2020 2020 2020 2054 6865 206f             The o
+0001caa0: 7574 7075 7420 6973 2061 2064 6963 7469  utput is a dicti
+0001cab0: 6f6e 6172 7920 7769 7468 206b 6579 733a  onary with keys:
+0001cac0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001cad0: 2020 2028 6368 6169 6e5f 6964 2c20 7265     (chain_id, re
+0001cae0: 7369 6475 655f 6e75 6d62 6572 290a 2020  sidue_number).  
+0001caf0: 2020 2020 2020 2020 2020 7768 6572 6520            where 
+0001cb00: 6561 6368 2076 616c 7565 2069 7320 7468  each value is th
+0001cb10: 6520 4c6f 5146 6974 2073 636f 7265 2066  e LoQFit score f
+0001cb20: 6f72 2061 2067 6976 656e 2072 6573 6964  or a given resid
+0001cb30: 7565 2e20 4966 0a20 2020 2020 2020 2020  ue. If.         
+0001cb40: 2020 2068 616c 665f 6d61 705f 3120 616e     half_map_1 an
+0001cb50: 6420 6861 6c66 5f6d 6170 5f32 2061 7267  d half_map_2 arg
+0001cb60: 756d 656e 7473 2061 7265 2073 7570 706c  uments are suppl
+0001cb70: 6965 6420 7468 6520 4c6f 5146 6974 0a20  ied the LoQFit. 
+0001cb80: 2020 2020 2020 2020 2020 2073 636f 7265             score
+0001cb90: 2077 696c 6c20 6265 206e 6f72 6d61 6c69   will be normali
+0001cba0: 7365 6420 6261 7365 6420 6f6e 2074 6865  sed based on the
+0001cbb0: 206c 6f63 616c 2072 6573 6f6c 7574 696f   local resolutio
+0001cbc0: 6e2e 0a20 2020 2020 2020 2022 2222 0a20  n..        """. 
+0001cbd0: 2020 2020 2020 2070 7269 6e74 2866 2243         print(f"C
+0001cbe0: 616c 6375 6c61 7469 6e67 204c 6f51 4669  alculating LoQFi
+0001cbf0: 7420 7363 6f72 6520 666f 7220 6d6f 6465  t score for mode
+0001cc00: 6c20 7b73 7472 7563 7475 7265 2e66 696c  l {structure.fil
+0001cc10: 656e 616d 657d 2069 6e74 6f20 220a 2020  ename} into ".  
+0001cc20: 2020 2020 2020 2020 2020 2020 6622 6d61              f"ma
+0001cc30: 7020 7b74 6172 6765 745f 6d61 702e 6669  p {target_map.fi
+0001cc40: 6c65 6e61 6d65 7d22 290a 0a20 2020 2020  lename}")..     
+0001cc50: 2020 2023 2073 6574 2075 7020 736f 6d65     # set up some
+0001cc60: 2073 7475 6666 0a20 2020 2020 2020 2074   stuff.        t
+0001cc70: 6172 6765 745f 6d61 702e 6170 6978 203d  arget_map.apix =
+0001cc80: 206e 702e 6172 7261 7928 7461 7267 6574   np.array(target
+0001cc90: 5f6d 6170 2e61 7069 7829 0a20 2020 2020  _map.apix).     
+0001cca0: 2020 2062 6c75 7272 6572 203d 2053 7472     blurrer = Str
+0001ccb0: 7563 7475 7265 426c 7572 7265 7228 7769  uctureBlurrer(wi
+0001ccc0: 7468 5f76 633d 5472 7565 290a 0a20 2020  th_vc=True)..   
+0001ccd0: 2020 2020 2069 6620 7369 6d5f 6d61 7020       if sim_map 
+0001cce0: 6973 204e 6f6e 653a 0a20 2020 2020 2020  is None:.       
+0001ccf0: 2020 2020 2073 696d 5f6d 6170 203d 2062       sim_map = b
+0001cd00: 6c75 7272 6572 2e67 6175 7373 6961 6e5f  lurrer.gaussian_
+0001cd10: 626c 7572 5f72 6561 6c5f 7370 6163 6528  blur_real_space(
+0001cd20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001cd30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001cd40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001cd50: 2020 2020 2073 7472 7563 7475 7265 2c0a       structure,.
+0001cd60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001cd70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001cd80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001cd90: 2020 2020 7265 736f 6c75 7469 6f6e 5f6d      resolution_m
+0001cda0: 6170 5f74 6172 6765 742c 0a20 2020 2020  ap_target,.     
+0001cdb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0001cdc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001cdd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001cde0: 2074 6172 6765 745f 6d61 702e 6170 6978   target_map.apix
-0001cdf0: 5b30 5d29 0a0a 2020 2020 2020 2020 2320  [0])..        # 
-0001ce00: 656e 7375 7265 2074 6861 7420 7061 7261  ensure that para
-0001ce10: 6d65 7465 7273 2061 7265 2073 656e 7369  meters are sensi
-0001ce20: 626c 6520 692e 652e 206e 6f74 2061 2031  ble i.e. not a 1
-0001ce30: 2070 6978 656c 2077 6964 6520 6d61 736b   pixel wide mask
-0001ce40: 0a20 2020 2020 2020 2069 6620 7370 6865  .        if sphe
-0001ce50: 7265 5f64 6961 6d65 7465 725f 7069 7865  re_diameter_pixe
-0001ce60: 6c73 203c 2036 3a0a 2020 2020 2020 2020  ls < 6:.        
-0001ce70: 2020 2020 7370 6865 7265 5f64 6961 6d65      sphere_diame
-0001ce80: 7465 725f 7069 7865 6c73 203d 2036 0a20  ter_pixels = 6. 
-0001ce90: 2020 2020 2020 2063 6f73 5f65 6467 6520         cos_edge 
-0001cea0: 3d20 696e 7428 726f 756e 6428 7370 6865  = int(round(sphe
-0001ceb0: 7265 5f64 6961 6d65 7465 725f 7069 7865  re_diameter_pixe
-0001cec0: 6c73 202f 2033 2929 0a20 2020 2020 2020  ls / 3)).       
-0001ced0: 2069 6620 636f 735f 6564 6765 203c 2031   if cos_edge < 1
-0001cee0: 303a 0a20 2020 2020 2020 2020 2020 2063  0:.            c
-0001cef0: 6f73 5f65 6467 6520 3d20 3130 0a0a 2020  os_edge = 10..  
-0001cf00: 2020 2020 2020 6966 2068 616c 665f 6d61        if half_ma
-0001cf10: 705f 3120 6973 206e 6f74 204e 6f6e 6520  p_1 is not None 
-0001cf20: 616e 6420 6861 6c66 5f6d 6170 5f32 2069  and half_map_2 i
-0001cf30: 7320 6e6f 7420 4e6f 6e65 3a0a 2020 2020  s not None:.    
-0001cf40: 2020 2020 2020 2020 696e 7465 7270 6f6c          interpol
-0001cf50: 6174 655f 6375 746f 6666 203d 2046 616c  ate_cutoff = Fal
-0001cf60: 7365 0a20 2020 2020 2020 2020 2020 206e  se.            n
-0001cf70: 6f72 6d61 6c69 7365 5f77 6974 685f 6861  ormalise_with_ha
-0001cf80: 6c66 5f6d 6170 203d 2054 7275 650a 2020  lf_map = True.  
-0001cf90: 2020 2020 2020 2020 2020 6861 6c66 5f6d            half_m
-0001cfa0: 6170 5f31 2e6f 7269 6769 6e20 3d20 7461  ap_1.origin = ta
-0001cfb0: 7267 6574 5f6d 6170 2e6f 7269 6769 6e0a  rget_map.origin.
-0001cfc0: 2020 2020 2020 2020 2020 2020 6861 6c66              half
-0001cfd0: 5f6d 6170 5f32 2e6f 7269 6769 6e20 3d20  _map_2.origin = 
-0001cfe0: 7461 7267 6574 5f6d 6170 2e6f 7269 6769  target_map.origi
-0001cff0: 6e0a 2020 2020 2020 2020 656c 7365 3a0a  n.        else:.
-0001d000: 2020 2020 2020 2020 2020 2020 696e 7465              inte
-0001d010: 7270 6f6c 6174 655f 6375 746f 6666 203d  rpolate_cutoff =
-0001d020: 2054 7275 650a 2020 2020 2020 2020 2020   True.          
-0001d030: 2020 6e6f 726d 616c 6973 655f 7769 7468    normalise_with
-0001d040: 5f68 616c 665f 6d61 7020 3d20 4661 6c73  _half_map = Fals
-0001d050: 650a 0a20 2020 2020 2020 2023 2067 6574  e..        # get
-0001d060: 2061 6e20 6170 7072 6f70 7269 6174 6520   an appropriate 
-0001d070: 626f 7820 7369 7a65 2074 6f20 6372 6f70  box size to crop
-0001d080: 2066 726f 6d20 6d61 696e 206d 6170 0a20   from main map. 
-0001d090: 2020 2020 2020 2023 2077 696c 6c20 6265         # will be
-0001d0a0: 2032 5e6e 2c20 335e 6e20 6f72 2035 5e6e   2^n, 3^n or 5^n
-0001d0b0: 2073 697a 6520 7768 6572 6520 6e20 6973   size where n is
-0001d0c0: 2074 6865 206e 756d 6265 7220 7265 7175   the number requ
-0001d0d0: 6972 6564 2066 6f72 0a20 2020 2020 2020  ired for.       
-0001d0e0: 2023 2074 6865 206d 696e 696d 756d 2062   # the minimum b
-0001d0f0: 6f78 2073 697a 6520 6e65 6564 6564 2074  ox size needed t
-0001d100: 6f20 656e 636f 6d70 6173 7320 656e 7469  o encompass enti
-0001d110: 7265 206d 6173 6b20 696e 2062 6f78 0a20  re mask in box. 
-0001d120: 2020 2020 2020 206d 6173 6b5f 6469 6d73         mask_dims
-0001d130: 203d 2066 6f75 7269 6572 2e67 6574 5f66   = fourier.get_f
-0001d140: 6674 5f6f 7074 696d 6973 6564 5f62 6f78  ft_optimised_box
-0001d150: 5f73 697a 6528 0a20 2020 2020 2020 2020  _size(.         
-0001d160: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001d170: 2020 2020 2020 2020 2020 2073 7068 6572             spher
-0001d180: 655f 6469 616d 6574 6572 5f70 6978 656c  e_diameter_pixel
-0001d190: 7320 2b20 2832 2a63 6f73 5f65 6467 6529  s + (2*cos_edge)
-0001d1a0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0001d1b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001d1c0: 2020 2020 2020 7461 7267 6574 5f6d 6170        target_map
-0001d1d0: 2e66 756c 6c4d 6170 2e73 6861 7065 290a  .fullMap.shape).
-0001d1e0: 0a20 2020 2020 2020 2069 6620 6d61 736b  .        if mask
-0001d1f0: 5f64 696d 7320 3d3d 205b 302c 2030 2c20  _dims == [0, 0, 
-0001d200: 305d 3a0a 2020 2020 2020 2020 2020 2020  0]:.            
-0001d210: 6d61 736b 203d 204d 6170 286e 702e 6f6e  mask = Map(np.on
-0001d220: 6573 2874 6172 6765 745f 6d61 702e 6675  es(target_map.fu
-0001d230: 6c6c 4d61 702e 7368 6170 6529 2c20 7461  llMap.shape), ta
-0001d240: 7267 6574 5f6d 6170 2e6f 7269 6769 6e2c  rget_map.origin,
-0001d250: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001d260: 2020 2020 2020 2020 7461 7267 6574 5f6d          target_m
-0001d270: 6170 2e61 7069 782c 2074 6172 6765 745f  ap.apix, target_
-0001d280: 6d61 702e 6669 6c65 6e61 6d65 290a 2020  map.filename).  
-0001d290: 2020 2020 2020 2020 2020 6d61 736b 5f64            mask_d
-0001d2a0: 696d 7320 3d20 6d61 736b 2e66 756c 6c4d  ims = mask.fullM
-0001d2b0: 6170 2e73 6861 7065 0a20 2020 2020 2020  ap.shape.       
-0001d2c0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-0001d2d0: 2020 2063 656e 7472 655f 6f66 5f6d 6173     centre_of_mas
-0001d2e0: 6b5f 6d61 7020 3d20 5b6d 6173 6b5f 6469  k_map = [mask_di
-0001d2f0: 6d73 5b30 5d2f 322c 206d 6173 6b5f 6469  ms[0]/2, mask_di
-0001d300: 6d73 5b31 5d2f 322c 0a20 2020 2020 2020  ms[1]/2,.       
+0001cdd0: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+0001cde0: 656e 734d 6170 3d74 6172 6765 745f 6d61  ensMap=target_ma
+0001cdf0: 7029 0a20 2020 2020 2020 2066 7363 5f74  p).        fsc_t
+0001ce00: 6872 6573 686f 6c64 203d 2030 2e35 0a20  hreshold = 0.5. 
+0001ce10: 2020 2020 2020 2073 696d 5f6d 6170 2e6e         sim_map.n
+0001ce20: 6f72 6d61 6c69 7365 5f74 6f5f 315f 6d69  ormalise_to_1_mi
+0001ce30: 6e75 7331 2869 6e5f 706c 6163 653d 5472  nus1(in_place=Tr
+0001ce40: 7565 290a 2020 2020 2020 2020 7461 7267  ue).        targ
+0001ce50: 6574 5f6d 6170 2e6e 6f72 6d61 6c69 7365  et_map.normalise
+0001ce60: 5f74 6f5f 315f 6d69 6e75 7331 2869 6e5f  _to_1_minus1(in_
+0001ce70: 706c 6163 653d 5472 7565 290a 0a20 2020  place=True)..   
+0001ce80: 2020 2020 2023 2061 7070 726f 7869 6d61       # approxima
+0001ce90: 7465 206d 6173 6b20 7370 6865 7265 2064  te mask sphere d
+0001cea0: 6961 6d65 7465 720a 2020 2020 2020 2020  iameter.        
+0001ceb0: 7370 6865 7265 5f64 6961 6d65 7465 725f  sphere_diameter_
+0001cec0: 616e 6773 7472 6f6d 7320 3d20 7265 736f  angstroms = reso
+0001ced0: 6c75 7469 6f6e 5f6d 6170 5f74 6172 6765  lution_map_targe
+0001cee0: 7420 2a20 350a 2020 2020 2020 2020 7370  t * 5.        sp
+0001cef0: 6865 7265 5f64 6961 6d65 7465 725f 7069  here_diameter_pi
+0001cf00: 7865 6c73 203d 2069 6e74 2873 7068 6572  xels = int(spher
+0001cf10: 655f 6469 616d 6574 6572 5f61 6e67 7374  e_diameter_angst
+0001cf20: 726f 6d73 202f 0a20 2020 2020 2020 2020  roms /.         
+0001cf30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001cf40: 2020 2020 2020 2020 2020 2020 7461 7267              targ
+0001cf50: 6574 5f6d 6170 2e61 7069 785b 305d 290a  et_map.apix[0]).
+0001cf60: 0a20 2020 2020 2020 2023 2065 6e73 7572  .        # ensur
+0001cf70: 6520 7468 6174 2070 6172 616d 6574 6572  e that parameter
+0001cf80: 7320 6172 6520 7365 6e73 6962 6c65 2069  s are sensible i
+0001cf90: 2e65 2e20 6e6f 7420 6120 3120 7069 7865  .e. not a 1 pixe
+0001cfa0: 6c20 7769 6465 206d 6173 6b0a 2020 2020  l wide mask.    
+0001cfb0: 2020 2020 6966 2073 7068 6572 655f 6469      if sphere_di
+0001cfc0: 616d 6574 6572 5f70 6978 656c 7320 3c20  ameter_pixels < 
+0001cfd0: 363a 0a20 2020 2020 2020 2020 2020 2073  6:.            s
+0001cfe0: 7068 6572 655f 6469 616d 6574 6572 5f70  phere_diameter_p
+0001cff0: 6978 656c 7320 3d20 360a 2020 2020 2020  ixels = 6.      
+0001d000: 2020 636f 735f 6564 6765 203d 2069 6e74    cos_edge = int
+0001d010: 2872 6f75 6e64 2873 7068 6572 655f 6469  (round(sphere_di
+0001d020: 616d 6574 6572 5f70 6978 656c 7320 2f20  ameter_pixels / 
+0001d030: 3329 290a 2020 2020 2020 2020 6966 2063  3)).        if c
+0001d040: 6f73 5f65 6467 6520 3c20 3130 3a0a 2020  os_edge < 10:.  
+0001d050: 2020 2020 2020 2020 2020 636f 735f 6564            cos_ed
+0001d060: 6765 203d 2031 300a 0a20 2020 2020 2020  ge = 10..       
+0001d070: 2069 6620 6861 6c66 5f6d 6170 5f31 2069   if half_map_1 i
+0001d080: 7320 6e6f 7420 4e6f 6e65 2061 6e64 2068  s not None and h
+0001d090: 616c 665f 6d61 705f 3220 6973 206e 6f74  alf_map_2 is not
+0001d0a0: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
+0001d0b0: 2020 2069 6e74 6572 706f 6c61 7465 5f63     interpolate_c
+0001d0c0: 7574 6f66 6620 3d20 4661 6c73 650a 2020  utoff = False.  
+0001d0d0: 2020 2020 2020 2020 2020 6e6f 726d 616c            normal
+0001d0e0: 6973 655f 7769 7468 5f68 616c 665f 6d61  ise_with_half_ma
+0001d0f0: 7020 3d20 5472 7565 0a20 2020 2020 2020  p = True.       
+0001d100: 2020 2020 2068 616c 665f 6d61 705f 312e       half_map_1.
+0001d110: 6f72 6967 696e 203d 2074 6172 6765 745f  origin = target_
+0001d120: 6d61 702e 6f72 6967 696e 0a20 2020 2020  map.origin.     
+0001d130: 2020 2020 2020 2068 616c 665f 6d61 705f         half_map_
+0001d140: 322e 6f72 6967 696e 203d 2074 6172 6765  2.origin = targe
+0001d150: 745f 6d61 702e 6f72 6967 696e 0a20 2020  t_map.origin.   
+0001d160: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+0001d170: 2020 2020 2020 2069 6e74 6572 706f 6c61         interpola
+0001d180: 7465 5f63 7574 6f66 6620 3d20 5472 7565  te_cutoff = True
+0001d190: 0a20 2020 2020 2020 2020 2020 206e 6f72  .            nor
+0001d1a0: 6d61 6c69 7365 5f77 6974 685f 6861 6c66  malise_with_half
+0001d1b0: 5f6d 6170 203d 2046 616c 7365 0a0a 2020  _map = False..  
+0001d1c0: 2020 2020 2020 2320 6765 7420 616e 2061        # get an a
+0001d1d0: 7070 726f 7072 6961 7465 2062 6f78 2073  ppropriate box s
+0001d1e0: 697a 6520 746f 2063 726f 7020 6672 6f6d  ize to crop from
+0001d1f0: 206d 6169 6e20 6d61 700a 2020 2020 2020   main map.      
+0001d200: 2020 2320 7769 6c6c 2062 6520 325e 6e2c    # will be 2^n,
+0001d210: 2033 5e6e 206f 7220 355e 6e20 7369 7a65   3^n or 5^n size
+0001d220: 2077 6865 7265 206e 2069 7320 7468 6520   where n is the 
+0001d230: 6e75 6d62 6572 2072 6571 7569 7265 6420  number required 
+0001d240: 666f 720a 2020 2020 2020 2020 2320 7468  for.        # th
+0001d250: 6520 6d69 6e69 6d75 6d20 626f 7820 7369  e minimum box si
+0001d260: 7a65 206e 6565 6465 6420 746f 2065 6e63  ze needed to enc
+0001d270: 6f6d 7061 7373 2065 6e74 6972 6520 6d61  ompass entire ma
+0001d280: 736b 2069 6e20 626f 780a 2020 2020 2020  sk in box.      
+0001d290: 2020 6d61 736b 5f64 696d 7320 3d20 666f    mask_dims = fo
+0001d2a0: 7572 6965 722e 6765 745f 6666 745f 6f70  urier.get_fft_op
+0001d2b0: 7469 6d69 7365 645f 626f 785f 7369 7a65  timised_box_size
+0001d2c0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+0001d2d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d2e0: 2020 2020 2020 7370 6865 7265 5f64 6961        sphere_dia
+0001d2f0: 6d65 7465 725f 7069 7865 6c73 202b 2028  meter_pixels + (
+0001d300: 322a 636f 735f 6564 6765 292c 0a20 2020  2*cos_edge),.   
 0001d310: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001d320: 2020 2020 2020 2020 2020 206d 6173 6b5f             mask_
-0001d330: 6469 6d73 5b32 5d2f 325d 0a20 2020 2020  dims[2]/2].     
-0001d340: 2020 2020 2020 206d 6173 6b20 3d20 626c         mask = bl
-0001d350: 7572 7265 722e 6d61 6b65 5f73 7068 6572  urrer.make_spher
-0001d360: 6963 616c 5f6d 6173 6b28 7370 6865 7265  ical_mask(sphere
-0001d370: 5f64 6961 6d65 7465 725f 7069 7865 6c73  _diameter_pixels
-0001d380: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0001d390: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001d3a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001d3b0: 206d 6173 6b5f 6469 6d73 2c20 6365 6e74   mask_dims, cent
-0001d3c0: 7265 5f6f 665f 6d61 736b 5f6d 6170 2c0a  re_of_mask_map,.
-0001d3d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001d3e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001d3f0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-0001d400: 6f73 5f65 6467 6529 0a0a 2020 2020 2020  os_edge)..      
-0001d410: 2020 2320 7361 7665 2073 636f 7265 7320    # save scores 
-0001d420: 666f 7220 6561 6368 2063 6861 696e 2061  for each chain a
-0001d430: 6e64 2072 6573 0a20 2020 2020 2020 2064  nd res.        d
-0001d440: 6963 745f 7265 735f 7363 6f72 6573 203d  ict_res_scores =
-0001d450: 204f 7264 6572 6564 4469 6374 2829 0a20   OrderedDict(). 
-0001d460: 2020 2020 2020 2063 6861 696e 7320 3d20         chains = 
-0001d470: 7374 7275 6374 7572 652e 7370 6c69 745f  structure.split_
-0001d480: 696e 746f 5f63 6861 696e 7328 290a 2020  into_chains().  
-0001d490: 2020 2020 2020 6e75 6d62 6572 5f6f 665f        number_of_
-0001d4a0: 7265 7369 6475 6573 203d 2073 7472 7563  residues = struc
-0001d4b0: 7475 7265 2e6e 756d 6265 725f 6f66 5f72  ture.number_of_r
-0001d4c0: 6573 6964 7565 7328 290a 0a20 2020 2020  esidues()..     
-0001d4d0: 2020 2023 2073 6574 2075 7020 7079 6666     # set up pyff
-0001d4e0: 7477 2066 6f72 2076 6572 7920 6661 7374  tw for very fast
-0001d4f0: 2066 6674 730a 2020 2020 2020 2020 696e   ffts.        in
-0001d500: 7075 7431 203d 2070 7966 6674 772e 656d  put1 = pyfftw.em
-0001d510: 7074 795f 616c 6967 6e65 6428 6d61 736b  pty_aligned(mask
-0001d520: 5f64 696d 732c 2064 7479 7065 3d27 666c  _dims, dtype='fl
-0001d530: 6f61 7436 3427 290a 2020 2020 2020 2020  oat64').        
-0001d540: 6666 7477 5f6f 626a 6563 7431 203d 2066  fftw_object1 = f
-0001d550: 6f75 7269 6572 2e67 6574 5f70 7966 6674  ourier.get_pyfft
-0001d560: 775f 6f62 6a65 6374 286d 6173 6b5f 6469  w_object(mask_di
-0001d570: 6d73 290a 2020 2020 2020 2020 6666 7477  ms).        fftw
-0001d580: 5f6f 626a 6563 7432 203d 2066 6f75 7269  _object2 = fouri
-0001d590: 6572 2e67 6574 5f70 7966 6674 775f 6f62  er.get_pyfftw_ob
-0001d5a0: 6a65 6374 286d 6173 6b5f 6469 6d73 290a  ject(mask_dims).
-0001d5b0: 0a20 2020 2020 2020 2023 2070 7265 636f  .        # preco
-0001d5c0: 6d70 7574 6520 7468 6573 6520 746f 2073  mpute these to s
-0001d5d0: 7065 6564 2075 7020 6361 6c63 756c 6174  peed up calculat
-0001d5e0: 696f 6e73 0a20 2020 2020 2020 2071 6269  ions.        qbi
-0001d5f0: 6e73 2c20 6c61 6265 6c6c 6564 5f73 6865  ns, labelled_she
-0001d600: 6c6c 7320 3d20 666f 7572 6965 722e 6765  lls = fourier.ge
-0001d610: 745f 6c61 6265 6c6c 6564 5f73 6865 6c6c  t_labelled_shell
-0001d620: 7328 0a20 2020 2020 2020 2020 2020 2069  s(.            i
-0001d630: 6e70 7574 312e 7368 6170 6529 0a0a 2020  nput1.shape)..  
-0001d640: 2020 2020 2020 7761 726e 696e 6773 203d        warnings =
-0001d650: 205b 5d0a 2020 2020 2020 2020 7265 735f   [].        res_
-0001d660: 6e6f 203d 2030 0a0a 2020 2020 2020 2020  no = 0..        
-0001d670: 666f 7220 6368 6169 6e20 696e 2063 6861  for chain in cha
-0001d680: 696e 733a 0a20 2020 2020 2020 2020 2020  ins:.           
-0001d690: 2066 6f72 2061 746f 6d20 696e 2063 6861   for atom in cha
-0001d6a0: 696e 2e61 746f 6d4c 6973 743a 0a20 2020  in.atomList:.   
-0001d6b0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-0001d6c0: 6174 6f6d 2e61 746f 6d5f 6e61 6d65 203d  atom.atom_name =
-0001d6d0: 3d20 2743 4127 206f 7220 6174 6f6d 2e61  = 'CA' or atom.a
-0001d6e0: 746f 6d5f 6e61 6d65 203d 3d20 2243 3127  tom_name == "C1'
-0001d6f0: 223a 0a20 2020 2020 2020 2020 2020 2020  ":.             
-0001d700: 2020 2020 2020 2070 6173 730a 2020 2020         pass.    
-0001d710: 2020 2020 2020 2020 2020 2020 656c 7365              else
-0001d720: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0001d730: 2020 2020 2020 636f 6e74 696e 7565 0a0a        continue..
-0001d740: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001d750: 6372 6f70 7065 645f 6d61 705f 3120 3d20  cropped_map_1 = 
-0001d760: 7461 7267 6574 5f6d 6170 2e67 6574 5f63  target_map.get_c
-0001d770: 726f 7070 6564 5f62 6f78 5f61 726f 756e  ropped_box_aroun
-0001d780: 645f 6174 6f6d 280a 2020 2020 2020 2020  d_atom(.        
-0001d790: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001d7a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001d7b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001d7c0: 2020 2020 2020 2020 6174 6f6d 2c0a 2020          atom,.  
-0001d7d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001d7e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001d7f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001d800: 2020 2020 2020 2020 2020 2020 2020 6d61                ma
-0001d810: 736b 5f64 696d 732c 0a20 2020 2020 2020  sk_dims,.       
-0001d820: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001d830: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001d840: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001d850: 2020 2020 2020 2020 2029 2e66 756c 6c4d           ).fullM
-0001d860: 6170 0a20 2020 2020 2020 2020 2020 2020  ap.             
-0001d870: 2020 2063 726f 7070 6564 5f6d 6170 5f32     cropped_map_2
-0001d880: 203d 2073 696d 5f6d 6170 2e67 6574 5f63   = sim_map.get_c
-0001d890: 726f 7070 6564 5f62 6f78 5f61 726f 756e  ropped_box_aroun
-0001d8a0: 645f 6174 6f6d 280a 2020 2020 2020 2020  d_atom(.        
-0001d8b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001d8c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001d8d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001d8e0: 2020 2020 2020 2020 6174 6f6d 2c0a 2020          atom,.  
-0001d8f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d320: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d330: 2074 6172 6765 745f 6d61 702e 6675 6c6c   target_map.full
+0001d340: 4d61 702e 7368 6170 6529 0a0a 2020 2020  Map.shape)..    
+0001d350: 2020 2020 6966 206d 6173 6b5f 6469 6d73      if mask_dims
+0001d360: 203d 3d20 5b30 2c20 302c 2030 5d3a 0a20   == [0, 0, 0]:. 
+0001d370: 2020 2020 2020 2020 2020 206d 6173 6b20             mask 
+0001d380: 3d20 4d61 7028 6e70 2e6f 6e65 7328 7461  = Map(np.ones(ta
+0001d390: 7267 6574 5f6d 6170 2e66 756c 6c4d 6170  rget_map.fullMap
+0001d3a0: 2e73 6861 7065 292c 2074 6172 6765 745f  .shape), target_
+0001d3b0: 6d61 702e 6f72 6967 696e 2c0a 2020 2020  map.origin,.    
+0001d3c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d3d0: 2020 2074 6172 6765 745f 6d61 702e 6170     target_map.ap
+0001d3e0: 6978 2c20 7461 7267 6574 5f6d 6170 2e66  ix, target_map.f
+0001d3f0: 696c 656e 616d 6529 0a20 2020 2020 2020  ilename).       
+0001d400: 2020 2020 206d 6173 6b5f 6469 6d73 203d       mask_dims =
+0001d410: 206d 6173 6b2e 6675 6c6c 4d61 702e 7368   mask.fullMap.sh
+0001d420: 6170 650a 2020 2020 2020 2020 656c 7365  ape.        else
+0001d430: 3a0a 2020 2020 2020 2020 2020 2020 6365  :.            ce
+0001d440: 6e74 7265 5f6f 665f 6d61 736b 5f6d 6170  ntre_of_mask_map
+0001d450: 203d 205b 6d61 736b 5f64 696d 735b 305d   = [mask_dims[0]
+0001d460: 2f32 2c20 6d61 736b 5f64 696d 735b 315d  /2, mask_dims[1]
+0001d470: 2f32 2c0a 2020 2020 2020 2020 2020 2020  /2,.            
+0001d480: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d490: 2020 2020 2020 6d61 736b 5f64 696d 735b        mask_dims[
+0001d4a0: 325d 2f32 5d0a 2020 2020 2020 2020 2020  2]/2].          
+0001d4b0: 2020 6d61 736b 203d 2062 6c75 7272 6572    mask = blurrer
+0001d4c0: 2e6d 616b 655f 7370 6865 7269 6361 6c5f  .make_spherical_
+0001d4d0: 6d61 736b 2873 7068 6572 655f 6469 616d  mask(sphere_diam
+0001d4e0: 6574 6572 5f70 6978 656c 732c 0a20 2020  eter_pixels,.   
+0001d4f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d500: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d510: 2020 2020 2020 2020 2020 2020 6d61 736b              mask
+0001d520: 5f64 696d 732c 2063 656e 7472 655f 6f66  _dims, centre_of
+0001d530: 5f6d 6173 6b5f 6d61 702c 0a20 2020 2020  _mask_map,.     
+0001d540: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d550: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d560: 2020 2020 2020 2020 2020 636f 735f 6564            cos_ed
+0001d570: 6765 290a 0a20 2020 2020 2020 2023 2073  ge)..        # s
+0001d580: 6176 6520 7363 6f72 6573 2066 6f72 2065  ave scores for e
+0001d590: 6163 6820 6368 6169 6e20 616e 6420 7265  ach chain and re
+0001d5a0: 730a 2020 2020 2020 2020 6469 6374 5f72  s.        dict_r
+0001d5b0: 6573 5f73 636f 7265 7320 3d20 4f72 6465  es_scores = Orde
+0001d5c0: 7265 6444 6963 7428 290a 2020 2020 2020  redDict().      
+0001d5d0: 2020 6368 6169 6e73 203d 2073 7472 7563    chains = struc
+0001d5e0: 7475 7265 2e73 706c 6974 5f69 6e74 6f5f  ture.split_into_
+0001d5f0: 6368 6169 6e73 2829 0a20 2020 2020 2020  chains().       
+0001d600: 206e 756d 6265 725f 6f66 5f72 6573 6964   number_of_resid
+0001d610: 7565 7320 3d20 7374 7275 6374 7572 652e  ues = structure.
+0001d620: 6e75 6d62 6572 5f6f 665f 7265 7369 6475  number_of_residu
+0001d630: 6573 2829 0a0a 2020 2020 2020 2020 2320  es()..        # 
+0001d640: 7365 7420 7570 2070 7966 6674 7720 666f  set up pyfftw fo
+0001d650: 7220 7665 7279 2066 6173 7420 6666 7473  r very fast ffts
+0001d660: 0a20 2020 2020 2020 2069 6e70 7574 3120  .        input1 
+0001d670: 3d20 7079 6666 7477 2e65 6d70 7479 5f61  = pyfftw.empty_a
+0001d680: 6c69 676e 6564 286d 6173 6b5f 6469 6d73  ligned(mask_dims
+0001d690: 2c20 6474 7970 653d 2766 6c6f 6174 3634  , dtype='float64
+0001d6a0: 2729 0a20 2020 2020 2020 2066 6674 775f  ').        fftw_
+0001d6b0: 6f62 6a65 6374 3120 3d20 666f 7572 6965  object1 = fourie
+0001d6c0: 722e 6765 745f 7079 6666 7477 5f6f 626a  r.get_pyfftw_obj
+0001d6d0: 6563 7428 6d61 736b 5f64 696d 7329 0a20  ect(mask_dims). 
+0001d6e0: 2020 2020 2020 2066 6674 775f 6f62 6a65         fftw_obje
+0001d6f0: 6374 3220 3d20 666f 7572 6965 722e 6765  ct2 = fourier.ge
+0001d700: 745f 7079 6666 7477 5f6f 626a 6563 7428  t_pyfftw_object(
+0001d710: 6d61 736b 5f64 696d 7329 0a0a 2020 2020  mask_dims)..    
+0001d720: 2020 2020 2320 7072 6563 6f6d 7075 7465      # precompute
+0001d730: 2074 6865 7365 2074 6f20 7370 6565 6420   these to speed 
+0001d740: 7570 2063 616c 6375 6c61 7469 6f6e 730a  up calculations.
+0001d750: 2020 2020 2020 2020 7162 696e 732c 206c          qbins, l
+0001d760: 6162 656c 6c65 645f 7368 656c 6c73 203d  abelled_shells =
+0001d770: 2066 6f75 7269 6572 2e67 6574 5f6c 6162   fourier.get_lab
+0001d780: 656c 6c65 645f 7368 656c 6c73 280a 2020  elled_shells(.  
+0001d790: 2020 2020 2020 2020 2020 696e 7075 7431            input1
+0001d7a0: 2e73 6861 7065 290a 0a20 2020 2020 2020  .shape)..       
+0001d7b0: 2077 6172 6e69 6e67 7320 3d20 5b5d 0a20   warnings = []. 
+0001d7c0: 2020 2020 2020 2072 6573 5f6e 6f20 3d20         res_no = 
+0001d7d0: 300a 0a20 2020 2020 2020 2066 6f72 2063  0..        for c
+0001d7e0: 6861 696e 2069 6e20 6368 6169 6e73 3a0a  hain in chains:.
+0001d7f0: 2020 2020 2020 2020 2020 2020 666f 7220              for 
+0001d800: 6174 6f6d 2069 6e20 6368 6169 6e2e 6174  atom in chain.at
+0001d810: 6f6d 4c69 7374 3a0a 2020 2020 2020 2020  omList:.        
+0001d820: 2020 2020 2020 2020 6966 2061 746f 6d2e          if atom.
+0001d830: 6174 6f6d 5f6e 616d 6520 3d3d 2027 4341  atom_name == 'CA
+0001d840: 2720 6f72 2061 746f 6d2e 6174 6f6d 5f6e  ' or atom.atom_n
+0001d850: 616d 6520 3d3d 2022 4331 2722 3a0a 2020  ame == "C1'":.  
+0001d860: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d870: 2020 7061 7373 0a20 2020 2020 2020 2020    pass.         
+0001d880: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+0001d890: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d8a0: 2063 6f6e 7469 6e75 650a 0a20 2020 2020   continue..     
+0001d8b0: 2020 2020 2020 2020 2020 2063 726f 7070             cropp
+0001d8c0: 6564 5f6d 6170 5f31 203d 2074 6172 6765  ed_map_1 = targe
+0001d8d0: 745f 6d61 702e 6765 745f 6372 6f70 7065  t_map.get_croppe
+0001d8e0: 645f 626f 785f 6172 6f75 6e64 5f61 746f  d_box_around_ato
+0001d8f0: 6d28 0a20 2020 2020 2020 2020 2020 2020  m(.             
 0001d900: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0001d910: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001d920: 2020 2020 2020 2020 2020 2020 2020 6d61                ma
-0001d930: 736b 5f64 696d 732c 0a20 2020 2020 2020  sk_dims,.       
+0001d920: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d930: 2020 2061 746f 6d2c 0a20 2020 2020 2020     atom,.       
 0001d940: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0001d950: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0001d960: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001d970: 2020 2020 2020 2020 2029 2e66 756c 6c4d           ).fullM
-0001d980: 6170 0a20 2020 2020 2020 2020 2020 2020  ap.             
-0001d990: 2020 2066 7363 203d 2066 6f75 7269 6572     fsc = fourier
-0001d9a0: 2e63 616c 6375 6c61 7465 5f66 7363 5f77  .calculate_fsc_w
-0001d9b0: 6974 685f 6d61 736b 280a 2020 2020 2020  ith_mask(.      
-0001d9c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001d9d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001d9e0: 2020 6372 6f70 7065 645f 6d61 705f 312c    cropped_map_1,
-0001d9f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001da00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001da10: 2020 2020 2020 2020 2063 726f 7070 6564           cropped
-0001da20: 5f6d 6170 5f32 2c0a 2020 2020 2020 2020  _map_2,.        
+0001d970: 2020 2020 2020 2020 206d 6173 6b5f 6469           mask_di
+0001d980: 6d73 2c0a 2020 2020 2020 2020 2020 2020  ms,.            
+0001d990: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d9a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d9b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d9c0: 2020 2020 292e 6675 6c6c 4d61 700a 2020      ).fullMap.  
+0001d9d0: 2020 2020 2020 2020 2020 2020 2020 6372                cr
+0001d9e0: 6f70 7065 645f 6d61 705f 3220 3d20 7369  opped_map_2 = si
+0001d9f0: 6d5f 6d61 702e 6765 745f 6372 6f70 7065  m_map.get_croppe
+0001da00: 645f 626f 785f 6172 6f75 6e64 5f61 746f  d_box_around_ato
+0001da10: 6d28 0a20 2020 2020 2020 2020 2020 2020  m(.             
+0001da20: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0001da30: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0001da40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001da50: 6d61 736b 2e66 756c 6c4d 6170 2c0a 2020  mask.fullMap,.  
+0001da50: 2020 2061 746f 6d2c 0a20 2020 2020 2020     atom,.       
 0001da60: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0001da70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001da80: 2020 2020 2020 7069 7865 6c5f 7369 7a65        pixel_size
-0001da90: 3d74 6172 6765 745f 6d61 702e 6170 6978  =target_map.apix
-0001daa0: 5b30 5d2c 0a20 2020 2020 2020 2020 2020  [0],.           
+0001da80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001da90: 2020 2020 2020 2020 206d 6173 6b5f 6469           mask_di
+0001daa0: 6d73 2c0a 2020 2020 2020 2020 2020 2020  ms,.            
 0001dab0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001dac0: 2020 2020 2020 2020 2020 2020 206c 6162               lab
-0001dad0: 656c 6c65 645f 7368 656c 6c73 3d6c 6162  elled_shells=lab
-0001dae0: 656c 6c65 645f 7368 656c 6c73 2c0a 2020  elled_shells,.  
-0001daf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001db00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001db10: 2020 2020 2020 7162 696e 733d 7162 696e        qbins=qbin
-0001db20: 732c 0a20 2020 2020 2020 2020 2020 2020  s,.             
+0001dac0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001dad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001dae0: 2020 2020 292e 6675 6c6c 4d61 700a 2020      ).fullMap.  
+0001daf0: 2020 2020 2020 2020 2020 2020 2020 6673                fs
+0001db00: 6320 3d20 666f 7572 6965 722e 6361 6c63  c = fourier.calc
+0001db10: 756c 6174 655f 6673 635f 7769 7468 5f6d  ulate_fsc_with_m
+0001db20: 6173 6b28 0a20 2020 2020 2020 2020 2020  ask(.           
 0001db30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001db40: 2020 2020 2020 2020 2020 2066 6674 775f             fftw_
-0001db50: 6f62 6a65 6374 313d 6666 7477 5f6f 626a  object1=fftw_obj
-0001db60: 6563 7431 2c0a 2020 2020 2020 2020 2020  ect1,.          
+0001db40: 2020 2020 2020 2020 2020 2020 2063 726f               cro
+0001db50: 7070 6564 5f6d 6170 5f31 2c0a 2020 2020  pped_map_1,.    
+0001db60: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0001db70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001db80: 2020 2020 2020 2020 2020 2020 2020 6666                ff
-0001db90: 7477 5f6f 626a 6563 7432 3d66 6674 775f  tw_object2=fftw_
-0001dba0: 6f62 6a65 6374 322c 0a20 2020 2020 2020  object2,.       
-0001dbb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001dbc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001dbd0: 2029 0a0a 2020 2020 2020 2020 2020 2020   )..            
-0001dbe0: 2020 2020 2320 6669 6e64 2068 6967 6865      # find highe
-0001dbf0: 7374 2066 7265 7175 656e 6379 2073 6865  st frequency she
-0001dc00: 6c6c 2077 6974 6820 302e 3520 636f 7272  ll with 0.5 corr
-0001dc10: 656c 6174 696f 6e0a 2020 2020 2020 2020  elation.        
-0001dc20: 2020 2020 2020 2020 6672 6571 5f61 745f          freq_at_
-0001dc30: 636f 7272 5f63 7574 6f66 6620 3d20 666f  corr_cutoff = fo
-0001dc40: 7572 6965 722e 6765 745f 6673 635f 7265  urier.get_fsc_re
-0001dc50: 736f 6c75 7469 6f6e 280a 2020 2020 2020  solution(.      
+0001db80: 2020 2020 6372 6f70 7065 645f 6d61 705f      cropped_map_
+0001db90: 322c 0a20 2020 2020 2020 2020 2020 2020  2,.             
+0001dba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001dbb0: 2020 2020 2020 2020 2020 206d 6173 6b2e             mask.
+0001dbc0: 6675 6c6c 4d61 702c 0a20 2020 2020 2020  fullMap,.       
+0001dbd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001dbe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001dbf0: 2070 6978 656c 5f73 697a 653d 7461 7267   pixel_size=targ
+0001dc00: 6574 5f6d 6170 2e61 7069 785b 305d 2c0a  et_map.apix[0],.
+0001dc10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001dc20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001dc30: 2020 2020 2020 2020 6c61 6265 6c6c 6564          labelled
+0001dc40: 5f73 6865 6c6c 733d 6c61 6265 6c6c 6564  _shells=labelled
+0001dc50: 5f73 6865 6c6c 732c 0a20 2020 2020 2020  _shells,.       
 0001dc60: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0001dc70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001dc80: 2020 6673 632c 0a20 2020 2020 2020 2020    fsc,.         
+0001dc80: 2071 6269 6e73 3d71 6269 6e73 2c0a 2020   qbins=qbins,.  
 0001dc90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001dca0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-0001dcb0: 7363 5f74 6872 6573 686f 6c64 3d66 7363  sc_threshold=fsc
-0001dcc0: 5f74 6872 6573 686f 6c64 2c0a 2020 2020  _threshold,.    
-0001dcd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001dca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001dcb0: 2020 2020 2020 6666 7477 5f6f 626a 6563        fftw_objec
+0001dcc0: 7431 3d66 6674 775f 6f62 6a65 6374 312c  t1=fftw_object1,
+0001dcd0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
 0001dce0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001dcf0: 2020 2020 696e 7465 7270 6f6c 6174 655f      interpolate_
-0001dd00: 6375 746f 6666 3d69 6e74 6572 706f 6c61  cutoff=interpola
-0001dd10: 7465 5f63 7574 6f66 662c 0a20 2020 2020  te_cutoff,.     
+0001dcf0: 2020 2020 2020 2020 2066 6674 775f 6f62           fftw_ob
+0001dd00: 6a65 6374 323d 6666 7477 5f6f 626a 6563  ject2=fftw_objec
+0001dd10: 7432 2c0a 2020 2020 2020 2020 2020 2020  t2,.            
 0001dd20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001dd30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001dd40: 2020 2075 7365 5f68 6967 6865 7374 5f72     use_highest_r
-0001dd50: 6573 6f6c 7574 696f 6e3d 5472 7565 2c0a  esolution=True,.
-0001dd60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001dd70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001dd80: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
-0001dd90: 2020 2020 2020 2020 2020 2023 2066 7265             # fre
-0001dda0: 715f 6174 5f63 7574 6f66 6620 6361 6e20  q_at_cutoff can 
-0001ddb0: 3d20 3020 6966 2063 6f72 7265 6c61 7469  = 0 if correlati
-0001ddc0: 6f6e 206e 6576 6572 2064 726f 7073 2062  on never drops b
-0001ddd0: 656c 6f77 2030 2e35 0a20 2020 2020 2020  elow 0.5.       
-0001dde0: 2020 2020 2020 2020 2069 6620 6672 6571           if freq
-0001ddf0: 5f61 745f 636f 7272 5f63 7574 6f66 6620  _at_corr_cutoff 
-0001de00: 3c20 6d69 6e28 7461 7267 6574 5f6d 6170  < min(target_map
-0001de10: 2e61 7069 7829 202a 2032 3a0a 2020 2020  .apix) * 2:.    
-0001de20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001de30: 6672 6571 5f61 745f 636f 7272 5f63 7574  freq_at_corr_cut
-0001de40: 6f66 6620 3d20 6d69 6e28 7461 7267 6574  off = min(target
-0001de50: 5f6d 6170 2e61 7069 7829 202a 2032 0a20  _map.apix) * 2. 
-0001de60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001de70: 2020 2077 6172 6e69 6e67 732e 6170 7065     warnings.appe
-0001de80: 6e64 2866 2257 6172 6e69 6e67 3a20 4653  nd(f"Warning: FS
-0001de90: 4320 6174 2072 6573 6964 7565 207b 6174  C at residue {at
-0001dea0: 6f6d 2e72 6573 5f6e 6f7d 2069 6e22 0a20  om.res_no} in". 
-0001deb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001dec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ded0: 2020 2066 2220 6368 6169 6e20 7b61 746f     f" chain {ato
-0001dee0: 6d2e 6368 6169 6e7d 206e 6576 6572 2066  m.chain} never f
-0001def0: 616c 6c73 2062 656c 6f77 2022 0a20 2020  alls below ".   
-0001df00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001df10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001df20: 2066 2230 2e35 2e20 4c6f 5146 6974 2073   f"0.5. LoQFit s
-0001df30: 636f 7265 2066 6f72 2074 6869 7320 7265  core for this re
-0001df40: 7369 6475 6520 7365 7420 220a 2020 2020  sidue set ".    
-0001df50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001df60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001df70: 6622 746f 207b 6672 6571 5f61 745f 636f  f"to {freq_at_co
-0001df80: 7272 5f63 7574 6f66 667d 2e20 5468 6973  rr_cutoff}. This
-0001df90: 2069 7320 4e4f 5420 220a 2020 2020 2020   is NOT ".      
-0001dfa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001dfb0: 2020 2020 2020 2020 2020 2020 2020 6622                f"
-0001dfc0: 6578 7065 6374 6564 2061 6e64 204e 4f54  expected and NOT
-0001dfd0: 2061 6e20 696e 6469 6361 7469 6f6e 206f   an indication o
-0001dfe0: 6620 6120 220a 2020 2020 2020 2020 2020  f a ".          
-0001dff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e000: 2020 2020 2020 2020 2020 6622 676f 6f64            f"good
-0001e010: 2066 6974 2062 6574 7765 656e 206d 6170   fit between map
-0001e020: 2061 6e64 206d 6f64 656c 2e22 290a 0a20   and model.").. 
-0001e030: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-0001e040: 2049 6620 7468 6572 6520 6973 2070 6f6f   If there is poo
-0001e050: 7220 636f 7272 656c 6174 696f 6e20 696e  r correlation in
-0001e060: 206c 6f77 2072 6573 6f6c 7574 696f 6e20   low resolution 
-0001e070: 7368 656c 6c73 2074 6865 0a20 2020 2020  shells the.     
-0001e080: 2020 2020 2020 2020 2020 2023 2066 7265             # fre
-0001e090: 715f 6174 5f63 7574 6f66 6620 6361 6e20  q_at_cutoff can 
-0001e0a0: 6265 2072 6964 6963 756c 6f75 736c 7920  be ridiculously 
-0001e0b0: 6869 6768 2028 692e 652e 203e 3130 3020  high (i.e. >100 
-0001e0c0: 616e 6773 7472 6f6d 7329 0a20 2020 2020  angstroms).     
-0001e0d0: 2020 2020 2020 2020 2020 2023 2077 6869             # whi
-0001e0e0: 6368 2072 7569 6e73 2074 6865 2073 6361  ch ruins the sca
-0001e0f0: 6c69 6e67 2077 6865 6e20 7468 6520 7363  ling when the sc
-0001e100: 6f72 6520 6973 2070 6c6f 7474 6564 0a20  ore is plotted. 
-0001e110: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-0001e120: 6620 6672 6571 5f61 745f 636f 7272 5f63  f freq_at_corr_c
-0001e130: 7574 6f66 6620 3e20 6d61 785f 7265 733a  utoff > max_res:
-0001e140: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001e150: 2020 2020 2077 6172 6e69 6e67 732e 6170       warnings.ap
-0001e160: 7065 6e64 2866 2257 6172 6e69 6e67 3a20  pend(f"Warning: 
-0001e170: 5265 7369 6475 6520 7b61 746f 6d2e 7265  Residue {atom.re
-0001e180: 735f 6e6f 7d20 696e 2063 6861 696e 2022  s_no} in chain "
-0001e190: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001e1a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e1b0: 2020 2020 2066 227b 6174 6f6d 2e63 6861       f"{atom.cha
-0001e1c0: 696e 7d20 6861 7320 6c6f 6361 6c20 7265  in} has local re
-0001e1d0: 736f 6c75 7469 6f6e 206f 6620 220a 2020  solution of ".  
-0001e1e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e1f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e200: 2020 6622 207b 6672 6571 5f61 745f 636f    f" {freq_at_co
-0001e210: 7272 5f63 7574 6f66 667d 2c20 7768 6963  rr_cutoff}, whic
-0001e220: 6820 6973 2073 6574 2022 0a20 2020 2020  h is set ".     
-0001e230: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e240: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-0001e250: 2274 6f20 7b6d 6178 5f72 6573 7d22 290a  "to {max_res}").
-0001e260: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e270: 2020 2020 6672 6571 5f61 745f 636f 7272      freq_at_corr
-0001e280: 5f63 7574 6f66 6620 3d20 6d61 785f 7265  _cutoff = max_re
-0001e290: 730a 0a20 2020 2020 2020 2020 2020 2020  s..             
-0001e2a0: 2020 2069 6620 6e6f 726d 616c 6973 655f     if normalise_
-0001e2b0: 7769 7468 5f68 616c 665f 6d61 703a 0a20  with_half_map:. 
-0001e2c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e2d0: 2020 2063 726f 705f 686d 6170 5f31 203d     crop_hmap_1 =
-0001e2e0: 2068 616c 665f 6d61 705f 312e 6765 745f   half_map_1.get_
-0001e2f0: 6372 6f70 7065 645f 626f 785f 6172 6f75  cropped_box_arou
-0001e300: 6e64 5f61 746f 6d28 0a20 2020 2020 2020  nd_atom(.       
+0001dd30: 2020 2020 2020 2020 2020 2020 290a 0a20              ).. 
+0001dd40: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+0001dd50: 2066 696e 6420 6869 6768 6573 7420 6672   find highest fr
+0001dd60: 6571 7565 6e63 7920 7368 656c 6c20 7769  equency shell wi
+0001dd70: 7468 2030 2e35 2063 6f72 7265 6c61 7469  th 0.5 correlati
+0001dd80: 6f6e 0a20 2020 2020 2020 2020 2020 2020  on.             
+0001dd90: 2020 2066 7265 715f 6174 5f63 6f72 725f     freq_at_corr_
+0001dda0: 6375 746f 6666 203d 2066 6f75 7269 6572  cutoff = fourier
+0001ddb0: 2e67 6574 5f66 7363 5f72 6573 6f6c 7574  .get_fsc_resolut
+0001ddc0: 696f 6e28 0a20 2020 2020 2020 2020 2020  ion(.           
+0001ddd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001dde0: 2020 2020 2020 2020 2020 2020 2066 7363               fsc
+0001ddf0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0001de00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001de10: 2020 2020 2020 2020 2020 6673 635f 7468            fsc_th
+0001de20: 7265 7368 6f6c 643d 6673 635f 7468 7265  reshold=fsc_thre
+0001de30: 7368 6f6c 642c 0a20 2020 2020 2020 2020  shold,.         
+0001de40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001de50: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+0001de60: 6e74 6572 706f 6c61 7465 5f63 7574 6f66  nterpolate_cutof
+0001de70: 663d 696e 7465 7270 6f6c 6174 655f 6375  f=interpolate_cu
+0001de80: 746f 6666 2c0a 2020 2020 2020 2020 2020  toff,.          
+0001de90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001dea0: 2020 2020 2020 2020 2020 2020 2020 7573                us
+0001deb0: 655f 6869 6768 6573 745f 7265 736f 6c75  e_highest_resolu
+0001dec0: 7469 6f6e 3d54 7275 652c 0a20 2020 2020  tion=True,.     
+0001ded0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001dee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001def0: 2020 2029 0a0a 2020 2020 2020 2020 2020     )..          
+0001df00: 2020 2020 2020 2320 6672 6571 5f61 745f        # freq_at_
+0001df10: 6375 746f 6666 2063 616e 203d 2030 2069  cutoff can = 0 i
+0001df20: 6620 636f 7272 656c 6174 696f 6e20 6e65  f correlation ne
+0001df30: 7665 7220 6472 6f70 7320 6265 6c6f 7720  ver drops below 
+0001df40: 302e 350a 2020 2020 2020 2020 2020 2020  0.5.            
+0001df50: 2020 2020 6966 2066 7265 715f 6174 5f63      if freq_at_c
+0001df60: 6f72 725f 6375 746f 6666 203c 206d 696e  orr_cutoff < min
+0001df70: 2874 6172 6765 745f 6d61 702e 6170 6978  (target_map.apix
+0001df80: 2920 2a20 323a 0a20 2020 2020 2020 2020  ) * 2:.         
+0001df90: 2020 2020 2020 2020 2020 2066 7265 715f             freq_
+0001dfa0: 6174 5f63 6f72 725f 6375 746f 6666 203d  at_corr_cutoff =
+0001dfb0: 206d 696e 2874 6172 6765 745f 6d61 702e   min(target_map.
+0001dfc0: 6170 6978 2920 2a20 320a 2020 2020 2020  apix) * 2.      
+0001dfd0: 2020 2020 2020 2020 2020 2020 2020 7761                wa
+0001dfe0: 726e 696e 6773 2e61 7070 656e 6428 6622  rnings.append(f"
+0001dff0: 5761 726e 696e 673a 2046 5343 2061 7420  Warning: FSC at 
+0001e000: 7265 7369 6475 6520 7b61 746f 6d2e 7265  residue {atom.re
+0001e010: 735f 6e6f 7d20 696e 220a 2020 2020 2020  s_no} in".      
+0001e020: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e030: 2020 2020 2020 2020 2020 2020 2020 6622                f"
+0001e040: 2063 6861 696e 207b 6174 6f6d 2e63 6861   chain {atom.cha
+0001e050: 696e 7d20 6e65 7665 7220 6661 6c6c 7320  in} never falls 
+0001e060: 6265 6c6f 7720 220a 2020 2020 2020 2020  below ".        
+0001e070: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e080: 2020 2020 2020 2020 2020 2020 6622 302e              f"0.
+0001e090: 352e 204c 6f51 4669 7420 7363 6f72 6520  5. LoQFit score 
+0001e0a0: 666f 7220 7468 6973 2072 6573 6964 7565  for this residue
+0001e0b0: 2073 6574 2022 0a20 2020 2020 2020 2020   set ".         
+0001e0c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e0d0: 2020 2020 2020 2020 2020 2066 2274 6f20             f"to 
+0001e0e0: 7b66 7265 715f 6174 5f63 6f72 725f 6375  {freq_at_corr_cu
+0001e0f0: 746f 6666 7d2e 2054 6869 7320 6973 204e  toff}. This is N
+0001e100: 4f54 2022 0a20 2020 2020 2020 2020 2020  OT ".           
+0001e110: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e120: 2020 2020 2020 2020 2066 2265 7870 6563           f"expec
+0001e130: 7465 6420 616e 6420 4e4f 5420 616e 2069  ted and NOT an i
+0001e140: 6e64 6963 6174 696f 6e20 6f66 2061 2022  ndication of a "
+0001e150: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001e160: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e170: 2020 2020 2066 2267 6f6f 6420 6669 7420       f"good fit 
+0001e180: 6265 7477 6565 6e20 6d61 7020 616e 6420  between map and 
+0001e190: 6d6f 6465 6c2e 2229 0a0a 2020 2020 2020  model.")..      
+0001e1a0: 2020 2020 2020 2020 2020 2320 4966 2074            # If t
+0001e1b0: 6865 7265 2069 7320 706f 6f72 2063 6f72  here is poor cor
+0001e1c0: 7265 6c61 7469 6f6e 2069 6e20 6c6f 7720  relation in low 
+0001e1d0: 7265 736f 6c75 7469 6f6e 2073 6865 6c6c  resolution shell
+0001e1e0: 7320 7468 650a 2020 2020 2020 2020 2020  s the.          
+0001e1f0: 2020 2020 2020 2320 6672 6571 5f61 745f        # freq_at_
+0001e200: 6375 746f 6666 2063 616e 2062 6520 7269  cutoff can be ri
+0001e210: 6469 6375 6c6f 7573 6c79 2068 6967 6820  diculously high 
+0001e220: 2869 2e65 2e20 3e31 3030 2061 6e67 7374  (i.e. >100 angst
+0001e230: 726f 6d73 290a 2020 2020 2020 2020 2020  roms).          
+0001e240: 2020 2020 2020 2320 7768 6963 6820 7275        # which ru
+0001e250: 696e 7320 7468 6520 7363 616c 696e 6720  ins the scaling 
+0001e260: 7768 656e 2074 6865 2073 636f 7265 2069  when the score i
+0001e270: 7320 706c 6f74 7465 640a 2020 2020 2020  s plotted.      
+0001e280: 2020 2020 2020 2020 2020 6966 2066 7265            if fre
+0001e290: 715f 6174 5f63 6f72 725f 6375 746f 6666  q_at_corr_cutoff
+0001e2a0: 203e 206d 6178 5f72 6573 3a0a 2020 2020   > max_res:.    
+0001e2b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e2c0: 7761 726e 696e 6773 2e61 7070 656e 6428  warnings.append(
+0001e2d0: 6622 5761 726e 696e 673a 2052 6573 6964  f"Warning: Resid
+0001e2e0: 7565 207b 6174 6f6d 2e72 6573 5f6e 6f7d  ue {atom.res_no}
+0001e2f0: 2069 6e20 6368 6169 6e20 220a 2020 2020   in chain ".    
+0001e300: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0001e310: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e320: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e330: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e340: 2020 2020 2020 2020 2020 2020 2061 746f               ato
-0001e350: 6d2c 0a20 2020 2020 2020 2020 2020 2020  m,.             
-0001e360: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e370: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e380: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e390: 2020 2020 2020 206d 6173 6b5f 6469 6d73         mask_dims
-0001e3a0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0001e3b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e3c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e3d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e3e0: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-0001e3f0: 2020 2020 2020 2020 2020 2020 6372 6f70              crop
-0001e400: 5f68 6d61 705f 3220 3d20 6861 6c66 5f6d  _hmap_2 = half_m
-0001e410: 6170 5f32 2e67 6574 5f63 726f 7070 6564  ap_2.get_cropped
-0001e420: 5f62 6f78 5f61 726f 756e 645f 6174 6f6d  _box_around_atom
-0001e430: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-0001e440: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e450: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e460: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e470: 2020 2020 2020 6174 6f6d 2c0a 2020 2020        atom,.    
+0001e320: 6622 7b61 746f 6d2e 6368 6169 6e7d 2068  f"{atom.chain} h
+0001e330: 6173 206c 6f63 616c 2072 6573 6f6c 7574  as local resolut
+0001e340: 696f 6e20 6f66 2022 0a20 2020 2020 2020  ion of ".       
+0001e350: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e360: 2020 2020 2020 2020 2020 2020 2066 2220               f" 
+0001e370: 7b66 7265 715f 6174 5f63 6f72 725f 6375  {freq_at_corr_cu
+0001e380: 746f 6666 7d2c 2077 6869 6368 2069 7320  toff}, which is 
+0001e390: 7365 7420 220a 2020 2020 2020 2020 2020  set ".          
+0001e3a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e3b0: 2020 2020 2020 2020 2020 6622 746f 207b            f"to {
+0001e3c0: 6d61 785f 7265 737d 2229 0a20 2020 2020  max_res}").     
+0001e3d0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+0001e3e0: 7265 715f 6174 5f63 6f72 725f 6375 746f  req_at_corr_cuto
+0001e3f0: 6666 203d 206d 6178 5f72 6573 0a0a 2020  ff = max_res..  
+0001e400: 2020 2020 2020 2020 2020 2020 2020 6966                if
+0001e410: 206e 6f72 6d61 6c69 7365 5f77 6974 685f   normalise_with_
+0001e420: 6861 6c66 5f6d 6170 3a0a 2020 2020 2020  half_map:.      
+0001e430: 2020 2020 2020 2020 2020 2020 2020 6372                cr
+0001e440: 6f70 5f68 6d61 705f 3120 3d20 6861 6c66  op_hmap_1 = half
+0001e450: 5f6d 6170 5f31 2e67 6574 5f63 726f 7070  _map_1.get_cropp
+0001e460: 6564 5f62 6f78 5f61 726f 756e 645f 6174  ed_box_around_at
+0001e470: 6f6d 280a 2020 2020 2020 2020 2020 2020  om(.            
 0001e480: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0001e490: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0001e4a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e4b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e4c0: 6d61 736b 5f64 696d 732c 0a20 2020 2020  mask_dims,.     
+0001e4b0: 2020 2020 2020 2020 6174 6f6d 2c0a 2020          atom,.  
+0001e4c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0001e4d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0001e4e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0001e4f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e500: 2020 2020 2020 2020 2020 2020 2020 2029                 )
-0001e510: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001e520: 2020 2020 2066 7363 203d 2066 6f75 7269       fsc = fouri
-0001e530: 6572 2e63 616c 6375 6c61 7465 5f66 7363  er.calculate_fsc
-0001e540: 5f77 6974 685f 6d61 736b 280a 2020 2020  _with_mask(.    
-0001e550: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e560: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e570: 2020 2020 2020 2020 6372 6f70 5f68 6d61          crop_hma
-0001e580: 705f 312e 6675 6c6c 4d61 702c 0a20 2020  p_1.fullMap,.   
-0001e590: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e500: 2020 6d61 736b 5f64 696d 732c 0a20 2020    mask_dims,.   
+0001e510: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e520: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e530: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e540: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e550: 2029 0a20 2020 2020 2020 2020 2020 2020   ).             
+0001e560: 2020 2020 2020 2063 726f 705f 686d 6170         crop_hmap
+0001e570: 5f32 203d 2068 616c 665f 6d61 705f 322e  _2 = half_map_2.
+0001e580: 6765 745f 6372 6f70 7065 645f 626f 785f  get_cropped_box_
+0001e590: 6172 6f75 6e64 5f61 746f 6d28 0a20 2020  around_atom(.   
 0001e5a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e5b0: 2020 2020 2020 2020 2063 726f 705f 686d           crop_hm
-0001e5c0: 6170 5f32 2e66 756c 6c4d 6170 2c0a 2020  ap_2.fullMap,.  
+0001e5b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e5c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0001e5d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e5e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e5f0: 2020 2020 2020 2020 2020 6d61 736b 2e66            mask.f
-0001e600: 756c 6c4d 6170 2c0a 2020 2020 2020 2020  ullMap,.        
+0001e5e0: 2061 746f 6d2c 0a20 2020 2020 2020 2020   atom,.         
+0001e5f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e600: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0001e610: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e620: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e630: 2020 2020 7069 7865 6c5f 7369 7a65 3d74      pixel_size=t
-0001e640: 6172 6765 745f 6d61 702e 6170 6978 5b30  arget_map.apix[0
-0001e650: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
+0001e620: 2020 2020 2020 2020 2020 206d 6173 6b5f             mask_
+0001e630: 6469 6d73 2c0a 2020 2020 2020 2020 2020  dims,.          
+0001e640: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e650: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0001e660: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e670: 2020 2020 2020 2020 2020 2020 2020 206c                 l
-0001e680: 6162 656c 6c65 645f 7368 656c 6c73 3d6c  abelled_shells=l
-0001e690: 6162 656c 6c65 645f 7368 656c 6c73 2c0a  abelled_shells,.
-0001e6a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e6b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e6c0: 2020 2020 2020 2020 2020 2020 7162 696e              qbin
-0001e6d0: 733d 7162 696e 732c 0a20 2020 2020 2020  s=qbins,.       
-0001e6e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e6f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e700: 2020 2020 2066 6674 775f 6f62 6a65 6374       fftw_object
-0001e710: 313d 6666 7477 5f6f 626a 6563 7431 2c0a  1=fftw_object1,.
-0001e720: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e730: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e740: 2020 2020 2020 2020 2020 2020 6666 7477              fftw
-0001e750: 5f6f 626a 6563 7432 3d66 6674 775f 6f62  _object2=fftw_ob
-0001e760: 6a65 6374 322c 0a20 2020 2020 2020 2020  ject2,.         
-0001e770: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e670: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+0001e680: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e690: 6673 6320 3d20 666f 7572 6965 722e 6361  fsc = fourier.ca
+0001e6a0: 6c63 756c 6174 655f 6673 635f 7769 7468  lculate_fsc_with
+0001e6b0: 5f6d 6173 6b28 0a20 2020 2020 2020 2020  _mask(.         
+0001e6c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e6d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e6e0: 2020 2063 726f 705f 686d 6170 5f31 2e66     crop_hmap_1.f
+0001e6f0: 756c 6c4d 6170 2c0a 2020 2020 2020 2020  ullMap,.        
+0001e700: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e710: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e720: 2020 2020 6372 6f70 5f68 6d61 705f 322e      crop_hmap_2.
+0001e730: 6675 6c6c 4d61 702c 0a20 2020 2020 2020  fullMap,.       
+0001e740: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e750: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e760: 2020 2020 206d 6173 6b2e 6675 6c6c 4d61       mask.fullMa
+0001e770: 702c 0a20 2020 2020 2020 2020 2020 2020  p,.             
 0001e780: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e790: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
-0001e7a0: 2020 2020 2020 2020 206c 6f63 616c 5f72           local_r
-0001e7b0: 6573 203d 2066 6f75 7269 6572 2e67 6574  es = fourier.get
-0001e7c0: 5f66 7363 5f72 6573 6f6c 7574 696f 6e28  _fsc_resolution(
-0001e7d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001e7e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e7f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e800: 2066 7363 2c0a 2020 2020 2020 2020 2020   fsc,.          
+0001e790: 2020 2020 2020 2020 2020 2020 2020 2070                 p
+0001e7a0: 6978 656c 5f73 697a 653d 7461 7267 6574  ixel_size=target
+0001e7b0: 5f6d 6170 2e61 7069 785b 305d 2c0a 2020  _map.apix[0],.  
+0001e7c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e7d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e7e0: 2020 2020 2020 2020 2020 6c61 6265 6c6c            labell
+0001e7f0: 6564 5f73 6865 6c6c 733d 6c61 6265 6c6c  ed_shells=labell
+0001e800: 6564 5f73 6865 6c6c 732c 0a20 2020 2020  ed_shells,.     
 0001e810: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0001e820: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e830: 2020 2020 2020 6673 635f 7468 7265 7368        fsc_thresh
-0001e840: 6f6c 643d 302e 352c 0a20 2020 2020 2020  old=0.5,.       
+0001e830: 2020 2020 2020 2071 6269 6e73 3d71 6269         qbins=qbi
+0001e840: 6e73 2c0a 2020 2020 2020 2020 2020 2020  ns,.            
 0001e850: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0001e860: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e870: 2020 2020 2020 2020 2069 6e74 6572 706f           interpo
-0001e880: 6c61 7465 5f63 7574 6f66 663d 4661 6c73  late_cutoff=Fals
-0001e890: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
+0001e870: 6666 7477 5f6f 626a 6563 7431 3d66 6674  fftw_object1=fft
+0001e880: 775f 6f62 6a65 6374 312c 0a20 2020 2020  w_object1,.     
+0001e890: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0001e8a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e8b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e8c0: 2020 2075 7365 5f68 6967 6865 7374 5f72     use_highest_r
-0001e8d0: 6573 6f6c 7574 696f 6e3d 5472 7565 2c0a  esolution=True,.
+0001e8b0: 2020 2020 2020 2066 6674 775f 6f62 6a65         fftw_obje
+0001e8c0: 6374 323d 6666 7477 5f6f 626a 6563 7432  ct2=fftw_object2
+0001e8d0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
 0001e8e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e8f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e8f0: 2020 2020 2020 2020 2020 2020 2020 290a                ).
 0001e900: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e910: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0001e920: 2020 2020 2020 6672 6571 5f61 745f 636f        freq_at_co
-0001e930: 7272 5f63 7574 6f66 6620 3d20 6672 6571  rr_cutoff = freq
-0001e940: 5f61 745f 636f 7272 5f63 7574 6f66 6620  _at_corr_cutoff 
-0001e950: 2f20 6c6f 6361 6c5f 7265 730a 0a20 2020  / local_res..   
-0001e960: 2020 2020 2020 2020 2020 2020 2064 6963               dic
-0001e970: 745f 7265 735f 7363 6f72 6573 5b28 6174  t_res_scores[(at
-0001e980: 6f6d 2e63 6861 696e 2c20 696e 7428 6174  om.chain, int(at
-0001e990: 6f6d 2e72 6573 5f6e 6f29 295d 203d 205c  om.res_no))] = \
-0001e9a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001e9b0: 2020 2020 2066 7265 715f 6174 5f63 6f72       freq_at_cor
-0001e9c0: 725f 6375 746f 6666 0a0a 2020 2020 2020  r_cutoff..      
-0001e9d0: 2020 2020 2020 2020 2020 7265 735f 6e6f            res_no
-0001e9e0: 202b 3d20 310a 2020 2020 2020 2020 2020   += 1.          
-0001e9f0: 2020 2020 2020 6966 2076 6572 626f 7365        if verbose
-0001ea00: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0001ea10: 2020 2020 2020 7a66 696c 6c5f 6c65 6e20        zfill_len 
-0001ea20: 3d20 6c65 6e28 7374 7228 6e75 6d62 6572  = len(str(number
-0001ea30: 5f6f 665f 7265 7369 6475 6573 2929 0a20  _of_residues)). 
-0001ea40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ea50: 2020 2070 7269 6e74 2866 225c 7250 726f     print(f"\rPro
-0001ea60: 6365 7373 6564 2072 6573 6964 7565 207b  cessed residue {
-0001ea70: 7374 7228 7265 735f 6e6f 292e 7a66 696c  str(res_no).zfil
-0001ea80: 6c28 7a66 696c 6c5f 6c65 6e29 7d22 0a20  l(zfill_len)}". 
-0001ea90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001eaa0: 2020 2020 2020 2020 2066 222f 7b6e 756d           f"/{num
-0001eab0: 6265 725f 6f66 5f72 6573 6964 7565 737d  ber_of_residues}
-0001eac0: 222c 2073 6570 3d27 272c 2065 6e64 3d27  ", sep='', end='
-0001ead0: 272c 2066 6c75 7368 3d54 7275 6529 0a0a  ', flush=True)..
-0001eae0: 2020 2020 2020 2020 6966 2076 6572 626f          if verbo
-0001eaf0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-0001eb00: 7072 696e 7428 2222 290a 2020 2020 2020  print("").      
-0001eb10: 2020 2020 2020 666f 7220 7761 726e 696e        for warnin
-0001eb20: 6720 696e 2077 6172 6e69 6e67 733a 0a20  g in warnings:. 
-0001eb30: 2020 2020 2020 2020 2020 2020 2020 2070                 p
-0001eb40: 7269 6e74 2877 6172 6e69 6e67 290a 0a20  rint(warning).. 
-0001eb50: 2020 2020 2020 2072 6574 7572 6e20 6469         return di
-0001eb60: 6374 5f72 6573 5f73 636f 7265 730a 0a20  ct_res_scores.. 
-0001eb70: 2020 2064 6566 206d 6170 5f6c 6f63 616c     def map_local
-0001eb80: 5f72 6573 6f6c 7574 696f 6e28 0a20 2020  _resolution(.   
-0001eb90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001eba0: 2020 2020 2020 2020 2073 656c 662c 0a20           self,. 
-0001ebb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ebc0: 2020 2020 2020 2020 2020 2068 616c 665f             half_
-0001ebd0: 6d61 705f 312c 0a20 2020 2020 2020 2020  map_1,.         
-0001ebe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ebf0: 2020 2068 616c 665f 6d61 705f 322c 0a20     half_map_2,. 
+0001e910: 2020 2020 6c6f 6361 6c5f 7265 7320 3d20      local_res = 
+0001e920: 666f 7572 6965 722e 6765 745f 6673 635f  fourier.get_fsc_
+0001e930: 7265 736f 6c75 7469 6f6e 280a 2020 2020  resolution(.    
+0001e940: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e950: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e960: 2020 2020 2020 2020 2020 2020 6673 632c              fsc,
+0001e970: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001e980: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e990: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e9a0: 2066 7363 5f74 6872 6573 686f 6c64 3d30   fsc_threshold=0
+0001e9b0: 2e35 2c0a 2020 2020 2020 2020 2020 2020  .5,.            
+0001e9c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e9d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e9e0: 2020 2020 696e 7465 7270 6f6c 6174 655f      interpolate_
+0001e9f0: 6375 746f 6666 3d46 616c 7365 2c0a 2020  cutoff=False,.  
+0001ea00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ea10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ea20: 2020 2020 2020 2020 2020 2020 2020 7573                us
+0001ea30: 655f 6869 6768 6573 745f 7265 736f 6c75  e_highest_resolu
+0001ea40: 7469 6f6e 3d54 7275 652c 0a20 2020 2020  tion=True,.     
+0001ea50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ea60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ea70: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
+0001ea80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ea90: 2066 7265 715f 6174 5f63 6f72 725f 6375   freq_at_corr_cu
+0001eaa0: 746f 6666 203d 2066 7265 715f 6174 5f63  toff = freq_at_c
+0001eab0: 6f72 725f 6375 746f 6666 202f 206c 6f63  orr_cutoff / loc
+0001eac0: 616c 5f72 6573 0a0a 2020 2020 2020 2020  al_res..        
+0001ead0: 2020 2020 2020 2020 6469 6374 5f72 6573          dict_res
+0001eae0: 5f73 636f 7265 735b 2861 746f 6d2e 6368  _scores[(atom.ch
+0001eaf0: 6169 6e2c 2069 6e74 2861 746f 6d2e 7265  ain, int(atom.re
+0001eb00: 735f 6e6f 2929 5d20 3d20 5c0a 2020 2020  s_no))] = \.    
+0001eb10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001eb20: 6672 6571 5f61 745f 636f 7272 5f63 7574  freq_at_corr_cut
+0001eb30: 6f66 660a 0a20 2020 2020 2020 2020 2020  off..           
+0001eb40: 2020 2020 2072 6573 5f6e 6f20 2b3d 2031       res_no += 1
+0001eb50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001eb60: 2069 6620 7665 7262 6f73 653a 0a20 2020   if verbose:.   
+0001eb70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001eb80: 207a 6669 6c6c 5f6c 656e 203d 206c 656e   zfill_len = len
+0001eb90: 2873 7472 286e 756d 6265 725f 6f66 5f72  (str(number_of_r
+0001eba0: 6573 6964 7565 7329 290a 2020 2020 2020  esidues)).      
+0001ebb0: 2020 2020 2020 2020 2020 2020 2020 7072                pr
+0001ebc0: 696e 7428 6622 5c72 5072 6f63 6573 7365  int(f"\rProcesse
+0001ebd0: 6420 7265 7369 6475 6520 7b73 7472 2872  d residue {str(r
+0001ebe0: 6573 5f6e 6f29 2e7a 6669 6c6c 287a 6669  es_no).zfill(zfi
+0001ebf0: 6c6c 5f6c 656e 297d 220a 2020 2020 2020  ll_len)}".      
 0001ec00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ec10: 2020 2020 2020 2020 2020 2073 7472 7563             struc
-0001ec20: 7475 7265 3d4e 6f6e 652c 0a20 2020 2020  ture=None,.     
-0001ec30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ec40: 2020 2020 2020 2070 726f 7465 696e 5f6d         protein_m
-0001ec50: 6173 6b3d 4e6f 6e65 2c0a 2020 2020 2020  ask=None,.      
-0001ec60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ec70: 2020 2020 2020 7665 7262 6f73 653d 5472        verbose=Tr
-0001ec80: 7565 2c0a 2020 2020 2020 2020 2020 2020  ue,.            
-0001ec90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001eca0: 6673 635f 7468 7265 7368 6f6c 643d 302e  fsc_threshold=0.
-0001ecb0: 352c 0a20 2020 2020 2020 2020 2020 2020  5,.             
-0001ecc0: 2020 2020 2020 2020 2020 2020 2020 2029                 )
-0001ecd0: 3a0a 2020 2020 2020 2020 2222 2243 616c  :.        """Cal
-0001ece0: 6375 6c61 7465 2074 6865 206c 6f63 616c  culate the local
-0001ecf0: 2072 6573 6f6c 7574 696f 6e20 7573 696e   resolution usin
-0001ed00: 6720 7468 6520 6c6f 6361 6c20 4653 4320  g the local FSC 
-0001ed10: 6d65 7468 6f64 2e0a 0a20 2020 2020 2020  method...       
-0001ed20: 2041 7267 756d 656e 7473 3a0a 2020 2020   Arguments:.    
-0001ed30: 2020 2020 2020 2020 6861 6c66 5f6d 6170          half_map
-0001ed40: 5f31 3a20 4120 6d61 7020 696e 7374 616e  _1: A map instan
-0001ed50: 6365 206f 6620 7468 6520 6669 7273 7420  ce of the first 
-0001ed60: 6861 6c66 2d6d 6170 2e0a 2020 2020 2020  half-map..      
-0001ed70: 2020 2020 2020 6861 6c66 5f6d 6170 5f32        half_map_2
-0001ed80: 3a20 4120 6d61 7020 696e 7374 616e 6365  : A map instance
-0001ed90: 206f 6620 7468 6520 7365 636f 6e64 2068   of the second h
-0001eda0: 616c 6620 6d61 702e 0a20 2020 2020 2020  alf map..       
-0001edb0: 2020 2020 2073 7472 7563 7475 7265 3a20       structure: 
-0001edc0: 4d6f 6465 6c20 7374 7275 6374 7572 6520  Model structure 
-0001edd0: 696e 7374 616e 6365 2e20 4966 2064 6566  instance. If def
-0001ede0: 696e 6564 2c20 7468 650a 2020 2020 2020  ined, the.      
-0001edf0: 2020 2020 2020 2020 2020 6c6f 6361 6c20            local 
-0001ee00: 7265 736f 6c75 7469 6f6e 2069 7320 6361  resolution is ca
-0001ee10: 6c63 756c 6174 6564 2061 7420 7468 6520  lculated at the 
-0001ee20: 4341 2061 746f 6d0a 2020 2020 2020 2020  CA atom.        
-0001ee30: 2020 2020 2020 2020 666f 7220 6561 6368          for each
-0001ee40: 2072 6573 6964 7565 2069 6e20 7468 6520   residue in the 
-0001ee50: 7374 7275 6374 7572 6520 6f6e 6c79 2e0a  structure only..
-0001ee60: 2020 2020 2020 2020 2020 2020 7072 6f74              prot
-0001ee70: 6569 6e5f 6d61 736b 3a20 4120 4d61 7020  ein_mask: A Map 
-0001ee80: 696e 7374 616e 6365 206f 6620 6120 6d61  instance of a ma
-0001ee90: 736b 2e20 4966 2064 6566 696e 6564 2c20  sk. If defined, 
-0001eea0: 7468 650a 2020 2020 2020 2020 2020 2020  the.            
-0001eeb0: 2020 2020 6c6f 6361 6c20 7265 736f 6c75      local resolu
-0001eec0: 7469 6f6e 2069 7320 6361 6c63 756c 6174  tion is calculat
-0001eed0: 6564 2061 7420 6561 6368 2070 6f69 6e74  ed at each point
-0001eee0: 2077 6974 6869 6e0a 2020 2020 2020 2020   within.        
-0001eef0: 2020 2020 2020 2020 7468 6520 6d61 736b          the mask
-0001ef00: 206f 6e6c 792e 0a20 2020 2020 2020 2020   only..         
-0001ef10: 2020 2076 6572 626f 7365 3a20 4966 2054     verbose: If T
-0001ef20: 7275 652c 2070 7269 6e74 7320 6120 7072  rue, prints a pr
-0001ef30: 6f67 7265 7373 2062 6172 2061 6e64 2077  ogress bar and w
-0001ef40: 6172 6e69 6e67 730a 2020 2020 2020 2020  arnings.        
-0001ef50: 2020 2020 6673 635f 7468 7265 7368 6f6c      fsc_threshol
-0001ef60: 643a 2043 6f72 7265 6c61 7469 6f6e 2074  d: Correlation t
-0001ef70: 6872 6573 686f 6c64 2076 616c 7565 2074  hreshold value t
-0001ef80: 6861 7420 6465 6669 6e65 730a 2020 2020  hat defines.    
-0001ef90: 2020 2020 2020 2020 2020 2020 686f 7720              how 
-0001efa0: 7468 6520 6d61 7020 7265 736f 6c75 7469  the map resoluti
-0001efb0: 6f6e 2069 7320 666f 756e 642e 0a0a 2020  on is found...  
-0001efc0: 2020 2020 2020 5265 7475 726e 733a 0a20        Returns:. 
-0001efd0: 2020 2020 2020 2020 2020 2054 6865 206c             The l
-0001efe0: 6f63 616c 2072 6573 6f6c 7574 696f 6e20  ocal resolution 
-0001eff0: 6174 2065 6163 6820 706f 7369 7469 6f6e  at each position
-0001f000: 2069 6e20 7468 6520 6d61 702c 206f 7220   in the map, or 
-0001f010: 6173 0a20 2020 2020 2020 2020 2020 2064  as.            d
-0001f020: 6566 696e 6564 2062 7920 7468 6520 7374  efined by the st
-0001f030: 7275 6374 7572 6520 696e 7374 616e 6365  ructure instance
-0001f040: 206f 7220 6d61 736b 2e20 5468 6520 6f75   or mask. The ou
-0001f050: 7470 7574 0a20 2020 2020 2020 2020 2020  tput.           
-0001f060: 2069 7320 6120 6469 6374 696f 6e61 7279   is a dictionary
-0001f070: 2077 6865 7265 2065 6163 6820 6b65 7920   where each key 
-0001f080: 6861 7320 7468 6520 666f 726d 6174 3a0a  has the format:.
-0001f090: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f0a0: 2020 2020 2020 2020 2020 2020 287a 2c20              (z, 
-0001f0b0: 792c 2078 290a 2020 2020 2020 2020 2020  y, x).          
-0001f0c0: 2020 7768 6572 6520 7a2c 2079 2c20 7820    where z, y, x 
-0001f0d0: 6973 2061 2033 442d 696e 6465 7820 6672  is a 3D-index fr
-0001f0e0: 6f6d 2074 6865 2068 616c 6620 6d61 7073  om the half maps
-0001f0f0: 2c20 616e 6420 7468 650a 2020 2020 2020  , and the.      
-0001f100: 2020 2020 2020 7661 6c75 6520 6973 2074        value is t
-0001f110: 6865 206c 6f63 616c 2072 6573 6f6c 7574  he local resolut
-0001f120: 696f 6e20 2869 6e20 616e 6773 7472 6f6d  ion (in angstrom
-0001f130: 7329 2e0a 2020 2020 2020 2020 2222 220a  s)..        """.
-0001f140: 2020 2020 2020 2020 7072 696e 7428 6622          print(f"
-0001f150: 4361 6c63 756c 6174 696e 6720 4c6f 6361  Calculating Loca
-0001f160: 6c20 5265 736f 6c75 7469 6f6e 2066 6f72  l Resolution for
-0001f170: 2068 616c 6620 6d61 703a 220a 2020 2020   half map:".    
-0001f180: 2020 2020 2020 2020 2020 6622 7b68 616c            f"{hal
-0001f190: 665f 6d61 705f 312e 6669 6c65 6e61 6d65  f_map_1.filename
-0001f1a0: 7d20 616e 6420 6d61 7020 7b68 616c 665f  } and map {half_
-0001f1b0: 6d61 705f 322e 6669 6c65 6e61 6d65 7d22  map_2.filename}"
-0001f1c0: 290a 0a20 2020 2020 2020 2023 2073 6574  )..        # set
-0001f1d0: 2075 7020 736f 6d65 2073 7475 6666 0a20   up some stuff. 
-0001f1e0: 2020 2020 2020 2061 7069 7820 3d20 6e70         apix = np
-0001f1f0: 2e61 7272 6179 2868 616c 665f 6d61 705f  .array(half_map_
-0001f200: 312e 6170 6978 295b 305d 0a20 2020 2020  1.apix)[0].     
-0001f210: 2020 206d 6170 5f72 6573 203d 2073 656c     map_res = sel
-0001f220: 662e 6d61 705f 7265 736f 6c75 7469 6f6e  f.map_resolution
-0001f230: 5f46 5343 2868 616c 665f 6d61 705f 312c  _FSC(half_map_1,
-0001f240: 2068 616c 665f 6d61 705f 3229 0a20 2020   half_map_2).   
-0001f250: 2020 2020 2062 6c75 7272 6572 203d 2053       blurrer = S
-0001f260: 7472 7563 7475 7265 426c 7572 7265 7228  tructureBlurrer(
-0001f270: 290a 0a20 2020 2020 2020 2023 2061 7070  )..        # app
-0001f280: 726f 7869 6d61 7465 206d 6173 6b20 7370  roximate mask sp
-0001f290: 6865 7265 2064 6961 6d65 7465 720a 2020  here diameter.  
-0001f2a0: 2020 2020 2020 7370 6865 7265 5f64 6961        sphere_dia
-0001f2b0: 6d65 7465 725f 616e 6773 7472 6f6d 7320  meter_angstroms 
-0001f2c0: 3d20 6d61 705f 7265 7320 2a20 370a 2020  = map_res * 7.  
-0001f2d0: 2020 2020 2020 7370 6865 7265 5f64 6961        sphere_dia
-0001f2e0: 6d65 7465 725f 7069 7865 6c73 203d 2069  meter_pixels = i
-0001f2f0: 6e74 2873 7068 6572 655f 6469 616d 6574  nt(sphere_diamet
-0001f300: 6572 5f61 6e67 7374 726f 6d73 2f61 7069  er_angstroms/api
-0001f310: 7829 0a0a 2020 2020 2020 2020 2320 656e  x)..        # en
-0001f320: 7375 7265 2074 6861 7420 7061 7261 6d65  sure that parame
-0001f330: 7465 7273 2061 7265 2073 656e 7369 626c  ters are sensibl
-0001f340: 6520 692e 652e 206e 6f74 2061 2031 2070  e i.e. not a 1 p
-0001f350: 6978 656c 2077 6964 6520 6d61 736b 0a20  ixel wide mask. 
-0001f360: 2020 2020 2020 2069 6620 7370 6865 7265         if sphere
-0001f370: 5f64 6961 6d65 7465 725f 7069 7865 6c73  _diameter_pixels
-0001f380: 203c 2036 3a0a 2020 2020 2020 2020 2020   < 6:.          
-0001f390: 2020 7370 6865 7265 5f64 6961 6d65 7465    sphere_diamete
-0001f3a0: 725f 7069 7865 6c73 203d 2036 0a20 2020  r_pixels = 6.   
-0001f3b0: 2020 2020 2063 6f73 5f65 6467 6520 3d20       cos_edge = 
-0001f3c0: 696e 7428 726f 756e 6428 7370 6865 7265  int(round(sphere
-0001f3d0: 5f64 6961 6d65 7465 725f 7069 7865 6c73  _diameter_pixels
-0001f3e0: 202f 2033 2929 0a20 2020 2020 2020 2069   / 3)).        i
-0001f3f0: 6620 636f 735f 6564 6765 203c 2031 303a  f cos_edge < 10:
-0001f400: 0a20 2020 2020 2020 2020 2020 2063 6f73  .            cos
-0001f410: 5f65 6467 6520 3d20 3130 0a0a 2020 2020  _edge = 10..    
-0001f420: 2020 2020 2320 6765 7420 616e 2061 7070      # get an app
-0001f430: 726f 7072 6961 7465 2062 6f78 2073 697a  ropriate box siz
-0001f440: 6520 746f 2063 726f 7020 6672 6f6d 206d  e to crop from m
-0001f450: 6169 6e20 6d61 700a 2020 2020 2020 2020  ain map.        
-0001f460: 2320 7769 6c6c 2062 6520 325e 6e2c 2033  # will be 2^n, 3
-0001f470: 5e6e 206f 7220 355e 6e20 7369 7a65 2077  ^n or 5^n size w
-0001f480: 6865 7265 206e 2069 7320 7468 6520 6e75  here n is the nu
-0001f490: 6d62 6572 2072 6571 7569 7265 6420 666f  mber required fo
-0001f4a0: 720a 2020 2020 2020 2020 2320 7468 6520  r.        # the 
-0001f4b0: 6d69 6e69 6d75 6d20 626f 7820 7369 7a65  minimum box size
-0001f4c0: 206e 6565 6465 6420 746f 2065 6e63 6f6d   needed to encom
-0001f4d0: 7061 7373 2065 6e74 6972 6520 6d61 736b  pass entire mask
-0001f4e0: 2069 6e20 626f 780a 2020 2020 2020 2020   in box.        
-0001f4f0: 6d61 736b 5f64 696d 7320 3d20 666f 7572  mask_dims = four
-0001f500: 6965 722e 6765 745f 6666 745f 6f70 7469  ier.get_fft_opti
-0001f510: 6d69 7365 645f 626f 785f 7369 7a65 280a  mised_box_size(.
-0001f520: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f530: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f540: 2020 2020 7370 6865 7265 5f64 6961 6d65      sphere_diame
-0001f550: 7465 725f 7069 7865 6c73 202b 2028 636f  ter_pixels + (co
-0001f560: 735f 6564 6765 202a 2032 292c 0a20 2020  s_edge * 2),.   
-0001f570: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f580: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f590: 2068 616c 665f 6d61 705f 312e 6675 6c6c   half_map_1.full
-0001f5a0: 4d61 702e 7368 6170 652c 0a20 2020 2020  Map.shape,.     
-0001f5b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f5c0: 2020 2020 2020 2020 2020 2020 2020 2029                 )
-0001f5d0: 0a0a 2020 2020 2020 2020 6966 206d 6173  ..        if mas
-0001f5e0: 6b5f 6469 6d73 203d 3d20 5b30 2c20 302c  k_dims == [0, 0,
-0001f5f0: 2030 5d3a 0a20 2020 2020 2020 2020 2020   0]:.           
-0001f600: 206d 6173 6b20 3d20 4d61 7028 6e70 2e6f   mask = Map(np.o
-0001f610: 6e65 7328 6861 6c66 5f6d 6170 5f31 2e66  nes(half_map_1.f
-0001f620: 756c 6c4d 6170 2e73 6861 7065 292c 2068  ullMap.shape), h
-0001f630: 616c 665f 6d61 705f 312e 6f72 6967 696e  alf_map_1.origin
-0001f640: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0001f650: 2020 2020 2020 2020 2068 616c 665f 6d61           half_ma
-0001f660: 705f 312e 6170 6978 2c20 6861 6c66 5f6d  p_1.apix, half_m
-0001f670: 6170 5f31 2e66 696c 656e 616d 6529 0a20  ap_1.filename). 
-0001f680: 2020 2020 2020 2020 2020 206d 6173 6b5f             mask_
-0001f690: 6469 6d73 203d 206d 6173 6b2e 6675 6c6c  dims = mask.full
-0001f6a0: 4d61 702e 7368 6170 650a 2020 2020 2020  Map.shape.      
-0001f6b0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-0001f6c0: 2020 2020 6365 6e74 7265 5f6f 665f 6d61      centre_of_ma
-0001f6d0: 736b 5f6d 6170 203d 205b 6d61 736b 5f64  sk_map = [mask_d
-0001f6e0: 696d 735b 305d 2f32 2c20 6d61 736b 5f64  ims[0]/2, mask_d
-0001f6f0: 696d 735b 315d 2f32 2c0a 2020 2020 2020  ims[1]/2,.      
-0001f700: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f710: 2020 2020 2020 2020 2020 2020 6d61 736b              mask
-0001f720: 5f64 696d 735b 325d 2f32 5d0a 2020 2020  _dims[2]/2].    
-0001f730: 2020 2020 2020 2020 6d61 736b 203d 2062          mask = b
-0001f740: 6c75 7272 6572 2e6d 616b 655f 7370 6865  lurrer.make_sphe
-0001f750: 7269 6361 6c5f 6d61 736b 2873 7068 6572  rical_mask(spher
-0001f760: 655f 6469 616d 6574 6572 5f70 6978 656c  e_diameter_pixel
-0001f770: 732c 0a20 2020 2020 2020 2020 2020 2020  s,.             
-0001f780: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f790: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f7a0: 2020 6d61 736b 5f64 696d 732c 2063 656e    mask_dims, cen
-0001f7b0: 7472 655f 6f66 5f6d 6173 6b5f 6d61 702c  tre_of_mask_map,
-0001f7c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001f7d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f7e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f7f0: 636f 735f 6564 6765 290a 0a20 2020 2020  cos_edge)..     
-0001f800: 2020 2023 2073 6176 6520 7363 6f72 6573     # save scores
-0001f810: 2066 6f72 2065 6163 6820 6368 6169 6e20   for each chain 
-0001f820: 616e 6420 7265 730a 2020 2020 2020 2020  and res.        
-0001f830: 6469 6374 5f72 6573 5f73 636f 7265 7320  dict_res_scores 
-0001f840: 3d20 4f72 6465 7265 6444 6963 7428 290a  = OrderedDict().
-0001f850: 0a20 2020 2020 2020 2023 2073 6574 2075  .        # set u
-0001f860: 7020 7079 6666 7477 2066 6f72 2076 6572  p pyfftw for ver
-0001f870: 7920 6661 7374 2066 6674 730a 2020 2020  y fast ffts.    
-0001f880: 2020 2020 696e 7075 7431 203d 2070 7966      input1 = pyf
-0001f890: 6674 772e 656d 7074 795f 616c 6967 6e65  ftw.empty_aligne
-0001f8a0: 6428 6d61 736b 5f64 696d 732c 2064 7479  d(mask_dims, dty
-0001f8b0: 7065 3d27 666c 6f61 7436 3427 290a 0a20  pe='float64').. 
-0001f8c0: 2020 2020 2020 2066 6674 775f 6f62 6a65         fftw_obje
-0001f8d0: 6374 3120 3d20 666f 7572 6965 722e 6765  ct1 = fourier.ge
-0001f8e0: 745f 7079 6666 7477 5f6f 626a 6563 7428  t_pyfftw_object(
-0001f8f0: 6d61 736b 5f64 696d 7329 0a20 2020 2020  mask_dims).     
-0001f900: 2020 2066 6674 775f 6f62 6a65 6374 3220     fftw_object2 
-0001f910: 3d20 666f 7572 6965 722e 6765 745f 7079  = fourier.get_py
-0001f920: 6666 7477 5f6f 626a 6563 7428 6d61 736b  fftw_object(mask
-0001f930: 5f64 696d 7329 0a0a 2020 2020 2020 2020  _dims)..        
-0001f940: 7162 696e 732c 206c 6162 656c 6c65 645f  qbins, labelled_
-0001f950: 7368 656c 6c73 203d 2066 6f75 7269 6572  shells = fourier
-0001f960: 2e67 6574 5f6c 6162 656c 6c65 645f 7368  .get_labelled_sh
-0001f970: 656c 6c73 280a 2020 2020 2020 2020 2020  ells(.          
-0001f980: 2020 696e 7075 7431 2e73 6861 7065 290a    input1.shape).
-0001f990: 0a20 2020 2020 2020 2023 2067 6574 2063  .        # get c
-0001f9a0: 6f6f 7264 696e 6174 6573 2077 6865 7265  oordinates where
-0001f9b0: 206c 6f63 616c 2046 5343 2073 686f 756c   local FSC shoul
-0001f9c0: 6420 6265 2063 616c 6375 6c61 7465 640a  d be calculated.
-0001f9d0: 2020 2020 2020 2020 6966 2073 7472 7563          if struc
-0001f9e0: 7475 7265 2069 7320 6e6f 7420 4e6f 6e65  ture is not None
-0001f9f0: 3a0a 2020 2020 2020 2020 2020 2020 636f  :.            co
-0001fa00: 6f72 6469 6e61 7465 7320 3d20 7374 7275  ordinates = stru
-0001fa10: 6374 7572 652e 6765 745f 4341 6f6e 6c79  cture.get_CAonly
-0001fa20: 2829 2e67 6574 5f61 746f 6d5f 7a79 785f  ().get_atom_zyx_
-0001fa30: 6d61 705f 696e 6465 7865 7328 0a20 2020  map_indexes(.   
-0001fa40: 2020 2020 2020 2020 2020 2020 2068 616c               hal
-0001fa50: 665f 6d61 705f 3129 0a20 2020 2020 2020  f_map_1).       
-0001fa60: 2065 6c69 6620 7072 6f74 6569 6e5f 6d61   elif protein_ma
-0001fa70: 736b 2069 7320 6e6f 7420 4e6f 6e65 3a0a  sk is not None:.
-0001fa80: 2020 2020 2020 2020 2020 2020 287a 2c20              (z, 
-0001fa90: 792c 2078 2920 3d20 6e70 2e77 6865 7265  y, x) = np.where
-0001faa0: 2870 726f 7465 696e 5f6d 6173 6b2e 6675  (protein_mask.fu
-0001fab0: 6c6c 4d61 7020 3e20 3029 0a20 2020 2020  llMap > 0).     
-0001fac0: 2020 2020 2020 2063 6f6f 7264 696e 6174         coordinat
-0001fad0: 6573 203d 206e 702e 7374 6163 6b28 287a  es = np.stack((z
-0001fae0: 2c20 792c 2078 292c 2061 7869 733d 2d31  , y, x), axis=-1
-0001faf0: 290a 2020 2020 2020 2020 656c 7365 3a0a  ).        else:.
-0001fb00: 2020 2020 2020 2020 2020 2020 287a 2c20              (z, 
-0001fb10: 792c 2078 2920 3d20 6e70 2e77 6865 7265  y, x) = np.where
-0001fb20: 2868 616c 665f 6d61 705f 312e 6675 6c6c  (half_map_1.full
-0001fb30: 4d61 7020 3c20 6e70 2e69 6e66 290a 2020  Map < np.inf).  
-0001fb40: 2020 2020 2020 2020 2020 636f 6f72 6469            coordi
-0001fb50: 6e61 7465 7320 3d20 6e70 2e73 7461 636b  nates = np.stack
-0001fb60: 2828 7a2c 2079 2c20 7829 2c20 6178 6973  ((z, y, x), axis
-0001fb70: 3d2d 3129 0a0a 2020 2020 2020 2020 7761  =-1)..        wa
-0001fb80: 726e 696e 6773 203d 205b 5d0a 2020 2020  rnings = [].    
-0001fb90: 2020 2020 6e20 3d20 300a 0a20 2020 2020      n = 0..     
-0001fba0: 2020 2066 6f72 2063 6f6f 7264 696e 6174     for coordinat
-0001fbb0: 6520 696e 2063 6f6f 7264 696e 6174 6573  e in coordinates
-0001fbc0: 3a0a 0a20 2020 2020 2020 2020 2020 2063  :..            c
-0001fbd0: 726f 7070 6564 5f6d 6170 5f31 203d 2068  ropped_map_1 = h
-0001fbe0: 616c 665f 6d61 705f 312e 6765 745f 6372  alf_map_1.get_cr
-0001fbf0: 6f70 7065 645f 626f 7828 0a20 2020 2020  opped_box(.     
-0001fc00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001fc10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001fc20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001fc30: 2020 2063 6f6f 7264 696e 6174 652c 0a20     coordinate,. 
-0001fc40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001fc50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001fc60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001fc70: 2020 2020 2020 206d 6173 6b5f 6469 6d73         mask_dims
-0001fc80: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0001fc90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001fca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001fcb0: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
-0001fcc0: 2020 2020 2020 2020 6372 6f70 7065 645f          cropped_
-0001fcd0: 6d61 705f 3220 3d20 6861 6c66 5f6d 6170  map_2 = half_map
-0001fce0: 5f32 2e67 6574 5f63 726f 7070 6564 5f62  _2.get_cropped_b
-0001fcf0: 6f78 280a 2020 2020 2020 2020 2020 2020  ox(.            
-0001fd00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001fd10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001fd20: 2020 2020 2020 2020 636f 6f72 6469 6e61          coordina
-0001fd30: 7465 2c0a 2020 2020 2020 2020 2020 2020  te,.            
-0001fd40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001fd50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001fd60: 2020 2020 2020 2020 6d61 736b 5f64 696d          mask_dim
-0001fd70: 732c 0a20 2020 2020 2020 2020 2020 2020  s,.             
+0001ec10: 2020 2020 6622 2f7b 6e75 6d62 6572 5f6f      f"/{number_o
+0001ec20: 665f 7265 7369 6475 6573 7d22 2c20 7365  f_residues}", se
+0001ec30: 703d 2727 2c20 656e 643d 2727 2c20 666c  p='', end='', fl
+0001ec40: 7573 683d 5472 7565 290a 0a20 2020 2020  ush=True)..     
+0001ec50: 2020 2069 6620 7665 7262 6f73 653a 0a20     if verbose:. 
+0001ec60: 2020 2020 2020 2020 2020 2070 7269 6e74             print
+0001ec70: 2822 2229 0a20 2020 2020 2020 2020 2020  ("").           
+0001ec80: 2066 6f72 2077 6172 6e69 6e67 2069 6e20   for warning in 
+0001ec90: 7761 726e 696e 6773 3a0a 2020 2020 2020  warnings:.      
+0001eca0: 2020 2020 2020 2020 2020 7072 696e 7428            print(
+0001ecb0: 7761 726e 696e 6729 0a0a 2020 2020 2020  warning)..      
+0001ecc0: 2020 7265 7475 726e 2064 6963 745f 7265    return dict_re
+0001ecd0: 735f 7363 6f72 6573 0a0a 2020 2020 6465  s_scores..    de
+0001ece0: 6620 6d61 705f 6c6f 6361 6c5f 7265 736f  f map_local_reso
+0001ecf0: 6c75 7469 6f6e 280a 2020 2020 2020 2020  lution(.        
+0001ed00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ed10: 2020 2020 7365 6c66 2c0a 2020 2020 2020      self,.      
+0001ed20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ed30: 2020 2020 2020 6861 6c66 5f6d 6170 5f31        half_map_1
+0001ed40: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0001ed50: 2020 2020 2020 2020 2020 2020 2020 6861                ha
+0001ed60: 6c66 5f6d 6170 5f32 2c0a 2020 2020 2020  lf_map_2,.      
+0001ed70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ed80: 2020 2020 2020 7374 7275 6374 7572 653d        structure=
+0001ed90: 4e6f 6e65 2c0a 2020 2020 2020 2020 2020  None,.          
+0001eda0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001edb0: 2020 7072 6f74 6569 6e5f 6d61 736b 3d4e    protein_mask=N
+0001edc0: 6f6e 652c 0a20 2020 2020 2020 2020 2020  one,.           
+0001edd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ede0: 2076 6572 626f 7365 3d54 7275 652c 0a20   verbose=True,. 
+0001edf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ee00: 2020 2020 2020 2020 2020 2066 7363 5f74             fsc_t
+0001ee10: 6872 6573 686f 6c64 3d30 2e35 2c0a 2020  hreshold=0.5,.  
+0001ee20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ee30: 2020 2020 2020 2020 2020 293a 0a20 2020            ):.   
+0001ee40: 2020 2020 2022 2222 4361 6c63 756c 6174       """Calculat
+0001ee50: 6520 7468 6520 6c6f 6361 6c20 7265 736f  e the local reso
+0001ee60: 6c75 7469 6f6e 2075 7369 6e67 2074 6865  lution using the
+0001ee70: 206c 6f63 616c 2046 5343 206d 6574 686f   local FSC metho
+0001ee80: 642e 0a0a 2020 2020 2020 2020 4172 6775  d...        Argu
+0001ee90: 6d65 6e74 733a 0a20 2020 2020 2020 2020  ments:.         
+0001eea0: 2020 2068 616c 665f 6d61 705f 313a 2041     half_map_1: A
+0001eeb0: 206d 6170 2069 6e73 7461 6e63 6520 6f66   map instance of
+0001eec0: 2074 6865 2066 6972 7374 2068 616c 662d   the first half-
+0001eed0: 6d61 702e 0a20 2020 2020 2020 2020 2020  map..           
+0001eee0: 2068 616c 665f 6d61 705f 323a 2041 206d   half_map_2: A m
+0001eef0: 6170 2069 6e73 7461 6e63 6520 6f66 2074  ap instance of t
+0001ef00: 6865 2073 6563 6f6e 6420 6861 6c66 206d  he second half m
+0001ef10: 6170 2e0a 2020 2020 2020 2020 2020 2020  ap..            
+0001ef20: 7374 7275 6374 7572 653a 204d 6f64 656c  structure: Model
+0001ef30: 2073 7472 7563 7475 7265 2069 6e73 7461   structure insta
+0001ef40: 6e63 652e 2049 6620 6465 6669 6e65 642c  nce. If defined,
+0001ef50: 2074 6865 0a20 2020 2020 2020 2020 2020   the.           
+0001ef60: 2020 2020 206c 6f63 616c 2072 6573 6f6c       local resol
+0001ef70: 7574 696f 6e20 6973 2063 616c 6375 6c61  ution is calcula
+0001ef80: 7465 6420 6174 2074 6865 2043 4120 6174  ted at the CA at
+0001ef90: 6f6d 0a20 2020 2020 2020 2020 2020 2020  om.             
+0001efa0: 2020 2066 6f72 2065 6163 6820 7265 7369     for each resi
+0001efb0: 6475 6520 696e 2074 6865 2073 7472 7563  due in the struc
+0001efc0: 7475 7265 206f 6e6c 792e 0a20 2020 2020  ture only..     
+0001efd0: 2020 2020 2020 2070 726f 7465 696e 5f6d         protein_m
+0001efe0: 6173 6b3a 2041 204d 6170 2069 6e73 7461  ask: A Map insta
+0001eff0: 6e63 6520 6f66 2061 206d 6173 6b2e 2049  nce of a mask. I
+0001f000: 6620 6465 6669 6e65 642c 2074 6865 0a20  f defined, the. 
+0001f010: 2020 2020 2020 2020 2020 2020 2020 206c                 l
+0001f020: 6f63 616c 2072 6573 6f6c 7574 696f 6e20  ocal resolution 
+0001f030: 6973 2063 616c 6375 6c61 7465 6420 6174  is calculated at
+0001f040: 2065 6163 6820 706f 696e 7420 7769 7468   each point with
+0001f050: 696e 0a20 2020 2020 2020 2020 2020 2020  in.             
+0001f060: 2020 2074 6865 206d 6173 6b20 6f6e 6c79     the mask only
+0001f070: 2e0a 2020 2020 2020 2020 2020 2020 7665  ..            ve
+0001f080: 7262 6f73 653a 2049 6620 5472 7565 2c20  rbose: If True, 
+0001f090: 7072 696e 7473 2061 2070 726f 6772 6573  prints a progres
+0001f0a0: 7320 6261 7220 616e 6420 7761 726e 696e  s bar and warnin
+0001f0b0: 6773 0a20 2020 2020 2020 2020 2020 2066  gs.            f
+0001f0c0: 7363 5f74 6872 6573 686f 6c64 3a20 436f  sc_threshold: Co
+0001f0d0: 7272 656c 6174 696f 6e20 7468 7265 7368  rrelation thresh
+0001f0e0: 6f6c 6420 7661 6c75 6520 7468 6174 2064  old value that d
+0001f0f0: 6566 696e 6573 0a20 2020 2020 2020 2020  efines.         
+0001f100: 2020 2020 2020 2068 6f77 2074 6865 206d         how the m
+0001f110: 6170 2072 6573 6f6c 7574 696f 6e20 6973  ap resolution is
+0001f120: 2066 6f75 6e64 2e0a 0a20 2020 2020 2020   found...       
+0001f130: 2052 6574 7572 6e73 3a0a 2020 2020 2020   Returns:.      
+0001f140: 2020 2020 2020 5468 6520 6c6f 6361 6c20        The local 
+0001f150: 7265 736f 6c75 7469 6f6e 2061 7420 6561  resolution at ea
+0001f160: 6368 2070 6f73 6974 696f 6e20 696e 2074  ch position in t
+0001f170: 6865 206d 6170 2c20 6f72 2061 730a 2020  he map, or as.  
+0001f180: 2020 2020 2020 2020 2020 6465 6669 6e65            define
+0001f190: 6420 6279 2074 6865 2073 7472 7563 7475  d by the structu
+0001f1a0: 7265 2069 6e73 7461 6e63 6520 6f72 206d  re instance or m
+0001f1b0: 6173 6b2e 2054 6865 206f 7574 7075 740a  ask. The output.
+0001f1c0: 2020 2020 2020 2020 2020 2020 6973 2061              is a
+0001f1d0: 2064 6963 7469 6f6e 6172 7920 7768 6572   dictionary wher
+0001f1e0: 6520 6561 6368 206b 6579 2068 6173 2074  e each key has t
+0001f1f0: 6865 2066 6f72 6d61 743a 0a20 2020 2020  he format:.     
+0001f200: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001f210: 2020 2020 2020 2028 7a2c 2079 2c20 7829         (z, y, x)
+0001f220: 0a20 2020 2020 2020 2020 2020 2077 6865  .            whe
+0001f230: 7265 207a 2c20 792c 2078 2069 7320 6120  re z, y, x is a 
+0001f240: 3344 2d69 6e64 6578 2066 726f 6d20 7468  3D-index from th
+0001f250: 6520 6861 6c66 206d 6170 732c 2061 6e64  e half maps, and
+0001f260: 2074 6865 0a20 2020 2020 2020 2020 2020   the.           
+0001f270: 2076 616c 7565 2069 7320 7468 6520 6c6f   value is the lo
+0001f280: 6361 6c20 7265 736f 6c75 7469 6f6e 2028  cal resolution (
+0001f290: 696e 2061 6e67 7374 726f 6d73 292e 0a20  in angstroms).. 
+0001f2a0: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
+0001f2b0: 2020 2070 7269 6e74 2866 2243 616c 6375     print(f"Calcu
+0001f2c0: 6c61 7469 6e67 204c 6f63 616c 2052 6573  lating Local Res
+0001f2d0: 6f6c 7574 696f 6e20 666f 7220 6861 6c66  olution for half
+0001f2e0: 206d 6170 3a22 0a20 2020 2020 2020 2020   map:".         
+0001f2f0: 2020 2020 2066 227b 6861 6c66 5f6d 6170       f"{half_map
+0001f300: 5f31 2e66 696c 656e 616d 657d 2061 6e64  _1.filename} and
+0001f310: 206d 6170 207b 6861 6c66 5f6d 6170 5f32   map {half_map_2
+0001f320: 2e66 696c 656e 616d 657d 2229 0a0a 2020  .filename}")..  
+0001f330: 2020 2020 2020 2320 7365 7420 7570 2073        # set up s
+0001f340: 6f6d 6520 7374 7566 660a 2020 2020 2020  ome stuff.      
+0001f350: 2020 6170 6978 203d 206e 702e 6172 7261    apix = np.arra
+0001f360: 7928 6861 6c66 5f6d 6170 5f31 2e61 7069  y(half_map_1.api
+0001f370: 7829 5b30 5d0a 2020 2020 2020 2020 6d61  x)[0].        ma
+0001f380: 705f 7265 7320 3d20 7365 6c66 2e6d 6170  p_res = self.map
+0001f390: 5f72 6573 6f6c 7574 696f 6e5f 4653 4328  _resolution_FSC(
+0001f3a0: 6861 6c66 5f6d 6170 5f31 2c20 6861 6c66  half_map_1, half
+0001f3b0: 5f6d 6170 5f32 290a 2020 2020 2020 2020  _map_2).        
+0001f3c0: 626c 7572 7265 7220 3d20 5374 7275 6374  blurrer = Struct
+0001f3d0: 7572 6542 6c75 7272 6572 2829 0a0a 2020  ureBlurrer()..  
+0001f3e0: 2020 2020 2020 2320 6170 7072 6f78 696d        # approxim
+0001f3f0: 6174 6520 6d61 736b 2073 7068 6572 6520  ate mask sphere 
+0001f400: 6469 616d 6574 6572 0a20 2020 2020 2020  diameter.       
+0001f410: 2073 7068 6572 655f 6469 616d 6574 6572   sphere_diameter
+0001f420: 5f61 6e67 7374 726f 6d73 203d 206d 6170  _angstroms = map
+0001f430: 5f72 6573 202a 2037 0a20 2020 2020 2020  _res * 7.       
+0001f440: 2073 7068 6572 655f 6469 616d 6574 6572   sphere_diameter
+0001f450: 5f70 6978 656c 7320 3d20 696e 7428 7370  _pixels = int(sp
+0001f460: 6865 7265 5f64 6961 6d65 7465 725f 616e  here_diameter_an
+0001f470: 6773 7472 6f6d 732f 6170 6978 290a 0a20  gstroms/apix).. 
+0001f480: 2020 2020 2020 2023 2065 6e73 7572 6520         # ensure 
+0001f490: 7468 6174 2070 6172 616d 6574 6572 7320  that parameters 
+0001f4a0: 6172 6520 7365 6e73 6962 6c65 2069 2e65  are sensible i.e
+0001f4b0: 2e20 6e6f 7420 6120 3120 7069 7865 6c20  . not a 1 pixel 
+0001f4c0: 7769 6465 206d 6173 6b0a 2020 2020 2020  wide mask.      
+0001f4d0: 2020 6966 2073 7068 6572 655f 6469 616d    if sphere_diam
+0001f4e0: 6574 6572 5f70 6978 656c 7320 3c20 363a  eter_pixels < 6:
+0001f4f0: 0a20 2020 2020 2020 2020 2020 2073 7068  .            sph
+0001f500: 6572 655f 6469 616d 6574 6572 5f70 6978  ere_diameter_pix
+0001f510: 656c 7320 3d20 360a 2020 2020 2020 2020  els = 6.        
+0001f520: 636f 735f 6564 6765 203d 2069 6e74 2872  cos_edge = int(r
+0001f530: 6f75 6e64 2873 7068 6572 655f 6469 616d  ound(sphere_diam
+0001f540: 6574 6572 5f70 6978 656c 7320 2f20 3329  eter_pixels / 3)
+0001f550: 290a 2020 2020 2020 2020 6966 2063 6f73  ).        if cos
+0001f560: 5f65 6467 6520 3c20 3130 3a0a 2020 2020  _edge < 10:.    
+0001f570: 2020 2020 2020 2020 636f 735f 6564 6765          cos_edge
+0001f580: 203d 2031 300a 0a20 2020 2020 2020 2023   = 10..        #
+0001f590: 2067 6574 2061 6e20 6170 7072 6f70 7269   get an appropri
+0001f5a0: 6174 6520 626f 7820 7369 7a65 2074 6f20  ate box size to 
+0001f5b0: 6372 6f70 2066 726f 6d20 6d61 696e 206d  crop from main m
+0001f5c0: 6170 0a20 2020 2020 2020 2023 2077 696c  ap.        # wil
+0001f5d0: 6c20 6265 2032 5e6e 2c20 335e 6e20 6f72  l be 2^n, 3^n or
+0001f5e0: 2035 5e6e 2073 697a 6520 7768 6572 6520   5^n size where 
+0001f5f0: 6e20 6973 2074 6865 206e 756d 6265 7220  n is the number 
+0001f600: 7265 7175 6972 6564 2066 6f72 0a20 2020  required for.   
+0001f610: 2020 2020 2023 2074 6865 206d 696e 696d       # the minim
+0001f620: 756d 2062 6f78 2073 697a 6520 6e65 6564  um box size need
+0001f630: 6564 2074 6f20 656e 636f 6d70 6173 7320  ed to encompass 
+0001f640: 656e 7469 7265 206d 6173 6b20 696e 2062  entire mask in b
+0001f650: 6f78 0a20 2020 2020 2020 206d 6173 6b5f  ox.        mask_
+0001f660: 6469 6d73 203d 2066 6f75 7269 6572 2e67  dims = fourier.g
+0001f670: 6574 5f66 6674 5f6f 7074 696d 6973 6564  et_fft_optimised
+0001f680: 5f62 6f78 5f73 697a 6528 0a20 2020 2020  _box_size(.     
+0001f690: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001f6a0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+0001f6b0: 7068 6572 655f 6469 616d 6574 6572 5f70  phere_diameter_p
+0001f6c0: 6978 656c 7320 2b20 2863 6f73 5f65 6467  ixels + (cos_edg
+0001f6d0: 6520 2a20 3229 2c0a 2020 2020 2020 2020  e * 2),.        
+0001f6e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001f6f0: 2020 2020 2020 2020 2020 2020 6861 6c66              half
+0001f700: 5f6d 6170 5f31 2e66 756c 6c4d 6170 2e73  _map_1.fullMap.s
+0001f710: 6861 7065 2c0a 2020 2020 2020 2020 2020  hape,.          
+0001f720: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001f730: 2020 2020 2020 2020 2020 290a 0a20 2020            )..   
+0001f740: 2020 2020 2069 6620 6d61 736b 5f64 696d       if mask_dim
+0001f750: 7320 3d3d 205b 302c 2030 2c20 305d 3a0a  s == [0, 0, 0]:.
+0001f760: 2020 2020 2020 2020 2020 2020 6d61 736b              mask
+0001f770: 203d 204d 6170 286e 702e 6f6e 6573 2868   = Map(np.ones(h
+0001f780: 616c 665f 6d61 705f 312e 6675 6c6c 4d61  alf_map_1.fullMa
+0001f790: 702e 7368 6170 6529 2c20 6861 6c66 5f6d  p.shape), half_m
+0001f7a0: 6170 5f31 2e6f 7269 6769 6e2c 0a20 2020  ap_1.origin,.   
+0001f7b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001f7c0: 2020 2020 6861 6c66 5f6d 6170 5f31 2e61      half_map_1.a
+0001f7d0: 7069 782c 2068 616c 665f 6d61 705f 312e  pix, half_map_1.
+0001f7e0: 6669 6c65 6e61 6d65 290a 2020 2020 2020  filename).      
+0001f7f0: 2020 2020 2020 6d61 736b 5f64 696d 7320        mask_dims 
+0001f800: 3d20 6d61 736b 2e66 756c 6c4d 6170 2e73  = mask.fullMap.s
+0001f810: 6861 7065 0a20 2020 2020 2020 2065 6c73  hape.        els
+0001f820: 653a 0a20 2020 2020 2020 2020 2020 2063  e:.            c
+0001f830: 656e 7472 655f 6f66 5f6d 6173 6b5f 6d61  entre_of_mask_ma
+0001f840: 7020 3d20 5b6d 6173 6b5f 6469 6d73 5b30  p = [mask_dims[0
+0001f850: 5d2f 322c 206d 6173 6b5f 6469 6d73 5b31  ]/2, mask_dims[1
+0001f860: 5d2f 322c 0a20 2020 2020 2020 2020 2020  ]/2,.           
+0001f870: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001f880: 2020 2020 2020 206d 6173 6b5f 6469 6d73         mask_dims
+0001f890: 5b32 5d2f 325d 0a20 2020 2020 2020 2020  [2]/2].         
+0001f8a0: 2020 206d 6173 6b20 3d20 626c 7572 7265     mask = blurre
+0001f8b0: 722e 6d61 6b65 5f73 7068 6572 6963 616c  r.make_spherical
+0001f8c0: 5f6d 6173 6b28 7370 6865 7265 5f64 6961  _mask(sphere_dia
+0001f8d0: 6d65 7465 725f 7069 7865 6c73 2c0a 2020  meter_pixels,.  
+0001f8e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001f8f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001f900: 2020 2020 2020 2020 2020 2020 206d 6173               mas
+0001f910: 6b5f 6469 6d73 2c20 6365 6e74 7265 5f6f  k_dims, centre_o
+0001f920: 665f 6d61 736b 5f6d 6170 2c0a 2020 2020  f_mask_map,.    
+0001f930: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001f940: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001f950: 2020 2020 2020 2020 2020 2063 6f73 5f65             cos_e
+0001f960: 6467 6529 0a0a 2020 2020 2020 2020 2320  dge)..        # 
+0001f970: 7361 7665 2073 636f 7265 7320 666f 7220  save scores for 
+0001f980: 6561 6368 2063 6861 696e 2061 6e64 2072  each chain and r
+0001f990: 6573 0a20 2020 2020 2020 2064 6963 745f  es.        dict_
+0001f9a0: 7265 735f 7363 6f72 6573 203d 204f 7264  res_scores = Ord
+0001f9b0: 6572 6564 4469 6374 2829 0a0a 2020 2020  eredDict()..    
+0001f9c0: 2020 2020 2320 7365 7420 7570 2070 7966      # set up pyf
+0001f9d0: 6674 7720 666f 7220 7665 7279 2066 6173  ftw for very fas
+0001f9e0: 7420 6666 7473 0a20 2020 2020 2020 2069  t ffts.        i
+0001f9f0: 6e70 7574 3120 3d20 7079 6666 7477 2e65  nput1 = pyfftw.e
+0001fa00: 6d70 7479 5f61 6c69 676e 6564 286d 6173  mpty_aligned(mas
+0001fa10: 6b5f 6469 6d73 2c20 6474 7970 653d 2766  k_dims, dtype='f
+0001fa20: 6c6f 6174 3634 2729 0a0a 2020 2020 2020  loat64')..      
+0001fa30: 2020 6666 7477 5f6f 626a 6563 7431 203d    fftw_object1 =
+0001fa40: 2066 6f75 7269 6572 2e67 6574 5f70 7966   fourier.get_pyf
+0001fa50: 6674 775f 6f62 6a65 6374 286d 6173 6b5f  ftw_object(mask_
+0001fa60: 6469 6d73 290a 2020 2020 2020 2020 6666  dims).        ff
+0001fa70: 7477 5f6f 626a 6563 7432 203d 2066 6f75  tw_object2 = fou
+0001fa80: 7269 6572 2e67 6574 5f70 7966 6674 775f  rier.get_pyfftw_
+0001fa90: 6f62 6a65 6374 286d 6173 6b5f 6469 6d73  object(mask_dims
+0001faa0: 290a 0a20 2020 2020 2020 2071 6269 6e73  )..        qbins
+0001fab0: 2c20 6c61 6265 6c6c 6564 5f73 6865 6c6c  , labelled_shell
+0001fac0: 7320 3d20 666f 7572 6965 722e 6765 745f  s = fourier.get_
+0001fad0: 6c61 6265 6c6c 6564 5f73 6865 6c6c 7328  labelled_shells(
+0001fae0: 0a20 2020 2020 2020 2020 2020 2069 6e70  .            inp
+0001faf0: 7574 312e 7368 6170 6529 0a0a 2020 2020  ut1.shape)..    
+0001fb00: 2020 2020 2320 6765 7420 636f 6f72 6469      # get coordi
+0001fb10: 6e61 7465 7320 7768 6572 6520 6c6f 6361  nates where loca
+0001fb20: 6c20 4653 4320 7368 6f75 6c64 2062 6520  l FSC should be 
+0001fb30: 6361 6c63 756c 6174 6564 0a20 2020 2020  calculated.     
+0001fb40: 2020 2069 6620 7374 7275 6374 7572 6520     if structure 
+0001fb50: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
+0001fb60: 2020 2020 2020 2020 2063 6f6f 7264 696e           coordin
+0001fb70: 6174 6573 203d 2073 7472 7563 7475 7265  ates = structure
+0001fb80: 2e67 6574 5f43 416f 6e6c 7928 292e 6765  .get_CAonly().ge
+0001fb90: 745f 6174 6f6d 5f7a 7978 5f6d 6170 5f69  t_atom_zyx_map_i
+0001fba0: 6e64 6578 6573 280a 2020 2020 2020 2020  ndexes(.        
+0001fbb0: 2020 2020 2020 2020 6861 6c66 5f6d 6170          half_map
+0001fbc0: 5f31 290a 2020 2020 2020 2020 656c 6966  _1).        elif
+0001fbd0: 2070 726f 7465 696e 5f6d 6173 6b20 6973   protein_mask is
+0001fbe0: 206e 6f74 204e 6f6e 653a 0a20 2020 2020   not None:.     
+0001fbf0: 2020 2020 2020 2028 7a2c 2079 2c20 7829         (z, y, x)
+0001fc00: 203d 206e 702e 7768 6572 6528 7072 6f74   = np.where(prot
+0001fc10: 6569 6e5f 6d61 736b 2e66 756c 6c4d 6170  ein_mask.fullMap
+0001fc20: 203e 2030 290a 2020 2020 2020 2020 2020   > 0).          
+0001fc30: 2020 636f 6f72 6469 6e61 7465 7320 3d20    coordinates = 
+0001fc40: 6e70 2e73 7461 636b 2828 7a2c 2079 2c20  np.stack((z, y, 
+0001fc50: 7829 2c20 6178 6973 3d2d 3129 0a20 2020  x), axis=-1).   
+0001fc60: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+0001fc70: 2020 2020 2020 2028 7a2c 2079 2c20 7829         (z, y, x)
+0001fc80: 203d 206e 702e 7768 6572 6528 6861 6c66   = np.where(half
+0001fc90: 5f6d 6170 5f31 2e66 756c 6c4d 6170 203c  _map_1.fullMap <
+0001fca0: 206e 702e 696e 6629 0a20 2020 2020 2020   np.inf).       
+0001fcb0: 2020 2020 2063 6f6f 7264 696e 6174 6573       coordinates
+0001fcc0: 203d 206e 702e 7374 6163 6b28 287a 2c20   = np.stack((z, 
+0001fcd0: 792c 2078 292c 2061 7869 733d 2d31 290a  y, x), axis=-1).
+0001fce0: 0a20 2020 2020 2020 2077 6172 6e69 6e67  .        warning
+0001fcf0: 7320 3d20 5b5d 0a20 2020 2020 2020 206e  s = [].        n
+0001fd00: 203d 2030 0a0a 2020 2020 2020 2020 666f   = 0..        fo
+0001fd10: 7220 636f 6f72 6469 6e61 7465 2069 6e20  r coordinate in 
+0001fd20: 636f 6f72 6469 6e61 7465 733a 0a0a 2020  coordinates:..  
+0001fd30: 2020 2020 2020 2020 2020 6372 6f70 7065            croppe
+0001fd40: 645f 6d61 705f 3120 3d20 6861 6c66 5f6d  d_map_1 = half_m
+0001fd50: 6170 5f31 2e67 6574 5f63 726f 7070 6564  ap_1.get_cropped
+0001fd60: 5f62 6f78 280a 2020 2020 2020 2020 2020  _box(.          
+0001fd70: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0001fd80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001fd90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001fda0: 2020 2020 2020 2029 0a0a 2020 2020 2020         )..      
-0001fdb0: 2020 2020 2020 6673 6320 3d20 666f 7572        fsc = four
-0001fdc0: 6965 722e 6361 6c63 756c 6174 655f 6673  ier.calculate_fs
-0001fdd0: 635f 7769 7468 5f6d 6173 6b28 0a20 2020  c_with_mask(.   
-0001fde0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001fd90: 2020 2020 2020 2020 2020 2020 2020 636f                co
+0001fda0: 6f72 6469 6e61 7465 2c0a 2020 2020 2020  ordinate,.      
+0001fdb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001fdc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001fdd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001fde0: 2020 6d61 736b 5f64 696d 732c 0a20 2020    mask_dims,.   
 0001fdf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001fe00: 2020 2020 2020 2020 2063 726f 7070 6564           cropped
-0001fe10: 5f6d 6170 5f31 2e66 756c 6c4d 6170 2c0a  _map_1.fullMap,.
-0001fe20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001fe30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001fe40: 2020 2020 2020 2020 2020 2020 6372 6f70              crop
-0001fe50: 7065 645f 6d61 705f 322e 6675 6c6c 4d61  ped_map_2.fullMa
-0001fe60: 702c 0a20 2020 2020 2020 2020 2020 2020  p,.             
+0001fe00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001fe10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001fe20: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
+0001fe30: 2020 2063 726f 7070 6564 5f6d 6170 5f32     cropped_map_2
+0001fe40: 203d 2068 616c 665f 6d61 705f 322e 6765   = half_map_2.ge
+0001fe50: 745f 6372 6f70 7065 645f 626f 7828 0a20  t_cropped_box(. 
+0001fe60: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0001fe70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001fe80: 2020 2020 2020 2020 2020 2020 2020 206d                 m
-0001fe90: 6173 6b2e 6675 6c6c 4d61 702c 0a20 2020  ask.fullMap,.   
+0001fe80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001fe90: 2020 2063 6f6f 7264 696e 6174 652c 0a20     coordinate,. 
 0001fea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0001feb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001fec0: 2020 2020 2020 2020 2070 6978 656c 5f73           pixel_s
-0001fed0: 697a 653d 6170 6978 2c0a 2020 2020 2020  ize=apix,.      
+0001fec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001fed0: 2020 206d 6173 6b5f 6469 6d73 2c0a 2020     mask_dims,.  
 0001fee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0001fef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ff00: 2020 2020 2020 6c61 6265 6c6c 6564 5f73        labelled_s
-0001ff10: 6865 6c6c 733d 6c61 6265 6c6c 6564 5f73  hells=labelled_s
-0001ff20: 6865 6c6c 732c 0a20 2020 2020 2020 2020  hells,.         
-0001ff30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ff40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ff50: 2020 2071 6269 6e73 3d71 6269 6e73 2c0a     qbins=qbins,.
+0001ff00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ff10: 2020 290a 0a20 2020 2020 2020 2020 2020    )..           
+0001ff20: 2066 7363 203d 2066 6f75 7269 6572 2e63   fsc = fourier.c
+0001ff30: 616c 6375 6c61 7465 5f66 7363 5f77 6974  alculate_fsc_wit
+0001ff40: 685f 6d61 736b 280a 2020 2020 2020 2020  h_mask(.        
+0001ff50: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0001ff60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ff70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ff80: 2020 2020 2020 2020 2020 2020 6666 7477              fftw
-0001ff90: 5f6f 626a 6563 7431 3d66 6674 775f 6f62  _object1=fftw_ob
-0001ffa0: 6a65 6374 312c 0a20 2020 2020 2020 2020  ject1,.         
-0001ffb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ffc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ffd0: 2020 2066 6674 775f 6f62 6a65 6374 323d     fftw_object2=
-0001ffe0: 6666 7477 5f6f 626a 6563 7432 2c0a 2020  fftw_object2,.  
-0001fff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020000: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020010: 2020 2020 2020 2020 2020 290a 0a20 2020            )..   
-00020020: 2020 2020 2020 2020 2023 2066 696e 6420           # find 
-00020030: 6869 6768 6573 7420 6672 6571 7565 6e63  highest frequenc
-00020040: 7920 7368 656c 6c20 7769 7468 2030 2e35  y shell with 0.5
-00020050: 2063 6f72 7265 6c61 7469 6f6e 0a20 2020   correlation.   
-00020060: 2020 2020 2020 2020 2066 7265 715f 6174           freq_at
-00020070: 5f63 6f72 725f 6375 746f 6666 203d 2066  _corr_cutoff = f
-00020080: 6f75 7269 6572 2e67 6574 5f66 7363 5f72  ourier.get_fsc_r
-00020090: 6573 6f6c 7574 696f 6e28 0a20 2020 2020  esolution(.     
+0001ff70: 2020 2020 6372 6f70 7065 645f 6d61 705f      cropped_map_
+0001ff80: 312e 6675 6c6c 4d61 702c 0a20 2020 2020  1.fullMap,.     
+0001ff90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ffa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ffb0: 2020 2020 2020 2063 726f 7070 6564 5f6d         cropped_m
+0001ffc0: 6170 5f32 2e66 756c 6c4d 6170 2c0a 2020  ap_2.fullMap,.  
+0001ffd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ffe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001fff0: 2020 2020 2020 2020 2020 6d61 736b 2e66            mask.f
+00020000: 756c 6c4d 6170 2c0a 2020 2020 2020 2020  ullMap,.        
+00020010: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020020: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020030: 2020 2020 7069 7865 6c5f 7369 7a65 3d61      pixel_size=a
+00020040: 7069 782c 0a20 2020 2020 2020 2020 2020  pix,.           
+00020050: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020060: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020070: 206c 6162 656c 6c65 645f 7368 656c 6c73   labelled_shells
+00020080: 3d6c 6162 656c 6c65 645f 7368 656c 6c73  =labelled_shells
+00020090: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
 000200a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000200b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000200c0: 2020 2020 2020 2066 7363 2c0a 2020 2020         fsc,.    
+000200b0: 2020 2020 2020 2020 2020 2020 2020 7162                qb
+000200c0: 696e 733d 7162 696e 732c 0a20 2020 2020  ins=qbins,.     
 000200d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 000200e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000200f0: 2020 2020 2020 2020 6673 635f 7468 7265          fsc_thre
-00020100: 7368 6f6c 643d 6673 635f 7468 7265 7368  shold=fsc_thresh
-00020110: 6f6c 642c 0a20 2020 2020 2020 2020 2020  old,.           
+000200f0: 2020 2020 2020 2066 6674 775f 6f62 6a65         fftw_obje
+00020100: 6374 313d 6666 7477 5f6f 626a 6563 7431  ct1=fftw_object1
+00020110: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
 00020120: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020130: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020140: 2069 6e74 6572 706f 6c61 7465 5f63 7574   interpolate_cut
-00020150: 6f66 663d 4661 6c73 652c 0a20 2020 2020  off=False,.     
+00020130: 2020 2020 2020 2020 2020 2020 2020 6666                ff
+00020140: 7477 5f6f 626a 6563 7432 3d66 6674 775f  tw_object2=fftw_
+00020150: 6f62 6a65 6374 322c 0a20 2020 2020 2020  object2,.       
 00020160: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00020170: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020180: 2020 2020 2020 2075 7365 5f68 6967 6865         use_highe
-00020190: 7374 5f72 6573 6f6c 7574 696f 6e3d 5472  st_resolution=Tr
-000201a0: 7565 2c0a 2020 2020 2020 2020 2020 2020  ue,.            
-000201b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000201c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000201d0: 290a 0a20 2020 2020 2020 2020 2020 2023  )..            #
-000201e0: 2046 5343 2063 616e 2067 6f20 6265 6c6f   FSC can go belo
-000201f0: 7720 6e79 7175 6973 7420 6672 6571 7565  w nyquist freque
-00020200: 6e63 7920 7768 656e 2073 6865 6c6c 7320  ncy when shells 
-00020210: 6e65 7665 7220 6472 6f70 0a20 2020 2020  never drop.     
-00020220: 2020 2020 2020 2023 2062 656c 6f77 2030         # below 0
-00020230: 2e35 2063 6f72 7265 6c61 7469 6f6e 2061  .5 correlation a
-00020240: 6e64 2066 7265 715f 6174 5f63 6f72 725f  nd freq_at_corr_
-00020250: 6375 746f 6666 2073 7469 6c6c 2065 7175  cutoff still equ
-00020260: 616c 7320 300a 2020 2020 2020 2020 2020  als 0.          
-00020270: 2020 6966 2066 7265 715f 6174 5f63 6f72    if freq_at_cor
-00020280: 725f 6375 746f 6666 203c 206d 696e 2868  r_cutoff < min(h
-00020290: 616c 665f 6d61 705f 312e 6170 6978 2920  alf_map_1.apix) 
-000202a0: 2a20 323a 0a20 2020 2020 2020 2020 2020  * 2:.           
-000202b0: 2020 2020 2066 7265 715f 6174 5f63 6f72       freq_at_cor
-000202c0: 725f 6375 746f 6666 203d 206d 696e 2868  r_cutoff = min(h
-000202d0: 616c 665f 6d61 705f 312e 6170 6978 2920  alf_map_1.apix) 
-000202e0: 2a20 320a 2020 2020 2020 2020 2020 2020  * 2.            
-000202f0: 2020 2020 7761 726e 696e 6773 2e61 7070      warnings.app
-00020300: 656e 6428 6622 5761 726e 696e 673a 2046  end(f"Warning: F
-00020310: 5343 2061 7420 636f 6f72 6469 6e61 7465  SC at coordinate
-00020320: 207b 636f 6f72 6469 6e61 7465 7d22 0a20   {coordinate}". 
-00020330: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020340: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00020350: 2220 6e65 7665 7220 6661 6c6c 7320 6265  " never falls be
-00020360: 6c6f 7720 302e 352e 2053 4c52 5320 220a  low 0.5. SLRS ".
-00020370: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020380: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020390: 6622 7363 6f72 6520 666f 7220 7468 6973  f"score for this
-000203a0: 2072 6573 6964 7565 2073 6574 2074 6f20   residue set to 
-000203b0: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
-000203c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000203d0: 2020 6622 7b66 7265 715f 6174 5f63 6f72    f"{freq_at_cor
-000203e0: 725f 6375 746f 6666 7d2e 2054 6869 7320  r_cutoff}. This 
-000203f0: 6973 204e 4f54 2022 0a20 2020 2020 2020  is NOT ".       
-00020400: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020410: 2020 2020 2020 2020 2066 2265 7870 6563           f"expec
-00020420: 7465 6420 616e 6420 4e4f 5420 616e 2069  ted and NOT an i
-00020430: 6e64 6963 6174 696f 6e20 6f66 2061 2067  ndication of a g
-00020440: 6f6f 6420 220a 2020 2020 2020 2020 2020  ood ".          
-00020450: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020460: 2020 2020 2020 6622 6669 7420 6265 7477        f"fit betw
-00020470: 6565 6e20 6d61 7020 616e 6420 6d6f 6465  een map and mode
-00020480: 6c2e 2229 0a0a 2020 2020 2020 2020 2020  l.")..          
-00020490: 2020 6469 6374 5f72 6573 5f73 636f 7265    dict_res_score
-000204a0: 735b 7475 706c 6528 636f 6f72 6469 6e61  s[tuple(coordina
-000204b0: 7465 295d 203d 2066 7265 715f 6174 5f63  te)] = freq_at_c
-000204c0: 6f72 725f 6375 746f 6666 0a0a 2020 2020  orr_cutoff..    
-000204d0: 2020 2020 2020 2020 6e20 2b3d 2031 0a20          n += 1. 
-000204e0: 2020 2020 2020 2020 2020 2069 6620 7665             if ve
-000204f0: 7262 6f73 653a 0a20 2020 2020 2020 2020  rbose:.         
-00020500: 2020 2020 2020 207a 6669 6c6c 5f6c 656e         zfill_len
-00020510: 203d 206c 656e 2873 7472 286c 656e 2863   = len(str(len(c
-00020520: 6f6f 7264 696e 6174 6573 2929 290a 2020  oordinates))).  
-00020530: 2020 2020 2020 2020 2020 2020 2020 7072                pr
-00020540: 696e 7428 6622 5c72 5072 6f63 6573 7365  int(f"\rProcesse
-00020550: 6420 7265 7369 6475 6520 7b73 7472 286e  d residue {str(n
-00020560: 292e 7a66 696c 6c28 7a66 696c 6c5f 6c65  ).zfill(zfill_le
-00020570: 6e29 7d22 0a20 2020 2020 2020 2020 2020  n)}".           
-00020580: 2020 2020 2020 2020 2020 2066 222f 7b6c             f"/{l
-00020590: 656e 2863 6f6f 7264 696e 6174 6573 297d  en(coordinates)}
-000205a0: 222c 2073 6570 3d27 272c 2065 6e64 3d27  ", sep='', end='
-000205b0: 272c 2066 6c75 7368 3d54 7275 6529 0a0a  ', flush=True)..
-000205c0: 2020 2020 2020 2020 6966 2076 6572 626f          if verbo
-000205d0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-000205e0: 7072 696e 7428 2222 290a 2020 2020 2020  print("").      
-000205f0: 2020 2020 2020 666f 7220 7761 726e 696e        for warnin
-00020600: 6720 696e 2077 6172 6e69 6e67 733a 0a20  g in warnings:. 
-00020610: 2020 2020 2020 2020 2020 2020 2020 2070                 p
-00020620: 7269 6e74 2877 6172 6e69 6e67 290a 0a20  rint(warning).. 
-00020630: 2020 2020 2020 2072 6574 7572 6e20 6469         return di
-00020640: 6374 5f72 6573 5f73 636f 7265 730a 0a20  ct_res_scores.. 
-00020650: 2020 2064 6566 206d 6170 5f72 6573 6f6c     def map_resol
-00020660: 7574 696f 6e5f 4653 4328 7365 6c66 2c20  ution_FSC(self, 
-00020670: 6861 6c66 5f6d 6170 312c 2068 616c 665f  half_map1, half_
-00020680: 6d61 7032 2c20 6d61 736b 3d4e 6f6e 652c  map2, mask=None,
-00020690: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000206a0: 2020 2020 2020 2020 2020 2020 6673 635f              fsc_
-000206b0: 7468 7265 7368 6f6c 643d 302e 3134 332c  threshold=0.143,
-000206c0: 2075 7365 5f68 6967 6865 7374 5f72 6573   use_highest_res
-000206d0: 6f6c 7574 696f 6e3d 5472 7565 293a 0a20  olution=True):. 
-000206e0: 2020 2020 2020 2022 2222 4361 6c63 756c         """Calcul
-000206f0: 6174 6520 7468 6520 6d61 7020 7265 736f  ate the map reso
-00020700: 6c75 7469 6f6e 2066 726f 6d20 7477 6f20  lution from two 
-00020710: 6861 6c66 2d6d 6170 7320 7573 696e 6720  half-maps using 
-00020720: 7468 650a 2020 2020 2020 2020 466f 7572  the.        Four
-00020730: 6965 7220 5368 656c 6c20 436f 7272 656c  ier Shell Correl
-00020740: 6174 696f 6e2e 0a0a 2020 2020 2020 2020  ation...        
-00020750: 4172 6775 6d65 6e74 733a 0a20 2020 2020  Arguments:.     
-00020760: 2020 2020 2020 2068 616c 665f 6d61 7031         half_map1
-00020770: 3a20 4d61 7020 696e 7374 616e 6365 206f  : Map instance o
-00020780: 6620 6669 7273 7420 6861 6c66 206d 6170  f first half map
-00020790: 0a20 2020 2020 2020 2020 2020 2068 616c  .            hal
-000207a0: 665f 6d61 7032 3a20 4d61 7020 696e 7374  f_map2: Map inst
-000207b0: 616e 6365 206f 6620 7365 636f 6e64 2068  ance of second h
-000207c0: 616c 6620 6d61 700a 2020 2020 2020 2020  alf map.        
-000207d0: 2020 2020 6d61 736b 3a20 4120 4d61 7020      mask: A Map 
-000207e0: 696e 7374 616e 6365 206f 6620 6120 736f  instance of a so
-000207f0: 6674 2065 6467 6564 206d 6173 6b0a 2020  ft edged mask.  
-00020800: 2020 2020 2020 2020 2020 6673 635f 7468            fsc_th
-00020810: 7265 7368 6f6c 643a 2043 6f72 7265 6c61  reshold: Correla
-00020820: 7469 6f6e 2074 6872 6573 686f 6c64 2076  tion threshold v
-00020830: 616c 7565 2074 6861 7420 6465 6669 6e65  alue that define
-00020840: 730a 2020 2020 2020 2020 2020 2020 2020  s.              
-00020850: 2020 686f 7720 7468 6520 6d61 7020 7265    how the map re
-00020860: 736f 6c75 7469 6f6e 2069 7320 666f 756e  solution is foun
-00020870: 642e 0a20 2020 2020 2020 2020 2020 2075  d..            u
-00020880: 7365 5f68 6967 6865 7374 5f72 6573 6f6c  se_highest_resol
-00020890: 7574 696f 6e3a 2049 6620 5472 7565 2c20  ution: If True, 
-000208a0: 7461 6b65 7320 7468 6520 6869 6768 6573  takes the highes
-000208b0: 740a 2020 2020 2020 2020 2020 2020 2020  t.              
-000208c0: 2020 7265 736f 6c75 7469 6f6e 2073 6865    resolution she
-000208d0: 6c6c 2074 6861 7420 6372 6f73 7365 7320  ll that crosses 
-000208e0: 7468 6520 6673 635f 7468 7265 7368 6f6c  the fsc_threshol
-000208f0: 642c 2069 660a 2020 2020 2020 2020 2020  d, if.          
-00020900: 2020 2020 2020 7468 6572 6520 6172 6520        there are 
-00020910: 6d75 6c74 6970 6c65 2063 726f 7373 6f76  multiple crossov
-00020920: 6572 732e 0a0a 2020 2020 2020 2020 5265  ers...        Re
-00020930: 7475 726e 733a 0a20 2020 2020 2020 2020  turns:.         
-00020940: 2020 2054 6865 2046 5343 2072 6573 6f6c     The FSC resol
-00020950: 7574 696f 6e20 2869 6e20 616e 6773 7472  ution (in angstr
-00020960: 6f6d 7329 2e0a 0a20 2020 2020 2020 2022  oms)...        "
-00020970: 2222 0a20 2020 2020 2020 2069 6620 6d61  "".        if ma
-00020980: 736b 2069 7320 6e6f 7420 4e6f 6e65 3a0a  sk is not None:.
-00020990: 2020 2020 2020 2020 2020 2020 6673 6320              fsc 
-000209a0: 3d20 666f 7572 6965 722e 6361 6c63 756c  = fourier.calcul
-000209b0: 6174 655f 6673 635f 7769 7468 5f6d 6173  ate_fsc_with_mas
-000209c0: 6b28 0a20 2020 2020 2020 2020 2020 2020  k(.             
-000209d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000209e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000209f0: 2020 2068 616c 665f 6d61 7031 2e66 756c     half_map1.ful
-00020a00: 6c4d 6170 2c0a 2020 2020 2020 2020 2020  lMap,.          
-00020a10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020a20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020a30: 2020 2020 2020 6861 6c66 5f6d 6170 322e        half_map2.
-00020a40: 6675 6c6c 4d61 702c 0a20 2020 2020 2020  fullMap,.       
-00020a50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020a60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020a70: 2020 2020 2020 2020 206d 6173 6b2e 6675           mask.fu
-00020a80: 6c6c 4d61 702c 0a20 2020 2020 2020 2020  llMap,.         
-00020a90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020aa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020ab0: 2020 2020 2020 2070 6978 656c 5f73 697a         pixel_siz
-00020ac0: 653d 6861 6c66 5f6d 6170 312e 6170 6978  e=half_map1.apix
-00020ad0: 5b30 5d2c 290a 2020 2020 2020 2020 656c  [0],).        el
-00020ae0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-00020af0: 6673 6320 3d20 666f 7572 6965 722e 6361  fsc = fourier.ca
-00020b00: 6c63 756c 6174 655f 6673 6328 6861 6c66  lculate_fsc(half
-00020b10: 5f6d 6170 312e 6675 6c6c 4d61 702c 0a20  _map1.fullMap,. 
-00020b20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020180: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
+00020190: 2020 2020 2320 6669 6e64 2068 6967 6865      # find highe
+000201a0: 7374 2066 7265 7175 656e 6379 2073 6865  st frequency she
+000201b0: 6c6c 2077 6974 6820 302e 3520 636f 7272  ll with 0.5 corr
+000201c0: 656c 6174 696f 6e0a 2020 2020 2020 2020  elation.        
+000201d0: 2020 2020 6672 6571 5f61 745f 636f 7272      freq_at_corr
+000201e0: 5f63 7574 6f66 6620 3d20 666f 7572 6965  _cutoff = fourie
+000201f0: 722e 6765 745f 6673 635f 7265 736f 6c75  r.get_fsc_resolu
+00020200: 7469 6f6e 280a 2020 2020 2020 2020 2020  tion(.          
+00020210: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020220: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020230: 2020 6673 632c 0a20 2020 2020 2020 2020    fsc,.         
+00020240: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020250: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020260: 2020 2066 7363 5f74 6872 6573 686f 6c64     fsc_threshold
+00020270: 3d66 7363 5f74 6872 6573 686f 6c64 2c0a  =fsc_threshold,.
+00020280: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020290: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000202a0: 2020 2020 2020 2020 2020 2020 696e 7465              inte
+000202b0: 7270 6f6c 6174 655f 6375 746f 6666 3d46  rpolate_cutoff=F
+000202c0: 616c 7365 2c0a 2020 2020 2020 2020 2020  alse,.          
+000202d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000202e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000202f0: 2020 7573 655f 6869 6768 6573 745f 7265    use_highest_re
+00020300: 736f 6c75 7469 6f6e 3d54 7275 652c 0a20  solution=True,. 
+00020310: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020320: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020330: 2020 2020 2020 2020 2020 2029 0a0a 2020             )..  
+00020340: 2020 2020 2020 2020 2020 2320 4653 4320            # FSC 
+00020350: 6361 6e20 676f 2062 656c 6f77 206e 7971  can go below nyq
+00020360: 7569 7374 2066 7265 7175 656e 6379 2077  uist frequency w
+00020370: 6865 6e20 7368 656c 6c73 206e 6576 6572  hen shells never
+00020380: 2064 726f 700a 2020 2020 2020 2020 2020   drop.          
+00020390: 2020 2320 6265 6c6f 7720 302e 3520 636f    # below 0.5 co
+000203a0: 7272 656c 6174 696f 6e20 616e 6420 6672  rrelation and fr
+000203b0: 6571 5f61 745f 636f 7272 5f63 7574 6f66  eq_at_corr_cutof
+000203c0: 6620 7374 696c 6c20 6571 7561 6c73 2030  f still equals 0
+000203d0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+000203e0: 6672 6571 5f61 745f 636f 7272 5f63 7574  freq_at_corr_cut
+000203f0: 6f66 6620 3c20 6d69 6e28 6861 6c66 5f6d  off < min(half_m
+00020400: 6170 5f31 2e61 7069 7829 202a 2032 3a0a  ap_1.apix) * 2:.
+00020410: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020420: 6672 6571 5f61 745f 636f 7272 5f63 7574  freq_at_corr_cut
+00020430: 6f66 6620 3d20 6d69 6e28 6861 6c66 5f6d  off = min(half_m
+00020440: 6170 5f31 2e61 7069 7829 202a 2032 0a20  ap_1.apix) * 2. 
+00020450: 2020 2020 2020 2020 2020 2020 2020 2077                 w
+00020460: 6172 6e69 6e67 732e 6170 7065 6e64 2866  arnings.append(f
+00020470: 2257 6172 6e69 6e67 3a20 4653 4320 6174  "Warning: FSC at
+00020480: 2063 6f6f 7264 696e 6174 6520 7b63 6f6f   coordinate {coo
+00020490: 7264 696e 6174 657d 220a 2020 2020 2020  rdinate}".      
+000204a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000204b0: 2020 2020 2020 2020 2020 6622 206e 6576            f" nev
+000204c0: 6572 2066 616c 6c73 2062 656c 6f77 2030  er falls below 0
+000204d0: 2e35 2e20 534c 5253 2022 0a20 2020 2020  .5. SLRS ".     
+000204e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000204f0: 2020 2020 2020 2020 2020 2066 2273 636f             f"sco
+00020500: 7265 2066 6f72 2074 6869 7320 7265 7369  re for this resi
+00020510: 6475 6520 7365 7420 746f 2022 0a20 2020  due set to ".   
+00020520: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020530: 2020 2020 2020 2020 2020 2020 2066 227b               f"{
+00020540: 6672 6571 5f61 745f 636f 7272 5f63 7574  freq_at_corr_cut
+00020550: 6f66 667d 2e20 5468 6973 2069 7320 4e4f  off}. This is NO
+00020560: 5420 220a 2020 2020 2020 2020 2020 2020  T ".            
+00020570: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020580: 2020 2020 6622 6578 7065 6374 6564 2061      f"expected a
+00020590: 6e64 204e 4f54 2061 6e20 696e 6469 6361  nd NOT an indica
+000205a0: 7469 6f6e 206f 6620 6120 676f 6f64 2022  tion of a good "
+000205b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000205c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000205d0: 2066 2266 6974 2062 6574 7765 656e 206d   f"fit between m
+000205e0: 6170 2061 6e64 206d 6f64 656c 2e22 290a  ap and model.").
+000205f0: 0a20 2020 2020 2020 2020 2020 2064 6963  .            dic
+00020600: 745f 7265 735f 7363 6f72 6573 5b74 7570  t_res_scores[tup
+00020610: 6c65 2863 6f6f 7264 696e 6174 6529 5d20  le(coordinate)] 
+00020620: 3d20 6672 6571 5f61 745f 636f 7272 5f63  = freq_at_corr_c
+00020630: 7574 6f66 660a 0a20 2020 2020 2020 2020  utoff..         
+00020640: 2020 206e 202b 3d20 310a 2020 2020 2020     n += 1.      
+00020650: 2020 2020 2020 6966 2076 6572 626f 7365        if verbose
+00020660: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00020670: 2020 7a66 696c 6c5f 6c65 6e20 3d20 6c65    zfill_len = le
+00020680: 6e28 7374 7228 6c65 6e28 636f 6f72 6469  n(str(len(coordi
+00020690: 6e61 7465 7329 2929 0a20 2020 2020 2020  nates))).       
+000206a0: 2020 2020 2020 2020 2070 7269 6e74 2866           print(f
+000206b0: 225c 7250 726f 6365 7373 6564 2072 6573  "\rProcessed res
+000206c0: 6964 7565 207b 7374 7228 6e29 2e7a 6669  idue {str(n).zfi
+000206d0: 6c6c 287a 6669 6c6c 5f6c 656e 297d 220a  ll(zfill_len)}".
+000206e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000206f0: 2020 2020 2020 6622 2f7b 6c65 6e28 636f        f"/{len(co
+00020700: 6f72 6469 6e61 7465 7329 7d22 2c20 7365  ordinates)}", se
+00020710: 703d 2727 2c20 656e 643d 2727 2c20 666c  p='', end='', fl
+00020720: 7573 683d 5472 7565 290a 0a20 2020 2020  ush=True)..     
+00020730: 2020 2069 6620 7665 7262 6f73 653a 0a20     if verbose:. 
+00020740: 2020 2020 2020 2020 2020 2070 7269 6e74             print
+00020750: 2822 2229 0a20 2020 2020 2020 2020 2020  ("").           
+00020760: 2066 6f72 2077 6172 6e69 6e67 2069 6e20   for warning in 
+00020770: 7761 726e 696e 6773 3a0a 2020 2020 2020  warnings:.      
+00020780: 2020 2020 2020 2020 2020 7072 696e 7428            print(
+00020790: 7761 726e 696e 6729 0a0a 2020 2020 2020  warning)..      
+000207a0: 2020 7265 7475 726e 2064 6963 745f 7265    return dict_re
+000207b0: 735f 7363 6f72 6573 0a0a 2020 2020 6465  s_scores..    de
+000207c0: 6620 6d61 705f 7265 736f 6c75 7469 6f6e  f map_resolution
+000207d0: 5f46 5343 2873 656c 662c 2068 616c 665f  _FSC(self, half_
+000207e0: 6d61 7031 2c20 6861 6c66 5f6d 6170 322c  map1, half_map2,
+000207f0: 206d 6173 6b3d 4e6f 6e65 2c0a 2020 2020   mask=None,.    
+00020800: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020810: 2020 2020 2020 2066 7363 5f74 6872 6573         fsc_thres
+00020820: 686f 6c64 3d30 2e31 3433 2c20 7573 655f  hold=0.143, use_
+00020830: 6869 6768 6573 745f 7265 736f 6c75 7469  highest_resoluti
+00020840: 6f6e 3d54 7275 6529 3a0a 2020 2020 2020  on=True):.      
+00020850: 2020 2222 2243 616c 6375 6c61 7465 2074    """Calculate t
+00020860: 6865 206d 6170 2072 6573 6f6c 7574 696f  he map resolutio
+00020870: 6e20 6672 6f6d 2074 776f 2068 616c 662d  n from two half-
+00020880: 6d61 7073 2075 7369 6e67 2074 6865 0a20  maps using the. 
+00020890: 2020 2020 2020 2046 6f75 7269 6572 2053         Fourier S
+000208a0: 6865 6c6c 2043 6f72 7265 6c61 7469 6f6e  hell Correlation
+000208b0: 2e0a 0a20 2020 2020 2020 2041 7267 756d  ...        Argum
+000208c0: 656e 7473 3a0a 2020 2020 2020 2020 2020  ents:.          
+000208d0: 2020 6861 6c66 5f6d 6170 313a 204d 6170    half_map1: Map
+000208e0: 2069 6e73 7461 6e63 6520 6f66 2066 6972   instance of fir
+000208f0: 7374 2068 616c 6620 6d61 700a 2020 2020  st half map.    
+00020900: 2020 2020 2020 2020 6861 6c66 5f6d 6170          half_map
+00020910: 323a 204d 6170 2069 6e73 7461 6e63 6520  2: Map instance 
+00020920: 6f66 2073 6563 6f6e 6420 6861 6c66 206d  of second half m
+00020930: 6170 0a20 2020 2020 2020 2020 2020 206d  ap.            m
+00020940: 6173 6b3a 2041 204d 6170 2069 6e73 7461  ask: A Map insta
+00020950: 6e63 6520 6f66 2061 2073 6f66 7420 6564  nce of a soft ed
+00020960: 6765 6420 6d61 736b 0a20 2020 2020 2020  ged mask.       
+00020970: 2020 2020 2066 7363 5f74 6872 6573 686f       fsc_thresho
+00020980: 6c64 3a20 436f 7272 656c 6174 696f 6e20  ld: Correlation 
+00020990: 7468 7265 7368 6f6c 6420 7661 6c75 6520  threshold value 
+000209a0: 7468 6174 2064 6566 696e 6573 0a20 2020  that defines.   
+000209b0: 2020 2020 2020 2020 2020 2020 2068 6f77               how
+000209c0: 2074 6865 206d 6170 2072 6573 6f6c 7574   the map resolut
+000209d0: 696f 6e20 6973 2066 6f75 6e64 2e0a 2020  ion is found..  
+000209e0: 2020 2020 2020 2020 2020 7573 655f 6869            use_hi
+000209f0: 6768 6573 745f 7265 736f 6c75 7469 6f6e  ghest_resolution
+00020a00: 3a20 4966 2054 7275 652c 2074 616b 6573  : If True, takes
+00020a10: 2074 6865 2068 6967 6865 7374 0a20 2020   the highest.   
+00020a20: 2020 2020 2020 2020 2020 2020 2072 6573               res
+00020a30: 6f6c 7574 696f 6e20 7368 656c 6c20 7468  olution shell th
+00020a40: 6174 2063 726f 7373 6573 2074 6865 2066  at crosses the f
+00020a50: 7363 5f74 6872 6573 686f 6c64 2c20 6966  sc_threshold, if
+00020a60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00020a70: 2074 6865 7265 2061 7265 206d 756c 7469   there are multi
+00020a80: 706c 6520 6372 6f73 736f 7665 7273 2e0a  ple crossovers..
+00020a90: 0a20 2020 2020 2020 2052 6574 7572 6e73  .        Returns
+00020aa0: 3a0a 2020 2020 2020 2020 2020 2020 5468  :.            Th
+00020ab0: 6520 4653 4320 7265 736f 6c75 7469 6f6e  e FSC resolution
+00020ac0: 2028 696e 2061 6e67 7374 726f 6d73 292e   (in angstroms).
+00020ad0: 0a0a 2020 2020 2020 2020 2222 220a 2020  ..        """.  
+00020ae0: 2020 2020 2020 6966 206d 6173 6b20 6973        if mask is
+00020af0: 206e 6f74 204e 6f6e 653a 0a20 2020 2020   not None:.     
+00020b00: 2020 2020 2020 2066 7363 203d 2066 6f75         fsc = fou
+00020b10: 7269 6572 2e63 616c 6375 6c61 7465 5f66  rier.calculate_f
+00020b20: 7363 5f77 6974 685f 6d61 736b 280a 2020  sc_with_mask(.  
 00020b30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020b40: 2020 2020 2020 2068 616c 665f 6d61 7032         half_map2
-00020b50: 2e66 756c 6c4d 6170 2c0a 2020 2020 2020  .fullMap,.      
-00020b60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020b70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020b80: 2020 7069 7865 6c5f 7369 7a65 3d68 616c    pixel_size=hal
-00020b90: 665f 6d61 7031 2e61 7069 785b 305d 2c29  f_map1.apix[0],)
-00020ba0: 0a0a 2020 2020 2020 2020 7265 736f 6c75  ..        resolu
-00020bb0: 7469 6f6e 203d 2066 6f75 7269 6572 2e67  tion = fourier.g
-00020bc0: 6574 5f66 7363 5f72 6573 6f6c 7574 696f  et_fsc_resolutio
-00020bd0: 6e28 0a20 2020 2020 2020 2020 2020 2066  n(.            f
-00020be0: 7363 2c20 6673 635f 7468 7265 7368 6f6c  sc, fsc_threshol
-00020bf0: 643d 6673 635f 7468 7265 7368 6f6c 642c  d=fsc_threshold,
-00020c00: 0a20 2020 2020 2020 2020 2020 2075 7365  .            use
-00020c10: 5f68 6967 6865 7374 5f72 6573 6f6c 7574  _highest_resolut
-00020c20: 696f 6e3d 7573 655f 6869 6768 6573 745f  ion=use_highest_
-00020c30: 7265 736f 6c75 7469 6f6e 2c0a 2020 2020  resolution,.    
-00020c40: 2020 2020 2020 2020 696e 7465 7270 6f6c          interpol
-00020c50: 6174 655f 6375 746f 6666 3d46 616c 7365  ate_cutoff=False
-00020c60: 290a 0a20 2020 2020 2020 2072 6574 7572  )..        retur
-00020c70: 6e20 7265 736f 6c75 7469 6f6e 0a0a 0a63  n resolution...c
-00020c80: 6c61 7373 2053 6c69 6469 6e67 5265 7369  lass SlidingResi
-00020c90: 6475 6557 696e 646f 773a 0a20 2020 2064  dueWindow:.    d
-00020ca0: 6566 205f 5f69 6e69 745f 5f28 7365 6c66  ef __init__(self
-00020cb0: 2c20 6163 6375 6d75 6c61 746f 7229 3a0a  , accumulator):.
-00020cc0: 2020 2020 2020 2020 7365 6c66 2e61 6363          self.acc
-00020cd0: 756d 756c 6174 6f72 203d 2061 6363 756d  umulator = accum
-00020ce0: 756c 6174 6f72 0a0a 2020 2020 6465 6620  ulator..    def 
-00020cf0: 7363 6f72 6573 2873 656c 662c 2072 6573  scores(self, res
-00020d00: 6964 7565 5f61 746f 6d73 5f6c 6973 742c  idue_atoms_list,
-00020d10: 2073 697a 6529 3a0a 2020 2020 2020 2020   size):.        
-00020d20: 7365 6c66 2e61 6363 756d 756c 6174 6f72  self.accumulator
-00020d30: 2e7a 6572 6f28 290a 0a20 2020 2020 2020  .zero()..       
-00020d40: 2068 616c 665f 7769 6e64 6f77 203d 2069   half_window = i
-00020d50: 6e74 2828 7369 7a65 202d 2031 2920 2f20  nt((size - 1) / 
-00020d60: 3229 0a0a 2020 2020 2020 2020 7363 6f72  2)..        scor
-00020d70: 6573 203d 205b 5d0a 2020 2020 2020 2020  es = [].        
-00020d80: 666f 7220 6865 6164 2069 6e20 7261 6e67  for head in rang
-00020d90: 6528 302c 206c 656e 2872 6573 6964 7565  e(0, len(residue
-00020da0: 5f61 746f 6d73 5f6c 6973 7429 202b 2068  _atoms_list) + h
-00020db0: 616c 665f 7769 6e64 6f77 293a 0a20 2020  alf_window):.   
-00020dc0: 2020 2020 2020 2020 2074 6169 6c20 3d20           tail = 
-00020dd0: 6865 6164 202d 2073 697a 650a 0a20 2020  head - size..   
-00020de0: 2020 2020 2020 2020 2023 2057 6869 6c65           # While
-00020df0: 2074 6865 2068 6561 6420 6973 2077 6974   the head is wit
-00020e00: 6820 696e 2074 6865 2061 6c6c 6f77 6564  h in the allowed
-00020e10: 2072 616e 6765 2c20 7573 6520 616c 6c20   range, use all 
-00020e20: 7468 6520 766f 7865 6c73 0a20 2020 2020  the voxels.     
-00020e30: 2020 2020 2020 2023 2061 7373 6f63 6961         # associa
-00020e40: 7465 6420 7769 7468 2074 6865 2072 6573  ted with the res
-00020e50: 6964 7565 7320 6174 6f6d 732e 0a20 2020  idues atoms..   
-00020e60: 2020 2020 2020 2020 2069 6620 6865 6164           if head
-00020e70: 203c 206c 656e 2872 6573 6964 7565 5f61   < len(residue_a
-00020e80: 746f 6d73 5f6c 6973 7429 3a0a 2020 2020  toms_list):.    
-00020e90: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-00020ea0: 6174 6f6d 2069 6e20 7265 7369 6475 655f  atom in residue_
-00020eb0: 6174 6f6d 735f 6c69 7374 5b68 6561 645d  atoms_list[head]
-00020ec0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00020ed0: 2020 2020 2020 7365 6c66 2e61 6363 756d        self.accum
-00020ee0: 756c 6174 6f72 2e61 6464 5f61 746f 6d28  ulator.add_atom(
-00020ef0: 6174 6f6d 290a 0a20 2020 2020 2020 2020  atom)..         
-00020f00: 2020 2023 2044 726f 7020 7468 6520 7461     # Drop the ta
-00020f10: 696c 2069 6620 6974 2077 6974 6869 6e20  il if it within 
-00020f20: 7468 6520 7261 6e67 6520 6f66 2072 6573  the range of res
-00020f30: 6964 7565 732e 0a20 2020 2020 2020 2020  idues..         
-00020f40: 2020 2069 6620 7461 696c 203e 3d20 303a     if tail >= 0:
-00020f50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00020f60: 2066 6f72 2061 746f 6d20 696e 2072 6573   for atom in res
-00020f70: 6964 7565 5f61 746f 6d73 5f6c 6973 745b  idue_atoms_list[
-00020f80: 7461 696c 5d3a 0a20 2020 2020 2020 2020  tail]:.         
-00020f90: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-00020fa0: 6163 6375 6d75 6c61 746f 722e 6465 6c5f  accumulator.del_
-00020fb0: 6174 6f6d 2861 746f 6d29 0a0a 2020 2020  atom(atom)..    
-00020fc0: 2020 2020 2020 2020 2320 4578 7472 6163          # Extrac
-00020fd0: 7420 7468 6520 534d 4f43 2073 636f 7265  t the SMOC score
-00020fe0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-00020ff0: 6865 6164 202d 2068 616c 665f 7769 6e64  head - half_wind
-00021000: 6f77 203e 3d20 303a 0a20 2020 2020 2020  ow >= 0:.       
-00021010: 2020 2020 2020 2020 2073 636f 7265 732e           scores.
-00021020: 6170 7065 6e64 2873 656c 662e 6163 6375  append(self.accu
-00021030: 6d75 6c61 746f 722e 6765 745f 7661 6c28  mulator.get_val(
-00021040: 2929 0a0a 2020 2020 2020 2020 7265 7475  ))..        retu
-00021050: 726e 2073 636f 7265 730a 0a0a 636c 6173  rn scores...clas
-00021060: 7320 5f41 6273 7472 6163 7453 6c69 6469  s _AbstractSlidi
-00021070: 6e67 5363 6f72 653a 0a20 2020 2064 6566  ngScore:.    def
-00021080: 205f 5f69 6e69 745f 5f28 7365 6c66 2c20   __init__(self, 
-00021090: 7374 7275 6374 2c20 6163 6375 6d75 6c61  struct, accumula
-000210a0: 746f 7229 3a0a 2020 2020 2020 2020 6d61  tor):.        ma
-000210b0: 7070 696e 6720 3d20 7b7d 0a20 2020 2020  pping = {}.     
-000210c0: 2020 2066 6f72 2061 2069 6e20 7374 7275     for a in stru
-000210d0: 6374 2e61 746f 6d4c 6973 743a 0a20 2020  ct.atomList:.   
-000210e0: 2020 2020 2020 2020 2069 6620 6d61 7070           if mapp
-000210f0: 696e 672e 6765 7428 612e 6368 6169 6e29  ing.get(a.chain)
-00021100: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
-00021110: 2020 2020 2020 2020 2020 6d61 7070 696e            mappin
-00021120: 675b 612e 6368 6169 6e5d 203d 207b 7d0a  g[a.chain] = {}.
-00021130: 2020 2020 2020 2020 2020 2020 6966 206d              if m
-00021140: 6170 7069 6e67 5b61 2e63 6861 696e 5d2e  apping[a.chain].
-00021150: 6765 7428 612e 7265 735f 6e6f 2920 6973  get(a.res_no) is
-00021160: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
-00021170: 2020 2020 2020 206d 6170 7069 6e67 5b61         mapping[a
-00021180: 2e63 6861 696e 5d5b 612e 7265 735f 6e6f  .chain][a.res_no
-00021190: 5d20 3d20 5b5d 0a20 2020 2020 2020 2020  ] = [].         
-000211a0: 2020 206d 6170 7069 6e67 5b61 2e63 6861     mapping[a.cha
-000211b0: 696e 5d5b 612e 7265 735f 6e6f 5d2e 6170  in][a.res_no].ap
-000211c0: 7065 6e64 2861 290a 2020 2020 2020 2020  pend(a).        
-000211d0: 7365 6c66 2e6d 6170 7069 6e67 203d 206d  self.mapping = m
-000211e0: 6170 7069 6e67 0a20 2020 2020 2020 2073  apping.        s
-000211f0: 656c 662e 736c 6964 6572 203d 2053 6c69  elf.slider = Sli
-00021200: 6469 6e67 5265 7369 6475 6557 696e 646f  dingResidueWindo
-00021210: 7728 6163 6375 6d75 6c61 746f 7229 0a0a  w(accumulator)..
-00021220: 2020 2020 6465 6620 5f67 6574 5f63 6f6e      def _get_con
-00021230: 7469 6773 2873 656c 662c 2063 6861 696e  tigs(self, chain
-00021240: 293a 0a20 2020 2020 2020 2063 6f6e 7469  ):.        conti
-00021250: 6773 203d 205b 5b5d 5d0a 2020 2020 2020  gs = [[]].      
-00021260: 2020 666f 7220 7265 735f 6e75 6d20 696e    for res_num in
-00021270: 2073 656c 662e 6d61 7070 696e 675b 6368   self.mapping[ch
-00021280: 6169 6e5d 3a0a 2020 2020 2020 2020 2020  ain]:.          
-00021290: 2020 6c61 7374 203d 2063 6f6e 7469 6773    last = contigs
-000212a0: 5b2d 315d 0a20 2020 2020 2020 2020 2020  [-1].           
-000212b0: 2069 6620 6c65 6e28 6c61 7374 2920 3d3d   if len(last) ==
-000212c0: 2030 3a0a 2020 2020 2020 2020 2020 2020   0:.            
-000212d0: 2020 2020 6c61 7374 2e61 7070 656e 6428      last.append(
-000212e0: 7265 735f 6e75 6d29 0a20 2020 2020 2020  res_num).       
-000212f0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-00021300: 2020 2020 2020 2020 2020 2069 6620 6c61             if la
-00021310: 7374 5b2d 315d 202b 2031 203d 3d20 7265  st[-1] + 1 == re
-00021320: 735f 6e75 6d3a 0a20 2020 2020 2020 2020  s_num:.         
-00021330: 2020 2020 2020 2020 2020 206c 6173 742e             last.
-00021340: 6170 7065 6e64 2872 6573 5f6e 756d 290a  append(res_num).
-00021350: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021360: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-00021370: 2020 2020 2020 2020 2020 636f 6e74 6967            contig
-00021380: 732e 6170 7065 6e64 285b 7265 735f 6e75  s.append([res_nu
-00021390: 6d5d 290a 2020 2020 2020 2020 7265 7475  m]).        retu
-000213a0: 726e 2063 6f6e 7469 6773 0a0a 2020 2020  rn contigs..    
-000213b0: 6465 6620 7363 6f72 655f 6368 6169 6e5f  def score_chain_
-000213c0: 636f 6e74 6967 2873 656c 662c 2063 6861  contig(self, cha
-000213d0: 696e 2c20 7369 7a65 293a 0a20 2020 2020  in, size):.     
-000213e0: 2020 2022 2222 4765 6e65 7261 7465 2073     """Generate s
-000213f0: 6c69 6469 6e67 2077 696e 646f 7720 7363  liding window sc
-00021400: 6f72 6573 2077 6865 7265 2077 696e 646f  ores where windo
-00021410: 7773 2064 6f20 6e6f 7420 7370 616e 2063  ws do not span c
-00021420: 6861 696e 2062 7265 616b 732e 220a 0a20  hain breaks.".. 
-00021430: 2020 2020 2020 2054 6869 7320 6d65 7468         This meth
-00021440: 6f64 2063 6f6d 7075 7465 7320 736c 6964  od computes slid
-00021450: 696e 6720 7769 6e64 6f77 7320 6f76 6572  ing windows over
-00021460: 2065 6163 6820 636f 6e74 6967 756f 7573   each contiguous
-00021470: 2072 6567 696f 6e20 6f66 2074 6865 2063   region of the c
-00021480: 6861 696e 2e0a 0a20 2020 2020 2020 2041  hain...        A
-00021490: 7267 733a 0a20 2020 2020 2020 2020 2020  rgs:.           
-000214a0: 6368 6169 6e20 2873 7472 293a 2054 6865  chain (str): The
-000214b0: 2063 6861 696e 206e 616d 6520 746f 2067   chain name to g
-000214c0: 656e 6572 6174 6520 7769 6e64 6f77 2073  enerate window s
-000214d0: 636f 7265 732e 0a20 2020 2020 2020 2020  cores..         
-000214e0: 2020 7369 7a65 2028 696e 7429 3a20 5468    size (int): Th
-000214f0: 6520 7369 7a65 206f 6620 7468 6520 7769  e size of the wi
-00021500: 6e64 6f77 2e20 5368 6f75 6c64 2062 6520  ndow. Should be 
-00021510: 616e 206f 6464 206e 756d 6265 722e 0a20  an odd number.. 
-00021520: 2020 2020 2020 2052 6574 7572 6e73 3a0a         Returns:.
-00021530: 2020 2020 2020 2020 2020 2041 2064 6963             A dic
-00021540: 7469 6f6e 6172 7920 6d61 7070 696e 6720  tionary mapping 
-00021550: 6561 6368 2072 6573 6964 7565 2074 6f20  each residue to 
-00021560: 6974 7320 7363 6f72 652e 0a20 2020 2020  its score..     
-00021570: 2020 2022 2222 0a0a 2020 2020 2020 2020     """..        
-00021580: 7363 6f72 6573 203d 207b 7d0a 0a20 2020  scores = {}..   
-00021590: 2020 2020 2072 6573 5f6d 6170 7069 6e67       res_mapping
-000215a0: 203d 2073 656c 662e 6d61 7070 696e 675b   = self.mapping[
-000215b0: 6368 6169 6e5d 0a20 2020 2020 2020 2063  chain].        c
-000215c0: 6f6e 7469 6773 203d 2073 656c 662e 5f67  ontigs = self._g
-000215d0: 6574 5f63 6f6e 7469 6773 2863 6861 696e  et_contigs(chain
-000215e0: 290a 0a20 2020 2020 2020 2066 6f72 2063  )..        for c
-000215f0: 6f6e 7469 6720 696e 2063 6f6e 7469 6773  ontig in contigs
-00021600: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
-00021610: 7369 6475 655f 6174 6f6d 735f 6c69 7374  sidue_atoms_list
-00021620: 203d 205b 7265 735f 6d61 7070 696e 675b   = [res_mapping[
-00021630: 725d 2066 6f72 2072 2069 6e20 636f 6e74  r] for r in cont
-00021640: 6967 5d0a 2020 2020 2020 2020 2020 2020  ig].            
-00021650: 636f 6e74 6967 5f73 636f 7265 7320 3d20  contig_scores = 
-00021660: 7365 6c66 2e73 6c69 6465 722e 7363 6f72  self.slider.scor
-00021670: 6573 2872 6573 6964 7565 5f61 746f 6d73  es(residue_atoms
-00021680: 5f6c 6973 742c 2073 697a 6529 0a20 2020  _list, size).   
-00021690: 2020 2020 2020 2020 2066 6f72 206b 2c20           for k, 
-000216a0: 7620 696e 207a 6970 2863 6f6e 7469 672c  v in zip(contig,
-000216b0: 2063 6f6e 7469 675f 7363 6f72 6573 293a   contig_scores):
-000216c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000216d0: 2073 636f 7265 735b 6b5d 203d 2076 0a0a   scores[k] = v..
-000216e0: 2020 2020 2020 2020 7265 7475 726e 2073          return s
-000216f0: 636f 7265 730a 0a20 2020 2064 6566 2073  cores..    def s
-00021700: 636f 7265 5f63 6861 696e 5f73 7061 6e28  core_chain_span(
-00021710: 7365 6c66 2c20 6368 6169 6e2c 2073 697a  self, chain, siz
-00021720: 6529 3a0a 2020 2020 2020 2020 2222 2247  e):.        """G
-00021730: 656e 6572 6174 6520 736c 6964 696e 6720  enerate sliding 
-00021740: 7769 6e64 6f77 2073 636f 7265 7320 7768  window scores wh
-00021750: 6572 6520 7769 6e64 6f77 7320 646f 2073  ere windows do s
-00021760: 7061 6e20 6368 6169 6e20 6272 6561 6b73  pan chain breaks
-00021770: 2e0a 0a20 2020 2020 2020 2054 6869 7320  ...        This 
-00021780: 6d65 7468 6f64 2069 676e 6f72 6573 2061  method ignores a
-00021790: 6e79 2062 7265 616b 7320 696e 2074 6865  ny breaks in the
-000217a0: 2063 6861 696e 2c20 736f 2077 696e 646f   chain, so windo
-000217b0: 7773 206d 6179 2069 6e63 6c75 6465 2064  ws may include d
-000217c0: 6973 7461 6e74 2072 6573 6964 7565 732e  istant residues.
-000217d0: 0a0a 2020 2020 2020 2020 4172 6773 3a0a  ..        Args:.
-000217e0: 2020 2020 2020 2020 2020 2063 6861 696e             chain
-000217f0: 2028 7374 7229 3a20 5468 6520 6368 6169   (str): The chai
-00021800: 6e20 6e61 6d65 2074 6f20 6765 6e65 7261  n name to genera
-00021810: 7465 2077 696e 646f 7720 7363 6f72 6573  te window scores
-00021820: 2e0a 2020 2020 2020 2020 2020 2073 697a  ..           siz
-00021830: 6520 2869 6e74 293a 2054 6865 2073 697a  e (int): The siz
-00021840: 6520 6f66 2074 6865 2077 696e 646f 772e  e of the window.
-00021850: 2053 686f 756c 6420 6265 2061 6e20 6f64   Should be an od
-00021860: 6420 6e75 6d62 6572 2e0a 2020 2020 2020  d number..      
-00021870: 2020 5265 7475 726e 733a 0a20 2020 2020    Returns:.     
-00021880: 2020 2020 2020 4120 6469 6374 696f 6e61        A dictiona
-00021890: 7279 206d 6170 7069 6e67 2065 6163 6820  ry mapping each 
-000218a0: 7265 7369 6475 6520 746f 2069 7473 2073  residue to its s
-000218b0: 636f 7265 2e0a 2020 2020 2020 2020 2222  core..        ""
-000218c0: 220a 2020 2020 2020 2020 7265 7369 6475  ".        residu
-000218d0: 655f 6d61 7070 696e 6720 3d20 7365 6c66  e_mapping = self
-000218e0: 2e6d 6170 7069 6e67 5b63 6861 696e 5d0a  .mapping[chain].
-000218f0: 2020 2020 2020 2020 7265 7369 6475 655f          residue_
-00021900: 6174 6f6d 735f 6c69 7374 203d 206c 6973  atoms_list = lis
-00021910: 7428 7265 7369 6475 655f 6d61 7070 696e  t(residue_mappin
-00021920: 672e 7661 6c75 6573 2829 290a 2020 2020  g.values()).    
-00021930: 2020 2020 6e75 6d62 6572 7320 3d20 7265      numbers = re
-00021940: 7369 6475 655f 6d61 7070 696e 672e 6b65  sidue_mapping.ke
-00021950: 7973 2829 0a20 2020 2020 2020 2073 636f  ys().        sco
-00021960: 7265 7320 3d20 7365 6c66 2e73 6c69 6465  res = self.slide
-00021970: 722e 7363 6f72 6573 2872 6573 6964 7565  r.scores(residue
-00021980: 5f61 746f 6d73 5f6c 6973 742c 2073 697a  _atoms_list, siz
-00021990: 6529 0a0a 2020 2020 2020 2020 7265 7475  e)..        retu
-000219a0: 726e 207b 6b3a 2076 2066 6f72 206b 2c20  rn {k: v for k, 
-000219b0: 7620 696e 207a 6970 286e 756d 6265 7273  v in zip(numbers
-000219c0: 2c20 7363 6f72 6573 297d 0a0a 0a63 6c61  , scores)}...cla
-000219d0: 7373 205f 4163 6375 6d75 6c61 746f 723a  ss _Accumulator:
-000219e0: 0a20 2020 2022 2222 416e 2061 6363 756d  .    """An accum
-000219f0: 756c 6174 6f72 2063 6f6d 7075 7465 7320  ulator computes 
-00021a00: 6120 7363 6f72 6520 6f76 6572 2061 2073  a score over a s
-00021a10: 6c69 6469 6e67 2077 696e 646f 7720 6f66  liding window of
-00021a20: 2061 746f 6d73 2222 220a 0a20 2020 2064   atoms"""..    d
-00021a30: 6566 2061 6464 5f61 746f 6d28 7365 6c66  ef add_atom(self
-00021a40: 2c20 6174 6f6d 293a 0a20 2020 2020 2020  , atom):.       
-00021a50: 2070 6173 730a 0a20 2020 2064 6566 2064   pass..    def d
-00021a60: 656c 5f61 746f 6d28 7365 6c66 2c20 6174  el_atom(self, at
-00021a70: 6f6d 293a 0a20 2020 2020 2020 2070 6173  om):.        pas
-00021a80: 730a 0a20 2020 2064 6566 2067 6574 5f76  s..    def get_v
-00021a90: 616c 2873 656c 6629 3a0a 2020 2020 2020  al(self):.      
-00021aa0: 2020 7061 7373 0a0a 2020 2020 6465 6620    pass..    def 
-00021ab0: 7a65 726f 2873 656c 6629 3a0a 2020 2020  zero(self):.    
-00021ac0: 2020 2020 7061 7373 0a0a 0a63 6c61 7373      pass...class
-00021ad0: 205f 4d4f 4341 6363 756d 756c 6174 6f72   _MOCAccumulator
-00021ae0: 285f 4163 6375 6d75 6c61 746f 7229 3a0a  (_Accumulator):.
-00021af0: 2020 2020 2222 2250 6c61 6365 686f 6c64      """Placehold
-00021b00: 6572 2064 6f63 7374 7269 6e67 0a20 2020  er docstring.   
-00021b10: 2022 2222 0a0a 2020 2020 6465 6620 5f5f   """..    def __
-00021b20: 696e 6974 5f5f 2873 656c 662c 2065 7870  init__(self, exp
-00021b30: 5f6d 6170 2c20 7369 6d5f 6d61 702c 2072  _map, sim_map, r
-00021b40: 6164 6975 7329 3a0a 2020 2020 2020 2020  adius):.        
-00021b50: 6672 6f6d 206d 6174 6820 696d 706f 7274  from math import
-00021b60: 2063 6569 6c2c 206c 6f67 2c20 706f 770a   ceil, log, pow.
-00021b70: 2020 2020 2020 2020 696d 706f 7274 2076          import v
-00021b80: 6f78 636f 7620 6173 2076 630a 0a20 2020  oxcov as vc..   
-00021b90: 2020 2020 206d 6178 5f64 696d 203d 206d       max_dim = m
-00021ba0: 6178 2865 7870 5f6d 6170 2e62 6f78 5f73  ax(exp_map.box_s
-00021bb0: 697a 6528 2929 0a20 2020 2020 2020 206e  ize()).        n
-00021bc0: 6578 745f 706f 7732 203d 2069 6e74 2870  ext_pow2 = int(p
-00021bd0: 6f77 2832 2c20 6365 696c 286c 6f67 286d  ow(2, ceil(log(m
-00021be0: 6178 5f64 696d 2920 2f20 6c6f 6728 3229  ax_dim) / log(2)
-00021bf0: 2929 290a 2020 2020 2020 2020 7365 6c66  ))).        self
-00021c00: 2e72 6164 6975 7320 3d20 7261 6469 7573  .radius = radius
-00021c10: 0a0a 2020 2020 2020 2020 7365 6c66 2e6d  ..        self.m
-00021c20: 6f63 203d 2076 632e 534d 4f43 280a 2020  oc = vc.SMOC(.  
-00021c30: 2020 2020 2020 2020 2020 6578 705f 6d61            exp_ma
-00021c40: 702e 6170 6978 2c0a 2020 2020 2020 2020  p.apix,.        
-00021c50: 2020 2020 6578 705f 6d61 702e 6f72 6967      exp_map.orig
-00021c60: 696e 2c0a 2020 2020 2020 2020 2020 2020  in,.            
-00021c70: 6e65 7874 5f70 6f77 322c 0a20 2020 2020  next_pow2,.     
-00021c80: 2020 2020 2020 205b 6578 705f 6d61 702e         [exp_map.
-00021c90: 785f 7369 7a65 2829 2c20 6578 705f 6d61  x_size(), exp_ma
-00021ca0: 702e 795f 7369 7a65 2829 2c20 6578 705f  p.y_size(), exp_
-00021cb0: 6d61 702e 7a5f 7369 7a65 2829 5d2c 0a20  map.z_size()],. 
-00021cc0: 2020 2020 2020 2020 2020 206e 702e 6173             np.as
-00021cd0: 636f 6e74 6967 756f 7573 6172 7261 7928  contiguousarray(
-00021ce0: 6578 705f 6d61 702e 6675 6c6c 4d61 702c  exp_map.fullMap,
-00021cf0: 2064 7479 7065 3d22 666c 6f61 7436 3422   dtype="float64"
-00021d00: 292c 0a20 2020 2020 2020 2020 2020 206e  ),.            n
-00021d10: 702e 6173 636f 6e74 6967 756f 7573 6172  p.ascontiguousar
-00021d20: 7261 7928 7369 6d5f 6d61 702e 6675 6c6c  ray(sim_map.full
-00021d30: 4d61 702c 2064 7479 7065 3d22 666c 6f61  Map, dtype="floa
-00021d40: 7436 3422 292c 0a20 2020 2020 2020 2029  t64"),.        )
-00021d50: 0a0a 2020 2020 6465 6620 6164 645f 6174  ..    def add_at
-00021d60: 6f6d 2873 656c 662c 2061 746f 6d29 3a0a  om(self, atom):.
-00021d70: 2020 2020 2020 2020 7365 6c66 2e6d 6f63          self.moc
-00021d80: 2e61 6464 5f73 7068 6572 6528 5b61 746f  .add_sphere([ato
-00021d90: 6d2e 782c 2061 746f 6d2e 792c 2061 746f  m.x, atom.y, ato
-00021da0: 6d2e 7a5d 2c20 7365 6c66 2e72 6164 6975  m.z], self.radiu
-00021db0: 7329 0a0a 2020 2020 6465 6620 6465 6c5f  s)..    def del_
-00021dc0: 6174 6f6d 2873 656c 662c 2061 746f 6d29  atom(self, atom)
-00021dd0: 3a0a 2020 2020 2020 2020 7365 6c66 2e6d  :.        self.m
-00021de0: 6f63 2e64 656c 5f73 7068 6572 6528 5b61  oc.del_sphere([a
-00021df0: 746f 6d2e 782c 2061 746f 6d2e 792c 2061  tom.x, atom.y, a
-00021e00: 746f 6d2e 7a5d 2c20 7365 6c66 2e72 6164  tom.z], self.rad
-00021e10: 6975 7329 0a0a 2020 2020 6465 6620 6765  ius)..    def ge
-00021e20: 745f 7661 6c28 7365 6c66 293a 0a20 2020  t_val(self):.   
-00021e30: 2020 2020 2072 6574 7572 6e20 7365 6c66       return self
-00021e40: 2e6d 6f63 2e67 6574 5f76 616c 2829 0a0a  .moc.get_val()..
-00021e50: 2020 2020 6465 6620 7a65 726f 2873 656c      def zero(sel
-00021e60: 6629 3a0a 2020 2020 2020 2020 7365 6c66  f):.        self
-00021e70: 2e6d 6f63 2e7a 6572 6f28 290a 0a0a 636c  .moc.zero()...cl
-00021e80: 6173 7320 5f4d 4941 6363 756d 756c 6174  ass _MIAccumulat
-00021e90: 6f72 285f 4163 6375 6d75 6c61 746f 7229  or(_Accumulator)
-00021ea0: 3a0a 2020 2020 2222 2249 6e63 7265 6d65  :.    """Increme
-00021eb0: 6e74 616c 2063 616c 6375 6c61 7469 6f6e  ntal calculation
-00021ec0: 206f 6620 4d49 2073 636f 7265 206f 7665   of MI score ove
-00021ed0: 7220 766f 7865 6c73 0a20 2020 2063 6f76  r voxels.    cov
-00021ee0: 6572 6564 2062 7920 6174 6f6d 732e 2222  ered by atoms.""
-00021ef0: 220a 0a20 2020 2064 6566 205f 5f69 6e69  "..    def __ini
-00021f00: 745f 5f28 7365 6c66 2c20 6578 705f 6d61  t__(self, exp_ma
-00021f10: 702c 2073 696d 5f6d 6170 2c20 7261 6469  p, sim_map, radi
-00021f20: 7573 2c20 785f 6269 6e73 2c20 795f 6269  us, x_bins, y_bi
-00021f30: 6e73 293a 0a20 2020 2020 2020 2066 726f  ns):.        fro
-00021f40: 6d20 6d61 7468 2069 6d70 6f72 7420 6365  m math import ce
-00021f50: 696c 2c20 6c6f 672c 2070 6f77 0a20 2020  il, log, pow.   
-00021f60: 2020 2020 2069 6d70 6f72 7420 766f 7863       import voxc
-00021f70: 6f76 2061 7320 7663 0a0a 2020 2020 2020  ov as vc..      
-00021f80: 2020 6d61 785f 6469 6d20 3d20 6d61 7828    max_dim = max(
-00021f90: 6578 705f 6d61 702e 626f 785f 7369 7a65  exp_map.box_size
-00021fa0: 2829 290a 2020 2020 2020 2020 6e65 7874  ()).        next
-00021fb0: 5f70 6f77 3220 3d20 696e 7428 706f 7728  _pow2 = int(pow(
-00021fc0: 322c 2063 6569 6c28 6c6f 6728 6d61 785f  2, ceil(log(max_
-00021fd0: 6469 6d29 202f 206c 6f67 2832 2929 2929  dim) / log(2))))
-00021fe0: 0a20 2020 2020 2020 2073 656c 662e 7261  .        self.ra
-00021ff0: 6469 7573 203d 2033 0a20 2020 2020 2020  dius = 3.       
-00022000: 2073 656c 662e 6578 705f 6d61 7020 3d20   self.exp_map = 
-00022010: 6578 705f 6d61 700a 2020 2020 2020 2020  exp_map.        
-00022020: 7365 6c66 2e73 696d 5f6d 6170 203d 2073  self.sim_map = s
-00022030: 696d 5f6d 6170 0a0a 2020 2020 2020 2020  im_map..        
-00022040: 7365 6c66 2e6d 6920 3d20 7663 2e53 4d49  self.mi = vc.SMI
-00022050: 280a 2020 2020 2020 2020 2020 2020 6578  (.            ex
-00022060: 705f 6d61 702e 6170 6978 2c0a 2020 2020  p_map.apix,.    
-00022070: 2020 2020 2020 2020 6578 705f 6d61 702e          exp_map.
-00022080: 6f72 6967 696e 2c0a 2020 2020 2020 2020  origin,.        
-00022090: 2020 2020 6e65 7874 5f70 6f77 322c 0a20      next_pow2,. 
-000220a0: 2020 2020 2020 2020 2020 205b 6578 705f             [exp_
-000220b0: 6d61 702e 785f 7369 7a65 2829 2c20 6578  map.x_size(), ex
-000220c0: 705f 6d61 702e 795f 7369 7a65 2829 2c20  p_map.y_size(), 
-000220d0: 6578 705f 6d61 702e 7a5f 7369 7a65 2829  exp_map.z_size()
-000220e0: 5d2c 0a20 2020 2020 2020 2020 2020 206e  ],.            n
-000220f0: 702e 6173 636f 6e74 6967 756f 7573 6172  p.ascontiguousar
-00022100: 7261 7928 7369 6d5f 6d61 702e 6675 6c6c  ray(sim_map.full
-00022110: 4d61 702c 2064 7479 7065 3d22 666c 6f61  Map, dtype="floa
-00022120: 7436 3422 292c 0a20 2020 2020 2020 2020  t64"),.         
-00022130: 2020 206e 702e 6173 636f 6e74 6967 756f     np.ascontiguo
-00022140: 7573 6172 7261 7928 6578 705f 6d61 702e  usarray(exp_map.
-00022150: 6675 6c6c 4d61 702c 2064 7479 7065 3d22  fullMap, dtype="
-00022160: 666c 6f61 7436 3422 292c 0a20 2020 2020  float64"),.     
-00022170: 2020 2020 2020 206e 702e 6d69 6e28 6578         np.min(ex
-00022180: 705f 6d61 702e 6675 6c6c 4d61 7029 2c0a  p_map.fullMap),.
-00022190: 2020 2020 2020 2020 2020 2020 6e70 2e6d              np.m
-000221a0: 6178 2865 7870 5f6d 6170 2e66 756c 6c4d  ax(exp_map.fullM
-000221b0: 6170 292c 0a20 2020 2020 2020 2020 2020  ap),.           
-000221c0: 206e 702e 6d69 6e28 7369 6d5f 6d61 702e   np.min(sim_map.
-000221d0: 6675 6c6c 4d61 7029 2c0a 2020 2020 2020  fullMap),.      
-000221e0: 2020 2020 2020 6e70 2e6d 6178 2873 696d        np.max(sim
-000221f0: 5f6d 6170 2e66 756c 6c4d 6170 292c 0a20  _map.fullMap),. 
-00022200: 2020 2020 2020 2020 2020 2078 5f62 696e             x_bin
-00022210: 732c 2079 5f62 696e 730a 2020 2020 2020  s, y_bins.      
-00022220: 2020 290a 0a20 2020 2064 6566 2061 6464    )..    def add
-00022230: 5f61 746f 6d28 7365 6c66 2c20 6174 6f6d  _atom(self, atom
-00022240: 293a 0a20 2020 2020 2020 2073 656c 662e  ):.        self.
-00022250: 6d69 2e61 6464 5f73 7068 6572 6528 0a20  mi.add_sphere(. 
-00022260: 2020 2020 2020 2020 2020 205b 6174 6f6d             [atom
-00022270: 2e78 2c20 6174 6f6d 2e79 2c20 6174 6f6d  .x, atom.y, atom
-00022280: 2e7a 5d2c 0a20 2020 2020 2020 2020 2020  .z],.           
-00022290: 2073 656c 662e 7261 6469 7573 2c0a 2020   self.radius,.  
-000222a0: 2020 2020 2020 290a 0a20 2020 2064 6566        )..    def
-000222b0: 2064 656c 5f61 746f 6d28 7365 6c66 2c20   del_atom(self, 
-000222c0: 6174 6f6d 293a 0a20 2020 2020 2020 2073  atom):.        s
-000222d0: 656c 662e 6d69 2e64 656c 5f73 7068 6572  elf.mi.del_spher
-000222e0: 6528 0a20 2020 2020 2020 2020 2020 205b  e(.            [
-000222f0: 6174 6f6d 2e78 2c20 6174 6f6d 2e79 2c20  atom.x, atom.y, 
-00022300: 6174 6f6d 2e7a 5d2c 0a20 2020 2020 2020  atom.z],.       
-00022310: 2020 2020 2073 656c 662e 7261 6469 7573       self.radius
-00022320: 2c0a 2020 2020 2020 2020 290a 0a20 2020  ,.        )..   
-00022330: 2023 204e 6f74 2073 7472 6963 746c 7920   # Not strictly 
-00022340: 6573 7365 6e74 6961 6c2c 2062 7574 2049  essential, but I
-00022350: 2073 686f 756c 6420 6164 6420 7a65 726f   should add zero
-00022360: 696e 6720 746f 2044 6966 664d 6170 2069  ing to DiffMap i
-00022370: 6e20 766f 7863 6f76 2e0a 2020 2020 6465  n voxcov..    de
-00022380: 6620 7a65 726f 2873 656c 6629 3a0a 2020  f zero(self):.  
-00022390: 2020 2020 2020 7365 6c66 2e6d 692e 7a65        self.mi.ze
-000223a0: 726f 2829 0a0a 2020 2020 2320 5265 7475  ro()..    # Retu
-000223b0: 726e 2063 7572 7265 6e74 204d 4920 7661  rn current MI va
-000223c0: 6c75 650a 2020 2020 6465 6620 6765 745f  lue.    def get_
-000223d0: 7661 6c28 7365 6c66 293a 0a20 2020 2020  val(self):.     
-000223e0: 2020 2072 6574 7572 6e20 7365 6c66 2e6d     return self.m
-000223f0: 692e 6765 745f 7661 6c28 290a 0a0a 636c  i.get_val()...cl
-00022400: 6173 7320 4c6f 6361 6c4d 4928 5f41 6273  ass LocalMI(_Abs
-00022410: 7472 6163 7453 6c69 6469 6e67 5363 6f72  tractSlidingScor
-00022420: 6529 3a0a 2020 2020 2222 220a 2020 2020  e):.    """.    
-00022430: 2222 220a 2020 2020 6465 6620 5f5f 696e  """.    def __in
-00022440: 6974 5f5f 2873 656c 662c 2073 7472 7563  it__(self, struc
-00022450: 742c 2065 7870 5f6d 6170 2c20 7369 6d5f  t, exp_map, sim_
-00022460: 6d61 702c 2072 6573 6f6c 7574 696f 6e2c  map, resolution,
-00022470: 2072 6164 6975 732c 206e 6f5f 6269 6e73   radius, no_bins
-00022480: 3d32 3029 3a0a 2020 2020 2020 2020 7369  =20):.        si
-00022490: 676d 615f 636f 6566 663d 302e 3232 350a  gma_coeff=0.225.
-000224a0: 0a20 2020 2020 2020 2073 656c 662e 6578  .        self.ex
-000224b0: 705f 6d61 7020 3d20 6578 705f 6d61 700a  p_map = exp_map.
-000224c0: 2020 2020 2020 2020 7365 6c66 2e73 696d          self.sim
-000224d0: 5f6d 6170 203d 2073 696d 5f6d 6170 0a20  _map = sim_map. 
-000224e0: 2020 2020 2020 2073 656c 662e 7261 6469         self.radi
-000224f0: 7573 203d 2072 6164 6975 730a 2020 2020  us = radius.    
-00022500: 2020 2020 7365 6c66 2e6e 6f5f 6269 6e73      self.no_bins
-00022510: 203d 206e 6f5f 6269 6e73 0a0a 2020 2020   = no_bins..    
-00022520: 2020 2020 6966 2073 696d 5f6d 6170 2069      if sim_map i
-00022530: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
-00022540: 2020 2020 7369 6d5f 6d61 7020 3d20 5374      sim_map = St
-00022550: 7275 6374 7572 6542 6c75 7272 6572 2829  ructureBlurrer()
-00022560: 2e67 6175 7373 6961 6e5f 626c 7572 5f72  .gaussian_blur_r
-00022570: 6561 6c5f 7370 6163 6528 0a20 2020 2020  eal_space(.     
-00022580: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-00022590: 7472 7563 742c 0a20 2020 2020 2020 2020  truct,.         
-000225a0: 2020 2020 2020 2020 2020 2072 6573 6f6c             resol
-000225b0: 7574 696f 6e2c 0a20 2020 2020 2020 2020  ution,.         
-000225c0: 2020 2020 2020 2020 2020 2065 7870 5f6d             exp_m
-000225d0: 6170 2c0a 2020 2020 2020 2020 2020 2020  ap,.            
-000225e0: 2020 2020 2020 2020 7369 676d 615f 636f          sigma_co
-000225f0: 6566 663d 7369 676d 615f 636f 6566 660a  eff=sigma_coeff.
-00022600: 2020 2020 2020 2020 2020 2020 290a 0a20              ).. 
-00022610: 2020 2020 2020 206d 6920 3d20 5f4d 4941         mi = _MIA
-00022620: 6363 756d 756c 6174 6f72 2865 7870 5f6d  ccumulator(exp_m
-00022630: 6170 2c20 7369 6d5f 6d61 702c 2072 6164  ap, sim_map, rad
-00022640: 6975 732c 206e 6f5f 6269 6e73 2c20 6e6f  ius, no_bins, no
-00022650: 5f62 696e 7329 0a20 2020 2020 2020 2073  _bins).        s
-00022660: 7570 6572 2829 2e5f 5f69 6e69 745f 5f28  uper().__init__(
-00022670: 7374 7275 6374 2c20 6d69 290a 0a0a 636c  struct, mi)...cl
-00022680: 6173 7320 4661 7374 534d 4f43 285f 4162  ass FastSMOC(_Ab
-00022690: 7374 7261 6374 536c 6964 696e 6753 636f  stractSlidingSco
-000226a0: 7265 293a 0a20 2020 2022 2222 4120 6661  re):.    """A fa
-000226b0: 7374 6572 2076 6572 7369 6f6e 206f 6620  ster version of 
-000226c0: 7468 6520 736c 6964 696e 6720 7769 6e64  the sliding wind
-000226d0: 6f77 2053 4d4f 4320 7363 6f72 652e 0a0a  ow SMOC score...
-000226e0: 2020 2020 556e 6c69 6b65 2074 6865 206f      Unlike the o
-000226f0: 7269 6769 6e61 6c20 616c 676f 7269 7468  riginal algorith
-00022700: 6d2c 2074 6869 7320 6f6e 6573 2069 7320  m, this ones is 
-00022710: 6f70 7469 6d69 7a65 6420 696e 2074 6865  optimized in the
-00022720: 0a20 2020 2066 6f6c 6c6f 7769 6e67 2077  .    following w
-00022730: 6179 733a 0a0a 2020 2020 2a20 6c61 7a69  ays:..    * lazi
-00022740: 6c79 2064 6574 6572 6d69 6e65 7320 7265  ly determines re
-00022750: 7175 6972 6564 2076 6f78 656c 7320 7361  quired voxels sa
-00022760: 7669 6e67 2073 7061 6365 2061 6e64 2074  ving space and t
-00022770: 696d 652e 0a20 2020 202a 2054 6865 2073  ime..    * The s
-00022780: 6c69 6469 6e67 2d77 696e 646f 7720 6361  liding-window ca
-00022790: 6c63 756c 6174 696f 6e20 6973 2070 6572  lculation is per
-000227a0: 666f 726d 6564 2069 6e20 7469 6d65 2070  formed in time p
-000227b0: 726f 706f 7274 696f 6e61 6c0a 2020 2020  roportional.    
-000227c0: 2020 6f6e 6c79 2074 6f20 6368 6169 6e20    only to chain 
-000227d0: 7369 7a65 2061 6e64 206e 6f74 2077 696e  size and not win
-000227e0: 646f 7720 7369 7a65 2e0a 0a20 2020 2054  dow size...    T
-000227f0: 6869 7320 6d65 7468 6f64 2064 6f65 7320  his method does 
-00022800: 6e6f 7420 6f66 6665 7220 616c 6c20 7468  not offer all th
-00022810: 6520 6265 6c6c 7320 616e 6420 7768 6973  e bells and whis
-00022820: 746c 6573 206f 6620 6f6c 6420 534d 4f43  tles of old SMOC
-00022830: 0a20 2020 2066 756e 6374 696f 6e20 7375  .    function su
-00022840: 6368 2061 7320 7269 6769 6420 626f 6479  ch as rigid body
-00022850: 2070 6172 616d 6574 6572 732e 2020 486f   parameters.  Ho
-00022860: 7765 7665 722c 2074 776f 2061 6c74 6572  wever, two alter
-00022870: 6e61 7469 7665 0a20 2020 206d 6574 686f  native.    metho
-00022880: 6473 2061 7265 2070 726f 7669 6465 6420  ds are provided 
-00022890: 666f 7220 6465 616c 696e 6720 7769 7468  for dealing with
-000228a0: 2053 4d4f 4320 7363 6f72 6573 2066 6f72   SMOC scores for
-000228b0: 2075 6e6d 6f64 656c 6c65 640a 2020 2020   unmodelled.    
-000228c0: 7265 6769 6f6e 732e 0a0a 2020 2020 5468  regions...    Th
-000228d0: 6520 6675 6e63 7469 6f6e 2060 7363 6f72  e function `scor
-000228e0: 655f 6368 6169 6e5f 636f 6e74 6967 602c  e_chain_contig`,
-000228f0: 2077 696c 6c20 7363 6f72 6520 616c 6c20   will score all 
-00022900: 636f 6e74 6967 7320 696e 2061 0a20 2020  contigs in a.   
-00022910: 2063 6861 696e 2077 6865 7265 2065 6163   chain where eac
-00022920: 6820 7769 6e64 6f77 206f 6e6c 7920 636f  h window only co
-00022930: 6e74 6169 6e73 2072 6573 6964 7565 7320  ntains residues 
-00022940: 6265 6c6f 6e67 696e 6720 746f 2074 6865  belonging to the
-00022950: 0a20 2020 2063 6f6e 7469 672e 0a0a 2020  .    contig...  
-00022960: 2020 5468 6520 6675 6e63 7469 6f6e 2060    The function `
-00022970: 7363 6f72 655f 6368 6169 6e5f 7370 616e  score_chain_span
-00022980: 6020 6d69 6d69 636b 7320 7468 6520 6f6c  ` mimicks the ol
-00022990: 6420 534d 4f43 2062 6568 6176 696f 7572  d SMOC behaviour
-000229a0: 2e0a 2020 2020 5769 6e64 6f77 7320 6967  ..    Windows ig
-000229b0: 6e6f 7265 2063 6f6e 7469 6773 2062 6f75  nore contigs bou
-000229c0: 6e64 6172 6965 7320 2874 6865 7920 2773  ndaries (they 's
-000229d0: 7061 6e27 2074 6865 6d29 2c20 7468 7573  pan' them), thus
-000229e0: 2072 6573 6964 7565 730a 2020 2020 696e   residues.    in
-000229f0: 2077 696e 646f 7773 206d 6179 2062 6520   windows may be 
-00022a00: 7068 7973 6963 616c 6c79 2064 6973 7461  physically dista
-00022a10: 6e74 2e0a 0a20 2020 2049 6e20 6765 6e65  nt...    In gene
-00022a20: 7261 6c2c 2074 6865 2063 6f6e 7369 6465  ral, the conside
-00022a30: 7220 7573 696e 6720 7468 6520 6073 636f  r using the `sco
-00022a40: 7265 5f63 6861 696e 5f63 6f6e 7469 6760  re_chain_contig`
-00022a50: 206d 6574 686f 642e 0a0a 0a20 2020 2041   method....    A
-00022a60: 7267 733a 0a20 2020 2020 2020 2073 7472  rgs:.        str
-00022a70: 7563 7420 283a 636c 6173 733a 6042 696f  uct (:class:`Bio
-00022a80: 5079 5f53 7472 7563 7475 7265 203c 5445  Py_Structure <TE
-00022a90: 4d50 792e 7072 6f74 6569 6e2e 7072 6f74  MPy.protein.prot
-00022aa0: 5f72 6570 5f62 696f 7079 2e42 696f 5079  _rep_biopy.BioPy
-00022ab0: 5f53 7472 7563 7475 7265 3e60 293a 204d  _Structure>`): M
-00022ac0: 6f64 656c 2074 6f20 7363 6f72 650a 2020  odel to score.  
-00022ad0: 2020 2020 2020 6578 705f 6d61 7020 283a        exp_map (:
-00022ae0: 636c 6173 733a 6045 4d4d 6170 203c 5445  class:`EMMap <TE
-00022af0: 4d50 792e 6d61 7073 2e65 6d5f 6d61 702e  MPy.maps.em_map.
-00022b00: 4d61 703e 6029 3a20 4578 7065 7269 6d65  Map>`): Experime
-00022b10: 6e74 616c 2064 656e 7369 7479 206d 6170  ntal density map
-00022b20: 0a20 2020 2020 2020 2072 6573 6f6c 7574  .        resolut
-00022b30: 696f 6e20 2866 6c6f 6174 293a 2054 6865  ion (float): The
-00022b40: 2072 6573 6f6c 7574 696f 6e20 6f66 2074   resolution of t
-00022b50: 6865 2065 7870 6572 696d 656e 7461 6c20  he experimental 
-00022b60: 6d61 700a 2020 2020 2020 2020 7369 676d  map.        sigm
-00022b70: 615f 636f 6566 6620 2866 6c6f 6174 2c20  a_coeff (float, 
-00022b80: 6f70 7469 6f6e 616c 293a 2054 6865 2073  optional): The s
-00022b90: 6967 6d61 2063 6f65 6666 6963 6965 6e74  igma coefficient
-00022ba0: 2066 6f72 2073 696d 756c 6174 696e 6720   for simulating 
-00022bb0: 7468 6520 6d61 702e 2044 6566 6175 6c74  the map. Default
-00022bc0: 7320 746f 2030 2e32 3235 2e0a 2020 2020  s to 0.225..    
-00022bd0: 2020 2020 7369 676d 615f 7468 7265 7368      sigma_thresh
-00022be0: 6f6c 6420 2866 6c6f 6174 2c20 6f70 7469  old (float, opti
-00022bf0: 6f6e 616c 293a 2054 6865 2073 6967 6d61  onal): The sigma
-00022c00: 2074 6872 6573 686f 6c64 2064 6574 6572   threshold deter
-00022c10: 6d69 6e65 7320 7468 6520 7261 6469 7573  mines the radius
-00022c20: 2061 726f 756e 6420 7468 6520 6174 6f6d   around the atom
-00022c30: 7320 746f 2063 6f6e 7369 6465 722e 2044  s to consider. D
-00022c40: 6566 6175 6c74 7320 746f 2032 2e35 2e0a  efaults to 2.5..
-00022c50: 2020 2020 2020 2020 7369 6d5f 6d61 7020          sim_map 
-00022c60: 2845 4d4d 6170 2c20 6f70 7469 6f6e 616c  (EMMap, optional
-00022c70: 293a 2041 2073 696d 756c 6174 6564 206d  ): A simulated m
-00022c80: 6170 2074 6f20 7573 6520 696e 7374 6561  ap to use instea
-00022c90: 6420 6f66 2067 656e 6572 6174 696e 6720  d of generating 
-00022ca0: 6f6e 652e 0a20 2020 2052 6574 7572 6e73  one..    Returns
-00022cb0: 3a0a 2020 2020 2020 2020 4661 7374 534d  :.        FastSM
-00022cc0: 4f43 206f 626a 6563 740a 2020 2020 2222  OC object.    ""
-00022cd0: 220a 0a20 2020 2064 6566 205f 5f69 6e69  "..    def __ini
-00022ce0: 745f 5f28 0a20 2020 2020 2020 2073 656c  t__(.        sel
-00022cf0: 662c 0a20 2020 2020 2020 2073 7472 7563  f,.        struc
-00022d00: 742c 0a20 2020 2020 2020 2065 7870 5f6d  t,.        exp_m
-00022d10: 6170 2c0a 2020 2020 2020 2020 7265 736f  ap,.        reso
-00022d20: 6c75 7469 6f6e 2c0a 2020 2020 2020 2020  lution,.        
-00022d30: 7369 676d 615f 636f 6566 663d 302e 3232  sigma_coeff=0.22
-00022d40: 352c 0a20 2020 2020 2020 2073 6967 6d61  5,.        sigma
-00022d50: 5f74 6872 6573 686f 6c64 3d32 2e35 2c0a  _threshold=2.5,.
-00022d60: 2020 2020 2020 2020 7369 6d5f 6d61 703d          sim_map=
-00022d70: 4e6f 6e65 2c0a 2020 2020 2020 2020 6c6f  None,.        lo
-00022d80: 6372 6573 3d4e 6f6e 652c 0a20 2020 2029  cres=None,.    )
-00022d90: 3a0a 2020 2020 2020 2020 7261 6469 7573  :.        radius
-00022da0: 203d 2073 6967 6d61 5f74 6872 6573 686f   = sigma_thresho
-00022db0: 6c64 202a 206d 6178 2873 6967 6d61 5f63  ld * max(sigma_c
-00022dc0: 6f65 6666 202a 2072 6573 6f6c 7574 696f  oeff * resolutio
-00022dd0: 6e2c 2031 2e30 290a 2020 2020 2020 2020  n, 1.0).        
-00022de0: 6966 2073 696d 5f6d 6170 2069 7320 4e6f  if sim_map is No
-00022df0: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
-00022e00: 7369 6d5f 6d61 7020 3d20 5374 7275 6374  sim_map = Struct
-00022e10: 7572 6542 6c75 7272 6572 286c 6f63 7265  ureBlurrer(locre
-00022e20: 733d 6c6f 6372 6573 292e 6761 7573 7369  s=locres).gaussi
-00022e30: 616e 5f62 6c75 725f 7265 616c 5f73 7061  an_blur_real_spa
-00022e40: 6365 280a 2020 2020 2020 2020 2020 2020  ce(.            
-00022e50: 2020 2020 2020 2020 7374 7275 6374 2c0a          struct,.
-00022e60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022e70: 2020 2020 7265 736f 6c75 7469 6f6e 2c0a      resolution,.
-00022e80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022e90: 2020 2020 6578 705f 6d61 702c 0a20 2020      exp_map,.   
-00022ea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022eb0: 2073 6967 6d61 5f63 6f65 6666 3d73 6967   sigma_coeff=sig
-00022ec0: 6d61 5f63 6f65 6666 0a20 2020 2020 2020  ma_coeff.       
-00022ed0: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
-00022ee0: 6d6f 6320 3d20 5f4d 4f43 4163 6375 6d75  moc = _MOCAccumu
-00022ef0: 6c61 746f 7228 6578 705f 6d61 702c 2073  lator(exp_map, s
-00022f00: 696d 5f6d 6170 2c20 7261 6469 7573 290a  im_map, radius).
-00022f10: 2020 2020 2020 2020 7375 7065 7228 292e          super().
-00022f20: 5f5f 696e 6974 5f5f 2873 7472 7563 742c  __init__(struct,
-00022f30: 206d 6f63 290a 0a0a 636c 6173 7320 4661   moc)...class Fa
-00022f40: 7374 5343 4343 3a0a 2020 2020 6465 6620  stSCCC:.    def 
-00022f50: 5f5f 696e 6974 5f5f 280a 2020 2020 2020  __init__(.      
-00022f60: 2020 2020 2020 7365 6c66 2c0a 2020 2020        self,.    
-00022f70: 2020 2020 2020 2020 7374 7275 6374 7572          structur
-00022f80: 652c 0a20 2020 2020 2020 2020 2020 206d  e,.            m
-00022f90: 6170 5f74 6172 6765 742c 0a20 2020 2020  ap_target,.     
-00022fa0: 2020 2020 2020 2072 6573 6f6c 7574 696f         resolutio
-00022fb0: 6e2c 0a20 2020 2020 2020 2020 2020 2073  n,.            s
-00022fc0: 6967 6d61 5f63 6f65 6666 3d30 2e32 3235  igma_coeff=0.225
-00022fd0: 2c0a 2020 2020 293a 0a20 2020 2020 2020  ,.    ):.       
-00022fe0: 2022 2222 4361 6c63 756c 6174 6520 6c6f   """Calculate lo
-00022ff0: 6361 6c20 6372 6f73 732d 636f 7272 656c  cal cross-correl
-00023000: 6174 696f 6e20 666f 7220 6120 7365 676d  ation for a segm
-00023010: 656e 7420 6f66 2061 2070 726f 7465 696e  ent of a protein
-00023020: 206d 6f64 656c 2e0a 0a20 2020 2020 2020   model...       
-00023030: 2041 7267 733a 0a20 2020 2020 2020 2020   Args:.         
-00023040: 2020 2073 7472 7563 7475 7265 3a20 5468     structure: Th
-00023050: 6520 656e 7469 7265 2061 746f 6d69 6320  e entire atomic 
-00023060: 7374 7275 6374 7572 650a 2020 2020 2020  structure.      
-00023070: 2020 2020 2020 6d61 705f 7461 7267 6574        map_target
-00023080: 3a20 416e 2065 7870 6572 696d 656e 7461  : An experimenta
-00023090: 6c20 6d61 702e 0a20 2020 2020 2020 2020  l map..         
-000230a0: 2020 2072 6573 6f6c 7574 696f 6e3a 2054     resolution: T
-000230b0: 6865 2073 6573 6f6c 7574 696f 6e20 6f66  he sesolution of
-000230c0: 2074 6865 2065 7870 6572 696d 656e 7461   the experimenta
-000230d0: 6c20 6d61 702e 0a20 2020 2020 2020 2020  l map..         
-000230e0: 2020 2073 6967 6d61 5f63 6f65 6666 3a20     sigma_coeff: 
-000230f0: 5468 6520 7369 676d 6120 636f 6566 6669  The sigma coeffi
-00023100: 6369 656e 7420 666f 7220 626c 7572 7269  cient for blurri
-00023110: 6e67 2e0a 2020 2020 2020 2020 2020 2020  ng..            
-00023120: 2020 2020 3a72 6566 3a60 6865 7265 3c4e      :ref:`here<N
-00023130: 6f74 6520 6f6e 2072 6561 6c20 7370 6163  ote on real spac
-00023140: 6520 626c 7572 7269 6e67 3a3e 600a 2020  e blurring:>`.  
-00023150: 2020 2020 2020 5265 7475 726e 733a 0a20        Returns:. 
-00023160: 2020 2020 2020 2020 2020 2041 2053 4343             A SCC
-00023170: 4320 6f62 6a65 6374 2e0a 2020 2020 2020  C object..      
-00023180: 2020 2222 220a 2020 2020 2020 2020 7365    """.        se
-00023190: 6c66 2e62 6c75 7272 6572 203d 2053 7472  lf.blurrer = Str
-000231a0: 7563 7475 7265 426c 7572 7265 7228 290a  uctureBlurrer().
-000231b0: 2020 2020 2020 2020 7365 6c66 2e73 636f          self.sco
-000231c0: 7265 7220 3d20 5363 6f72 696e 6746 756e  rer = ScoringFun
-000231d0: 6374 696f 6e73 2829 0a20 2020 2020 2020  ctions().       
-000231e0: 2073 656c 662e 6d61 705f 7461 7267 6574   self.map_target
-000231f0: 203d 206d 6170 5f74 6172 6765 740a 2020   = map_target.  
-00023200: 2020 2020 2020 7365 6c66 2e72 6573 6f6c        self.resol
-00023210: 7574 696f 6e20 3d20 7265 736f 6c75 7469  ution = resoluti
-00023220: 6f6e 0a20 2020 2020 2020 2073 656c 662e  on.        self.
-00023230: 7369 676d 615f 636f 6566 6620 3d20 7369  sigma_coeff = si
-00023240: 676d 615f 636f 6566 660a 2020 2020 2020  gma_coeff.      
-00023250: 2020 7365 6c66 2e77 686f 6c65 5f73 696d    self.whole_sim
-00023260: 5f6d 6170 203d 2073 656c 662e 626c 7572  _map = self.blur
-00023270: 7265 722e 6761 7573 7369 616e 5f62 6c75  rer.gaussian_blu
-00023280: 725f 7265 616c 5f73 7061 6365 280a 2020  r_real_space(.  
-00023290: 2020 2020 2020 2020 2020 7374 7275 6374            struct
-000232a0: 7572 652c 0a20 2020 2020 2020 2020 2020  ure,.           
-000232b0: 2072 6573 6f6c 7574 696f 6e2c 0a20 2020   resolution,.   
-000232c0: 2020 2020 2020 2020 2064 656e 734d 6170           densMap
-000232d0: 3d6d 6170 5f74 6172 6765 742c 0a20 2020  =map_target,.   
-000232e0: 2020 2020 2020 2020 2073 6967 6d61 5f63           sigma_c
-000232f0: 6f65 6666 3d73 6967 6d61 5f63 6f65 6666  oeff=sigma_coeff
-00023300: 2c0a 2020 2020 2020 2020 2020 2020 6e6f  ,.            no
-00023310: 726d 616c 6973 653d 5472 7565 2c0a 2020  rmalise=True,.  
-00023320: 2020 2020 2020 290a 0a20 2020 2064 6566        )..    def
-00023330: 2073 636f 7265 5f73 6567 6d65 6e74 2873   score_segment(s
-00023340: 656c 662c 2073 6567 6d65 6e74 5f73 7472  elf, segment_str
-00023350: 7563 7475 7265 293a 0a20 2020 2020 2020  ucture):.       
-00023360: 2022 2222 5363 6f72 6520 6120 7365 676d   """Score a segm
-00023370: 656e 7420 6f66 2074 6865 2073 7472 7563  ent of the struc
-00023380: 7475 7265 2e0a 0a20 2020 2020 2020 2041  ture...        A
-00023390: 7267 733a 0a20 2020 2020 2020 2020 2020  rgs:.           
-000233a0: 2073 6567 6d65 6e74 3a20 416e 2061 746f   segment: An ato
-000233b0: 6d69 6320 7374 7275 6374 7572 6520 7768  mic structure wh
-000233c0: 6963 6820 7368 6f75 6c64 2062 6520 6120  ich should be a 
-000233d0: 636f 6d70 6f6e 656e 740a 2020 2020 2020  component.      
-000233e0: 2020 5265 7475 726e 733a 0a20 2020 2020    Returns:.     
-000233f0: 2020 2020 2020 2043 4343 2073 636f 7265         CCC score
-00023400: 3a20 2866 6c6f 6174 290a 2020 2020 2020  : (float).      
-00023410: 2020 2222 220a 2020 2020 2020 2020 7365    """.        se
-00023420: 676d 656e 745f 7369 6d5f 6d61 7020 3d20  gment_sim_map = 
-00023430: 7365 6c66 2e62 6c75 7272 6572 2e67 6175  self.blurrer.gau
-00023440: 7373 6961 6e5f 626c 7572 5f72 6561 6c5f  ssian_blur_real_
-00023450: 7370 6163 6528 0a20 2020 2020 2020 2020  space(.         
-00023460: 2020 2073 6567 6d65 6e74 5f73 7472 7563     segment_struc
-00023470: 7475 7265 2c0a 2020 2020 2020 2020 2020  ture,.          
-00023480: 2020 7365 6c66 2e72 6573 6f6c 7574 696f    self.resolutio
-00023490: 6e2c 0a20 2020 2020 2020 2020 2020 2073  n,.            s
-000234a0: 656c 662e 6d61 705f 7461 7267 6574 2c0a  elf.map_target,.
-000234b0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-000234c0: 2e73 6967 6d61 5f63 6f65 6666 2c0a 2020  .sigma_coeff,.  
-000234d0: 2020 2020 2020 2020 2020 6e6f 726d 616c            normal
-000234e0: 6973 653d 5472 7565 2c0a 2020 2020 2020  ise=True,.      
-000234f0: 2020 290a 2020 2020 2020 2020 6d69 6e44    ).        minD
-00023500: 656e 7320 3d20 7365 676d 656e 745f 7369  ens = segment_si
-00023510: 6d5f 6d61 702e 7374 6428 290a 2020 2020  m_map.std().    
-00023520: 2020 2020 7365 676d 656e 745f 6d61 736b      segment_mask
-00023530: 203d 2073 6567 6d65 6e74 5f73 696d 5f6d   = segment_sim_m
-00023540: 6170 2e5f 6765 745f 6d61 736b 4172 7261  ap._get_maskArra
-00023550: 7928 6d69 6e44 656e 7329 0a20 2020 2020  y(minDens).     
-00023560: 2020 2074 6172 6765 745f 6d61 736b 6564     target_masked
-00023570: 203d 2073 656c 662e 6d61 705f 7461 7267   = self.map_targ
-00023580: 6574 2e5f 6765 745f 6d61 736b 4d61 7028  et._get_maskMap(
-00023590: 7365 676d 656e 745f 6d61 736b 290a 2020  segment_mask).  
-000235a0: 2020 2020 2020 7369 6d5f 6d61 736b 6564        sim_masked
-000235b0: 203d 2073 656c 662e 7768 6f6c 655f 7369   = self.whole_si
-000235c0: 6d5f 6d61 702e 5f67 6574 5f6d 6173 6b4d  m_map._get_maskM
-000235d0: 6170 2873 6567 6d65 6e74 5f6d 6173 6b29  ap(segment_mask)
-000235e0: 0a20 2020 2020 2020 2073 7365 2c20 5f20  .        sse, _ 
-000235f0: 3d20 7365 6c66 2e73 636f 7265 722e 4343  = self.scorer.CC
-00023600: 435f 6d61 7028 7461 7267 6574 5f6d 6173  C_map(target_mas
-00023610: 6b65 642c 2073 696d 5f6d 6173 6b65 642c  ked, sim_masked,
-00023620: 2063 6d6f 6465 3d46 616c 7365 290a 2020   cmode=False).  
-00023630: 2020 2020 2020 7265 7475 726e 2073 7365        return sse
-00023640: 0a                                       .
+00020b40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020b50: 2020 2020 2020 2020 2020 2020 2020 6861                ha
+00020b60: 6c66 5f6d 6170 312e 6675 6c6c 4d61 702c  lf_map1.fullMap,
+00020b70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00020b80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020b90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020ba0: 2068 616c 665f 6d61 7032 2e66 756c 6c4d   half_map2.fullM
+00020bb0: 6170 2c0a 2020 2020 2020 2020 2020 2020  ap,.            
+00020bc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020bd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020be0: 2020 2020 6d61 736b 2e66 756c 6c4d 6170      mask.fullMap
+00020bf0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00020c00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020c10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020c20: 2020 7069 7865 6c5f 7369 7a65 3d68 616c    pixel_size=hal
+00020c30: 665f 6d61 7031 2e61 7069 785b 305d 2c29  f_map1.apix[0],)
+00020c40: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
+00020c50: 2020 2020 2020 2020 2020 2066 7363 203d             fsc =
+00020c60: 2066 6f75 7269 6572 2e63 616c 6375 6c61   fourier.calcula
+00020c70: 7465 5f66 7363 2868 616c 665f 6d61 7031  te_fsc(half_map1
+00020c80: 2e66 756c 6c4d 6170 2c0a 2020 2020 2020  .fullMap,.      
+00020c90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020ca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020cb0: 2020 6861 6c66 5f6d 6170 322e 6675 6c6c    half_map2.full
+00020cc0: 4d61 702c 0a20 2020 2020 2020 2020 2020  Map,.           
+00020cd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020ce0: 2020 2020 2020 2020 2020 2020 2070 6978               pix
+00020cf0: 656c 5f73 697a 653d 6861 6c66 5f6d 6170  el_size=half_map
+00020d00: 312e 6170 6978 5b30 5d2c 290a 0a20 2020  1.apix[0],)..   
+00020d10: 2020 2020 2072 6573 6f6c 7574 696f 6e20       resolution 
+00020d20: 3d20 666f 7572 6965 722e 6765 745f 6673  = fourier.get_fs
+00020d30: 635f 7265 736f 6c75 7469 6f6e 280a 2020  c_resolution(.  
+00020d40: 2020 2020 2020 2020 2020 6673 632c 2066            fsc, f
+00020d50: 7363 5f74 6872 6573 686f 6c64 3d66 7363  sc_threshold=fsc
+00020d60: 5f74 6872 6573 686f 6c64 2c0a 2020 2020  _threshold,.    
+00020d70: 2020 2020 2020 2020 7573 655f 6869 6768          use_high
+00020d80: 6573 745f 7265 736f 6c75 7469 6f6e 3d75  est_resolution=u
+00020d90: 7365 5f68 6967 6865 7374 5f72 6573 6f6c  se_highest_resol
+00020da0: 7574 696f 6e2c 0a20 2020 2020 2020 2020  ution,.         
+00020db0: 2020 2069 6e74 6572 706f 6c61 7465 5f63     interpolate_c
+00020dc0: 7574 6f66 663d 4661 6c73 6529 0a0a 2020  utoff=False)..  
+00020dd0: 2020 2020 2020 7265 7475 726e 2072 6573        return res
+00020de0: 6f6c 7574 696f 6e0a 0a0a 636c 6173 7320  olution...class 
+00020df0: 536c 6964 696e 6752 6573 6964 7565 5769  SlidingResidueWi
+00020e00: 6e64 6f77 3a0a 2020 2020 6465 6620 5f5f  ndow:.    def __
+00020e10: 696e 6974 5f5f 2873 656c 662c 2061 6363  init__(self, acc
+00020e20: 756d 756c 6174 6f72 293a 0a20 2020 2020  umulator):.     
+00020e30: 2020 2073 656c 662e 6163 6375 6d75 6c61     self.accumula
+00020e40: 746f 7220 3d20 6163 6375 6d75 6c61 746f  tor = accumulato
+00020e50: 720a 0a20 2020 2064 6566 2073 636f 7265  r..    def score
+00020e60: 7328 7365 6c66 2c20 7265 7369 6475 655f  s(self, residue_
+00020e70: 6174 6f6d 735f 6c69 7374 2c20 7369 7a65  atoms_list, size
+00020e80: 293a 0a20 2020 2020 2020 2073 656c 662e  ):.        self.
+00020e90: 6163 6375 6d75 6c61 746f 722e 7a65 726f  accumulator.zero
+00020ea0: 2829 0a0a 2020 2020 2020 2020 6861 6c66  ()..        half
+00020eb0: 5f77 696e 646f 7720 3d20 696e 7428 2873  _window = int((s
+00020ec0: 697a 6520 2d20 3129 202f 2032 290a 0a20  ize - 1) / 2).. 
+00020ed0: 2020 2020 2020 2073 636f 7265 7320 3d20         scores = 
+00020ee0: 5b5d 0a20 2020 2020 2020 2066 6f72 2068  [].        for h
+00020ef0: 6561 6420 696e 2072 616e 6765 2830 2c20  ead in range(0, 
+00020f00: 6c65 6e28 7265 7369 6475 655f 6174 6f6d  len(residue_atom
+00020f10: 735f 6c69 7374 2920 2b20 6861 6c66 5f77  s_list) + half_w
+00020f20: 696e 646f 7729 3a0a 2020 2020 2020 2020  indow):.        
+00020f30: 2020 2020 7461 696c 203d 2068 6561 6420      tail = head 
+00020f40: 2d20 7369 7a65 0a0a 2020 2020 2020 2020  - size..        
+00020f50: 2020 2020 2320 5768 696c 6520 7468 6520      # While the 
+00020f60: 6865 6164 2069 7320 7769 7468 2069 6e20  head is with in 
+00020f70: 7468 6520 616c 6c6f 7765 6420 7261 6e67  the allowed rang
+00020f80: 652c 2075 7365 2061 6c6c 2074 6865 2076  e, use all the v
+00020f90: 6f78 656c 730a 2020 2020 2020 2020 2020  oxels.          
+00020fa0: 2020 2320 6173 736f 6369 6174 6564 2077    # associated w
+00020fb0: 6974 6820 7468 6520 7265 7369 6475 6573  ith the residues
+00020fc0: 2061 746f 6d73 2e0a 2020 2020 2020 2020   atoms..        
+00020fd0: 2020 2020 6966 2068 6561 6420 3c20 6c65      if head < le
+00020fe0: 6e28 7265 7369 6475 655f 6174 6f6d 735f  n(residue_atoms_
+00020ff0: 6c69 7374 293a 0a20 2020 2020 2020 2020  list):.         
+00021000: 2020 2020 2020 2066 6f72 2061 746f 6d20         for atom 
+00021010: 696e 2072 6573 6964 7565 5f61 746f 6d73  in residue_atoms
+00021020: 5f6c 6973 745b 6865 6164 5d3a 0a20 2020  _list[head]:.   
+00021030: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021040: 2073 656c 662e 6163 6375 6d75 6c61 746f   self.accumulato
+00021050: 722e 6164 645f 6174 6f6d 2861 746f 6d29  r.add_atom(atom)
+00021060: 0a0a 2020 2020 2020 2020 2020 2020 2320  ..            # 
+00021070: 4472 6f70 2074 6865 2074 6169 6c20 6966  Drop the tail if
+00021080: 2069 7420 7769 7468 696e 2074 6865 2072   it within the r
+00021090: 616e 6765 206f 6620 7265 7369 6475 6573  ange of residues
+000210a0: 2e0a 2020 2020 2020 2020 2020 2020 6966  ..            if
+000210b0: 2074 6169 6c20 3e3d 2030 3a0a 2020 2020   tail >= 0:.    
+000210c0: 2020 2020 2020 2020 2020 2020 666f 7220              for 
+000210d0: 6174 6f6d 2069 6e20 7265 7369 6475 655f  atom in residue_
+000210e0: 6174 6f6d 735f 6c69 7374 5b74 6169 6c5d  atoms_list[tail]
+000210f0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00021100: 2020 2020 2020 7365 6c66 2e61 6363 756d        self.accum
+00021110: 756c 6174 6f72 2e64 656c 5f61 746f 6d28  ulator.del_atom(
+00021120: 6174 6f6d 290a 0a20 2020 2020 2020 2020  atom)..         
+00021130: 2020 2023 2045 7874 7261 6374 2074 6865     # Extract the
+00021140: 2053 4d4f 4320 7363 6f72 650a 2020 2020   SMOC score.    
+00021150: 2020 2020 2020 2020 6966 2068 6561 6420          if head 
+00021160: 2d20 6861 6c66 5f77 696e 646f 7720 3e3d  - half_window >=
+00021170: 2030 3a0a 2020 2020 2020 2020 2020 2020   0:.            
+00021180: 2020 2020 7363 6f72 6573 2e61 7070 656e      scores.appen
+00021190: 6428 7365 6c66 2e61 6363 756d 756c 6174  d(self.accumulat
+000211a0: 6f72 2e67 6574 5f76 616c 2829 290a 0a20  or.get_val()).. 
+000211b0: 2020 2020 2020 2072 6574 7572 6e20 7363         return sc
+000211c0: 6f72 6573 0a0a 0a63 6c61 7373 205f 4162  ores...class _Ab
+000211d0: 7374 7261 6374 536c 6964 696e 6753 636f  stractSlidingSco
+000211e0: 7265 3a0a 2020 2020 6465 6620 5f5f 696e  re:.    def __in
+000211f0: 6974 5f5f 2873 656c 662c 2073 7472 7563  it__(self, struc
+00021200: 742c 2061 6363 756d 756c 6174 6f72 293a  t, accumulator):
+00021210: 0a20 2020 2020 2020 206d 6170 7069 6e67  .        mapping
+00021220: 203d 207b 7d0a 2020 2020 2020 2020 666f   = {}.        fo
+00021230: 7220 6120 696e 2073 7472 7563 742e 6174  r a in struct.at
+00021240: 6f6d 4c69 7374 3a0a 2020 2020 2020 2020  omList:.        
+00021250: 2020 2020 6966 206d 6170 7069 6e67 2e67      if mapping.g
+00021260: 6574 2861 2e63 6861 696e 2920 6973 204e  et(a.chain) is N
+00021270: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
+00021280: 2020 2020 206d 6170 7069 6e67 5b61 2e63       mapping[a.c
+00021290: 6861 696e 5d20 3d20 7b7d 0a20 2020 2020  hain] = {}.     
+000212a0: 2020 2020 2020 2069 6620 6d61 7070 696e         if mappin
+000212b0: 675b 612e 6368 6169 6e5d 2e67 6574 2861  g[a.chain].get(a
+000212c0: 2e72 6573 5f6e 6f29 2069 7320 4e6f 6e65  .res_no) is None
+000212d0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+000212e0: 2020 6d61 7070 696e 675b 612e 6368 6169    mapping[a.chai
+000212f0: 6e5d 5b61 2e72 6573 5f6e 6f5d 203d 205b  n][a.res_no] = [
+00021300: 5d0a 2020 2020 2020 2020 2020 2020 6d61  ].            ma
+00021310: 7070 696e 675b 612e 6368 6169 6e5d 5b61  pping[a.chain][a
+00021320: 2e72 6573 5f6e 6f5d 2e61 7070 656e 6428  .res_no].append(
+00021330: 6129 0a20 2020 2020 2020 2073 656c 662e  a).        self.
+00021340: 6d61 7070 696e 6720 3d20 6d61 7070 696e  mapping = mappin
+00021350: 670a 2020 2020 2020 2020 7365 6c66 2e73  g.        self.s
+00021360: 6c69 6465 7220 3d20 536c 6964 696e 6752  lider = SlidingR
+00021370: 6573 6964 7565 5769 6e64 6f77 2861 6363  esidueWindow(acc
+00021380: 756d 756c 6174 6f72 290a 0a20 2020 2064  umulator)..    d
+00021390: 6566 205f 6765 745f 636f 6e74 6967 7328  ef _get_contigs(
+000213a0: 7365 6c66 2c20 6368 6169 6e29 3a0a 2020  self, chain):.  
+000213b0: 2020 2020 2020 636f 6e74 6967 7320 3d20        contigs = 
+000213c0: 5b5b 5d5d 0a20 2020 2020 2020 2066 6f72  [[]].        for
+000213d0: 2072 6573 5f6e 756d 2069 6e20 7365 6c66   res_num in self
+000213e0: 2e6d 6170 7069 6e67 5b63 6861 696e 5d3a  .mapping[chain]:
+000213f0: 0a20 2020 2020 2020 2020 2020 206c 6173  .            las
+00021400: 7420 3d20 636f 6e74 6967 735b 2d31 5d0a  t = contigs[-1].
+00021410: 2020 2020 2020 2020 2020 2020 6966 206c              if l
+00021420: 656e 286c 6173 7429 203d 3d20 303a 0a20  en(last) == 0:. 
+00021430: 2020 2020 2020 2020 2020 2020 2020 206c                 l
+00021440: 6173 742e 6170 7065 6e64 2872 6573 5f6e  ast.append(res_n
+00021450: 756d 290a 2020 2020 2020 2020 2020 2020  um).            
+00021460: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+00021470: 2020 2020 2020 6966 206c 6173 745b 2d31        if last[-1
+00021480: 5d20 2b20 3120 3d3d 2072 6573 5f6e 756d  ] + 1 == res_num
+00021490: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+000214a0: 2020 2020 2020 6c61 7374 2e61 7070 656e        last.appen
+000214b0: 6428 7265 735f 6e75 6d29 0a20 2020 2020  d(res_num).     
+000214c0: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
+000214d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000214e0: 2020 2020 2063 6f6e 7469 6773 2e61 7070       contigs.app
+000214f0: 656e 6428 5b72 6573 5f6e 756d 5d29 0a20  end([res_num]). 
+00021500: 2020 2020 2020 2072 6574 7572 6e20 636f         return co
+00021510: 6e74 6967 730a 0a20 2020 2064 6566 2073  ntigs..    def s
+00021520: 636f 7265 5f63 6861 696e 5f63 6f6e 7469  core_chain_conti
+00021530: 6728 7365 6c66 2c20 6368 6169 6e2c 2073  g(self, chain, s
+00021540: 697a 6529 3a0a 2020 2020 2020 2020 2222  ize):.        ""
+00021550: 2247 656e 6572 6174 6520 736c 6964 696e  "Generate slidin
+00021560: 6720 7769 6e64 6f77 2073 636f 7265 7320  g window scores 
+00021570: 7768 6572 6520 7769 6e64 6f77 7320 646f  where windows do
+00021580: 206e 6f74 2073 7061 6e20 6368 6169 6e20   not span chain 
+00021590: 6272 6561 6b73 2e22 0a0a 2020 2020 2020  breaks."..      
+000215a0: 2020 5468 6973 206d 6574 686f 6420 636f    This method co
+000215b0: 6d70 7574 6573 2073 6c69 6469 6e67 2077  mputes sliding w
+000215c0: 696e 646f 7773 206f 7665 7220 6561 6368  indows over each
+000215d0: 2063 6f6e 7469 6775 6f75 7320 7265 6769   contiguous regi
+000215e0: 6f6e 206f 6620 7468 6520 6368 6169 6e2e  on of the chain.
+000215f0: 0a0a 2020 2020 2020 2020 4172 6773 3a0a  ..        Args:.
+00021600: 2020 2020 2020 2020 2020 2063 6861 696e             chain
+00021610: 2028 7374 7229 3a20 5468 6520 6368 6169   (str): The chai
+00021620: 6e20 6e61 6d65 2074 6f20 6765 6e65 7261  n name to genera
+00021630: 7465 2077 696e 646f 7720 7363 6f72 6573  te window scores
+00021640: 2e0a 2020 2020 2020 2020 2020 2073 697a  ..           siz
+00021650: 6520 2869 6e74 293a 2054 6865 2073 697a  e (int): The siz
+00021660: 6520 6f66 2074 6865 2077 696e 646f 772e  e of the window.
+00021670: 2053 686f 756c 6420 6265 2061 6e20 6f64   Should be an od
+00021680: 6420 6e75 6d62 6572 2e0a 2020 2020 2020  d number..      
+00021690: 2020 5265 7475 726e 733a 0a20 2020 2020    Returns:.     
+000216a0: 2020 2020 2020 4120 6469 6374 696f 6e61        A dictiona
+000216b0: 7279 206d 6170 7069 6e67 2065 6163 6820  ry mapping each 
+000216c0: 7265 7369 6475 6520 746f 2069 7473 2073  residue to its s
+000216d0: 636f 7265 2e0a 2020 2020 2020 2020 2222  core..        ""
+000216e0: 220a 0a20 2020 2020 2020 2073 636f 7265  "..        score
+000216f0: 7320 3d20 7b7d 0a0a 2020 2020 2020 2020  s = {}..        
+00021700: 7265 735f 6d61 7070 696e 6720 3d20 7365  res_mapping = se
+00021710: 6c66 2e6d 6170 7069 6e67 5b63 6861 696e  lf.mapping[chain
+00021720: 5d0a 2020 2020 2020 2020 636f 6e74 6967  ].        contig
+00021730: 7320 3d20 7365 6c66 2e5f 6765 745f 636f  s = self._get_co
+00021740: 6e74 6967 7328 6368 6169 6e29 0a0a 2020  ntigs(chain)..  
+00021750: 2020 2020 2020 666f 7220 636f 6e74 6967        for contig
+00021760: 2069 6e20 636f 6e74 6967 733a 0a20 2020   in contigs:.   
+00021770: 2020 2020 2020 2020 2072 6573 6964 7565           residue
+00021780: 5f61 746f 6d73 5f6c 6973 7420 3d20 5b72  _atoms_list = [r
+00021790: 6573 5f6d 6170 7069 6e67 5b72 5d20 666f  es_mapping[r] fo
+000217a0: 7220 7220 696e 2063 6f6e 7469 675d 0a20  r r in contig]. 
+000217b0: 2020 2020 2020 2020 2020 2063 6f6e 7469             conti
+000217c0: 675f 7363 6f72 6573 203d 2073 656c 662e  g_scores = self.
+000217d0: 736c 6964 6572 2e73 636f 7265 7328 7265  slider.scores(re
+000217e0: 7369 6475 655f 6174 6f6d 735f 6c69 7374  sidue_atoms_list
+000217f0: 2c20 7369 7a65 290a 2020 2020 2020 2020  , size).        
+00021800: 2020 2020 666f 7220 6b2c 2076 2069 6e20      for k, v in 
+00021810: 7a69 7028 636f 6e74 6967 2c20 636f 6e74  zip(contig, cont
+00021820: 6967 5f73 636f 7265 7329 3a0a 2020 2020  ig_scores):.    
+00021830: 2020 2020 2020 2020 2020 2020 7363 6f72              scor
+00021840: 6573 5b6b 5d20 3d20 760a 0a20 2020 2020  es[k] = v..     
+00021850: 2020 2072 6574 7572 6e20 7363 6f72 6573     return scores
+00021860: 0a0a 2020 2020 6465 6620 7363 6f72 655f  ..    def score_
+00021870: 6368 6169 6e5f 7370 616e 2873 656c 662c  chain_span(self,
+00021880: 2063 6861 696e 2c20 7369 7a65 293a 0a20   chain, size):. 
+00021890: 2020 2020 2020 2022 2222 4765 6e65 7261         """Genera
+000218a0: 7465 2073 6c69 6469 6e67 2077 696e 646f  te sliding windo
+000218b0: 7720 7363 6f72 6573 2077 6865 7265 2077  w scores where w
+000218c0: 696e 646f 7773 2064 6f20 7370 616e 2063  indows do span c
+000218d0: 6861 696e 2062 7265 616b 732e 0a0a 2020  hain breaks...  
+000218e0: 2020 2020 2020 5468 6973 206d 6574 686f        This metho
+000218f0: 6420 6967 6e6f 7265 7320 616e 7920 6272  d ignores any br
+00021900: 6561 6b73 2069 6e20 7468 6520 6368 6169  eaks in the chai
+00021910: 6e2c 2073 6f20 7769 6e64 6f77 7320 6d61  n, so windows ma
+00021920: 7920 696e 636c 7564 6520 6469 7374 616e  y include distan
+00021930: 7420 7265 7369 6475 6573 2e0a 0a20 2020  t residues...   
+00021940: 2020 2020 2041 7267 733a 0a20 2020 2020       Args:.     
+00021950: 2020 2020 2020 6368 6169 6e20 2873 7472        chain (str
+00021960: 293a 2054 6865 2063 6861 696e 206e 616d  ): The chain nam
+00021970: 6520 746f 2067 656e 6572 6174 6520 7769  e to generate wi
+00021980: 6e64 6f77 2073 636f 7265 732e 0a20 2020  ndow scores..   
+00021990: 2020 2020 2020 2020 7369 7a65 2028 696e          size (in
+000219a0: 7429 3a20 5468 6520 7369 7a65 206f 6620  t): The size of 
+000219b0: 7468 6520 7769 6e64 6f77 2e20 5368 6f75  the window. Shou
+000219c0: 6c64 2062 6520 616e 206f 6464 206e 756d  ld be an odd num
+000219d0: 6265 722e 0a20 2020 2020 2020 2052 6574  ber..        Ret
+000219e0: 7572 6e73 3a0a 2020 2020 2020 2020 2020  urns:.          
+000219f0: 2041 2064 6963 7469 6f6e 6172 7920 6d61   A dictionary ma
+00021a00: 7070 696e 6720 6561 6368 2072 6573 6964  pping each resid
+00021a10: 7565 2074 6f20 6974 7320 7363 6f72 652e  ue to its score.
+00021a20: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
+00021a30: 2020 2020 2072 6573 6964 7565 5f6d 6170       residue_map
+00021a40: 7069 6e67 203d 2073 656c 662e 6d61 7070  ping = self.mapp
+00021a50: 696e 675b 6368 6169 6e5d 0a20 2020 2020  ing[chain].     
+00021a60: 2020 2072 6573 6964 7565 5f61 746f 6d73     residue_atoms
+00021a70: 5f6c 6973 7420 3d20 6c69 7374 2872 6573  _list = list(res
+00021a80: 6964 7565 5f6d 6170 7069 6e67 2e76 616c  idue_mapping.val
+00021a90: 7565 7328 2929 0a20 2020 2020 2020 206e  ues()).        n
+00021aa0: 756d 6265 7273 203d 2072 6573 6964 7565  umbers = residue
+00021ab0: 5f6d 6170 7069 6e67 2e6b 6579 7328 290a  _mapping.keys().
+00021ac0: 2020 2020 2020 2020 7363 6f72 6573 203d          scores =
+00021ad0: 2073 656c 662e 736c 6964 6572 2e73 636f   self.slider.sco
+00021ae0: 7265 7328 7265 7369 6475 655f 6174 6f6d  res(residue_atom
+00021af0: 735f 6c69 7374 2c20 7369 7a65 290a 0a20  s_list, size).. 
+00021b00: 2020 2020 2020 2072 6574 7572 6e20 7b6b         return {k
+00021b10: 3a20 7620 666f 7220 6b2c 2076 2069 6e20  : v for k, v in 
+00021b20: 7a69 7028 6e75 6d62 6572 732c 2073 636f  zip(numbers, sco
+00021b30: 7265 7329 7d0a 0a0a 636c 6173 7320 5f41  res)}...class _A
+00021b40: 6363 756d 756c 6174 6f72 3a0a 2020 2020  ccumulator:.    
+00021b50: 2222 2241 6e20 6163 6375 6d75 6c61 746f  """An accumulato
+00021b60: 7220 636f 6d70 7574 6573 2061 2073 636f  r computes a sco
+00021b70: 7265 206f 7665 7220 6120 736c 6964 696e  re over a slidin
+00021b80: 6720 7769 6e64 6f77 206f 6620 6174 6f6d  g window of atom
+00021b90: 7322 2222 0a0a 2020 2020 6465 6620 6164  s"""..    def ad
+00021ba0: 645f 6174 6f6d 2873 656c 662c 2061 746f  d_atom(self, ato
+00021bb0: 6d29 3a0a 2020 2020 2020 2020 7061 7373  m):.        pass
+00021bc0: 0a0a 2020 2020 6465 6620 6465 6c5f 6174  ..    def del_at
+00021bd0: 6f6d 2873 656c 662c 2061 746f 6d29 3a0a  om(self, atom):.
+00021be0: 2020 2020 2020 2020 7061 7373 0a0a 2020          pass..  
+00021bf0: 2020 6465 6620 6765 745f 7661 6c28 7365    def get_val(se
+00021c00: 6c66 293a 0a20 2020 2020 2020 2070 6173  lf):.        pas
+00021c10: 730a 0a20 2020 2064 6566 207a 6572 6f28  s..    def zero(
+00021c20: 7365 6c66 293a 0a20 2020 2020 2020 2070  self):.        p
+00021c30: 6173 730a 0a0a 636c 6173 7320 5f4d 4f43  ass...class _MOC
+00021c40: 4163 6375 6d75 6c61 746f 7228 5f41 6363  Accumulator(_Acc
+00021c50: 756d 756c 6174 6f72 293a 0a20 2020 2022  umulator):.    "
+00021c60: 2222 506c 6163 6568 6f6c 6465 7220 646f  ""Placeholder do
+00021c70: 6373 7472 696e 670a 2020 2020 2222 220a  cstring.    """.
+00021c80: 0a20 2020 2064 6566 205f 5f69 6e69 745f  .    def __init_
+00021c90: 5f28 7365 6c66 2c20 6578 705f 6d61 702c  _(self, exp_map,
+00021ca0: 2073 696d 5f6d 6170 2c20 7261 6469 7573   sim_map, radius
+00021cb0: 293a 0a20 2020 2020 2020 2066 726f 6d20  ):.        from 
+00021cc0: 6d61 7468 2069 6d70 6f72 7420 6365 696c  math import ceil
+00021cd0: 2c20 6c6f 672c 2070 6f77 0a20 2020 2020  , log, pow.     
+00021ce0: 2020 2069 6d70 6f72 7420 766f 7863 6f76     import voxcov
+00021cf0: 2061 7320 7663 0a0a 2020 2020 2020 2020   as vc..        
+00021d00: 6d61 785f 6469 6d20 3d20 6d61 7828 6578  max_dim = max(ex
+00021d10: 705f 6d61 702e 626f 785f 7369 7a65 2829  p_map.box_size()
+00021d20: 290a 2020 2020 2020 2020 6e65 7874 5f70  ).        next_p
+00021d30: 6f77 3220 3d20 696e 7428 706f 7728 322c  ow2 = int(pow(2,
+00021d40: 2063 6569 6c28 6c6f 6728 6d61 785f 6469   ceil(log(max_di
+00021d50: 6d29 202f 206c 6f67 2832 2929 2929 0a20  m) / log(2)))). 
+00021d60: 2020 2020 2020 2073 656c 662e 7261 6469         self.radi
+00021d70: 7573 203d 2072 6164 6975 730a 0a20 2020  us = radius..   
+00021d80: 2020 2020 2073 656c 662e 6d6f 6320 3d20       self.moc = 
+00021d90: 7663 2e53 4d4f 4328 0a20 2020 2020 2020  vc.SMOC(.       
+00021da0: 2020 2020 2065 7870 5f6d 6170 2e61 7069       exp_map.api
+00021db0: 782c 0a20 2020 2020 2020 2020 2020 2065  x,.            e
+00021dc0: 7870 5f6d 6170 2e6f 7269 6769 6e2c 0a20  xp_map.origin,. 
+00021dd0: 2020 2020 2020 2020 2020 206e 6578 745f             next_
+00021de0: 706f 7732 2c0a 2020 2020 2020 2020 2020  pow2,.          
+00021df0: 2020 5b65 7870 5f6d 6170 2e78 5f73 697a    [exp_map.x_siz
+00021e00: 6528 292c 2065 7870 5f6d 6170 2e79 5f73  e(), exp_map.y_s
+00021e10: 697a 6528 292c 2065 7870 5f6d 6170 2e7a  ize(), exp_map.z
+00021e20: 5f73 697a 6528 295d 2c0a 2020 2020 2020  _size()],.      
+00021e30: 2020 2020 2020 6e70 2e61 7363 6f6e 7469        np.asconti
+00021e40: 6775 6f75 7361 7272 6179 2865 7870 5f6d  guousarray(exp_m
+00021e50: 6170 2e66 756c 6c4d 6170 2c20 6474 7970  ap.fullMap, dtyp
+00021e60: 653d 2266 6c6f 6174 3634 2229 2c0a 2020  e="float64"),.  
+00021e70: 2020 2020 2020 2020 2020 6e70 2e61 7363            np.asc
+00021e80: 6f6e 7469 6775 6f75 7361 7272 6179 2873  ontiguousarray(s
+00021e90: 696d 5f6d 6170 2e66 756c 6c4d 6170 2c20  im_map.fullMap, 
+00021ea0: 6474 7970 653d 2266 6c6f 6174 3634 2229  dtype="float64")
+00021eb0: 2c0a 2020 2020 2020 2020 290a 0a20 2020  ,.        )..   
+00021ec0: 2064 6566 2061 6464 5f61 746f 6d28 7365   def add_atom(se
+00021ed0: 6c66 2c20 6174 6f6d 293a 0a20 2020 2020  lf, atom):.     
+00021ee0: 2020 2073 656c 662e 6d6f 632e 6164 645f     self.moc.add_
+00021ef0: 7370 6865 7265 285b 6174 6f6d 2e78 2c20  sphere([atom.x, 
+00021f00: 6174 6f6d 2e79 2c20 6174 6f6d 2e7a 5d2c  atom.y, atom.z],
+00021f10: 2073 656c 662e 7261 6469 7573 290a 0a20   self.radius).. 
+00021f20: 2020 2064 6566 2064 656c 5f61 746f 6d28     def del_atom(
+00021f30: 7365 6c66 2c20 6174 6f6d 293a 0a20 2020  self, atom):.   
+00021f40: 2020 2020 2073 656c 662e 6d6f 632e 6465       self.moc.de
+00021f50: 6c5f 7370 6865 7265 285b 6174 6f6d 2e78  l_sphere([atom.x
+00021f60: 2c20 6174 6f6d 2e79 2c20 6174 6f6d 2e7a  , atom.y, atom.z
+00021f70: 5d2c 2073 656c 662e 7261 6469 7573 290a  ], self.radius).
+00021f80: 0a20 2020 2064 6566 2067 6574 5f76 616c  .    def get_val
+00021f90: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
+00021fa0: 7265 7475 726e 2073 656c 662e 6d6f 632e  return self.moc.
+00021fb0: 6765 745f 7661 6c28 290a 0a20 2020 2064  get_val()..    d
+00021fc0: 6566 207a 6572 6f28 7365 6c66 293a 0a20  ef zero(self):. 
+00021fd0: 2020 2020 2020 2073 656c 662e 6d6f 632e         self.moc.
+00021fe0: 7a65 726f 2829 0a0a 0a63 6c61 7373 205f  zero()...class _
+00021ff0: 4d49 4163 6375 6d75 6c61 746f 7228 5f41  MIAccumulator(_A
+00022000: 6363 756d 756c 6174 6f72 293a 0a20 2020  ccumulator):.   
+00022010: 2022 2222 496e 6372 656d 656e 7461 6c20   """Incremental 
+00022020: 6361 6c63 756c 6174 696f 6e20 6f66 204d  calculation of M
+00022030: 4920 7363 6f72 6520 6f76 6572 2076 6f78  I score over vox
+00022040: 656c 730a 2020 2020 636f 7665 7265 6420  els.    covered 
+00022050: 6279 2061 746f 6d73 2e22 2222 0a0a 2020  by atoms."""..  
+00022060: 2020 6465 6620 5f5f 696e 6974 5f5f 2873    def __init__(s
+00022070: 656c 662c 2065 7870 5f6d 6170 2c20 7369  elf, exp_map, si
+00022080: 6d5f 6d61 702c 2072 6164 6975 732c 2078  m_map, radius, x
+00022090: 5f62 696e 732c 2079 5f62 696e 7329 3a0a  _bins, y_bins):.
+000220a0: 2020 2020 2020 2020 6672 6f6d 206d 6174          from mat
+000220b0: 6820 696d 706f 7274 2063 6569 6c2c 206c  h import ceil, l
+000220c0: 6f67 2c20 706f 770a 2020 2020 2020 2020  og, pow.        
+000220d0: 696d 706f 7274 2076 6f78 636f 7620 6173  import voxcov as
+000220e0: 2076 630a 0a20 2020 2020 2020 206d 6178   vc..        max
+000220f0: 5f64 696d 203d 206d 6178 2865 7870 5f6d  _dim = max(exp_m
+00022100: 6170 2e62 6f78 5f73 697a 6528 2929 0a20  ap.box_size()). 
+00022110: 2020 2020 2020 206e 6578 745f 706f 7732         next_pow2
+00022120: 203d 2069 6e74 2870 6f77 2832 2c20 6365   = int(pow(2, ce
+00022130: 696c 286c 6f67 286d 6178 5f64 696d 2920  il(log(max_dim) 
+00022140: 2f20 6c6f 6728 3229 2929 290a 2020 2020  / log(2)))).    
+00022150: 2020 2020 7365 6c66 2e72 6164 6975 7320      self.radius 
+00022160: 3d20 330a 2020 2020 2020 2020 7365 6c66  = 3.        self
+00022170: 2e65 7870 5f6d 6170 203d 2065 7870 5f6d  .exp_map = exp_m
+00022180: 6170 0a20 2020 2020 2020 2073 656c 662e  ap.        self.
+00022190: 7369 6d5f 6d61 7020 3d20 7369 6d5f 6d61  sim_map = sim_ma
+000221a0: 700a 0a20 2020 2020 2020 2073 656c 662e  p..        self.
+000221b0: 6d69 203d 2076 632e 534d 4928 0a20 2020  mi = vc.SMI(.   
+000221c0: 2020 2020 2020 2020 2065 7870 5f6d 6170           exp_map
+000221d0: 2e61 7069 782c 0a20 2020 2020 2020 2020  .apix,.         
+000221e0: 2020 2065 7870 5f6d 6170 2e6f 7269 6769     exp_map.origi
+000221f0: 6e2c 0a20 2020 2020 2020 2020 2020 206e  n,.            n
+00022200: 6578 745f 706f 7732 2c0a 2020 2020 2020  ext_pow2,.      
+00022210: 2020 2020 2020 5b65 7870 5f6d 6170 2e78        [exp_map.x
+00022220: 5f73 697a 6528 292c 2065 7870 5f6d 6170  _size(), exp_map
+00022230: 2e79 5f73 697a 6528 292c 2065 7870 5f6d  .y_size(), exp_m
+00022240: 6170 2e7a 5f73 697a 6528 295d 2c0a 2020  ap.z_size()],.  
+00022250: 2020 2020 2020 2020 2020 6e70 2e61 7363            np.asc
+00022260: 6f6e 7469 6775 6f75 7361 7272 6179 2873  ontiguousarray(s
+00022270: 696d 5f6d 6170 2e66 756c 6c4d 6170 2c20  im_map.fullMap, 
+00022280: 6474 7970 653d 2266 6c6f 6174 3634 2229  dtype="float64")
+00022290: 2c0a 2020 2020 2020 2020 2020 2020 6e70  ,.            np
+000222a0: 2e61 7363 6f6e 7469 6775 6f75 7361 7272  .ascontiguousarr
+000222b0: 6179 2865 7870 5f6d 6170 2e66 756c 6c4d  ay(exp_map.fullM
+000222c0: 6170 2c20 6474 7970 653d 2266 6c6f 6174  ap, dtype="float
+000222d0: 3634 2229 2c0a 2020 2020 2020 2020 2020  64"),.          
+000222e0: 2020 6e70 2e6d 696e 2865 7870 5f6d 6170    np.min(exp_map
+000222f0: 2e66 756c 6c4d 6170 292c 0a20 2020 2020  .fullMap),.     
+00022300: 2020 2020 2020 206e 702e 6d61 7828 6578         np.max(ex
+00022310: 705f 6d61 702e 6675 6c6c 4d61 7029 2c0a  p_map.fullMap),.
+00022320: 2020 2020 2020 2020 2020 2020 6e70 2e6d              np.m
+00022330: 696e 2873 696d 5f6d 6170 2e66 756c 6c4d  in(sim_map.fullM
+00022340: 6170 292c 0a20 2020 2020 2020 2020 2020  ap),.           
+00022350: 206e 702e 6d61 7828 7369 6d5f 6d61 702e   np.max(sim_map.
+00022360: 6675 6c6c 4d61 7029 2c0a 2020 2020 2020  fullMap),.      
+00022370: 2020 2020 2020 785f 6269 6e73 2c20 795f        x_bins, y_
+00022380: 6269 6e73 0a20 2020 2020 2020 2029 0a0a  bins.        )..
+00022390: 2020 2020 6465 6620 6164 645f 6174 6f6d      def add_atom
+000223a0: 2873 656c 662c 2061 746f 6d29 3a0a 2020  (self, atom):.  
+000223b0: 2020 2020 2020 7365 6c66 2e6d 692e 6164        self.mi.ad
+000223c0: 645f 7370 6865 7265 280a 2020 2020 2020  d_sphere(.      
+000223d0: 2020 2020 2020 5b61 746f 6d2e 782c 2061        [atom.x, a
+000223e0: 746f 6d2e 792c 2061 746f 6d2e 7a5d 2c0a  tom.y, atom.z],.
+000223f0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+00022400: 2e72 6164 6975 732c 0a20 2020 2020 2020  .radius,.       
+00022410: 2029 0a0a 2020 2020 6465 6620 6465 6c5f   )..    def del_
+00022420: 6174 6f6d 2873 656c 662c 2061 746f 6d29  atom(self, atom)
+00022430: 3a0a 2020 2020 2020 2020 7365 6c66 2e6d  :.        self.m
+00022440: 692e 6465 6c5f 7370 6865 7265 280a 2020  i.del_sphere(.  
+00022450: 2020 2020 2020 2020 2020 5b61 746f 6d2e            [atom.
+00022460: 782c 2061 746f 6d2e 792c 2061 746f 6d2e  x, atom.y, atom.
+00022470: 7a5d 2c0a 2020 2020 2020 2020 2020 2020  z],.            
+00022480: 7365 6c66 2e72 6164 6975 732c 0a20 2020  self.radius,.   
+00022490: 2020 2020 2029 0a0a 2020 2020 2320 4e6f       )..    # No
+000224a0: 7420 7374 7269 6374 6c79 2065 7373 656e  t strictly essen
+000224b0: 7469 616c 2c20 6275 7420 4920 7368 6f75  tial, but I shou
+000224c0: 6c64 2061 6464 207a 6572 6f69 6e67 2074  ld add zeroing t
+000224d0: 6f20 4469 6666 4d61 7020 696e 2076 6f78  o DiffMap in vox
+000224e0: 636f 762e 0a20 2020 2064 6566 207a 6572  cov..    def zer
+000224f0: 6f28 7365 6c66 293a 0a20 2020 2020 2020  o(self):.       
+00022500: 2073 656c 662e 6d69 2e7a 6572 6f28 290a   self.mi.zero().
+00022510: 0a20 2020 2023 2052 6574 7572 6e20 6375  .    # Return cu
+00022520: 7272 656e 7420 4d49 2076 616c 7565 0a20  rrent MI value. 
+00022530: 2020 2064 6566 2067 6574 5f76 616c 2873     def get_val(s
+00022540: 656c 6629 3a0a 2020 2020 2020 2020 7265  elf):.        re
+00022550: 7475 726e 2073 656c 662e 6d69 2e67 6574  turn self.mi.get
+00022560: 5f76 616c 2829 0a0a 0a63 6c61 7373 204c  _val()...class L
+00022570: 6f63 616c 4d49 285f 4162 7374 7261 6374  ocalMI(_Abstract
+00022580: 536c 6964 696e 6753 636f 7265 293a 0a20  SlidingScore):. 
+00022590: 2020 2022 2222 0a20 2020 2022 2222 0a20     """.    """. 
+000225a0: 2020 2064 6566 205f 5f69 6e69 745f 5f28     def __init__(
+000225b0: 7365 6c66 2c20 7374 7275 6374 2c20 6578  self, struct, ex
+000225c0: 705f 6d61 702c 2073 696d 5f6d 6170 2c20  p_map, sim_map, 
+000225d0: 7265 736f 6c75 7469 6f6e 2c20 7261 6469  resolution, radi
+000225e0: 7573 2c20 6e6f 5f62 696e 733d 3230 293a  us, no_bins=20):
+000225f0: 0a20 2020 2020 2020 2073 6967 6d61 5f63  .        sigma_c
+00022600: 6f65 6666 3d30 2e32 3235 0a0a 2020 2020  oeff=0.225..    
+00022610: 2020 2020 7365 6c66 2e65 7870 5f6d 6170      self.exp_map
+00022620: 203d 2065 7870 5f6d 6170 0a20 2020 2020   = exp_map.     
+00022630: 2020 2073 656c 662e 7369 6d5f 6d61 7020     self.sim_map 
+00022640: 3d20 7369 6d5f 6d61 700a 2020 2020 2020  = sim_map.      
+00022650: 2020 7365 6c66 2e72 6164 6975 7320 3d20    self.radius = 
+00022660: 7261 6469 7573 0a20 2020 2020 2020 2073  radius.        s
+00022670: 656c 662e 6e6f 5f62 696e 7320 3d20 6e6f  elf.no_bins = no
+00022680: 5f62 696e 730a 0a20 2020 2020 2020 2069  _bins..        i
+00022690: 6620 7369 6d5f 6d61 7020 6973 204e 6f6e  f sim_map is Non
+000226a0: 653a 0a20 2020 2020 2020 2020 2020 2073  e:.            s
+000226b0: 696d 5f6d 6170 203d 2053 7472 7563 7475  im_map = Structu
+000226c0: 7265 426c 7572 7265 7228 292e 6761 7573  reBlurrer().gaus
+000226d0: 7369 616e 5f62 6c75 725f 7265 616c 5f73  sian_blur_real_s
+000226e0: 7061 6365 280a 2020 2020 2020 2020 2020  pace(.          
+000226f0: 2020 2020 2020 2020 2020 7374 7275 6374            struct
+00022700: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00022710: 2020 2020 2020 7265 736f 6c75 7469 6f6e        resolution
+00022720: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00022730: 2020 2020 2020 6578 705f 6d61 702c 0a20        exp_map,. 
+00022740: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022750: 2020 2073 6967 6d61 5f63 6f65 6666 3d73     sigma_coeff=s
+00022760: 6967 6d61 5f63 6f65 6666 0a20 2020 2020  igma_coeff.     
+00022770: 2020 2020 2020 2029 0a0a 2020 2020 2020         )..      
+00022780: 2020 6d69 203d 205f 4d49 4163 6375 6d75    mi = _MIAccumu
+00022790: 6c61 746f 7228 6578 705f 6d61 702c 2073  lator(exp_map, s
+000227a0: 696d 5f6d 6170 2c20 7261 6469 7573 2c20  im_map, radius, 
+000227b0: 6e6f 5f62 696e 732c 206e 6f5f 6269 6e73  no_bins, no_bins
+000227c0: 290a 2020 2020 2020 2020 7375 7065 7228  ).        super(
+000227d0: 292e 5f5f 696e 6974 5f5f 2873 7472 7563  ).__init__(struc
+000227e0: 742c 206d 6929 0a0a 0a63 6c61 7373 2046  t, mi)...class F
+000227f0: 6173 7453 4d4f 4328 5f41 6273 7472 6163  astSMOC(_Abstrac
+00022800: 7453 6c69 6469 6e67 5363 6f72 6529 3a0a  tSlidingScore):.
+00022810: 2020 2020 2222 2241 2066 6173 7465 7220      """A faster 
+00022820: 7665 7273 696f 6e20 6f66 2074 6865 2073  version of the s
+00022830: 6c69 6469 6e67 2077 696e 646f 7720 534d  liding window SM
+00022840: 4f43 2073 636f 7265 2e0a 0a20 2020 2055  OC score...    U
+00022850: 6e6c 696b 6520 7468 6520 6f72 6967 696e  nlike the origin
+00022860: 616c 2061 6c67 6f72 6974 686d 2c20 7468  al algorithm, th
+00022870: 6973 206f 6e65 7320 6973 206f 7074 696d  is ones is optim
+00022880: 697a 6564 2069 6e20 7468 650a 2020 2020  ized in the.    
+00022890: 666f 6c6c 6f77 696e 6720 7761 7973 3a0a  following ways:.
+000228a0: 0a20 2020 202a 206c 617a 696c 7920 6465  .    * lazily de
+000228b0: 7465 726d 696e 6573 2072 6571 7569 7265  termines require
+000228c0: 6420 766f 7865 6c73 2073 6176 696e 6720  d voxels saving 
+000228d0: 7370 6163 6520 616e 6420 7469 6d65 2e0a  space and time..
+000228e0: 2020 2020 2a20 5468 6520 736c 6964 696e      * The slidin
+000228f0: 672d 7769 6e64 6f77 2063 616c 6375 6c61  g-window calcula
+00022900: 7469 6f6e 2069 7320 7065 7266 6f72 6d65  tion is performe
+00022910: 6420 696e 2074 696d 6520 7072 6f70 6f72  d in time propor
+00022920: 7469 6f6e 616c 0a20 2020 2020 206f 6e6c  tional.      onl
+00022930: 7920 746f 2063 6861 696e 2073 697a 6520  y to chain size 
+00022940: 616e 6420 6e6f 7420 7769 6e64 6f77 2073  and not window s
+00022950: 697a 652e 0a0a 2020 2020 5468 6973 206d  ize...    This m
+00022960: 6574 686f 6420 646f 6573 206e 6f74 206f  ethod does not o
+00022970: 6666 6572 2061 6c6c 2074 6865 2062 656c  ffer all the bel
+00022980: 6c73 2061 6e64 2077 6869 7374 6c65 7320  ls and whistles 
+00022990: 6f66 206f 6c64 2053 4d4f 430a 2020 2020  of old SMOC.    
+000229a0: 6675 6e63 7469 6f6e 2073 7563 6820 6173  function such as
+000229b0: 2072 6967 6964 2062 6f64 7920 7061 7261   rigid body para
+000229c0: 6d65 7465 7273 2e20 2048 6f77 6576 6572  meters.  However
+000229d0: 2c20 7477 6f20 616c 7465 726e 6174 6976  , two alternativ
+000229e0: 650a 2020 2020 6d65 7468 6f64 7320 6172  e.    methods ar
+000229f0: 6520 7072 6f76 6964 6564 2066 6f72 2064  e provided for d
+00022a00: 6561 6c69 6e67 2077 6974 6820 534d 4f43  ealing with SMOC
+00022a10: 2073 636f 7265 7320 666f 7220 756e 6d6f   scores for unmo
+00022a20: 6465 6c6c 6564 0a20 2020 2072 6567 696f  delled.    regio
+00022a30: 6e73 2e0a 0a20 2020 2054 6865 2066 756e  ns...    The fun
+00022a40: 6374 696f 6e20 6073 636f 7265 5f63 6861  ction `score_cha
+00022a50: 696e 5f63 6f6e 7469 6760 2c20 7769 6c6c  in_contig`, will
+00022a60: 2073 636f 7265 2061 6c6c 2063 6f6e 7469   score all conti
+00022a70: 6773 2069 6e20 610a 2020 2020 6368 6169  gs in a.    chai
+00022a80: 6e20 7768 6572 6520 6561 6368 2077 696e  n where each win
+00022a90: 646f 7720 6f6e 6c79 2063 6f6e 7461 696e  dow only contain
+00022aa0: 7320 7265 7369 6475 6573 2062 656c 6f6e  s residues belon
+00022ab0: 6769 6e67 2074 6f20 7468 650a 2020 2020  ging to the.    
+00022ac0: 636f 6e74 6967 2e0a 0a20 2020 2054 6865  contig...    The
+00022ad0: 2066 756e 6374 696f 6e20 6073 636f 7265   function `score
+00022ae0: 5f63 6861 696e 5f73 7061 6e60 206d 696d  _chain_span` mim
+00022af0: 6963 6b73 2074 6865 206f 6c64 2053 4d4f  icks the old SMO
+00022b00: 4320 6265 6861 7669 6f75 722e 0a20 2020  C behaviour..   
+00022b10: 2057 696e 646f 7773 2069 676e 6f72 6520   Windows ignore 
+00022b20: 636f 6e74 6967 7320 626f 756e 6461 7269  contigs boundari
+00022b30: 6573 2028 7468 6579 2027 7370 616e 2720  es (they 'span' 
+00022b40: 7468 656d 292c 2074 6875 7320 7265 7369  them), thus resi
+00022b50: 6475 6573 0a20 2020 2069 6e20 7769 6e64  dues.    in wind
+00022b60: 6f77 7320 6d61 7920 6265 2070 6879 7369  ows may be physi
+00022b70: 6361 6c6c 7920 6469 7374 616e 742e 0a0a  cally distant...
+00022b80: 2020 2020 496e 2067 656e 6572 616c 2c20      In general, 
+00022b90: 7468 6520 636f 6e73 6964 6572 2075 7369  the consider usi
+00022ba0: 6e67 2074 6865 2060 7363 6f72 655f 6368  ng the `score_ch
+00022bb0: 6169 6e5f 636f 6e74 6967 6020 6d65 7468  ain_contig` meth
+00022bc0: 6f64 2e0a 0a0a 2020 2020 4172 6773 3a0a  od....    Args:.
+00022bd0: 2020 2020 2020 2020 7374 7275 6374 2028          struct (
+00022be0: 3a63 6c61 7373 3a60 4269 6f50 795f 5374  :class:`BioPy_St
+00022bf0: 7275 6374 7572 6520 3c54 454d 5079 2e70  ructure <TEMPy.p
+00022c00: 726f 7465 696e 2e70 726f 745f 7265 705f  rotein.prot_rep_
+00022c10: 6269 6f70 792e 4269 6f50 795f 5374 7275  biopy.BioPy_Stru
+00022c20: 6374 7572 653e 6029 3a20 4d6f 6465 6c20  cture>`): Model 
+00022c30: 746f 2073 636f 7265 0a20 2020 2020 2020  to score.       
+00022c40: 2065 7870 5f6d 6170 2028 3a63 6c61 7373   exp_map (:class
+00022c50: 3a60 454d 4d61 7020 3c54 454d 5079 2e6d  :`EMMap <TEMPy.m
+00022c60: 6170 732e 656d 5f6d 6170 2e4d 6170 3e60  aps.em_map.Map>`
+00022c70: 293a 2045 7870 6572 696d 656e 7461 6c20  ): Experimental 
+00022c80: 6465 6e73 6974 7920 6d61 700a 2020 2020  density map.    
+00022c90: 2020 2020 7265 736f 6c75 7469 6f6e 2028      resolution (
+00022ca0: 666c 6f61 7429 3a20 5468 6520 7265 736f  float): The reso
+00022cb0: 6c75 7469 6f6e 206f 6620 7468 6520 6578  lution of the ex
+00022cc0: 7065 7269 6d65 6e74 616c 206d 6170 0a20  perimental map. 
+00022cd0: 2020 2020 2020 2073 6967 6d61 5f63 6f65         sigma_coe
+00022ce0: 6666 2028 666c 6f61 742c 206f 7074 696f  ff (float, optio
+00022cf0: 6e61 6c29 3a20 5468 6520 7369 676d 6120  nal): The sigma 
+00022d00: 636f 6566 6669 6369 656e 7420 666f 7220  coefficient for 
+00022d10: 7369 6d75 6c61 7469 6e67 2074 6865 206d  simulating the m
+00022d20: 6170 2e20 4465 6661 756c 7473 2074 6f20  ap. Defaults to 
+00022d30: 302e 3232 352e 0a20 2020 2020 2020 2073  0.225..        s
+00022d40: 6967 6d61 5f74 6872 6573 686f 6c64 2028  igma_threshold (
+00022d50: 666c 6f61 742c 206f 7074 696f 6e61 6c29  float, optional)
+00022d60: 3a20 5468 6520 7369 676d 6120 7468 7265  : The sigma thre
+00022d70: 7368 6f6c 6420 6465 7465 726d 696e 6573  shold determines
+00022d80: 2074 6865 2072 6164 6975 7320 6172 6f75   the radius arou
+00022d90: 6e64 2074 6865 2061 746f 6d73 2074 6f20  nd the atoms to 
+00022da0: 636f 6e73 6964 6572 2e20 4465 6661 756c  consider. Defaul
+00022db0: 7473 2074 6f20 322e 352e 0a20 2020 2020  ts to 2.5..     
+00022dc0: 2020 2073 696d 5f6d 6170 2028 454d 4d61     sim_map (EMMa
+00022dd0: 702c 206f 7074 696f 6e61 6c29 3a20 4120  p, optional): A 
+00022de0: 7369 6d75 6c61 7465 6420 6d61 7020 746f  simulated map to
+00022df0: 2075 7365 2069 6e73 7465 6164 206f 6620   use instead of 
+00022e00: 6765 6e65 7261 7469 6e67 206f 6e65 2e0a  generating one..
+00022e10: 2020 2020 5265 7475 726e 733a 0a20 2020      Returns:.   
+00022e20: 2020 2020 2046 6173 7453 4d4f 4320 6f62       FastSMOC ob
+00022e30: 6a65 6374 0a20 2020 2022 2222 0a0a 2020  ject.    """..  
+00022e40: 2020 6465 6620 5f5f 696e 6974 5f5f 280a    def __init__(.
+00022e50: 2020 2020 2020 2020 7365 6c66 2c0a 2020          self,.  
+00022e60: 2020 2020 2020 7374 7275 6374 2c0a 2020        struct,.  
+00022e70: 2020 2020 2020 6578 705f 6d61 702c 0a20        exp_map,. 
+00022e80: 2020 2020 2020 2072 6573 6f6c 7574 696f         resolutio
+00022e90: 6e2c 0a20 2020 2020 2020 2073 6967 6d61  n,.        sigma
+00022ea0: 5f63 6f65 6666 3d30 2e32 3235 2c0a 2020  _coeff=0.225,.  
+00022eb0: 2020 2020 2020 7369 676d 615f 7468 7265        sigma_thre
+00022ec0: 7368 6f6c 643d 322e 352c 0a20 2020 2020  shold=2.5,.     
+00022ed0: 2020 2073 696d 5f6d 6170 3d4e 6f6e 652c     sim_map=None,
+00022ee0: 0a20 2020 2020 2020 206c 6f63 7265 733d  .        locres=
+00022ef0: 4e6f 6e65 2c0a 2020 2020 293a 0a20 2020  None,.    ):.   
+00022f00: 2020 2020 2072 6164 6975 7320 3d20 7369       radius = si
+00022f10: 676d 615f 7468 7265 7368 6f6c 6420 2a20  gma_threshold * 
+00022f20: 6d61 7828 7369 676d 615f 636f 6566 6620  max(sigma_coeff 
+00022f30: 2a20 7265 736f 6c75 7469 6f6e 2c20 312e  * resolution, 1.
+00022f40: 3029 0a20 2020 2020 2020 2069 6620 7369  0).        if si
+00022f50: 6d5f 6d61 7020 6973 204e 6f6e 653a 0a20  m_map is None:. 
+00022f60: 2020 2020 2020 2020 2020 2073 696d 5f6d             sim_m
+00022f70: 6170 203d 2053 7472 7563 7475 7265 426c  ap = StructureBl
+00022f80: 7572 7265 7228 6c6f 6372 6573 3d6c 6f63  urrer(locres=loc
+00022f90: 7265 7329 2e67 6175 7373 6961 6e5f 626c  res).gaussian_bl
+00022fa0: 7572 5f72 6561 6c5f 7370 6163 6528 0a20  ur_real_space(. 
+00022fb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022fc0: 2020 2073 7472 7563 742c 0a20 2020 2020     struct,.     
+00022fd0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+00022fe0: 6573 6f6c 7574 696f 6e2c 0a20 2020 2020  esolution,.     
+00022ff0: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+00023000: 7870 5f6d 6170 2c0a 2020 2020 2020 2020  xp_map,.        
+00023010: 2020 2020 2020 2020 2020 2020 7369 676d              sigm
+00023020: 615f 636f 6566 663d 7369 676d 615f 636f  a_coeff=sigma_co
+00023030: 6566 660a 2020 2020 2020 2020 2020 2020  eff.            
+00023040: 290a 0a20 2020 2020 2020 206d 6f63 203d  )..        moc =
+00023050: 205f 4d4f 4341 6363 756d 756c 6174 6f72   _MOCAccumulator
+00023060: 2865 7870 5f6d 6170 2c20 7369 6d5f 6d61  (exp_map, sim_ma
+00023070: 702c 2072 6164 6975 7329 0a20 2020 2020  p, radius).     
+00023080: 2020 2073 7570 6572 2829 2e5f 5f69 6e69     super().__ini
+00023090: 745f 5f28 7374 7275 6374 2c20 6d6f 6329  t__(struct, moc)
+000230a0: 0a0a 0a63 6c61 7373 2046 6173 7453 4343  ...class FastSCC
+000230b0: 433a 0a20 2020 2064 6566 205f 5f69 6e69  C:.    def __ini
+000230c0: 745f 5f28 0a20 2020 2020 2020 2020 2020  t__(.           
+000230d0: 2073 656c 662c 0a20 2020 2020 2020 2020   self,.         
+000230e0: 2020 2073 7472 7563 7475 7265 2c0a 2020     structure,.  
+000230f0: 2020 2020 2020 2020 2020 6d61 705f 7461            map_ta
+00023100: 7267 6574 2c0a 2020 2020 2020 2020 2020  rget,.          
+00023110: 2020 7265 736f 6c75 7469 6f6e 2c0a 2020    resolution,.  
+00023120: 2020 2020 2020 2020 2020 7369 676d 615f            sigma_
+00023130: 636f 6566 663d 302e 3232 352c 0a20 2020  coeff=0.225,.   
+00023140: 2029 3a0a 2020 2020 2020 2020 2222 2243   ):.        """C
+00023150: 616c 6375 6c61 7465 206c 6f63 616c 2063  alculate local c
+00023160: 726f 7373 2d63 6f72 7265 6c61 7469 6f6e  ross-correlation
+00023170: 2066 6f72 2061 2073 6567 6d65 6e74 206f   for a segment o
+00023180: 6620 6120 7072 6f74 6569 6e20 6d6f 6465  f a protein mode
+00023190: 6c2e 0a0a 2020 2020 2020 2020 4172 6773  l...        Args
+000231a0: 3a0a 2020 2020 2020 2020 2020 2020 7374  :.            st
+000231b0: 7275 6374 7572 653a 2054 6865 2065 6e74  ructure: The ent
+000231c0: 6972 6520 6174 6f6d 6963 2073 7472 7563  ire atomic struc
+000231d0: 7475 7265 0a20 2020 2020 2020 2020 2020  ture.           
+000231e0: 206d 6170 5f74 6172 6765 743a 2041 6e20   map_target: An 
+000231f0: 6578 7065 7269 6d65 6e74 616c 206d 6170  experimental map
+00023200: 2e0a 2020 2020 2020 2020 2020 2020 7265  ..            re
+00023210: 736f 6c75 7469 6f6e 3a20 5468 6520 7365  solution: The se
+00023220: 736f 6c75 7469 6f6e 206f 6620 7468 6520  solution of the 
+00023230: 6578 7065 7269 6d65 6e74 616c 206d 6170  experimental map
+00023240: 2e0a 2020 2020 2020 2020 2020 2020 7369  ..            si
+00023250: 676d 615f 636f 6566 663a 2054 6865 2073  gma_coeff: The s
+00023260: 6967 6d61 2063 6f65 6666 6963 6965 6e74  igma coefficient
+00023270: 2066 6f72 2062 6c75 7272 696e 672e 0a20   for blurring.. 
+00023280: 2020 2020 2020 2020 2020 2020 2020 203a                 :
+00023290: 7265 663a 6068 6572 653c 4e6f 7465 206f  ref:`here<Note o
+000232a0: 6e20 7265 616c 2073 7061 6365 2062 6c75  n real space blu
+000232b0: 7272 696e 673a 3e60 0a20 2020 2020 2020  rring:>`.       
+000232c0: 2052 6574 7572 6e73 3a0a 2020 2020 2020   Returns:.      
+000232d0: 2020 2020 2020 4120 5343 4343 206f 626a        A SCCC obj
+000232e0: 6563 742e 0a20 2020 2020 2020 2022 2222  ect..        """
+000232f0: 0a20 2020 2020 2020 2073 656c 662e 626c  .        self.bl
+00023300: 7572 7265 7220 3d20 5374 7275 6374 7572  urrer = Structur
+00023310: 6542 6c75 7272 6572 2829 0a20 2020 2020  eBlurrer().     
+00023320: 2020 2073 656c 662e 7363 6f72 6572 203d     self.scorer =
+00023330: 2053 636f 7269 6e67 4675 6e63 7469 6f6e   ScoringFunction
+00023340: 7328 290a 2020 2020 2020 2020 7365 6c66  s().        self
+00023350: 2e6d 6170 5f74 6172 6765 7420 3d20 6d61  .map_target = ma
+00023360: 705f 7461 7267 6574 0a20 2020 2020 2020  p_target.       
+00023370: 2073 656c 662e 7265 736f 6c75 7469 6f6e   self.resolution
+00023380: 203d 2072 6573 6f6c 7574 696f 6e0a 2020   = resolution.  
+00023390: 2020 2020 2020 7365 6c66 2e73 6967 6d61        self.sigma
+000233a0: 5f63 6f65 6666 203d 2073 6967 6d61 5f63  _coeff = sigma_c
+000233b0: 6f65 6666 0a20 2020 2020 2020 2073 656c  oeff.        sel
+000233c0: 662e 7768 6f6c 655f 7369 6d5f 6d61 7020  f.whole_sim_map 
+000233d0: 3d20 7365 6c66 2e62 6c75 7272 6572 2e67  = self.blurrer.g
+000233e0: 6175 7373 6961 6e5f 626c 7572 5f72 6561  aussian_blur_rea
+000233f0: 6c5f 7370 6163 6528 0a20 2020 2020 2020  l_space(.       
+00023400: 2020 2020 2073 7472 7563 7475 7265 2c0a       structure,.
+00023410: 2020 2020 2020 2020 2020 2020 7265 736f              reso
+00023420: 6c75 7469 6f6e 2c0a 2020 2020 2020 2020  lution,.        
+00023430: 2020 2020 6465 6e73 4d61 703d 6d61 705f      densMap=map_
+00023440: 7461 7267 6574 2c0a 2020 2020 2020 2020  target,.        
+00023450: 2020 2020 7369 676d 615f 636f 6566 663d      sigma_coeff=
+00023460: 7369 676d 615f 636f 6566 662c 0a20 2020  sigma_coeff,.   
+00023470: 2020 2020 2020 2020 206e 6f72 6d61 6c69           normali
+00023480: 7365 3d54 7275 652c 0a20 2020 2020 2020  se=True,.       
+00023490: 2029 0a0a 2020 2020 6465 6620 7363 6f72   )..    def scor
+000234a0: 655f 7365 676d 656e 7428 7365 6c66 2c20  e_segment(self, 
+000234b0: 7365 676d 656e 745f 7374 7275 6374 7572  segment_structur
+000234c0: 6529 3a0a 2020 2020 2020 2020 2222 2253  e):.        """S
+000234d0: 636f 7265 2061 2073 6567 6d65 6e74 206f  core a segment o
+000234e0: 6620 7468 6520 7374 7275 6374 7572 652e  f the structure.
+000234f0: 0a0a 2020 2020 2020 2020 4172 6773 3a0a  ..        Args:.
+00023500: 2020 2020 2020 2020 2020 2020 7365 676d              segm
+00023510: 656e 743a 2041 6e20 6174 6f6d 6963 2073  ent: An atomic s
+00023520: 7472 7563 7475 7265 2077 6869 6368 2073  tructure which s
+00023530: 686f 756c 6420 6265 2061 2063 6f6d 706f  hould be a compo
+00023540: 6e65 6e74 0a20 2020 2020 2020 2052 6574  nent.        Ret
+00023550: 7572 6e73 3a0a 2020 2020 2020 2020 2020  urns:.          
+00023560: 2020 4343 4320 7363 6f72 653a 2028 666c    CCC score: (fl
+00023570: 6f61 7429 0a20 2020 2020 2020 2022 2222  oat).        """
+00023580: 0a20 2020 2020 2020 2073 6567 6d65 6e74  .        segment
+00023590: 5f73 696d 5f6d 6170 203d 2073 656c 662e  _sim_map = self.
+000235a0: 626c 7572 7265 722e 6761 7573 7369 616e  blurrer.gaussian
+000235b0: 5f62 6c75 725f 7265 616c 5f73 7061 6365  _blur_real_space
+000235c0: 280a 2020 2020 2020 2020 2020 2020 7365  (.            se
+000235d0: 676d 656e 745f 7374 7275 6374 7572 652c  gment_structure,
+000235e0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+000235f0: 662e 7265 736f 6c75 7469 6f6e 2c0a 2020  f.resolution,.  
+00023600: 2020 2020 2020 2020 2020 7365 6c66 2e6d            self.m
+00023610: 6170 5f74 6172 6765 742c 0a20 2020 2020  ap_target,.     
+00023620: 2020 2020 2020 2073 656c 662e 7369 676d         self.sigm
+00023630: 615f 636f 6566 662c 0a20 2020 2020 2020  a_coeff,.       
+00023640: 2020 2020 206e 6f72 6d61 6c69 7365 3d54       normalise=T
+00023650: 7275 652c 0a20 2020 2020 2020 2029 0a20  rue,.        ). 
+00023660: 2020 2020 2020 206d 696e 4465 6e73 203d         minDens =
+00023670: 2073 6567 6d65 6e74 5f73 696d 5f6d 6170   segment_sim_map
+00023680: 2e73 7464 2829 0a20 2020 2020 2020 2073  .std().        s
+00023690: 6567 6d65 6e74 5f6d 6173 6b20 3d20 7365  egment_mask = se
+000236a0: 676d 656e 745f 7369 6d5f 6d61 702e 5f67  gment_sim_map._g
+000236b0: 6574 5f6d 6173 6b41 7272 6179 286d 696e  et_maskArray(min
+000236c0: 4465 6e73 290a 2020 2020 2020 2020 7461  Dens).        ta
+000236d0: 7267 6574 5f6d 6173 6b65 6420 3d20 7365  rget_masked = se
+000236e0: 6c66 2e6d 6170 5f74 6172 6765 742e 5f67  lf.map_target._g
+000236f0: 6574 5f6d 6173 6b4d 6170 2873 6567 6d65  et_maskMap(segme
+00023700: 6e74 5f6d 6173 6b29 0a20 2020 2020 2020  nt_mask).       
+00023710: 2073 696d 5f6d 6173 6b65 6420 3d20 7365   sim_masked = se
+00023720: 6c66 2e77 686f 6c65 5f73 696d 5f6d 6170  lf.whole_sim_map
+00023730: 2e5f 6765 745f 6d61 736b 4d61 7028 7365  ._get_maskMap(se
+00023740: 676d 656e 745f 6d61 736b 290a 2020 2020  gment_mask).    
+00023750: 2020 2020 7373 652c 205f 203d 2073 656c      sse, _ = sel
+00023760: 662e 7363 6f72 6572 2e43 4343 5f6d 6170  f.scorer.CCC_map
+00023770: 2874 6172 6765 745f 6d61 736b 6564 2c20  (target_masked, 
+00023780: 7369 6d5f 6d61 736b 6564 2c20 636d 6f64  sim_masked, cmod
+00023790: 653d 4661 6c73 6529 0a20 2020 2020 2020  e=False).       
+000237a0: 2072 6574 7572 6e20 7373 650a             return sse.
```

### Comparing `BioTEMPy-2.2.0a0/TEMPy/protein/structure_blurrer.py` & `BioTEMPy-2.2.0a1/TEMPy/protein/structure_blurrer.py`

 * *Files identical despite different names*

### Comparing `BioTEMPy-2.2.0a0/TEMPy/protein/structure_parser.py` & `BioTEMPy-2.2.0a1/TEMPy/protein/structure_parser.py`

 * *Files identical despite different names*

### Comparing `BioTEMPy-2.2.0a0/TEMPy/script/gamma.py` & `BioTEMPy-2.2.0a1/TEMPy/script/gamma.py`

 * *Files identical despite different names*

### Comparing `BioTEMPy-2.2.0a0/TEMPy/script/loqfit.py` & `BioTEMPy-2.2.0a1/TEMPy/script/loqfit.py`

 * *Files identical despite different names*

### Comparing `BioTEMPy-2.2.0a0/TEMPy/script/mi.py` & `BioTEMPy-2.2.0a1/TEMPy/script/mi.py`

 * *Files identical despite different names*

### Comparing `BioTEMPy-2.2.0a0/TEMPy/script/output.py` & `BioTEMPy-2.2.0a1/TEMPy/script/output.py`

 * *Files identical despite different names*

### Comparing `BioTEMPy-2.2.0a0/TEMPy/script/sccc.py` & `BioTEMPy-2.2.0a1/TEMPy/script/sccc.py`

 * *Files identical despite different names*

### Comparing `BioTEMPy-2.2.0a0/TEMPy/script/smoc.py` & `BioTEMPy-2.2.0a1/TEMPy/script/smoc.py`

 * *Files identical despite different names*

### Comparing `BioTEMPy-2.2.0a0/TEMPy/tempy_data/quaternion_vectors_5000.pk` & `BioTEMPy-2.2.0a1/TEMPy/tempy_data/quaternion_vectors_5000.pk`

 * *Files identical despite different names*

### Comparing `BioTEMPy-2.2.0a0/setup.py` & `BioTEMPy-2.2.0a1/setup.py`

 * *Files 13% similar despite different names*

```diff
@@ -7,15 +7,15 @@
 
 if os.path.exists('build') is True:
     print('build exists')
     shutil.rmtree('./build')
 
 setup(
     name='BioTEMPy',
-    version='2.2.0a0',
+    version='2.2.0a1',
     author='Maya Topf, Daven Vasishtan, Arun Prasad Pandurangan, Irene Farabella, Agnel-Praveen Joseph, Harpal Sahota',
     author_email='tempy-help@cryst.bbk.ac.uk',
     packages=setuptools.find_packages(),
     url='http://tempy.ismb.lon.ac.uk/',
     description='TEMPy: a Python Library for Assessment of 3D Electron Microscopy Density Fits',
     package_dir={'TEMPy': 'TEMPy'},
     python_requires='>=3.7',
@@ -33,10 +33,11 @@
         "Operating System :: OS Independent",
     ],
     package_data={'TEMPy': ['tempy_data/*.pk']},
     entry_points = {
         'console_scripts': ['TEMPy.smoc=TEMPy.script.smoc:main',
                             'TEMPy.gamma=TEMPy.script.gamma:main',
                             'TEMPy.loqfit=TEMPy.script.loqfit:main',
-                            'TEMPy.sccc=TEMPy.script.sccc:main']
+                            'TEMPy.sccc=TEMPy.script.sccc:main',
+                            'TEMPy.scores=TEMPy.script.scores:main']
     }
 )
```

